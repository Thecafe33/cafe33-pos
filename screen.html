<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Cafe 33 - Customer Screen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    
    <style>
        /* T·ªëi ∆∞u hi·ªáu nƒÉng: T·∫Øt user-select ƒë·ªÉ tr√°nh b√¥i ƒëen nh·∫ßm */
        body { font-family: 'Inter', sans-serif; overflow: hidden; background: #F0FDF4; user-select: none; -webkit-user-select: none; }
        
        /* Thay th·∫ø hi·ªáu ·ª©ng k√≠nh m·ªù (n·∫∑ng) b·∫±ng n·ªÅn tr·∫Øng ƒë·ª•c (nh·∫π) */
        .lite-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); /* Shadow r·∫•t nh·∫π */
        }

        /* N√∫t b·∫•m ph·∫≥ng, ph·∫£n h·ªìi nhanh */
        .numpad-btn {
            background: #ffffff; 
            border-radius: 16px; 
            font-weight: 900; 
            font-size: 1.8rem; 
            color: #1e3932;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 0 #cbd5e1; /* Gi·∫£ l·∫≠p ƒë·ªô n·ªïi b·∫±ng border-bottom nh·∫π */
            transition: transform 0.1s; 
            display: flex; align-items: center; justify-content: center;
        }
        .numpad-btn:active { 
            transform: translateY(2px); 
            box-shadow: none; 
            background: #f1f5f9; 
        }

        /* Animation ƒë∆°n gi·∫£n: Ch·ªâ d·ªãch chuy·ªÉn v·ªã tr√≠ (GPU friendly) */
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* --- TH√äM V√ÄO STYLE --- */
.native-input {
    width: 100%; font-size: 2.5rem; font-weight: 900; text-align: center;
    color: #1e3932; letter-spacing: 0.1em; background: #F9FAFB;
    border: 2px solid #E5E7EB; border-radius: 16px; padding: 20px;
    outline: none; transition: border-color 0.2s;
}
.native-input:focus { border-color: #006241; background: #ffffff; }
        
    </style>
</head>
<body class="flex flex-col h-screen w-screen relative overflow-hidden bg-[#F2F4F7]">

   <header class="flex justify-between items-center px-8 py-6 z-[70] shrink-0 bg-white/90 backdrop-blur-md border-b border-gray-100 relative shadow-sm">
    <div>
        <h1 class="text-3xl font-black text-[#006241] tracking-tighter leading-none">The cafe 33</h1>
        <p class="text-sm font-bold text-gray-400 mt-1">33 xin ch√†o</p>
    </div>

    <button onclick="openNativeInput()" class="flex items-center gap-3 bg-white border-2 border-gray-100 pl-2 pr-6 py-2 rounded-full shadow-sm active:scale-95 transition-transform hover:border-[#006241] group">
        <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-[#006241] transition-colors">
            <span class="material-symbols-outlined text-gray-600 text-xl group-hover:text-white">dialpad</span>
        </div>
        <div class="text-left">
            <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest leading-none mb-0.5">Th√†nh vi√™n</p>
            <p class="text-sm font-black text-gray-800 leading-none">Nh·∫≠p SƒêT</p>
        </div>
    </button>
</header>
<main class="flex-1 relative overflow-hidden flex flex-col bg-[#F2F4F7]">
        
        <div id="screensaver" class="hidden absolute inset-0 z-[60] bg-black flex flex-col items-center justify-center overflow-hidden">
            <div id="slide-layer-1" class="absolute inset-0 z-10 transition-opacity duration-1000 ease-in-out opacity-0 bg-black"></div>
            <div id="slide-layer-2" class="absolute inset-0 z-10 transition-opacity duration-1000 ease-in-out opacity-0 bg-black"></div>
            <div class="absolute bottom-0 w-full bg-gradient-to-t from-black/80 to-transparent p-6 pt-32 z-20">
                <p class="text-white text-2xl font-black uppercase tracking-[0.2em] text-center drop-shadow-lg animate-pulse">The Cafe 33 - Coffee in Bed</p>
            </div>
        </div>
<div id="bed-info-panel" class="hidden h-auto shrink-0 bg-sky-50 border-b border-sky-100 flex-col items-center justify-center py-6 px-4 shadow-sm relative z-10 transition-all duration-500 gap-4">
            
            <div class="flex flex-col items-center text-center">
                
                <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center shadow-sm border-4 border-sky-100 animate-bounce mb-2">
                    <span class="material-symbols-outlined text-4xl text-sky-500">sentiment_satisfied_alt</span>
                </div>

                <div class="mb-1">
                    <span class="bg-sky-200 text-sky-700 text-[10px] font-black px-2 py-0.5 rounded-md uppercase tracking-wider">Cafe in Bed</span>
                </div>

                <h1 id="bed-cust-name" class="text-3xl font-black text-gray-800 leading-tight truncate max-w-[90vw]">...</h1>
                <p id="bed-cust-phone" class="text-sm font-bold text-gray-400 font-mono mt-0.5 tracking-widest">...</p>
            </div>

            <div class="w-full max-w-sm bg-white px-6 py-3 rounded-2xl shadow-sm border border-sky-100 flex items-center justify-between gap-4">
                
                <div class="text-center flex-1">
                    <p class="text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">Check-in</p>
                    <p id="bed-start-time" class="text-xl font-black text-gray-700">--:--</p>
                </div>
                
                <div class="flex flex-col items-center gap-1 opacity-30">
                    <div class="w-8 h-[2px] bg-gray-400"></div>
                    <span class="material-symbols-outlined text-xs text-gray-400">arrow_forward</span>
                </div>

                <div class="text-center flex-1">
                    <p class="text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">Check-out</p>
                    <p id="bed-end-time" class="text-xl font-black text-sky-600">--:--</p>
                </div>
            </div>
        </div>
        

       <div id="view-cart" class="flex-1 flex flex-col w-full overflow-hidden relative bg-white transition-all duration-500">
        
        <div id="cart-list" class="flex-1 overflow-y-auto p-6 space-y-3 pb-32">
            </div>

        <div class="bg-white p-5 border-t border-gray-100 flex justify-between items-center gap-4 shadow-[0_-10px_60px_rgba(0,0,0,0.08)] z-20 absolute bottom-0 w-full rounded-t-[32px]">
            
            <div id="footer-user-info" class="hidden flex items-center gap-4 bg-[#F0FDF4] pr-8 pl-2 py-2 rounded-full border border-[#DCFCE7] animate-fade-in">
                <div class="w-12 h-12 bg-[#006241] rounded-full flex items-center justify-center shadow-lg shadow-green-900/20 text-white">
                    <span class="material-symbols-outlined text-2xl">person</span>
                </div>
                <div class="text-left">
                    <p id="cust-name" class="text-lg font-black text-[#006241] leading-none mb-0.5">Kh√°ch l·∫ª</p>
                    <p class="text-[10px] font-bold text-green-600/70 uppercase tracking-wider">
                        <span id="cust-points" class="font-black text-green-700 text-sm">0</span> ƒëi·ªÉm t√≠ch l≈©y
                    </p>
                </div>
            </div>

            <div id="footer-welcome-msg" class="flex items-center gap-3 opacity-30 px-2">
                <span class="material-symbols-outlined text-3xl">storefront</span>
                <span class="font-black text-sm uppercase">S·∫µn s√†ng ph·ª•c v·ª•</span>
            </div>

            <div class="text-right">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-[0.2em] mb-1">T·ªïng t·∫°m t√≠nh</p>
                <p class="text-5xl font-black text-[#006241] tracking-tight leading-none" id="total-price">0</p>
            </div>
        </div>
    </div>


        <div id="view-qr" class="hidden absolute inset-0 z-[55] flex flex-col items-center justify-center bg-white/95 backdrop-blur-xl fade-in">
            <div class="w-full max-w-md text-center p-6">
                <h2 class="text-3xl font-black text-[#006241] mb-2 uppercase tracking-tight">Thanh To√°n QR</h2>
                <div class="bg-white p-4 rounded-[32px] shadow-2xl border-2 border-gray-100 inline-block mb-8 relative">
                    <img id="qr-image" src="" class="w-72 h-72 rounded-xl object-contain bg-gray-50">
                </div>
                <div class="bg-[#F0FDF4] p-5 rounded-3xl border border-[#DCFCE7] max-w-xs mx-auto">
                    <p class="text-xs font-bold text-[#166534] uppercase tracking-widest mb-1">S·ªë ti·ªÅn c·∫ßn thanh to√°n</p>
                    <p class="text-5xl font-black text-[#15803d] tracking-tight" id="qr-amount">0</p>
                </div>
            </div>
        </div>

        <div id="view-success" class="hidden absolute inset-0 z-[60] bg-[#006241] flex flex-col items-center justify-center text-white fade-in"></div>
    </main>
   <div id="view-native-input" class="hidden absolute inset-0 z-80 flex items-center justify-center bg-black/60 fade-in backdrop-blur-sm">
            <div class="bg-white w-[90%] max-w-[400px] rounded-[32px] p-6 shadow-2xl relative">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-black text-[#006241] uppercase">Nh·∫≠p S·ªë ƒêi·ªán Tho·∫°i</h3>
                    <button onclick="closeNativeInput()" class="w-10 h-10 rounded-full bg-gray-100 text-gray-500 font-bold flex items-center justify-center">‚úï</button>
                </div>
                <input type="tel" id="native-phone" placeholder="09..." class="native-input mb-6" autocomplete="off">
                <div class="flex gap-3">
                    <button onclick="closeNativeInput()" class="flex-1 py-4 bg-gray-100 text-gray-600 font-bold rounded-2xl uppercase">H·ªßy</button>
                    <button onclick="submitNativePhone()" id="btn-submit" class="flex-[2] py-4 bg-[#006241] text-white font-black rounded-2xl uppercase shadow-lg active:bg-[#004f32]">G·ª≠i Ngay</button>
                </div>
            </div>
        </div>
<div id="view-rules" class="hidden absolute inset-0 z-[90] bg-white flex flex-col animate-fade-in">
    
    <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-white shadow-sm shrink-0">
        <h2 class="text-2xl font-black text-[#006241] uppercase tracking-tight">Quy ƒê·ªãnh & Cam K·∫øt</h2>
        <div class="flex gap-2">
            <div id="step-dot-1" class="w-8 h-2 rounded-full bg-[#006241] transition-all"></div>
            <div id="step-dot-2" class="w-2 h-2 rounded-full bg-gray-200 transition-all"></div>
            <div id="step-dot-3" class="w-2 h-2 rounded-full bg-gray-200 transition-all"></div>
        </div>
    </div>

    <div class="flex-1 relative overflow-hidden bg-[#F2F4F7]">
        
        <div id="rules-page-1" class="absolute inset-0 p-4 flex flex-col items-center justify-center transition-all duration-300">
            <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">B∆∞·ªõc 1/3: N·ªôi quy s·ª≠ d·ª•ng</p>
            
            <div onclick="zoomImage('img-rules-1')" class="relative w-full h-[65vh] max-w-lg bg-white p-2 rounded-2xl shadow-sm border border-gray-200 cursor-zoom-in group">
                <img id="img-rules-1" src="https://firebasestorage.googleapis.com/v0/b/the-cafe-33.firebasestorage.app/o/N%E1%BB%98I%20QUY%20S%E1%BB%AC%20D%E1%BB%A4NG%20BED_20260109_102319_0000.png?alt=media&token=85271122-90ad-4ebd-9ff5-47726f28343f" 
                     class="w-full h-full object-contain rounded-xl" alt="N·ªôi quy Bed">
                
                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors rounded-2xl flex items-center justify-center pointer-events-none">
                    <span class="bg-white/90 px-3 py-1.5 rounded-full text-xs font-bold text-gray-700 opacity-0 group-hover:opacity-100 shadow-sm transform scale-95 group-hover:scale-100 transition-all">üîç B·∫•m ƒë·ªÉ ph√≥ng to</span>
                </div>
            </div>
        </div>

        <div id="rules-page-2" class="absolute inset-0 translate-x-full p-4 flex flex-col items-center justify-center transition-all duration-300">
            <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">B∆∞·ªõc 2/3: Th·ªèa thu·∫≠n mi·ªÖn tr·ª´</p>
            
            <div onclick="zoomImage('img-rules-2')" class="relative w-full h-[65vh] max-w-lg bg-white p-2 rounded-2xl shadow-sm border border-gray-200 cursor-zoom-in group">
                <img id="img-rules-2" src="https://firebasestorage.googleapis.com/v0/b/the-cafe-33.firebasestorage.app/o/Screenshot_2026-01-09-09-54-02-815_com.android.chrome.png?alt=media&token=961efd8e-9dca-4c80-b6f4-4a30363969c8" 
                     class="w-full h-full object-contain rounded-xl" alt="Mi·ªÖn tr·ª´ tr√°ch nhi·ªám">
                
                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors rounded-2xl flex items-center justify-center pointer-events-none">
                    <span class="bg-white/90 px-3 py-1.5 rounded-full text-xs font-bold text-gray-700 opacity-0 group-hover:opacity-100 shadow-sm transform scale-95 group-hover:scale-100 transition-all">üîç B·∫•m ƒë·ªÉ ph√≥ng to</span>
                </div>
            </div>
        </div>

        <div id="rules-page-3" class="absolute inset-0 translate-x-full p-8 flex flex-col items-center justify-center text-center transition-all duration-300 bg-white">
            <span class="material-symbols-outlined text-6xl text-amber-500 mb-4 animate-bounce">priority_high</span>
            <h3 class="text-3xl font-black text-gray-800 mb-8 uppercase tracking-tight">L∆∞u √ù Quan Tr·ªçng</h3>
            
            <div class="w-full max-w-md space-y-4 text-left">
                <div class="bg-[#F2F4F7] p-4 rounded-2xl border-l-8 border-red-500 flex items-center gap-4">
                    <span class="material-symbols-outlined text-red-500 text-2xl">cleaning_services</span>
                    <p class="font-black text-gray-700 text-lg">1. Vui l√≤ng kh√¥ng l√†m b·∫©n n·ªám</p>
                </div>
                
                <div class="bg-[#F2F4F7] p-4 rounded-2xl border-l-8 border-blue-500 flex items-center gap-4">
                    <span class="material-symbols-outlined text-blue-500 text-2xl">timer</span>
                    <p class="font-black text-gray-700 text-lg">2. T·ª± ch√∫ √Ω th·ªùi gian k·∫øt th√∫c</p>
                </div>

                <div class="bg-[#F2F4F7] p-4 rounded-2xl border-l-8 border-green-500 flex items-center gap-4">
                    <span class="material-symbols-outlined text-green-500 text-2xl">volume_off</span>
                    <p class="font-black text-gray-700 text-lg">3. Vui l√≤ng gi·ªØ tr·∫≠t t·ª±</p>
                </div>
            </div>
        </div>

        <div id="rules-page-4" class="absolute inset-0 translate-x-full p-8 flex flex-col items-center justify-center text-center bg-white transition-all duration-300">
            <span class="material-symbols-outlined text-[140px] text-[#006241] mb-6 animate-pulse">sentiment_very_satisfied</span>
            
            <h3 class="text-4xl font-black text-[#006241] mb-2 uppercase tracking-tight">C·∫£m ∆°n b·∫°n!</h3>
            <p class="text-xl font-bold text-gray-500">ƒê√£ ƒë·ªìng √Ω v·ªõi n·ªôi quy.</p>
            <p class="text-lg text-gray-400 mt-2 font-medium">Mong b·∫°n tu√¢n th·ªß v√† c√≥ tr·∫£i nghi·ªám vui v·∫ª.</p>
        </div>

    </div>

    <div class="p-5 bg-white border-t border-gray-100 shrink-0 relative z-20">
        <button id="btn-rules-action" onclick="handleRulesAction()" class="w-full py-5 bg-[#006241] text-white rounded-[20px] font-black text-xl uppercase shadow-xl shadow-green-900/20 active:scale-[0.98] transition-all flex items-center justify-center gap-3">
            <span>ƒê√£ ƒë·ªçc & ƒê·ªìng √Ω (1/3)</span>
            <span class="material-symbols-outlined">arrow_forward</span>
        </button>
    </div>
</div>

<div id="image-viewer" onclick="closeZoom()" class="hidden fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-4 backdrop-blur-sm cursor-zoom-out fade-in">
    <img id="zoomed-img" src="" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl">
    <p class="absolute bottom-10 text-white/50 text-xs font-bold uppercase tracking-widest">Ch·∫°m b·∫•t k·ª≥ ƒë√¢u ƒë·ªÉ ƒë√≥ng</p>
</div>
    <script>
        // 1. C·∫§U H√åNH FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCNh1-16gYZ0P30Fkd-2tB-O89PXkPX9Lc",
            authDomain: "the-cafe-33.firebaseapp.com",
            databaseURL: "https://the-cafe-33-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "the-cafe-33",
            storageBucket: "the-cafe-33.appspot.com",
            messagingSenderId: "...",
            appId: "..."
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // 2. AUTO LOGIN
        auth.signInWithEmailAndPassword("elio@thecafe33.com", "Thecafe33ty").then(() => {
            console.log("Connected Lite");
            listenToPOS();
        }).catch(e => console.error(e));
        // --- C·∫§U H√åNH PLAYLIST (GI·ªÆ NGUY√äN) ---
        const promoPlaylist = [
            { type: 'image', src: 'https://firebasestorage.googleapis.com/v0/b/the-cafe-33.firebasestorage.app/o/1768316658706.jpg?alt=media&token=c8854aaa-6af4-40d7-a5b6-ccdda66e58e8', duration: 6000 },
            { type: 'image', src: 'https://firebasestorage.googleapis.com/v0/b/the-cafe-33.firebasestorage.app/o/1770299826548.jpg?alt=media&token=c3e3fad2-b9b3-48e8-aad8-bd5658a3f386', duration: 6000 },
            { type: 'image', src: 'https://firebasestorage.googleapis.com/v0/b/the-cafe-33.firebasestorage.app/o/IMG_20260113_214718.png?alt=media&token=7cda9538-ce16-43ae-92a1-7eeaf1166d23', duration: 6000 },
            { type: 'image', src: 'https://firebasestorage.googleapis.com/v0/b/the-cafe-33.firebasestorage.app/o/%C4%90%E1%BB%8F%20Cam%20Xanh%20L%C3%A1%20R%E1%BB%B1c%20R%E1%BB%A1%20H%C3%ACnh%20%E1%BA%A2nh%20%C4%90%E1%BB%93%20%C4%82n%20Th%E1%BB%A9c%20U%E1%BB%91ng%20B%E1%BB%AFa%20S%C3%A1ng%20Poster_20260122_230631_0000.png?alt=media&token=701bbd64-0618-49fa-bda6-affe536ecdbb', duration: 6000 },
            { type: 'image', src: 'https://firebasestorage.googleapis.com/v0/b/the-cafe-33.firebasestorage.app/o/IMG_20260113_145355.png?alt=media&token=bf813553-a32c-4e0b-bd39-27e3a283b990', duration: 6000 }
        ];

        let currentSlideIndex = -1;
        let slideTimeout = null;
        let isSaverRunning = false;
        let activeLayer = 1; // ƒê√°nh d·∫•u l·ªõp n√†o ƒëang hi·ªán (1 ho·∫∑c 2)

        function startScreensaver() {
            if (isSaverRunning) return;
            isSaverRunning = true;
            document.getElementById('screensaver').classList.remove('hidden');
            
            // B·∫Øt ƒë·∫ßu chu tr√¨nh
            if (currentSlideIndex === -1) nextSlide(); 
            else showNextBuffer(); // Ti·∫øp t·ª•c n·∫øu ƒëang t·∫°m d·ª´ng
        }

        function stopScreensaver() {
            isSaverRunning = false;
            clearTimeout(slideTimeout);
            document.getElementById('screensaver').classList.add('hidden');
            
            // D·ª´ng video n·∫øu ƒëang ch·∫°y ƒë·ªÉ ƒë·ª° t·ªën RAM
            const vid1 = document.querySelector('#slide-layer-1 video');
            const vid2 = document.querySelector('#slide-layer-2 video');
            if(vid1) vid1.pause();
            if(vid2) vid2.pause();
        }

        function nextSlide() {
            if (!isSaverRunning) return;
            currentSlideIndex++;
            if (currentSlideIndex >= promoPlaylist.length) currentSlideIndex = 0;
            showNextBuffer();
        }

        function showNextBuffer() {
            if (!isSaverRunning) return;

            const item = promoPlaylist[currentSlideIndex];
            
            // X√°c ƒë·ªãnh l·ªõp ·∫©n (Back buffer) ƒë·ªÉ n·∫°p n·ªôi dung m·ªõi v√†o
            // N·∫øu Layer 1 ƒëang hi·ªán -> N·∫°p v√†o Layer 2 v√† ng∆∞·ª£c l·∫°i
            const backLayerId = activeLayer === 1 ? 'slide-layer-2' : 'slide-layer-1';
            const frontLayerId = activeLayer === 1 ? 'slide-layer-1' : 'slide-layer-2';
            
            const backEl = document.getElementById(backLayerId);
            const frontEl = document.getElementById(frontLayerId);

            backEl.innerHTML = ""; // D·ªçn d·∫πp l·ªõp sau

            let mediaEl;

            // --- T·∫†O ELEMENT M·ªöI ---
            if (item.type === 'image') {
                mediaEl = document.createElement('img');
                mediaEl.src = item.src;
                mediaEl.className = "w-full h-full object-cover";
                
                // M·∫§U CH·ªêT: Ch·ªù t·∫£i xong m·ªõi chuy·ªÉn c·∫£nh
                mediaEl.onload = () => {
                    transitionLayer(frontEl, backEl, item.duration);
                };
                // N·∫øu l·ªói th√¨ b·ªè qua sang c√°i ti·∫øp theo
                mediaEl.onerror = () => { setTimeout(nextSlide, 1000); };
            } 
            else if (item.type === 'video') {
                mediaEl = document.createElement('video');
                mediaEl.src = item.src;
                mediaEl.className = "w-full h-full object-cover";
                mediaEl.muted = true;
                mediaEl.autoplay = true;
                mediaEl.playsInline = true;
                mediaEl.loop = false;

                // Video t·∫£i xong metadata th√¨ chuy·ªÉn c·∫£nh
                mediaEl.onloadeddata = () => {
                    transitionLayer(frontEl, backEl, 0); // Video t·ª± qu·∫£n l√Ω th·ªùi gian
                };
                
                mediaEl.onended = nextSlide;
                mediaEl.onerror = () => { setTimeout(nextSlide, 1000); };
            }

            backEl.appendChild(mediaEl);
        }

        function transitionLayer(frontEl, backEl, duration) {
            if (!isSaverRunning) return;

            // 1. Hi·ªán l·ªõp sau l√™n (Fade In)
            backEl.classList.remove('opacity-0');
            backEl.classList.add('opacity-100');

            // 2. ·∫®n l·ªõp tr∆∞·ªõc ƒëi (Fade Out) - Delay nh·∫π ƒë·ªÉ l·ªõp sau k·ªãp che k√≠n
            setTimeout(() => {
                frontEl.classList.remove('opacity-100');
                frontEl.classList.add('opacity-0');
                
                // D·ªçn d·∫πp n·ªôi dung c≈© cho nh·∫π m√°y
                setTimeout(() => frontEl.innerHTML = "", 1000); 
            }, 100); // Ch·ªù 100ms cho m∆∞·ª£t

            // 3. ƒê·∫£o chi·ªÅu Active
            activeLayer = activeLayer === 1 ? 2 : 1;

            // 4. H·∫πn gi·ªù cho slide ti·∫øp theo (N·∫øu l√† ·∫£nh)
            if (duration > 0) {
                slideTimeout = setTimeout(nextSlide, duration);
            }
        }

        // 3. LISTEN FROM POS (LOGIC ∆ØU TI√äN)
        // --- 1. S·ª¨A H√ÄM LISTEN TO POS ---
        
        // // --- 3. LISTEN FROM POS (LOGIC M·ªöI: SPLIT VIEW) ---
       // Bi·∫øn ghi nh·ªõ phi√™n l√†m vi·ªác Bed hi·ªán t·∫°i
        let currentBedSession = null;

        // --- 3. LISTEN FROM POS (LOGIC M·ªöI: B·ªÄN V·ªÆNG) ---
        function listenToPOS() {
            db.ref('session_display').on('value', (snap) => {
                const data = snap.val();
                if(!data) return resetScreen();
// ============================================================
        // üìú 1. LOGIC N·ªòI QUY (M·ªöI TH√äM V√ÄO ƒê√ÇY)
        // ============================================================
        if (data.state === 'show_rules') {
            showRulesModal(); // G·ªçi h√†m hi·ªÉn th·ªã 3 b∆∞·ªõc n·ªôi quy
            return; // D·ª´ng l·∫°i, kh√¥ng ch·∫°y c√°c l·ªánh d∆∞·ªõi
        }
                // >>> 1. N·∫æU L√Ä L·ªÜNH CH√ÄO M·ª™NG BED -> L∆ØU V√ÄO B·ªò NH·ªö <<<
                if (data.state === 'bed_welcome') {
                    currentBedSession = {
                        name: data.customerName,
                        phone: data.maskedPhone,
                        start: data.startTime,
                        end: data.endTime
                    };
                    document.getElementById('view-rules').classList.add('hidden');
                    renderBedLayout(data); // V·∫Ω giao di·ªán ngay
                    return;
                }

                // >>> 2. C√ÅC TR·∫†NG TH√ÅI KH√ÅC <<<
                
                // N·∫øu QR -> Hi·ªán ƒë√® l√™n t·∫•t c·∫£
                if (data.state === 'qr_payment') {
                    stopScreensaver();
                    document.getElementById('view-qr').classList.remove('hidden');
                    document.getElementById('qr-image').src = data.qrUrl;
                    document.getElementById('qr-amount').innerText = Number(data.amount).toLocaleString() + 'ƒë';
                    return;
                }

                // N·∫øu Nh·∫≠p SƒêT -> Hi·ªán Popup
                if (data.state === 'input_phone') {
                    stopScreensaver();
                    openNativeInput();
                    return;
                }

                // N·∫øu Th√†nh c√¥ng -> X√≥a b·ªô nh·ªõ Bed & Hi·ªán Success
                if (data.state === 'success') {
                    currentBedSession = null; // K·∫øt th√∫c phi√™n Bed
                    stopScreensaver();
                    // >>> QUAN TR·ªåNG: ƒê√ìNG MODAL N·ªòI QUY T·∫†I ƒê√ÇY <<<
            document.getElementById('view-rules').classList.add('hidden');
                    showSuccessScreen(data);
                    return;
                }

                // N·∫øu Idle (R·∫£nh) -> X√≥a b·ªô nh·ªõ & Ch·∫°y qu·∫£ng c√°o
                if (data.state === 'idle') {
                    resetScreen();
                    return;
                }

                // >>> 3. TR·∫†NG TH√ÅI CART (TH√äM M√ìN) <<<
                // ƒê√¢y l√† ch·ªó s·ª≠a l·ªói: Lu√¥n ki·ªÉm tra xem c√≥ ƒëang trong phi√™n Bed kh√¥ng
                
                renderBedLayout(data); // H√†m n√†y s·∫Ω t·ª± quy·∫øt ƒë·ªãnh hi·ªán Panel Xanh hay kh√¥ng
            });
        }

        // --- H√ÄM V·∫º GIAO DI·ªÜN TH√îNG MINH ---
        // --- H√ÄM V·∫º GIAO DI·ªÜN TH√îNG MINH ---
        function renderBedLayout(data) {
            stopScreensaver();
            document.getElementById('view-qr').classList.add('hidden');
            document.getElementById('view-success').classList.add('hidden');

            const bedPanel = document.getElementById('bed-info-panel');

            // --- 1. X·ª¨ L√ù PANEL BED (H√ÄNG TR√äN) ---
            if (currentBedSession) {
                // ƒêang l√† kh√°ch Bed -> Hi·ªán thanh m√†u xanh
                bedPanel.classList.remove('hidden');
                bedPanel.classList.add('flex'); 

                document.getElementById('bed-cust-name').innerText = currentBedSession.name || "Qu√Ω Kh√°ch";
                document.getElementById('bed-cust-phone').innerText = currentBedSession.phone || "";
                document.getElementById('bed-start-time').innerText = currentBedSession.start || "--:--";
                document.getElementById('bed-end-time').innerText = currentBedSession.end || "--:--";
            } else {
                // Kh√°ch th∆∞·ªùng -> ·∫®n thanh xanh
                bedPanel.classList.add('hidden');
                bedPanel.classList.remove('flex');
            }

            // --- 2. X·ª¨ L√ù FOOTER (H√ÄNG D∆Ø·ªöI - G√ìC TR√ÅI) [M·ªöI TH√äM] ---
            const footerUser = document.getElementById('footer-user-info');
            const footerWelcome = document.getElementById('footer-welcome-msg');
            
            // Logic x√°c ƒë·ªãnh t√™n ƒë·ªÉ hi·ªán ·ªü d∆∞·ªõi
            let displayName = null;
            let displayPoints = 0;

            if (currentBedSession) {
                // N·∫øu l√† Bed -> L·∫•y t√™n t·ª´ b·ªô nh·ªõ Bed
                displayName = currentBedSession.name;
            } 
            else if (data.customerName && data.customerName !== "Kh√°ch m·ªõi" && data.customerName !== "Kh√°ch l·∫ª") {
                // N·∫øu l√† Kh√°ch th∆∞·ªùng c√≥ t√™n -> L·∫•y t·ª´ POS g·ª≠i sang
                displayName = data.customerName;
                displayPoints = data.customerPoints || 0;
            }

            // Ki·ªÉm tra ƒë·ªÉ hi·ªÉn th·ªã
            if (displayName) {
                // -> C√ì T√äN: Hi·ªán th·∫ª th√†nh vi√™n
                footerUser.classList.remove('hidden');
                footerUser.classList.add('flex');
                footerWelcome.classList.add('hidden'); // ·∫®n c√¢u ch√†o

                document.getElementById('cust-name').innerText = displayName;
                document.getElementById('cust-points').innerText = displayPoints;
            } else {
                // -> KH√îNG T√äN (Kh√°ch l·∫ª): Hi·ªán c√¢u ch√†o "S·∫µn s√†ng ph·ª•c v·ª•"
                footerUser.classList.add('hidden');
                footerUser.classList.remove('flex');
                footerWelcome.classList.remove('hidden');
            }

            // --- 3. C·∫¨P NH·∫¨T GI·ªé H√ÄNG ---
            updateCartUI(data);
        }

        function showSuccessScreen(data) {
            const successView = document.getElementById('view-success');
            successView.classList.remove('hidden');
            
            if (data.orderType === 'bed') {
                // Giao di·ªán T√≠m/Xanh cho Bed
                successView.className = "absolute inset-0 z-[60] bg-gradient-to-br from-indigo-500 to-purple-600 flex flex-col items-center justify-center text-white fade-in";
                successView.innerHTML = `
                    <span class="material-symbols-outlined text-9xl mb-4 text-yellow-300">sentiment_very_satisfied</span>
                    <h2 class="text-5xl font-black">ƒê√£ order bed xong</h2>
                    <p class="text-xl font-bold mt-4 opacity-80 animate-pulse">Vui l√≤ng th·ª±c hi·ªán ƒë√∫ng quy ƒë·ªãnh nh√©</p>
                `;
            } else {
                // Giao di·ªán Xanh l√° cho kh√°ch th∆∞·ªùng
                successView.className = "absolute inset-0 z-[60] bg-[#006241] flex flex-col items-center justify-center text-white fade-in";
                successView.innerHTML = `
                    <span class="material-symbols-outlined text-9xl mb-6">check_circle</span>
                    <h2 class="text-5xl font-black">Th√†nh C√¥ng!</h2>
                    <p class="text-2xl font-bold opacity-80 mt-2">C·∫£m ∆°n qu√Ω kh√°ch</p>
                `;
            }

            setTimeout(() => {
                successView.classList.add('hidden');
                resetScreen();
            }, 5000);
        }
        //--- H√ÄM UI ---
        function updateCartUI(data) {
            document.getElementById('total-price').innerText = Number(data.total || 0).toLocaleString();
            const listEl = document.getElementById('cart-list');
            listEl.innerHTML = '';

            if (data.cart && data.cart.length > 0) {
                data.cart.forEach(item => {
                    let sizeBadge = item.size ? `<span class="bg-gray-100 text-gray-500 text-[10px] font-bold px-2 py-0.5 rounded ml-2 uppercase border border-gray-200">${item.size}</span>` : '';
                    
                    listEl.innerHTML += `
                    <div class="flex justify-between items-center bg-white p-3 rounded-2xl border border-gray-100 mb-2 shadow-sm fade-in">
                        <div class="flex items-center gap-3">
                            <div class="bg-[#F0FDF4] w-12 h-12 flex items-center justify-center rounded-xl font-black text-[#006241] border border-[#006241]/10 text-xl">${item.qty}</div>
                            <div>
                                <div class="flex items-center">
                                    <p class="font-bold text-gray-800 leading-tight text-lg">${item.name}</p>
                                    ${sizeBadge}
                                </div>
                            </div>
                        </div>
                        <p class="font-black text-xl text-[#006241]">${(item.price * item.qty).toLocaleString()}</p>
                    </div>`;
                });
            } else {
                listEl.innerHTML = `
                <div class="flex flex-col items-center justify-center h-64 text-gray-300 gap-2">
                    <span class="material-symbols-outlined text-6xl opacity-30">shopping_bag</span>
                    <p class="text-sm font-bold uppercase opacity-50">Ch∆∞a c√≥ m√≥n</p>
                </div>`;
            }
        }

     function resetScreen() {
            currentBedSession = null; // X√≥a b·ªô nh·ªõ Bed
            
            // ·∫®n c√°c Panel ƒë·∫∑c bi·ªát
            document.getElementById('bed-info-panel').classList.add('hidden');
            document.getElementById('bed-info-panel').classList.remove('flex');
            document.getElementById('view-qr').classList.add('hidden');
            document.getElementById('view-success').classList.add('hidden');
            
            // --- RESET FOOTER (M·ªöI TH√äM) ---
            document.getElementById('footer-user-info').classList.add('hidden');
            document.getElementById('footer-user-info').classList.remove('flex');
            document.getElementById('footer-welcome-msg').classList.remove('hidden'); // Hi·ªán l·∫°i c√¢u ch√†o
            
            // Reset Gi·ªè h√†ng
            document.getElementById('total-price').innerText = "0";
            document.getElementById('cart-list').innerHTML = "";
            
            closeNativeInput();
            startScreensaver(); 
        }

        // --- KEYPAD LOGIC ---
        // --- NATIVE INPUT LOGIC (SI√äU NH·∫∏) ---
// --- H√ÄM M·ªû POPUP NH·∫¨P SƒêT (C·∫¨P NH·∫¨T: T·∫ÆT QU·∫¢NG C√ÅO NGAY) ---
function openNativeInput() {
    // 1. T·∫ÆT QU·∫¢NG C√ÅO NGAY L·∫¨P T·ª®C
    stopScreensaver(); 

    // 2. Hi·ªán Popup nh·∫≠p li·ªáu
    const modal = document.getElementById('view-native-input');
    const input = document.getElementById('native-phone');
    
    modal.classList.remove('hidden');
    input.value = ""; 
    
    // Focus v√†o input ƒë·ªÉ b√†n ph√≠m ·∫£o t·ª± b·∫≠t l√™n
    setTimeout(() => input.focus(), 100);
}

// --- H√ÄM ƒê√ìNG POPUP (C·∫¨P NH·∫¨T: KI·ªÇM TRA ƒê·ªÇ B·∫¨T L·∫†I QU·∫¢NG C√ÅO) ---
function closeNativeInput() {
    // 1. ·∫®n Popup
    document.getElementById('view-native-input').classList.add('hidden');
    document.getElementById('native-phone').blur(); // T·∫Øt b√†n ph√≠m

    // 2. LOGIC TH√îNG MINH:
    // N·∫øu ƒëang kh√¥ng c√≥ kh√°ch (Footer ƒëang ·∫©n) V√Ä kh√¥ng c√≥ m√≥n trong gi·ªè
    // -> Th√¨ b·∫≠t l·∫°i qu·∫£ng c√°o cho ƒë·ª° tr·ªëng m√†n h√¨nh
    const footerUser = document.getElementById('footer-user-info');
    const totalPrice = document.getElementById('total-price').innerText;

    const isGuestLogin = !footerUser.classList.contains('hidden'); // ƒê√£ c√≥ t√™n kh√°ch
    const hasCart = totalPrice !== "0"; // ƒêang c√≥ m√≥n

    // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p v·∫£ gi·ªè h√†ng r·ªóng -> B·∫≠t l·∫°i qu·∫£ng c√°o
    if (!isGuestLogin && !hasCart) {
        startScreensaver();
    }
}


// G·ª≠i s·ªë khi b·∫•m n√∫t
// --- H√ÄM G·ª¨I SƒêT (B·∫¢N FIX: G·ª¨I XONG T·ª∞ ƒê√ìNG) ---
function submitNativePhone() {
    const input = document.getElementById('native-phone');
    const val = input.value.trim();
    const btn = document.getElementById('btn-submit');

    // 1. Validate: Kh√¥ng cho g·ª≠i n·∫øu tr·ªëng
    if (val.length < 3) {
        input.focus();
        return;
    }

    // 2. Hi·ªáu ·ª©ng "ƒêang g·ª≠i..."
    btn.innerText = "ƒêang g·ª≠i...";
    btn.classList.add('opacity-50');

    // 3. G·ª≠i l√™n Firebase
    db.ref('client_input').set({
        type: 'phone_update',
        value: val,
        timestamp: Date.now()
    }).then(() => {
        // --- TH√ÄNH C√îNG ---
        btn.innerText = "‚úî ƒê√É G·ª¨I"; // B√°o cho kh√°ch bi·∫øt
        
        // Ch·ªù 0.5 gi√¢y cho kh√°ch k·ªãp ƒë·ªçc ch·ªØ "ƒê√£ g·ª≠i" r·ªìi m·ªõi ƒë√≥ng
        setTimeout(() => {
            closeNativeInput(); // <--- QUAN TR·ªåNG: ƒê√≥ng modal
            
            // Reset l·∫°i n√∫t b·∫•m v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu cho l·∫ßn sau
            btn.innerText = "G·ª¨I NGAY";
            btn.classList.remove('opacity-50');
            input.value = ""; 
        }, 500);

    }).catch(err => {
        // --- L·ªñI ---
        alert("L·ªói m·∫°ng: " + err.message);
        btn.innerText = "G·ª¨I L·∫†I";
        btn.classList.remove('opacity-50');
    });
}

// H·ªó tr·ª£ b·∫•m Enter tr√™n b√†n ph√≠m
document.getElementById('native-phone').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') submitNativePhone();
});

   // --- LOGIC ƒêI·ªÄU KHI·ªÇN N·ªòI QUY ---
let currentRuleStep = 1;

// 1. H√†m b·∫≠t Modal (Reset v·ªÅ trang 1)
function showRulesModal() {
    currentRuleStep = 1;
    updateRulesUI();
    document.getElementById('view-rules').classList.remove('hidden');
    stopScreensaver(); // T·∫Øt qu·∫£ng c√°o ƒë·ªÉ kh√°ch t·∫≠p trung ƒë·ªçc
}

// 2. H√†m x·ª≠ l√Ω n√∫t b·∫•m (Next -> Next -> Finish)
function handleRulesAction() {
    if (currentRuleStep < 3) {
        // N·∫øu ƒëang ·ªü trang 1 ho·∫∑c 2 -> Chuy·ªÉn b∆∞·ªõc ti·∫øp theo
        currentRuleStep++;
        updateRulesUI();
    } else {
        // N·∫øu ƒëang ·ªü trang 3 -> Ho√†n th√†nh
        finishRulesAgreement();
    }
}

// 3. H√†m c·∫≠p nh·∫≠t giao di·ªán (Trang, N√∫t, Thanh ti·∫øn tr√¨nh)
function updateRulesUI() {
    const btn = document.getElementById('btn-rules-action');
    const dot1 = document.getElementById('step-dot-1');
    const dot2 = document.getElementById('step-dot-2');
    const dot3 = document.getElementById('step-dot-3');

    // A. Chuy·ªÉn ƒë·ªïi c√°c trang (Slide Effect)
    // Duy·ªát qua 4 trang (1, 2, 3, 4)
    ['1', '2', '3', '4'].forEach(i => {
        const page = document.getElementById(`rules-page-${i}`);
        if(!page) return;

        if (i < currentRuleStep) {
            // Trang ƒë√£ qua -> ƒê·∫©y sang tr√°i
            page.classList.add('-translate-x-full');
            page.classList.remove('translate-x-0', 'translate-x-full');
        } else if (i == currentRuleStep) {
            // Trang hi·ªán t·∫°i -> ·ªû gi·ªØa
            page.classList.remove('-translate-x-full', 'translate-x-full');
            page.classList.add('translate-x-0');
        } else {
            // Trang ch∆∞a t·ªõi -> ƒê·∫©y sang ph·∫£i
            page.classList.add('translate-x-full');
            page.classList.remove('translate-x-0', '-translate-x-full');
        }
    });

    // B. C·∫≠p nh·∫≠t N√∫t b·∫•m & Thanh ti·∫øn tr√¨nh (Dots)
    if (currentRuleStep === 1) {
        // ƒêang ·ªü ·∫¢nh 1
        btn.innerHTML = `<span>ƒê√£ ƒë·ªçc & ƒê·ªìng √Ω (1/3)</span><span class="material-symbols-outlined">arrow_forward</span>`;
        btn.className = "w-full py-5 bg-[#006241] text-white rounded-[20px] font-black text-xl uppercase shadow-xl transition-all flex items-center justify-center gap-3";
        
        dot1.className = "w-8 h-2 rounded-full bg-[#006241] transition-all";
        dot2.className = "w-2 h-2 rounded-full bg-gray-200 transition-all";
        dot3.className = "w-2 h-2 rounded-full bg-gray-200 transition-all";
    } 
    else if (currentRuleStep === 2) {
        // ƒêang ·ªü ·∫¢nh 2 (Mi·ªÖn tr·ª´)
        btn.innerHTML = `<span>ƒê√£ ƒë·ªçc & ƒê·ªìng √Ω (2/3)</span><span class="material-symbols-outlined">arrow_forward</span>`;
        
        dot1.className = "w-2 h-2 rounded-full bg-gray-200 transition-all";
        dot2.className = "w-8 h-2 rounded-full bg-[#006241] transition-all";
        dot3.className = "w-2 h-2 rounded-full bg-gray-200 transition-all";
    } 
    else if (currentRuleStep === 3) {
        // ƒêang ·ªü Text L∆∞u √Ω (B∆∞·ªõc cu·ªëi ƒë·ªÉ x√°c nh·∫≠n)
        btn.innerHTML = `<span>X√°c nh·∫≠n cam k·∫øt (3/3)</span><span class="material-symbols-outlined">verified</span>`;
        // ƒê·ªïi m√†u n√∫t sang m√†u Cam/V√†ng ƒë·ªÉ g√¢y ch√∫ √Ω
        btn.className = "w-full py-5 bg-gradient-to-r from-amber-500 to-orange-600 text-white rounded-[20px] font-black text-xl uppercase shadow-xl active:scale-95 transition-all flex items-center justify-center gap-3";
        
        dot1.className = "w-2 h-2 rounded-full bg-gray-200 transition-all";
        dot2.className = "w-2 h-2 rounded-full bg-gray-200 transition-all";
        dot3.className = "w-8 h-2 rounded-full bg-amber-500 transition-all";
    }
}

// 4. H√†m Ho√†n t·∫•t
function finishRulesAgreement() {
    // A. Hi·ªán trang c·∫£m ∆°n (Trang 4 - M·∫∑t c∆∞·ªùi)
    document.getElementById('rules-page-3').classList.add('-translate-x-full');
    document.getElementById('rules-page-4').classList.remove('translate-x-full');
    document.getElementById('rules-page-4').classList.add('translate-x-0');
    
    // B. ·∫®n n√∫t b·∫•m (V√¨ ƒë√£ xong r·ªìi)
    document.getElementById('btn-rules-action').parentElement.classList.add('hidden');

    // C. G·ª≠i t√≠n hi·ªáu "ƒê√£ ƒë·ªìng √Ω" v·ªÅ cho POS
    db.ref('client_input').set({
        type: 'rules_agreed',
        timestamp: Date.now()
    });

    // POS s·∫Ω nh·∫≠n t√≠n hi·ªáu n√†y -> T·∫Øt popup ch·ªù -> Ho√†n t·∫•t thanh to√°n -> G·ª≠i l·ªánh 'success'
    // Khi m√†n h√¨nh n√†y nh·∫≠n l·∫°i l·ªánh 'success' t·ª´ POS, n√≥ s·∫Ω t·ª± ƒë√≥ng modal quy ƒë·ªãnh ƒëi.
}

// 5. Logic Ph√≥ng to ·∫£nh (Zoom)
function zoomImage(imgId) {
    const src = document.getElementById(imgId).src;
    document.getElementById('zoomed-img').src = src;
    document.getElementById('image-viewer').classList.remove('hidden');
}

function closeZoom() {
    document.getElementById('image-viewer').classList.add('hidden');
}


    </script>
</body>
</html>
