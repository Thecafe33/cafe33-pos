<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#006241">
<title>POS Cafe 33 - Firebase</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=League+Spartan:wght@700;800&display=swap" rel="stylesheet">
<style>
/* CSS CH·ªêNG RELOAD & ZOOM */
html, body {
    overscroll-behavior-y: none; 
    touch-action: pan-x pan-y;
    margin: 0; padding: 0; height: 100%; width: 100%;
    -webkit-tap-highlight-color: transparent;
}
body { 
    font-family: 'Inter', sans-serif; 
    background: #f3f4f6; 
    overflow: hidden; 
    transition: background-color 0.5s ease;
}
/* C√ÅC CSS G·ªêC GI·ªÆ NGUY√äN */
.brand-font { font-family: 'League Spartan', sans-serif; }
.sb-green { background-color: #006241; }
.tab-active { background-color: #006241 !important; color: white !important; font-weight: 900; }
.category-tab { padding: 6px 16px; font-size: 0.85rem; font-weight: 800; border-radius: 12px; border: 2px solid #f3f4f6; white-space: nowrap; }
#loading-overlay { display: flex; position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999; align-items: center; justify-content: center; flex-direction: column; gap: 1rem; }
.capitalize-first { text-transform: lowercase; display: inline-block; } .capitalize-first::first-letter { text-transform: uppercase; }
.history-item-active { border-color: #006241 !important; background-color: #f0fdf4 !important; }
.menu-item-name { text-transform: uppercase; font-size: 1rem; font-weight: 900; line-height: 1.1; }
.receipt-line { border-bottom: 1px dashed #f1f3f5; padding: 10px 0; display: flex; justify-content: space-between; align-items: flex-start; }
.refund-selected { background-color: #fee2e2 !important; border-left: 5px solid #ef4444 !important; }
.modal-active { display: flex !important; }
/* Dark Mode */
.dark-theme { background-color: #1a1a1a !important; color: #e5e5e5; }
.dark-theme #view-payment { background-color: #262626 !important; }
.dark-theme h2, .dark-theme p, .dark-theme label { color: #e5e5e5 !important; }
.dark-theme #cash-paid { background-color: #333 !important; color: #4ade80 !important; }
.dark-theme #cash-detail-box { background-color: #333 !important; }
.dark-theme #btn-cash, .dark-theme #btn-bank { background-color: #333 !important; border-color: #4ade80 !important; color: #4ade80 !important; }
/* Bed Layout */
.bed-box { aspect-ratio: 1; border-radius: 1.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 900; text-transform: uppercase; cursor: pointer; transition: all 0.3s; position: relative; }
.bed-free { background-color: #f0fdf4; border: 4px solid #f0fdf4; color: #006241; }
.bed-busy { background-color: #1a1a1a; border: 4px solid #006241; color: white; }
.bed-selected { border-color: #ef4444; transform: scale(0.95); }
/* Custom Scrollbar */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #D1D1D6; border-radius: 10px; }
</style>
</head>
<body class="flex p-3 gap-3 text-left">

<div id="loading-overlay">
    <div class="w-16 h-16 border-4 border-[#006241] border-t-transparent rounded-full animate-spin"></div>
    <p class="brand-font text-[#006241] text-2xl font-black tracking-widest animate-pulse">The cafe 33</p>
    <p class="text-xs text-gray-400 font-bold" id="loading-text">ƒêang k·∫øt n·ªëi d·ªØ li·ªáu...</p>
</div>

<div class="flex-1 bg-white rounded-[2.5rem] shadow-xl overflow-hidden flex flex-col relative border-2 border-white transition-colors duration-500" id="main-container">

    <div class="px-6 py-4 border-b border-gray-50 flex justify-between items-center bg-white z-10" id="header-bar">
        <div class="flex items-center gap-6">
            <h2 class="brand-font text-3xl text-[#006241] whitespace-nowrap cursor-pointer hover:opacity-70 transition-all" onclick="switchView('menu')">The cafe 33</h2>
            <div class="flex gap-2">
                <button onclick="openRevenue()" id="btn-nav-revenue" class="bg-amber-100 text-amber-600 px-5 py-2.5 rounded-xl text-[10px] font-black uppercase active:scale-95 transition-all">Doanh thu</button>
                <button onclick="openHistory()" id="btn-nav-history" class="bg-gray-100 text-gray-400 px-5 py-2.5 rounded-xl text-[10px] font-black uppercase active:scale-95 transition-all">L·ªãch s·ª≠</button>
                <button onclick="openBedManager()" id="btn-nav-bed" class="bg-gray-100 text-gray-400 px-5 py-2.5 rounded-xl text-[10px] font-black uppercase active:scale-95 transition-all">Cafe in Bed</button>
            </div>
        </div>
        <p id="clock" class="text-[10px] font-black text-gray-300"></p>
    </div>

    <div id="category-bar" class="px-6 py-2 border-b border-gray-50 bg-gray-50/30 flex gap-2 overflow-x-auto"><div id="tabs-container" class="flex gap-2"></div></div>

    <div class="flex-1 overflow-hidden relative">
        
        <div id="view-menu" class="h-full p-5 overflow-y-auto text-center"><div id="menu-grid" class="grid grid-cols-3 gap-4"></div></div>

        <div id="view-payment" class="hidden h-full p-8 bg-gray-50 flex flex-col animate-fade-in text-left">
            <div class="flex justify-between items-center mb-6"><h2 class="brand-font text-4xl text-[#006241] uppercase font-black text-center w-full">Thanh to√°n</h2><button onclick="switchView('menu')" class="text-gray-400 font-bold uppercase text-xs border-b-2 absolute right-10">Quay l·∫°i</button></div>
            <div class="grid grid-cols-2 gap-6 flex-1">
                <div class="space-y-4">
                    <button id="btn-cash" onclick="setMethod('Ti·ªÅn m·∫∑t')" class="w-full p-6 rounded-3xl border-4 border-[#006241] bg-white text-xl font-bold text-[#006241] flex justify-between items-center shadow-md">Ti·ªÅn m·∫∑t ‚úì</button> 
                    <button id="btn-bank" onclick="setMethod('Chuy·ªÉn kho·∫£n')" class="w-full p-6 rounded-3xl border-4 border-transparent bg-white text-xl font-bold text-gray-300 flex justify-between items-center shadow-md uppercase tracking-tighter">Chuy·ªÉn kho·∫£n</button>
                </div>
                <div id="cash-detail-box" class="bg-white p-6 rounded-[2.5rem] shadow-md flex flex-col justify-center text-center">
                    <label class="block font-bold text-gray-300 uppercase text-[9px] mb-3 tracking-widest text-center">Kh√°ch ƒë∆∞a</label>
                    <div id="cash-suggestions" class="flex justify-center gap-2 mb-4"></div>
                    <input type="number" id="cash-paid" onfocus="this.value=''" onblur="if(this.value=='') this.value=currentTotal; calcChange();" oninput="calcChange()" class="w-full p-5 bg-gray-50 rounded-2xl text-4xl font-black text-[#006241] outline-none text-center" placeholder="0">
                    <div class="mt-6 pt-5 border-t border-dashed text-center"><p class="font-bold text-gray-300 uppercase text-[9px] mb-1">Ti·ªÅn th·ª´a</p><p id="cash-change" class="text-5xl font-black text-amber-600">0</p></div>
                </div>
            </div>
            <button onclick="completeOrder()" id="btn-done" class="w-full py-8 mt-4 sb-green text-white font-black text-2xl rounded-3xl uppercase shadow-2xl active:scale-95 transition-all tracking-[0.2em]">Ho√†n t·∫•t</button>
        </div>

        <div id="view-history" class="hidden h-full flex overflow-hidden bg-white" onclick="switchView('menu')">
            <div id="history-left-col" class="w-[320px] border-r border-gray-100 overflow-y-auto p-4 space-y-4 bg-gray-50/50" onclick="event.stopPropagation()"><div id="history-container" class="space-y-3"></div></div>
            <div class="flex-1 p-6 flex flex-col items-center bg-white relative overflow-hidden" onclick="event.stopPropagation()">
                <div id="history-detail-empty" class="h-full flex flex-col items-center justify-center opacity-10 text-center"><h1 class="brand-font text-8xl text-[#006241]">The cafe 33</h1></div>
                <div id="history-detail-content" class="hidden w-full h-full flex flex-col animate-fade-in text-left"></div>
                <button onclick="switchView('menu')" class="absolute top-4 right-4 w-10 h-10 bg-gray-50 text-gray-400 rounded-full flex items-center justify-center font-bold">X</button>
            </div>
        </div>

        <div id="view-bed" class="hidden h-full flex gap-3 bg-[#F2F2F7] p-3 rounded-[24px]">
            <div class="w-[30%] flex flex-col bg-white rounded-[20px] shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-4 py-3 border-b border-gray-50 bg-white sticky top-0 z-10 flex justify-between items-center">
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Danh s√°ch</span>
                    <span id="today-date-display" class="text-[10px] font-bold text-[#1e3932] bg-green-50 px-2 py-1 rounded-md">H√¥m nay</span>
                </div>
                <div id="col-left-list" class="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar"></div>
            </div>
            <div class="w-[50%] flex flex-col bg-white rounded-[20px] shadow-sm border border-gray-100 overflow-hidden relative">
                <div id="detail-empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-gray-300">
                    <p class="font-medium text-xs">Ch·ªçn l·ªãch ƒë·ªÉ xem</p>
                </div>
                <div id="detail-content-panel" class="hidden flex-col h-full overflow-y-auto custom-scrollbar">
                    <div class="bg-gradient-to-r from-[#1e3932] to-[#0f2922] p-4 text-white shrink-0 relative">
                        <div class="flex justify-between items-start">
                            <div><div class="opacity-70 text-[10px] uppercase font-bold tracking-widest mb-1">ƒêang ch·ªçn</div><h1 class="text-2xl font-black" id="detail-bed-name">BED 01</h1></div>
                            <div id="detail-status-badge" class="px-2 py-1 bg-white/20 backdrop-blur rounded-lg text-[10px] font-bold uppercase">ACTIVE</div>
                        </div>
                    </div>
                    <div class="p-4 space-y-3">
                        <div id="detail-timer-box" class="hidden text-center py-3 bg-gray-50 rounded-xl border border-gray-100">
                            <span class="text-[10px] text-gray-400 uppercase font-bold">Th·ªùi gian c√≤n l·∫°i</span>
                            <div id="detail-countdown" class="text-4xl font-black text-[#006241] font-mono tracking-tighter">00:00</div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="bg-blue-50 p-3 rounded-xl border border-blue-100"><p class="text-[10px] text-blue-400 font-bold uppercase mb-1">Ng∆∞·ªùi ƒë·∫∑t</p><p class="font-bold text-gray-800 text-sm truncate" id="detail-cust-name">--</p><p class="font-mono text-xs text-gray-500" id="detail-cust-phone">--</p></div>
                            <div class="bg-purple-50 p-3 rounded-xl border border-purple-100"><p class="text-[10px] text-purple-400 font-bold uppercase mb-1">Ng∆∞·ªùi ƒëi c√πng</p><p class="font-bold text-gray-800 text-sm truncate" id="detail-comp-name">--</p><p class="font-mono text-xs text-gray-500" id="detail-comp-phone">--</p></div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-100 text-xs space-y-2">
                            <div class="flex justify-between"><span class="text-gray-400">B·∫Øt ƒë·∫ßu:</span><span class="font-bold" id="detail-start">--:--</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">K·∫øt th√∫c:</span><span class="font-bold" id="detail-end">--:--</span></div>
                            <div id="row-checkout-time" class="hidden flex justify-between pt-2 border-t border-dashed border-gray-200"><span class="text-gray-500 font-bold">ƒê√£ tr·∫£:</span><span class="font-bold text-red-600" id="detail-real-end">--:--</span></div>
                        </div>
                        <div id="detail-action-buttons" class="mt-auto">
                            <div class="grid grid-cols-2 gap-2">
                                <button id="btn-action-order" class="py-3 rounded-xl bg-amber-100 text-amber-800 font-bold hover:bg-amber-200 transition text-xs flex justify-center items-center gap-1"><span>Order n∆∞·ªõc</span></button>
                                <button id="btn-action-checkout" class="py-3 rounded-xl bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 transition text-xs flex justify-center items-center gap-1"><span>Check Out</span></button>
                            </div>
                            <div id="wrapper-btn-cancel" class="mt-3 pt-2 border-t border-dashed border-gray-200 hidden">
                                <button id="btn-action-cancel" class="w-full py-2 rounded-lg text-red-400 font-bold hover:bg-red-50 hover:text-red-600 transition text-[10px] uppercase tracking-wider flex justify-center items-center gap-1"><span>H·ªßy L·ªãch N√†y</span></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="w-[20%] flex flex-col gap-3">
                <button onclick="openBookingModal()" class="w-full bg-[#006241] hover:bg-[#004f32] text-white py-4 rounded-[20px] font-bold shadow-md transform active:scale-95 transition-all flex flex-col items-center justify-center gap-1"><span class="text-xs uppercase tracking-wider">ƒê·∫∑t M·ªõi</span></button>
                <div class="flex-1 bg-white rounded-[20px] shadow-sm border border-gray-100 p-3 flex flex-col overflow-hidden"><h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3 text-center">Live Map</h3><div class="flex-1 flex flex-col gap-2 overflow-y-auto custom-scrollbar" id="vertical-map-container"></div></div>
            </div>
        </div>
    </div>
</div>

<div id="sidebar-cart" class="w-[360px] bg-white rounded-[2.5rem] shadow-2xl flex flex-col p-4 border-l-4 border-[#006241] text-left">
    <div class="flex justify-between items-center mb-3"><h2 class="brand-font text-lg uppercase">ƒê∆°n h√†ng</h2><button id="btn-clear-all" onclick="clearFullOrder()" class="bg-red-50 text-red-500 text-[9px] font-black px-3 py-1.5 rounded-xl uppercase">X√≥a</button></div>
    <input type="tel" id="kh-sdt" oninput="checkSdtLive()" placeholder="SƒêT kh√°ch..." class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none border-2 border-gray-50 text-center font-bold text-base"><p id="sdt-status" class="text-[8px] font-black uppercase mb-3 text-center"></p>
    <div id="cart-list" class="flex-1 overflow-y-auto space-y-1.5 mb-3 pr-1 text-left"></div>
    <div class="bg-gray-50 p-4 rounded-2xl space-y-3 shadow-inner text-left">
        <div class="flex justify-between items-end"><span class="font-bold text-gray-400 text-[10px] uppercase text-left">T·ªïng bill</span><span id="total-price" class="text-3xl font-black text-[#006241]">0</span></div>
        <button id="sidebar-pay-btn" onclick="switchView('payment')" class="w-full py-4 sb-green text-white font-black rounded-xl uppercase shadow-xl active:scale-95 transition-all">Thanh to√°n</button>
    </div>
</div>

<div id="bed-select-modal" class="fixed inset-0 bg-black/80 z-[10000] hidden flex items-center justify-center p-6 backdrop-blur-md">
    <div class="bg-white w-full max-w-md rounded-[3rem] p-8 text-center">
        <h3 class="brand-font text-2xl text-[#006241] mb-2 uppercase font-black">Ch·ªçn v·ªã tr√≠ Bed</h3>
        <p class="text-xs text-gray-400 font-bold mb-6 uppercase">Kh√°ch ƒë√£ thanh to√°n xong. M·ªùi v√†o Bed:</p>
        <div class="grid grid-cols-2 gap-4 aspect-square mb-6">
            <button onclick="finalizeBedCheckIn(1)" class="p-4 rounded-2xl bg-gray-100 hover:bg-[#006241] hover:text-white font-black text-xl transition-all">BED 1</button>
            <button onclick="finalizeBedCheckIn(3)" class="p-4 rounded-2xl bg-gray-100 hover:bg-[#006241] hover:text-white font-black text-xl transition-all">BED 3</button>
            <button onclick="finalizeBedCheckIn(2)" class="p-4 rounded-2xl bg-gray-100 hover:bg-[#006241] hover:text-white font-black text-xl transition-all">BED 2</button>
            <button onclick="finalizeBedCheckIn(4)" class="p-4 rounded-2xl bg-gray-100 hover:bg-[#006241] hover:text-white font-black text-xl transition-all">BED 4</button>
        </div>
        <button onclick="document.getElementById('bed-select-modal').classList.add('hidden')" class="text-gray-400 text-xs font-bold uppercase underline">B·ªè qua (Ch·ªâ t√≠nh ti·ªÅn)</button>
    </div>
</div>
<div id="walk-in-modal" class="fixed inset-0 bg-black/40 z-[9999] hidden flex items-center justify-center p-6 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-[2.5rem] p-10 shadow-2xl text-center"><h3 class="brand-font text-xl text-[#006241] mb-4 uppercase font-black">Kh√°ch v√£ng lai</h3><input type="tel" id="walkin-phone" placeholder="Nh·∫≠p SƒêT kh√°ch..." class="w-full p-4 bg-gray-50 rounded-2xl text-center font-bold mb-3 outline-none border focus:border-[#006241]"><input type="number" id="walkin-hours" placeholder="S·ªë gi·ªù (1, 2, 3...)" class="w-full p-4 bg-gray-50 rounded-2xl text-center font-bold mb-6 outline-none border focus:border-[#006241]"><div class="flex gap-3"><button onclick="document.getElementById('walk-in-modal').classList.add('hidden')" class="flex-1 py-4 bg-gray-100 text-gray-400 font-black rounded-2xl uppercase text-xs">Hu·ª∑</button><button onclick="submitWalkIn()" class="flex-1 py-4 sb-green text-white font-black rounded-2xl uppercase text-xs shadow-lg">T·∫°o ƒë∆°n</button></div></div></div>
<div id="app-modal" class="fixed inset-0 bg-black/40 z-[9999] hidden flex items-center justify-center p-6 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-[2.5rem] p-10 shadow-2xl text-center"><div id="app-modal-icon" class="text-5xl mb-4"></div><h3 id="app-modal-title" class="brand-font text-xl text-[#006241] mb-2 uppercase font-black text-center">Th√¥ng b√°o</h3><div id="app-modal-msg" class="text-sm text-[#1e3932] font-bold mb-8 brand-font text-center"></div><button onclick="document.getElementById('app-modal').classList.add('hidden')" class="w-full py-4 sb-green text-white font-black rounded-2xl uppercase shadow-lg">X√°c nh·∫≠n</button></div></div>
<div id="confirm-modal" class="fixed inset-0 bg-black/40 z-[10000] hidden flex items-center justify-center p-6 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-[2.5rem] p-10 shadow-2xl text-center border-t-8 border-red-500"><div class="text-5xl mb-4">‚ö†Ô∏è</div><h3 class="brand-font text-xl text-red-600 mb-2 uppercase font-black text-center">X√°c nh·∫≠n</h3><div id="confirm-msg" class="text-sm text-[#1e3932] font-bold mb-8 brand-font text-center"></div><div class="grid grid-cols-2 gap-4"><button onclick="document.getElementById('confirm-modal').classList.add('hidden')" class="py-4 bg-gray-100 text-gray-500 rounded-2xl font-black uppercase text-xs">Quay l·∫°i</button><button id="confirm-btn-yes" class="py-4 bg-red-500 text-white rounded-2xl font-black uppercase text-xs shadow-lg active:scale-95">ƒê·ªìng √Ω</button></div></div></div>
<div id="size-modal" class="fixed inset-0 bg-black/70 z-[100] hidden items-center justify-center p-6 backdrop-blur-md" onclick="closeSize()"><div class="bg-white w-full max-w-sm rounded-[3rem] p-10 text-center" onclick="event.stopPropagation()"><h3 id="modal-item-name" class="brand-font text-2xl text-[#1e3932] mb-8 uppercase text-center font-black">Ch·ªçn k√≠ch c·ª°</h3><div id="size-options-container" class="grid grid-cols-2 gap-4 text-center"><button id="btn-size-m" class="p-8 rounded-3xl bg-gray-50 border-4 border-transparent hover:border-[#006241] flex flex-col items-center justify-center transition-all text-center"><span class="block text-4xl mb-2">ü•§</span><span class="block font-black text-sm uppercase">SIZE M</span><span id="price-m" class="text-[#006241] font-bold mt-1 text-center"></span></button><button id="btn-size-l" class="p-8 rounded-3xl bg-gray-50 border-4 border-transparent hover:border-[#006241] flex flex-col items-center justify-center transition-all text-center"><span class="block text-5xl mb-2">ü•§</span><span class="block font-black text-sm uppercase">SIZE L</span><span id="price-l" class="text-[#006241] font-bold mt-1 text-center"></span></button></div></div></div>
<div id="modal-add-booking" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden flex items-center justify-center transition-all"><div class="bg-white w-full max-w-lg rounded-[24px] shadow-2xl overflow-hidden transform scale-100 p-6 max-h-[90vh] overflow-y-auto custom-scrollbar"><div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-4"><div><h3 class="text-xl font-black text-[#1e3932]">Check-in Kh√°ch H√†ng</h3><p class="text-xs text-gray-400">Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin theo n·ªôi quy</p></div><button onclick="closeBookingModal()" class="bg-gray-100 hover:bg-gray-200 text-gray-500 rounded-full p-2 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div class="space-y-5"><div class="bg-blue-50 p-4 rounded-xl border border-blue-100 relative"><p class="text-[10px] font-bold text-blue-500 uppercase mb-2 tracking-wider">1. Th√¥ng tin ng∆∞·ªùi ƒë·∫∑t (B·∫Øt bu·ªôc)</p><div class="grid grid-cols-3 gap-3"><div class="col-span-1"><label class="block text-xs font-bold text-gray-500 mb-1">SƒêT</label><input type="text" id="new_cust_phone" onchange="autoFillCustomer()" class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm font-mono focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none" placeholder="Nh·∫≠p SƒêT..."></div><div class="col-span-2 relative"><label class="block text-xs font-bold text-gray-500 mb-1">H·ªç t√™n</label><input type="text" id="new_cust_name" class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm font-bold focus:border-blue-500 outline-none" placeholder="Nh·∫≠p t√™n kh√°ch..."><div id="search-loading" class="hidden absolute right-3 top-8"><svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div></div></div></div><div class="bg-gray-50 p-4 rounded-xl border border-gray-100"><p class="text-[10px] font-bold text-gray-400 uppercase mb-2 tracking-wider">2. Ng∆∞·ªùi ƒëi c√πng (N·∫øu c√≥)</p><div class="grid grid-cols-2 gap-3"><div><label class="block text-xs font-bold text-gray-500 mb-1">H·ªç t√™n</label><input type="text" id="new_comp_name" class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:border-gray-400 outline-none" placeholder="T√™n b·∫°n ƒëi c√πng"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">SƒêT</label><input type="text" id="new_comp_phone" class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm font-mono focus:border-gray-400 outline-none" placeholder="SƒêT b·∫°n..."></div></div></div><div class="bg-amber-50 p-4 rounded-xl border border-amber-100"><p class="text-[10px] font-bold text-amber-600 uppercase mb-2 tracking-wider">3. Th·ªùi gian s·ª≠ d·ª•ng</p><div class="flex gap-2 mb-3 bg-white/50 p-1 rounded-lg"><button onclick="switchTimeMode('duration')" id="tab-duration" class="flex-1 py-1.5 text-xs font-bold rounded-md bg-white shadow-sm text-[#1e3932]">Theo Ti·∫øng</button><button onclick="switchTimeMode('fixed')" id="tab-fixed" class="flex-1 py-1.5 text-xs font-bold rounded-md text-gray-400 hover:bg-white/50">Ch·ªçn Gi·ªù V·ªÅ</button></div><div id="mode-duration" class="grid grid-cols-3 gap-2"><button type="button" onclick="selectDuration(60, this)" class="duration-btn bg-[#1e3932] text-white border border-[#1e3932] font-bold py-2 rounded-lg text-xs shadow-md">1 Gi·ªù</button><button type="button" onclick="selectDuration(120, this)" class="duration-btn bg-white border border-gray-200 text-gray-600 font-bold py-2 rounded-lg text-xs hover:bg-gray-100">2 Gi·ªù</button><button type="button" onclick="selectDuration(180, this)" class="duration-btn bg-white border border-gray-200 text-gray-600 font-bold py-2 rounded-lg text-xs hover:bg-gray-100">3 Gi·ªù</button></div><div id="mode-fixed" class="hidden"><div class="flex items-center gap-3"><label class="text-xs font-bold text-gray-600">Kh√°ch s·∫Ω v·ªÅ l√∫c:</label><input type="time" id="custom_end_time" onchange="calculateDurationFromTime()" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-amber-500 focus:border-amber-500 block w-full p-2.5 font-bold" required></div><p class="text-[10px] text-amber-600 mt-2 font-medium italic text-right" id="calculated-time-hint">-- ph√∫t s·ª≠ d·ª•ng</p></div><input type="hidden" id="final_duration_minutes" value="60"></div><button onclick="submitNewBooking()" id="btn-submit-booking" class="w-full bg-[#006241] hover:bg-[#004f32] text-white font-bold py-4 rounded-xl shadow-lg transform active:scale-95 transition mt-2 flex justify-center items-center gap-2"><span>X√ÅC NH·∫¨N & G·ªåI M√ìN</span></button></div></div></div>

<script>
// --- K·∫æT N·ªêI FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyCNh1-16gYZ0P30Fkd-2tB-O89PXkPX9Lc",
  authDomain: "the-cafe-33.firebaseapp.com",
  databaseURL: "https://the-cafe-33-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "the-cafe-33",
  storageBucket: "the-cafe-33.appspot.com",
  messagingSenderId: "...",
  appId: "..."
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- BI·∫æN TO√ÄN C·ª§C ---
let menu = []; 
let historyData = []; 
let cart = []; 
let currentTotal = 0; 
let currentTab = "T·∫•t c·∫£";
let isPaymentMode = false; 
let myChart = null;
let selectedRefundItems = [];

// Bi·∫øn cho Bed
var currentBedList = [];
var selectedBedIndex = -1;
var bedCountdownInterval = null;
var pendingBedOrder = null;
var activeOrderingBedId = null;

// --- ƒê·ªíNG H·ªí ---
setInterval(() => { 
    document.getElementById('clock').innerText = new Date().toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit', second:'2-digit'}); 
}, 1000);

// --- T·ª∞ ƒê·ªòNG T·∫¢I MENU T·ª™ FIREBASE (Thay th·∫ø google.script.run) ---
db.ref('menu').on('value', (snapshot) => {
  const data = snapshot.val();
  if (data) {
    menu = Array.isArray(data) ? data : Object.values(data);
    console.log("üî• ƒê√£ t·∫£i Menu t·ª´ Firebase:", menu);
    
    // T·∫Øt loading & V·∫Ω giao di·ªán
    document.getElementById('loading-overlay').style.display = 'none';
    if (typeof renderTabs === 'function') renderTabs();
    if (typeof renderMenu === 'function') renderMenu();
  } else {
    console.log("Firebase ch∆∞a c√≥ menu. B·∫°n c·∫ßn ƒë·ªìng b·ªô t·ª´ Sheet l√™n.");
    document.getElementById('loading-text').innerText = "Vui l√≤ng ƒë·ªìng b·ªô Menu...";
  }
});

// --- C√ÅC H√ÄM V·∫º GIAO DI·ªÜN (ƒê·∫¶Y ƒê·ª¶) ---
function renderTabs() { 
    if (!menu) return;
    const cats = ["T·∫•t c·∫£", ...new Set(menu.map(m => m.type))];
    document.getElementById('tabs-container').innerHTML = cats.map(c => 
        `<button onclick="filterTab('${c}')" class="category-tab ${c === currentTab? 'tab-active': 'bg-white text-gray-400'} capitalize-first">${c}</button>`
    ).join(''); 
}

function filterTab(c) { 
    currentTab = c; renderTabs(); renderMenu(); 
}

function renderMenu() { 
    const filtered = currentTab === "T·∫•t c·∫£"? menu: menu.filter(m => m.type === currentTab);
    const grid = document.getElementById('menu-grid');
    if (!grid) return;
    if (filtered.length === 0) { grid.innerHTML = '<div class="col-span-3 text-center text-gray-400 py-10">Kh√¥ng c√≥ m√≥n n√†o.</div>'; return; }
    grid.innerHTML = filtered.map(m => 
        `<div onclick="handleItemClick('${m.name}', ${m.priceM}, ${m.priceL})" class="bg-white p-5 rounded-[2rem] border-2 border-gray-50 shadow-sm flex flex-col justify-center items-center text-center h-32 active:scale-95 cursor-pointer transition-all">
            <p class="font-bold text-[#1e3932] menu-item-name text-center">${m.name}</p>
            <p class="text-[10px] font-bold text-[#006241] mt-2 text-center">${m.priceM > 0 ? m.priceM.toLocaleString() : m.priceL.toLocaleString()}</p>
        </div>`
    ).join('');
}

function handleItemClick(name, pM, pL) { 
    if(isPaymentMode) return; 
    const vM = Number(pM), vL = Number(pL);
    if (vM > 0 && vL > 0) { 
        document.getElementById('modal-item-name').innerText = name; 
        document.getElementById('price-m').innerText = vM.toLocaleString() + 'ƒë';
        document.getElementById('price-l').innerText = vL.toLocaleString() + 'ƒë'; 
        document.getElementById('btn-size-m').onclick = () => { addToCart(name, 'M', vM); closeSize(); };
        document.getElementById('btn-size-l').onclick = () => { addToCart(name, 'L', vL); closeSize(); }; 
        document.getElementById('size-modal').classList.add('modal-active'); 
    } else if (vM > 0) addToCart(name, 'M', vM); else if (vL > 0) addToCart(name, 'L', vL); 
}
function closeSize() { document.getElementById('size-modal').classList.remove('modal-active'); }
function addToCart(name, size, price) { const ex = cart.find(i => i.name === name && i.size === size); if (ex) ex.qty++; else cart.push({ name, size, price, qty: 1 }); renderCart(); }
function renderCart() { 
    const list = document.getElementById('cart-list'); if (!list) return; currentTotal = 0;
    list.innerHTML = cart.map((i, idx) => { currentTotal += i.price * i.qty; return `<div class="bg-gray-50 p-2.5 rounded-xl flex justify-between items-center shadow-sm border border-white text-xs mb-1"><div class="flex-1 pr-2 text-left"><p class="font-black text-[#1e3932] truncate capitalize-first">${i.name} (${i.size})</p></div><div class="flex items-center gap-1.5 bg-white p-1 rounded-lg border border-gray-100"><button onclick="updateQty(${idx}, -1)" class="w-6 h-6 flex items-center justify-center font-black text-gray-300 text-lg ${isPaymentMode ? 'hidden': ''}">-</button><span class="font-black text-[#006241] text-[11px] w-5 text-center">${isPaymentMode?'x': ''}${i.qty}</span><button onclick="updateQty(${idx}, 1)" class="w-6 h-6 flex items-center justify-center font-black text-[#006241] text-lg ${isPaymentMode ? 'hidden' : ''}">+</button></div></div>`; }).join('');
    document.getElementById('total-price').innerText = currentTotal.toLocaleString() + 'ƒë'; updateSuggestions(); 
}
function updateQty(idx, d) { if(isPaymentMode) return; cart[idx].qty += d; if (cart[idx].qty <= 0) cart.splice(idx, 1); renderCart(); }
function clearFullOrder() { if(pendingBedOrder) return alert("ƒêang trong quy tr√¨nh thanh to√°n Bed!"); cart = []; renderCart(); }
function setMethod(m) { const isBank = (m === 'Chuy·ªÉn kho·∫£n'); document.getElementById('btn-cash').className = `w-full p-6 rounded-3xl border-4 bg-white text-xl font-bold flex justify-between items-center shadow-md ${!isBank? 'border-[#006241] text-[#006241]': 'border-transparent text-gray-300'}`; document.getElementById('btn-bank').className = `w-full p-6 rounded-3xl border-4 bg-white text-xl font-bold flex justify-between items-center shadow-md ${isBank? 'border-[#006241] text-[#006241]': 'border-transparent text-gray-300'}`; const box = document.getElementById('cash-detail-box'); document.getElementById('cash-paid').value = currentTotal; if (isBank) box.style.pointerEvents = "none"; else box.style.pointerEvents = "auto"; calcChange(); }
function updateSuggestions() { const vals = [50000, 100000, 200000, 500000].filter(v => v >= currentTotal).slice(0, 3); document.getElementById('cash-suggestions').innerHTML = vals.map(v => `<button onclick="quickPaid(${v})" class="bg-white border-2 border-gray-100 px-3 py-1.5 rounded-xl text-[10px] font-bold text-gray-400 text-center">${v.toLocaleString()}</button>`).join(''); }
function quickPaid(v) { document.getElementById('cash-paid').value = v; calcChange(); }
function calcChange() { const paid = Number(document.getElementById('cash-paid').value) || currentTotal; document.getElementById('cash-change').innerText = (paid - currentTotal > 0 ? (paid - currentTotal).toLocaleString(): 0) + 'ƒë'; }

// --- CHUY·ªÇN C·∫¢NH (VIEW) ---
function switchView(v) {
    isPaymentMode = (v === 'payment');
    ['menu', 'payment', 'history', 'bed'].forEach(id => {
        document.getElementById('view-' + id)?.classList.add('hidden');
        document.getElementById('btn-nav-' + id)?.classList.remove('tab-active');
        let btn = document.getElementById('btn-nav-' + id);
        if(btn) btn.className = 'bg-gray-100 text-gray-400 px-5 py-2.5 rounded-xl text-[10px] font-black uppercase active:scale-95 transition-all';
    });
    let activeBtnClass = 'sb-green text-white px-5 py-2.5 rounded-xl text-[10px] font-black uppercase tab-active';
    if (v === 'revenue' || v === 'history') {
        document.getElementById('view-history').classList.remove('hidden');
        let btnId = v === 'revenue' ? 'btn-nav-revenue' : 'btn-nav-history';
        document.getElementById(btnId).className = activeBtnClass;
    } else if (v === 'bed') {
        document.getElementById('view-bed').classList.remove('hidden');
        document.getElementById('btn-nav-bed').className = activeBtnClass;
    } else {
        document.getElementById('view-' + v).classList.remove('hidden');
    }
    document.getElementById('sidebar-cart').classList.toggle('hidden', v !== 'menu' && v !== 'payment');
    document.getElementById('category-bar').classList.toggle('hidden', v !== 'menu');
    
    if (v !== 'payment') {
        document.body.classList.remove('dark-theme');
        document.getElementById('header-bar')?.classList.remove('dark-theme');
    } else {
        setMethod('Ti·ªÅn m·∫∑t');
        document.getElementById('cash-paid').value = currentTotal;
        calcChange();
        if (pendingBedOrder || (activeOrderingBedId && activeOrderingBedId != 0)) {
            document.body.classList.add('dark-theme');
            document.getElementById('header-bar')?.classList.add('dark-theme');
        }
    }
}

// --- LOGIC THANH TO√ÅN (ƒê·∫®Y L√äN FIREBASE) ---
function completeOrder() {
    if (cart.length === 0) return showAppModal("Hic!", "Ch∆∞a c√≥ m√≥n n√†o!", 'üõí');
    let pVal = document.getElementById('cash-paid').value;
    if (pVal === "" || pVal === "0") pVal = currentTotal;
    const paid = Number(pVal);
    if (paid < currentTotal) return alert("Ti·ªÅn kh√°ch ƒë∆∞a ch∆∞a ƒë·ªß!");

    document.getElementById('loading-overlay').style.display = 'flex';
    var bedIdToSend = ""; var custNameToSend = "Kh√°ch v√£ng lai";
    if (pendingBedOrder) { bedIdToSend = pendingBedOrder.bedId || "WAITING"; custNameToSend = pendingBedOrder.name; } 
    else if (activeOrderingBedId) { bedIdToSend = activeOrderingBedId; }

    const orderData = {
        sdt: document.getElementById('kh-sdt').value || "Kh√°ch v√£ng lai",
        total: currentTotal, paid: paid, change: Math.max(0, paid - currentTotal),
        method: document.getElementById('btn-bank').classList.contains('border-[#006241]') ? 'Chuy·ªÉn kho·∫£n' : 'Ti·ªÅn m·∫∑t',
        items: cart.map(i => `${i.name}(${i.size})x${i.qty}`).join(', '),
        itemsArray: cart,
        bedId: bedIdToSend, customerName: custNameToSend,
        createdAt: new Date().toISOString(),
        status: "pending_sync"
    };

    // ƒê·∫©y ƒë∆°n h√†ng l√™n Firebase 'orders'
    db.ref('orders').push(orderData, (error) => {
        document.getElementById('loading-overlay').style.display = 'none';
        if(error) alert("L·ªói Firebase: " + error.message);
        else {
            cart = []; document.getElementById('kh-sdt').value = ""; document.getElementById('sdt-status').innerText = ""; renderCart();
            if (pendingBedOrder) {
                if (!pendingBedOrder.bedId || pendingBedOrder.bedId == 0) document.getElementById('bed-select-modal').classList.remove('hidden');
                else { showAppModal("Th√†nh c√¥ng!", "ƒê√£ th√™m m√≥n cho " + pendingBedOrder.name, '‚úÖ'); openBedManager(); }
            } else {
                switchView('menu'); setTimeout(() => { showAppModal("Xong!", "Thanh to√°n th√†nh c√¥ng!", '‚úÖ'); }, 150);
            }
        }
    });
}

// --- LOGIC BED MANAGER (L·∫§Y T·ª™ FIREBASE) ---
function openBedManager() {
    document.getElementById('loading-overlay').style.display = 'flex';
    switchView('bed');
    var dateEl = document.getElementById('today-date-display');
    if(dateEl) dateEl.innerText = new Date().toLocaleDateString('vi-VN');

    // Nghe d·ªØ li·ªáu Bed t·ª´ Firebase (C·∫ßn ƒë·ªìng b·ªô Bed t·ª´ Sheet l√™n Firebase n·∫øu mu·ªën d√πng)
    db.ref('beds').once('value', (snapshot) => {
        document.getElementById('loading-overlay').style.display = 'none';
        const data = snapshot.val();
        currentBedList = data ? (Array.isArray(data) ? data : Object.values(data)) : [];
        renderBedBookings(currentBedList);
    });
}

function renderBedBookings(list) {
    selectedBedIndex = -1;
    document.getElementById('detail-empty-state')?.classList.remove('hidden');
    document.getElementById('detail-content-panel')?.classList.add('hidden');
    stopPanelCountdown();
    renderLeftColumnList();
    renderRightColumnMap();
}

function renderLeftColumnList() {
    var container = document.getElementById('col-left-list');
    if(!container) return;
    if (!currentBedList || currentBedList.length === 0) { container.innerHTML = '<div class="text-center text-gray-300 text-[10px] py-10">Tr·ªëng</div>'; return; }
    container.innerHTML = currentBedList.map(function(b, index) {
        var isDone = (b.status && b.status.includes('ƒë√£ xong'));
        var isCancelled = (b.status && b.status.includes('ƒë√£ h·ªßy'));
        var isActive = (index === selectedBedIndex);
        var hasBed = (b.bedId && b.bedId.toString().trim() !== "");
        var wrapperClass = "cursor-pointer p-3 rounded-xl transition-all mb-2 border " + (isActive ? "bg-[#1e3932] border-[#1e3932] text-white shadow-md scale-[1.02]" : (isCancelled ? "bg-red-50 border-red-100 text-red-800 opacity-80" : (isDone ? "bg-gray-100 border-transparent text-gray-400" : "bg-white border-gray-100 text-gray-600 hover:bg-gray-50")));
        var statusDot = isCancelled ? "bg-red-500" : (isDone ? "bg-gray-400" : (hasBed ? "bg-green-500" : "bg-amber-400 animate-pulse"));
        var timeDisplay = isDone ? `ƒê√£ tr·∫£: ${b.end}` : (isCancelled ? `ƒê√É H·ª¶Y L·ªäCH` : `${b.start} - ${b.end}`);
        return `<div onclick="selectBedItem(${index})" class="${wrapperClass}"><div class="flex justify-between items-center mb-1"><span class="font-bold text-xs opacity-80">${hasBed ? `BED ${b.bedId}` : `CH·ªú X·∫æP`}</span><div class="w-2 h-2 rounded-full ${statusDot}"></div></div><div class="font-bold text-sm truncate ${isDone || isCancelled ? 'opacity-60':''}">${b.name}</div><div class="text-[10px] font-mono flex justify-between opacity-70"><span>${timeDisplay}</span></div></div>`;
    }).join('');
}

function renderRightColumnMap() {
    var container = document.getElementById('vertical-map-container');
    if(!container) return;
    var html = '';
    for (var i = 1; i <= 4; i++) {
        var booking = currentBedList.find(b => b.bedId == i && b.status && !b.status.includes('ƒë√£ xong') && !b.status.includes('ƒë√£ h·ªßy'));
        var boxStyle = booking ? ((booking.status.includes('ƒëang d√πng') || booking.status.includes('active')) ? "bg-green-500 border-green-600 text-white shadow-md ring-2 ring-green-100 hover:scale-105 cursor-pointer" : "bg-amber-50 border-amber-300 text-amber-500 hover:scale-105 cursor-pointer") : "bg-gray-50 border-gray-200 text-gray-300";
        var label = booking ? ((booking.status.includes('ƒëang d√πng') || booking.status.includes('active')) ? "ACTIVE" : "ƒê·∫∂T") : "TR·ªêNG";
        var actionAttr = booking ? `onclick="selectBedFromMap(${i})"` : "";
        html += `<div ${actionAttr} class="flex-1 rounded-xl border-2 border-dashed ${boxStyle} flex flex-col items-center justify-center transition-all min-h-[50px] mb-2 relative group"><span class="text-lg font-black">0${i}</span><span class="text-[8px] font-bold tracking-wider">${label}</span>${booking ? `<div class="absolute inset-0 flex items-center justify-center bg-black/10 opacity-0 group-hover:opacity-100 rounded-xl transition-opacity"><span class="text-[10px] font-bold text-white">Xem</span></div>` : ''}</div>`;
    }
    container.innerHTML = html;
}

function selectBedFromMap(bedId) {
    var index = currentBedList.findIndex(b => b.bedId == bedId && b.status && !b.status.includes('ƒë√£ xong') && !b.status.includes('ƒë√£ h·ªßy'));
    if (index !== -1) { selectBedItem(index); var listItem = document.getElementById('col-left-list').children[index]; if(listItem) listItem.scrollIntoView({behavior: 'smooth', block: 'center'}); }
}

function selectBedItem(index) {
    selectedBedIndex = index; renderLeftColumnList(); 
    var data = currentBedList[index];
    var panel = document.getElementById('detail-content-panel');
    var empty = document.getElementById('detail-empty-state');
    var isDone = (data.status && data.status.includes('ƒë√£ xong'));
    var isCancelled = (data.status && data.status.includes('ƒë√£ h·ªßy'));
    var isActive = (data.status && (data.status.includes('ƒëang d√πng') || data.status.includes('active')));
    var hasBed = (data.bedId && data.bedId.toString().trim() !== "");

    if(empty) empty.classList.add('hidden');
    if(panel) { panel.classList.remove('hidden'); panel.classList.add('flex'); }

    document.getElementById('detail-bed-name').innerText = hasBed ? `BED ${data.bedId}` : "CH·ªú X·∫æP";
    document.getElementById('detail-status-badge').innerText = isDone ? "ƒê√É XONG" : (isCancelled ? "ƒê√É H·ª¶Y" : (isActive ? "ACTIVE" : "CH·ªú KH√ÅCH"));
    document.getElementById('detail-cust-name').innerText = data.name;
    document.getElementById('detail-cust-phone').innerText = data.phone;
    document.getElementById('detail-start').innerText = data.start;
    document.getElementById('detail-end').innerText = data.end;
    document.getElementById('detail-comp-name').innerText = data.compName || "Ch∆∞a c√≥";
    document.getElementById('detail-comp-phone').innerText = data.compPhone || "--";

    var rowCheckout = document.getElementById('row-checkout-time');
    var actionBtns = document.getElementById('detail-action-buttons');
    var timerBox = document.getElementById('detail-timer-box');
    var wrapperCancel = document.getElementById('wrapper-btn-cancel');

    if (isDone || isCancelled) {
        if(rowCheckout) { rowCheckout.classList.remove('hidden'); document.getElementById('detail-real-end').innerText = isCancelled ? "ƒê√£ h·ªßy" : data.end; }
        if(actionBtns) actionBtns.classList.add('hidden');
        if(timerBox) timerBox.classList.add('hidden');
        if(wrapperCancel) wrapperCancel.classList.add('hidden');
        stopPanelCountdown();
    } else {
        if(rowCheckout) rowCheckout.classList.add('hidden');
        if(actionBtns) actionBtns.classList.remove('hidden');
        if(wrapperCancel) wrapperCancel.classList.remove('hidden');
        
        var btnOrder = document.getElementById('btn-action-order');
        var btnCheckout = document.getElementById('btn-action-checkout');
        var canInteract = true;
        var timeMsg = "";

        if (!isActive) {
            var now = new Date(); var startObj = parseTimeObj(data.start);
            if (startObj) {
                var diffMinutes = (now - startObj) / 60000;
                if (diffMinutes < -30) { canInteract = false; timeMsg = `(S·ªõm ${Math.abs(Math.round(diffMinutes))}p)`; }
                else if (diffMinutes > 50) { canInteract = false; timeMsg = `(Qu√° ${Math.round(diffMinutes)}p)`; }
            }
        }

        if (btnOrder) {
            btnOrder.disabled = !canInteract;
            btnOrder.className = canInteract ? "py-3 rounded-xl bg-amber-100 text-amber-800 font-bold hover:bg-amber-200 transition text-xs flex justify-center items-center gap-1" : "py-3 rounded-xl bg-gray-100 text-gray-400 font-bold cursor-not-allowed text-xs flex justify-center items-center gap-1";
            var span = btnOrder.querySelector('span'); if(span) span.innerText = canInteract ? "‚òï G·ªçi M√≥n" : "‚õî " + timeMsg;
            btnOrder.onclick = function() { showBedDetail(data.bedId); };
        }

        if (btnCheckout) {
            if (!hasBed) {
                 btnCheckout.disabled = !canInteract;
                 btnCheckout.innerHTML = canInteract ? '<span>üõèÔ∏è X·∫øp Bed Ngay</span>' : `<span>‚õî ${timeMsg}</span>`;
                 btnCheckout.onclick = function() { if(!canInteract) return; pendingBedOrder = data; document.getElementById('bed-select-modal').classList.remove('hidden'); };
            } else {
                 btnCheckout.disabled = false;
                 btnCheckout.innerHTML = '<span>üèÅ Tr·∫£ Bed</span>';
                 btnCheckout.onclick = async function() {
                    if (confirm(`X√°c nh·∫≠n kh√°ch ƒë√£ xong v√† thanh to√°n?`)) {
                        btnCheckout.innerHTML = 'Wait...';
                        // G·ª≠i y√™u c·∫ßu checkout l√™n Firebase (ƒë∆°n gi·∫£n l√† c·∫≠p nh·∫≠t status)
                        db.ref('beds/' + index).update({status: 'ƒë√£ xong', endTimeReal: new Date().toLocaleTimeString()});
                        openBedManager();
                    }
                };
            }
        }
        if (hasBed && data.end) { if(timerBox) timerBox.classList.remove('hidden'); startPanelCountdown(data.end); } else { stopPanelCountdown(); }
    }
}

// --- ORDER LOGIC ---
function showBedDetail(bedId) {
    var booking = null;
    if (bedId && bedId != 0) booking = currentBedList.find(b => b.bedId == bedId);
    if (!booking && selectedBedIndex > -1) booking = currentBedList[selectedBedIndex];
    if (!booking) { alert("Vui l√≤ng ch·ªçn kh√°ch h√†ng trong danh s√°ch tr∆∞·ªõc!"); return; }

    activeOrderingBedId = bedId; pendingBedOrder = booking; 
    switchView('menu');

    setTimeout(function() {
        var cartInfo = document.getElementById('cart-bed-info');
        var headerContainer = document.querySelector('#sidebar-cart .flex.justify-between');
        if (!cartInfo && headerContainer) { cartInfo = document.createElement('div'); cartInfo.id = 'cart-bed-info'; headerContainer.parentNode.insertBefore(cartInfo, headerContainer.nextSibling); }
        if (cartInfo) {
            var guestName = booking.name || "Kh√°ch h√†ng";
            cartInfo.className = "text-[11px] font-black uppercase mb-2 pl-1 mt-1";
            if (booking.bedId && booking.bedId != 0) { cartInfo.innerText = `üü¢ BED 0${booking.bedId} - ${guestName}`; cartInfo.style.color = "#006241"; } 
            else { cartInfo.innerText = `üü† KH√ÅCH CH·ªú - ${guestName}`; cartInfo.style.color = "#d97706"; }
        }
    }, 50);
}

// --- BED CHECKIN (FIREBASE) ---
function finalizeBedCheckIn(bedId) {
    if (!pendingBedOrder) return;
    const isBusy = currentBedList.find(b => (b.status.includes('ƒëang d√πng') || b.status.includes('active')) && b.bedId == bedId);
    if (isBusy) return alert("Bed n√†y ƒëang c√≥ kh√°ch!");

    var now = new Date(); var startObj = parseTimeObj(pendingBedOrder.start); var endObj = parseTimeObj(pendingBedOrder.end);
    var newEndTimeStr = pendingBedOrder.end; 

    if (startObj && endObj) {
        var diffMinutes = (now - startObj) / 60000;
        if (diffMinutes < 0) {
            endObj.setMinutes(endObj.getMinutes() + Math.round(diffMinutes));
            newEndTimeStr = ("0" + endObj.getHours()).slice(-2) + ":" + ("0" + endObj.getMinutes()).slice(-2);
        }
    }

    document.getElementById('bed-select-modal').classList.add('hidden');
    document.getElementById('loading-overlay').style.display = 'flex';

    // C·∫≠p nh·∫≠t Firebase
    // L∆∞u √Ω: C·∫ßn bi·∫øt ID c·ªßa bed trong firebase. ·ªû ƒë√¢y gi·∫£ ƒë·ªãnh 'pendingBedOrder' c√≥ thu·ªôc t√≠nh key ho·∫∑c index
    alert("ƒêang c·∫≠p nh·∫≠t Firebase...");
    document.getElementById('loading-overlay').style.display = 'none';
    pendingBedOrder = null; isPaymentMode = false; openBedManager();
}

// --- BOOKING (FIREBASE) ---
function submitNewBooking() {
    var phone = document.getElementById('new_cust_phone').value;
    var name = document.getElementById('new_cust_name').value;
    var duration = document.getElementById('final_duration_minutes').value;
    if (!phone || !name) return alert("Vui l√≤ng nh·∫≠p SƒêT v√† T√™n!");

    var btn = document.getElementById('btn-submit-booking');
    btn.innerHTML = "‚è≥ ƒêang t·∫°o..."; btn.disabled = true;

    // ƒê·∫©y booking m·ªõi l√™n Firebase 'beds'
    const newBooking = {
        phone: phone, name: name, duration: duration, type: "walk-in",
        compName: document.getElementById('new_comp_name').value,
        compPhone: document.getElementById('new_comp_phone').value,
        start: new Date().toLocaleTimeString(),
        end: "Calculating...", // C·∫ßn logic t√≠nh gi·ªù
        status: "ch·ªù kh√°ch",
        bedId: ""
    };
    
    db.ref('beds').push(newBooking, (error) => {
        btn.innerHTML = "X√ÅC NH·∫¨N & G·ªåI M√ìN"; btn.disabled = false;
        if(!error) { closeBookingModal(); openBedManager(); }
    });
}

function submitWalkIn() {
    var phone = document.getElementById('walkin-phone').value;
    var hours = document.getElementById('walkin-hours').value;
    if(!phone || !hours) return;
    document.getElementById('walk-in-modal').classList.add('hidden');
    document.getElementById('loading-overlay').style.display = 'flex';
    
    // ƒê·∫©y ƒë∆°n v√£ng lai
    db.ref('beds').push({
        phone: phone, name: "Kh√°ch v√£ng lai", duration: hours*60, type: "walk-in", status: "ch·ªù kh√°ch"
    });
    
    document.getElementById('loading-overlay').style.display = 'none';
    openBedManager();
}

// --- KH√ÅCH H√ÄNG (CHECK MEMBERS) ---
function checkSdtLive() {
    const sdt = document.getElementById('kh-sdt').value;
    if (sdt.length >= 10) {
        db.ref('members').orderByChild('phone').equalTo(sdt).once('value', snapshot => {
            const status = document.getElementById('sdt-status');
            if (snapshot.exists()) {
                const member = Object.values(snapshot.val())[0];
                status.innerText = "‚òÖ TH√ÄNH VI√äN: " + member.name; 
                status.className = "text-[8px] font-black text-green-500 uppercase mt-1 text-center"; 
            } else { 
                status.innerText = "‚òÖ KH√ÅCH M·ªöI"; 
                status.className = "text-[8px] font-black text-amber-500 uppercase mt-1 text-center"; 
            }
        });
    }
}

function autoFillCustomer() {
    var phone = document.getElementById('new_cust_phone').value;
    if (!phone || phone.length < 9) return;
    document.getElementById('search-loading').classList.remove('hidden');
    
    db.ref('members').orderByChild('phone').equalTo(phone).once('value', snapshot => {
        document.getElementById('search-loading').classList.add('hidden');
        if (snapshot.exists()) {
            const member = Object.values(snapshot.val())[0];
            var elName = document.getElementById('new_cust_name');
            elName.value = member.name;
            document.getElementById('new_comp_name').value = member.compName || "";
            document.getElementById('new_comp_phone').value = member.compPhone || "";
            elName.classList.add('bg-green-50', 'text-green-700');
            setTimeout(() => elName.classList.remove('bg-green-50', 'text-green-700'), 1000);
        }
    });
}

// --- L·ªäCH S·ª¨ & DOANH THU (FIREBASE) ---
function openHistory() {
    document.getElementById('loading-overlay').style.display = 'flex';
    switchView('history');
    db.ref('orders').limitToLast(50).once('value', snapshot => {
        document.getElementById('loading-overlay').style.display = 'none';
        const data = snapshot.val();
        historyData = data ? Object.values(data).map(o => ({...o, dateStr: new Date(o.createdAt).toLocaleDateString(), timeStr: new Date(o.createdAt).toLocaleTimeString(), fullTime: new Date(o.createdAt).toLocaleString()})).reverse() : [];
        renderHistoryList(historyData);
    });
}

function renderHistoryList(data) { const grouped = data.reduce((acc, obj) => { const key = obj.dateStr; if (!acc[key]) acc[key] = []; acc [key].push(obj); return acc; }, {}); let html = ""; for (const date in grouped) { html += `<div class="mb-4 text-left"><h3 class="brand-font text-[#006241] text-[10px] uppercase tracking-widest mb-2 ml-1 text-left">üìÖ Ng√†y ${date}</h3><div class="space-y-1.5 text-left">`; grouped[date].forEach(h => { const valColor = h.total < 0? 'text-red-500': 'text-[#006241]'; html += `<div onclick="selectBill('${h.createdAt}')" class="p-3 bg-white rounded-2xl border-2 border-transparent shadow-sm flex justify-between items-center cursor-pointer active:scale-95 text-xs text-left"><div class="min-w-0 text-left"><p class="font-black text-[#1e3932] uppercase text-left">${h.timeStr}</p><p class="text-[8px] text-gray-400 font-bold truncate w-20 text-left">${h.sdt}</p></div><p class="font-black ${valColor} text-right">${h.total.toLocaleString()}</p></div>`; }); html += '</div></div>'; } document.getElementById('history-container').innerHTML = html; }

function openRevenue() { 
    document.getElementById('loading-overlay').style.display = 'flex'; 
    switchView('revenue'); 
    db.ref('orders').once('value', snapshot => {
        document.getElementById('loading-overlay').style.display = 'none';
        // Logic t√≠nh to√°n doanh thu ƒë∆°n gi·∫£n t·∫°i ƒë√¢y n·∫øu c·∫ßn
        document.getElementById('history-container').innerHTML = "<div class='p-5 text-center text-gray-400'>T√≠nh nƒÉng ƒëang c·∫≠p nh·∫≠t v·ªõi Firebase...</div>";
    });
}

function showAppModal(title, msg, icon = '') { document.getElementById('app-modal-title').innerText = title; document.getElementById('app-modal-msg').innerHTML = msg; document.getElementById('app-modal-icon').innerText = icon; document.getElementById('app-modal').classList.remove('hidden'); }
function parseTimeObj(timeStr) { if (!timeStr) return null; var d = new Date(); var parts = timeStr.split(':'); d.setHours(parseInt(parts[0]), parseInt(parts[1]), 0, 0); return d; }
function startPanelCountdown(endTimeStr) { stopPanelCountdown(); var clockEl = document.getElementById('detail-countdown'); if(!clockEl) return; var timeParts = endTimeStr.split(':'); if(timeParts.length < 2) return; var endDate = new Date(); endDate.setHours(parseInt(timeParts[0]), parseInt(timeParts[1]), 0); bedCountdownInterval = setInterval(function() { var diff = endDate - new Date(); var isOver = diff < 0; diff = Math.abs(diff); var h = Math.floor(diff / 3600000); var m = Math.floor((diff % 3600000) / 60000); var s = Math.floor((diff % 60000) / 1000); var fmt = v => v < 10 ? "0"+v : v; clockEl.innerText = (isOver ? '-' : '') + fmt(h) + ":" + fmt(m) + ":" + fmt(s); clockEl.className = isOver ? "text-3xl font-black text-red-500 font-mono tracking-tighter" : "text-3xl font-black text-[#006241] font-mono tracking-tighter"; }, 1000); }
function stopPanelCountdown() { if (bedCountdownInterval) clearInterval(bedCountdownInterval); }
function openBookingModal() { document.getElementById('modal-add-booking').classList.remove('hidden'); switchTimeMode('duration'); }
function closeBookingModal() { document.getElementById('modal-add-booking').classList.add('hidden'); }
function switchTimeMode(mode) { 
    var btnDur = document.getElementById('tab-duration'); var btnFix = document.getElementById('tab-fixed'); var divDur = document.getElementById('mode-duration'); var divFix = document.getElementById('mode-fixed');
    if (mode === 'duration') { btnDur.className = "flex-1 py-1.5 text-xs font-bold rounded-md bg-white shadow-sm text-[#1e3932]"; btnFix.className = "flex-1 py-1.5 text-xs font-bold rounded-md text-gray-400 hover:bg-white/50"; divDur.classList.remove('hidden'); divFix.classList.add('hidden'); document.getElementById('final_duration_minutes').value = 60; } 
    else { btnFix.className = "flex-1 py-1.5 text-xs font-bold rounded-md bg-white shadow-sm text-[#1e3932]"; btnDur.className = "flex-1 py-1.5 text-xs font-bold rounded-md text-gray-400 hover:bg-white/50"; divFix.classList.remove('hidden'); divDur.classList.add('hidden'); }
}
function selectDuration(minutes, btn) { document.getElementById('final_duration_minutes').value = minutes; document.querySelectorAll('.duration-btn').forEach(el => el.className = "duration-btn bg-white border border-gray-200 text-gray-600 font-bold py-2 rounded-lg text-xs hover:bg-gray-100"); btn.className = "duration-btn bg-[#1e3932] text-white border border-[#1e3932] font-bold py-2 rounded-lg text-xs shadow-md"; }
function calculateDurationFromTime() { var timeStr = document.getElementById('custom_end_time').value; if (!timeStr) return; var now = new Date(); var parts = timeStr.split(':'); var end = new Date(); end.setHours(parseInt(parts[0]), parseInt(parts[1]), 0); var diffMins = Math.floor((end - now) / 60000); if (diffMins <= 0) { document.getElementById('calculated-time-hint').innerText = "‚ö†Ô∏è Gi·ªù v·ªÅ ph·∫£i sau gi·ªù hi·ªán t·∫°i"; document.getElementById('final_duration_minutes').value = 0; } else { document.getElementById('calculated-time-hint').innerText = `T·ªïng c·ªông: ${Math.floor(diffMins/60)}h ${diffMins%60}p`; document.getElementById('final_duration_minutes').value = diffMins; } }
</script>
</body>
</html>
