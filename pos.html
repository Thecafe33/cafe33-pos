<!DOCTYPE html>
<html>
<head>
<title>POS The cafe 33</title>
<meta name="apple-mobile-web-app-title" content="POS The cafe 33">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#ffffff">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=League+Spartan:wght@700;800&display=swap" rel="stylesheet">
<style>
/* --- C·∫§U H√åNH CHUNG --- */
html, body {
    width: 100%; height: 100%; overflow: hidden;
    font-size: 13px; /* Chu·∫©n PC */
    -webkit-text-size-adjust: 100%; text-size-adjust: 100%;
    overscroll-behavior-y: none; touch-action: pan-x pan-y;
    margin: 0; padding: 0; -webkit-tap-highlight-color: transparent;
}
body { font-family: 'Inter', sans-serif; background: #f3f4f6; transition: background-color 0.5s ease; }
input, button, select, textarea { font-size: 1rem; }

/* --- UTILITIES & COMPONENTS --- */
.brand-font { font-family: 'League Spartan', sans-serif; }
.sb-green { background-color: #006241; }
.tab-active { background-color: #006241 !important; color: white !important; font-weight: 900; }
.category-tab { padding: 6px 16px; font-size: 0.85rem; font-weight: 800; border-radius: 12px; border: 2px solid #f3f4f6; white-space: nowrap; }
#loading-overlay { display: flex; position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999; align-items: center; justify-content: center; flex-direction: column; gap: 1rem; }
.capitalize-first { text-transform: lowercase; display: inline-block; } .capitalize-first::first-letter { text-transform: uppercase; }
.history-item-active { border-color: #006241 !important; background-color: #f0fdf4 !important; }
.menu-item-name { text-transform: uppercase; font-size: 1rem; font-weight: 900; line-height: 1.1; }
.receipt-line { border-bottom: 1px dashed #f1f3f5; padding: 10px 0; display: flex; justify-content: space-between; align-items: flex-start; }
.refund-selected { background-color: #fee2e2 !important; border-left: 5px solid #ef4444 !important; }
.modal-active { display: flex !important; }

/* Scrollbar */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #D1D1D6; border-radius: 10px; }

/* Bed Box */
.bed-box { aspect-ratio: 1; border-radius: 1.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 900; text-transform: uppercase; cursor: pointer; transition: all 0.3s; position: relative; }
.bed-free { background-color: #f0fdf4; border: 4px solid #f0fdf4; color: #006241; }
.bed-busy { background-color: #1a1a1a; border: 4px solid #006241; color: white; }
.bed-selected { border-color: #ef4444; transform: scale(0.95); 

/* Animation */
.sheet-open { transform: translateY(0) !important; }
@keyframes slideUpFade { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.animate-slide-up { animation: slideUpFade 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

/* ============================================================ */
/* --- MASTER MOBILE CSS (B·∫¢N G·ªòP CHU·∫®N APPLE - FINAL) --- */
/* ============================================================ */
@media only screen and (max-width: 768px) {
/* === TH√äM ƒêO·∫†N N√ÄY ƒê·ªÇ ·∫®N TUY·ªÜT ƒê·ªêI SIDEBAR C≈® === */
    #sidebar-cart {
        display: none !important;
        opacity: 0 !important;
        pointer-events: none !important;
        visibility: hidden !important;
        z-index: -1 !important;
    }
    /* 1. C·∫§U TR√öC CHUNG (X·∫øp d·ªçc, Full m√†n h√¨nh) */
    body {
        font-size: 16px !important;
        flex-direction: column !important;
        padding: 0 !important;
        gap: 0 !important;
    }
    #main-container {
        width: 100% !important;
        flex: 1 !important;
        border-radius: 0 !important;
        border: none !important;
        box-shadow: none !important;
        display: flex;
        flex-direction: column;
    }

    /* 2. HEADER BAR (K√≠nh m·ªù, Trong su·ªët) */
    #header-bar {
        position: sticky !important;
        top: 0 !important;
        background: rgba(255, 255, 255, 0.85) !important;
        backdrop-filter: blur(20px) !important;
        -webkit-backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(0,0,0,0.05) !important;
        z-index: 50 !important;
        padding: 12px 20px !important;
    }
    #header-bar h2 {
        font-size: 1.4rem !important;
        font-weight: 900 !important;
        letter-spacing: -0.5px;
    }
    #header-bar button.md\:hidden {
        background: #F2F4F6 !important;
        border-radius: 12px !important;
        color: #333 !important;
        width: 44px !important;
        height: 44px !important;
    }
    #clock { display: none !important; } /* ·∫®n ƒë·ªìng h·ªì */

    /* --- 1. C·∫§U H√åNH CHUNG --- */
    .custom-scrollbar::-webkit-scrollbar { display: none !important; }
    .custom-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .hidden { display: none !important; }
    html, body { background-color: #f3f4f6 !important; height: 100% !important; }

    /* ================================================= */
    /* --- 2. GIAO DI·ªÜN MOBILE (M√†n h√¨nh nh·ªè < 768px) --- */
    /* ================================================= */
    @media only screen and (max-width: 768px) {
        
        /* Khung bao ngo√†i: S√°t l·ªÅ, ·∫©n thanh cu·ªôn th·ª´a */
        #view-menu:not(.hidden), #view-bed:not(.hidden) {
            padding: 4px !important;       /* C√°ch m√©p 4px */
            padding-top: 10px !important;
            padding-bottom: 0 !important;
            height: 100% !important;
            overflow: hidden !important;
            display: flex !important;
            flex-direction: column !important;
        }

        /* N·ªôi dung b√™n trong: Cu·ªôn d·ªçc, n√© Bottom Bar */
        #view-menu-content, #col-left-list {
            padding: 0 !important;            
            padding-bottom: 120px !important; 
            overflow-y: auto !important;
            height: 100% !important;
        }

        /* L∆∞·ªõi Menu: 3 C·ªôt, Kho·∫£ng c√°ch si√™u nh·ªè */
        #menu-grid {
            display: grid !important;
            grid-template-columns: repeat(3, 1fr) !important; 
            gap: 6px !important; 
            width: 100% !important;
        }

        /* √î M√≥n ƒÉn: Vu√¥ng v·ª©c, bo g√≥c nh·ªè */
        #menu-grid > div {
            aspect-ratio: 1 / 1 !important;   /* √âp h√¨nh vu√¥ng */
            min-height: 0 !important;         
            height: auto !important;
            padding: 4px !important;          
            border-radius: 12px !important;   
        }
        
    }

    /* ================================================= */
    /* --- 3. GIAO DI·ªÜN PC (M√†n h√¨nh l·ªõn > 769px) --- */
    /* ================================================= */
    @media only screen and (min-width: 769px) {
        #menu-grid {
            grid-template-columns: repeat(3, 1fr) !important; /* V·∫´n 3 c·ªôt nh∆∞ng tho√°ng */
            gap: 20px !important;             /* Kho·∫£ng c√°ch r·ªông r√£i */
            padding-bottom: 20px !important;
        }
        #menu-grid > div {
            aspect-ratio: auto !important;    /* Kh√¥ng √©p vu√¥ng */
            height: 140px !important;         /* Chi·ªÅu cao ch·ªØ nh·∫≠t c·ªë ƒë·ªãnh */
            padding: 20px !important;         /* ƒê·ªám trong l·ªõn */
            border-radius: 2rem !important;   /* Bo g√≥c to m·ªÅm m·∫°i */
        }
    }
    /* 3. ƒê·∫£m b·∫£o class hidden c·ªßa Tailwind c√≥ quy·ªÅn l·ª±c t·ªëi cao */
    .hidden {
        display: none !important;
    }

    html, body {
        background-color: #f3f4f6 !important;
        height: 100% !important;
    }
    
    /* 4. THANH CART "DYNAMIC ISLAND" (Vi√™n thu·ªëc n·ªïi) */
    
    /* Tr·∫°ng th√°i ·∫®N: B·∫Øt bu·ªôc ·∫©n tuy·ªát ƒë·ªëi */
    #sidebar-cart.hidden {
        display: none !important;
        opacity: 0 !important;
        pointer-events: none !important;
        visibility: hidden !important;
    }

    /* Tr·∫°ng th√°i HI·ªÜN: N·ªïi kh·ªëi, K√≠nh m·ªù, Bo tr√≤n 999px */
    #sidebar-cart:not(.hidden) {
        display: flex !important;
        flex-direction: row !important;
        position: fixed !important;
        
        /* V·ªã tr√≠ "treo" l∆° l·ª≠ng s√°t ƒë√°y */
        bottom: calc(env(safe-area-inset-bottom) + 15px) !important;
        left: 14px !important;
        right: 14px !important;
        width: auto !important;
        height: auto !important;
        max-height: 72px !important;
        
        /* Hi·ªáu ·ª©ng k√≠nh m·ªù xuy√™n th·∫•u */
        background: rgba(255, 255, 255, 0.85) !important;
        backdrop-filter: blur(25px) !important;
        -webkit-backdrop-filter: blur(25px);
        
        /* H√¨nh d√°ng vi√™n thu·ªëc */
        border-radius: 999px !important;
        overflow: hidden !important; /* C·∫Øt b·ªè blur th·ª´a */
        border: none !important;
        
        /* ƒê·ªï b√≥ng cao c·∫•p */
        box-shadow: 
            0 15px 35px -8px rgba(0,0,0,0.15),
            0 0 0 1px rgba(0,0,0,0.05),
            inset 0 1px 0 rgba(255,255,255,0.6) !important;
        
        padding: 8px 20px !important;
        z-index: 9999 !important;
        align-items: center !important;
        justify-content: space-between !important;
    }

    /* Tinh ch·ªânh n·ªôi dung b√™n trong thanh Cart */
    #sidebar-cart #cart-bottom-bar {
        background: transparent !important;
        padding: 0 !important;
        margin: 0 !important;
        width: 100% !important;
        border: none !important;
        box-shadow: none !important;
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        justify-content: space-between !important;
        gap: 15px !important;
    }
    #sidebar-cart #cart-bottom-bar > div:first-child {
        display: flex !important;
        flex-direction: column !important;
        align-items: flex-start !important;
        cursor: pointer !important;
    }
    #total-price {
        font-size: 1.4rem !important;
        font-weight: 900 !important;
        color: #1e3932 !important;
    }
    #total-price::after {
        content: "Xem chi ti·∫øt ^";
        display: block;
        font-size: 10px !important;
        font-weight: 600 !important;
        color: #6B7280;
        margin-top: 2px;
    }
    
    /* ·∫®n c√°c ph·∫ßn th·ª´a c·ªßa sidebar g·ªëc */
    #sidebar-cart:not(.expanded) #cart-list,
    #sidebar-cart:not(.expanded) #cart-top-section,
    #sidebar-cart:not(.expanded) h2,
    #sidebar-cart:not(.expanded) .md\:hidden,
    #sidebar-cart:not(.expanded) #btn-clear-all,
    #cart-bottom-bar span.text-gray-400,
    #cart-bottom-bar .animate-bounce {
        display: none !important;
    }

    /* N√∫t Thanh To√°n tr√™n thanh Bar */
    #sidebar-pay-btn {
        width: auto !important;
        padding: 10px 24px !important;
        margin: 0 !important;
        border-radius: 99px !important; /* Bo tr√≤n theo thanh bar */
        background: #006241 !important;
        box-shadow: 0 4px 15px rgba(0, 98, 65, 0.3) !important;
        font-size: 0.85rem !important;
        letter-spacing: 0.5px !important;
    }

    /* 5. MENU DANH M·ª§C "DARK GLASS" (K√≠nh ƒëen m·ªù) */
    #sheet-category-content {
        background: rgba(20, 20, 20, 0.90) !important;
        backdrop-filter: blur(30px) !important;
        -webkit-backdrop-filter: blur(30px);
        border: 1px solid rgba(255, 255, 255, 0.15) !important;
        border-radius: 32px !important;
        bottom: 20px !important;
        left: 16px !important;
        right: 16px !important;
        box-shadow: 0 40px 80px -10px rgba(0,0,0,0.6) !important;
        color: white !important;
    }
    #sheet-category-content h3 {
        color: white !important;
        text-align: center !important;
        letter-spacing: 1px !important;
    }
    #sheet-category-content div.w-12 {
        background-color: rgba(255,255,255,0.2) !important;
    }

    /* 6. GIAO DI·ªÜN THANH TO√ÅN (FUTURE 2026) */
    #view-payment { background-color: #F2F2F7 !important; }
    .neo-card {
        background: #FFFFFF;
        border-radius: 32px;
        box-shadow: 0 10px 40px -10px rgba(0,0,0,0.08), 0 0 2px rgba(0,0,0,0.05);
        border: 1px solid rgba(255,255,255,0.6);
    }
    .neo-btn-primary {
        background: linear-gradient(145deg, #00704a, #005538);
        color: white;
        border-radius: 999px;
        box-shadow: 0 8px 20px -6px rgba(0, 98, 65, 0.4), inset 0 2px 0 rgba(255,255,255,0.2);
        border: none;
    }
    .neo-btn-secondary {
        background: #FFFFFF;
        color: #333;
        border-radius: 28px;
        box-shadow: 0 6px 15px -4px rgba(0,0,0,0.05), inset 0 0 0 1px rgba(0,0,0,0.02);
    }
    .neo-input-box {
        background: #F2F4F6;
        border-radius: 24px;
        border: 1px solid transparent;
        transition: all 0.3s;
    }
    .neo-input-box:focus-within {
        background: #FFFFFF;
        box-shadow: 0 4px 20px rgba(0, 98, 65, 0.15);
        border-color: #006241;
    }
    
    /* ·∫®n c√°c popup th·ª´a v√† tinh ch·ªânh Z-Index */
    .app-modal { z-index: 10001 !important; }
    #sheet-cart-edit { z-index: 20000 !important; }
    #sheet-cart-edit button { pointer-events: auto !important; }
    #sheet-cart-list p { font-size: 1rem !important; }
    
    
        /* ·∫®n ho√†n to√†n thanh category tabs desktop tr√™n mobile */
    /* Selector ph·ªï bi·∫øn cho Tailwind desktop tabs */
    .hidden.md\:flex,
    .md\:flex,
    .md\:block,
    .md\:grid,
    .category-tabs-container,  /* n·∫øu c√≥ class n√†y */
    #category-bar,             /* n·∫øu c√≥ id n√†y */
    .flex.gap-2.items-center.justify-start.overflow-x-auto {  /* selector g·∫ßn ƒë√∫ng t·ª´ ·∫£nh */
        display: none !important;
    }

    /* ·∫®n c·ª• th·ªÉ c√°c tab n·∫øu d√πng class category-tab cho desktop */
    .category-tab:not(.mobile-category) {
        display: none !important;
    }
    /* ·∫®n tuy·ªát ƒë·ªëi Sidebar c≈© tr√™n Mobile */
    #sidebar-cart {
        display: none !important;
    }
    
    /* ƒê·∫£m b·∫£o Bottom Bar m·ªõi lu√¥n n·ªïi l√™n tr√™n */
    #mobile-bottom-bar {
        z-index: 9999 !important;
    }
    
    /* T·∫°o kho·∫£ng tr·ªëng d∆∞·ªõi c√πng danh s√°ch m√≥n ƒÉn ƒë·ªÉ kh√¥ng b·ªã Bar che m·∫•t */
    #menu-grid {
        padding-bottom: 100px !important;
    }
}
/* --- C·∫¨P NH·∫¨T M√ÄU N·ªÄN TO√ÄN APP (S√ÅNG H∆†N - FAFAFA) --- */
    body, html {
        background-color: #FAFAFA !important; /* ƒê·ªïi m√†u n·ªÅn body */
    }
    #view-menu, #view-payment, #view-bed, #view-history {
        background-color: #FAFAFA !important; /* ƒê·ªïi m√†u n·ªÅn c√°c view */
    }
    /* ƒê·ªïi m√†u n·ªÅn header mobile cho ƒë·ªìng b·ªô */
    .md\:hidden[style*="background: #F2F2F7"] {
        background: rgba(250, 250, 250, 0.9) !important; 
        border-bottom: 1px solid rgba(0,0,0,0.03) !important;
    }
    /* ƒê·ªïi m√†u n·ªÅn c√°c √¥ input cho t·ªáp m√†u */
    .neo-input-box, input, #cash-paid {
        background-color: #F3F4F6 !important; /* Gi·ªØ input h∆°i t·ªëi t√≠ ƒë·ªÉ ph√¢n bi·ªát */
    }
    /* === FIX GRID MENU - CH·ªÆ TO R√ï H∆†N, ƒê·∫∏P NH∆Ø SHEET CATEGORY === */
#menu-grid > div {
    display: flex;
    flex-direction: column;
    justify-content: end; /* ƒê·∫©y ch·ªØ xu·ªëng d∆∞·ªõi √¥ vu√¥ng */
    padding-bottom: 12px !important; /* Th√™m kho·∫£ng th·ªü d∆∞·ªõi */
}

/* T√™n m√≥n: To, bold c·ª±c m·∫°nh, uppercase, d·ªÖ ƒë·ªçc */
#menu-grid p.menu-name {
    font-size: 13.5px !important;     /* To h∆°n c≈© (11px ‚Üí 13.5px) */
    font-weight: 900 !important;      /* ƒêen ƒë·∫≠m nh∆∞ sheet category */
    line-height: 1.3 !important;      /* Tho√°ng h∆°n, kh√¥ng d√≠nh ch·ªØ */
    letter-spacing: -0.2px !important;
    color: #1e293b !important;        /* ƒêen x√°m ƒë·∫≠m, d·ªÖ ƒë·ªçc tr√™n n·ªÅn tr·∫Øng/x√°m */
    margin-bottom: 4px !important;
    text-align: center !important;
    padding: 0 8px !important;        /* N√© m√©p √¥ t√≠ cho kh√¥ng tr√†n */
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;            /* T·ªëi ƒëa 2 d√≤ng, t·ª± c·∫Øt ... n·∫øu d√†i */
    -webkit-box-orient: vertical;
}

/* Gi√° ti·ªÅn: To h∆°n, bo tr√≤n nh·∫π, n·ªÅn xanh m·ªù nh∆∞ badge */
#menu-grid p.menu-price {
    font-size: 12.5px !important;     /* To h∆°n c≈© (10px ‚Üí 12.5px) */
    font-weight: 800 !important;
    color: white !important;
    background: rgba(0, 98, 65, 0.9) !important; /* Xanh Starbucks m·ªù */
    backdrop-blur-sm !important;
    padding: 6px 10px !important;     /* Badge to h∆°n */
    border-radius: 999px !important;  /* Bo tr√≤n vi√™n thu·ªëc */
    align-self: center !important;    /* CƒÉn gi·ªØa ngang */
    box-shadow: 0 2px 8px rgba(0, 98, 65, 0.2) !important;
    min-width: 70px;
}

/* Mobile ƒë·∫∑c bi·ªát: N·∫øu m√†n h√¨nh si√™u nh·ªè th√¨ thu nh·ªè t√≠ cho v·ª´a √¥ */
@media only screen and (max-width: 480px) {
    #menu-grid p.menu-name { font-size: 13px !important; }
    #menu-grid p.menu-price { font-size: 12px !important; }
}

/* PC: Gi·ªØ tho√°ng r√£i, ch·ªØ to h∆°n n·ªØa */
@media only screen and (min-width: 769px) {
    #menu-grid p.menu-name {
        font-size: 1.8rem !important;   /* To ƒë√πng tr√™n PC */
        line-height: 1.2 !important;
        padding: 0 20px !important;
    }
    #menu-grid p.menu-price {
        font-size: 1.4rem !important;
        padding: 10px 20px !important;
    }
}
    /* ============================================================ */
/* --- SIDEBAR IOS STYLE (MOBILE ONLY) --- */
/* ============================================================ */
@media only screen and (max-width: 768px) {
    /* ·∫®n thanh cu·ªôn cho Sidebar */
    #mobile-sidebar .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    #mobile-sidebar .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    
    /* Font variation cho Material Symbols ƒë·ªÉ icon ƒë·∫≠m h∆°n */
    .material-symbols-outlined {
        font-variation-settings: 'FILL' 1, 'wght' 600, 'GRAD' 0, 'opsz' 24;
    }
}
    /* ============================================================ */
/* --- FRONTEND CAO C·∫§P FIX: Z-INDEX HIERARCHY --- */
/* ============================================================ */
@media only screen and (max-width: 768px) {
    
    /* 1. Sidebar Menu: L·ªõp cao nh·∫•t (Th∆∞·ª£ng t·∫ßng) */
    #mobile-sidebar {
        z-index: 10002 !important;
    }

    /* 2. M√†n ƒëen m·ªù: L·ªõp k·∫ø d∆∞·ªõi Sidebar */
    #mobile-overlay {
        z-index: 10001 !important;
    }
    
    /* 3. Bottom Bar Thanh to√°n: Th·∫•p h∆°n Sidebar */
    /* (Fix l·ªói override z-9999 c≈©) */
    #mobile-bottom-bar {
        z-index: 9000 !important;
    }
}
    /* ============================================================ */
/* --- FRONTEND CAO C·∫§P: PAYMENT IOS STYLE (MOBILE ONLY) --- */
/* ============================================================ */
@media only screen and (max-width: 768px) {
    
    /* 1. N·ªÅn v√† Layout chung */
    #view-payment .md\:hidden {
        background-color: #F2F2F7 !important;
        padding: 0 !important;
    }

    /* 2. Hi·ªáu ·ª©ng Glassmorphism (K√≠nh m·ªù) */
    .glass-card {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.04);
        border-radius: 2.5rem; /* Squircle Large */
    }
    
    .glass-pill {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.8);
        box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        border-radius: 999px;
    }

    /* 3. Override n√∫t G·ª£i √Ω ti·ªÅn (Do JS sinh ra class m·∫∑c ƒë·ªãnh n√™n ph·∫£i override m·∫°nh) */
    #cash-suggestions-mobile {
        display: grid !important;
        grid-template-columns: repeat(3, 1fr) !important; /* √âp th√†nh 3 c·ªôt */
        gap: 12px !important;
    }
    
    #cash-suggestions-mobile button {
        width: 100% !important;
        border-radius: 999px !important; /* Bo tr√≤n vi√™n thu·ªëc */
        background: rgba(255, 255, 255, 0.6) !important;
        border: 1px solid rgba(255, 255, 255, 0.5) !important;
        box-shadow: 0 2px 5px rgba(0,0,0,0.02) !important;
        color: #1a4d2e !important;
        font-weight: 800 !important;
        padding: 12px 0 !important;
        font-size: 1rem !important;
    }
    
    #cash-suggestions-mobile button:active {
        background: #1a4d2e !important;
        color: white !important;
        transform: scale(0.95);
    }
}
    @media only screen and (max-width: 768px) {
    /* Khi v√†o Step 2, ·∫©n thanh cu·ªôn c·ªßa container cha */
    #view-payment:has(#mob-step-2:not(.hidden)) .overflow-y-auto {
        overflow: hidden !important;
    }
    /* ============================================================ */
/* --- MODULE: CAFE IN BED MOBILE (IOS DESIGN) --- */
/* ============================================================ */
    /* ·∫®n giao di·ªán Bed c≈© c·ªßa PC tr√™n Mobile */
    #view-bed {
        display: none !important;
    }

    /* Container ch√≠nh cho Bed Mobile */
    #view-bed-mobile {
        display: flex;
        flex-direction: column;
        height: 100%;
        background-color: #F2F2F7;
        position: relative;
        overflow: hidden;
    }

    /* C√°c Utility Classes t·ª´ thi·∫øt k·∫ø m·∫´u */
    .ios-blur {
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
    }
    .squircle {
        border-radius: 24px;
    }
    .header-gradient {
        background: linear-gradient(135deg, #065F46 0%, #064E3B 100%);
    }
    .text-primary {
        color: #064E3B;
    }
    .bg-primary {
        background-color: #064E3B;
    }
    
    /* Animation chuy·ªÉn trang */
    .page-enter {
        transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .page-enter-active {
        transform: translateX(0);
    }
    .page-exit {
        transform: translateX(0);
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .page-exit-active {
        transform: translateX(100%);
    }
}
    /* ============================================================ */
/* --- MODULE: REVENUE MOBILE (ANALYTICS DASHBOARD) --- */
/* ============================================================ */
@media only screen and (max-width: 768px) {
    /* ·∫®n thanh cu·ªôn ngang cho c√°c th·∫ª Card */
    .hide-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .hide-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    
    /* Style cho Dropdown Menu (gi·ªëng style Category) */
    .revenue-dropdown-item {
        width: 100%;
        text-align: left;
        padding: 12px 16px;
        font-weight: 700;
        font-size: 13px;
        color: #1e293b;
        border-bottom: 1px dashed #f1f5f9;
        transition: all 0.2s;
    }
    .revenue-dropdown-item:last-child {
        border-bottom: none;
    }
    .revenue-dropdown-item:active {
        background-color: #f8fafc;
        color: #065F46;
    }
}
    @media only screen and (max-width: 768px) {
    /* ƒê·∫£m b·∫£o View History Mobile kh√¥ng ƒë√® m·∫•t Header */
    #view-history-mobile {
        top: 72px !important; /* Chi·ªÅu cao ∆∞·ªõc t√≠nh c·ªßa Header Mobile */
        height: calc(100% - 72px) !important;
        z-index: 40 !important; /* Th·∫•p h∆°n Header (z-50) */
    }

    /* ƒê·∫£m b·∫£o Header Mobile lu√¥n n·ªïi l√™n tr√™n c√πng */
    #main-container > .md\:hidden.sticky {
        z-index: 51 !important;
    }
}
    /* --- CSS CHO GIAO DI·ªÜN CHI TI·∫æT BED (MOBILE NEW) --- */
.glass {
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.5);
}
.glass-widget {
    background: rgba(255, 255, 255, 0.4);
    backdrop-filter: blur(25px);
    -webkit-backdrop-filter: blur(25px);
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.04);
}
.high-gloss-button {
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(4px);
    border: 0.5px solid rgba(255, 255, 255, 0.9);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03), inset 0 1px 1px rgba(255, 255, 255, 1);
}
.high-gloss-button:active {
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.8), 0 4px 12px rgba(0, 0, 0, 0.05);
    transform: scale(0.96);
}
.squircle { border-radius: 40px; }
.timer-font { font-variant-numeric: tabular-nums; letter-spacing: -0.05em; }
.text-primary { color: #006241; }
.bg-primary { background-color: #006241; }


    
    /* --- CSS CHO GIAO DI·ªÜN PC NEW (SPATIAL DESIGN) --- */
.spatial-glass {
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(40px) saturate(180%);
    -webkit-backdrop-filter: blur(40px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.8);
    box-shadow: 0 20px 40px -10px rgba(0, 68, 50, 0.08);
}
.glass-card-inner {
    background: rgba(255, 255, 255, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.6);
    box-shadow: 0 4px 12px rgba(0,0,0,0.02);
}
.text-emerald-deep { color: #065F46; }
.bg-emerald-deep { background-color: #065F46; }
/* T·∫°o thanh cu·ªôn ·∫©n cho ƒë·∫πp */
.hide-scroll::-webkit-scrollbar { display: none; }
.hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    /* --- BUTTON STYLE CHO THANH TO√ÅN BED --- */
.btn-pay-bed {
    background-color: #000000 !important; 
    color: #FFD700 !important; /* V√†ng kim */
    border: 1px solid #FFD700 !important;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3) !important;
}
               /* --- [EMERGENCY FIX] ·∫®N TUY·ªÜT ƒê·ªêI SIDEBAR PC TR√äN MOBILE --- */
@media only screen and (max-width: 768px) {
    #sidebar-cart {
        display: none !important;
        visibility: hidden !important;
        pointer-events: none !important;
        z-index: -9999 !important;
    }
}
</style>
</head>
<body class="flex p-3 gap-3 text-left">
   <div id="mobile-sidebar" class="fixed inset-y-0 left-0 w-[85%] max-w-[340px] bg-[#F2F2F7] shadow-[20px_0_60px_rgba(0,0,0,0.15)] transform -translate-x-full transition-transform duration-300 z-[9999] flex flex-col font-['Inter'] overflow-hidden border-r border-gray-200/50">
    
    <div class="pt-14 pb-8 px-8 flex flex-col items-start gap-4 shrink-0">
        <button onclick="toggleMobileMenu()" class="absolute top-6 right-6 p-2 rounded-full bg-gray-200/50 text-gray-500 hover:bg-gray-300 transition-colors">
            <span class="material-symbols-outlined text-xl font-bold">close</span>
        </button>

        <div class="w-16 h-16 rounded-full border-2 border-[#0fbd49]/30 p-1 bg-white shadow-sm">
            <div class="w-full h-full rounded-full bg-cover bg-center bg-gray-100 flex items-center justify-center overflow-hidden">
                <span class="text-2xl">üë®‚Äçüíª</span> 
            </div>
        </div>
        <div>
            <p class="text-gray-400 text-[10px] font-extrabold tracking-[0.15em] uppercase mb-1">H·ªá th·ªëng POS</p>
            <h1 class="text-[#102216] text-3xl font-black tracking-tight leading-none">Xin ch√†o,<br>Admin</h1>
        </div>
    </div>

    <div class="flex-1 overflow-y-auto px-6 pb-6 space-y-4 no-scrollbar">
        
        <div onclick="openRevenueMobile(); toggleMobileMenu()" class="bg-white p-5 rounded-[2rem] flex items-center justify-between shadow-[0_10px_30px_-5px_rgba(0,0,0,0.05)] active:scale-95 transition-all cursor-pointer border border-white">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-[#ecfdf3] flex items-center justify-center rounded-[1.25rem]">
                    <span class="material-symbols-outlined text-[#0fbd49] text-3xl" style="font-variation-settings: 'FILL' 1;">analytics</span>
                </div>
                <div>
                    <p class="text-gray-900 text-lg font-extrabold leading-none">Doanh thu</p>
                    <p class="text-gray-400 text-[11px] mt-1.5 font-bold">B√°o c√°o t·ªïng quan</p>
                </div>
            </div>
            <span class="material-symbols-outlined text-gray-300">chevron_right</span>
        </div>

        <div onclick="openHistory(); toggleMobileMenu()" class="bg-white p-5 rounded-[2rem] flex items-center justify-between shadow-[0_10px_30px_-5px_rgba(0,0,0,0.05)] active:scale-95 transition-all cursor-pointer border border-white">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-[#ecfdf3] flex items-center justify-center rounded-[1.25rem]">
                    <span class="material-symbols-outlined text-[#0fbd49] text-3xl" style="font-variation-settings: 'FILL' 1;">history</span>
                </div>
                <div>
                    <p class="text-gray-900 text-lg font-extrabold leading-none">L·ªãch s·ª≠</p>
                    <p class="text-gray-400 text-[11px] mt-1.5 font-bold">Giao d·ªãch g·∫ßn ƒë√¢y</p>
                </div>
            </div>
            <span class="material-symbols-outlined text-gray-300">chevron_right</span>
        </div>

        <div onclick="openBedManager(); toggleMobileMenu()" class="bg-white p-5 rounded-[2rem] flex items-center justify-between shadow-[0_10px_30px_-5px_rgba(0,0,0,0.05)] active:scale-95 transition-all cursor-pointer border border-white">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-[#ecfdf3] flex items-center justify-center rounded-[1.25rem]">
                    <span class="material-symbols-outlined text-[#0fbd49] text-3xl" style="font-variation-settings: 'FILL' 1;">grid_view</span>
                </div>
                <div>
                    <p class="text-gray-900 text-lg font-extrabold leading-none">Qu·∫£n l√Ω Bed</p>
                    <p class="text-gray-400 text-[11px] mt-1.5 font-bold">S∆° ƒë·ªì ph√≤ng b√†n</p>
                </div>
            </div>
            <span class="material-symbols-outlined text-gray-300">chevron_right</span>
        </div>

        <div class="bg-white p-5 rounded-[2rem] flex items-center justify-between shadow-[0_10px_30px_-5px_rgba(0,0,0,0.05)] active:scale-95 transition-all cursor-pointer border border-white opacity-60 grayscale">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-[#ecfdf3] flex items-center justify-center rounded-[1.25rem]">
                    <span class="material-symbols-outlined text-[#0fbd49] text-3xl" style="font-variation-settings: 'FILL' 1;">inventory_2</span>
                </div>
                <div>
                    <p class="text-gray-900 text-lg font-extrabold leading-none">Kho h√†ng</p>
                    <p class="text-gray-400 text-[11px] mt-1.5 font-bold">S·∫Øp ra m·∫Øt</p>
                </div>
            </div>
            </div>

    </div>

    <div class="p-6 pb-10 flex flex-col gap-2 shrink-0 bg-[#F2F2F7]">
        <div class="flex items-center gap-4 bg-gray-200/50 px-5 py-4 rounded-[1.5rem] active:bg-gray-200 transition-colors cursor-pointer group">
            <span class="material-symbols-outlined text-gray-500">settings</span>
            <p class="text-gray-600 text-base font-bold flex-1">C√†i ƒë·∫∑t</p>
        </div>
        <div class="flex items-center gap-4 px-5 py-4 rounded-[1.5rem] active:bg-red-50 transition-colors cursor-pointer group text-gray-400 hover:text-red-500">
            <span class="material-symbols-outlined transition-colors">logout</span>
            <p class="text-base font-bold flex-1 transition-colors">ƒêƒÉng xu·∫•t</p>
        </div>
    </div>
</div>
<div id="mobile-overlay" onclick="toggleMobileMenu()" class="fixed inset-0 bg-black/60 z-[9990] hidden backdrop-blur-[2px] transition-opacity"></div>

<div id="loading-overlay">
    <div class="w-16 h-16 border-4 border-[#006241] border-t-transparent rounded-full animate-spin"></div>
    <p class="brand-font text-[#006241] text-2xl font-black tracking-widest animate-pulse">The cafe 33</p>
    <p class="text-xs text-gray-400 font-bold" id="loading-text">ƒêang k·∫øt n·ªëi d·ªØ li·ªáu...</p>
</div>

<div class="flex-1 bg-white rounded-[2.5rem] shadow-xl overflow-hidden flex flex-col relative border-2 border-white transition-colors duration-500" id="main-container">
  <div class="md:hidden px-5 py-4 flex items-center justify-between sticky top-0 z-50 transition-all duration-300" 
     style="background: #F2F2F7; border-bottom: 1px solid rgba(0,0,0,0.05);"> <button onclick="toggleMobileMenu()" class="w-12 h-12 rounded-full bg-white shadow-sm border border-white flex items-center justify-center text-[#006241] active:scale-90 transition-transform">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="6" x2="20" y2="6"></line><line x1="4" y1="12" x2="20" y2="12"></line><line x1="4" y1="18" x2="12" y2="18"></line></svg>
    </button>

    <h2 class="brand-font text-3xl font-black text-[#006241] tracking-tighter cursor-pointer" onclick="switchView('menu')">The cafe 33</h2>

    <button onclick="openBedManager()" class="h-12 pl-4 pr-5 bg-[#006241] rounded-full shadow-[0_8px_20px_-5px_rgba(0,98,65,0.4)] flex items-center gap-2 active:scale-95 transition-all border border-white/10">
        <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9.5V20M3 20H21M3 20V21M21 20V9.5M21 20V21M3 9.5C3 8.39543 3.89543 7.5 5 7.5H9C10.1046 7.5 11 8.39543 11 9.5V11H3V9.5ZM21 9.5C21 8.39543 20.1046 7.5 19 7.5H15C13.8954 7.5 13 8.39543 13 9.5V11H21V9.5Z"/>
            <path d="M3 11H21V16H3V11Z"/>
        </svg>
        <span class="text-white font-black text-xs uppercase tracking-wider">BED</span>
    </button>
</div>

<div class="hidden md:flex px-8 py-6 border-b border-gray-50 bg-white z-10 shrink-0 items-center gap-8 shadow-[0_4px_20px_rgba(0,0,0,0.02)]" id="header-bar-pc">
    
    <h2 class="brand-font text-4xl text-[#006241] whitespace-nowrap cursor-pointer hover:opacity-80 transition-all tracking-tighter" onclick="switchView('menu')">The cafe 33</h2>
    
    <div class="flex items-center gap-3">
        <button id="btn-nav-revenue" onclick="openRevenue()" class="bg-gray-100 text-gray-400 px-6 py-3 rounded-2xl text-[11px] font-black uppercase hover:bg-gray-200 active:scale-95 transition-all tracking-widest">
            Doanh thu
        </button>
        <button id="btn-nav-history" onclick="openHistory()" class="bg-gray-100 text-gray-400 px-6 py-3 rounded-2xl text-[11px] font-black uppercase hover:bg-gray-200 active:scale-95 transition-all tracking-widest">
            L·ªãch s·ª≠
        </button>
        <button id="btn-nav-bed" onclick="openBedManager()" class="bg-gray-100 text-gray-400 px-6 py-3 rounded-2xl text-[11px] font-black uppercase hover:bg-gray-200 active:scale-95 transition-all tracking-widest">
            Qu·∫£n l√Ω Bed
        </button>
    </div>

</div>
   <div id="view-menu" class="flex-1 flex flex-col overflow-hidden relative bg-[#F2F2F7]">

    <div id="category-bar" class="hidden md:flex px-6 py-2 border-b border-gray-50 bg-gray-50/30 gap-2 overflow-x-auto shrink-0">
        <div id="tabs-container" class="flex gap-2"></div>
    </div>

    <div class="md:hidden absolute top-4 right-4 z-50 flex flex-col items-end">
        
        <button onclick="toggleCategoryDropdown()" class="relative z-50 flex items-center gap-3 bg-[#006241] text-white pl-5 pr-4 py-3 rounded-full shadow-md active:scale-95 transition-all border border-white/20">
            <span class="text-[10px] font-black uppercase tracking-widest opacity-90">MENU</span>
            <div class="h-4 w-[1px] bg-white/30"></div>
            <span id="mob-cat-label-new" class="text-sm font-black text-white uppercase pl-1">T·∫•t c·∫£</span>
            <span class="text-xs text-white/80">‚ñº</span>
        </button>

        <div id="mob-cat-overlay" onclick="toggleCategoryDropdown()" class="hidden fixed inset-0 z-40 bg-black/20 backdrop-blur-[1px]"></div>

        <div id="mob-cat-dropdown" class="hidden absolute top-full right-0 mt-3 w-64 bg-white rounded-[2rem] shadow-xl p-3 z-50 origin-top-right transition-all duration-200 opacity-0 scale-95 border border-gray-100">
            <div id="mob-cat-list" class="max-h-[60vh] overflow-y-auto custom-scrollbar space-y-2">
                </div>
        </div>
    </div>

    <div id="view-menu-content" class="flex-1 px-3 pb-32 overflow-y-auto custom-scrollbar">
        <div class="h-16 md:hidden w-full"></div>
        <div id="menu-grid" class="grid grid-cols-2 md:grid-cols-3 gap-3 pb-20"></div>
    </div>

    <div id="sheet-category" class="md:hidden fixed inset-0 z-[100] hidden">
        <div onclick="closeCategorySheet()" class="absolute inset-0 bg-black/40 backdrop-blur-[2px] transition-opacity opacity-0 animate-fade-in"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[32px] p-6 pb-10 shadow-[0_-10px_40px_rgba(0,0,0,0.2)] transform translate-y-full transition-transform duration-300 ease-out flex flex-col max-h-[70vh]" id="sheet-category-content">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6 shrink-0"></div>
            <h3 class="text-lg font-black text-gray-800 uppercase mb-4 shrink-0">Ch·ªçn Danh M·ª•c</h3>
            <div id="sheet-category-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-2"></div>
        </div>
    </div>

    <div id="sheet-cart-edit" class="md:hidden fixed inset-0 z-[100] hidden">
        <div onclick="closeCartModal()" class="absolute inset-0 bg-black/40 backdrop-blur-[2px]"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[32px] flex flex-col max-h-[80vh] shadow-2xl animate-slide-up">
            
            <div class="p-5 border-b border-gray-50 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <h3 class="text-lg font-black text-[#006241] uppercase">Gi·ªè h√†ng</h3>
                    <button onclick="clearAllMobile()" class="text-[10px] font-bold text-red-500 bg-red-50 px-3 py-1.5 rounded-full uppercase active:scale-95 transition-all">
                        X√≥a h·∫øt
                    </button>
                </div>
                <button onclick="closeCartModal()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 font-bold">‚úï</button>
            </div>

            <div id="sheet-cart-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-[#F9FAFB]"></div>
            
            <div class="p-4 border-t border-gray-100 bg-white pb-8">
                <button onclick="closeCartModal()" class="w-full py-3.5 bg-[#006241] text-white rounded-xl font-bold uppercase">ƒê√≥ng & Ti·∫øp t·ª•c</button>
            </div>
        </div>
    </div>

</div>
       <div id="view-payment" class="hidden h-full flex-col animate-fade-in relative bg-[#f2f2f7]"> <div class="hidden md:flex flex-col h-full p-8 bg-white">
         <div class="flex justify-between items-center mb-6"><h2 class="brand-font text-4xl text-[#006241] uppercase font-black text-center w-full">Thanh to√°n</h2><button onclick="switchView('menu')" class="text-gray-400 font-bold uppercase text-xs border-b-2 absolute right-10">Quay l·∫°i</button></div>
         <div class="grid grid-cols-2 gap-6 flex-1"><div class="space-y-4"><button id="btn-cash" onclick="setMethod('Ti·ªÅn m·∫∑t')" class="w-full p-6 rounded-3xl border-4 border-[#006241] bg-white text-xl font-bold text-[#006241] flex justify-between items-center shadow-md">Ti·ªÅn m·∫∑t ‚úì</button><button id="btn-bank" onclick="setMethod('Chuy·ªÉn kho·∫£n')" class="w-full p-6 rounded-3xl border-4 border-transparent bg-white text-xl font-bold text-gray-300 flex justify-between items-center shadow-md uppercase tracking-tighter">Chuy·ªÉn kho·∫£n</button></div><div id="cash-detail-box" class="bg-white p-6 rounded-[2.5rem] shadow-md flex flex-col justify-center text-center"><label class="block font-bold text-gray-300 uppercase text-[9px] mb-3 tracking-widest text-center">Kh√°ch ƒë∆∞a</label><div id="cash-suggestions" class="flex flex-wrap justify-center gap-2 mb-4"></div>
             <input type="tel" id="cash-paid" 
       onfocus="this.value=''" 
       onblur="if(this.value=='') this.value=currentTotal.toLocaleString('en-US'); calcChange();" 
       oninput="formatCashInput(this); calcChange()" 
       class="w-full p-5 bg-gray-50 rounded-2xl text-4xl font-black text-[#006241] outline-none text-center" 
       placeholder="0"><div class="mt-6 pt-5 border-t border-dashed text-center"><p class="font-bold text-gray-300 uppercase text-[9px] mb-1">Ti·ªÅn th·ª´a</p><p id="cash-change" class="text-5xl font-black text-amber-500">0ƒë</p></div></div></div><button onclick="completeOrder()" id="btn-done" class="w-full py-8 mt-4 sb-green text-white font-black text-2xl rounded-3xl uppercase shadow-2xl active:scale-95 transition-all tracking-[0.2em]">Ho√†n t·∫•t</button>
         <button onclick="openSplitModal()" class="w-full py-8 mt-6 bg-gray-100/80 text-gray-800 font-black text-2xl rounded-3xl uppercase shadow-xl active:scale-95 transition-all border border-gray-200/50">
    T√≠nh ri√™ng
</button>  
    
    </div>

  <div class="flex md:hidden flex-col h-full bg-[#F2F2F7] relative overflow-hidden font-sans">
        
        <div class="px-5 pt-8 pb-4 flex items-center justify-between sticky top-0 z-20" style="background: rgba(242,242,247,0.95); backdrop-filter: blur(20px);">
            <button onclick="backMobileStep()" class="w-12 h-12 rounded-full bg-white flex items-center justify-center text-slate-800 shadow-[0_4px_20px_rgba(0,0,0,0.05)] active:scale-90 transition-transform">
               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" /></svg>
            </button>
            <h2 id="mob-pay-title" class="text-3xl font-black tracking-tighter uppercase text-slate-900">Thanh to√°n</h2>
            <div class="w-12"></div>
        </div>

        <div class="flex-1 overflow-y-auto px-5 pt-2 pb-32 space-y-6">

            <div id="mob-step-1" class="flex flex-col gap-6 animate-slide-up">
                
                <div class="bg-white rounded-[32px] p-10 flex flex-col items-center justify-center text-center shadow-[0_4px_20px_rgba(0,0,0,0.05)]">
                    <span class="text-gray-400 font-bold text-xs uppercase tracking-widest mb-2">T·ªïng ho√° ƒë∆°n</span>
                    <span id="pay-total-display-1" class="font-black text-7xl text-slate-900 tracking-tighter leading-none">0</span>
                </div>

                <div class="bg-white rounded-[28px] p-6 flex items-center gap-5 shadow-[0_4px_20px_rgba(0,0,0,0.05)]">
                    <div class="w-14 h-14 rounded-full bg-blue-50 flex items-center justify-center shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.437.695A18.683 18.683 0 0112 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 01-.437-.695z" clip-rule="evenodd" /></svg>
                    </div>
                    
                    <div class="flex-1 min-w-0 flex flex-col justify-center">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Kh√°ch h√†ng / T√≠ch ƒëi·ªÉm</label>
                        <input type="tel" id="pay-sdt-mobile" oninput="syncMobileInputs()" placeholder="Nh·∫≠p SƒêT..." 
                               class="w-full bg-transparent border-none text-slate-900 text-3xl font-black p-0 outline-none placeholder:text-gray-300 placeholder:font-bold h-auto leading-none focus:ring-0">
                    </div>
                </div>
                <div id="pay-cust-name-mobile" class="h-0 overflow-hidden transition-all duration-300"></div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="goToMobileCash()" class="bg-white rounded-[32px] shadow-[0_4px_20px_rgba(0,0,0,0.05)] p-8 flex flex-col items-center justify-center gap-4 transition-transform active:scale-95 border border-transparent">
                        <div class="w-20 h-14 bg-green-100 rounded-2xl flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" height="40px" viewBox="0 -960 960 960" width="40px" fill="#16a34a"><path d="M560-440q-50 0-85-35t-35-85q0-50 35-85t85-35q50 0 85 35t35 85q0 50-35 85t-85 35ZM280-320q-33 0-56.5-23.5T200-400v-320q0-33 23.5-56.5T280-800h560q33 0 56.5 23.5T920-720v320q0 33-23.5 56.5T840-320H280Zm0-80h560v-320H280v320Zm0-400v320-320ZM160-160q-33 0-56.5-23.5T80-240v-480h80v480h600v80H160Z"/></svg>
                        </div>
                        <span class="font-black text-slate-800 text-xl">Ti·ªÅn m·∫∑t</span>
                    </button>
                    <button onclick="setMethod('Chuy·ªÉn kho·∫£n')" class="bg-white rounded-[32px] shadow-[0_4px_20px_rgba(0,0,0,0.05)] p-8 flex flex-col items-center justify-center gap-4 transition-transform active:scale-95 border border-transparent">
                        <div class="w-20 h-14 bg-blue-50 rounded-2xl flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" height="36px" viewBox="0 -960 960 960" width="36px" fill="#2563eb"><path d="M200-280v-280h80v280h-80Zm240 0v-280h80v280h-80ZM80-120v-80h800v80H80Zm600-160v-280h80v280h-80ZM80-640v-80l400-200 400 200v80H80Zm178-80h444-444Z"/></svg>
                        </div>
                        <span class="font-black text-slate-800 text-xl">Chuy·ªÉn kho·∫£n</span>
                    </button>
                </div>
                
                <button onclick="openSplitModal()" class="w-full bg-white rounded-[32px] shadow-[0_4px_20px_rgba(0,0,0,0.05)] py-8 text-center transition-transform active:scale-95">
                    <span class="font-black text-slate-800 uppercase tracking-widest text-lg">Thu ti·ªÅn ri√™ng</span>
                </button>
            </div>

       <div id="mob-step-2" class="hidden h-full flex flex-col animate-slide-up relative">
    
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
        <div class="absolute -top-10 -left-10 w-64 h-64 bg-white rounded-full blur-3xl opacity-60"></div>
        <div class="absolute bottom-20 -right-10 w-64 h-64 bg-[#1a4d2e]/5 rounded-full blur-3xl"></div>
    </div>

    <div class="flex-1 flex flex-col gap-4 relative z-10 pb-4">
        
        <div class="glass-card w-full py-10 px-6 flex flex-col items-center justify-center gap-2 shadow-sm rounded-[2.5rem] shrink-0 border border-white/60">
            <p class="text-gray-400 text-[10px] font-bold uppercase tracking-[0.2em]">T·ªïng thanh to√°n</p>
            <h1 id="pay-total-display-2" class="text-[#1a4d2e] text-7xl font-black tracking-tighter leading-none mt-1">0</h1>
        </div>

        <div class="glass-card w-full flex-1 p-6 shadow-sm rounded-[2.5rem] flex flex-col gap-6 border border-white/60">
            
            <div class="flex flex-col items-center justify-center flex-1">
                <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest mb-3">Ti·ªÅn kh√°ch ƒë∆∞a</p>
                <div class="relative w-full bg-[#F2F4F6] rounded-2xl p-4 border border-gray-200/50 shadow-inner">
                    <input type="tel" id="cash-paid-mobile" oninput="syncMobileInputs()" placeholder="0" 
                           class="w-full bg-transparent border-none text-center text-5xl font-black text-gray-900 p-0 outline-none placeholder:text-gray-300 focus:ring-0 h-auto leading-none">
                </div>
            </div>

            <div class="shrink-0 pt-2 border-t border-gray-100/50">
                <div id="cash-suggestions-mobile"></div>
            </div>
        </div>
    </div>

    <div class="mt-auto pt-2 flex flex-col gap-4 relative z-10 shrink-0">
        <div class="flex justify-between items-end px-4">
            <span class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Ti·ªÅn th·ª´a</span>
            <span id="cash-change-mobile" class="text-amber-500 text-5xl font-black tracking-tight drop-shadow-sm leading-none">0ƒë</span>
        </div>
        
        <button onclick="completeOrder()" class="w-full bg-[#1a4d2e] text-white py-5 rounded-[2rem] font-black text-xl shadow-xl shadow-[#1a4d2e]/20 flex items-center justify-center gap-3 active:scale-[0.98] transition-all border border-[#1a4d2e]/10">
            <span>X√ÅC NH·∫¨N</span>
            <span class="material-symbols-outlined text-white font-bold text-2xl">check_circle</span>
        </button>
    </div>
</div>
        </div>
    </div>
</div>

        <div id="view-history" class="hidden h-full flex overflow-hidden bg-white" onclick="switchView('menu')">
    <div id="history-left-col" class="w-[320px] border-r border-gray-100 overflow-y-auto p-4 space-y-4 bg-gray-50/50" onclick="event.stopPropagation()">
        <div id="history-container" class="space-y-3"></div>
    </div>
    
    <div class="flex-1 p-6 flex flex-col items-center bg-white relative overflow-hidden" onclick="event.stopPropagation()">
        <div id="history-detail-empty" class="h-full flex flex-col items-center justify-center opacity-10 text-center">
            <h1 class="brand-font text-8xl text-[#006241]">The cafe 33</h1>
        </div>
        <div id="history-detail-content" class="hidden w-full h-full flex flex-col animate-fade-in text-left"></div>
    </div>
</div>

        <div id="view-bed" class="hidden h-full flex gap-3 bg-[#F2F2F7] p-3 rounded-[24px]">
            <div class="w-[30%] flex flex-col bg-white rounded-[20px] shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-4 py-3 border-b border-gray-50 bg-white sticky top-0 z-10 flex justify-between items-center">
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Danh s√°ch</span>
                    <input type="date" id="date-picker-btn" onchange="changeBedDate(this.value)" 
       class="text-[10px] font-bold text-[#006241] bg-green-50 px-2 py-1 rounded-md border-none outline-none cursor-pointer hover:bg-green-100 transition-colors">
                </div>
                <div id="col-left-list" class="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar"></div>
            </div>
            <div class="w-[50%] flex flex-col bg-white rounded-[20px] shadow-sm border border-gray-100 overflow-hidden relative">
                <div id="detail-empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-gray-300">
                    <p class="font-medium text-xs">Ch·ªçn l·ªãch ƒë·ªÉ xem</p>
                </div>
                <div id="detail-content-panel" class="hidden flex-col h-full bg-[#F2F2F7] relative overflow-hidden">
    
    <div class="relative z-10 bg-white/80 backdrop-blur-xl border-b border-gray-200 pt-6 pb-6 px-6 shadow-sm sticky top-0">
        <div class="flex justify-between items-start">
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">ƒêang ch·ªçn</p>
                </div>
                <h1 class="text-4xl font-black text-[#1e3932] tracking-tight" id="detail-bed-name">BED 01</h1>
            </div>
            
            <div id="detail-status-badge" class="px-4 py-1.5 bg-amber-100 text-amber-700 rounded-full text-[11px] font-black uppercase tracking-wide border border-amber-200/50 shadow-sm">
                WAITING
            </div>
        </div>
    </div>

    <div class="flex-1 overflow-y-auto custom-scrollbar p-5 space-y-5">

        <div id="detail-timer-box" class="hidden text-center py-6 bg-white rounded-[24px] shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-gray-100 relative overflow-hidden group">
            <div class="absolute inset-0 bg-green-50/50 opacity-0 group-hover:opacity-100 transition-opacity"></div>
            <span class="relative z-10 text-[10px] text-gray-400 uppercase font-bold tracking-widest bg-white px-3 py-1 rounded-full border border-gray-100">Th·ªùi gian c√≤n l·∫°i</span>
            <div id="detail-countdown" class="relative z-10 text-5xl font-black text-[#006241] font-mono tracking-tighter mt-3 drop-shadow-sm">00:00</div>
        </div>

        <div class="bg-white rounded-[24px] shadow-sm border border-gray-200/60 overflow-hidden">
            <div class="p-4 flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-xl shadow-inner shrink-0">
                    üë§
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-0.5">Ng∆∞·ªùi ƒë·∫∑t</p>
                    <p class="font-bold text-gray-900 text-lg truncate leading-tight" id="detail-cust-name">--</p>
                    <p class="font-mono text-xs text-gray-500 font-medium mt-0.5" id="detail-cust-phone">--</p>
                </div>
            </div>
            
            <div class="h-[1px] bg-gray-100 mx-4"></div>

            <div class="p-4 flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center text-xl shadow-inner shrink-0">
                    üë•
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-0.5">Ng∆∞·ªùi ƒëi c√πng</p>
                    <p class="font-bold text-gray-900 text-lg truncate leading-tight" id="detail-comp-name">--</p>
                    <p class="font-mono text-xs text-gray-500 font-medium mt-0.5" id="detail-comp-phone">--</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-[24px] shadow-sm border border-gray-200/60 p-5 flex justify-between items-center relative overflow-hidden">
            <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-[#006241]"></div>
            
            <div class="pl-2">
                <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">B·∫Øt ƒë·∫ßu</p>
                <p class="text-2xl font-black text-[#1e3932]" id="detail-start">--:--</p>
            </div>
            
            <div class="text-gray-200 text-2xl font-light">‚ûù</div>

            <div class="text-right">
                <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">K·∫øt th√∫c</p>
                <p class="text-2xl font-black text-[#1e3932]" id="detail-end">--:--</p>
            </div>
        </div>
        
        <div id="row-checkout-time" class="hidden bg-gray-100 rounded-[20px] p-4 border border-gray-200 flex justify-between items-center">
            <span class="text-xs font-bold text-gray-500 uppercase">Th·ª±c t·∫ø tr·∫£:</span>
            <span class="font-black text-red-600 text-lg" id="detail-real-end">--:--</span>
        </div>

    </div>

    <div id="detail-action-buttons" class="p-5 pb-8 bg-white/90 backdrop-blur-md border-t border-gray-200 mt-auto z-20">
        <div class="grid grid-cols-2 gap-3">
            <button id="btn-action-order" class="py-4 rounded-[18px] bg-amber-50 text-amber-700 font-bold border border-amber-100 shadow-sm active:scale-95 transition-all flex justify-center items-center gap-2 group">
                <span class="text-lg group-hover:scale-110 transition-transform">‚òï</span>
                <span class="uppercase text-xs tracking-wider">G·ªçi M√≥n</span>
            </button>
            
            <button id="btn-action-checkout" class="py-4 rounded-[18px] bg-[#006241] text-white font-bold shadow-lg shadow-green-900/20 active:scale-95 transition-all flex justify-center items-center gap-2">
                <span class="text-lg">üõèÔ∏è</span>
                <span class="uppercase text-xs tracking-wider">X·∫øp Bed Ngay</span>
            </button>
        </div>

        <div id="wrapper-btn-cancel" class="mt-3 hidden">
            <button id="btn-action-cancel" class="w-full py-3 rounded-[18px] text-red-400 font-bold bg-transparent hover:bg-red-50 transition-colors text-[10px] uppercase tracking-widest border border-dashed border-gray-300 hover:border-red-200">
                H·ªßy L·ªãch N√†y
            </button>
        </div>
    </div>
</div>
            </div>
            <div class="w-[20%] flex flex-col gap-3">
                <button onclick="openBookingModal()" class="w-full bg-[#006241] hover:bg-[#004f32] text-white py-4 rounded-[20px] font-bold shadow-md transform active:scale-95 transition-all flex flex-col items-center justify-center gap-1"><span class="text-xs uppercase tracking-wider">ƒê·∫∑t M·ªõi</span></button>
                <div class="flex-1 bg-white rounded-[20px] shadow-sm border border-gray-100 p-3 flex flex-col overflow-hidden"><h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3 text-center">Live Map</h3><div class="flex-1 flex flex-col gap-2 overflow-y-auto custom-scrollbar" id="vertical-map-container"></div></div>
            </div>
        </div>
    <div id="view-bed-mobile" class="hidden h-full flex flex-col relative">
    
    <div id="mob-bed-list-screen" class="flex flex-col h-full w-full absolute inset-0 z-10 bg-[#F2F2F7]">
        <header class="flex justify-between items-end px-5 pt-6 pb-6 bg-[#F2F2F7] shrink-0">
            <div>
                <p class="text-[11px] font-bold tracking-widest text-slate-400 uppercase">The Cafe 33</p>
                <h1 class="text-3xl font-bold tracking-tight text-slate-900">Danh s√°ch</h1>
            </div>
            <div class="bg-white px-3 py-1.5 rounded-full shadow-sm flex items-center gap-2 border border-slate-200">
                <input type="date" id="mob-date-picker" onchange="changeBedDateMobile(this.value)" class="text-sm font-bold bg-transparent border-none p-0 outline-none w-[90px] text-slate-700">
                <span class="material-symbols-outlined text-lg text-slate-400">calendar_today</span>
            </div>
        </header>

        <div id="mob-bed-list-container" class="flex-1 overflow-y-auto px-5 pb-32 space-y-3 custom-scrollbar">
            </div>

        <div class="absolute bottom-6 left-0 right-0 px-6 pointer-events-none z-20">
            <button onclick="openBookingModal()" class="pointer-events-auto mx-auto flex items-center justify-center gap-2 bg-[#064E3B] text-white w-full h-16 rounded-[22px] shadow-2xl shadow-emerald-900/30 active:scale-95 transition-all">
                <span class="material-symbols-outlined text-2xl font-bold">add</span>
                <span class="text-lg font-bold tracking-wide">ƒê·∫∂T M·ªöI</span>
            </button>
        </div>
    </div>

    <div id="mob-bed-detail-screen" class="flex flex-col h-full w-full absolute inset-0 z-30 bg-[#F2F2F7] transform translate-x-full transition-transform duration-300">
        
        <div id="mob-detail-header-container"></div>

        <main id="mob-bed-detail-content" class="flex-1 overflow-y-auto px-5 pt-2 pb-32 space-y-5 custom-scrollbar">
            </main>

        <div id="mob-detail-actions" class="absolute bottom-0 left-0 right-0 p-5 bg-[#F2F2F7]/90 backdrop-blur-xl border-t border-white/50 z-40 pb-8">
            </div>
    </div>
</div>
    <div id="view-revenue-mobile" class="hidden h-full flex flex-col bg-white overflow-hidden relative animate-fade-in">
    
    <header class="px-5 pt-6 pb-2 flex items-center justify-between bg-white sticky top-0 z-30 border-b border-gray-50/50">
    <div>
        <h1 class="text-2xl font-black tracking-tight text-[#1e3932] uppercase">Doanh Thu</h1>
    </div>
    
    <div class="flex items-center gap-2">
        <button onclick="openMobileDateFilter()" class="flex items-center gap-1 px-3 py-2 rounded-full bg-slate-50 border border-slate-100 active:scale-95 transition-transform">
            <span class="material-symbols-outlined text-[16px] text-slate-600 font-bold">calendar_month</span>
            <span class="text-[10px] font-bold text-slate-700 uppercase">L·ªçc ng√†y</span>
        </button>
        
        <div class="relative">
            <button onclick="toggleRevenueDropdown()" class="w-9 h-9 rounded-full bg-slate-50 border border-slate-100 flex items-center justify-center active:scale-95 transition-transform">
                <span class="material-symbols-outlined text-slate-600 text-[18px]">more_horiz</span>
            </button>
            <div id="mob-revenue-dropdown" class="hidden absolute top-full right-0 mt-2 w-56 bg-white rounded-2xl shadow-xl border border-slate-100 z-50 overflow-hidden origin-top-right transition-all">
    <button class="revenue-dropdown-item" onclick="switchRevenueView('overview')">T·ªïng quan (Bi·ªÉu ƒë·ªì)</button>
    <button class="revenue-dropdown-item" onclick="switchRevenueView('items')">Doanh thu theo m√≥n</button>
    <button class="revenue-dropdown-item" onclick="switchRevenueView('groups')">Doanh thu theo nh√≥m</button>
    <button class="revenue-dropdown-item" onclick="switchRevenueView('bed')">Doanh thu Cafe in Bed</button>
</div>
            <div id="mob-revenue-overlay" onclick="toggleRevenueDropdown()" class="hidden fixed inset-0 z-40"></div>
        </div>
    </div>
</header>

    <main class="flex-1 overflow-y-auto pb-20 custom-scrollbar">
        
        <div class="px-6 mb-8 mt-2">
            <div class="bg-slate-100 p-1.5 rounded-full flex items-center">
                <button onclick="switchRevTime('week')" id="tab-rev-week" class="flex-1 py-2.5 rounded-full text-[11px] font-black bg-[#065F46] text-white shadow-sm transition-all">TU·∫¶N</button>
                <button onclick="switchRevTime('month')" id="tab-rev-month" class="flex-1 py-2.5 rounded-full text-[11px] font-bold text-slate-400 transition-all">TH√ÅNG</button>
                <button onclick="switchRevTime('year')" id="tab-rev-year" class="flex-1 py-2.5 rounded-full text-[11px] font-bold text-slate-400 transition-all">NƒÇM</button>
            </div>
        </div>

        <div id="mob-revenue-summary-cards" class="grid grid-cols-2 gap-4 px-4 mb-6">
    
    <div class="bg-white p-4 py-5 rounded-[1.5rem] shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-slate-50 flex flex-col justify-center items-center text-center">
        <p class="text-[9px] font-extrabold uppercase tracking-[0.15em] text-slate-400 mb-1.5">T·ªïng thu</p>
        <div id="mob-rev-total" class="text-[#065F46] font-black tracking-tighter leading-none flex flex-col items-center">
            0 <span class="text-[10px] opacity-60">‚Ç´</span>
        </div>
    </div>

    <div class="bg-white p-4 py-5 rounded-[1.5rem] shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-slate-50 flex flex-col justify-center items-center text-center">
        <p class="text-[9px] font-extrabold uppercase tracking-[0.15em] text-slate-400 mb-1.5">ƒÇn v·∫∑t</p>
        <div id="mob-rev-snack" class="text-[#D97706] font-black tracking-tighter leading-none flex flex-col items-center">
            0 <span class="text-[10px] opacity-60">‚Ç´</span>
        </div>
    </div>

</div>

        <div class="px-5">
            <div class="bg-white rounded-[2.5rem] shadow-[0_20px_50px_rgba(0,0,0,0.06)] border border-slate-50 p-8">
                
                <div class="flex items-center justify-between mb-10">
                    <h3 id="mob-chart-title" class="font-bold text-xl tracking-tight text-slate-800">Bi·ªÉu ƒë·ªì doanh thu</h3>
                    <div class="relative z-20">
    <button onclick="toggleSmartTimeDropdown()" class="flex items-center gap-2 px-3 py-1.5 bg-emerald-50 rounded-full active:scale-95 transition-all border border-emerald-100 shadow-sm">
        <div class="w-2 h-2 rounded-full bg-[#065F46] animate-pulse"></div>
        <span class="text-[10px] font-bold text-[#065F46] uppercase tracking-wider min-w-[60px] text-center" id="mob-chart-label">Tu·∫ßn n√†y</span>
        <span class="material-symbols-outlined text-[14px] text-[#065F46]">arrow_drop_down</span>
    </button>

    <div id="smart-time-dropdown" class="hidden absolute top-full right-0 mt-2 w-40 bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden animate-fade-in origin-top-right">
        <div class="p-1">
            <button onclick="selectSmartTime('this_week')" class="w-full text-left px-3 py-2.5 hover:bg-emerald-50 rounded-lg text-[11px] font-bold text-slate-600 flex justify-between items-center group">
                Tu·∫ßn n√†y <span class="hidden group-hover:inline text-[#006241]">‚úì</span>
            </button>
            <button onclick="selectSmartTime('last_week')" class="w-full text-left px-3 py-2.5 hover:bg-emerald-50 rounded-lg text-[11px] font-bold text-slate-600 flex justify-between items-center group">
                Tu·∫ßn tr∆∞·ªõc <span class="hidden group-hover:inline text-[#006241]">‚úì</span>
            </button>
            <div class="h-[1px] bg-slate-100 my-1"></div>
            <button onclick="selectSmartTime('this_month')" class="w-full text-left px-3 py-2.5 hover:bg-emerald-50 rounded-lg text-[11px] font-bold text-slate-600 flex justify-between items-center group">
                Th√°ng n√†y <span class="hidden group-hover:inline text-[#006241]">‚úì</span>
            </button>
            <button onclick="selectSmartTime('last_month')" class="w-full text-left px-3 py-2.5 hover:bg-emerald-50 rounded-lg text-[11px] font-bold text-slate-600 flex justify-between items-center group">
                Th√°ng tr∆∞·ªõc <span class="hidden group-hover:inline text-[#006241]">‚úì</span>
            </button>
        </div>
    </div>
    <div id="smart-time-overlay" onclick="toggleSmartTimeDropdown()" class="hidden fixed inset-0 z-[-1]"></div>
</div>
                </div>

                <div class="relative h-64 w-full flex items-end justify-between gap-2 mb-8" id="mob-rev-chart-bars">
                    <div class="w-full h-full flex items-center justify-center text-slate-300">ƒêang t·∫£i...</div>
                </div>

                <div class="pt-8 border-t border-slate-50 flex items-center justify-between">
                    <div class="flex flex-col">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">T·ªïng c·ªông</span>
                        <span class="text-2xl font-black tracking-tight text-slate-900" id="mob-chart-total">0 ‚Ç´</span>
                    </div>
                    <button onclick="openHistory()" class="w-12 h-12 rounded-full bg-[#10172A] flex items-center justify-center text-white shadow-xl active:scale-90 transition-transform">
                        <span class="material-symbols-outlined font-bold">arrow_forward</span>
                    </button>
                </div>
            </div>
        </div>
        
        </main>
</div>
    </div>
</div>

<div id="sidebar-cart" class="w-[360px] bg-white rounded-[2.5rem] shadow-2xl flex flex-col p-4 border-l-4 border-[#006241] text-left transition-all duration-300 z-[50]"> 
    <div class="md:hidden w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-3 cursor-pointer" onclick="toggleCartExpand()"></div>

    <div class="hidden md:flex justify-between items-center mb-3">
        <h2 class="brand-font text-lg uppercase">ƒê∆°n h√†ng</h2>
        <button id="btn-clear-all" onclick="clearFullOrder()" class="bg-red-50 text-red-500 text-[9px] font-black px-3 py-1.5 rounded-xl uppercase">X√≥a</button>
    </div>

    <div id="cart-top-section" class="block md:block">
        <input type="tel" id="kh-sdt" oninput="checkSdtLive()" placeholder="SƒêT kh√°ch..." class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none border-2 border-gray-50 text-center font-bold text-base focus:border-[#006241]">
        <p id="sdt-status" class="text-[8px] font-black uppercase mb-3 text-center"></p>
    </div>

    <div id="cart-list" class="flex-1 overflow-y-auto space-y-1.5 mb-3 pr-1 text-left custom-scrollbar transition-all"></div>

    <div id="cart-bottom-bar" class="bg-gray-50 p-4 rounded-2xl space-y-3 shadow-inner text-left mt-auto">
        <div class="flex justify-between items-end" onclick="toggleCartExpand()">
            <span class="font-bold text-gray-400 text-[10px] uppercase text-left mb-1">T·ªïng bill</span>
            <div class="flex items-center gap-2">
                <span class="md:hidden text-[#006241] text-xs animate-bounce">‚ñ≤</span>
                <span id="total-price" class="text-3xl font-black text-[#006241]">0</span>
            </div>
        </div>
        <button id="sidebar-pay-btn" onclick="switchView('payment')" class="w-full py-4 sb-green text-white font-black rounded-xl uppercase shadow-xl active:scale-95 transition-all">Thanh to√°n</button>
    </div>
</div>

<div id="bed-select-modal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/40 backdrop-blur-sm transition-all duration-300 p-4 pb-8 sm:p-4">
    
    <div class="bg-[#F2F2F7] w-full max-w-[380px] rounded-3xl shadow-2xl overflow-hidden transform transition-all scale-100 relative flex flex-col animate-slide-up sm:animate-none">
        
        <div class="bg-[#006241] px-6 py-5 flex justify-between items-center shrink-0 relative overflow-hidden">
            <div class="absolute top-0 right-0 -mt-4 -mr-4 text-[#2a4f45] opacity-30">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor"><path d="M2 20h20v2H2v-2zm2-8h2v7H4v-7zm5 0h2v7H9v-7zm4 0h2v7h-2v-7zm5 0h2v7h-2v-7zM2 7h20v2H2V7zm2-5h2v4H4V2zm5 0h2v4H9V2zm4 0h2v4h-2V2zm5 0h2v4h-2V2z"/></svg>
            </div>
            <div class="relative z-10">
                <h3 class="text-white text-xl font-bold tracking-wide">Ch·ªçn Gi∆∞·ªùng</h3>
                <p class="text-green-100/80 text-sm mt-0.5">Vui l√≤ng ch·ªçn v·ªã tr√≠ c√≤n tr·ªëng</p>
            </div>
            <button onclick="document.getElementById('bed-select-modal').classList.add('hidden')" 
                class="relative z-10 w-8 h-8 rounded-full bg-black/20 flex items-center justify-center text-white hover:bg-black/30 transition backdrop-blur-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
            </button>
        </div>

        <div class="p-5 bg-[#F2F2F7]">
            <div class="grid grid-cols-2 gap-4" id="bed-selection-container">
                </div>
        </div>
        
        <div class="px-6 pb-5 text-center text-gray-400 text-[10px] font-medium uppercase tracking-wider">
            Ch·∫°m v√†o Bed m√†u xanh ƒë·ªÉ x√°c nh·∫≠n
        </div>
    </div>
</div>
<div id="walk-in-modal" class="fixed inset-0 bg-black/40 z-[9999] hidden flex items-center justify-center p-6 backdrop-blur-[4px]">
    <div class="bg-white/95 backdrop-blur-2xl w-full max-w-sm rounded-[35px] p-8 shadow-[0_30px_60px_rgba(0,0,0,0.3)] text-center border border-white/60">
        <h3 class="brand-font text-2xl text-[#006241] mb-1 uppercase font-black tracking-wide">Kh√°ch v√£ng lai</h3>
        <p class="text-[10px] text-gray-400 font-bold uppercase mb-6 tracking-widest">Nh·∫≠p th√¥ng tin nhanh</p>
        
        <input type="tel" id="walkin-phone" oninput="checkCustomer()" placeholder="Nh·∫≠p SƒêT kh√°ch..." 
            class="w-full p-4 bg-gray-50/50 rounded-3xl text-center font-bold mb-2 outline-none border border-gray-100 focus:border-[#006241] focus:bg-white transition-all text-[#006241] text-lg placeholder:text-gray-300">
        
        <div id="customer-info" class="h-4 mb-3 text-[10px]"></div>

        <input type="number" id="walkin-hours" placeholder="S·ªë gi·ªù (1, 2...)" 
            class="w-full p-4 bg-gray-50/50 rounded-3xl text-center font-bold mb-8 outline-none border border-gray-100 focus:border-[#006241] focus:bg-white transition-all text-[#006241] text-lg placeholder:text-gray-300">
        
        <div class="grid grid-cols-2 gap-3">
            <button onclick="document.getElementById('walk-in-modal').classList.add('hidden')" 
                class="py-4 bg-gray-100 text-gray-400 font-black rounded-[24px] uppercase text-xs hover:bg-gray-200 transition-all">
                Hu·ª∑
            </button>
            <button onclick="submitWalkIn()" 
                class="py-4 bg-[#006241] text-white font-black rounded-[24px] uppercase text-xs shadow-lg shadow-green-900/20 active:scale-95 transition-all">
                T·∫°o ƒë∆°n
            </button>
        </div>
    </div>
</div>

<div id="app-modal" class="fixed inset-0 bg-black/40 z-[9999] hidden flex items-center justify-center p-6 backdrop-blur-[4px]">
    <div class="bg-white/95 backdrop-blur-2xl w-full max-w-[320px] rounded-[35px] p-8 shadow-[0_30px_60px_rgba(0,0,0,0.3)] text-center border border-white/60">
        <div id="app-modal-icon" class="text-5xl mb-4"></div>
        <h3 id="app-modal-title" class="brand-font text-xl text-[#006241] mb-2 uppercase font-black text-center tracking-wide">Th√¥ng b√°o</h3>
        <div id="app-modal-msg" class="text-sm text-gray-600 font-medium mb-8 leading-relaxed px-2"></div>
        <button onclick="document.getElementById('app-modal').classList.add('hidden')" 
            class="w-full py-4 bg-[#006241] text-white font-black rounded-[24px] uppercase shadow-lg shadow-green-900/20 active:scale-95 transition-all">
            ƒê√£ hi·ªÉu
        </button>
    </div>
</div>

<div id="confirm-modal" class="fixed inset-0 bg-black/40 z-[10000] hidden flex items-center justify-center p-6 backdrop-blur-[4px]">
    <div class="bg-white/95 backdrop-blur-2xl w-full max-w-[320px] rounded-[35px] p-8 shadow-[0_30px_60px_rgba(0,0,0,0.3)] text-center border border-white/60 border-t-8 border-t-red-500">
        <div class="text-5xl mb-4">‚ö†Ô∏è</div>
        <h3 class="brand-font text-xl text-red-500 mb-2 uppercase font-black text-center tracking-wide">L∆∞u √Ω</h3>
        <div id="confirm-msg" class="text-sm text-gray-600 font-medium mb-8 leading-relaxed"></div>
        <div class="grid grid-cols-2 gap-3">
            <button onclick="document.getElementById('confirm-modal').classList.add('hidden')" 
                class="py-4 bg-gray-100 text-gray-500 rounded-[24px] font-black uppercase text-[10px] hover:bg-gray-200 transition-all">
                Quay l·∫°i
            </button>
            <button id="confirm-btn-yes" 
                class="py-4 bg-red-500 text-white rounded-[24px] font-black uppercase text-[10px] shadow-lg shadow-red-500/30 active:scale-95 transition-all">
                ƒê·ªìng √Ω
            </button>
        </div>
    </div>
</div>

<div id="size-modal" class="fixed inset-0 bg-black/40 z-[100] hidden items-center justify-center p-6 backdrop-blur-[6px]" onclick="closeSize()">
    
    <div class="bg-white/95 backdrop-blur-2xl w-full max-w-[500px] rounded-[45px] p-10 text-center shadow-[0_30px_80px_rgba(0,0,0,0.3)] border border-white/60 relative overflow-hidden" onclick="event.stopPropagation()">

        <h3 id="modal-item-name" class="brand-font text-3xl text-[#006241] mb-2 uppercase text-center font-black mt-2 leading-tight">T√™n m√≥n</h3>
        <p class="text-xs text-gray-400 font-bold uppercase tracking-widest mb-10">Vui l√≤ng ch·ªçn k√≠ch c·ª°</p>
        
        <div id="size-options-container" class="grid grid-cols-2 gap-6 text-center">
            
            <button id="btn-size-m" class="p-6 rounded-[35px] bg-green-50/50 border-2 border-[#006241]/10 flex flex-col items-center justify-center transition-all shadow-sm active:scale-95 active:bg-green-100 h-[200px]">
                <span class="block text-6xl mb-4 drop-shadow-sm">ü•§</span>
                <span class="block font-black text-xl uppercase text-[#006241]">SIZE M</span>
                <span id="price-m" class="text-[#006241] font-bold mt-2 text-2xl">--</span>
            </button>

            <button id="btn-size-l" class="p-6 rounded-[35px] bg-green-50/50 border-2 border-[#006241]/10 flex flex-col items-center justify-center transition-all shadow-sm active:scale-95 active:bg-green-100 h-[200px]">
                <span class="block text-7xl mb-4 drop-shadow-sm">ü•§</span>
                <span class="block font-black text-xl uppercase text-[#006241]">SIZE L</span>
                <span id="price-l" class="text-[#006241] font-bold mt-2 text-2xl">--</span>
            </button>
        </div>
    </div>
</div>
<div id="modal-add-booking" class="hidden fixed inset-0 z-[200] flex items-end md:items-center justify-center bg-slate-900/60 backdrop-blur-md transition-all duration-300">
    
    <div class="bg-white w-full md:max-w-[500px] h-[90vh] md:h-auto md:max-h-[85vh] rounded-t-[40px] md:rounded-[40px] shadow-2xl flex flex-col relative overflow-hidden animate-slide-up">
        
        <div class="px-8 pt-8 pb-4 flex justify-between items-start bg-white z-10 shrink-0">
            <div>
                <h2 class="text-3xl font-black text-[#1e3932] tracking-tighter uppercase leading-none">ƒê·∫∑t Bed M·ªõi</h2>
                <p class="text-sm font-bold text-gray-400 mt-1">Nh·∫≠p th√¥ng tin kh√°ch h√†ng</p>
            </div>
            <button onclick="closeBookingModal()" class="w-12 h-12 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-red-50 hover:text-red-500 transition-colors active:scale-90">
                <span class="material-symbols-outlined text-2xl font-bold">close</span>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar px-8 pb-4 space-y-6">
            
            <div class="space-y-3">
                <div class="flex items-center gap-2">
                    <span class="w-1.5 h-1.5 rounded-full bg-[#006241]"></span>
                    <p class="text-[11px] font-black text-gray-400 uppercase tracking-[0.2em]">Ng∆∞·ªùi ƒë·∫∑t ch√≠nh</p>
                </div>
                
                <div class="space-y-4">
                    <div class="relative w-full">
                        <input type="tel" id="new_cust_phone" placeholder=" " oninput="autoFillCustomer()"
                            class="peer w-full h-[64px] pt-6 pb-2 px-5 bg-[#F2F4F7] rounded-[20px] text-xl font-black text-[#1e3932] outline-none border-2 border-transparent focus:border-[#006241] focus:bg-white transition-all placeholder-transparent shadow-sm">
                        <label class="absolute left-5 top-4 text-[10px] text-[#006241] font-bold uppercase tracking-wider transition-all 
                                    peer-placeholder-shown:top-1/2 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-400 peer-placeholder-shown:font-medium peer-placeholder-shown:normal-case 
                                    peer-focus:top-4 peer-focus:-translate-y-0 peer-focus:text-[10px] peer-focus:text-[#006241] peer-focus:font-bold peer-focus:uppercase pointer-events-none">
                            S·ªë ƒëi·ªán tho·∫°i
                        </label>
                        <span class="material-symbols-outlined absolute right-5 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">dialpad</span>
                    </div>

                    <div class="relative w-full">
                        <input type="text" id="new_cust_name" placeholder=" " value="Kh√°ch v√£ng lai"
                            class="peer w-full h-[64px] pt-6 pb-2 px-5 bg-[#F2F4F7] rounded-[20px] text-xl font-black text-[#1e3932] outline-none border-2 border-transparent focus:border-[#006241] focus:bg-white transition-all placeholder-transparent shadow-sm">
                        <label class="absolute left-5 top-4 text-[10px] text-[#006241] font-bold uppercase tracking-wider transition-all 
                                    peer-placeholder-shown:top-1/2 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-400 peer-placeholder-shown:font-medium peer-placeholder-shown:normal-case 
                                    peer-focus:top-4 peer-focus:-translate-y-0 peer-focus:text-[10px] peer-focus:text-[#006241] peer-focus:font-bold peer-focus:uppercase pointer-events-none">
                            H·ªç v√† T√™n
                        </label>
                    </div>
                </div>
            </div>

            <div class="space-y-3">
                <div class="flex items-center gap-2">
                    <span class="w-1.5 h-1.5 rounded-full bg-purple-400"></span>
                    <p class="text-[11px] font-black text-gray-400 uppercase tracking-[0.2em]">Ng∆∞·ªùi ƒëi c√πng (Auto-fill)</p>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="relative w-full">
                        <input type="text" id="new_comp_name" placeholder=" "
                            class="peer w-full h-[56px] pt-5 pb-1 px-4 bg-white border border-gray-200 rounded-[18px] text-base font-bold text-slate-700 outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition-all placeholder-transparent">
                        <label class="absolute left-4 top-3 text-[9px] text-purple-600 font-bold uppercase tracking-wider transition-all 
                                    peer-placeholder-shown:top-1/2 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:text-sm peer-placeholder-shown:text-gray-400 peer-placeholder-shown:font-medium peer-placeholder-shown:normal-case 
                                    peer-focus:top-3 peer-focus:-translate-y-0 peer-focus:text-[9px] peer-focus:text-purple-600 peer-focus:uppercase pointer-events-none">
                            T√™n b·∫°n
                        </label>
                    </div>
                    <div class="relative w-full">
                        <input type="tel" id="new_comp_phone" placeholder=" "
                            class="peer w-full h-[56px] pt-5 pb-1 px-4 bg-white border border-gray-200 rounded-[18px] text-base font-bold text-slate-700 outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition-all placeholder-transparent">
                        <label class="absolute left-4 top-3 text-[9px] text-purple-600 font-bold uppercase tracking-wider transition-all 
                                    peer-placeholder-shown:top-1/2 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:text-sm peer-placeholder-shown:text-gray-400 peer-placeholder-shown:font-medium peer-placeholder-shown:normal-case 
                                    peer-focus:top-3 peer-focus:-translate-y-0 peer-focus:text-[9px] peer-focus:text-purple-600 peer-focus:uppercase pointer-events-none">
                            SƒêT b·∫°n
                        </label>
                    </div>
                </div>
            </div>

            <div class="space-y-4 pb-4">
                <div class="flex items-center gap-2">
                    <span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span>
                    <p class="text-[11px] font-black text-gray-400 uppercase tracking-[0.2em]">Th·ªùi gian s·ª≠ d·ª•ng</p>
                </div>

                <div class="bg-[#F2F4F7] p-1.5 rounded-[20px] flex relative">
                    <button onclick="toggleTimeMode('duration')" id="tab-duration" class="flex-1 py-3 rounded-[16px] text-xs font-black uppercase tracking-wider bg-white text-[#006241] shadow-sm transition-all duration-300">
                        Theo Ti·∫øng
                    </button>
                    <button onclick="toggleTimeMode('end-time')" id="tab-end-time" class="flex-1 py-3 rounded-[16px] text-xs font-black uppercase tracking-wider text-gray-400 hover:text-gray-600 transition-all duration-300">
                        Ch·ªçn Gi·ªù V·ªÅ
                    </button>
                </div>
                
                <div id="mode-duration-box" class="grid grid-cols-3 gap-3">
                    <button onclick="selectDurationNew(1)" id="btn-dur-1" class="h-16 border-2 border-[#006241] bg-green-50 text-[#006241] rounded-[20px] flex flex-col items-center justify-center transition-all shadow-sm">
                        <span class="text-xl font-black">1H</span>
                    </button>
                    <button onclick="selectDurationNew(2)" id="btn-dur-2" class="h-16 border-2 border-transparent bg-white text-gray-500 rounded-[20px] flex flex-col items-center justify-center hover:bg-gray-50 transition-all border-gray-100">
                        <span class="text-xl font-black">2H</span>
                    </button>
                    <button onclick="selectDurationNew(3)" id="btn-dur-3" class="h-16 border-2 border-transparent bg-white text-gray-500 rounded-[20px] flex flex-col items-center justify-center hover:bg-gray-50 transition-all border-gray-100">
                        <span class="text-xl font-black">3H</span>
                    </button>
                </div>
                
                <div id="mode-endtime-box" class="hidden animate-fade-in">
                    <div class="relative group">
                        <input type="time" id="manual-end-time"
                            class="w-full h-20 bg-white border-2 border-gray-200 rounded-[24px] text-3xl font-black text-[#006241] text-center focus:border-[#006241] outline-none shadow-sm flex items-center justify-center px-4">
                        <span class="absolute top-1/2 left-6 -translate-y-1/2 text-gray-400 pointer-events-none">
                            <span class="material-symbols-outlined">schedule</span>
                        </span>
                         <p class="text-center text-[10px] font-bold text-gray-400 mt-2 uppercase tracking-widest" id="calculated-time-hint">H·ªá th·ªëng s·∫Ω t·ª± t√≠nh ti·ªÅn</p>
                    </div>
                </div>

                <input type="hidden" id="final_duration_minutes" value="60">
            </div>
        </div>

        <div class="p-8 pt-4 bg-white border-t border-gray-50 z-20 shrink-0">
            <button onclick="submitNewBooking()" class="w-full h-16 bg-[#006241] hover:bg-[#004f32] text-white rounded-[24px] font-black text-lg uppercase tracking-wider shadow-xl shadow-emerald-900/20 active:scale-[0.98] transition-all flex items-center justify-center gap-3 group">
                <span class="material-symbols-outlined text-2xl group-hover:scale-110 transition-transform">add_circle</span>
                T·∫°o L·ªãch & Ch·ªù X·∫øp
            </button>
        </div>
    </div>
</div>
    
</div>

<script>    
function normalizePhone(p){
    return String(p || "").replace(/[^0-9]/g, "");
}

function findCustomerByPhone(phone){
    const key = normalizePhone(phone);
    if(!key) return null;
    return customerMap[key] || null;
}


// =========================================================
// 1. C·∫§U H√åNH & K·∫æT N·ªêI FIREBASE
// =========================================================
const firebaseConfig = {
  apiKey: "AIzaSyCNh1-16gYZ0P30Fkd-2tB-O89PXkPX9Lc",
  authDomain: "the-cafe-33.firebaseapp.com",
  databaseURL: "https://the-cafe-33-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "the-cafe-33",
  storageBucket: "the-cafe-33.appspot.com",
  messagingSenderId: "...",
  appId: "..."
};

// Kh·ªüi t·∫°o Firebase an to√†n
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.database();
// --- B·∫ÆT ƒê·∫¶U CODE ƒêƒÇNG NH·∫¨P T·ª∞ ƒê·ªòNG ---
const auth = firebase.auth();

function autoLoginPOS() {
    // Thay email/pass b·∫±ng c√°i b√† t·∫°o ·ªü B∆Ø·ªöC 1
    const email = "elio@thecafe33.com"; 
    const pass = "Thecafe33ty"; 

    auth.signInWithEmailAndPassword(email, pass)
        .then((userCredential) => {
            console.log("‚úÖ ƒê√£ ƒëƒÉng nh·∫≠p Admin th√†nh c√¥ng!");
            // ƒêƒÉng nh·∫≠p xong m·ªõi t·∫£i d·ªØ li·ªáu cho ch·∫Øc
            // (C√°c h√†m t·∫£i d·ªØ li·ªáu c≈© v·∫´n s·∫Ω t·ª± ch·∫°y nh·ªù listener, n√™n kh√¥ng c·∫ßn g·ªçi l·∫°i ·ªü ƒë√¢y c≈©ng ƒë∆∞·ª£c)
        })
        .catch((error) => {
            console.error("‚ùå L·ªói ƒëƒÉng nh·∫≠p:", error.message);
            alert("L·ªói: Kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p v√†o h·ªá th·ªëng! Ki·ªÉm tra l·∫°i Email/Pass trong code.");
        });
}

// G·ªçi h√†m n√†y ngay khi ch·∫°y App
autoLoginPOS();
// --- K·∫æT TH√öC CODE ƒêƒÇNG NH·∫¨P ---
// =========================================================
// 2. BI·∫æN TO√ÄN C·ª§C
// =========================================================
let menu = []; 
let historyData = [];
let cart = [];
let currentTotal = 0;
let customerMap = {};
let currentTab = "T·∫•t c·∫£";
let isPaymentMode = false;
let myChart = null;
let selectedRefundItems = [];
let paymentListener = null; // Bi·∫øn ƒë·ªÉ theo d√µi ti·ªÅn v·ªÅ
let currentOrderCode = "";  // Bi·∫øn l∆∞u m√£ ƒë∆°n h√†ng ƒëang ch·ªù


// Bi·∫øn qu·∫£n l√Ω Bed
var currentBedList = [];
var selectedBedIndex = -1;
var bedCountdownInterval = null;
var pendingBedOrder = null;
var activeOrderingBedId = null;
var isCheckoutFlow = false; // Bi·∫øn ƒë√°nh d·∫•u: C√≥ ph·∫£i ƒëang tr·∫£ Bed kh√¥ng?

// ƒê·ªìng h·ªì h·ªá th·ªëng
setInterval(() => {
    const el = document.getElementById('clock');
    if(el) el.innerText = new Date().toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
}, 1000);

// =========================================================
// 3. KH·ªûI ƒê·ªòNG APP (C√ì C∆† CH·∫æ CH·ªêNG TREO)
// =========================================================
    // === FIX ID SƒêT: walkin-phone -> kh-sdt ===


window.onload = function() {
    console.log("üöÄ App ƒëang kh·ªüi ƒë·ªông...");

    // A. C√†i ƒë·∫∑t "L·ªëi tho√°t hi·ªÉm": T·ª± t·∫Øt loading sau 5 gi√¢y n·∫øu Firebase kh√¥ng ph·∫£n h·ªìi
    const safetyTimer = setTimeout(() => {
        const ol = document.getElementById('loading-overlay');
        if(ol && ol.style.display !== 'none') {
            ol.style.display = 'none';
            console.warn("‚ö†Ô∏è Loading qu√° l√¢u, t·ª± ƒë·ªông b·ªè qua.");
        }
    }, 5000);

    // B. L·∫Øng nghe Menu t·ª´ Firebase
    db.ref("customers").on("value", (snap) => {
    customerMap = snap.val() || {};
    console.log("Customers:", Object.keys(customerMap).length);
});

    db.ref('menu').on('value', (snapshot) => {
        clearTimeout(safetyTimer); // H·ªßy b·ªô ƒë·∫øm tho√°t hi·ªÉm v√¨ ƒë√£ k·∫øt n·ªëi ƒë∆∞·ª£c
        const data = snapshot.val();
        
        if (data) {
            menu = Array.isArray(data) ? data : Object.values(data);
            console.log(`‚úÖ ƒê√£ t·∫£i ${menu.length} m√≥n.`);
            // V·∫Ω giao di·ªán
            renderTabs();
            renderMenu();
        } else {
            console.log("‚ö†Ô∏è Menu tr√™n Firebase ƒëang tr·ªëng!");
        }
        // T·∫Øt m√†n h√¨nh loading
        document.getElementById('loading-overlay').style.display = 'none';
    }, (error) => {
        console.error("‚ùå L·ªói Firebase Menu:", error);
        document.getElementById('loading-overlay').style.display = 'none';
        alert("L·ªói k·∫øt n·ªëi: " + error.message);
    });
// C. L·∫Øng nghe danh s√°ch KH√ÅCH H√ÄNG t·ª´ Firebase
db.ref("customers").on("value", snap => {
    customerMap = snap.val() || {};
    console.log("üë• ƒê√£ load", Object.keys(customerMap).length, "kh√°ch");
});

    // C. L·∫Øng nghe Bed (Ch·∫°y ng·∫ßm)
    db.ref('beds').on('value', (snapshot) => {
        const data = snapshot.val();
        currentBedList = [];
        if(data) {
            Object.keys(data).forEach(key => {
                let item = data[key];
                item.key = key; 
                currentBedList.push(item);
            });
        }
        // N·∫øu ƒëang m·ªü tab Bed th√¨ v·∫Ω l·∫°i ngay
        const viewBed = document.getElementById('view-bed');
        if(viewBed && !viewBed.classList.contains('hidden')) {
            renderBedBookings(currentBedList);
        }
    });
    switchView('menu'); // <--- K√≠ch ho·∫°t giao di·ªán & Hi·ªán Bottom Bar ngay l·∫≠p t·ª©c
};

// =========================================================
// 4. MENU & GI·ªé H√ÄNG (CORE)
// =========================================================
// --- H√ÄM V·∫º MENU (2 TRONG 1: NGANG CHO PC - D·ªåC CHO MOBILE) ---
// --- H√ÄM V·∫º MENU & C·∫¨P NH·∫¨T T·ªîNG TI·ªÄN TR√äN ƒê·∫¶U ---

function renderTabs() {
    if (!menu || menu.length === 0) return;
    const cats = ["T·∫•t c·∫£", ...new Set(menu.map(m => m.type))];

    // 1. Render cho Tablet (Gi·ªØ nguy√™n)
    const containerPC = document.getElementById('tabs-container');
    if(containerPC) {
        containerPC.innerHTML = cats.map(c => `<button onclick="filterTab('${c}')" class="category-tab ${c === currentTab? 'tab-active': 'bg-white text-gray-400'} capitalize-first transition-all">${c}</button>`).join('');
    }

    // 2. Render cho Mobile (Dropdown ki·ªÉu m·ªõi)
    const containerMob = document.getElementById('mob-cat-list-new');
    if(containerMob) {
        containerMob.innerHTML = cats.map(c => {
            const isActive = (c === currentTab);
            // Style: N√∫t bo tr√≤n, icon check b√™n ph·∫£i
            return `
            <div onclick="filterTabMobile('${c}')" class="p-3 rounded-xl flex justify-between items-center cursor-pointer transition-all ${isActive ? 'bg-green-50 text-[#006241]' : 'hover:bg-gray-50 text-gray-600'}">
                <span class="capitalize-first font-bold text-sm ml-2">${c}</span>
                ${isActive ? '<span class="text-[#006241] text-lg font-black">‚úì</span>' : ''}
            </div>
            `;
        }).join('');
    }
}

// ============================================================
// --- 1. LOGIC MENU DANH M·ª§C TR∆Ø·ª¢T T·ª™ ƒê√ÅY (BOTTOM SHEET) ---
// ============================================================
// --- H√ÄM M·ªû DANH M·ª§C (GIAO DI·ªÜN S√ÅNG & N√öT CHUBBY) ---
// --- LOGIC DROPDOWN MENU (M·ªöI: TH·∫¢ T·ª™ TR√äN XU·ªêNG) ---

// 1. H√†m B·∫≠t/T·∫Øt Menu
// 1. H√†m B·∫≠t/T·∫Øt Menu (ƒê√£ ch·ªânh ch·ªØ TO v√† ƒê·∫¨M)
function toggleCategoryDropdown() {
    const drop = document.getElementById('mob-cat-dropdown');
    const overlay = document.getElementById('mob-cat-overlay');
    const list = document.getElementById('mob-cat-list');

    if (drop.classList.contains('hidden')) {
        // --- M·ªû MENU ---
        
        // V·∫Ω danh s√°ch m√≥n
        const cats = ["T·∫•t c·∫£", ...new Set(menu.map(m => m.type))];
        list.innerHTML = cats.map(c => {
            const isActive = (c === currentTab);
            
            // LOGIC STYLE:
            // - text-lg: Ch·ªØ to (Large)
            // - font-black: Ch·ªØ si√™u ƒë·∫≠m (d·ªÖ ƒë·ªçc)
            // - py-4: N√∫t cao, d·ªÖ b·∫•m
            
            return `
            <button onclick="selectCategoryDropdown('${c}')" class="w-full py-4 px-6 rounded-[1.5rem] flex items-center justify-between transition-all mb-1 ${isActive ? 'bg-[#E6F4F1] text-[#006241] shadow-sm ring-1 ring-[#006241]/20' : 'bg-white text-gray-700 hover:bg-gray-50'}">
                <span class="capitalize-first text-lg font-black tracking-wide">${c}</span>
                ${isActive ? '<span class="text-xl font-bold">‚úì</span>' : ''}
            </button>`;
        }).join('');

        // Hi·ªáu ·ª©ng hi·ªán ra
        drop.classList.remove('hidden');
        overlay.classList.remove('hidden');
        setTimeout(() => {
            drop.classList.remove('opacity-0', 'scale-95');
            drop.classList.add('opacity-100', 'scale-100');
        }, 10);

    } else {
        // --- ƒê√ìNG MENU ---
        closeCategoryDropdown();
    }
}

// 2. H√†m ƒê√≥ng Menu (Hi·ªáu ·ª©ng m∆∞·ª£t)
function closeCategoryDropdown() {
    const drop = document.getElementById('mob-cat-dropdown');
    const overlay = document.getElementById('mob-cat-overlay');
    
    drop.classList.remove('opacity-100', 'scale-100');
    drop.classList.add('opacity-0', 'scale-95');
    overlay.classList.add('hidden');
    
    setTimeout(() => {
        drop.classList.add('hidden');
    }, 200);
}

// 3. H√†m Ch·ªçn M√≥n (X·ª≠ l√Ω xong th√¨ t·ª± ƒë√≥ng)
function selectCategoryDropdown(c) {
    currentTab = c;
    document.getElementById('mob-cat-label-new').innerText = c;
    renderMenu(); // L·ªçc m√≥n ƒÉn
    closeCategoryDropdown(); // ƒê√≥ng menu
}

function closeCategorySheet() {
    const sheet = document.getElementById('sheet-category');
    const content = document.getElementById('sheet-category-content');
    
    // Hi·ªáu ·ª©ng ƒë√≥ng
    content.classList.remove('sheet-open');
    sheet.querySelector('div').classList.add('opacity-0');
    
    setTimeout(() => {
        sheet.classList.add('hidden');
    }, 300);
}

// Khi ch·ªçn danh m·ª•c tr√™n Mobile
function selectCategoryMobile(c) {
    currentTab = c;
    // C·∫≠p nh·∫≠t ch·ªØ tr√™n n√∫t Menu
    document.getElementById('mob-cat-label-new').innerText = c;
    renderMenu(); // L·ªçc m√≥n ƒÉn
    closeCategorySheet(); // ƒê√≥ng sheet
}

// ============================================================
// --- 2. LOGIC GI·ªé H√ÄNG MOBILE (S·ª¨A / X√ìA M√ìN) ---
// ============================================================
// --- S·ª¨A H√ÄM N√ÄY ƒê·ªÇ GIAO DI·ªÜN N√öT TR√íN & KH√îNG B·ªä THANH BAR ƒê√à ---
/* --- ƒê√É S·ª¨A: Text to h∆°n, Padding ƒë√°y 200px ƒë·ªÉ kh√¥ng b·ªã ƒë√® --- */
/* --- ƒê√É S·ª¨A: Modal Chi Ti·∫øt Gi·ªè H√†ng (Ch·ªØ to, N√∫t tr√≤n, Padding ƒë√°y l·ªõn) --- */
function openCartModal() {
    if(cart.length === 0) return alert("Gi·ªè h√†ng ƒëang tr·ªëng! Ch·ªçn m√≥n ƒëi b√†.");

    const listEl = document.getElementById('sheet-cart-list');

    listEl.innerHTML = cart.map((i, idx) => `
    <div class="bg-white p-4 rounded-[24px] border border-gray-100 shadow-[0_2px_8px_rgba(0,0,0,0.04)] flex items-center gap-4 mb-3 relative overflow-hidden">
        
        <div class="flex-1 min-w-0 text-left">
            <p class="font-black text-[#1e3932] text-lg truncate capitalize-first tracking-tight">${i.name}</p>
            <p class="text-sm text-gray-400 font-bold uppercase mt-1">${i.size} ‚Ä¢ <span class="text-[#006241]">${i.price.toLocaleString()}ƒë</span></p>
        </div>

        <div class="flex items-center gap-3 bg-[#F2F4F6] rounded-full p-2 shadow-inner">
            <button onclick="updateQtyMobile(${idx}, -1)" class="w-10 h-10 flex items-center justify-center bg-white rounded-full shadow-sm text-gray-600 font-bold active:scale-90 transition-all text-2xl hover:text-red-500 leading-none pb-1">-</button>
            <span class="font-black text-xl w-6 text-center text-[#1e3932]">${i.qty}</span>
            <button onclick="updateQtyMobile(${idx}, 1)" class="w-10 h-10 flex items-center justify-center bg-[#006241] rounded-full shadow-lg shadow-green-900/20 text-white font-bold active:scale-90 transition-all text-2xl leading-none pb-1">+</button>
        </div>

        <button onclick="removeItemMobile(${idx})" class="w-12 h-12 flex items-center justify-center text-red-500 bg-red-50 rounded-full active:scale-90 transition-all hover:bg-red-100 border border-red-100 shadow-sm ml-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        </button>
    </div>
    `).join('');

    // ƒê·∫©y n·ªôi dung l√™n cao 200px ƒë·ªÉ kh√¥ng b·ªã thanh Bar che
    listEl.style.paddingBottom = "200px"; 

    document.getElementById('sheet-cart-edit').classList.remove('hidden');
    document.body.classList.add('cart-modal-open');     // ‚Üê TH√äM D√íNG N√ÄY
    updateCartPadding();
}
function closeCartModal() {
    document.getElementById('sheet-cart-edit').classList.add('hidden');
    document.body.classList.remove('cart-modal-open');  // ‚Üê TH√äM D√íNG N√ÄY
    updateCartPadding();
}

function updateQtyMobile(idx, delta) {
    cart[idx].qty += delta;
    if (cart[idx].qty <= 0) cart.splice(idx, 1); // H·∫øt th√¨ x√≥a lu√¥n
    
    renderCart(); // C·∫≠p nh·∫≠t l·∫°i t·ªïng ti·ªÅn b√™n ngo√†i
    
    if(cart.length === 0) closeCartModal();
    else openCartModal(); // V·∫Ω l·∫°i modal ƒë·ªÉ th·∫•y s·ªë l∆∞·ª£ng m·ªõi
}

// --- LOGIC X√ìA GI·ªé H√ÄNG NHANH (KH√îNG H·ªéI) ---

// 1. X√≥a t·ª´ng m√≥n (B·∫•m l√† bay)
function removeItemMobile(idx) {
    // Kh√¥ng confirm n·ªØa, x√≥a th·∫≥ng tay
    cart.splice(idx, 1);
    
    renderCart(); // C·∫≠p nh·∫≠t l·∫°i ti·ªÅn
    
    if(cart.length === 0) {
        closeCartModal(); // H·∫øt s·∫°ch th√¨ ƒë√≥ng lu√¥n
    } else {
        openCartModal();  // C√≤n th√¨ v·∫Ω l·∫°i danh s√°ch
    }
}

// 2. X√≥a h·∫øt t·∫•t c·∫£ (N√∫t m·ªõi)
// --- X√ìA H·∫æT (GI·ªÆ NGUY√äN M√ÄN H√åNH) ---
function clearAllMobile() {
    // 1. X√≥a d·ªØ li·ªáu
    cart = []; 
    
    // 2. C·∫≠p nh·∫≠t ti·ªÅn ·ªü Bottom Bar (v·ªÅ 0ƒë)
    renderCart(); 
    
    // 3. Thay v√¨ ƒë√≥ng Modal, ta v·∫Ω l·∫°i n·ªôi dung b√™n trong th√†nh "Tr·ªëng"
    const listEl = document.getElementById('sheet-cart-list');
    if(listEl) {
        listEl.innerHTML = `
            <div class="flex flex-col items-center justify-center h-64 text-gray-300 animate-fade-in">
                <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                </div>
                <span class="text-xs font-bold uppercase tracking-wider">Gi·ªè h√†ng tr·ªëng tr∆°n</span>
            </div>
        `;
    }
}

// --- H√ÄM ƒê√ìNG M·ªû DROPDOWN ---
function toggleCatDropdown() {
    const drop = document.getElementById('mob-cat-dropdown');
    const overlay = document.getElementById('mob-cat-overlay');
    const arrow = document.getElementById('cat-arrow');
    
    if (drop.classList.contains('hidden')) {
        // M·ªü ra
        drop.classList.remove('hidden');
        overlay.classList.remove('hidden');
        arrow.style.transform = "rotate(180deg)"; // Xoay m≈©i t√™n l√™n
    } else {
        // ƒê√≥ng l·∫°i
        drop.classList.add('hidden');
        overlay.classList.add('hidden');
        arrow.style.transform = "rotate(0deg)"; // Xoay m≈©i t√™n xu·ªëng
    }
}

// --- H√ÄM CH·ªåN DANH M·ª§C TR√äN MOBILE ---
function filterTabMobile(c) {
    // 1. C·∫≠p nh·∫≠t bi·∫øn to√†n c·ª•c
    currentTab = c;
    
    // 2. C·∫≠p nh·∫≠t nh√£n tr√™n n√∫t b·∫•m
    document.getElementById('mob-cat-label').innerText = c;
    
    // 3. L·ªçc m√≥n ƒÉn
    renderMenu();
    
    // 4. V·∫Ω l·∫°i dropdown (ƒë·ªÉ chuy·ªÉn d·∫•u t√≠ch xanh sang m√≥n m·ªõi)
    renderTabs();
    
    // 5. ƒê√≥ng dropdown
    toggleCatDropdown();
}

function filterTab(c) {
    currentTab = c; 
    
    // C·∫≠p nh·∫≠t giao di·ªán Tablet
    renderTabs(); 
    renderMenu();
    
    // C·∫≠p nh·∫≠t lu√¥n nh√£n Mobile (n·∫øu c√≥)
    const mobLabel = document.getElementById('mob-cat-label');
    if(mobLabel) mobLabel.innerText = c;
}

function renderMenu() { 
    const filtered = currentTab === "T·∫•t c·∫£"? menu: menu.filter(m => m.type === currentTab);
    const grid = document.getElementById('menu-grid');
    if (!grid) return;
    
    if (filtered.length === 0) { 
        grid.innerHTML = '<div class="col-span-3 text-center text-gray-400 py-10">Kh√¥ng c√≥ m√≥n n√†o.</div>'; 
        return; 
    }
    
    // --- RENDER MENU: H√åNH VU√îNG BO TR√íN (MOBILE) ---
    grid.innerHTML = filtered.map(m => 
        `<div onclick="handleItemClick('${m.name}', ${m.priceM}, ${m.priceL})" 
            class="bg-white border border-gray-100 shadow-[0_4px_12px_rgba(0,0,0,0.03)] flex flex-col justify-between items-center text-center cursor-pointer transition-all active:scale-95 relative overflow-hidden group
            
            /* --- MOBILE START: VU√îNG TUY·ªÜT ƒê·ªêI --- */
            aspect-square            /* √âp h√¨nh vu√¥ng */
            p-3                      /* Padding v·ª´a ph·∫£i ƒë·ªÉ kh√¥ng b·ªã ch·∫≠t */
            rounded-[2.2rem]         /* Bo g√≥c c·ª±c ƒë·∫°i gi·ªëng ·∫£nh m·∫´u */
            /* --- MOBILE END --- */

            /* --- PC START (Gi·ªØ nguy√™n) --- */
            md:aspect-auto md:h-32 md:p-5 md:rounded-[2rem] md:border-2 md:border-gray-50 md:shadow-sm md:justify-center">
            
            <div class="flex-1 flex items-center justify-center w-full overflow-hidden">
                <p class="font-black text-[#1e3932] uppercase break-words leading-none group-hover:text-[#006241] transition-colors
                          
                          /* Mobile: Ch·ªØ to, ƒë·∫≠m, t·ªëi ƒëa 2 d√≤ng */
                          text-lg line-clamp-2
                          
                          /* PC */
                          md:text-[1rem] md:line-clamp-3"> 
                    ${m.name}
                </p>
            </div>

            <div class="w-full pt-1 flex justify-center md:mt-2 md:pb-0 shrink-0">
                <p class="font-extrabold text-[#006241] tracking-tight shadow-sm
                          
                          /* Mobile: Style vi√™n thu·ªëc */
                          bg-[#E6F4F1] px-5 py-2 rounded-full text-base
                          
                          /* PC */
                          md:text-[11px] md:bg-transparent md:p-0 md:rounded-none md:shadow-none">
                    ${m.priceM > 0 ? (m.priceM/1000) + 'k' : (m.priceL/1000) + 'k'}
                </p>
            </div>

        </div>`
    ).join('');
}
function handleItemClick(name, pM, pL) { 
    if(isPaymentMode) return; 
    const vM = Number(pM), vL = Number(pL);
    
    // N·∫øu m√≥n c√≥ 2 size -> M·ªü Popup
    if (vM > 0 && vL > 0) { 
        document.getElementById('modal-item-name').innerText = name; 
        document.getElementById('price-m').innerText = vM.toLocaleString() + 'ƒë';
        document.getElementById('price-l').innerText = vL.toLocaleString() + 'ƒë'; 
        
        document.getElementById('btn-size-m').onclick = () => { addToCart(name, 'M', vM); closeSize(); };
        document.getElementById('btn-size-l').onclick = () => { addToCart(name, 'L', vL); closeSize(); }; 
        
        // --- S·ª¨A L·ªñI T·∫†I ƒê√ÇY: X√≥a class hidden ƒë·ªÉ popup hi·ªán l√™n ---
        var modal = document.getElementById('size-modal');
        modal.classList.remove('hidden');      // G·ª° b·ªè l·ªánh ·∫©n
        modal.classList.add('modal-active');   // K√≠ch ho·∫°t flexbox
        // -----------------------------------------------------------
        
    } else if (vM > 0) {
        addToCart(name, 'M', vM); 
    } else if (vL > 0) {
        addToCart(name, 'L', vL); 
    }
}

function closeSize() { 
    // --- S·ª¨A L·ªñI T·∫†I ƒê√ÇY: Th√™m l·∫°i class hidden ƒë·ªÉ ƒë√≥ng ---
    var modal = document.getElementById('size-modal');
    modal.classList.remove('modal-active');
    modal.classList.add('hidden');
    // ------------------------------------------------------
}

function addToCart(name, size, price) {
    const ex = cart.find(i => i.name === name && i.size === size);
    if (ex) ex.qty++; else cart.push({ name, size, price, qty: 1 });
    
    // 1. C·∫≠p nh·∫≠t giao di·ªán (Gi·ªù ƒë√£ an to√†n, kh√¥ng g√¢y crash)
    renderCart();
    
    // 2. B·∫Øt bu·ªôc ƒë√≥ng popup ch·ªçn size ngay l·∫≠p t·ª©c
    closeSize();
    updateCartPadding();
}

/* --- ƒê√É S·ª¨A: renderCart (T·ª± ƒë·ªông ·∫®n/Hi·ªán thanh Bar tr√™n Mobile) --- */
/* --- ƒê√É S·ª¨A: H√†m renderCart (Fix l·ªói Crash do thi·∫øu ID) --- */
// --- [FIXED] RENDER CART (C√ì LOGIC ƒê·ªîI M√ÄU N√öT BED) ---
// --- [FIXED] RENDER CART (C·∫¨P NH·∫¨T T·ªîNG TI·ªÄN M√ÄN H√åNH THANH TO√ÅN MOBILE) ---
// --- [FIXED SAFE] RENDER CART (C·∫¨P NH·∫¨T T·ªîNG TI·ªÄN MOBILE & AN TO√ÄN) ---
function renderCart() {
    try {
        const list = document.getElementById('cart-list');
        if (!list) return;

        currentTotal = 0;

        // 1. Render List M√≥n (Gi·ªØ nguy√™n logic c≈©)
        list.innerHTML = cart.map((i, idx) => {
            currentTotal += i.price * i.qty;
            return `<div class="bg-gray-50 p-2.5 rounded-xl flex justify-between items-center shadow-sm border border-white text-xs mb-1">
                <div class="flex-1 pr-2 text-left"><p class="font-black text-[#006241] truncate capitalize-first">${i.name} (${i.size})</p></div>
                <div class="flex items-center gap-1.5 bg-white p-1 rounded-lg border border-gray-100">
                    <button onclick="updateQty(${idx}, -1)" class="w-6 h-6 flex items-center justify-center font-black text-gray-300 text-lg ${isPaymentMode ? 'hidden': ''}">-</button>
                    <span class="font-black text-[#006241] text-[11px] w-5 text-center">${isPaymentMode?'x': ''}${i.qty}</span>
                    <button onclick="updateQty(${idx}, 1)" class="w-6 h-6 flex items-center justify-center font-black text-[#006241] text-lg ${isPaymentMode ? 'hidden' : ''}">+</button>
                </div>
            </div>`;
        }).join('');

        // 2. C·∫≠p nh·∫≠t T·ªïng ti·ªÅn Sidebar PC & Bottom Bar Mobile
        const pcTotal = document.getElementById('total-price');
        if(pcTotal) pcTotal.innerText = currentTotal.toLocaleString() + 'ƒë';
        
        const mobBarTotal = document.getElementById('mob-bar-total');
        if(mobBarTotal) mobBarTotal.innerText = currentTotal.toLocaleString() + 'ƒë';

        // 3. [FIX] C·∫≠p nh·∫≠t T·ªïng ti·ªÅn M√†n h√¨nh Thanh to√°n Mobile
        const payDisplay1 = document.getElementById('pay-total-display-1');
        if (payDisplay1) payDisplay1.innerText = currentTotal.toLocaleString();

        const payDisplay2 = document.getElementById('pay-total-display-2');
        if (payDisplay2) payDisplay2.innerText = currentTotal.toLocaleString();

        // 4. Logic ƒê·ªïi N√∫t Thanh To√°n Bed (Ki·ªÉm tra bi·∫øn an to√†n)
        // Ki·ªÉm tra bi·∫øn to√†n c·ª•c c√≥ t·ªìn t·∫°i kh√¥ng tr∆∞·ªõc khi d√πng
        let pOrder = (typeof pendingBedOrder !== 'undefined') ? pendingBedOrder : null;
        let aBedId = (typeof activeOrderingBedId !== 'undefined') ? activeOrderingBedId : null;
        const isBedOrder = (pOrder || aBedId);

        const payBtn = document.getElementById('sidebar-pay-btn');
        const mobPayBtn = document.querySelector('#mobile-bottom-bar button'); 

        const normalText = "Thanh to√°n";
        const bedText = "THANH TO√ÅN BED";
        const bedClassPC = "w-full py-4 btn-pay-bed font-black rounded-xl uppercase shadow-xl active:scale-95 transition-all tracking-widest";
        const normalClassPC = "w-full py-4 sb-green text-white font-black rounded-xl uppercase shadow-xl active:scale-95 transition-all";
        
        // PC Button
        if (payBtn) {
            if (isBedOrder) {
                payBtn.innerText = bedText;
                payBtn.className = bedClassPC;
            } else {
                payBtn.innerText = normalText;
                payBtn.className = normalClassPC;
            }
        }

        // Mobile Button
        if (mobPayBtn) {
            const spanText = mobPayBtn.querySelector('span'); 
            if (isBedOrder) {
                if(spanText) spanText.innerText = bedText;
                mobPayBtn.className = "h-full px-10 btn-pay-bed rounded-[2.5rem] font-bold uppercase text-xs shadow-lg active:scale-95 transition-all flex items-center gap-2";
            } else {
                if(spanText) spanText.innerText = normalText;
                mobPayBtn.className = "h-full px-10 bg-[#006241] text-white rounded-[2.5rem] font-bold uppercase text-xs shadow-lg active:scale-95 transition-all flex items-center gap-2 hover:bg-[#004f32]";
            }
        }

        updateSuggestions();
    } catch (e) {
        console.error("L·ªói renderCart:", e);
    }
}
function updateQty(idx, d) { 
    if(isPaymentMode) return; 
    cart[idx].qty += d; 
    if (cart[idx].qty <= 0) cart.splice(idx, 1); 
    renderCart(); 
}

// =========================================================
// 5. THANH TO√ÅN (PAYMENT)
// =========================================================
// --- H√ÄM THANH TO√ÅN (ƒê√É S·ª¨A: RESET S·∫†CH S·∫º TH√îNG TIN KH√ÅCH) ---
// --- H√ÄM THANH TO√ÅN (ƒê√É FIX L·ªñI RESET BI·∫æN TR∆Ø·ªöC KHI ƒê√ìNG BED) ---
function completeOrder_OLD() {
    if (cart.length === 0) return showAppModal("Hic!", "Ch∆∞a c√≥ m√≥n n√†o!", 'üõí');
    
    let pVal = document.getElementById('cash-paid').value;
    if (pVal === "" || pVal === "0") pVal = currentTotal;
    const paid = Number(pVal);
    if (paid < currentTotal) return alert("Ti·ªÅn kh√°ch ƒë∆∞a ch∆∞a ƒë·ªß!");

    document.getElementById('loading-overlay').style.display = 'flex';
    
    // === [FIX] B∆Ø·ªöC 1: L∆ØU L·∫†I ID BED C·∫¶N ƒê√ìNG NGAY L·∫¨P T·ª®C ===
    // Ph·∫£i l∆∞u v√†o bi·∫øn c·ª•c b·ªô ngay l√∫c n√†y, v√¨ l√°t n·ªØa pendingBedOrder s·∫Ω b·ªã reset v·ªÅ null
    var bookingKeyToClose = (pendingBedOrder) ? (pendingBedOrder.id || pendingBedOrder.key) : null;
    
    // L·∫•y th√¥ng tin Bed/Kh√°ch ƒë·ªÉ l∆∞u ƒë∆°n h√†ng
    var bedIdToSend = ""; 
    var custNameToSend = "Kh√°ch v√£ng lai";
    if (pendingBedOrder) { 
        bedIdToSend = pendingBedOrder.bedId || "WAITING"; 
        custNameToSend = pendingBedOrder.name; 
    } else if (activeOrderingBedId) { 
        bedIdToSend = activeOrderingBedId; 
    }

    const orderData = {
        sdt: document.getElementById('kh-sdt').value || "Kh√°ch v√£ng lai",
        total: currentTotal, 
        paid: paid, 
        change: Math.max(0, paid - currentTotal),
        method: document.getElementById('btn-bank').classList.contains('border-[#006241]') ? 'Chuy·ªÉn kho·∫£n' : 'Ti·ªÅn m·∫∑t',
        items: cart.map(i => `${i.name}(${i.size})x${i.qty}`).join(', '),
        itemsArray: cart,
        bedId: bedIdToSend, 
        customerName: custNameToSend,
        createdAt: new Date().toISOString(),
        status: "pending_sync"
    };

    // ƒê·∫©y ƒë∆°n h√†ng l√™n Firebase
    db.ref('orders').push(orderData, (error) => {
        document.getElementById('loading-overlay').style.display = 'none';
        
        if(error) alert("L·ªói Firebase: " + error.message);
        else {
            // === D·ªåN D·∫∏P GIAO DI·ªÜN ===
            document.getElementById('kh-sdt').value = ""; 
            document.getElementById('sdt-status').innerText = "";
            var cartInfo = document.getElementById('cart-bed-info');
            if (cartInfo) cartInfo.remove();

            // X√≥a gi·ªè h√†ng (ƒê√∫ng, v√¨ ƒë√£ thanh to√°n r·ªìi)
            cart = [];
            renderCart();

            // === [QUAN TR·ªåNG] LOGIC RESET BI·∫æN TH√îNG MINH ===
            // N·∫øu ƒë√¢y l√† ƒë∆°n "WAITING" (Ch·ªù x·∫øp bed), ta TUY·ªÜT ƒê·ªêI KH√îNG ƒê∆Ø·ª¢C RESET pendingBedOrder
            // V√¨ l√°t n·ªØa ch·ªçn Bed xong, h√†m finalizeBedCheckIn c·∫ßn d√πng bi·∫øn n√†y ƒë·ªÉ bi·∫øt update cho ai.
            
            if (bedIdToSend !== "WAITING") {
                // Ch·ªâ reset khi ƒë∆°n ƒë√£ xong h·∫≥n (Mang v·ªÅ, ho·∫∑c Order th√™m cho Bed ƒë√£ c√≥ s·ªë)
                pendingBedOrder = null;
                activeOrderingBedId = null;
            }

            // === ƒêI·ªÄU H∆Ø·ªöNG TI·∫æP THEO ===

            // 1. Tr∆∞·ªùng h·ª£p Tr·∫£ Bed (Checkout) -> ƒê√≥ng Bed ngay
            if (isCheckoutFlow && bookingKeyToClose) {
                console.log("ƒêang ƒë√≥ng Bed ID:", bookingKeyToClose);
                db.ref('bedBookings/' + bookingKeyToClose).update({
                    status: 'ƒë√£ xong',
                    realEndTime: new Date().toLocaleTimeString('en-GB')
                });
                isCheckoutFlow = false;
                pendingBedOrder = null; // Xong r·ªìi th√¨ reset ƒë∆∞·ª£c
                openBedManager();
                setTimeout(() => { showAppModal("Ho√†n t·∫•t!", "ƒê√£ thanh to√°n v√† TR·∫¢ BED th√†nh c√¥ng!", 'üèÅ'); }, 150);
            } 
            // 2. Tr∆∞·ªùng h·ª£p Kh√°ch m·ªõi (WAITING) -> M·ªü Modal ch·ªçn Bed
            else if (bedIdToSend == "WAITING") {
                 // Kh√¥ng reset pendingBedOrder ·ªü ƒë√¢y, ƒë·ªÉ d√†nh cho b∆∞·ªõc ch·ªçn Bed
                 renderBedSelection();
                 document.getElementById('bed-select-modal').classList.remove('hidden');
            } 
            // 3. Tr∆∞·ªùng h·ª£p Order th√™m / Mang v·ªÅ -> Xong phim
            else {
                switchView('menu');
                setTimeout(() => { showAppModal("Xong!", "Thanh to√°n th√†nh c√¥ng!", '‚úÖ'); }, 150);
            }
        }
    });
}

// C√°c h√†m b·ªï tr·ª£ thanh to√°n
// --- H√ÄM CH·ªåN PH∆Ø∆†NG TH·ª®C THANH TO√ÅN (ƒê√É FIX: L√ÄM M·ªú √î TI·ªÄN M·∫∂T KHI CK) ---
function setMethod(m) {
    const isBank = (m === 'Chuy·ªÉn kho·∫£n');
    
    // 1. C·∫≠p nh·∫≠t giao di·ªán n√∫t b·∫•m
    // N·∫øu l√† Bank: N√∫t Bank s√°ng, N√∫t Cash x√°m
    // N·∫øu l√† Cash: N√∫t Cash s√°ng, N√∫t Bank x√°m
    
    // Class cho n√∫t ƒëang Active (C√≥ vi·ªÅn xanh/ƒëen t√πy theme)
    const activeClass = "w-full p-6 rounded-3xl border-4 bg-white text-xl font-bold flex justify-between items-center shadow-md border-[#006241] text-[#006241] sb-green";
    
    // Class cho n√∫t Inactive (M·ªù, kh√¥ng vi·ªÅn)
    const inactiveClass = "w-full p-6 rounded-3xl border-4 border-transparent bg-white text-xl font-bold text-gray-300 flex justify-between items-center shadow-md";

    // C·∫≠p nh·∫≠t class cho 2 n√∫t
    document.getElementById('btn-cash').className = isBank ? inactiveClass : activeClass;
    document.getElementById('btn-bank').className = isBank ? activeClass : inactiveClass;

    // 2. X·ª¨ L√ù √î NH·∫¨P TI·ªÄN "KH√ÅCH ƒê∆ØA"
    const box = document.getElementById('cash-detail-box');
    const input = document.getElementById('cash-paid');

    // Lu√¥n reset gi√° tr·ªã v·ªÅ t·ªïng bill tr∆∞·ªõc ƒë√£
    input.value = currentTotal.toLocaleString('en-US'); 
    calcChange();;

    if (isBank) {
        // --- CH·∫æ ƒê·ªò CHUY·ªÇN KHO·∫¢N ---
        // G·ªçi h√†m hi·ªÉn th·ªã QR
        showPaymentQR(); 
        
        // V√¥ hi·ªáu h√≥a √¥ nh·∫≠p ti·ªÅn
        box.style.pointerEvents = "none";
        box.style.opacity = "0.4";
        box.style.filter = "grayscale(100%)";
    } else {
        // --- CH·∫æ ƒê·ªò TI·ªÄN M·∫∂T ---
        box.style.pointerEvents = "auto";
        box.style.opacity = "1";
        box.style.filter = "none";
        
        // ·∫®n Popup QR n·∫øu ƒëang m·ªü (tr∆∞·ªùng h·ª£p kh√°ch ƒë·ªïi √Ω)
        document.getElementById('qr-modal')?.classList.add('hidden');
    }
    calcChange();
}
// --- H√ÄM T·∫†O G·ª¢I √ù TI·ªÄN (CH·∫†Y C·∫¢ 2 GIAO DI·ªÜN) ---
// --- H√ÄM T·∫†O G·ª¢I √ù TI·ªÄN (CH·∫†Y C·∫¢ PC & MOBILE) ---
// --- H√ÄM V·∫º G·ª¢I √ù (STYLE N√öT TO - CHIA 2 C·ªòT) ---
// --- S·ª¨A H√ÄM G·ª¢I √ù (B·ªé N√öT TR√ôNG L·∫∂P & GI·ªÆ LAYOUT ƒê·∫∏P) ---
function updateSuggestions() {
    // Ch·ªâ l·∫•y c√°c m·ªánh gi√° L·ªöN H∆†N t·ªïng bill ƒë·ªÉ g·ª£i √Ω (50k, 100k, 200k, 500k)
    const vals = [50000, 100000, 200000, 500000].filter(v => v > currentTotal).slice(0, 4);
    
    // PC (Gi·ªØ nguy√™n)
    const pcContainer = document.getElementById('cash-suggestions');
    if (pcContainer) {
        pcContainer.innerHTML = vals.map(v => `<button onclick="quickPaid(${v})" class="bg-white border-2 border-gray-100 px-3 py-1.5 rounded-xl text-[10px] font-bold text-gray-400 hover:border-[#006241] hover:text-[#006241] transition-all">${v.toLocaleString()}</button>`).join('');
    }

    // MOBILE (N√∫t to b√©o - Chia l∆∞·ªõi)
    const mobContainer = document.getElementById('cash-suggestions-mobile');
    if (mobContainer) {
        mobContainer.innerHTML = vals.map(v => 
            `<button onclick="quickPaidMobile(${v})" 
                class="w-full py-4 bg-white text-[#006241] rounded-2xl text-lg font-black shadow-sm border border-gray-100 active:bg-[#006241] active:text-white active:scale-95 transition-all">
                ${(v/1000).toLocaleString()}k
            </button>`
        ).join('');
    }
}

// H√†m ki·ªÉm tra v√† c·∫≠p nh·∫≠t class cart-empty
function updateCartPadding() {
    // Kh√¥ng l√†m g√¨ c·∫£. Logic c≈© ƒë√£ b·ªã lo·∫°i b·ªè.
    return; 
}
// H√†m h·ªó tr·ª£ b·∫•m n√∫t tr√™n Mobile
// --- [M·ªöI] H√ÄM FORMAT S·ªê KHI NH·∫¨P (23000 -> 23,000) ---
function formatCashInput(input) {
    // 1. L·∫•y v·ªã tr√≠ con tr·ªè (ƒë·ªÉ kh√¥ng b·ªã nh·∫£y khi s·ª≠a gi·ªØa ch·ª´ng)
    let cursorPosition = input.selectionStart;
    
    // 2. L·∫•y gi√° tr·ªã th√¥ (ch·ªâ gi·ªØ l·∫°i s·ªë)
    let originalVal = input.value.replace(/\D/g, ''); 
    
    if (!originalVal) {
        input.value = "";
        return;
    }

    // 3. Format l·∫°i c√≥ d·∫•u ph·∫©y
    let formattedVal = Number(originalVal).toLocaleString('en-US');
    input.value = formattedVal;
    
    // (M·∫πo nh·ªè: Reset con tr·ªè v·ªÅ cu·ªëi n·∫øu ƒëang nh·∫≠p nhanh)
    // cursorPosition = input.value.length; 
    // input.setSelectionRange(cursorPosition, cursorPosition);
}

// --- S·ª¨A L·∫†I H√ÄM T√çNH TI·ªÄN TH·ª™A (ƒê·ªÇ HI·ªÇU D·∫§U PH·∫®Y) ---
function calcChange() { 
    // L·∫•y gi√° tr·ªã t·ª´ √¥ input, nh·ªõ X√ìA D·∫§U PH·∫®Y tr∆∞·ªõc khi chuy·ªÉn th√†nh s·ªë
    let rawVal = document.getElementById('cash-paid').value.replace(/,/g, '');
    const paid = Number(rawVal) || 0; 
    
    // N·∫øu √¥ tr·ªëng (paid = 0) th√¨ coi nh∆∞ kh√°ch ch∆∞a ƒë∆∞a, ti·ªÅn th·ª´a = 0 (ho·∫∑c √¢m)
    let change = paid - currentTotal;
    
    document.getElementById('cash-change').innerText = (change > 0 ? change.toLocaleString() : 0) + 'ƒë'; 
}

// --- S·ª¨A L·∫†I H√ÄM QUICK PAID (ƒê·ªÇ ƒêI·ªÄN C√ì D·∫§U PH·∫®Y) ---
function quickPaid(v) { 
    // ƒêi·ªÅn v√†o √¥ input v·ªõi format ƒë·∫πp
    document.getElementById('cash-paid').value = v.toLocaleString('en-US'); 
    calcChange(); 
}
function clearFullOrder() { if(pendingBedOrder) return alert("ƒêang trong quy tr√¨nh thanh to√°n Bed!"); cart = []; renderCart();updateCartPadding(); }

// =========================================================
// 6. L·ªäCH S·ª¨ & DOANH THU (ƒê√É S·ª¨A L·ªñI HI·ªÇN TH·ªä)
// =========================================================
function openHistory() {
    document.getElementById('loading-overlay').style.display = 'flex';
    switchView('history');
    
    // T√¨m c·∫£ 'orders' v√† 'order' ƒë·ªÅ ph√≤ng b·∫°n l∆∞u nh·∫ßm t√™n
    db.ref('orders').limitToLast(100).once('value', snap => {
        if(!snap.exists()) {
             // Th·ª≠ t√¨m nh√°nh 'order' n·∫øu 'orders' kh√¥ng c√≥
             db.ref('order').limitToLast(100).once('value', snap2 => {
                 processHistoryData(snap2.val());
             });
        } else {
             processHistoryData(snap.val());
        }
    });
}

function processHistoryData(data) {
    document.getElementById('loading-overlay').style.display = 'none';
    if(!data) {
        historyData = [];
        document.getElementById('history-container').innerHTML = "<div class='text-center text-gray-400 mt-10'>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</div>";
    } else {
        // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu
        historyData = Object.keys(data).map(key => {
            const o = data[key];
            const d = new Date(o.createdAt || Date.now());
            return {
                ...o,
                id: key,
                dateStr: d.toLocaleDateString('en-GB'),
                timeStr: d.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}),
                fullTime: d.toLocaleString('en-GB'),
                points: o.points || Math.floor((Number(o.total)||0)/100)
            };
        }).reverse();
        renderHistoryList(historyData);
    }
}

function renderHistoryList(data) { 
    if(!data || data.length === 0) return;

    // --- R·∫º NH√ÅNH MOBILE ---
    if (window.innerWidth <= 768) {
        renderHistoryMobile(data);
        return;
    }

    // --- LOGIC PC (GI·ªÆ NGUY√äN) ---
    const grouped = data.reduce((acc, obj) => { 
        const key = obj.dateStr; if (!acc[key]) acc[key] = []; acc [key].push(obj); return acc; 
    }, {}); 
    
    let html = ""; 
    Object.keys(grouped).sort((a,b) => {
         const da = a.split('/').reverse().join(''); const db = b.split('/').reverse().join(''); return db.localeCompare(da);
    }).forEach(date => { 
        html += `<div class="mb-4 text-left"><h3 class="brand-font text-[#006241] text-[10px] uppercase tracking-widest mb-2 ml-1 text-left">üìÖ Ng√†y ${date}</h3><div class="space-y-1.5 text-left">`; 
        grouped[date].forEach((h) => { 
            const realIdx = historyData.findIndex(item => item.id === h.id);
            const valColor = h.total < 0? 'text-red-500': 'text-[#006241]'; 
            html += `<div id="h-item-${realIdx}" onclick="selectBill(${realIdx})" class="p-3 bg-white rounded-2xl border-2 border-transparent shadow-sm flex justify-between items-center cursor-pointer active:scale-95 text-xs text-left">
                <div class="min-w-0 text-left">
                    <p class="font-black text-[#006241] uppercase text-left">${h.timeStr}</p>
                    <p class="text-[8px] text-gray-400 font-bold truncate w-20 text-left">${h.sdt}</p>
                </div>
                <p class="font-black ${valColor} text-right">${Number(h.total).toLocaleString()}</p>
            </div>`; 
        }); 
        html += '</div></div>'; 
    });
    document.getElementById('history-container').innerHTML = html; 
}
// --- 1. BI·∫æN TO√ÄN C·ª§C CHO SWIPE ---
let sheetStartY = 0;
let sheetCurrentY = 0;
let isSheetDragging = false;

// --- 2. H√ÄM HI·ªÜN CHI TI·∫æT (Logic m·ªõi) ---
// --- LOGIC HI·ªÇN TH·ªä CHI TI·∫æT (ƒê√É FIX: S·ªê L∆Ø·ª¢NG & KHO·∫¢NG C√ÅCH) ---
function showHistoryDetailMobile(idx) {
    const h = historyData[idx];
    if (!h) return;

    // A. ƒêi·ªÅn th√¥ng tin
    document.getElementById('detail-mob-time').innerText = h.timeStr + " - " + h.dateStr.slice(0,5); 
    document.getElementById('detail-mob-cust').innerText = h.sdt || 'V√£ng lai';
    document.getElementById('detail-mob-method').innerText = h.method;
    document.getElementById('detail-mob-total').innerText = Number(h.total).toLocaleString();
    
    // B. Render Danh s√°ch m√≥n
    const itemsContainer = document.getElementById('detail-mob-items-list');
    let itemsHtml = '';
    let totalQty = 0;
    
    const itemsArr = h.items.split(',');
    
    itemsArr.forEach((itemStr) => {
        const raw = itemStr.trim();
        const lastX = raw.lastIndexOf('x');
        
        if (lastX !== -1) {
            let namePart = raw.substring(0, lastX).trim();
            const qty = parseInt(raw.substring(lastX + 1)) || 1; // L·∫•y s·ªë l∆∞·ª£ng
            totalQty += qty;
            
            // T√°ch Size
            let finalName = namePart;
            let size = "";
            let unitPrice = 0;

            if(namePart.includes('(')) {
                let parts = namePart.split('(');
                finalName = parts[0].trim();
                size = parts[1].replace(')', '').trim();
            }

            // T√¨m gi√°
            const menuItem = menu.find(m => m.name.toLowerCase() === finalName.toLowerCase());
            if (menuItem) {
                if (size === 'L') unitPrice = menuItem.priceL;
                else unitPrice = menuItem.priceM || menuItem.priceL;
            }
            
            let displayPrice = (unitPrice * qty).toLocaleString();
            if(unitPrice === 0) displayPrice = "--"; // N·∫øu kh√¥ng t√¨m th·∫•y gi√°

            // --- HTML ITEM (FIXED) ---
            // 1. S·ªë l∆∞·ª£ng (qty) thay v√¨ s·ªë th·ª© t·ª±
            // 2. Class py-3 (gi·∫£m kho·∫£ng c√°ch)
            // 3. Text m√†u ƒë·∫≠m (text-gray-900)
            itemsHtml += `
            <div class="py-3 border-b border-dashed border-gray-100 flex justify-between items-start group">
                <div class="flex gap-3">
                    <div class="w-6 text-center pt-0.5">
                        <span class="text-[16px] font-black text-[#006B44]">${qty}</span>
                    </div>
                    
                    <div>
                        <h3 class="text-[15px] font-bold text-gray-900 leading-snug">
                            ${finalName}
                        </h3>
                        <div class="flex items-center gap-2 mt-1">
                            ${size ? `<span class="text-[10px] font-black text-[#006B44] bg-[#006B44]/10 px-1.5 py-[2px] rounded text-center min-w-[20px]">${size}</span>` : ''}
                            <span class="text-[12px] text-gray-400 font-bold tracking-wide">${unitPrice.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
                
                <span class="text-[15px] font-bold text-gray-900 tabular-nums tracking-tight">${displayPrice}</span>
            </div>`;
        }
    });
    
    itemsContainer.innerHTML = itemsHtml;
    document.getElementById('detail-item-count').innerText = `S·ªë l∆∞·ª£ng: ${totalQty} m√≥n`;

    // C. X·ª≠ l√Ω n√∫t H·ªßy
    const btnCancel = document.getElementById('btn-cancel-order-mobile');
    const totalText = document.getElementById('detail-mob-total');
    
    if(h.total < 0) {
        btnCancel.classList.add('hidden');
        totalText.parentElement.classList.add('text-red-500'); 
        totalText.parentElement.classList.remove('text-[#006B44]');
        document.getElementById('detail-mob-total').innerText = "ƒê√É H·ª¶Y";
    } else {
        btnCancel.classList.remove('hidden');
        totalText.parentElement.classList.remove('text-red-500');
        totalText.parentElement.classList.add('text-[#006B44]');
        
        btnCancel.onclick = function() {
            if(confirm("X√°c nh·∫≠n h·ªßy ƒë∆°n h√†ng n√†y?")) {
                executeRefundAction(idx, true);
                closeHistoryDetailMobile();
            }
        };
    }

    // D. M·ªü Sheet
    const sheet = document.getElementById('sheet-history-detail');
    const content = document.getElementById('sheet-content-main');
    sheet.classList.remove('hidden');
    requestAnimationFrame(() => {
        content.classList.remove('translate-y-full');
    });
    
    // K√≠ch ho·∫°t vu·ªët
    setupSwipeToDismiss(content);
}

// --- 3. H√ÄM ƒê√ìNG (Animation Slide Down) ---
function closeHistoryDetailMobile() {
    const sheet = document.getElementById('sheet-history-detail');
    const content = document.getElementById('sheet-content-main');
    
    content.style.transform = ''; // Reset inline style c·ªßa swipe
    content.classList.add('translate-y-full');
    
    setTimeout(() => {
        sheet.classList.add('hidden');
    }, 300);
}

// --- 4. H√ÄM VU·ªêT (SWIPE) ---
function setupSwipeToDismiss(element) {
    const scrollBody = document.getElementById('sheet-scroll-body');
    
    element.ontouchstart = (e) => {
        if (scrollBody.scrollTop > 0) { isSheetDragging = false; return; }
        isSheetDragging = true;
        sheetStartY = e.touches[0].clientY;
        element.style.transition = 'none'; 
    };

    element.ontouchmove = (e) => {
        if (!isSheetDragging) return;
        const currentY = e.touches[0].clientY;
        const deltaY = currentY - sheetStartY;
        if (deltaY > 0) {
            if (e.cancelable) e.preventDefault(); 
            element.style.transform = `translateY(${deltaY}px)`;
        }
    };

    element.ontouchend = (e) => {
        if (!isSheetDragging) return;
        isSheetDragging = false;
        element.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
        const deltaY = e.changedTouches[0].clientY - sheetStartY;
        if (deltaY > 150) closeHistoryDetailMobile();
        else element.style.transform = '';
    };
}

// --- H√ÄM X·ª¨ L√ù C·∫¢M ·ª®NG (CORE) ---
function setupSwipeToDismiss(element) {
    const scrollBody = document.getElementById('sheet-scroll-body');
    
    // 1. CH·∫†M V√ÄO (TOUCH START)
    element.ontouchstart = (e) => {
        // Ch·ªâ cho ph√©p k√©o n·∫øu danh s√°ch ƒëang ·ªü tr√™n c√πng (scrollTop = 0)
        // N·∫øu danh s√°ch ƒëang cu·ªôn ·ªü gi·ªØa, th√¨ ∆∞u ti√™n cu·ªôn danh s√°ch ch·ª© kh√¥ng k√©o sheet
        if (scrollBody.scrollTop > 0) {
            isSheetDragging = false;
            return;
        }

        isSheetDragging = true;
        sheetStartY = e.touches[0].clientY;
        element.style.transition = 'none'; // T·∫Øt animation ƒë·ªÉ k√©o cho m∆∞·ª£t (theo ng√≥n tay)
    };

    // 2. DI CHUY·ªÇN (TOUCH MOVE)
    element.ontouchmove = (e) => {
        if (!isSheetDragging) return;

        const currentY = e.touches[0].clientY;
        const deltaY = currentY - sheetStartY;

        // Ch·ªâ x·ª≠ l√Ω khi k√©o xu·ªëng (deltaY > 0)
        if (deltaY > 0) {
            // NgƒÉn ch·∫∑n cu·ªôn trang web g·ªëc (pull-to-refresh)
            if (e.cancelable) e.preventDefault(); 
            
            // Di chuy·ªÉn sheet theo ng√≥n tay
            element.style.transform = `translateY(${deltaY}px)`;
        }
    };

    // 3. TH·∫¢ TAY (TOUCH END)
    element.ontouchend = (e) => {
        if (!isSheetDragging) return;
        isSheetDragging = false;

        // B·∫≠t l·∫°i animation ƒë·ªÉ ƒë√≥ng ho·∫∑c b·∫≠t ng∆∞·ª£c l·∫°i
        element.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';

        const currentY = e.changedTouches[0].clientY;
        const deltaY = currentY - sheetStartY;

        // NG∆Ø·ª†NG ƒê√ìNG: N·∫øu k√©o xu·ªëng qu√° 150px -> ƒê√≥ng lu√¥n
        if (deltaY > 150) {
            closeHistoryDetailMobile();
        } else {
            // N·∫øu k√©o √≠t qu√° -> B·∫≠t ng∆∞·ª£c l·∫°i v·ªã tr√≠ c≈© (Reset)
            element.style.transform = '';
        }
    };
}

// --- H√ÄM SELECT BILL ƒê√É FIX (C√ì N√öT H·ª¶Y/HO√ÄN) ---
// --- COPY T·ª™ ƒê√ÇY ---
function selectBill(idx) {
    // 1. Reset highlight c≈©
    selectedRefundItems = [];
    document.querySelectorAll('[id^="h-item-"]').forEach(el => el.classList.remove('history-item-active'));
    
    // Highlight d√≤ng ƒë∆∞·ª£c ch·ªçn
    var rowEl = document.getElementById(`h-item-${idx}`);
    if (rowEl) rowEl.classList.add('history-item-active');

    // 2. L·∫•y d·ªØ li·ªáu ƒë∆°n h√†ng
    const h = historyData[idx];
    if (!h) return;

    const items = h.items.split(',');
    let tQty = 0;
    
    // Ki·ªÉm tra xem ƒë∆°n ƒë√£ ho√†n ch∆∞a (Ti·ªÅn √¢m = ƒë√£ ho√†n)
    const isAlreadyRefund = h.total < 0;

    // 3. X·ª≠ l√Ω danh s√°ch m√≥n ƒÉn
    // --- ƒê√ÇY L√Ä D√íNG B·∫†N ƒêANG B·ªä THI·∫æU ---
    const itemsHtml = items.map((item, i) => { 
    // -------------------------------------
        const raw = item.trim();
        const lastX = raw.lastIndexOf('x');
        if (lastX === -1) return '';

        const namePartFull = raw.substring(0, lastX).trim();
        const qty = parseInt(raw.substring(lastX + 1)) || 1;
        tQty += qty;

        let nameOnly = namePartFull, sizePart = "";
        if (namePartFull.includes('(')) {
            const lb = namePartFull.lastIndexOf('(');
            nameOnly = namePartFull.substring(0, lb).trim();
            sizePart = namePartFull.substring(lb + 1, namePartFull.lastIndexOf(')'));
        }

        const m = menu.find(mi => mi.name.toLowerCase() === nameOnly.toLowerCase());
        const uP = m ? (sizePart === 'L' ? m.priceL : m.priceM) : 0;
        const subTotal = uP * qty;
        
        // T√≠nh ƒëi·ªÉm
        const pts = (m && m.type === 'ƒÉn v·∫∑t') ? Math.floor((subTotal/100)*0.4) : Math.floor(subTotal/100);
        
        const itData = JSON.stringify({ name: nameOnly, size: sizePart, qty, subTotal, itemPoints: pts });

        // Render d√≤ng s·∫£n ph·∫©m
        return `<div id="refund-row-${i}" onclick='${isAlreadyRefund ? "" : `toggleRefundItem(${i}, ${itData})`}' class="receipt-line p-2 rounded-xl transition-all border-l-4 border-transparent ${isAlreadyRefund ? "opacity-50 text-left" : "cursor-pointer hover:bg-gray-50 text-left"}">
            <div class="flex-1 mr-4 text-left">
                <div class="flex items-start gap-2 text-left">
                    <span class="font-black text-[#006241] text-lg text-left">${qty}x</span>
                    <div class="flex flex-col text-left">
                        <span class="font-black text-[#006241] text-sm capitalize-first leading-tight text-left">${nameOnly} ${sizePart ? `<span class="text-green-500 font-black text-[12px] ml-1">[${sizePart}]</span>` : ""}</span>
                        <span class="text-[9px] text-gray-400 font-bold italic text-left">ƒê∆°n gi√°: ${uP.toLocaleString()}</span>
                    </div>
                </div>
            </div>
            <div class="text-right font-black text-[#006241] text-base pt-1 text-right">${subTotal.toLocaleString()}</div>
        </div>`;
    }).join(''); // <--- D·∫•u } n√†y b√¢y gi·ªù s·∫Ω kh·ªõp v·ªõi d·∫•u { ·ªü d√≤ng items.map b√™n tr√™n

    // 4. Hi·ªÉn th·ªã Panel Chi ti·∫øt
    document.getElementById('history-detail-empty').classList.add('hidden');
    const detail = document.getElementById('history-detail-content');
    detail.classList.remove('hidden');

    // 5. V·∫º GIAO DI·ªÜN CHI TI·∫æT
    detail.innerHTML = `
    <div class="grid grid-cols-12 gap-3 h-full overflow-hidden text-left relative">
        
        <button onclick="switchView('menu')" class="absolute top-0 right-0 z-50 w-8 h-8 bg-gray-100 hover:bg-gray-200 text-gray-500 rounded-full flex items-center justify-center font-bold shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
        <div class="col-span-4 border-r border-gray-100 pr-3 flex flex-col pt-2 text-left">
            <h3 class="brand-font text-3xl text-[#006241] leading-none mb-1 text-left">The cafe 33</h3>
            <p class="text-[8px] text-gray-400 font-bold uppercase mb-4 tracking-widest text-left">H√≥a ƒë∆°n ƒëi·ªán t·ª≠</p>

            <div class="space-y-2 text-left">
                <div class="p-2 bg-gray-50 rounded-xl text-left"><p class="text-[8px] text-gray-400 font-bold uppercase mb-0.5 text-left">Th·ªùi gian</p><p class="font-black text-[#006241] text-[10px] leading-tight text-left">${h.fullTime}</p></div>
                <div class="p-2 bg-gray-50 rounded-xl text-left"><p class="text-[8px] text-gray-400 font-bold uppercase mb-0.5 text-left">Kh√°ch h√†ng</p><p class="font-black text-[#006241] text-[10px] leading-tight text-left">${h.sdt}</p></div>
                <div class="p-2 bg-gray-50 rounded-xl border-l-4 ${h.total < 0 ? 'border-red-500 text-left' : 'border-[#006241] text-left'} text-left"><p class="text-[8px] text-gray-400 font-bold uppercase mb-0.5 text-left">Thanh to√°n</p><p class="font-black ${h.total < 0 ? 'text-red-500 text-left' : 'text-[#006241] text-left'} text-[10px] uppercase text-left">${h.method}</p></div>
            </div>

            ${isAlreadyRefund ?
                '<div class="mt-10 text-center"><p class="text-[10px] font-black text-red-400 uppercase italic text-center">H√≥a ƒë∆°n ho√†n tr·∫£</p></div>' :
                `<div class="mt-4 space-y-2 text-center">
                    <button onclick="executeRefundAction(${idx}, true)" class="w-full py-3 bg-red-500 text-white rounded-xl font-black text-[10px] uppercase shadow-lg active:scale-95 transition-all text-center">H·ªßy to√†n b·ªô</button>
                    <button id="btn-refund-selected" onclick="executeRefundAction(${idx}, false)" class="hidden w-full py-3 border-2 border-red-500 text-red-500 rounded-xl font-black text-[10px] uppercase active:scale-95 transition-all text-center">Ho√†n m√≥n ƒë√£ ch·ªçn</button>
                </div>`
            }

            ${h.sdt === "Kh√°ch v√£ng lai" ? "" : 
`<div class="mt-auto mb-2 text-center text-center"><p class="text-amber-600 font-black text-[9px] uppercase italic tracking-tighter text-center"> +${h.points} ƒêI·ªÇM</p></div>`
}
        </div>

        <div class="col-span-8 flex flex-col h-full pt-2 overflow-hidden text-left">
            <div id="refund-items-list" class="flex-1 overflow-y-auto pr-1 space-y-0.5 text-left">${itemsHtml}</div>
            <div class="mt-4 pt-4 border-t-2 border-[#006241] flex flex-col items-end flex-shrink-0 text-right">
                <div class="flex justify-between w-full items-center mb-1 text-left"><span class="text-[10px] font-bold text-gray-400 uppercase italic text-left">S·ªë l∆∞·ª£ng: ${tQty} m√≥n</span><span class="brand-font text-[#006241] text-xl uppercase font-black opacity-30 text-right">T·ªïng bill</span></div>
                <div class="font-black text-3xl leading-none text-right ${h.total < 0 ? 'text-red-500 text-right' : 'text-[#006241] text-right'}">${h.total.toLocaleString()}<span class="text-lg ml-1 text-right">ƒë</span></div>
            </div>
        </div>
    </div>`;
}
// --- ƒê·∫æN ƒê√ÇY ---

// --- H√ÄM M·ªû TAB DOANH THU (PHI√äN B·∫¢N AN TO√ÄN) ---
// --- H√ÄM M·ªû TAB DOANH THU (KH√îNG NH√ÅY M√ÄN H√åNH TR·∫ÆNG) ---
function openRevenue(mode) {
    if (!mode) mode = 'week';

    // 1. KI·ªÇM TRA XEM ƒêANG ·ªû ƒê√ÇU
    // N·∫øu tab view-history ƒëang hi·ªán V√Ä n√∫t revenue ƒëang active -> T·ª©c l√† ƒëang chuy·ªÉn ch·∫ø ƒë·ªô
    var isSwitchingMode = !document.getElementById('view-history').classList.contains('hidden') && 
                          document.getElementById('btn-nav-revenue').classList.contains('tab-active');

    if (isSwitchingMode) {
        // --- CH·∫æ ƒê·ªò CHUY·ªÇN TAB (KH√îNG NH√ÅY) ---
        // Hi·ªán v√≤ng xoay nh·ªè
        var miniLoader = document.getElementById('mini-loader');
        if (miniLoader) miniLoader.classList.remove('hidden');
        
        // L√†m m·ªù nh·∫π n·ªôi dung ƒë·ªÉ bi·∫øt ƒëang load
        var content = document.getElementById('history-detail-content');
        if (content) {
            content.style.opacity = "0.6";
            content.style.pointerEvents = "none"; // Ch·∫∑n b·∫•m lung tung khi ƒëang load
        }
    } else {
        // --- CH·∫æ ƒê·ªò M·ªû L·∫¶N ƒê·∫¶U (HI·ªÜN LOADING TO) ---
        document.getElementById('loading-overlay').style.display = 'flex';
        switchView('revenue');
    }

    // L·∫•y ng√†y custom
    var startEl = document.getElementById('rev-start');
    var endEl = document.getElementById('rev-end');
    var startVal = startEl ? startEl.value : null;
    var endVal = endEl ? endEl.value : null;

    Promise.all([
        db.ref('orders').once('value'),
        db.ref('order').once('value')
    ]).then(function(snapshots) {
        
        // T·∫Øt Loading to (n·∫øu c√≥)
        document.getElementById('loading-overlay').style.display = 'none';
        
        try {
            var allOrders = [];
            snapshots.forEach(function(snap) {
                if(snap.exists()) {
                    var val = snap.val();
                    if (val) {
                        Object.keys(val).forEach(function(k) {
                            allOrders.push(val[k]);
                        });
                    }
                }
            });

            var stats = calculateStats(allOrders, mode, startVal, endVal);
            
            if (stats) {
                renderDailyRevenueList(stats.dailyList);
                renderRevenueDashboard(stats, mode); // H√†m n√†y s·∫Ω t·ª± t·∫Øt mini-loader v√† b·ªè l√†m m·ªù
            }
        } catch (e) {
            alert("L·ªói: " + e.message);
            // N·∫øu l·ªói c≈©ng ph·∫£i nh·ªõ t·∫Øt hi·ªáu ·ª©ng l√†m m·ªù
            var content = document.getElementById('history-detail-content');
            if (content) { content.style.opacity = "1"; content.style.pointerEvents = "auto"; }
        }
    });
}
// --- H√ÄM T√çNH TO√ÅN (PHI√äN B·∫¢N FIX L·ªñI CRASH) ---
function calculateStats(orders, mode, customStart, customEnd) {
    var now = new Date();
    var startTime, endTime;
    var labels = [];
    var chartData = [];
    var groupType = 'day'; 

    // 1. THI·∫æT L·∫¨P TH·ªúI GIAN
    if (mode === 'week') {
        var day = now.getDay() || 7; 
        startTime = new Date(now); startTime.setDate(now.getDate() - day + 1); startTime.setHours(0,0,0,0);
        endTime = new Date(startTime); endTime.setDate(startTime.getDate() + 6); endTime.setHours(23,59,59,999);
        labels = ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'];
        chartData = [0,0,0,0,0,0,0];
    } 
    else if (mode === 'month') {
        startTime = new Date(now.getFullYear(), now.getMonth(), 1);
        endTime = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
        
        // T·∫°o nh√£n ng√†y 1 -> 31 b·∫±ng v√≤ng l·∫∑p th·ªß c√¥ng (An to√†n h∆°n Array.from)
        var daysInMonth = endTime.getDate();
        for (var i = 1; i <= daysInMonth; i++) {
            labels.push(i.toString());
            chartData.push(0);
        }
    } 
    else if (mode === 'year') {
        startTime = new Date(now.getFullYear(), 0, 1);
        endTime = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
        labels = ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'];
        chartData = [0,0,0,0,0,0,0,0,0,0,0,0];
        groupType = 'month';
    } 
    else if (mode === 'custom') {
        if (!customStart || !customEnd) return null;
        startTime = new Date(customStart); startTime.setHours(0,0,0,0);
        endTime = new Date(customEnd); endTime.setHours(23,59,59,999);
        
        var diffTime = Math.abs(endTime - startTime);
        var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        
        if (diffDays > 31) {
            groupType = 'month';
            labels = ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12']; 
            chartData = [0,0,0,0,0,0,0,0,0,0,0,0];
        } else {
            for (var j = 0; j <= diffDays; j++) {
                var dTemp = new Date(startTime); dTemp.setDate(dTemp.getDate() + j);
                labels.push(dTemp.getDate() + "/" + (dTemp.getMonth()+1));
                chartData.push(0);
            }
        }
    }

    var stats = { drinkTotal: 0, snackTotal: 0, labels: labels, chartData: chartData, dailyList: {}, today: 0, yesterday: 0 };
    
    var todayStr = now.toLocaleDateString('en-GB');
    var yest = new Date(now); yest.setDate(now.getDate() - 1); 
    var yestStr = yest.toLocaleDateString('en-GB');

    // 2. DUY·ªÜT ƒê∆†N H√ÄNG
    orders.forEach(function(o) {
        var d = new Date(o.createdAt || Date.now());
        var dateKey = d.toLocaleDateString('en-GB');
        var amount = Number(o.total) || 0;
        if (amount <= 0) return;

        if (dateKey === todayStr) stats.today += amount;
        if (dateKey === yestStr) stats.yesterday += amount;

        if (d >= startTime && d <= endTime) {
            var itemsStr = String(o.items || "").toLowerCase();
            var isSnack = (itemsStr.indexOf('h·∫°t') > -1 || itemsStr.indexOf('b√°nh') > -1 || itemsStr.indexOf('snack') > -1);
            
            if(isSnack) stats.snackTotal += amount; 
            else stats.drinkTotal += amount;
            
            if (!stats.dailyList[dateKey]) stats.dailyList[dateKey] = { drink: 0 };
            stats.dailyList[dateKey].drink += amount;

            // C·ªông d·ªìn v√†o bi·ªÉu ƒë·ªì
            var idx = -1;
            if (groupType === 'month') {
                idx = d.getMonth();
            } else if (mode === 'month') {
                idx = d.getDate() - 1;
            } else if (mode === 'week') {
                idx = (d.getDay() + 6) % 7;
            } else if (mode === 'custom' && labels.length <= 31) {
                // Logic ƒë∆°n gi·∫£n cho custom ng·∫Øn ng√†y
                var timeDiff = d.getTime() - startTime.getTime();
                var dayDiff = Math.floor(timeDiff / (1000 * 3600 * 24));
                idx = dayDiff;
            }

            if (idx >= 0 && idx < chartData.length) {
                chartData[idx] += amount;
            }
        }
    });
    return stats;
}

function renderDailyRevenueList(list) { 
    let html = '<div class="mb-4 text-left"><h3 class="brand-font text-[#006241] text-[10px] uppercase tracking-widest mb-2 ml-1 text-left">Doanh thu</h3><div class="space-y-1.5 text-left">'; 
    Object.keys(list).sort((a,b) => { const da = a.split('/').reverse().join(''); const db = b.split('/').reverse().join(''); return db.localeCompare(da); }).forEach(date => { 
        html += `<div class="p-3 bg-white rounded-2xl shadow-sm text-left"><p class="font-black text-[#006241] text-[10px] uppercase text-left">üìÖ ${date}</p><p class="text-[11px] font-black text-[#006241] mt-1 text-left">${list[date].drink.toLocaleString()}ƒë</p></div>`; 
    }); 
    html += '</div></div>'; 
    document.getElementById('history-container').innerHTML = html; 
}

// --- H√ÄM V·∫º DASHBOARD DOANH THU (STYLE APPLE: S√ÅNG, S·∫†CH, XANH TH∆Ø∆†NG HI·ªÜU) ---
// --- H√ÄM V·∫º DASHBOARD (C√ì TH√äM V√íNG XOAY LOADING NH·ªé) ---
// --- H√ÄM V·∫º DASHBOARD (N√öT X N·∫∞M CHUNG THANH C√îNG C·ª§ - SI√äU G·ªåN) ---
// --- H√ÄM V·∫º DASHBOARD (STYLE "FLOATING PILLS" - SI√äU SANG & BO TR√íN) ---
// --- H√ÄM V·∫º DASHBOARD (STYLE VI√äN THU·ªêC - 1 H√ÄNG NGANG TI·∫æT KI·ªÜM KH√îNG GIAN) ---
function renderRevenueDashboard(data, mode) {
    document.getElementById('history-detail-empty').classList.add('hidden');
    const detail = document.getElementById('history-detail-content');
    detail.classList.remove('hidden');
    
    // Reset hi·ªáu ·ª©ng load
    detail.style.opacity = "1";
    detail.style.pointerEvents = "auto";

    const diff = data.today - data.yesterday;
    const dColor = diff >= 0 ? 'text-green-500': 'text-red-500';
    const dIcon = diff >= 0 ? '‚ñ≤': '‚ñº';

    // Style n√∫t b·∫•m (Bo tr√≤n vi√™n thu·ªëc)
    const activeBtn = "bg-[#006241] text-white shadow-md font-bold rounded-full transform scale-105";
    const inactiveBtn = "bg-transparent text-gray-500 hover:bg-gray-100 font-medium rounded-full";

    detail.innerHTML = `
    <div class="flex flex-col h-full space-y-4 text-left pt-2 px-1">
        
        <div class="flex flex-row items-center justify-between gap-2 z-10 relative">
            
            <div class="flex bg-white p-1 rounded-full shadow-[0_2px_10px_rgba(0,0,0,0.05)] border border-gray-100 shrink-0">
                <button onclick="openRevenue('week')" class="px-5 py-2 text-[10px] uppercase transition-all duration-300 ${mode==='week'?activeBtn:inactiveBtn}">Tu·∫ßn</button>
                <button onclick="openRevenue('month')" class="px-5 py-2 text-[10px] uppercase transition-all duration-300 ${mode==='month'?activeBtn:inactiveBtn}">Th√°ng</button>
                <button onclick="openRevenue('year')" class="px-5 py-2 text-[10px] uppercase transition-all duration-300 ${mode==='year'?activeBtn:inactiveBtn}">NƒÉm</button>
            </div>
            
            <div class="flex items-center gap-2 bg-white p-1 pl-3 rounded-full shadow-[0_2px_10px_rgba(0,0,0,0.05)] border border-gray-100 shrink-0">
                
                <div id="mini-loader" class="hidden animate-spin rounded-full h-3 w-3 border-[2px] border-t-[#006241] border-gray-100 mr-1"></div>

                <div class="flex items-center gap-1 border-r border-gray-100 pr-2 mr-1">
                    <input type="date" id="rev-start" class="text-[10px] font-bold text-[#006241] outline-none bg-transparent w-[70px] uppercase cursor-pointer">
                    <span class="text-gray-300 font-light">-</span>
                    <input type="date" id="rev-end" class="text-[10px] font-bold text-[#006241] outline-none bg-transparent w-[70px] uppercase cursor-pointer">
                </div>

                <button onclick="openRevenue('custom')" class="w-8 h-8 bg-[#006241] text-white rounded-full flex items-center justify-center shadow-md hover:scale-105 active:scale-95 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </button>

                <button onclick="switchView('menu')" class="w-8 h-8 bg-gray-100 hover:bg-red-50 text-gray-500 hover:text-red-500 rounded-full flex items-center justify-center transition-all hover:scale-105 active:scale-95 ml-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-3 text-left z-0 relative">
            <div class="p-4 bg-white rounded-[24px] border border-gray-50 shadow-[0_4px_15px_rgba(0,0,0,0.02)] flex flex-col items-center justify-center">
                <p class="text-[8px] font-bold text-gray-400 uppercase tracking-widest mb-1">T·ªïng thu</p>
                <p class="brand-font text-xl text-[#006241]">${(data.drinkTotal + data.snackTotal).toLocaleString()}</p>
            </div>
            <div class="p-4 bg-white rounded-[24px] border border-gray-50 shadow-[0_4px_15px_rgba(0,0,0,0.02)] flex flex-col items-center justify-center">
                <p class="text-[8px] font-bold text-gray-400 uppercase tracking-widest mb-1">ƒÇn v·∫∑t</p>
                <p class="brand-font text-xl text-amber-500">${data.snackTotal.toLocaleString()}</p>
            </div>
            <div class="p-4 bg-white rounded-[24px] border border-gray-50 shadow-[0_4px_15px_rgba(0,0,0,0.02)] flex flex-col items-center justify-center">
                <p class="text-[8px] font-bold text-gray-400 uppercase tracking-widest mb-1">So h√¥m qua</p>
                <div class="flex items-center gap-1 bg-gray-50 px-2 py-0.5 rounded-full mt-1">
                    <span class="text-[10px] ${dColor}">${dIcon}</span>
                    <span class="font-black text-xs ${dColor}">${Math.abs(diff).toLocaleString()}</span>
                </div>
            </div>
        </div>

        <div class="flex-1 bg-white p-5 rounded-[2.5rem] border border-gray-50 shadow-sm flex flex-col relative overflow-hidden z-0">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>`;

    setTimeout(() => {
        renderChart(data.labels, data.chartData, mode);
    }, 200);
}
function renderChart(labels, chartData, type) { 
    const ctx = document.getElementById('revenueChart').getContext('2d'); 
    if (myChart) myChart.destroy(); 
    myChart = new Chart(ctx, { 
        type: 'bar', plugins: [ChartDataLabels], 
        data: { labels, datasets: [{ data: chartData, backgroundColor: '#006241', borderRadius: 6 }] }, 
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top', formatter: (v) => v != 0 ? (v/1000).toFixed(0) + 'k': '', font: { weight: 'bold', size: 9 }, color: '#006241'} }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { weight: 'bold', size: 8} } } } } 
    }); 
}

// =========================================================
// 7. C√ÅC H√ÄM KH√ÅC (NAV, SWITCH VIEW...)
// =========================================================
// --- H√ÄM CHUY·ªÇN VIEW (C·∫¨P NH·∫¨T LOGIC LUXURY THEME) ---
// --- H√ÄM CHUY·ªÇN VIEW (ƒê√É FIX: ·∫®N N√öT 'THANH TO√ÅN' ·ªû SIDEBAR KHI ƒêANG THANH TO√ÅN) ---
/* --- ƒê√É S·ª¨A: H√†m switchView Logic ch·∫∑t ch·∫Ω --- */
/* --- ƒê√É S·ª¨A: H√†m switchView (Logic ·∫©n/hi·ªán chu·∫©n x√°c cho Mobile) --- */
/* --- ƒê√É S·ª¨A: switchView (Ch·∫∑n thanh Bar ƒëi lung tung) --- */
// --- H√ÄM CHUY·ªÇN VIEW (ƒê√É FIX L·ªñI CRASH NULL PROPERTY) ---
// --- H√ÄM CHUY·ªÇN VIEW (ƒê√É FIX TO√ÄN DI·ªÜN L·ªñI NULL) ---
// =========================================================
// [FIX FINAL] H√ÄM CHUY·ªÇN VIEW (ƒê√É FIX L·ªñI ƒê√à GIAO DI·ªÜN)
// =========================================================
function switchView(v) {
    // 1. ·∫®n ngay giao di·ªán L·ªãch s·ª≠ Mobile tr∆∞·ªõc khi l√†m g√¨ kh√°c
    var histMob = document.getElementById('view-history-mobile');
    if (histMob) histMob.classList.add('hidden');

    isPaymentMode = (v === 'payment');
    var isMobile = window.innerWidth <= 768;

    // --- 2. QU·∫¢N L√ù BOTTOM BAR (LOGIC T·ªêI ∆ØU) ---
    var mobBar = document.getElementById('mobile-bottom-bar');
    if (mobBar) {
        if (v === 'menu') {
            mobBar.classList.remove('hidden');
            mobBar.classList.add('flex');
        } else {
            mobBar.classList.add('hidden');
            mobBar.classList.remove('flex');
        }
    }

    // --- 3. D·ªåN D·∫∏P C√ÅC VIEW MOBILE ƒê·∫∂C BI·ªÜT ---
    var bedMob = document.getElementById('view-bed-mobile');
    if(bedMob) bedMob.classList.add('hidden');
    
    var revMob = document.getElementById('view-revenue-mobile');
    if(revMob) revMob.classList.add('hidden');

    // --- 4. X·ª¨ L√ù RI√äNG TAB BED TR√äN MOBILE ---
    if (v === 'bed' && isMobile) {
        openBedManagerMobile(); 
        return; 
    }

    // --- 5. ·∫®N T·∫§T C·∫¢ VIEW CH√çNH & RESET NAV BUTTON PC ---
    ['menu', 'payment', 'history', 'bed', 'revenue'].forEach(id => {
        var viewEl = document.getElementById('view-' + id);
        if (viewEl) viewEl.classList.add('hidden');

        var btn = document.getElementById('btn-nav-' + id);
        if (btn) {
            btn.classList.remove('tab-active', 'sb-green', 'text-white');
            btn.className = 'bg-gray-100 text-gray-400 px-5 py-2.5 rounded-xl text-[10px] font-black uppercase active:scale-95 transition-all';
        }
    });

    // --- 6. HI·ªÜN VIEW M·ª§C TI√äU ---
    
    // -> LOGIC DOANH THU
    if (v === 'revenue') {
        if (isMobile) {
            openRevenueMobile(); 
            return; 
        } else {
            document.getElementById('view-history').classList.remove('hidden');
            let btn = document.getElementById('btn-nav-revenue');
            if(btn) btn.className = 'sb-green text-white px-5 py-2.5 rounded-xl text-[10px] font-black uppercase tab-active';
        }
    } 
    // -> LOGIC L·ªäCH S·ª¨ (ƒê√É C·∫¨P NH·∫¨T)
    else if (v === 'history') {
        if (isMobile) {
            // Mobile: Hi·ªán view mobile nh∆∞ng KH√îNG ƒë∆∞·ª£c ·∫©n Header cha
            if(histMob) {
                histMob.classList.remove('hidden');
                // ƒê·∫£m b·∫£o container ch√≠nh v·∫´n hi·ªán ƒë·ªÉ Header kh√¥ng m·∫•t
                document.getElementById('view-menu').classList.add('hidden'); 
            }
        } else {
            // PC: Hi·ªán giao di·ªán c≈© & Active n√∫t
            document.getElementById('view-history').classList.remove('hidden');
            let btn = document.getElementById('btn-nav-history');
            if(btn) btn.className = 'sb-green text-white px-5 py-2.5 rounded-xl text-[10px] font-black uppercase tab-active';
        }
    }
    // -> LOGIC BED (PC)
    else if (v === 'bed') {
        document.getElementById('view-bed').classList.remove('hidden');
        let btn = document.getElementById('btn-nav-bed');
        if(btn) btn.className = 'sb-green text-white px-5 py-2.5 rounded-xl text-[10px] font-black uppercase tab-active';
    }
    // -> C√ÅC VIEW KH√ÅC (Menu, Payment)
    else {
        var viewTarget = document.getElementById('view-' + v);
        if (viewTarget) viewTarget.classList.remove('hidden');
    }

    // --- 7. SIDEBAR & CATEGORY BAR ---
   // --- 7. SIDEBAR & CATEGORY BAR (ƒê√É FIX L·ªñI ƒê√à GIAO DI·ªÜN) ---
    var sidebarCart = document.getElementById('sidebar-cart');
    
    if (sidebarCart) {
        if (window.innerWidth <= 768) {
            // === MOBILE: LU√îN ·∫®N SIDEBAR PC ===
            sidebarCart.classList.add('hidden'); 
            sidebarCart.style.display = 'none'; // Th√™m d√≤ng n√†y cho ch·∫Øc ch·∫Øn
        } else {
            // === PC: CH·ªà HI·ªÜN ·ªû MENU & PAYMENT ===
            sidebarCart.style.display = ''; // Reset style inline n·∫øu c√≥
            if (v === 'menu' || v === 'payment') {
                sidebarCart.classList.remove('hidden');
            } else {
                sidebarCart.classList.add('hidden');
            }
        }
    }

    var catBar = document.getElementById('category-bar');
    if (catBar) catBar.classList.toggle('hidden', v !== 'menu');
    
    // Reset inputs payment n·∫øu v√†o trang payment
    if (v === 'payment') {
        var mobStep1 = document.getElementById('mob-step-1');
        var mobStep2 = document.getElementById('mob-step-2');
        if (mobStep1) mobStep1.classList.remove('hidden');
        if (mobStep2) mobStep2.classList.add('hidden');
        
        // --- [FIX QUAN TR·ªåNG] T·ª∞ ƒêI·ªÄN SƒêT KH√ÅCH BED ---
        if (pendingBedOrder && pendingBedOrder.phone) {
            // ƒêi·ªÅn cho Mobile
            var mobInput = document.getElementById('pay-sdt-mobile');
            if(mobInput) mobInput.value = pendingBedOrder.phone;
            
            // ƒêi·ªÅn cho PC (N·∫øu c·∫ßn, th∆∞·ªùng PC d√πng chung kh-sdt)
            // L∆∞u √Ω: kh-sdt ƒë√£ ƒë∆∞·ª£c ƒëi·ªÅn ·ªü b∆∞·ªõc showBedDetail r·ªìi
        }
        // ---------------------------------------------

        if (typeof syncMobileInputs === 'function') syncMobileInputs();
        if (typeof setMethod === 'function') setMethod('Ti·ªÅn m·∫∑t');
    }
}
// Bed Functions
// --- H√ÄM OPEN BED MANAGER (ƒê√É S·ª¨A L·ªñI NG√ÄY GI·ªú) ---
// =========================================================
// QU·∫¢N L√ù BED & L·ªäCH (ƒê√É N√ÇNG C·∫§P: CH·ªåN NG√ÄY)
// =========================================================

// Bi·∫øn l∆∞u tr·ªØ to√†n b·ªô l·ªãch (ƒë·ªÉ kh√¥ng ph·∫£i t·∫£i l·∫°i khi ƒë·ªïi ng√†y)
var globalAllBookings = []; 
var currentFilterDateStr = ""; // L∆∞u ng√†y ƒëang ch·ªçn (d·∫°ng dd/mm/yyyy)

function openBedManager() {
    document.getElementById('loading-overlay').style.display = 'flex';
    switchView('bed');
    
    // 1. M·∫∑c ƒë·ªãnh ch·ªçn ng√†y h√¥m nay
    const today = new Date();
    // Format yyyy-mm-dd cho √¥ input
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const todayInputFormat = `${yyyy}-${mm}-${dd}`;
    
    // Set gi√° tr·ªã cho √¥ ch·ªçn ng√†y
    const picker = document.getElementById('date-picker-btn');
    if(picker) picker.value = todayInputFormat;
    
    // 2. T·∫£i d·ªØ li·ªáu t·ª´ Firebase
    db.ref('bedBookings').on('value', snap => {
        const data = snap.val() || {};
        
        // Chu·∫©n h√≥a d·ªØ li·ªáu th√¥
        globalAllBookings = Object.keys(data).map(k => {
            const item = data[k];
            
            // X·ª≠ l√Ω ng√†y: Chuy·ªÉn h·∫øt v·ªÅ d·∫°ng dd/mm/yyyy ƒë·ªÉ so s√°nh
            let rawDate = item.date || item.bookingDate || "";
            // N·∫øu l√† yyyy-mm-dd (2026-01-23) -> ƒë·ªïi th√†nh 23/01/2026
            if (rawDate.includes('-') && rawDate.split('-')[0].length === 4) {
                const p = rawDate.split('-'); 
                rawDate = `${p[2]}/${p[1]}/${p[0]}`;
            }

            return {
                id: k,
                ...item,
                start: item.start || item.startTime || "--:--", 
                end: item.end || item.endTime || "--:--",
                displayDate: rawDate 
            };
        });

        document.getElementById('loading-overlay').style.display = 'none';
        
        // 3. G·ªçi h√†m l·ªçc theo ng√†y hi·ªán t·∫°i c·ªßa √¥ input
        changeBedDate(picker ? picker.value : todayInputFormat);
    });
}

// H√†m x·ª≠ l√Ω khi b√† b·∫•m ch·ªçn ng√†y kh√°c
function changeBedDate(dateInputValue) {
    if (!dateInputValue) return;

    // dateInputValue ƒëang l√†: 2026-01-25 (yyyy-mm-dd)
    // C·∫ßn ƒë·ªïi sang: 25/01/2026 (dd/mm/yyyy) ƒë·ªÉ kh·ªõp v·ªõi d·ªØ li·ªáu
    const parts = dateInputValue.split('-');
    const targetDateStr = `${parts[2]}/${parts[1]}/${parts[0]}`;
    
    currentFilterDateStr = targetDateStr; // L∆∞u l·∫°i ƒë·ªÉ d√πng n·∫øu c·∫ßn

    console.log("üìÖ ƒêang xem l·ªãch ng√†y:", targetDateStr);

    // L·ªçc danh s√°ch t·ª´ kho d·ªØ li·ªáu ƒë√£ t·∫£i (globalAllBookings)
    // Logic: 
    // 1. Kh·ªõp ng√†y
    // 2. HO·∫∂C ƒëang 'active' (ƒëang d√πng) th√¨ hi·ªán lu√¥n (ƒë·ªÉ nh·ª° qua ƒë√™m c√≤n th·∫•y)
    currentBedList = globalAllBookings.filter(b => {
        // Ch·ªâ hi·ªán active n·∫øu xem ng√†y h√¥m nay, c√≤n xem qu√° kh·ª© th√¨ ch·ªâ hi·ªán ƒë√∫ng ng√†y ƒë√≥
        const isToday = (targetDateStr === new Date().toLocaleDateString('en-GB'));
        
        if (isToday) {
             return b.displayDate === targetDateStr || (b.status && b.status.includes('active'));
        } else {
             // Xem qu√° kh·ª©/t∆∞∆°ng lai th√¨ c·ª© ƒë√∫ng ng√†y l√† hi·ªán
             return b.displayDate === targetDateStr;
        }
    });

    // V·∫Ω l·∫°i giao di·ªán
    renderBedBookings(currentBedList);
}
function renderBedBookings(list) {
    // ========================================================
    // 1. T·ª∞ ƒê·ªòNG QU√âT V√Ä H·ª¶Y L·ªäCH TR·ªÑ (Auto-Cancel Logic)
    // ========================================================
    const now = new Date();
    const AUTO_CANCEL_MINUTES = 50; // Gi·ªõi h·∫°n 50 ph√∫t
    const todayStr = now.toLocaleDateString('en-GB'); // dd/mm/yyyy

    if (list && list.length > 0) {
        list.forEach(booking => {
            // Ch·ªâ ki·ªÉm tra c√°c ƒë∆°n ƒëang "ch·ªù kh√°ch"
            if (booking.status === 'ch·ªù kh√°ch' || !booking.status) {
                
                // Ch·ªâ h·ªßy n·∫øu l√† l·ªãch c·ªßa H√îM NAY
                if (!booking.displayDate || booking.displayDate === todayStr) {
                    
                    if (booking.start && booking.start.includes(':')) {
                        // T√≠nh to√°n th·ªùi gian tr·ªÖ
                        let parts = booking.start.split(':');
                        let bookingTime = new Date();
                        bookingTime.setHours(parseInt(parts[0]), parseInt(parts[1]), 0);

                        let diff = (now - bookingTime) / 60000; // ƒê·ªïi ra ph√∫t

                        // N·∫øu tr·ªÖ h∆°n 50 ph√∫t -> H·ªßy ngay tr√™n Firebase
                        if (diff > AUTO_CANCEL_MINUTES) {
                            console.log(`üö´ Auto-cancel: ƒê∆°n ${booking.name} tr·ªÖ ${Math.round(diff)}p -> H·ª¶Y`);
                            
                            // [ƒê√É S·ª¨A L·ªñI ·ªû ƒê√ÇY]: D√πng booking.id thay v√¨ k, booking thay v√¨ item
                            let bookingId = booking.id || booking.key;
                            
                            if (bookingId) {
                                db.ref('bedBookings/' + bookingId).update({
                                    status: 'ƒë√£ h·ªßy',
                                    cancelType: 'auto_timeout',
                                    note: 'H·ªßy t·ª± ƒë·ªông (Qu√° 50p)'
                                });
                                
                                // C·∫≠p nh·∫≠t hi·ªÉn th·ªã ngay l·∫≠p t·ª©c
                                booking.status = 'ƒë√£ h·ªßy';
                                booking.cancelType = 'auto_timeout';
                            }
                        }
                    }
                }
            }
        });
    }

    // ========================================================
    // 2. RESET GIAO DI·ªÜN V·ªÄ M·∫∂C ƒê·ªäNH
    // ========================================================
    selectedBedIndex = -1; // B·ªè ch·ªçn item ƒëang click
    
    // Hi·ªán m√†n h√¨nh ch·ªù "Ch·ªçn l·ªãch ƒë·ªÉ xem"
    document.getElementById('detail-empty-state')?.classList.remove('hidden');
    
    // ·∫®n b·∫£ng chi ti·∫øt ƒëi
    document.getElementById('detail-content-panel')?.classList.add('hidden');
    
    // T·∫Øt ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c (n·∫øu ƒëang ch·∫°y c·ªßa bed tr∆∞·ªõc)
    stopPanelCountdown();

    // ========================================================
    // 3. V·∫º L·∫†I GIAO DI·ªÜN (List b√™n tr√°i + Map b√™n ph·∫£i)
    // ========================================================
    renderLeftColumnList();
    renderRightColumnMap();
}
// --- H√ÄM V·∫º DANH S√ÅCH B√äN TR√ÅI (KH√îI PH·ª§C & C√ì M√ÄU H·ª¶Y) ---
// --- H√ÄM V·∫º DANH S√ÅCH B√äN TR√ÅI (STYLE M·ªöI: BO TR√íN M·ªÄM M·∫†I) ---
function renderLeftColumnList() {
    var container = document.getElementById('col-left-list');
    if (!container) return;

    if (!currentBedList || currentBedList.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-300 text-[10px] py-10 font-bold uppercase tracking-widest">Kh√¥ng c√≥ l·ªãch</div>';
        return;
    }

    container.innerHTML = currentBedList.map(function(b, index) {
        var isDone = (b.status && b.status.includes('ƒë√£ xong'));
        var isCancelled = (b.status && b.status.includes('ƒë√£ h·ªßy'));
        var isActive = (b.status && (b.status.includes('active') || b.status.includes('ƒëang d√πng')));
        var isSelected = (index === selectedBedIndex);

        // Style c∆° b·∫£n: Bo tr√≤n 24px, padding r·ªông h∆°n
        var wrapperClass = "cursor-pointer p-4 rounded-[24px] transition-all duration-200 mb-3 border relative group ";
        var statusTextUI = ""; 

        if (isSelected) {
            // ƒêang ch·ªçn: Xanh ƒë·∫≠m, n·ªïi kh·ªëi
            wrapperClass += "bg-[#006241] border-[#006241] text-white shadow-lg scale-[1.02] z-10";
        } else if (isCancelled) {
            // ƒê√£ h·ªßy: ƒê·ªè nh·∫°t
            if (b.cancelType === 'auto_timeout') {
                wrapperClass += "bg-red-50 border-red-100 text-red-900";
                statusTextUI = "AUTO TIMEOUT";
            } else {
                wrapperClass += "bg-red-50 border-red-100 text-red-800 opacity-70 grayscale-[0.5]";
                statusTextUI = "ƒê√É H·ª¶Y";
            }
        } else if (isDone) {
            // ƒê√£ xong: X√°m s·∫°ch s·∫Ω
            wrapperClass += "bg-gray-100 border-gray-200 text-gray-500 hover:bg-gray-200";
        } else if (isActive) {
            // ƒêang d√πng: Xanh nh·∫°t
            wrapperClass += "bg-[#E6F4F1] border-[#bce3db] text-[#006241] shadow-sm";
        } else {
            // Ch·ªù: Tr·∫Øng
            wrapperClass += "bg-white border-gray-100 text-gray-600 hover:bg-gray-50 hover:shadow-md hover:border-gray-200";
        }

        // D·∫•u ch·∫•m tr·∫°ng th√°i
        var statusDot = "";
        if (isCancelled) statusDot = "bg-red-500";
        else if (isDone) statusDot = "bg-gray-400";
        else if (isActive) statusDot = "bg-green-500 animate-pulse shadow-[0_0_8px_rgba(34,197,94,0.6)]";
        else statusDot = "bg-amber-400";

        // Hi·ªÉn th·ªã gi·ªù
        var timeDisplay = `${b.start} - ${b.end}`;
        if (isDone && b.realEndTime) timeDisplay = `Check-out: ${b.realEndTime}`;
        else if (isCancelled) timeDisplay = statusTextUI;

        var bedLabel = (b.bedId && b.bedId != "WAITING") ? `BED 0${b.bedId}` : "CH·ªú X·∫æP";

        return `
        <div onclick="selectBedItem(${index})" class="${wrapperClass}">
            <div class="flex justify-between items-center mb-1.5">
                <span class="font-black text-[10px] opacity-70 uppercase tracking-widest">${bedLabel}</span>
                <div class="w-2.5 h-2.5 rounded-full ${statusDot}"></div>
            </div>
            <div class="font-black text-sm truncate mb-1.5 leading-tight">${b.name}</div>
            <div class="text-[10px] font-mono flex justify-between opacity-80 font-bold items-center">
                <span>${timeDisplay}</span>
                ${b.totalSpend ? `<span class="bg-black/10 px-1.5 rounded text-[9px]">${Number(b.totalSpend).toLocaleString()}ƒë</span>` : ''}
            </div>
        </div>`;
    }).join('');
}
 // --- [PC FIX LIVE MAP] GIAO DI·ªÜN GRID + HI·ªÇN TH·ªä T√äN ---
// --- [PC MAP FIX] TH·ª® T·ª∞ 1-3-2-4 + T√äN TH√îNG MINH ---
function renderRightColumnMap() {
    var container = document.getElementById('vertical-map-container');
    if(!container) return;

    // 1. Style l·∫°i khung cha (Spatial Design)
    var parent = container.parentElement;
    if (parent && !parent.classList.contains('spatial-glass')) {
        parent.className = "flex-1 spatial-glass rounded-[2.5rem] p-5 flex flex-col overflow-hidden relative shadow-sm border border-white/60";
        var title = parent.querySelector('h3');
        if(title) {
            title.className = "text-[10px] font-black text-gray-400 uppercase tracking-[0.3em] mb-4 text-center";
            title.innerText = "LIVE STATUS";
        }
    }

    // 2. C·∫•u h√¨nh Grid 2 c·ªôt
    container.className = "flex-1 grid grid-cols-2 gap-3 overflow-y-auto hide-scroll content-start";

    var html = '';
    
    // --- [FIX LOGIC] TH·ª® T·ª∞ RENDER ƒê·∫∂C BI·ªÜT ---
    // ƒê·ªÉ Bed 1 tr√™n Bed 2, Bed 3 tr√™n Bed 4 -> Grid ph·∫£i v·∫Ω: 1 -> 3 -> 2 -> 4
    var mapOrder = [1, 3, 2, 4]; 

    mapOrder.forEach(i => {
        // T√¨m ƒë∆°n ƒëang Active
        var booking = currentBedList.find(b => 
            b.bedId == i && 
            b.status && 
            (b.status.includes('active') || b.status.includes('ƒëang d√πng'))
        );

        // --- C·∫§U H√åNH M·∫∂C ƒê·ªäNH (TR·ªêNG) ---
        var contentHTML = `<span class="text-4xl font-black text-gray-200 group-hover:text-gray-300 transition-colors">0${i}</span>`;
        var subText = "TR·ªêNG";
        var boxClass = "bg-white/40 border-2 border-dashed border-gray-200 hover:border-gray-300 hover:bg-white/60";
        var statusDot = "";

        // --- C·∫§U H√åNH KHI C√ì KH√ÅCH (ACTIVE) ---
        if (booking) {
            boxClass = "bg-[#065F46] text-white shadow-xl shadow-emerald-900/20 border border-emerald-600/50 relative overflow-hidden";
            subText = ""; 
            
            // X·ª¨ L√ù T√äN: L·∫•y 2 t·ª´ cu·ªëi (V√≠ d·ª•: "Nguy·ªÖn VƒÉn A" -> "VƒÇN A")
            var shortName = "KH√ÅCH";
            if (booking.name) {
                let parts = booking.name.trim().split(' ');
                // L·∫•y 2 t·ª´ cu·ªëi
                shortName = parts.slice(Math.max(parts.length - 2, 0)).join(' ');
            }
            
            // HTML hi·ªÉn th·ªã: S·ªë nh·ªè + T√™n to
            contentHTML = `
                <div class="flex flex-col items-center justify-center h-full z-10 w-full px-1 pt-2">
                    <span class="text-[10px] font-bold opacity-60 mb-0.5 tracking-widest">BED 0${i}</span>
                    <span class="text-sm font-black text-center uppercase leading-tight break-words line-clamp-2 w-full px-1">
                        ${shortName}
                    </span>
                </div>
            `;
            
            // Ch·∫•m xanh nh·∫•p nh√°y
            statusDot = `
                <div class="absolute top-2 right-2 flex h-2.5 w-2.5">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500 border border-[#065F46]"></span>
                </div>`;
        }

        // --- RENDER ITEM ---
        html += `
        <div onclick="selectBedFromMap(${i})" 
             class="${boxClass} aspect-square rounded-[2rem] flex flex-col items-center justify-center cursor-pointer transition-all duration-300 active:scale-95 group relative">
            
            ${statusDot}
            ${contentHTML}
            
            ${!booking ? `<span class="text-[9px] font-black uppercase tracking-widest mt-1 text-gray-400 group-hover:text-gray-500">${subText}</span>` : ''}
        </div>`;
    });
    
    container.innerHTML = html;
}
function selectBedFromMap(bedId) { var index = currentBedList.findIndex(b => b.bedId == bedId && b.status && !b.status.includes('ƒë√£ xong') && !b.status.includes('ƒë√£ h·ªßy')); if (index !== -1) { (index); var listItem = document.getElementById('col-left-list').children[index]; if(listItem) listItem.scrollIntoView({behavior: 'smooth', block: 'center'}); } }
// --- H√ÄM G·ªåI POPUP STYLE IPHONE ---
let onConfirmAction = null; // Bi·∫øn l∆∞u h√†nh ƒë·ªông s·∫Ω l√†m khi b·∫•m OK

function showIOSConfirm(message, callback) {
    // 1. G√°n n·ªôi dung
    document.getElementById('ios-modal-message').innerText = message;
    
    // 2. L∆∞u h√†nh ƒë·ªông c·∫ßn l√†m (callback)
    onConfirmAction = callback;
    
    // 3. G√°n s·ª± ki·ªán cho n√∫t OK
    const btnOk = document.getElementById('ios-confirm-btn');
    btnOk.onclick = function() {
        if (onConfirmAction) onConfirmAction(); // Ch·∫°y h√†nh ƒë·ªông
        closeIOSModal(); // ƒê√≥ng popup
    };

    // 4. Hi·ªÉn th·ªã Popup
    const modal = document.getElementById('ios-confirm-modal');
    modal.classList.remove('hidden');
    // Th√™m ch√∫t animation
    modal.classList.add('animate-fade-in'); 
}

function closeIOSModal() {
    document.getElementById('ios-confirm-modal').classList.add('hidden');
    onConfirmAction = null;
}
// --- H√ÄM SELECT ITEM: ƒê√É G·ªòP T·∫§T C·∫¢ LOGIC (KH√îNG B·ªä ƒê∆† N·ªÆA) ---
// --- H√ÄM SELECT ITEM: ƒê√É S·ª¨A L·ªñI D·∫§U NGO·∫∂C + POPUP IPHONE ---
// --- H√ÄM SELECT ITEM: ƒê√É FIX L·ªñI "BTN CANCEL" & TH√äM CH·ªåN L√ù DO H·ª¶Y ---
// --- H√ÄM CH·ªåN BED ITEM (N√ÇNG C·∫§P: T√çNH TI·ªÄN + PH·∫†T V·ªÜ SINH) ---
// --- H√ÄM SELECT BED ITEM (B·∫¢N CHU·∫®N: COMPACT UI + ƒê·ª¶ T√çNH NƒÇNG) ---
// --- H√ÄM CH·ªåN BED ITEM (ƒê√É N√ÇNG C·∫§P: QU·∫¢N L√ù PH·∫†T V·ªÜ SINH) ---
// --- [PC FIX] H√ÄM CH·ªåN BED V√Ä HI·ªÇN TH·ªä CHI TI·∫æT (ƒê√É FIX ƒê·ªíNG H·ªí) ---
// --- [PC REDESIGN] H√ÄM CH·ªåN BED V√Ä HI·ªÇN TH·ªä CHI TI·∫æT (GIAO DI·ªÜN SPATIAL) ---
// --- [PC REDESIGN - FIXED DISPLAY] H√ÄM CH·ªåN BED ---
// --- [PC FINAL V4] H√ÄM CH·ªåN BED V√Ä HI·ªÇN TH·ªä CHI TI·∫æT ---
// Update:
// 1. Hi·ªÉn th·ªã T·ªïng chi ti√™u t·∫°m t√≠nh cho Bed ƒëang ho·∫°t ƒë·ªông (Active)
// 2. Fix l·ªói T√™n kh√°ch qu√° d√†i (T·ª± xu·ªëng d√≤ng, c·∫Øt b·ªõt)
// 3. Fix l·ªói Gi·ªù Checkout v√† L√Ω do h·ªßy
// --- [PC FIX LAYOUT] H√ÄM CH·ªåN BED (B·∫¢N T·ªêI ∆ØU DI·ªÜN T√çCH) ---
// Thay ƒë·ªïi:
// 1. B·ªè d√≤ng "CHI TI·∫æT ƒê·∫∂T L·ªäCH"
// 2. Thu nh·ªè √¥ Gi·ªù B·∫Øt ƒë·∫ßu/K·∫øt th√∫c (Text nh·ªè l·∫°i, padding gi·∫£m)
// 3. ƒê·∫©y t√™n kh√°ch l√™n cao h∆°n (Gi·∫£m padding top)

function selectBedItem(index) {
    selectedBedIndex = index;
    renderLeftColumnList(); 

    var data = currentBedList[index];
    var panel = document.getElementById('detail-content-panel');
    var empty = document.getElementById('detail-empty-state');
    
    // 1. Hi·ªán panel (ƒê√£ fix l·ªói hidden)
    if(empty) empty.classList.add('hidden');
    if(panel) { 
        panel.classList.remove('hidden'); 
        panel.className = "flex flex-col h-full bg-[#F2F4F7] relative overflow-hidden rounded-[2.5rem]";
    }

    // 2. X√°c ƒë·ªãnh tr·∫°ng th√°i
    var isDone = (data.status && data.status.includes('ƒë√£ xong'));
    var isCancelled = (data.status && data.status.includes('ƒë√£ h·ªßy'));
    var isActive = (data.status && (data.status.includes('active') || data.status.includes('ƒëang d√πng')));
    var hasBed = (data.bedId && data.bedId != "WAITING");
    var bookingId = data.id || data.key;
    
    // Check ph·∫°t v·ªá sinh
    var hasPenalty = data.hasPenalty === true;
    var penaltyAmt = data.penaltyAmount || 0;

    // --- LOGIC SUB-TITLE ---
    let subTitleHTML = "";
    if (isCancelled) {
        let reason = "ƒê√É H·ª¶Y";
        if (data.cancelType === 'auto_timeout') reason = "AUTO H·ª¶Y (QU√Å GI·ªú)";
        else if (data.cancelType === 'customer') reason = "KH√ÅCH B√ÅO H·ª¶Y";
        else if (data.cancelType === 'store') reason = "QU√ÅN H·ª¶Y (SYSTEM)";
        subTitleHTML = `<span class="text-xl font-black text-red-500 uppercase tracking-tight">${reason}</span>`;
    } else if (isDone) {
        subTitleHTML = `<span class="text-xl font-black text-gray-400 uppercase">BED 0${data.bedId} (ƒê√É TR·∫¢)</span>`;
    } else {
        subTitleHTML = `<span class="text-2xl font-black text-[#065F46]" id="detail-bed-name">${hasBed ? `BED 0${data.bedId}` : "CH·ªú X·∫æP"}</span>`;
    }

    // --- RENDER HTML (ƒê√É T·ªêI ∆ØU DI·ªÜN T√çCH) ---
    panel.innerHTML = `
    <div class="spatial-glass w-full h-full flex flex-col relative rounded-[2.5rem] overflow-hidden">
        
        <div class="px-8 pt-6 pb-2 shrink-0">
            <div class="flex items-start justify-between">
                <div class="flex-1 pr-4">
                    <h1 class="text-3xl md:text-4xl font-black tracking-tighter text-[#1e293b] leading-tight mb-1 line-clamp-2 overflow-hidden text-ellipsis" style="max-height: 5rem;">
                        ${data.name || "Kh√°ch l·∫ª"}
                    </h1>
                    
                    <div class="flex items-center gap-2">
                        ${subTitleHTML}
                        <div id="detail-timer-box" class="hidden ml-4 px-3 py-1 bg-red-50 text-red-600 rounded-lg flex items-center gap-2 animate-pulse">
                            <span class="material-symbols-outlined text-sm">timer</span>
                            <span id="detail-countdown" class="font-black font-mono text-lg tracking-tight">--:--</span>
                        </div>
                    </div>
                </div>

                <div id="detail-status-badge" class="px-5 py-2 rounded-2xl border transition-colors shrink-0">
                    <span class="font-black text-sm tracking-widest uppercase">WAITING</span>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto px-8 pb-32 hide-scroll space-y-4">
            
            <div class="grid grid-cols-2 gap-4">
                <div class="p-4 glass-card-inner rounded-[1.5rem] flex flex-col justify-center">
                    <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1">LI√äN H·ªÜ</p>
                    <h4 class="text-xl font-black text-slate-800 truncate">${data.phone || "--"}</h4>
                    <div class="flex items-center gap-1 text-emerald-600">
                        <span class="material-symbols-outlined text-xs">verified</span>
                        <span class="text-[10px] font-bold">Kh√°ch h√†ng</span>
                    </div>
                </div>

                <div class="p-4 glass-card-inner rounded-[1.5rem] flex flex-col justify-center">
                    <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1">ƒêI C√ôNG</p>
                    <h4 class="text-xl font-black text-slate-800 truncate">${data.compName || "---"}</h4>
                    <p class="text-xs font-bold text-gray-500">${data.compPhone || "--"}</p>
                </div>
            </div>

            <div class="p-4 bg-white/60 border border-white/40 rounded-[2rem] flex items-center justify-around shadow-sm">
                <div class="text-center">
                    <p class="text-[9px] font-black text-gray-400 uppercase tracking-[0.2em] mb-1">B·∫ÆT ƒê·∫¶U</p>
                    <span class="text-3xl font-black text-slate-800 tracking-tighter">${data.start}</span>
                </div>
                <div class="text-gray-300">
                    <span class="material-symbols-outlined text-3xl font-light">arrow_forward</span>
                </div>
                <div class="text-center">
                    <p class="text-[9px] font-black text-gray-400 uppercase tracking-[0.2em] mb-1">K·∫æT TH√öC</p>
                    <span class="text-3xl font-black text-slate-800 tracking-tighter">${data.end}</span>
                </div>
            </div>

            <div id="row-checkout-time" class="hidden text-center bg-gray-100/50 rounded-2xl p-2 border border-gray-200/50">
                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Th·ª±c t·∫ø check-out l√∫c</span>
                <div class="font-black text-slate-800 text-2xl tracking-tight" id="detail-real-end">--:--</div>
            </div>

            <div id="done-session-info" class="hidden space-y-3"></div>

            <div id="wrapper-btn-cancel" class="hidden pt-2">
                <button id="btn-action-cancel" class="w-full py-3 rounded-2xl border-2 border-dashed border-red-200 text-red-400 font-black uppercase tracking-[0.2em] text-[10px] hover:bg-red-50 transition-all">
                    H·ª¶Y L·ªäCH N√ÄY
                </button>
            </div>
        </div>

        <div id="detail-action-buttons" class="absolute bottom-6 left-6 right-6 z-20">
            <div class="bg-white/90 backdrop-blur-xl p-3 rounded-[2rem] shadow-[0_20px_40px_-10px_rgba(0,0,0,0.15)] border border-white flex items-center gap-3">
                <button id="btn-action-order" class="flex-1 h-14 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-[1.5rem] font-black text-sm uppercase flex items-center justify-center gap-2 transition-all active:scale-95 shadow-inner">
                    <span class="material-symbols-outlined">restaurant</span>
                    G·ªçi M√≥n
                </button>
                <button id="btn-action-checkout" class="flex-[1.5] h-14 bg-[#065F46] hover:bg-[#044e39] text-white rounded-[1.5rem] font-black text-sm uppercase flex items-center justify-center gap-2 shadow-lg shadow-emerald-900/20 transition-all active:scale-95">
                    <span class="material-symbols-outlined">meeting_room</span>
                    X·∫øp Bed Ngay
                </button>
            </div>
        </div>

    </div>
    `;

    // 4. Update Badge
    var badge = document.getElementById('detail-status-badge');
    var badgeContent = badge.querySelector('span');
    
    if (isDone) {
        badge.className = "px-5 py-2 rounded-2xl border border-gray-200 bg-gray-100 text-gray-500";
        badgeContent.innerText = "ƒê√É XONG";
    } else if (isCancelled) {
        badge.className = "px-5 py-2 rounded-2xl border border-red-200 bg-red-50 text-red-500";
        badgeContent.innerText = "ƒê√É H·ª¶Y";
    } else if (isActive) {
        badge.className = "px-5 py-2 rounded-2xl border border-emerald-200 bg-emerald-50 text-[#065F46] shadow-sm";
        badgeContent.innerText = "ACTIVE";
    } else {
        badge.className = "px-5 py-2 rounded-2xl border border-amber-200 bg-amber-50 text-amber-600 shadow-sm";
        badgeContent.innerText = "CH·ªú KH√ÅCH";
    }

    // --- LOGIC ƒê·ªíNG H·ªí ---
    var timerBox = document.getElementById('detail-timer-box');
    if (isActive) {
        if(timerBox) timerBox.classList.remove('hidden');
        startPanelCountdown(data.end);
    } else {
        if(timerBox) timerBox.classList.add('hidden');
        stopPanelCountdown();
    }

    // 5. Logic hi·ªÉn th·ªã n√∫t/ti·ªÅn
    var rowCheckout = document.getElementById('row-checkout-time');
    var actionBtns = document.getElementById('detail-action-buttons');
    var wrapperCancel = document.getElementById('wrapper-btn-cancel');

    if (isDone || isCancelled) {
        if(rowCheckout) {
            rowCheckout.classList.remove('hidden');
            let timeText = isCancelled ? (data.note || "ƒê√£ h·ªßy") : (data.realEndTime || "--:--");
            document.getElementById('detail-real-end').innerText = timeText;
        }
        if(actionBtns) actionBtns.classList.add('hidden');
        if(wrapperCancel) wrapperCancel.classList.add('hidden');

        if (isDone && !isCancelled) {
            let savedTotal = data.totalSpend ? Number(data.totalSpend) : null;
            if (savedTotal !== null) {
                renderDoneSessionInfo(savedTotal, hasPenalty, penaltyAmt, data.phone, bookingId);
            } else if (data.phone) {
                calculateSessionSpend(data.phone, data.start, data.realEndTime).then(total => {
                    renderDoneSessionInfo(total, hasPenalty, penaltyAmt, data.phone, bookingId);
                });
            }
        }
    } else {
        var oldInfo = document.getElementById('done-session-info');
        if(oldInfo) oldInfo.classList.add('hidden');
        if(rowCheckout) rowCheckout.classList.add('hidden');
        if(actionBtns) actionBtns.classList.remove('hidden');
        if(isActive) { if(wrapperCancel) wrapperCancel.classList.add('hidden'); }
        else { if(wrapperCancel) wrapperCancel.classList.remove('hidden'); }
        
        // T√≠nh ti·ªÅn t·∫°m t√≠nh cho Active
        if (data.phone) {
             calculateSessionSpend(data.phone, data.start, data.end).then(total => {
                var infoDiv = document.getElementById('done-session-info');
                if (infoDiv) {
                    infoDiv.innerHTML = `
                    <div class="bg-white border border-emerald-100 rounded-[2rem] p-4 shadow-sm relative overflow-hidden">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-[9px] font-bold uppercase tracking-[0.2em] text-gray-400 mb-1">CHI TI√äU T·∫†M T√çNH</p>
                                <div class="flex items-baseline gap-1">
                                    <span class="text-3xl font-black tracking-tight text-[#065F46]">${total.toLocaleString()}</span>
                                    <span class="text-xs font-bold opacity-60 text-[#065F46]">VNƒê</span>
                                </div>
                            </div>
                            <div class="w-10 h-10 bg-emerald-50 rounded-full flex items-center justify-center text-[#065F46]">
                                <span class="material-symbols-outlined">payments</span>
                            </div>
                        </div>
                    </div>`;
                    infoDiv.classList.remove('hidden');
                }
             });
        }
        
        setupActionButtons(bookingId, data, hasBed, 
            document.getElementById('btn-action-order'), 
            document.getElementById('btn-action-checkout'), 
            document.getElementById('btn-action-cancel')
        );
    }
}

// H√†m ph·ª• tr·ª£ Render Card T·ªïng Ti·ªÅn & N√∫t Ph·∫°t (Gi·ªØ nguy√™n)
function renderDoneSessionInfo(total, hasPenalty, penaltyAmt, phone, bookingId) {
    var infoDiv = document.getElementById('done-session-info');
    if (!infoDiv) return;

    var totalHTML = `
    <div class="bg-gradient-to-br from-[#065F46] to-[#044e39] rounded-[2rem] p-6 text-white shadow-lg relative overflow-hidden">
        <div class="absolute top-0 right-0 p-4 opacity-20"><span class="material-symbols-outlined text-6xl">payments</span></div>
        <p class="text-[10px] font-bold uppercase tracking-[0.2em] opacity-80 mb-1">T·ªîNG CHI TI√äU</p>
        <div class="flex items-baseline gap-1">
            <span class="text-4xl font-black tracking-tight">${total.toLocaleString()}</span>
            <span class="text-sm font-bold opacity-80">VNƒê</span>
        </div>
    </div>`;

    var penaltyHTML = '';
    if (hasPenalty) {
        penaltyHTML = `
        <div class="bg-red-50 rounded-[2rem] p-6 border border-red-100 flex flex-col gap-4 relative overflow-hidden">
            <div class="absolute -right-4 -top-4 w-20 h-20 bg-red-200 rounded-full opacity-30"></div>
            <div class="flex items-center gap-4 relative z-10">
                <div class="w-12 h-12 bg-red-100 text-red-500 rounded-2xl flex items-center justify-center shadow-sm">
                    <span class="material-symbols-outlined text-2xl">warning</span>
                </div>
                <div>
                    <p class="text-[10px] font-black text-red-400 uppercase tracking-widest">ƒê√É PH·∫†T V·ªÜ SINH</p>
                    <p class="text-2xl font-black text-red-600">${penaltyAmt.toLocaleString()}ƒë</p>
                </div>
            </div>
            <div class="flex gap-3 relative z-10">
                <button onclick="openCleaningModal('${phone}', '${bookingId}')" class="flex-1 py-3 bg-white border border-red-200 text-red-500 rounded-xl font-bold text-xs uppercase shadow-sm hover:bg-red-50 transition-all">S·ª≠a</button>
                <button onclick="deletePenalty('${phone}', '${bookingId}')" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold text-xs uppercase shadow-lg shadow-red-200 hover:bg-red-600 transition-all">X√≥a</button>
            </div>
        </div>`;
    } else {
        penaltyHTML = `
        <div onclick="openCleaningModal('${phone}', '${bookingId}')" class="group bg-white rounded-[2rem] p-5 border-2 border-dashed border-gray-200 hover:border-red-200 cursor-pointer transition-all flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gray-100 group-hover:bg-red-100 text-gray-400 group-hover:text-red-500 rounded-2xl flex items-center justify-center transition-colors">
                    <span class="material-symbols-outlined">cleaning_services</span>
                </div>
                <div>
                    <h4 class="font-black text-gray-600 group-hover:text-red-500 uppercase text-sm transition-colors">Th√™m ph√≠ v·ªá sinh</h4>
                    <p class="text-xs text-gray-400">N·∫øu kh√°ch l√†m b·∫©n n·ªám/s√†n</p>
                </div>
            </div>
            <span class="material-symbols-outlined text-gray-300 group-hover:text-red-400">add_circle</span>
        </div>`;
    }

    infoDiv.innerHTML = totalHTML + penaltyHTML;
    infoDiv.classList.remove('hidden');
}
// H√†m ph·ª• ƒë·ªÉ g√°n n√∫t (cho code g·ªçn)
function setupActionButtons(bookingId, data, hasBed, btnOrder, btnCheckout, btnCancel) {
    // Cancel
    if(btnCancel) {
        btnCancel.onclick = function() {
            window.pendingCancelId = bookingId;
            document.getElementById('modal-cancel-reason').classList.remove('hidden');
        };
    }
    // Order
    if (btnOrder) {
        btnOrder.innerHTML = "<span>‚òï G·ªçi M√≥n</span>";
        btnOrder.onclick = function() { showBedDetail(data.bedId); };
    }
    // Checkout
    if (btnCheckout) {
        if (!hasBed) {
            btnCheckout.innerHTML = '<span>üõèÔ∏è X·∫øp Bed Ngay</span>';
            btnCheckout.onclick = function() {
                pendingBedOrder = data;
                renderBedSelection();
                document.getElementById('bed-select-modal').classList.remove('hidden');
            };
        } else {
            btnCheckout.innerHTML = '<span>Tr·∫£ Bed</span>';
            btnCheckout.onclick = function() { handleBedCheckout(data); };
        }
    }
}
    // --- [FIXED] G·ªåI M√ìN MOBILE (C√ì T·ª∞ ƒê·ªòNG T√çNH GI·ªú) ---
// --- [FIXED] G·ªåI M√ìN MOBILE (B·∫¢N FULL KH√îNG C·∫ÆT B·ªöT) ---
function handleMobileBedOrder(bookingId) {
    // 1. T√¨m th√¥ng tin ƒë∆°n ƒë·∫∑t trong bi·∫øn to√†n c·ª•c
    const booking = globalAllBookings.find(b => b.id === bookingId);
    
    if (!booking) return console.error("Kh√¥ng t√¨m th·∫•y booking ID:", bookingId);

    // 2. C·∫≠p nh·∫≠t bi·∫øn tr·∫°ng th√°i Bed
    activeOrderingBedId = booking.bedId || "WAITING"; 
    pendingBedOrder = booking; 

    // 3. T·ª∞ ƒê·ªòNG ƒêI·ªÄN S·ªê ƒêI·ªÜN THO·∫†I
    var sdtInput = document.getElementById('kh-sdt');
    if (sdtInput && booking.phone) {
        sdtInput.value = booking.phone;
        
        // K√≠ch ho·∫°t h√†m ki·ªÉm tra kh√°ch h√†ng
        if (typeof checkSdtLive === 'function') {
            checkSdtLive(); 
        }
    }

    // >>> [TH√äM M·ªöI] T·ª∞ ƒê·ªòNG T√çNH GI·ªú V√Ä TH√äM M√ìN BED <<<
    // Ch·ªâ ch√®n th√™m ƒëo·∫°n n√†y, kh√¥ng x√≥a code c≈©
    if (typeof autoAddBedItems === 'function') {
        autoAddBedItems(booking);
    }
    // ---------------------------------------------------

    // 4. Chuy·ªÉn sang giao di·ªán Menu
    switchView('menu');

    // 5. (GI·ªÆ NGUY√äN CODE C≈®) Hi·ªÉn th·ªã thanh th√¥ng b√°o nh·ªè
    setTimeout(function() {
        var cartInfo = document.getElementById('cart-bed-info');
        var headerContainer = document.querySelector('#sidebar-cart .flex.justify-between');
        
        // N·∫øu ch∆∞a c√≥ thanh th√¥ng b√°o th√¨ t·∫°o m·ªõi
        if (!cartInfo && headerContainer) {
            cartInfo = document.createElement('div');
            cartInfo.id = 'cart-bed-info';
            headerContainer.parentNode.insertBefore(cartInfo, headerContainer.nextSibling);
        }
        
        if (cartInfo) {
            var guestName = booking.name || "Kh√°ch h√†ng";
            cartInfo.className = "text-[11px] font-black uppercase mb-2 pl-1 mt-1 animate-pulse";
            
            if (booking.bedId && booking.bedId != "WAITING") {
                cartInfo.innerText = `üü¢ ƒêANG G·ªåI: BED 0${booking.bedId} - ${guestName}`;
                cartInfo.style.color = "#006241";
            } else {
                cartInfo.innerText = `üü† ƒêANG G·ªåI: KH√ÅCH CH·ªú - ${guestName}`;
                cartInfo.style.color = "#d97706";
            }
        }
    }, 100);
}
// --- S·ª¨A L·ªñI: G·ªåI M√ìN KH√îNG NH·∫¨N DI·ªÜN KH√ÅCH ---
// --- [FIXED] G·ªåI M√ìN PC (C√ì T·ª∞ ƒê·ªòNG T√çNH GI·ªú) ---
// --- [FIXED PC] G·ªåI M√ìN T·ª™ CHI TI·∫æT BED ---
function showBedDetail(bedId) { 
    var booking = null; 
    if (bedId && bedId != 0) booking = currentBedList.find(b => b.bedId == bedId);
    if (!booking && selectedBedIndex > -1) booking = currentBedList[selectedBedIndex]; 
    
    if (!booking) return alert("Vui l√≤ng ch·ªçn kh√°ch h√†ng tr∆∞·ªõc!");
    
    // 1. Set bi·∫øn to√†n c·ª•c
    activeOrderingBedId = bedId; 
    pendingBedOrder = booking; 

    // 2. ƒêi·ªÅn SƒêT v√†o √¥ t√¨m ki·∫øm & K√≠ch ho·∫°t t√¨m t√™n kh√°ch
    var sdtInput = document.getElementById('kh-sdt');
    if (sdtInput && booking.phone) {
        sdtInput.value = booking.phone;
        // G·ªçi h√†m checkSdtLive ƒë·ªÉ hi·ªán t√™n kh√°ch ngay l·∫≠p t·ª©c
        if (typeof checkSdtLive === 'function') checkSdtLive();
    }

    // 3. T·ª± ƒë·ªông t√≠nh gi·ªù v√† th√™m m√≥n (QUAN TR·ªåNG)
    if (typeof autoAddBedItems === 'function') {
        autoAddBedItems(booking);
    } else {
        console.error("Thi·∫øu h√†m autoAddBedItems!");
    }

    // 4. Chuy·ªÉn View
    switchView('menu'); 
    
    // 5. Hi·ªÉn th·ªã th√¥ng b√°o nh·ªè
    updateCartInfo(booking);
}

// H√†m ph·ª• hi·ªÉn th·ªã th√¥ng b√°o nh·ªè tr√™n gi·ªè h√†ng (T√°ch ra cho g·ªçn)
function updateCartInfo(booking) {
    setTimeout(function() { 
        var cartInfo = document.getElementById('cart-bed-info'); 
        var headerContainer = document.querySelector('#sidebar-cart .flex.justify-between'); 
        if (!cartInfo && headerContainer) { 
            cartInfo = document.createElement('div'); 
            cartInfo.id = 'cart-bed-info'; 
            headerContainer.parentNode.insertBefore(cartInfo, headerContainer.nextSibling); 
        } 
        if (cartInfo) { 
            var guestName = booking.name || "Kh√°ch h√†ng"; 
            cartInfo.className = "text-[11px] font-black uppercase mb-2 pl-1 mt-1 animate-pulse"; 
            if (booking.bedId && booking.bedId != 0) { 
                cartInfo.innerText = `üü¢ BED 0${booking.bedId} - ${guestName}`; 
                cartInfo.style.color = "#006241"; 
            } else { 
                cartInfo.innerText = `üü† KH√ÅCH CH·ªú - ${guestName}`; 
                cartInfo.style.color = "#d97706"; 
            } 
        } 
    }, 50);
}
    //--- S·ª¨A L·ªñI: X·∫æP BED B·ªä RA ƒê∆†N M·ªöI UNDEFINED ---
function finalizeBedCheckIn(bedId) {
    // 1. Ki·ªÉm tra an to√†n
    if (!pendingBedOrder) return alert("Ch∆∞a ch·ªçn kh√°ch h√†ng!");
    
    // QUAN TR·ªåNG: Ki·ªÉm tra xem c√≥ ID ƒë∆°n h√†ng kh√¥ng?
    // Code hi·ªÉn th·ªã d√πng .id, n√™n ·ªü ƒë√¢y ph·∫£i d√πng .id
    var bookingId = pendingBedOrder.id || pendingBedOrder.key; 
    
    if (!bookingId) {
        console.error("L·ªói: Kh√¥ng t√¨m th·∫•y ID ƒë∆°n h√†ng", pendingBedOrder);
        return alert("L·ªói d·ªØ li·ªáu: Kh√¥ng t√¨m th·∫•y m√£ ƒë∆°n h√†ng. Vui l√≤ng F5 v√† th·ª≠ l·∫°i.");
    }

    // 2. Ki·ªÉm tra xem Bed ƒë√≥ c√≥ ƒëang b·∫≠n kh√¥ng
    // (L·ªçc trong danh s√°ch hi·ªán t·∫°i ƒë·ªÉ xem Bed X ƒë√£ c√≥ ai Active ch∆∞a)
    const isBusy = currentBedList.find(b => 
        (b.status && (b.status.includes('active') || b.status.includes('ƒëang d√πng'))) 
        && b.bedId == bedId
    );

    if (isBusy) return alert("Bed " + bedId + " ƒëang c√≥ kh√°ch r·ªìi!");

    // 3. X·ª≠ l√Ω c·∫≠p nh·∫≠t
    document.getElementById('bed-select-modal').classList.add('hidden');
    document.getElementById('loading-overlay').style.display = 'flex';

    // 4. GHI ƒê√à V√ÄO ƒê√öNG ID C≈® (Update)
    // Tuy·ªát ƒë·ªëi kh√¥ng d√πng .push() ·ªü ƒë√¢y
    db.ref('bedBookings/' + bookingId).update({
        status: 'active',   // Chuy·ªÉn tr·∫°ng th√°i sang Active
        bedId: bedId,       // G√°n s·ªë Bed
        checkInTime: new Date().toLocaleTimeString('en-GB') // L∆∞u gi·ªù v√†o th·ª±c t·∫ø
    }, (err) => {
        document.getElementById('loading-overlay').style.display = 'none';
        
        if (!err) {
            // Reset bi·∫øn t·∫°m
            pendingBedOrder = null;
            isPaymentMode = false;
            
            // T·∫£i l·∫°i danh s√°ch ƒë·ªÉ th·∫•y k·∫øt qu·∫£
            // L√∫c n√†y √¥ng Nguyen Van A s·∫Ω nh·∫£y t·ª´ "Ch·ªù x·∫øp" sang "Bed X"
            openBedManager(); 
        } else {
            alert("L·ªói Firebase: " + err.message);
        }
    });
}
function openBookingModal() { document.getElementById('modal-add-booking').classList.remove('hidden'); document.getElementById('new_cust_name').value = "Kh√°ch v√£ng lai"; document.getElementById('new_cust_phone').value = ""; document.getElementById('new_cust_phone').focus(); switchTimeMode('duration'); }
function closeBookingModal() { document.getElementById('modal-add-booking').classList.add('hidden'); }
// --- [FIXED] AUTO FILL (BAO G·ªíM C·∫¢ NG∆Ø·ªúI ƒêI C√ôNG) ---
function autoFillCustomer() {
    // 1. L·∫•y SƒêT
    var phoneInput = document.getElementById('new_cust_phone');
    var phone = phoneInput.value.toString().trim();

    if (!phone || phone.length < 3) return;

    // 2. Tra c·ª©u trong RAM (bi·∫øn customerMap to√†n c·ª•c)
    var key = normalizePhone(phone);
    var customer = customerMap[key];

    // L·∫•y c√°c √¥ nh·∫≠p li·ªáu
    var elName = document.getElementById('new_cust_name');
    var elCompName = document.getElementById('new_comp_name');
    var elCompPhone = document.getElementById('new_comp_phone');

    if (customer) {
        // --- T√åM TH·∫§Y ---
        
        // ƒêi·ªÅn t√™n kh√°ch
        elName.value = customer.name || "";
        
        // [FIX] ƒêI·ªÄN TH√îNG TIN B·∫†N ƒêI C√ôNG (L·∫•y t·ª´ lastCompName)
        if(elCompName) elCompName.value = customer.lastCompName || "";
        if(elCompPhone) elCompPhone.value = customer.lastCompPhone || "";

        // Hi·ªáu ·ª©ng b√°o hi·ªáu
        elName.classList.add('bg-green-50', 'text-green-700');
        setTimeout(() => elName.classList.remove('bg-green-50', 'text-green-700'), 1000);
        
        console.log("Auto-fill OK:", customer.name, "ƒêi c√πng:", customer.lastCompName);
    } else {
        // Kh√¥ng t√¨m th·∫•y th√¨ th√¥i, kh√¥ng x√≥a (ƒë·ªÉ nh√¢n vi√™n nh·∫≠p m·ªõi)
    }
}
// --- H√ÄM T·∫†O L·ªäCH BED M·ªöI (ƒê√É FIX ƒê∆Ø·ªúNG D·∫™N + NG√ÄY GI·ªú) ---
// --- H√ÄM T·∫†O L·ªäCH BED M·ªöI (CHU·∫®N C√ö PH√ÅP) ---
// --- H√ÄM T·∫†O L·ªäCH M·ªöI (ƒê√É KH·ªöP V·ªöI GIAO DI·ªÜN IOS) ---
// --- H√ÄM T·∫†O L·ªäCH M·ªöI (ƒê√É FIX L·ªñI TR√ôNG BI·∫æN 'NOW') ---
// --- [FIXED] T·∫†O L·ªäCH + L∆ØU TH√îNG TIN B·∫†N ƒêI C√ôNG ---
function submitNewBooking() {
    // 1. L·∫•y th√¥ng tin
    var phone = document.getElementById('new_cust_phone').value;
    var name = document.getElementById('new_cust_name').value;
    var compName = document.getElementById('new_comp_name').value;
    var compPhone = document.getElementById('new_comp_phone').value;

    if (!phone || !name) return alert("Vui l√≤ng nh·∫≠p SƒêT v√† T√™n!");

    // 2. T√≠nh th·ªùi gian (Logic gi·ªØ nguy√™n)
    var durationMinutes = 60; 
    var now = new Date(); 
    var boxDur = document.getElementById('mode-duration-box');
    
    if (boxDur && !boxDur.classList.contains('hidden')) {
        durationMinutes = (typeof selectedDurationHours !== 'undefined' ? selectedDurationHours : 1) * 60;
    } else {
        var timeStr = document.getElementById('manual-end-time').value;
        if (!timeStr) return alert("Vui l√≤ng ch·ªçn gi·ªù v·ªÅ!");
        var parts = timeStr.split(':');
        var end = new Date(); 
        end.setHours(parseInt(parts[0]), parseInt(parts[1]), 0);
        if (end <= now) return alert("Gi·ªù v·ªÅ ph·∫£i l·ªõn h∆°n gi·ªù hi·ªán t·∫°i!");
        durationMinutes = Math.floor((end - now) / 60000);
    }

    var btn = document.querySelector('button[onclick="submitNewBooking()"]');
    if(btn) { btn.innerHTML = "‚è≥ ƒêang t·∫°o..."; btn.disabled = true; }

    const dateStr = now.toLocaleDateString('en-GB'); 
    const startStr = now.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
    const endObj = new Date(now.getTime() + durationMinutes * 60000);
    const endStr = endObj.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});

    // 3. [FIX QUAN TR·ªåNG] C·∫¨P NH·∫¨T H·ªí S∆† KH√ÅCH H√ÄNG (L∆ØU B·∫†N ƒêI C√ôNG)
    // ƒê·ªÉ l·∫ßn sau nh·∫≠p SƒêT n√†y n√≥ s·∫Ω t·ª± hi·ªán b·∫°n ƒëi c√πng c≈©
    let cleanPhone = normalizePhone(phone);
    if(cleanPhone) {
        db.ref('customers/' + cleanPhone).update({
            name: name,
            lastVisit: new Date().toISOString(),
            // L∆∞u th√¥ng tin ng∆∞·ªùi ƒëi c√πng v√†o h·ªì s∆° kh√°ch
            lastCompName: compName, 
            lastCompPhone: compPhone
        });
    }

    // 4. G·ª≠i ƒë∆°n Bed l√™n Firebase
    db.ref('bedBookings').push({
        phone: phone,
        name: name,
        date: dateStr,
        start: startStr,
        end: endStr,
        compName: compName,
        compPhone: compPhone,
        status: "ch·ªù kh√°ch",
        bedId: "",
        type: "walk-in"
    }, (err) => {
        if(btn) { btn.innerHTML = "T·∫†O L·ªäCH & CH·ªú X·∫æP"; btn.disabled = false; }
        
        if (!err) {
            closeBookingModal(); 
            openBedManager();    
        } else {
            alert("L·ªói: " + err.message);
        }
    });
}
function submitWalkIn() { var phone = normalizePhone(document.getElementById('walkin-phone').value); var hours = document.getElementById('walkin-hours').value; if(!phone || !hours) return; document.getElementById('walk-in-modal').classList.add('hidden'); document.getElementById('loading-overlay').style.display = 'flex'; db.ref('beds').push({ phone: phone, name: "Kh√°ch v√£ng lai", duration: hours*60, type: "walk-in", status: "ch·ªù kh√°ch" }); document.getElementById('loading-overlay').style.display = 'none'; openBedManager(); }
function checkSdtLive() {
    // 1. L·∫•y gi√° tr·ªã t·ª´ √¥ input
    const sdtInput = document.getElementById('kh-sdt');
    const sdt = sdtInput.value.toString().trim(); // X√≥a kho·∫£ng tr·∫Øng th·ª´a cho ch·∫Øc
    const status = document.getElementById('sdt-status');

    // 2. Reset n·∫øu x√≥a tr·∫Øng ho·∫∑c ch∆∞a ƒë·ªß s·ªë
    if (sdt.length < 3) { // ƒê·ªÉ 3 ho·∫∑c 10 t√πy b·∫°n, th∆∞·ªùng reset s·ªõm cho ƒë·∫πp
        status.innerText = "";
        return;
    }

    // 3. KI·ªÇM TRA TRONG RAM (Si√™u nhanh, kh√¥ng c·∫ßn g·ªçi db.ref n·ªØa)
    // V√¨ key c·ªßa customerMap ch√≠nh l√† SƒêT, ta ch·ªâ c·∫ßn "nh·∫∑t" n√≥ ra
    const m = customerMap[sdt];

    if (m) {
        // --- T√åM TH·∫§Y ---
        // L∆∞u √Ω: m ch√≠nh l√† object {name: "...", points: ...} lu√¥n, kh√¥ng c·∫ßn Object.values g√¨ c·∫£
        status.innerText = "‚òÖ TH√ÄNH VI√äN: " + m.name;
        status.className = "text-[8px] font-black text-green-500 uppercase mt-1 text-center";
    } else {
        // --- KH√îNG T√åM TH·∫§Y ---
        // Ch·ªâ b√°o kh√°ch m·ªõi khi ƒë√£ nh·∫≠p ƒë·ªß d√†i (v√≠ d·ª• 10 s·ªë) ƒë·ªÉ ƒë·ª° nh√°y lo·∫°n x·∫°
        if (sdt.length >= 10) {
            status.innerText = "‚òÖ KH√ÅCH M·ªöI";
            status.className = "text-[8px] font-black text-amber-500 uppercase mt-1 text-center";
        } else {
            status.innerText = ""; // Ch∆∞a nh·∫≠p xong th√¨ ch∆∞a b√°o g√¨
        }
    }
}
function showAppModal(title, msg, icon = '') { document.getElementById('app-modal-title').innerText = title; document.getElementById('app-modal-msg').innerHTML = msg; document.getElementById('app-modal-icon').innerText = icon; document.getElementById('app-modal').classList.remove('hidden'); }
function parseTimeObj(timeStr) { if (!timeStr) return null; var d = new Date(); var parts = timeStr.split(':'); d.setHours(parseInt(parts[0]), parseInt(parts[1]), 0, 0); return d; }
function startPanelCountdown(endTimeStr) { stopPanelCountdown(); var clockEl = document.getElementById('detail-countdown'); if(!clockEl) return; var timeParts = endTimeStr.split(':'); if(timeParts.length < 2) return; var endDate = new Date(); endDate.setHours(parseInt(timeParts[0]), parseInt(timeParts[1]), 0); bedCountdownInterval = setInterval(function() { var diff = endDate - new Date(); var isOver = diff < 0; diff = Math.abs(diff); var h = Math.floor(diff / 3600000); var m = Math.floor((diff % 3600000) / 60000); var s = Math.floor((diff % 60000) / 1000); var fmt = v => v < 10 ? "0"+v : v; clockEl.innerText = (isOver ? '-' : '') + fmt(h) + ":" + fmt(m) + ":" + fmt(s); clockEl.className = isOver ? "text-3xl font-black text-red-500 font-mono tracking-tighter" : "text-3xl font-black text-[#006241] font-mono tracking-tighter"; }, 1000); }
function stopPanelCountdown() { if (bedCountdownInterval) clearInterval(bedCountdownInterval); }
function switchTimeMode(mode) { var btnDur = document.getElementById('tab-duration'); var btnFix = document.getElementById('tab-fixed'); var divDur = document.getElementById('mode-duration'); var divFix = document.getElementById('mode-fixed'); if (mode === 'duration') { btnDur.className = "flex-1 py-1.5 text-xs font-bold rounded-md bg-white shadow-sm text-[#006241]"; btnFix.className = "flex-1 py-1.5 text-xs font-bold rounded-md text-gray-400 hover:bg-white/50"; divDur.classList.remove('hidden'); divFix.classList.add('hidden'); document.getElementById('final_duration_minutes').value = 60; } else { btnFix.className = "flex-1 py-1.5 text-xs font-bold rounded-md bg-white shadow-sm text-[#006241]"; btnDur.className = "flex-1 py-1.5 text-xs font-bold rounded-md text-gray-400 hover:bg-white/50"; divFix.classList.remove('hidden'); divDur.classList.add('hidden'); var now = new Date(); now.setMinutes(now.getMinutes() + 90); var hh = ("0" + now.getHours()).slice(-2); var mm = ("0" + now.getMinutes()).slice(-2); document.getElementById('custom_end_time').value = `${hh}:${mm}`; calculateDurationFromTime(); } }
function calculateDurationFromTime() { var timeStr = document.getElementById('custom_end_time').value; if (!timeStr) return; var now = new Date(); var parts = timeStr.split(':'); var end = new Date(); end.setHours(parseInt(parts[0]), parseInt(parts[1]), 0); var diffMins = Math.floor((end - now) / 60000); if (diffMins <= 0) { document.getElementById('calculated-time-hint').innerText = "‚ö†Ô∏è Gi·ªù v·ªÅ ph·∫£i sau gi·ªù hi·ªán t·∫°i"; document.getElementById('final_duration_minutes').value = 0; } else { document.getElementById('calculated-time-hint').innerText = `T·ªïng c·ªông: ${Math.floor(diffMins/60)}h ${diffMins%60}p`; document.getElementById('final_duration_minutes').value = diffMins; } }
// ================= CUSTOMER LOOKUP =================

function normalizePhone(p){
    return String(p || "").replace(/[^0-9]/g, "");
}

function findCustomerByPhone(phone){
    const key = normalizePhone(phone);
    if(!key) return null;
    return customerMap[key] || null;
}

function checkCustomer(){
    const input = document.getElementById("walkin-phone");
    if(!input) return;

    const sdt = normalizePhone(input.value);
    const label = document.getElementById("sdt-status");

    if(!sdt){
        if(label) label.innerText = "";
        return;
    }

    const c = findCustomerByPhone(sdt);
    if(c){
        if(label){
            label.innerText = `‚úî ${c.name} ‚Äî ${c.points} ƒëi·ªÉm`;
            label.style.color = "#22c55e";
        }
    }else{
        if(label){
            label.innerText = "Kh√°ch m·ªõi";
            label.style.color = "#aaa";
        }
    }
}
// --- LOGIC GIAO DI·ªÜN MODAL CHECK-IN M·ªöI ---
// 2. Logic Ch·ªçn Gi·ªù (T√°ch bi·ªát ƒë·ªÉ kh√¥ng ƒë·ª•ng PC)
let selectedDurationHours = 1; // M·∫∑c ƒë·ªãnh

function toggleTimeMode(mode) {
    const tabDur = document.getElementById('tab-duration');
    const tabEnd = document.getElementById('tab-end-time');
    const boxDur = document.getElementById('mode-duration-box');
    const boxEnd = document.getElementById('mode-endtime-box');

    if (mode === 'duration') {
        if(tabDur) tabDur.className = "flex-1 py-2 text-xs font-bold rounded-lg shadow-sm bg-white text-[#006241] transition-all";
        if(tabEnd) tabEnd.className = "flex-1 py-2 text-xs font-bold rounded-lg text-gray-500 hover:bg-gray-200 transition-all";
        if(boxDur) boxDur.classList.remove('hidden');
        if(boxEnd) boxEnd.classList.add('hidden');
        // Reset v·ªÅ m·∫∑c ƒë·ªãnh
        if(document.getElementById('final_duration_minutes')) document.getElementById('final_duration_minutes').value = 60;
    } else {
        if(tabEnd) tabEnd.className = "flex-1 py-2 text-xs font-bold rounded-lg shadow-sm bg-white text-[#006241] transition-all";
        if(tabDur) tabDur.className = "flex-1 py-2 text-xs font-bold rounded-lg text-gray-500 hover:bg-gray-200 transition-all";
        if(boxEnd) boxEnd.classList.remove('hidden');
        if(boxDur) boxDur.classList.add('hidden');
        
        // Auto set gi·ªù g·ª£i √Ω (Hi·ªán t·∫°i + 90p)
        var now = new Date();
        now.setMinutes(now.getMinutes() + 90);
        var hh = ("0" + now.getHours()).slice(-2);
        var mm = ("0" + now.getMinutes()).slice(-2);
        var timeInput = document.getElementById('custom_end_time') || document.getElementById('manual-end-time');
        if(timeInput) {
            timeInput.value = `${hh}:${mm}`;
            if(typeof calculateDurationFromTime === 'function') calculateDurationFromTime();
        }
    }
}


    // --- H√ÄM X·ª¨ L√ù H·ª¶Y THEO L√ù DO ---
function submitCancelBooking(type) {
    var bookingId = window.pendingCancelId;
    if (!bookingId) return;

    var reasonText = "";
    if (type === 'customer') reasonText = "Kh√°ch b√°o h·ªßy";
    else if (type === 'store') reasonText = "The cafe 33 h·ªßy (System)";

    // ƒê√≥ng modal
    document.getElementById('modal-cancel-reason').classList.add('hidden');
    document.getElementById('loading-overlay').style.display = 'flex';

    // C·∫≠p nh·∫≠t Firebase
    db.ref('bedBookings/' + bookingId).update({
        status: 'ƒë√£ h·ªßy',
        cancelType: type, // L∆∞u lo·∫°i: 'customer' ho·∫∑c 'store'
        note: reasonText
    }, (err) => {
        document.getElementById('loading-overlay').style.display = 'none';
        if (!err) {
            openBedManager(); // Load l·∫°i danh s√°ch
        } else {
            alert("L·ªói: " + err.message);
        }
    });
}
    // =========================================================
// X·ª¨ L√ù TR·∫¢ BED & T√çNH PH√ç L·ªê GI·ªú (TH√îNG MINH)
// =========================================================
// --- [FIX] X·ª¨ L√ù TR·∫¢ BED & L∆ØU DOANH THU ---
// --- BI·∫æN T·∫†M L∆ØU D·ªÆ LI·ªÜU CHECKOUT ---
let tempCheckoutData = null;

// --- [REPLACE] H√ÄM CHECKOUT M·ªöI (M·ªû POPUP SMART) ---
function handleBedCheckout(booking) {
    if (!booking) return;
    
    // 1. T√≠nh to√°n d·ªØ li·ªáu
    const now = new Date();
    let endParts = booking.end.split(':');
    let endTime = new Date();
    endTime.setHours(parseInt(endParts[0]), parseInt(endParts[1]), 0);
    
    // T√≠nh ph√∫t l·ªë
    let diffMinutes = Math.floor((now - endTime) / 60000);
    
    // T√≠nh s·ªë gi·ªù ƒë√£ tr·∫£ tr∆∞·ªõc ƒë√≥ (ƒë·ªÉ bi·∫øt ph·∫°t t·ª´ gi·ªù th·ª© m·∫•y)
    let startParts = booking.start.split(':');
    let startTime = new Date();
    startTime.setHours(parseInt(startParts[0]), parseInt(startParts[1]), 0);
    let bookedMinutes = (endTime - startTime) / 60000;
    let paidHours = Math.ceil(bookedMinutes / 60);

    // L∆∞u v√†o bi·∫øn t·∫°m ƒë·ªÉ c√°c n√∫t con s·ª≠ d·ª•ng
    tempCheckoutData = {
        booking: booking,
        diffMinutes: diffMinutes,
        paidHours: paidHours,
        extraHoursQty: (diffMinutes > 5) ? Math.ceil(diffMinutes / 60) : 0
    };

    // 2. ƒêi·ªÅn th√¥ng tin v√†o Popup
    document.getElementById('sco-bed-name').innerText = `BED 0${booking.bedId}`;
    document.getElementById('sco-customer').innerText = booking.name || "Kh√°ch l·∫ª";
    
    const otEl = document.getElementById('sco-overtime');
    const feeEl = document.getElementById('sco-fee');

    if (diffMinutes > 5) {
        otEl.innerText = `${diffMinutes} ph√∫t`;
        otEl.className = "text-2xl font-black text-red-500";
        feeEl.innerText = `+ ${tempCheckoutData.extraHoursQty} gi·ªù`;
    } else {
        otEl.innerText = "ƒê√∫ng gi·ªù";
        otEl.className = "text-2xl font-black text-green-500";
        feeEl.innerText = "0 gi·ªù";
    }

    // 3. Hi·ªÉn th·ªã Popup (Animation)
    const modal = document.getElementById('modal-smart-checkout');
    modal.classList.remove('hidden');
    setTimeout(() => {
        modal.classList.remove('opacity-0', 'scale-95');
        modal.classList.add('opacity-100', 'scale-100');
    }, 10);
}

// --- C√ÅC H√ÄM X·ª¨ L√ù L·ª∞A CH·ªåN ---

// 1. T√çNH PH√ç T·ª∞ ƒê·ªòNG (Logic c≈©)
function confirmCheckoutAuto() {
    if(!tempCheckoutData) return;
    const { booking, extraHoursQty, paidHours } = tempCheckoutData;

    closeSmartCheckout(); // ƒê√≥ng popup

    // N·∫øu c√≥ l·ªë gi·ªù -> Ch·∫°y v√≤ng l·∫∑p th√™m m√≥n
    if (extraHoursQty > 0) {
        for (let i = 1; i <= extraHoursQty; i++) {
            let currentHourIndex = paidHours + i;
            if (currentHourIndex <= 4) autoAddMenuItemToCart("1h bed"); 
            else autoAddMenuItemToCart("1h bed t·ª´ h5");
        }
        showAppModal("ƒê√£ c·ªông ti·ªÅn", `H·ªá th·ªëng ƒë√£ t·ª± ƒë·ªông th√™m ${extraHoursQty}h v√†o h√≥a ƒë∆°n.`, "ü§ñ");
    }

    // Chuy·ªÉn sang thanh to√°n
    proceedToCheckoutFlow(booking);
}

// 2. T·ª∞ CH·ªåN PH√ç (Ch·ªâ chuy·ªÉn m√†n h√¨nh, kh√¥ng c·ªông g√¨ c·∫£)
function confirmCheckoutManual() {
    if(!tempCheckoutData) return;
    closeSmartCheckout();
    
    // Ch·ªâ chuy·ªÉn trang, nh√¢n vi√™n t·ª± b·∫•m m√≥n ph·∫°t n·∫øu mu·ªën
    proceedToCheckoutFlow(tempCheckoutData.booking);
}

// 3. KH√îNG T√çNH PH√ç (Checkout ngay l·∫≠p t·ª©c)
function confirmCheckoutFree() {
    if(!tempCheckoutData) return;
    const { booking } = tempCheckoutData;
    
    closeSmartCheckout();

    // G·ªçi th·∫≥ng h√†m ƒë√≥ng Bed v√† t√≠nh ti·ªÅn Session (B·ªè qua b∆∞·ªõc v√†o Menu thanh to√°n)
    // L∆∞u √Ω: H√†m n√†y s·∫Ω t√≠nh t·ªïng ti·ªÅn c√°c m√≥n ƒê√É G·ªåI tr∆∞·ªõc ƒë√≥, kh√¥ng c·ªông th√™m gi·ªù l·ªë
    let realTimeStr = new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
    calculateAndSaveCheckout(booking, realTimeStr);
}

// --- H√ÄM PH·ª§ TR·ª¢ CHUNG ---
function closeSmartCheckout() {
    const modal = document.getElementById('modal-smart-checkout');
    modal.classList.remove('opacity-100', 'scale-100');
    modal.classList.add('opacity-0', 'scale-95');
    setTimeout(() => modal.classList.add('hidden'), 300);
}

function proceedToCheckoutFlow(booking) {
    // Set bi·∫øn to√†n c·ª•c ƒë·ªÉ h·ªá th·ªëng bi·∫øt ƒëang trong lu·ªìng tr·∫£ Bed
    activeOrderingBedId = booking.bedId;
    pendingBedOrder = booking; 
    isCheckoutFlow = true; 
    
    // ƒêi·ªÅn SƒêT v√†o gi·ªè
    var sdtInput = document.getElementById('kh-sdt');
    if (sdtInput && booking.phone) {
        sdtInput.value = booking.phone;
        if (typeof checkSdtLive === 'function') checkSdtLive();
    }
    
    // Chuy·ªÉn view
    switchView('menu');
}
// [H√ÄM M·ªöI] T√≠nh t·ªïng ti·ªÅn v√† L∆∞u v√†o Firebase
function calculateAndSaveCheckout(booking, realTimeStr) {
    let btnCheckout = document.getElementById('btn-action-checkout');
    if(btnCheckout) btnCheckout.innerHTML = 'ƒêang t√≠nh ti·ªÅn...';

    // G·ªçi h√†m t√≠nh ti·ªÅn session
    calculateSessionSpend(booking.phone, booking.start, realTimeStr).then(total => {
        
        let bookingId = booking.id || booking.key;
        
        // C·∫≠p nh·∫≠t Firebase v·ªõi ƒë·∫ßy ƒë·ªß th√¥ng tin: Tr·∫°ng th√°i, Gi·ªù ra, T·ªîNG TI·ªÄN
        db.ref('bedBookings/' + bookingId).update({
            status: 'ƒë√£ xong',
            realEndTime: realTimeStr,
            totalSpend: total // <--- QUAN TR·ªåNG: L∆∞u c√°i n√†y ƒë·ªÉ B√°o c√°o ƒë·ªçc ƒë∆∞·ª£c
        }, (err) => { 
            if(!err) {
                openBedManager(); 
                // C√≥ th·ªÉ show toast th√¥ng b√°o doanh thu session n√†y
                // alert(`ƒê√£ tr·∫£ Bed. Doanh thu: ${total.toLocaleString()}ƒë`);
            }
            else {
                alert("L·ªói: " + err.message);
                if(btnCheckout) btnCheckout.innerHTML = '<span>üèÅ Tr·∫£ Bed</span>';
            }
        });
    });
}

// H√†m processCheckoutFirebase c≈© c√≥ th·ªÉ x√≥a ho·∫∑c ƒë·ªÉ ƒë√≥ kh√¥ng d√πng t·ªõi n·ªØa

// H√†m ph·ª•: T√¨m m√≥n trong menu v√† n√©m v√†o gi·ªè
function autoAddMenuItemToCart(itemName) {
    // T√¨m m√≥n trong m·∫£ng menu to√†n c·ª•c
    // (L∆∞u √Ω: So s√°nh ch·ªØ th∆∞·ªùng ƒë·ªÉ tr√°nh l·ªói vi·∫øt hoa/th∆∞·ªùng)
    const item = menu.find(m => m.name.toLowerCase() === itemName.toLowerCase());
    
    if (item) {
        // N·∫øu th·∫•y -> Th√™m v√†o gi·ªè (d√πng h√†m addToCart c√≥ s·∫µn c·ªßa b√†)
        // item.priceM ho·∫∑c priceL tu·ª≥ b√† set trong menu, ·ªü ƒë√¢y tui l·∫•y ƒë·∫°i priceM
        let price = item.priceM > 0 ? item.priceM : item.priceL;
        addToCart(item.name, 'M', price); 
    } else {
        console.warn(`Kh√¥ng t√¨m th·∫•y m√≥n "${itemName}" trong Menu! Ki·ªÉm tra l·∫°i t√™n m√≥n.`);
    }
}

// H√†m ph·ª•: G·ªçi Firebase checkout (T√°ch ra t·ª´ code c≈© cho g·ªçn)
function processCheckoutFirebase(booking) {
    let btnCheckout = document.getElementById('btn-action-checkout');
    if(btnCheckout) btnCheckout.innerHTML = 'Wait...';
    
    let bookingId = booking.id || booking.key;
    
    db.ref('bedBookings/' + bookingId).update({
        status: 'ƒë√£ xong',
        realEndTime: new Date().toLocaleTimeString('en-GB')
    }, (err) => { 
        if(!err) openBedManager(); 
        else {
            alert("L·ªói: " + err.message);
            if(btnCheckout) btnCheckout.innerHTML = '<span>üèÅ Tr·∫£ Bed</span>';
        }
    }); 
}
// --- H√ÄM V·∫º N√öT CH·ªåN BED (KH√îI PH·ª§C) ---
// --- H√ÄM V·∫º N√öT CH·ªåN BED (PHI√äN B·∫¢N IOS PREMIUM) ---
// --- H√ÄM V·∫º N√öT CH·ªåN BED (LAYOUT CHU·∫®N: 1 TR√äN 2, 3 B√äN PH·∫¢I 1) ---
// --- M√ÄU M·ªöI: T∆Ø∆†I T·∫ÆN H∆†N  ---
// --- H√ÄM V·∫º N√öT CH·ªåN BED (STYLE: N·ªÄN TR·∫ÆNG - CH·ªÆ XANH T∆Ø∆†I #006241) ---
function renderBedSelection() {
    var container = document.getElementById('bed-selection-container');
    if (!container) return;
    
    container.innerHTML = ""; // X√≥a tr·∫Øng c≈©

    // Th·ª© t·ª± v·∫Ω: 1 -> 3 -> 2 -> 4 (C·ªôt tr√°i: 1 tr√™n 2, C·ªôt ph·∫£i: 3 tr√™n 4)
    var orderMap = [1, 3, 2, 4];

    orderMap.forEach(i => {
        // Ki·ªÉm tra tr·∫°ng th√°i Bed
        var isBusy = currentBedList.find(b => 
            b.bedId == i && b.status && (b.status.includes('active') || b.status.includes('ƒëang d√πng'))
        );

        var btnHTML = "";

        if (isBusy) {
            // === TR·∫†NG TH√ÅI B·∫¨N (X√°m nh·∫°t) ===
            btnHTML = `
            <div class="relative w-full h-full">
                <button disabled class="w-full h-full bg-[#F3F4F6] rounded-2xl p-3 flex flex-col items-center justify-center border border-gray-200 cursor-not-allowed opacity-60 grayscale transition-all">
                    <div class="w-10 h-10 bg-gray-200 text-gray-400 rounded-full flex items-center justify-center mb-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                    </div>
                    <span class="font-bold text-gray-400 text-sm">BED 0${i}</span>
                    <span class="text-[9px] text-gray-400 font-bold uppercase tracking-wider bg-gray-200 px-2 py-0.5 rounded-full mt-1">ƒêang b·∫≠n</span>
                </button>
            </div>
            `;
        } else {
            // === TR·∫†NG TH√ÅI TR·ªêNG (N·ªÄN TR·∫ÆNG - CH·ªÆ XANH T∆Ø∆†I #006241) ===
            btnHTML = `
            <button onclick="finalizeBedCheckIn(${i})" class="w-full h-full bg-white rounded-2xl p-3 flex flex-col items-center justify-center shadow-[0_4px_15px_rgba(0,0,0,0.05)] border-2 border-transparent hover:border-[#006241]/30 active:scale-[0.97] active:shadow-sm transition-all duration-200 group relative overflow-hidden">
                
                <div class="absolute inset-0 bg-[#006241] opacity-0 group-hover:opacity-[0.03] transition-opacity"></div>
                
                <div class="w-11 h-11 bg-[#E6F4F1] text-[#006241] rounded-full flex items-center justify-center mb-1 shadow-sm group-hover:scale-110 transition-transform duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                </div>
                
                <span class="font-black text-[#006241] text-lg group-hover:text-[#004f32] transition-colors">BED 0${i}</span>
                
                <span class="text-[9px] text-[#006241] font-bold uppercase tracking-wider bg-[#E6F4F1] px-2.5 py-0.5 rounded-full mt-1">
                    S·∫µn s√†ng
                </span>
            </button>
            `;
        }

        container.innerHTML += btnHTML;
    });
}
// --- H√ÄM T√çNH T·ªîNG CHI TI√äU C·ª¶A 1 L·∫¶N BED ---
// --- H√ÄM T√çNH TI·ªÄN (CHU·∫®N X√ÅC THEO KHUNG GI·ªú) ---
function calculateSessionSpend(phone, startTimeStr, endTimeStr) {
    return new Promise((resolve) => {
        if (!startTimeStr || !endTimeStr) { resolve(0); return; }

        // 1. T·∫°o ƒë·ªëi t∆∞·ª£ng Date cho Start/End (Gi·∫£ ƒë·ªãnh l√† h√¥m nay ho·∫∑c ng√†y trong booking)
        // V√¨ data booking c√≥ th·ªÉ thi·∫øu ng√†y, ta l·∫•y ng√†y hi·ªán t·∫°i l√†m m·ªëc so s√°nh gi·ªù
        var now = new Date();
        
        var startParts = startTimeStr.split(':');
        var startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(startParts[0]), parseInt(startParts[1]), 0);

        var endParts = endTimeStr.split(':');
        var endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(endParts[0]), parseInt(endParts[1]), 59); // Th√™m gi√¢y cho ch·∫Øc

        // N·∫øu qua ƒë√™m (End < Start), c·ªông th√™m 1 ng√†y cho End
        if (endDate < startDate) endDate.setDate(endDate.getDate() + 1);

        // 2. Qu√©t ƒë∆°n h√†ng
        db.ref('orders').once('value', snap => {
            let total = 0;
            if (snap.exists()) {
                const orders = snap.val();
                Object.values(orders).forEach(o => {
                    // Check SƒêT
                    if (normalizePhone(o.sdt) === normalizePhone(phone)) {
                        // Check Th·ªùi gian t·∫°o ƒë∆°n
                        var orderDate = new Date(o.createdAt);
                        
                        // Logic so s√°nh: ƒê∆°n h√†ng ph·∫£i n·∫±m TRONG kho·∫£ng Start -> End
                        // (Th√™m buffer 5 ph√∫t tr∆∞·ªõc/sau ƒë·ªÉ tr·ª´ hao sai l·ªách)
                        var bufferStart = new Date(startDate.getTime() - 5*60000); 
                        var bufferEnd = new Date(endDate.getTime() + 5*60000);

                        if (orderDate >= bufferStart && orderDate <= bufferEnd) {
                            total += Number(o.total || 0);
                        }
                    }
                });
            }
            resolve(total);
        });
    });
}

// --- H√ÄM PH·∫†T PH√ç V·ªÜ SINH (L∆ØU N·ª¢) ---
function setCleaningFee(phone, amount, bookingId) {
    if (!phone) return alert("Kh√¥ng t√¨m th·∫•y SƒêT kh√°ch!");
    
    // 1. L∆∞u n·ª£ v√†o th√¥ng tin kh√°ch h√†ng (customers/SDT/pendingFee)
    db.ref('customers/' + normalizePhone(phone)).update({
        pendingFee: amount, // S·ªë ti·ªÅn n·ª£
        pendingFeeReason: "Ph√≠ v·ªá sinh n·ªám (L·∫ßn tr∆∞·ªõc)" // L√Ω do
    }, (error) => {
        if (error) alert("L·ªói: " + error.message);
        else {
            // 2. C·∫≠p nh·∫≠t giao di·ªán b√°o ƒë√£ l∆∞u
            let statusEl = document.getElementById(`fee-status-${bookingId}`);
            if(statusEl) {
                statusEl.innerText = `ƒê√£ l∆∞u n·ª£ ${amount.toLocaleString()}ƒë cho l·∫ßn sau.`;
                statusEl.classList.remove('text-gray-400');
                statusEl.classList.add('text-green-600', 'font-bold');
            }
            
            // 3. (Tu·ª≥ ch·ªçn) ƒê√°nh d·∫•u v√†o booking c≈© l√† ƒë√£ b·ªã ph·∫°t
            db.ref('bedBookings/' + bookingId).update({
                hasPenalty: true,
                penaltyAmount: amount
            });
        }
    });
}
// =========================================================
// C√ÅC H√ÄM X·ª¨ L√ù PH√ç V·ªÜ SINH (B·ªä THI·∫æU)
// =========================================================

// Bi·∫øn t·∫°m ƒë·ªÉ nh·ªõ ƒëang ph·∫°t ai
var pendingFeePhone = "";
var pendingFeeBookingId = "";

// 1. H√†m m·ªü Modal ch·ªçn ph√≠ (ƒê∆∞·ª£c g·ªçi khi b·∫•m n√∫t ch·ªïi/v·ªá sinh)
function openCleaningModal(phone, bookingId) {
    console.log("M·ªü modal ph·∫°t cho:", phone); 
    pendingFeePhone = phone;
    pendingFeeBookingId = bookingId;
    
    var modal = document.getElementById('modal-cleaning-fee');
    if(modal) {
        modal.classList.remove('hidden');
        // Th√™m animation nh·∫π cho ƒë·∫πp
        modal.querySelector('div').classList.add('scale-100');
        modal.querySelector('div').classList.remove('scale-95');
    } else {
        alert("L·ªói: Kh√¥ng t√¨m th·∫•y Modal HTML ID 'modal-cleaning-fee'. Vui l√≤ng ki·ªÉm tra l·∫°i code HTML.");
    }
}

// 2. H√†m x√°c nh·∫≠n ph√≠ (ƒê∆∞·ª£c g·ªçi khi ch·ªçn 20k/30k/50k)
// --- 1. X√ÅC NH·∫¨N V√Ä G·ª¨I PH√ç (C√ì POPUP CONFIRM) ---
function submitCleaningFee(amount) {
    if (!pendingFeePhone) return;
    
    // ƒê√≥ng modal ch·ªçn ti·ªÅn tr∆∞·ªõc
    document.getElementById('modal-cleaning-fee').classList.add('hidden');
    
    // Hi·ªán Popup x√°c nh·∫≠n ki·ªÉu Apple (IOS Confirm)
    showIOSConfirm(`X√°c nh·∫≠n t√≠nh ph√≠ ${amount.toLocaleString()}ƒë cho kh√°ch n√†y?`, function() {
        setCleaningFee(pendingFeePhone, amount, pendingFeeBookingId);
    });
}

// --- 2. L∆ØU PH√ç V√ÄO FIREBASE (C·∫¨P NH·∫¨T C·∫¢ KH√ÅCH V√Ä BED) ---
function setCleaningFee(phone, amount, bookingId) {
    document.getElementById('loading-overlay').style.display = 'flex';

    // A. C·∫≠p nh·∫≠t n·ª£ cho kh√°ch h√†ng
    db.ref('customers/' + normalizePhone(phone)).update({
        pendingFee: amount, 
        pendingFeeReason: "Ph√≠ v·ªá sinh n·ªám"
    }, (error) => {
        if (error) {
            document.getElementById('loading-overlay').style.display = 'none';
            alert("L·ªói: " + error.message);
        } else {
            // B. ƒê√°nh d·∫•u v√†o Booking l√† "ƒê√£ b·ªã ph·∫°t" (ƒê·ªÉ hi·ªÉn th·ªã l·∫°i n√∫t X√≥a/S·ª≠a)
            db.ref('bedBookings/' + bookingId).update({
                hasPenalty: true,
                penaltyAmount: amount
            }, () => {
                document.getElementById('loading-overlay').style.display = 'none';
                
                // Load l·∫°i danh s√°ch ƒë·ªÉ giao di·ªán t·ª± c·∫≠p nh·∫≠t (Hi·ªán b·∫£ng th√¥ng b√°o ƒë·ªè)
                openBedManager(); 
                
                // Hi·ªán th√¥ng b√°o th√†nh c√¥ng
                setTimeout(() => {
                    showAppModal("ƒê√£ t√≠nh ph√≠!", `Kh√°ch s·∫Ω b·ªã t√≠nh th√™m ${amount.toLocaleString()}ƒë v√†o l·∫ßn thanh to√°n sau.`, "‚úÖ");
                }, 300);
            });
        }
    });
}

// --- 3. X√ìA PH√ç PH·∫†T (N√öT X√ìA) ---
function deletePenalty(phone, bookingId) {
    showIOSConfirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën X√ìA ph√≠ ph·∫°t n√†y ch·ª©?", function() {
        document.getElementById('loading-overlay').style.display = 'flex';

        // A. X√≥a n·ª£ c·ªßa kh√°ch (V·ªÅ 0)
        db.ref('customers/' + normalizePhone(phone)).update({
            pendingFee: 0, 
            pendingFeeReason: null
        });

        // B. C·∫≠p nh·∫≠t l·∫°i booking (H·ªßy c·ªù hasPenalty)
        db.ref('bedBookings/' + bookingId).update({
            hasPenalty: false,
            penaltyAmount: 0
        }, () => {
            document.getElementById('loading-overlay').style.display = 'none';
            openBedManager(); // Refresh giao di·ªán
            setTimeout(() => { showAppModal("ƒê√£ x√≥a!", "ƒê√£ h·ªßy b·ªè kho·∫£n ph√≠ v·ªá sinh.", "üóëÔ∏è"); }, 300);
        });
    });
}
// --- H√ÄM L·∫ÆNG NGHE TI·ªÄN V·ªÄ T·ª™ PAYOS (CH√àN M·ªöI) ---
// --- H√ÄM L·∫ÆNG NGHE TI·ªÄN V·ªÄ THEO M√É ƒê∆†N H√ÄNG (VI·∫æT L·∫†I) ---
function listenForPayment(code, amount) {
    // 1. D·ªçn d·∫πp c√°c l·ªánh l·∫Øng nghe c≈© n·∫øu c√≥
    if (paymentListener) {
        db.ref('payment_events/' + currentOrderCode).off();
    }

    console.log("üîç ƒêang ƒë·ª£i thanh to√°n cho m√£:", code);

    // 2. L·∫Øng nghe tr·ª±c ti·∫øp v√†o nh√°nh payment_events/[M√£_CF]
    // C√°ch n√†y gi√∫p POS kh√¥ng ph·∫£i qu√©t to√†n b·ªô danh s√°ch, ti·∫øt ki·ªám pin v√† nhanh h∆°n
    paymentListener = db.ref('payment_events/' + code).on('value', (snap) => {
        const data = snap.val();
        
        // N·∫øu t√¨m th·∫•y d·ªØ li·ªáu v√† s·ªë ti·ªÅn kh·ªõp ho·∫∑c d∆∞
        if (data && Number(data.amount) >= amount) {
            console.log("‚úÖ ƒê√£ nh·∫≠n ti·ªÅn:", code);
            // --- CH√àN D√íNG N√ÄY V√ÄO ƒê√ÇY ---
            speakSuccess(data.amount); 
            // -----------------------------

            // C·∫≠p nh·∫≠t giao di·ªán th√¥ng b√°o
            const statusEl = document.getElementById('qr-status');
            if(statusEl) {
                statusEl.innerHTML = `
                    <div class="flex flex-col items-center animate-bounce">
                        <span class="text-green-500 text-3xl">‚úÖ</span>
                        <span class="text-green-600 font-black text-sm uppercase">ƒê√£ nh·∫≠n ƒë·ªß ti·ªÅn</span>
                    </div>`;
            }

            // ƒê·ª£i 1.5 gi√¢y ƒë·ªÉ nh√¢n vi√™n k·ªãp th·∫•y d·∫•u t√≠ch xanh r·ªìi t·ª± ƒë·ªông ƒë√≥ng
            setTimeout(() => {
                document.getElementById('qr-modal')?.classList.add('hidden');
                
                // G·ªçi h√†m thanh to√°n m·∫∑c ƒë·ªãnh c·ªßa b√† ƒë·ªÉ l∆∞u ƒë∆°n v√†o Sheet/Firebase Orders
                if (typeof completeOrder === "function") {
                    completeOrder(); 
                }
            }, 1500);

            // T·∫Øt l·∫Øng nghe sau khi ƒë√£ xong vi·ªác
            db.ref('payment_events/' + code).off();
            paymentListener = null;
        }
    });
}
// --- H√ÄM HI·ªÇN TH·ªä QR V√Ä ƒê·ª¢I TI·ªÄN (CH√àN M·ªöI) ---
// --- H√ÄM T·∫†O QR D√ÄNH RI√äNG CHO GITHUB / WEB NGO√ÄI ---
// --- H√ÄM T·∫†O QR (B·∫¢N FIX L·ªñI ·∫¢NH B·ªä G√ÉY) ---
// --- H√ÄM T·∫†O QR (ƒê√É FIX: K·∫æT N·ªêI TR·ª∞C TI·∫æP FIREBASE BACKEND) ---
function showPaymentQR() {
    // 1. KI·ªÇM TRA S·ªê TI·ªÄN
    if (!currentTotal || currentTotal < 2000) {
        alert("Vui l√≤ng ch·ªçn m√≥n (T·ªëi thi·ªÉu 2.000ƒë) ƒë·ªÉ t·∫°o m√£ QR!");
        setMethod('Ti·ªÅn m·∫∑t'); 
        return;
    }

    // 2. LINK BACKEND M·ªöI (L·∫•y t·ª´ Firebase Functions c·ªßa Ti√™n sinh)
    // L∆∞u √Ω: ƒê√¢y l√† link function createPayment, kh√¥ng ph·∫£i webhook
    const API_URL = "https://us-central1-the-cafe-33.cloudfunctions.net/createPayment"; 

    // Hi·ªÉn th·ªã Popup ch·ªù
    const modal = document.getElementById('qr-modal');
    modal.classList.remove('hidden');
    
    const qrImg = document.getElementById('vietqr-img');
    const qrText = document.getElementById('qr-content');
    const statusEl = document.getElementById('qr-status');
    
    // ·∫¢nh loading
    qrImg.src = "https://i.gifer.com/ZZ5H.gif"; 
    qrText.innerText = "ƒêang t·∫°o QR...";
    statusEl.innerText = "Vui l√≤ng ƒë·ª£i gi√¢y l√°t...";

    // 3. G·ªåI SERVER FIREBASE (D√πng JSON chu·∫©n)
    fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            amount: parseInt(currentTotal) // Ch·ªâ c·∫ßn g·ª≠i s·ªë ti·ªÅn, backend t·ª± sinh m√£
        })
    })
    .then(response => response.json())
    .then(result => {
        console.log("PayOS Result:", result);
        
        if (result.status === "success") {
            // Hi·ªÉn th·ªã m√£ QR t·ª´ PayOS tr·∫£ v·ªÅ
            // D√πng api.qrserver ƒë·ªÉ ƒë·∫£m b·∫£o ·∫£nh n√©t
            qrImg.src = "https://api.qrserver.com/v1/create-qr-code/?size=400x400&margin=10&data=" + encodeURIComponent(result.qrCode);
            
            currentOrderCode = result.orderCodeFull; // L∆∞u m√£ ƒë∆°n: CF123456...
            qrText.innerText = currentOrderCode; 
            statusEl.innerHTML = '<b class="text-amber-500 animate-pulse">ƒêang ch·ªù thanh to√°n...</b>';
            
            // B·∫Øt ƒë·∫ßu l·∫Øng nghe Firebase Realtime Database
            listenForPayment(result.orderCodeFull, currentTotal);
        } else {
            alert("L·ªói t·ª´ PayOS: " + result.message);
            modal.classList.add('hidden');
            setMethod('Ti·ªÅn m·∫∑t');
        }
    })
    .catch(error => {
        console.error("L·ªói Fetch:", error);
        alert("L·ªói k·∫øt n·ªëi Server! Vui l√≤ng th·ª≠ l·∫°i.");
        modal.classList.add('hidden');
        setMethod('Ti·ªÅn m·∫∑t');
    });
}
// --- H√ÄM ƒê·ªåC √ÇM THANH KHI NH·∫¨N TI·ªÄN ---
function speakSuccess(amount) {
    // 1. So·∫°n n·ªôi dung c·∫ßn ƒë·ªçc
    // D√πng toLocaleString('vi-VN') ƒë·ªÉ n√≥ ƒë·ªçc l√† "NƒÉm m∆∞∆°i ngh√¨n" thay v√¨ "5 kh√¥ng kh√¥ng..."
    var textToRead = "The Cafe 33 ƒë√£ nh·∫≠n " + Number(amount).toLocaleString('vi-VN') + " ƒë·ªìng. C·∫£m ∆°n nh√≥!";
    
    // 2. C·∫•u h√¨nh gi·ªçng ƒë·ªçc
    var msg = new SpeechSynthesisUtterance();
    msg.text = textToRead;
    msg.lang = 'vi-VN'; // Ch·ªçn gi·ªçng ti·∫øng Vi·ªát
    msg.volume = 1;     // √Çm l∆∞·ª£ng to nh·∫•t (0 -> 1)
    msg.rate = 1.1;     // T·ªëc ƒë·ªô ƒë·ªçc (1 l√† b√¨nh th∆∞·ªùng, 1.1 l√† nhanh nh·∫π vui t∆∞∆°i)
    
    // 3. Ph√°t loa
    window.speechSynthesis.speak(msg);
}
// --- BI·∫æN TO√ÄN C·ª§C ƒê·ªÇ GI·ªÆ LOA ---
let synth = window.speechSynthesis;
let soundLock = null;

// 1. H√†m ƒë·ªçc c∆° b·∫£n (Fix l·ªói gi·ªçng ch·ªã Google b·ªã k·∫πt)
function speakNow(text) {
    if (synth.speaking) synth.cancel(); // D·ª´ng c√¢u ƒëang n√≥i d·ªü

    let msg = new SpeechSynthesisUtterance(text);
    msg.lang = 'vi-VN'; 
    msg.rate = 1.1;
    msg.volume = 1.0;

    synth.speak(msg);
}

// 2. H√†m "M·ªìi loa" (G·∫Øn v√†o n√∫t Chuy·ªÉn kho·∫£n)
// M·∫πo: Ph√°t m·ªôt √¢m thanh r·ªóng li√™n t·ª•c ƒë·ªÉ tr√¨nh duy·ªát t∆∞·ªüng b√† ƒëang nghe nh·∫°c
function unlockAudio() {
    speakNow("ƒêang t·∫°o m√£ thanh to√°n"); // N√≥i c√¢u ƒë·∫ßu ti√™n ƒë·ªÉ xin quy·ªÅn
    
    // Hack: T·∫°o m·ªôt audio r·ªóng ch·∫°y n·ªÅn ƒë·ªÉ gi·ªØ k·∫øt n·ªëi loa kh√¥ng b·ªã ng·∫Øt
    if (!soundLock) {
        soundLock = new Audio("https://github.com/anars/blank-audio/raw/master/10-minutes-of-silence.mp3");
        soundLock.loop = true;
        soundLock.play().catch(e => console.log("Kh√¥ng play ƒë∆∞·ª£c audio n·ªÅn"));
    }
}

// 3. H√†m g·ªçi khi ti·ªÅn v·ªÅ
function speakSuccess(amount) {
    // D·ª´ng audio n·ªÅn l·∫°i cho ƒë·ª° t·ªën pin
    if (soundLock) {
        soundLock.pause();
        soundLock = null;
    }

    let text = "ƒê√£ nh·∫≠n " + Number(amount).toLocaleString('vi-VN') + " ƒë·ªìng. C·∫£m ∆°n!";
    speakNow(text);
}
// --- LOGIC MOBILE ---
function toggleMobileMenu() {
    const sb = document.getElementById('mobile-sidebar');
    const ol = document.getElementById('mobile-overlay');
    if (sb.classList.contains('-translate-x-full')) {
        sb.classList.remove('-translate-x-full'); ol.classList.remove('hidden');
    } else {
        sb.classList.add('-translate-x-full'); ol.classList.add('hidden');
    }
}
function toggleCartExpand() {
    if (window.innerWidth > 768) return;
    
    // Thay v√¨ m·ªü r·ªông sidebar (giao di·ªán c≈©), ta g·ªçi Modal chi ti·∫øt (Giao di·ªán m·ªõi)
    openCartModal(); 
}
// --- LOGIC CHO M√ÄN H√åNH THANH TO√ÅN MOBILE ---
function syncMobileInputs() {
    // 1. ƒê·ªìng b·ªô SƒêT
    var sdtMob = document.getElementById('pay-sdt-mobile').value;
    var sdtMain = document.getElementById('kh-sdt');
    if (sdtMain) {
        sdtMain.value = sdtMob;
        // G·ªçi h√†m ki·ªÉm tra t√™n kh√°ch c√≥ s·∫µn
        if (typeof checkSdtLive === 'function') checkSdtLive(); 
    }
    
    // Hi·ªÉn th·ªã t√™n kh√°ch ngay tr√™n mobile
    var cleanSdt = sdtMob.replace(/[^0-9]/g, '');
    var custNameEl = document.getElementById('pay-cust-name-mobile');
if (custNameEl) {
    if (customerMap[cleanSdt]) {
        custNameEl.innerHTML = `<div class="mt-3 bg-green-50 p-2 rounded-xl text-center"><span class="text-xs font-black text-green-700">‚òÖ ${customerMap[cleanSdt].name}</span></div>`;
        custNameEl.style.height = "auto"; // M·ªü r·ªông chi·ªÅu cao
    } else {
        custNameEl.innerHTML = "";
        custNameEl.style.height = "0"; // Thu g·ªçn l·∫°i
    }
}

    // 2. ƒê·ªìng b·ªô Ti·ªÅn kh√°ch ƒë∆∞a & T√≠nh ti·ªÅn th·ª´a
    var cashMob = document.getElementById('cash-paid-mobile').value;
    var cashMain = document.getElementById('cash-paid');
    
    // X·ª≠ l√Ω d·∫•u ph·∫©y (n·∫øu mu·ªën nh·∫≠p 50,000)
    var rawCash = cashMob.replace(/[^0-9]/g, '');
    
    if (cashMain) {
        cashMain.value = rawCash;
        // G·ªçi h√†m t√≠nh to√°n c≈©
        if (typeof calcChange === 'function') calcChange();
    }

    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã ti·ªÅn th·ª´a tr√™n Mobile
    var paid = Number(rawCash) || 0;
    var change = paid - currentTotal;
    var changeEl = document.getElementById('cash-change-mobile');
    if (changeEl) {
        changeEl.innerText = (change > 0 ? change.toLocaleString() : 0) + 'ƒë';
    }
}
// --- LOGIC ƒêI·ªÄU KHI·ªÇN B∆Ø·ªöC THANH TO√ÅN MOBILE ---

// 1. Chuy·ªÉn sang m√†n h√¨nh nh·∫≠p ti·ªÅn m·∫∑t (B∆∞·ªõc 2)
// 1. Chuy·ªÉn sang m√†n h√¨nh nh·∫≠p ti·ªÅn m·∫∑t (B∆∞·ªõc 2)
function goToMobileCash() {
    setMethod('Ti·ªÅn m·∫∑t'); 
    
    // ·∫®n b∆∞·ªõc 1, hi·ªán b∆∞·ªõc 2
    document.getElementById('mob-step-1').classList.add('hidden');
    document.getElementById('mob-step-2').classList.remove('hidden');
    // document.getElementById('mob-pay-title').innerText = "Thu ti·ªÅn m·∫∑t"; // C√≥ th·ªÉ b·ªè d√≤ng n√†y n·∫øu mu·ªën gi·ªØ ti√™u ƒë·ªÅ ng·∫Øn g·ªçn

    var input = document.getElementById('cash-paid-mobile');
    if(input) {
        // T·ª± ƒëi·ªÅn t·ªïng bill v√†o √¥ kh√°ch ƒë∆∞a
        input.value = currentTotal.toLocaleString('en-US'); 
        
        // T√≠nh ngay ti·ªÅn th·ª´a
        syncMobileInputs();
        
        // --- S·ª¨A L·ªñI ·ªû ƒê√ÇY ---
        // input.focus();  <-- X√ìA D√íNG N√ÄY ƒêI (N√≥ l√† th·ªß ph·∫°m g·ªçi b√†n ph√≠m)
        
        input.blur();   // <-- TH√äM D√íNG N√ÄY (Ra l·ªánh cho b√†n ph√≠m: "N·∫±m im, c·∫•m nh√∫c nh√≠ch!")
        // --------------------
    }
    
    // C·∫≠p nh·∫≠t g·ª£i √Ω ti·ªÅn
    updateSuggestions();
}

// 2. N√∫t Quay l·∫°i th√¥ng minh
function backMobileStep() {
    var step2 = document.getElementById('mob-step-2');
    
    // N·∫øu ƒëang ·ªü B∆∞·ªõc 2 (Nh·∫≠p ti·ªÅn) -> Quay v·ªÅ B∆∞·ªõc 1
    if (step2 && !step2.classList.contains('hidden')) {
        document.getElementById('mob-step-2').classList.add('hidden');
        document.getElementById('mob-step-1').classList.remove('hidden');
        document.getElementById('mob-pay-title').innerText = "Thanh to√°n";
    } else {
        // N·∫øu ƒëang ·ªü B∆∞·ªõc 1 -> Quay v·ªÅ Menu ch√≠nh
        switchView('menu');
    }
}
// --- H√ÄM L∆ØU ƒê∆†N H√ÄNG L√äN FIREBASE (T√ÅCH RI√äNG CHO CH·∫ÆC ƒÇN) ---
// --- [FIXED] H√ÄM L∆ØU ƒê∆†N H√ÄNG (KH√îI PH·ª§C LOGIC CH·ªåN BED & TR·∫¢ BED) ---
function saveOrderToFirebase(method) {
    // 1. Ki·ªÉm tra gi·ªè h√†ng
    if (!cart || cart.length === 0) return alert("Gi·ªè h√†ng ƒëang tr·ªëng!");

    const pVal = document.getElementById('cash-paid').value;
    const paid = (method === 'Chuy·ªÉn kho·∫£n') ? currentTotal : (Number(pVal) || currentTotal);
    
    // --- L∆ØU TR·∫†NG TH√ÅI TR∆Ø·ªöC KHI G·ª¨I (QUAN TR·ªåNG) ---
    // Ph·∫£i l∆∞u v√†o bi·∫øn c·ª•c b·ªô v√¨ b√™n trong callback, pendingBedOrder c√≥ th·ªÉ b·ªã null
    const currentBooking = pendingBedOrder; 
    const isCheckout = isCheckoutFlow;
    const currentBedId = (currentBooking && currentBooking.bedId) ? currentBooking.bedId : (activeOrderingBedId || "");

    // 2. Chu·∫©n b·ªã d·ªØ li·ªáu
    const orderData = {
        id: Date.now(),
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        sdt: document.getElementById('kh-sdt').value || "Kh√°ch v√£ng lai",
        items: cart.map(i => `${i.name} (${i.size}) x${i.qty}`).join(', '),
        itemsArray: cart,
        total: currentTotal,
        paid: paid,
        change: Math.max(0, paid - currentTotal),
        method: method,
        points: Math.floor(currentTotal / 1000),
        bedId: currentBedId,
        customerName: (currentBooking && currentBooking.name) ? currentBooking.name : "Kh√°ch l·∫ª"
    };

    console.log("üöÄ ƒêang ƒë·∫©y ƒë∆°n l√™n Firebase...", orderData);

    // 3. G·ª≠i l√™n Firebase
    db.ref('orders').push(orderData, (error) => {
        if (error) {
            alert("‚ùå L·ªói l∆∞u ƒë∆°n: " + error.message);
        } else {
            console.log("‚úÖ ƒê√£ l∆∞u ƒë∆°n th√†nh c√¥ng!");
            
            // D·ªçn d·∫πp gi·ªè h√†ng
            cart = [];
            renderCart();
            document.getElementById('kh-sdt').value = "";
            if(document.getElementById('qr-modal')) document.getElementById('qr-modal').classList.add('hidden');

            // --- PH√ÇN LU·ªíNG X·ª¨ L√ù SAU THANH TO√ÅN ---

            // TR∆Ø·ªúNG H·ª¢P 1: TR·∫¢ BED (CHECKOUT)
            if (isCheckout && currentBooking) {
                let bookingId = currentBooking.id || currentBooking.key;
                let realTime = new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
                
                db.ref('bedBookings/' + bookingId).update({
                    status: 'ƒë√£ xong',
                    realEndTime: realTime
                });
                
                // Reset v√† v·ªÅ trang qu·∫£n l√Ω Bed
                isCheckoutFlow = false;
                pendingBedOrder = null;
                activeOrderingBedId = null;
                
                openBedManager(); // Quay l·∫°i m√†n h√¨nh Bed ƒë·ªÉ th·∫•y k·∫øt qu·∫£
                setTimeout(() => showAppModal("Ho√†n t·∫•t", "ƒê√£ thanh to√°n v√† TR·∫¢ BED th√†nh c√¥ng!", "üèÅ"), 300);
            }
            
            // TR∆Ø·ªúNG H·ª¢P 2: KH√ÅCH M·ªöI (WAITING) -> C·∫¶N CH·ªåN BED
            else if (currentBooking && (currentBooking.bedId === "WAITING" || !currentBooking.bedId)) {
                // Kh√¥ng reset pendingBedOrder, gi·ªØ l·∫°i ƒë·ªÉ h√†m ch·ªçn bed (finalizeBedCheckIn) d√πng
                // Kh√¥ng switchView('menu') m√† m·ªü popup ngay
                
                renderBedSelection(); // V·∫Ω l·∫°i c√°c √¥ bed
                document.getElementById('bed-select-modal').classList.remove('hidden');
                
                // (Tr√™n Mobile, modal n√†y s·∫Ω hi·ªán ƒë√® l√™n giao di·ªán thanh to√°n, v·∫´n ok)
            }
            
            // TR∆Ø·ªúNG H·ª¢P 3: G·ªåI M√ìN TH√äM / MANG V·ªÄ
            else {
                // Reset h·∫øt
                pendingBedOrder = null;
                activeOrderingBedId = null;
                
                switchView('menu');
                setTimeout(() => showAppModal("Th√†nh c√¥ng", "ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c l∆∞u!", "‚úÖ"), 300);
            }
        }
    });
}
// --- H√ÄM N·ªêI V√ÄO N√öT THANH TO√ÅN TR√äN UI ---
function completeOrder() {
    // T·ª± ƒë·ªông ph√°t hi·ªán ph∆∞∆°ng th·ª©c thanh to√°n d·ª±a tr√™n UI
    let method = 'Ti·ªÅn m·∫∑t';
    
    // Ki·ªÉm tra xem n√∫t Chuy·ªÉn kho·∫£n c√≥ ƒëang ƒë∆∞·ª£c ch·ªçn kh√¥ng
    const btnBank = document.getElementById('btn-bank');
    if (btnBank && (btnBank.classList.contains('sb-green') || btnBank.classList.contains('border-[#006241]'))) {
        method = 'Chuy·ªÉn kho·∫£n';
    }

    // G·ªçi h√†m x·ª≠ l√Ω ch√≠nh
    saveOrderToFirebase(method);
}
    // Bi·∫øn to√†n c·ª•c cho thu ti·ªÅn ri√™ng
// Bi·∫øn to√†n c·ª•c cho thu ti·ªÅn ri√™ng (gi·ªØ tr·∫°ng th√°i ngay c·∫£ khi ƒë√≥ng/m·ªü modal)
let expandedCart = [];          
let selectedForPayment = new Set(); 
let paidInstances = new Set();     // Gi·ªØ global, kh√¥ng clear khi m·ªü l·∫°i

// M·ªü modal thu ti·ªÅn ri√™ng
function openSplitModal() {
    if (typeof cart === 'undefined' || !Array.isArray(cart) || cart.length === 0) {
        if (typeof showAppModal === 'function') showAppModal("Th√¥ng b√°o", "Gi·ªè h√†ng ƒëang tr·ªëng!", "‚ö†Ô∏è");
        return;
    }

    // Rebuild expandedCart M·ªñI L·∫¶N m·ªü ƒë·ªÉ sync ƒë√∫ng qty hi·ªán t·∫°i
    expandedCart = [];
    let instanceId = 0;
    cart.forEach(item => {
        let unitPrice = 0;
        if (item.size === 'L' && item.priceL !== undefined) unitPrice = item.priceL;
        else if (item.size === 'M' && item.priceM !== undefined) unitPrice = item.priceM;
        else if (item.price !== undefined) unitPrice = item.price;

        for (let i = 0; i < (item.qty || 1); i++) {
            expandedCart.push({
                name: item.name || "M√≥n kh√¥ng t√™n",
                size: item.size || "",
                price: unitPrice,
                instanceId: instanceId++
            });
        }
    });

    selectedForPayment.clear();
    renderSplitList();

    document.getElementById('split-payment-modal').classList.remove('hidden');
}

function closeSplitModal() {
    document.getElementById('split-payment-modal').classList.add('hidden');
    selectedForPayment.clear();
    hideToast();
}

// Toast nh·∫π b√™n trong modal
function showToast() {
    const toast = document.getElementById('split-toast');
    if (toast) {
        toast.classList.remove('hidden');
        setTimeout(hideToast, 2500); // T·ª± ·∫©n sau 2.5s
    }
}
function hideToast() {
    const toast = document.getElementById('split-toast');
    if (toast) toast.classList.add('hidden');
}

// Render danh s√°ch (checkbox b√™n ph·∫£i)
function renderSplitList() {
    const container = document.getElementById('split-list');
    if (!container) return;
    container.innerHTML = '';

    if (expandedCart.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 py-10 text-lg">Kh√¥ng c√≥ m√≥n n√†o</p>';
        return;
    }

    expandedCart.forEach(exItem => {
        const isPaid = paidInstances.has(exItem.instanceId);
        const checked = selectedForPayment.has(exItem.instanceId) ? 'checked' : '';
        const disabled = isPaid ? 'disabled' : '';
        const rowClass = isPaid ? 'opacity-40' : '';

        const displayPrice = (exItem.price || 0).toLocaleString();

        const rowHTML = `
        <div class="flex items-center justify-between py-4 px-5 bg-gray-50/80 backdrop-blur rounded-3xl ${rowClass} transition-all">
            <div class="flex-1">
                <p class="font-black text-xl text-gray-900">${exItem.name}</p>
                <p class="text-lg text-[#006241] font-bold">${exItem.size ? exItem.size + ' ‚Ä¢ ' + displayPrice + 'ƒë' : ''}</p>
                ${isPaid ? '<p class="text-sm text-green-600 font-black uppercase mt-2">‚úì ƒê√£ thu</p>' : ''}
            </div>
            
            <div class="flex items-center">
                <input type="checkbox" ${checked} ${disabled}
                       onchange="toggleSplitSelect(${exItem.instanceId}, this.checked)"
                       class="w-8 h-8 rounded-xl border-4 border-gray-300 accent-[#006241] focus:ring-4 focus:ring-[#006241]/20">
            </div>
        </div>`;
        container.innerHTML += rowHTML;
    });

    updateSplitTotal();
}
function toggleSplitSelect(id, checked) {
    if (checked) selectedForPayment.add(id);
    else selectedForPayment.delete(id);
    updateSplitTotal();
}

function updateSplitTotal() {
    let total = 0;
    selectedForPayment.forEach(id => {
        const item = expandedCart.find(it => it.instanceId === id);
        if (item && item.price !== undefined) total += item.price;
    });

    const totalEl = document.getElementById('split-total');
    if (totalEl) totalEl.innerText = total.toLocaleString() + 'ƒë';
    
    const btn = document.getElementById('pay-selected-btn');
    if (btn) btn.disabled = selectedForPayment.size === 0;

    const allPaid = expandedCart.every(it => paidInstances.has(it.instanceId));
    const completeBtn = document.getElementById('complete-all-btn');
    if (completeBtn) completeBtn.classList.toggle('hidden', !allPaid);
}

function markAsPaidSelected() {
    if (selectedForPayment.size === 0) return;

    selectedForPayment.forEach(id => paidInstances.add(id));
    selectedForPayment.clear();
    renderSplitList();
    showToast(); // Th√¥ng b√°o nh·∫π kh√¥ng m·ªù
}

function completeWholePayment() {
    if (expandedCart.length !== paidInstances.size) {
        if (typeof showAppModal === 'function') showAppModal("Ch∆∞a xong", "C√≤n m√≥n ch∆∞a thu ti·ªÅn!", "‚ö†Ô∏è");
        return;
    }

    // Reset h·∫øt ƒë·ªÉ l·∫ßn thanh to√°n sau s·∫°ch s·∫Ω
    expandedCart = [];
    paidInstances.clear();

    closeSplitModal();
    completeOrder(); 
}
    // =========================================================
// MOBILE SPECIFIC LOGIC: CAFE IN BED
// =========================================================

// 1. H√†m m·ªü tab Bed tr√™n Mobile
// =========================================================
// [FIX] MOBILE SPECIFIC LOGIC: CAFE IN BED (ƒê√É S·ª¨A L·ªñI TREO M√ÅY)
// =========================================================

// =========================================================
// [FIX FINAL] MOBILE SPECIFIC LOGIC: CAFE IN BED
// =========================================================

// 1. H√†m m·ªü tab Bed tr√™n Mobile (ƒê√£ fix l·ªói Bottom Bar)
function openBedManagerMobile() {
    document.getElementById('loading-overlay').style.display = 'flex';
    
    // ·∫®n thanh thanh to√°n
    var mobBar = document.getElementById('mobile-bottom-bar');
    if(mobBar) {
        mobBar.classList.add('hidden');
        mobBar.classList.remove('flex');
    }

    // ·∫®n c√°c view kh√°c
    ['view-menu', 'view-payment', 'view-history', 'view-bed', 'view-revenue'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.classList.add('hidden');
    });

    document.getElementById('view-bed-mobile').classList.remove('hidden');
    
    // Reset Nav Button
    const btnBed = document.getElementById('btn-nav-bed');
    if(btnBed) {
        document.querySelectorAll('button[id^="btn-nav-"]').forEach(b => {
            b.classList.remove('tab-active', 'sb-green', 'text-white');
            b.classList.add('bg-gray-100', 'text-gray-400');
        });
        btnBed.classList.add('tab-active', 'sb-green', 'text-white');
        btnBed.classList.remove('bg-gray-100', 'text-gray-400');
    }

    const today = new Date().toISOString().split('T')[0];
    const picker = document.getElementById('mob-date-picker');
    if(picker && !picker.value) picker.value = today;

    // Load d·ªØ li·ªáu
    // Load d·ªØ li·ªáu
    db.ref('bedBookings').on('value', snap => {
        const data = snap.val() || {};
        globalAllBookings = Object.keys(data).map(k => {
            const item = data[k];
            // Format l·∫°i ng√†y th√°ng chu·∫©n
            let rawDate = item.date || item.bookingDate || "";
            if (rawDate.includes('-') && rawDate.split('-')[0].length === 4) {
                const p = rawDate.split('-'); 
                rawDate = `${p[2]}/${p[1]}/${p[0]}`;
            }
            return {
                id: k, ...item,
                start: item.start || "--:--", 
                end: item.end || "--:--",
                displayDate: rawDate 
            };
        });

        // >>> [QUAN TR·ªåNG] G·ªåI H√ÄM QU√âT H·ª¶Y T·ª∞ ƒê·ªòNG <<<
        // Gi√∫p Mobile t·ª± d·ªçn d·∫πp ƒë∆°n treo gi·ªëng h·ªát PC
        runAutoCancelScan(globalAllBookings); 
        // ---------------------------------------------

        document.getElementById('loading-overlay').style.display = 'none';
        
        // Render l·∫°i list
        const picker = document.getElementById('mob-date-picker');
        // Fix l·ªói ng√†y th√°ng n·∫øu ch∆∞a c√≥ gi√° tr·ªã
        const todayISO = new Date().toISOString().split('T')[0];
        changeBedDateMobile(picker && picker.value ? picker.value : todayISO);
    });
}

// 2. ƒê·ªïi ng√†y (Gi·ªØ nguy√™n)
function changeBedDateMobile(dateVal) {
    if(!dateVal) return;
    const parts = dateVal.split('-');
    const targetDateStr = `${parts[2]}/${parts[1]}/${parts[0]}`;
    
    const list = globalAllBookings.filter(b => {
        const isToday = (targetDateStr === new Date().toLocaleDateString('en-GB'));
        if (isToday) return b.displayDate === targetDateStr || (b.status && b.status.includes('active'));
        return b.displayDate === targetDateStr;
    });
    renderMobileBedList(list);
}

// 3. Render List (Gi·ªØ nguy√™n)
function renderMobileBedList(list) {
    const container = document.getElementById('mob-bed-list-container');
    if(!container) return;

    if(list.length === 0) {
        container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-slate-400"><span class="material-symbols-outlined text-4xl mb-2">event_busy</span><p class="text-sm font-medium">Kh√¥ng c√≥ l·ªãch ƒë·∫∑t</p></div>`;
        return;
    }

    container.innerHTML = list.map(b => {
        const isWaiting = !b.bedId || b.bedId == "WAITING";
        const isActive = b.status === 'active' || (b.status && b.status.includes('active'));
        const isDone = b.status === 'ƒë√£ xong';
        
        let cardBg = "bg-white", titleColor = "text-slate-900";
        let statusText = isWaiting ? "CH·ªú X·∫æP" : `BED 0${b.bedId}`;
        let statusColor = isWaiting ? "text-amber-600" : "text-slate-500";
        let dotColor = isWaiting ? "bg-amber-500" : (isActive ? "bg-green-500 animate-pulse" : "bg-slate-300");
        
        if (isWaiting) {
            cardBg = "bg-[#064E3B]"; titleColor = "text-white"; statusText = "CH·ªú X·∫æP";
            statusColor = "text-emerald-200/80"; dotColor = "bg-red-500 border-2 border-[#064E3B]";
        }

        return `
        <div onclick="showMobileBedDetail('${b.id}')" class="${cardBg} squircle p-5 shadow-[0_4px_20px_rgba(0,0,0,0.04)] active:scale-[0.98] transition-transform border border-slate-100/50 relative overflow-hidden">
            <div class="flex justify-between items-start mb-1.5 relative z-10">
                <span class="text-[11px] font-bold tracking-widest uppercase ${statusColor}">${statusText}</span>
                <div class="w-2.5 h-2.5 rounded-full ${dotColor}"></div>
            </div>
            <h3 class="text-xl font-bold mb-3 ${titleColor} relative z-10">${b.name}</h3>
            <div class="flex items-center gap-2 text-sm ${isWaiting ? 'text-white/70' : 'text-slate-500'} relative z-10">
                <span class="material-symbols-outlined text-base">schedule</span>
                <span class="font-medium">Check-out: ${isDone ? (b.realEndTime || b.end) : b.end}</span>
            </div>
            ${isWaiting ? '<div class="absolute -right-6 -bottom-6 w-24 h-24 bg-white/10 rounded-full z-0"></div>' : ''}
        </div>`;
    }).join('');
}

// 4. Show Detail (ƒê√£ update n√∫t Back & Logic ·∫©n 3 ch·∫•m)
function showMobileBedDetail(bookingId) {
    const booking = globalAllBookings.find(b => b.id === bookingId);
    if(!booking) return;
    window.currentMobileBooking = booking; 
    
    // Render
    renderDetailContentMobile(booking);

    // Update Header Detail (N√∫t Back chu·∫©n + ·∫®n/Hi·ªán 3 ch·∫•m)
    const isFinished = (booking.status === 'ƒë√£ xong' || booking.status === 'ƒë√£ h·ªßy');
    const headerHtml = `
        <nav class="flex items-center justify-between px-5 py-4 bg-[#F2F2F7] sticky top-0 z-40">
            <button onclick="closeMobileBedDetail()" class="w-11 h-11 rounded-full bg-white flex items-center justify-center text-slate-800 shadow-[0_2px_10px_rgba(0,0,0,0.05)] active:scale-90 transition-transform border border-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                </svg>
            </button>
            <h1 class="text-lg font-black text-slate-900 uppercase tracking-tight">Chi ti·∫øt</h1>
            
            ${!isFinished ? `
            <button onclick="openCancelMenuMobile()" class="w-11 h-11 rounded-full bg-white flex items-center justify-center text-slate-800 shadow-[0_2px_10px_rgba(0,0,0,0.05)] active:scale-90 transition-transform border border-gray-100">
                <span class="material-symbols-outlined text-xl">more_horiz</span>
            </button>` : `<div class="w-11"></div>`}
        </nav>`;
    
    // G√°n Header m·ªõi v√†o DOM (B·∫°n c·∫ßn th√™m id="mob-detail-header" v√†o th·∫ª nav trong HTML b∆∞·ªõc d∆∞·ªõi)
    document.getElementById('mob-detail-header-container').innerHTML = headerHtml;

    document.getElementById('mob-bed-detail-screen').classList.remove('translate-x-full');
}

function closeMobileBedDetail() {
    document.getElementById('mob-bed-detail-screen').classList.add('translate-x-full');
    window.currentMobileBooking = null;
}

// 5. Render N·ªôi dung (ƒê√£ n·ªëi API t√≠nh ti·ªÅn)
// H√†m ph·ª• tr·ª£: T√≠nh th·ªùi gian c√≤n l·∫°i (ƒê·∫øm ng∆∞·ª£c)
// Bi·∫øn to√†n c·ª•c ƒë·ªÉ qu·∫£n l√Ω ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c
var mobileTimerInterval = null;

// H√†m ti·ªán √≠ch: T√≠nh gi·ªù ƒë·∫øm ng∆∞·ª£c
function getCountdownStr(endTimeStr) {
    if (!endTimeStr || endTimeStr === "--:--") return { timeStr: "--:--", label: "...", style: "bg-gray-400" };
    
    const now = new Date();
    const parts = endTimeStr.split(':');
    const end = new Date();
    end.setHours(parseInt(parts[0]), parseInt(parts[1]), 0, 0);

    // X·ª≠ l√Ω qua ƒë√™m
    if (end < now && (now.getHours() - end.getHours()) > 12) {
        end.setDate(end.getDate() + 1);
    }
    
    let diff = end - now;
    let label = "C√íN L·∫†I";
    let style = "bg-white/20 text-white"; // M√†u m·∫∑c ƒë·ªãnh
    
    if (diff < 0) {
        diff = Math.abs(diff);
        label = "QU√Å GI·ªú";
        style = "bg-red-500 text-white animate-pulse border border-white/30"; // M√†u ƒë·ªè c·∫£nh b√°o
    }

    const h = Math.floor(diff / 3600000);
    const m = Math.floor((diff % 3600000) / 60000);
    const s = Math.floor((diff % 60000) / 1000); // Th√™m gi√¢y cho sinh ƒë·ªông
    
    // Format HH:MM:SS
    const timeStr = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    
    return { timeStr, label, style };
}

// --- H√ÄM RENDER CH√çNH ---
    // --- [FINAL FIX] H√ÄM RENDER CHI TI·∫æT BED MOBILE ---
// Fix l·ªói: ƒê·ªìng h·ªì ch·ªâ ch·∫°y khi tr·∫°ng th√°i l√† ACTIVE (ƒêang d√πng)

function renderDetailContentMobile(b) {
    // 1. D·ªçn d·∫πp timer c≈© (B·∫Øt bu·ªôc)
    if (mobileTimerInterval) clearInterval(mobileTimerInterval);
    
    window.currentMobileBooking = b;

    const container = document.getElementById('mob-bed-detail-content');
    const actionContainer = document.getElementById('mob-detail-actions');
    
    // --- ƒê·ªäNH NGHƒ®A TR·∫†NG TH√ÅI ---
    const isWaiting = !b.bedId || b.bedId == "WAITING";
    const statusText = isWaiting ? "CH·ªú X·∫æP" : `BED 0${b.bedId}`;
    const isDone = b.status === 'ƒë√£ xong';
    const isCancelled = b.status === 'ƒë√£ h·ªßy';
    // Logic Active chu·∫©n: C√≥ status active HO·∫∂C ƒëang d√πng
    const isActive = (b.status === 'active' || (b.status && b.status.includes('active')) || (b.status && b.status.includes('ƒëang d√πng')));

    // 2. T√≠nh ti·ªÅn th·ª±c t·∫ø (Async)
    calculateSessionSpend(b.phone, b.start, (isDone ? b.realEndTime : b.end)).then(total => {
        const el = document.getElementById('mob-detail-total-display');
        if(el) el.innerText = total.toLocaleString() + 'ƒë';
    });

    // 3. Chu·∫©n b·ªã d·ªØ li·ªáu hi·ªÉn th·ªã ƒë·ªìng h·ªì
    // Ch·ªâ t√≠nh to√°n ƒë·∫øm ng∆∞·ª£c n·∫øu ƒëang Active
    const countdown = isActive ? getCountdownStr(b.end) : { timeStr: b.start, label: "D·ª∞ KI·∫æN", style: "bg-white/20" };

    // 4. Render HTML
    container.innerHTML = `
    <div class="bg-primary squircle p-8 text-white relative overflow-hidden shadow-2xl shadow-[#006241]/20 min-h-[220px] flex flex-col justify-between">
        <div class="relative z-10">
            <p class="text-[11px] font-bold tracking-[0.2em] opacity-60 mb-1 uppercase">Tr·∫°ng Th√°i</p>
            <h2 class="text-5xl font-black tracking-tighter">${statusText}</h2>
            ${isCancelled ? '<span class="inline-block mt-2 bg-red-500 px-3 py-1 rounded-full text-[10px] font-bold">ƒê√É H·ª¶Y</span>' : ''}
        </div>
        
        ${isActive ? `
            <div class="relative z-10 flex items-baseline justify-between mt-4">
                <div id="mob-live-timer" class="timer-font text-6xl font-medium tracking-tight">${countdown.timeStr}</div>
                <div id="mob-live-badge" class="${countdown.style} px-3 py-1 rounded-full text-[12px] font-semibold backdrop-blur-md transition-all">
                    ${countdown.label}
                </div>
            </div>
        ` : (isWaiting ? `
            <div class="relative z-10 flex items-baseline justify-between mt-4 opacity-80">
                <div class="timer-font text-5xl font-medium tracking-tight">${b.start}</div>
                <div class="bg-white/10 px-3 py-1 rounded-full text-[10px] font-bold backdrop-blur-md">
                    CH·ªú CHECK-IN
                </div>
            </div>
        ` : '')}

        <div class="absolute -right-10 -top-10 w-48 h-48 bg-white/10 rounded-full blur-3xl"></div>
        <div class="absolute right-4 bottom-4 w-32 h-32 bg-black/10 rounded-full"></div>
    </div>

    <div class="grid grid-cols-2 gap-4 mt-2">
        <div class="glass p-5 rounded-[28px] shadow-sm flex flex-col items-center text-center">
            <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-3">
                <span class="material-symbols-outlined text-[20px]">person</span>
            </div>
            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Kh√°ch H√†ng</span>
            <p class="text-[15px] font-bold leading-tight truncate w-full">${b.name}</p>
            <p class="text-[12px] text-gray-500 mt-0.5 font-mono">${b.phone}</p>
        </div>
        <div class="glass p-5 rounded-[28px] shadow-sm flex flex-col items-center text-center">
            <div class="w-10 h-10 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mb-3">
                <span class="material-symbols-outlined text-[20px]">group</span>
            </div>
            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">ƒêi C√πng</span>
            <p class="text-[15px] font-bold leading-tight truncate w-full">${b.compName || "--"}</p>
            <p class="text-[12px] text-gray-500 mt-0.5 font-mono">${b.compPhone || "--"}</p>
        </div>
    </div>

    <div class="bg-white rounded-[28px] shadow-sm overflow-hidden border border-gray-50">
        <div class="flex items-center justify-between px-6 py-5 border-b border-gray-100">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-emerald-50 text-emerald-500 rounded-xl flex items-center justify-center">
                    <span class="material-symbols-outlined">schedule</span>
                </div>
                <span class="font-semibold text-[14px] text-gray-600">B·∫Øt ƒë·∫ßu</span>
            </div>
            <span class="text-lg font-bold text-gray-900">${b.start}</span>
        </div>
        <div class="flex items-center justify-between px-6 py-5">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-rose-50 text-rose-500 rounded-xl flex items-center justify-center">
                    <span class="material-symbols-outlined">alarm_off</span>
                </div>
                <span class="font-semibold text-[14px] text-gray-600">${isDone ? "Th·ª±c t·∫ø tr·∫£" : "K·∫øt th√∫c"}</span>
            </div>
            <span class="text-lg font-bold ${isDone ? 'text-rose-600' : 'text-gray-900'}">
                ${isDone ? (b.realEndTime || b.end) : b.end}
            </span>
        </div>
    </div>

    <div class="flex items-end justify-between px-2 pt-2 pb-1">
        <span class="text-[12px] font-bold text-gray-400 uppercase tracking-[0.1em]">T·ªïng chi ti√™u</span>
        <span id="mob-detail-total-display" class="text-4xl font-black text-primary tracking-tight">...</span>
    </div>

    ${(!isActive && !isWaiting) ? `
    <div class="glass-widget rounded-[32px] p-6 space-y-4 relative overflow-hidden animate-slide-up">
        <div class="flex items-center justify-between px-1">
            <span class="text-[14px] font-bold text-slate-800 tracking-tight">Ph√≠ v·ªá sinh</span>
            <div class="flex items-center gap-1.5 py-1 px-2.5 rounded-full bg-orange-500/10 border border-orange-500/20">
                <span class="material-symbols-outlined text-[14px] text-orange-600 font-bold">error</span>
                <span class="text-[10px] font-black uppercase tracking-widest text-orange-600">N·ª£ sau</span>
            </div>
        </div>
        <div class="flex gap-4">
            <button onclick="submitCleaningFee(20000)" class="high-gloss-button flex-1 py-4 rounded-full text-[14px] font-bold text-slate-900 transition-all duration-200">20K</button>
            <button onclick="submitCleaningFee(30000)" class="high-gloss-button flex-1 py-4 rounded-full text-[14px] font-bold text-slate-900 transition-all duration-200">30K</button>
            <button onclick="submitCleaningFee(50000)" class="high-gloss-button flex-1 py-4 rounded-full text-[14px] font-bold text-slate-900 transition-all duration-200">50K</button>
        </div>
        <div class="absolute -bottom-4 -left-4 w-24 h-24 bg-white/40 rounded-full blur-2xl pointer-events-none"></div>
    </div>
    ` : ''}
    `;

    // 5. N√öT ƒêI·ªÄU KHI·ªÇN (BOTTOM BAR)
    let btnHtml = '';

    if (isWaiting && !isCancelled) {
        // [CH·ªú X·∫æP]
        btnHtml = `
        <div class="fixed bottom-0 left-0 right-0 p-6 bg-[#F2F2F7]/90 backdrop-blur-lg flex gap-4 z-50">
            <button onclick="handleMobileBedOrder('${b.id}')" 
                class="flex-1 h-16 bg-white border-2 border-[#006241] rounded-full text-[#006241] font-bold text-[15px] shadow-lg shadow-black/5 transition-all active:scale-95 uppercase">
                G·ªåI M√ìN
            </button>
            <button onclick="pendingBedOrder=window.currentMobileBooking; renderBedSelection(); document.getElementById('bed-select-modal').classList.remove('hidden');" 
                class="flex-1 h-16 bg-[#006241] rounded-full text-white font-bold text-[15px] shadow-lg shadow-[#006241]/20 transition-all active:scale-95 uppercase">
                X·∫æP BED
            </button>
        </div>`;
    } 
    else if (isActive && !isCancelled) {
        // [ƒêANG D√ôNG]
        btnHtml = `
        <div class="fixed bottom-0 left-0 right-0 p-6 bg-[#F2F2F7]/90 backdrop-blur-lg flex gap-4 z-50">
            <button onclick="handleMobileBedOrder('${b.id}')" 
                class="flex-1 h-16 bg-white border-2 border-[#006241] rounded-full text-[#006241] font-bold text-[15px] shadow-lg shadow-black/5 transition-all active:scale-95 uppercase">
                G·ªåI M√ìN
            </button>
            <button onclick="handleBedCheckout(window.currentMobileBooking)" 
                class="flex-1 h-16 bg-[#006241] rounded-full text-white font-bold text-[15px] shadow-lg shadow-[#006241]/20 transition-all active:scale-95 uppercase">
                TR·∫¢ BED
            </button>
        </div>`;
    } 
    else {
        // [ƒê√É XONG/H·ª¶Y]
        btnHtml = `
        <div class="fixed bottom-0 left-0 right-0 p-6 bg-[#F2F2F7]/90 backdrop-blur-lg z-50">
            <button onclick="closeMobileBedDetail()" class="w-full h-16 bg-slate-200 text-slate-500 rounded-full font-bold text-[15px] uppercase">
                ƒê√≥ng
            </button>
        </div>`;
    }
    actionContainer.innerHTML = btnHtml;

    // 6. K√çCH HO·∫†T ƒê·ªíNG H·ªí LIVE (CH·ªà KHI ACTIVE)
    // --- [FIX] QUAN TR·ªåNG: Ch·ªâ ch·∫°y setInterval khi isActive = true ---
    if (isActive) {
        mobileTimerInterval = setInterval(() => {
            const currentCountdown = getCountdownStr(b.end);
            
            const tEl = document.getElementById('mob-live-timer');
            const bEl = document.getElementById('mob-live-badge');
            
            if (tEl && bEl) {
                tEl.innerText = currentCountdown.timeStr;
                bEl.innerText = currentCountdown.label;
                bEl.className = `${currentCountdown.style} px-3 py-1 rounded-full text-[12px] font-semibold backdrop-blur-md transition-colors`;
            }
        }, 1000);
    }
}


// B·ªï sung h√†m ƒë√≥ng ƒë·ªÉ d·ªçn d·∫πp Timer
function closeMobileBedDetail() {
    if (mobileTimerInterval) clearInterval(mobileTimerInterval);
    document.getElementById('mob-bed-detail-screen').classList.add('translate-x-full');
    window.currentMobileBooking = null;
}
         // =========================================================
// MOBILE REVENUE LOGIC
// =========================================================
let currentRevMode = 'week';

function openRevenueMobile() {
    // 1. [QUAN TR·ªåNG] ·∫®n tuy·ªát ƒë·ªëi thanh Bottom Bar Thanh To√°n
    var mobBar = document.getElementById('mobile-bottom-bar');
    if(mobBar) {
        mobBar.classList.add('hidden');
        mobBar.classList.remove('flex');
    }

    // 2. ·∫®n Sidebar Cart & C√°c View kh√°c
    document.getElementById('sidebar-cart').classList.add('hidden');
    
    ['view-menu', 'view-payment', 'view-history', 'view-bed', 'view-revenue'].forEach(id => {
        var el = document.getElementById(id);
        if(el) el.classList.add('hidden');
    });
    
    // ·∫®n view Bed Mobile (n·∫øu ƒëang m·ªü)
    document.getElementById('view-bed-mobile').classList.add('hidden');
    
    // 3. Hi·ªán view Revenue Mobile
    document.getElementById('view-revenue-mobile').classList.remove('hidden');
    
    // 4. Load Data
    fetchRevenueDataMobile(currentRevMode);
}
    // --- MODULE: SMART TIME DROPDOWN ---
let currentRevLabelOverride = null; // Bi·∫øn l∆∞u t√™n nh√£n t√πy ch·ªânh (Tu·∫ßn tr∆∞·ªõc, Th√°ng tr∆∞·ªõc...)

function toggleSmartTimeDropdown() {
    const dd = document.getElementById('smart-time-dropdown');
    const ol = document.getElementById('smart-time-overlay');
    
    if (dd.classList.contains('hidden')) {
        dd.classList.remove('hidden');
        ol.classList.remove('hidden');
    } else {
        dd.classList.add('hidden');
        ol.classList.add('hidden');
    }
}

function selectSmartTime(type) {
    toggleSmartTimeDropdown(); // ƒê√≥ng menu
    
    const now = new Date();
    let start, end;
    let label = "";
    let mode = 'custom'; // M·∫∑c ƒë·ªãnh d√πng mode custom ƒë·ªÉ truy·ªÅn ng√†y c·ª• th·ªÉ

    if (type === 'this_week') {
        switchRevTime('week'); // D√πng l·∫°i logic c≈©
        return; 
    } 
    else if (type === 'this_month') {
        switchRevTime('month'); // D√πng l·∫°i logic c≈©
        return;
    }
    else if (type === 'last_week') {
        // T√≠nh Th·ª© 2 -> CN tu·∫ßn tr∆∞·ªõc
        let day = now.getDay() || 7; 
        let endLastWeek = new Date(now); 
        endLastWeek.setDate(now.getDate() - day); // Ch·ªß nh·∫≠t tu·∫ßn tr∆∞·ªõc
        endLastWeek.setHours(23,59,59,999);
        
        let startLastWeek = new Date(endLastWeek);
        startLastWeek.setDate(endLastWeek.getDate() - 6); // Th·ª© 2 tu·∫ßn tr∆∞·ªõc
        startLastWeek.setHours(0,0,0,0);
        
        start = startLastWeek.toISOString().split('T')[0];
        end = endLastWeek.toISOString().split('T')[0];
        label = "Tu·∫ßn tr∆∞·ªõc";
    }
    else if (type === 'last_month') {
        // T√≠nh ng√†y 1 -> Cu·ªëi th√°ng tr∆∞·ªõc
        start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        end = new Date(now.getFullYear(), now.getMonth(), 0); // Ng√†y 0 c·ªßa th√°ng n√†y = Cu·ªëi th√°ng tr∆∞·ªõc
        
        // Format YYYY-MM-DD
        // L∆∞u √Ω m√∫i gi·ªù: d√πng toLocaleDateString('en-CA') ho·∫∑c t·ª± format ƒë·ªÉ tr√°nh l·ªách ng√†y
        let format = (d) => {
            let y = d.getFullYear();
            let m = String(d.getMonth()+1).padStart(2,'0');
            let day = String(d.getDate()).padStart(2,'0');
            return `${y}-${m}-${day}`;
        };

        start = format(start);
        end = format(end);
        label = "Th√°ng tr∆∞·ªõc";
    }

    // Set bi·∫øn Override ƒë·ªÉ UI bi·∫øt ƒë∆∞·ªùng hi·ªÉn th·ªã t√™n
    currentRevLabelOverride = label;
    
    // Reset style c√°c n√∫t Tab (ƒë·ªÉ n√≥ kh√¥ng s√°ng c√°i n√†o c·∫£, v√¨ ƒëang ch·ªçn Last Week)
    ['week', 'month', 'year'].forEach(m => {
        document.getElementById(`tab-rev-${m}`).className = "flex-1 py-2.5 rounded-full text-[11px] font-bold text-slate-400 transition-all";
    });

    // G·ªçi h√†m fetch d·ªØ li·ªáu
    currentRevMode = 'custom';
    fetchRevenueDataMobile('custom', start, end);
}
// =========================================================
// MODULE: DOANH THU M·ªû R·ªòNG (ITEMS, GROUPS, BED)
// =========================================================

let currentRevenueView = 'overview'; // M·∫∑c ƒë·ªãnh l√† t·ªïng quan

// 1. H√†m chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô xem
function switchRevenueView(viewMode) {
    currentRevenueView = viewMode;
    toggleRevenueDropdown(); // ƒê√≥ng menu
    
    // ƒê·ªïi ti√™u ƒë·ªÅ bi·ªÉu ƒë·ªì
    const titleEl = document.getElementById('mob-chart-title');
    if (titleEl) {
        if(viewMode === 'overview') titleEl.innerText = "Bi·ªÉu ƒë·ªì doanh thu";
        else if(viewMode === 'items') titleEl.innerText = "Top 10 M√≥n B√°n Ch·∫°y";
        else if(viewMode === 'groups') titleEl.innerText = "Doanh Thu Theo Nh√≥m";
        else if(viewMode === 'bed') titleEl.innerText = "Doanh Thu Cafe in Bed";
    }

    // T·∫£i l·∫°i d·ªØ li·ªáu ngay l·∫≠p t·ª©c
    fetchRevenueDataMobile(currentRevMode);
}

// 2. H√†m T√≠nh to√°n Top M√≥n (Logic c·ªët l√µi)
// =========================================================
// [KH√îI PH·ª§C] MODULE: DOANH THU N√ÇNG CAO (ITEMS & GROUPS)
// =========================================================

let currentItemSort = 'desc'; // desc: Cao->Th·∫•p, asc: Th·∫•p->Cao
let customSelectedItems = null; // null = Auto Top 10

// 1. H√†m v·∫Ω UI Top 10 (Phi√™n b·∫£n m·ªõi nh·∫•t)
function updateRevenueItemsUI(data) {
    // C·∫≠p nh·∫≠t nh√£n th·ªùi gian
    const labelMap = {'week': 'Tu·∫ßn n√†y', 'month': 'Th√°ng n√†y', 'year': 'NƒÉm nay', 'custom': 'T√πy ch·ªçn'};
    let finalLabel = currentRevLabelOverride || labelMap[currentRevMode] || 'Chi ti·∫øt';
    const labelEl = document.getElementById('mob-chart-label');
    if(labelEl) labelEl.innerText = finalLabel;

    // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn hi·ªÉn th·ªã
    document.getElementById('mob-rev-total').innerHTML = `
        <span class="text-3xl">${data.totalRev.toLocaleString()}</span> 
        <span class="text-xs font-bold opacity-60">‚Ç´</span>
    `;

    const container = document.getElementById('mob-rev-chart-bars');
    container.className = "w-full flex flex-col gap-3 pb-4"; 
    
    // Header ƒëi·ªÅu khi·ªÉn
    let sortLabel = currentItemSort === 'desc' ? "Cao ‚¨á" : "Th·∫•p ‚¨Ü";
    let filterLabel = customSelectedItems ? "T√πy ch·ªçn" : "Top 10 (M·∫∑c ƒë·ªãnh)";
    let filterClass = customSelectedItems 
        ? "bg-amber-50 text-amber-700 border-amber-200 ring-1 ring-amber-100" 
        : "bg-white text-slate-600 border-slate-100 shadow-sm";

    let html = `
    <div class="flex flex-col gap-3 mb-4">
        <div class="flex justify-between items-end px-1">
            <span class="text-[10px] font-black text-gray-300 uppercase tracking-[0.2em]">X·∫øp h·∫°ng</span>
        </div>
        <div class="flex gap-3">
            <button onclick="openItemSelectModal()" class="flex-1 flex items-center justify-center gap-2 ${filterClass} border py-2.5 px-4 rounded-full active:scale-95 transition-all group">
                <span class="material-symbols-outlined text-[18px] group-active:scale-110 transition-transform">tune</span>
                <span class="text-[11px] font-bold uppercase tracking-wide">${filterLabel}</span>
            </button>
            <button onclick="toggleItemSort()" class="flex items-center justify-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-600 py-2.5 px-5 rounded-full active:scale-95 transition-all">
                <span class="material-symbols-outlined text-[18px]">sort</span>
                <span class="text-[11px] font-bold">${sortLabel}</span>
            </button>
        </div>
    </div>`;

    if (data.topItems.length === 0) {
        container.innerHTML = html + '<div class="flex flex-col items-center justify-center py-10 text-gray-300 gap-2"><span class="text-3xl">üì≠</span><span class="text-xs font-medium">Ch∆∞a c√≥ s·ªë li·ªáu</span></div>';
        document.getElementById('mob-chart-total').innerText = "0 ‚Ç´";
        return;
    }

    const maxVal = Math.max(...data.topItems.map(i => i.total), 1);
    
    // T√≠nh t·ªïng ti·ªÅn danh s√°ch ƒëang hi·ªán
    const displayedTotal = data.topItems.reduce((acc, item) => acc + item.total, 0);
    document.getElementById('mob-chart-total').innerText = displayedTotal.toLocaleString() + ' ‚Ç´';

    html += '<div class="space-y-3">';
    html += data.topItems.map((item, index) => {
        let percent = Math.round((item.total / maxVal) * 100);
        let rankBg = 'bg-slate-100 text-slate-500';
        let rankText = 'text-slate-500';
        
        if(currentItemSort === 'desc' && !customSelectedItems) {
            if(index === 0) { rankBg = 'bg-yellow-100'; rankText = 'text-yellow-700'; }
            else if(index === 1) { rankBg = 'bg-gray-100'; rankText = 'text-gray-700'; }
            else if(index === 2) { rankBg = 'bg-orange-50'; rankText = 'text-orange-700'; }
        }
        let barColor = (item.total > 0) ? 'bg-[#006241]' : 'bg-slate-200';
        
        return `
        <div class="w-full group">
            <div class="flex justify-between items-center mb-1.5">
                <div class="flex items-center gap-3 max-w-[70%]">
                    <div class="w-6 h-6 rounded-full ${rankBg} ${rankText} flex items-center justify-center text-[10px] font-black shrink-0 shadow-sm border border-white">
                        ${index + 1}
                    </div>
                    <div class="flex flex-col min-w-0">
                        <span class="font-bold text-[13px] text-slate-700 truncate leading-tight">${item.name}</span>
                        ${item.qty > 0 ? `<span class="text-[9px] font-bold text-slate-400">ƒê√£ b√°n: ${item.qty}</span>` : ''}
                    </div>
                </div>
                <span class="font-black text-[13px] text-[#006241] whitespace-nowrap">${item.total.toLocaleString()}</span>
            </div>
            <div class="w-full h-2 bg-slate-50 rounded-full overflow-hidden">
                <div class="h-full ${barColor} rounded-full transition-all duration-1000 ease-out relative" style="width: ${percent}%">
                    <div class="absolute inset-0 bg-white/20"></div>
                </div>
            </div>
        </div>`;
    }).join('');
    html += '</div>';
    container.innerHTML = html;
}

// 2. H√†m T√≠nh to√°n Top M√≥n (H·ªó tr·ª£ l·ªçc)
function calculateTopItems(orders, mode, customStart, customEnd) {
    // Logic l·ªçc th·ªùi gian (r√∫t g·ªçn)
    var now = new Date(); var startTime, endTime;
    if (mode === 'week') { var day = now.getDay() || 7; startTime = new Date(now); startTime.setDate(now.getDate() - day + 1); startTime.setHours(0,0,0,0); endTime = new Date(startTime); endTime.setDate(startTime.getDate() + 6); endTime.setHours(23,59,59,999); } 
    else if (mode === 'month') { startTime = new Date(now.getFullYear(), now.getMonth(), 1); endTime = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999); }
    else if (mode === 'year') { startTime = new Date(now.getFullYear(), 0, 1); endTime = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999); }
    else { if(!customStart || !customEnd) return { topItems: [], totalRev: 0 }; startTime = new Date(customStart); startTime.setHours(0,0,0,0); endTime = new Date(customEnd); endTime.setHours(23,59,59,999); }

    let itemMap = {}; let totalRevenue = 0; 
    orders.forEach(o => {
        var d = new Date(o.createdAt || Date.now());
        if (d >= startTime && d <= endTime) {
            totalRevenue += Number(o.total || 0);
            if (o.itemsArray && Array.isArray(o.itemsArray)) {
                o.itemsArray.forEach(item => {
                    let name = item.name; 
                    if (!itemMap[name]) itemMap[name] = { qty: 0, total: 0 };
                    itemMap[name].qty += (item.qty || 0);
                    itemMap[name].total += (item.price * item.qty || 0);
                });
            } else if (o.items) {
                let parts = o.items.split(',');
                parts.forEach(p => {
                    let cleanP = p.trim(); let xIndex = cleanP.lastIndexOf('x');
                    if(xIndex > -1) {
                        let namePart = cleanP.substring(0, xIndex).trim();
                        let parenIndex = namePart.indexOf('(');
                        if(parenIndex > -1) namePart = namePart.substring(0, parenIndex).trim();
                        let qty = parseInt(cleanP.substring(xIndex+1)) || 1;
                        if (!itemMap[namePart]) itemMap[namePart] = { qty: 0, total: 0 };
                        itemMap[namePart].qty += qty;
                    }
                });
            }
        }
    });

    let finalItems = [];
    if (customSelectedItems && customSelectedItems.length > 0) {
        customSelectedItems.forEach(name => {
            if (itemMap[name]) finalItems.push({ name: name, ...itemMap[name] });
            else finalItems.push({ name: name, qty: 0, total: 0 });
        });
    } else {
        let sorted = Object.keys(itemMap).map(k => ({name: k, ...itemMap[k]}));
        sorted.sort((a, b) => b.total - a.total);
        finalItems = sorted.slice(0, 10);
    }

    if (currentItemSort === 'desc') finalItems.sort((a, b) => b.total - a.total);
    else finalItems.sort((a, b) => a.total - b.total);

    return { topItems: finalItems, totalRev: totalRevenue };
}

// 3. C√°c h√†m h·ªó tr·ª£ (Sort, Select Modal, Group) - NH·ªÆNG H√ÄM B·ªä M·∫§T
function toggleItemSort() {
    currentItemSort = (currentItemSort === 'desc') ? 'asc' : 'desc';
    fetchRevenueDataMobile(currentRevMode);
}

function openItemSelectModal() {
    let uniqueItems = [...new Set(menu.map(m => m.name))].sort();
    const listEl = document.getElementById('item-select-list');
    listEl.innerHTML = uniqueItems.map(name => {
        let isChecked = customSelectedItems ? customSelectedItems.includes(name) : false;
        return `
        <label class="flex items-center justify-between p-3 bg-white border border-gray-100 rounded-xl cursor-pointer active:bg-gray-50 transition-colors">
            <span class="font-bold text-gray-700 text-sm select-none">${name}</span>
            <input type="checkbox" value="${name}" ${isChecked ? 'checked' : ''} onchange="handleItemCheck(this)" class="w-5 h-5 rounded border-gray-300 accent-[#006241]">
        </label>`;
    }).join('');
    updateSelectCount();
    document.getElementById('modal-item-select').classList.remove('hidden');
}

function handleItemCheck(el) { updateSelectCount(); }
function updateSelectCount() {
    const count = document.querySelectorAll('#item-select-list input[type="checkbox"]:checked').length;
    document.getElementById('item-select-count').innerText = `ƒê√£ ch·ªçn: ${count} m√≥n`;
}
function filterItemSelectionList(keyword) {
    const kw = keyword.toLowerCase();
    document.querySelectorAll('#item-select-list label').forEach(lbl => {
        lbl.style.display = lbl.querySelector('span').innerText.toLowerCase().includes(kw) ? 'flex' : 'none';
    });
}
function resetItemSelection() {
    customSelectedItems = null; 
    document.getElementById('modal-item-select').classList.add('hidden');
    fetchRevenueDataMobile(currentRevMode);
}
function applyItemSelection() {
    const checkboxes = document.querySelectorAll('#item-select-list input[type="checkbox"]:checked');
    if (checkboxes.length === 0) return alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 m√≥n!");
    customSelectedItems = Array.from(checkboxes).map(cb => cb.value);
    document.getElementById('modal-item-select').classList.add('hidden');
    fetchRevenueDataMobile(currentRevMode);
}

// 4. Logic Doanh thu Nh√≥m (Group) - B·ªä M·∫§T
function calculateGroupRevenue(orders, mode, customStart, customEnd) {
    // (Logic th·ªùi gian gi·ªëng h·ªát calculateTopItems - R√∫t g·ªçn)
    var now = new Date(); var startTime, endTime;
    if (mode === 'week') { var day = now.getDay() || 7; startTime = new Date(now); startTime.setDate(now.getDate() - day + 1); startTime.setHours(0,0,0,0); endTime = new Date(startTime); endTime.setDate(startTime.getDate() + 6); endTime.setHours(23,59,59,999); }
    else if (mode === 'month') { startTime = new Date(now.getFullYear(), now.getMonth(), 1); endTime = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999); }
    else if (mode === 'year') { startTime = new Date(now.getFullYear(), 0, 1); endTime = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999); }
    else { if(!customStart || !customEnd) return { groups: [], totalRev: 0 }; startTime = new Date(customStart); startTime.setHours(0,0,0,0); endTime = new Date(customEnd); endTime.setHours(23,59,59,999); }

    let groupMap = {}; let totalRevenue = 0;
    orders.forEach(o => {
        var d = new Date(o.createdAt || Date.now());
        if (d >= startTime && d <= endTime) {
            totalRevenue += Number(o.total || 0);
            const process = (name, qty, price) => {
                const m = menu.find(mi => mi.name.toLowerCase() === name.toLowerCase());
                let gName = m ? m.type : "Kh√°c";
                gName = gName.charAt(0).toUpperCase() + gName.slice(1);
                if (!groupMap[gName]) groupMap[gName] = { qty: 0, total: 0 };
                groupMap[gName].qty += qty;
                groupMap[gName].total += (price * qty);
            };
            if (o.itemsArray) o.itemsArray.forEach(i => process(i.name, i.qty||1, i.price||0));
            else if (o.items) {
                o.items.split(',').forEach(p => {
                    let raw = p.trim(), x = raw.lastIndexOf('x');
                    if(x>-1) {
                        let n = raw.substring(0, x).trim();
                        let idx = n.indexOf('('); if(idx>-1) n=n.substring(0,idx).trim();
                        let q = parseInt(raw.substring(x+1))||1;
                        let m = menu.find(mi=>mi.name.toLowerCase()===n.toLowerCase());
                        process(n, q, m?(m.priceM||0):0);
                    }
                });
            }
        }
    });
    let sorted = Object.keys(groupMap).map(k => ({name: k, ...groupMap[k]})).sort((a,b)=>b.total-a.total);
    return { groups: sorted, totalRev: totalRevenue };
}

function updateRevenueGroupsUI(data) {
    const container = document.getElementById('mob-rev-chart-bars');
    container.className = "w-full flex flex-col gap-3 pb-4"; 
    document.getElementById('mob-chart-total').innerText = data.totalRev.toLocaleString() + ' ‚Ç´';

    let html = `<div class="flex justify-between items-center mb-3 pb-2 border-b border-dashed border-gray-200"><span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Ph√¢n lo·∫°i doanh thu</span><span class="text-[10px] font-bold text-gray-400">Cao ‚ûù Th·∫•p</span></div>`;
    
    if (data.groups.length === 0) {
        container.innerHTML = html + '<div class="text-center text-gray-300 py-10 text-xs">Ch∆∞a c√≥ d·ªØ li·ªáu</div>'; return;
    }
    const maxVal = Math.max(...data.groups.map(i => i.total), 1);
    html += '<div class="space-y-4">';
    html += data.groups.map((group, index) => {
        let percent = Math.round((group.total / maxVal) * 100);
        let icon = "category";
        if(group.name.toLowerCase().includes('c√† ph√™')) icon = "coffee";
        else if(group.name.toLowerCase().includes('tr√†')) icon = "local_cafe";
        else if(group.name.toLowerCase().includes('ƒÉn v·∫∑t')) icon = "cookie";
        let isTop1 = index === 0;
        let barColor = isTop1 ? 'bg-amber-500' : 'bg-[#006241]';
        let iconBg = isTop1 ? 'bg-amber-100 text-amber-600' : 'bg-gray-100 text-gray-500';

        return `
        <div class="w-full group">
            <div class="flex justify-between items-center mb-1.5">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full ${iconBg} flex items-center justify-center shadow-sm border border-white"><span class="material-symbols-outlined text-[16px]">${icon}</span></div>
                    <div class="flex flex-col"><span class="font-black text-[13px] text-slate-800 leading-tight">${group.name}</span><span class="text-[9px] font-bold text-slate-400">ƒê√£ b√°n: ${group.qty}</span></div>
                </div>
                <div class="flex flex-col items-end"><span class="font-black text-[13px] text-[#006241]">${group.total.toLocaleString()}</span><span class="text-[9px] font-bold text-slate-400">${Math.round((group.total/data.totalRev)*100)}%</span></div>
            </div>
            <div class="w-full h-2.5 bg-gray-100 rounded-full overflow-hidden"><div class="h-full ${barColor} rounded-full transition-all duration-1000 ease-out relative" style="width: ${percent}%"><div class="absolute inset-0 bg-white/20"></div></div></div>
        </div>`;
    }).join('');
    html += '</div>';
    container.innerHTML = html;
}
function toggleItemSort() {
    currentItemSort = (currentItemSort === 'desc') ? 'asc' : 'desc';
    fetchRevenueDataMobile(currentRevMode);
}
    function openItemSelectModal() {
    // L·∫•y danh s√°ch t·∫•t c·∫£ m√≥n t·ª´ MENU g·ªëc (bi·∫øn menu to√†n c·ª•c)
    // ƒê·ªÉ ƒë·∫£m b·∫£o ng∆∞·ªùi d√πng c√≥ th·ªÉ ch·ªçn m√≥n ch∆∞a b√°n ƒë∆∞·ª£c bao gi·ªù
    let uniqueItems = [...new Set(menu.map(m => m.name))].sort();
    
    const listEl = document.getElementById('item-select-list');
    listEl.innerHTML = uniqueItems.map(name => {
        // Ki·ªÉm tra xem m√≥n n√†y c√≥ ƒëang ƒë∆∞·ª£c ch·ªçn kh√¥ng
        let isChecked = false;
        if (customSelectedItems) {
            isChecked = customSelectedItems.includes(name);
        }
        
        return `
        <label class="flex items-center justify-between p-3 bg-white border border-gray-100 rounded-xl cursor-pointer active:bg-gray-50 transition-colors">
            <span class="font-bold text-gray-700 text-sm select-none">${name}</span>
            <input type="checkbox" value="${name}" 
                ${isChecked ? 'checked' : ''} 
                onchange="handleItemCheck(this)"
                class="w-5 h-5 rounded border-gray-300 accent-[#006241]">
        </label>
        `;
    }).join('');

    updateSelectCount();
    document.getElementById('modal-item-select').classList.remove('hidden');
}
    function handleItemCheck(el) {
    // ƒê·∫øm s·ªë l∆∞·ª£ng ƒë√£ ch·ªçn
    const checkboxes = document.querySelectorAll('#item-select-list input[type="checkbox"]:checked');
    // if (checkboxes.length > 10) {
    //     alert("Ch·ªâ ƒë∆∞·ª£c ch·ªçn t·ªëi ƒëa 10 m√≥n!");
    //     el.checked = false;
    //     return;
    // }
    updateSelectCount();
}
    function updateSelectCount() {
    const count = document.querySelectorAll('#item-select-list input[type="checkbox"]:checked').length;
    document.getElementById('item-select-count').innerText = `ƒê√£ ch·ªçn: ${count} m√≥n`;
}

function filterItemSelectionList(keyword) {
    const kw = keyword.toLowerCase();
    const labels = document.querySelectorAll('#item-select-list label');
    labels.forEach(lbl => {
        const text = lbl.querySelector('span').innerText.toLowerCase();
        lbl.style.display = text.includes(kw) ? 'flex' : 'none';
    });
}
    function resetItemSelection() {
    customSelectedItems = null; // Reset v·ªÅ Null -> Auto Top 10
    document.getElementById('modal-item-select').classList.add('hidden');
    fetchRevenueDataMobile(currentRevMode);
}

function applyItemSelection() {
    const checkboxes = document.querySelectorAll('#item-select-list input[type="checkbox"]:checked');
    if (checkboxes.length === 0) {
        alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 m√≥n ho·∫∑c b·∫•m 'M·∫∑c ƒë·ªãnh'");
        return;
    }
    
    // L∆∞u danh s√°ch m√≥n ƒë√£ ch·ªçn v√†o bi·∫øn
    customSelectedItems = Array.from(checkboxes).map(cb => cb.value);
    
    document.getElementById('modal-item-select').classList.add('hidden');
    fetchRevenueDataMobile(currentRevMode);
}
// 3. H√†m v·∫Ω UI B·∫£ng X·∫øp H·∫°ng (Thay th·∫ø bi·ªÉu ƒë·ªì
// 2. C·∫≠p nh·∫≠t h√†m fetchRevenueDataMobile ƒë·ªÉ h·ªó tr·ª£ Custom Date
// (GHI ƒê√à h√†m c≈© ·ªü d√≤ng ~2965)
function fetchRevenueDataMobile(mode, startVal, endVal) {
    // 1. Qu·∫£n l√Ω hi·ªÉn th·ªã UI chung
    const summaryCards = document.getElementById('mob-revenue-summary-cards');
    
    // ·∫®n √¥ t·ªïng thu m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng ph·∫£i Overview
    if (currentRevenueView !== 'overview') {
        if(summaryCards) summaryCards.classList.add('hidden');
    } else {
        if(summaryCards) summaryCards.classList.remove('hidden');
    }

    document.getElementById('mob-rev-total').innerText = "...";
    
    // --- [M·ªöI] R·∫º NH√ÅNH CHO DOANH THU BED ---
    if (currentRevenueView === 'bed') {
        // G·ªçi Firebase l·∫•y d·ªØ li·ªáu Bed
        db.ref('bedBookings').once('value', snap => {
            const data = snap.val();
            let bookings = [];
            if(data) bookings = Object.values(data);
            
            // T√≠nh to√°n s·ªë li·ªáu Bed
            const bedStats = calculateBedStats(bookings, mode, startVal, endVal);
            
            // V·∫Ω giao di·ªán Bed
            updateRevenueBedUI(bedStats);
        });
        return; // D·ª™NG L·∫†I, kh√¥ng ch·∫°y ph·∫ßn orders b√™n d∆∞·ªõi
    }

    // ... (Ph·∫ßn logic cho orders c≈© gi·ªØ nguy√™n) ...
    db.ref('orders').once('value', snap => {
        // ... code c≈© ...
        const data = snap.val();
        let orders = [];
        if(data) orders = Object.values(data);
        
        if (currentRevenueView === 'overview') {
            const chartBox = document.getElementById('mob-rev-chart-bars');
            let isScrollMode = (mode === 'month') || (mode === 'custom' && (!startVal || !endVal || Math.abs(new Date(endVal) - new Date(startVal)) > 12 * 86400000));

            if (isScrollMode) {
                chartBox.className = "relative h-64 w-full flex items-end justify-start gap-3 mb-8 overflow-x-auto custom-scrollbar px-2 pb-2";
            } else {
                chartBox.className = "relative h-64 w-full flex items-end justify-between gap-2 mb-8 overflow-hidden px-1";
            }
            
            const stats = calculateStats(orders, mode, startVal, endVal);
            if(stats) updateRevenueUIMobile(stats, mode);
            
        } else if (currentRevenueView === 'items') {
            const result = calculateTopItems(orders, mode, startVal, endVal);
            updateRevenueItemsUI(result);
            
        } else if (currentRevenueView === 'groups') {
            const result = calculateGroupRevenue(orders, mode, startVal, endVal);
            updateRevenueGroupsUI(result);
        }
    });
}
function calculateGroupRevenue(orders, mode, customStart, customEnd) {
    // A. L·ªçc th·ªùi gian (Copy logic chu·∫©n)
    var now = new Date();
    var startTime, endTime;
    
    if (mode === 'week') {
        var day = now.getDay() || 7; 
        startTime = new Date(now); startTime.setDate(now.getDate() - day + 1); startTime.setHours(0,0,0,0);
        endTime = new Date(startTime); endTime.setDate(startTime.getDate() + 6); endTime.setHours(23,59,59,999);
    } else if (mode === 'month') {
        startTime = new Date(now.getFullYear(), now.getMonth(), 1);
        endTime = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
    } else if (mode === 'year') {
        startTime = new Date(now.getFullYear(), 0, 1);
        endTime = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
    } else { 
        if(!customStart || !customEnd) return { groups: [], totalRev: 0 };
        startTime = new Date(customStart); startTime.setHours(0,0,0,0);
        endTime = new Date(customEnd); endTime.setHours(23,59,59,999);
    }

    // B. T·ªïng h·ª£p d·ªØ li·ªáu theo NH√ìM
    let groupMap = {}; 
    let totalRevenue = 0; 

    orders.forEach(o => {
        var d = new Date(o.createdAt || Date.now());
        if (d >= startTime && d <= endTime) {
            totalRevenue += Number(o.total || 0);

            // H√†m ph·ª• ƒë·ªÉ x·ª≠ l√Ω t·ª´ng m√≥n
            const processItem = (name, qty, price) => {
                // 1. T√¨m m√≥n trong Menu g·ªëc ƒë·ªÉ l·∫•y Type
                // (So s√°nh ch·ªØ th∆∞·ªùng ƒë·ªÉ ch√≠nh x√°c h∆°n)
                const menuItem = menu.find(m => m.name.toLowerCase() === name.toLowerCase());
                
                // 2. X√°c ƒë·ªãnh nh√≥m (N·∫øu kh√¥ng t√¨m th·∫•y ho·∫∑c m√≥n ƒë√£ b·ªã x√≥a kh·ªèi menu -> Cho v√†o "Kh√°c")
                let groupName = menuItem ? menuItem.type : "Kh√°c";
                
                // Vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu cho ƒë·∫πp
                groupName = groupName.charAt(0).toUpperCase() + groupName.slice(1);

                if (!groupMap[groupName]) groupMap[groupName] = { qty: 0, total: 0 };
                groupMap[groupName].qty += qty;
                groupMap[groupName].total += (price * qty);
            };

            if (o.itemsArray && Array.isArray(o.itemsArray)) {
                o.itemsArray.forEach(item => {
                    processItem(item.name, item.qty || 1, item.price || 0);
                });
            } else if (o.items) {
                let parts = o.items.split(',');
                parts.forEach(p => {
                    let cleanP = p.trim(); 
                    let xIndex = cleanP.lastIndexOf('x');
                    if(xIndex > -1) {
                        let namePart = cleanP.substring(0, xIndex).trim();
                        let parenIndex = namePart.indexOf('(');
                        if(parenIndex > -1) namePart = namePart.substring(0, parenIndex).trim();
                        let qty = parseInt(cleanP.substring(xIndex+1)) || 1;
                        
                        // Gi√°: V√¨ string kh√¥ng l∆∞u gi√° l√∫c b√°n, ta l·∫•y t·∫°m gi√° hi·ªán t·∫°i trong menu
                        // (ƒê√¢y l√† h·∫°n ch·∫ø c·ªßa d·ªØ li·ªáu c≈©, nh∆∞ng ch·∫•p nh·∫≠n ƒë∆∞·ª£c)
                        const mInfo = menu.find(m => m.name.toLowerCase() === namePart.toLowerCase());
                        let estimatedPrice = mInfo ? (mInfo.priceM || mInfo.priceL || 0) : 0;
                        
                        processItem(namePart, qty, estimatedPrice);
                    }
                });
            }
        }
    });

    // C. Chuy·ªÉn Map th√†nh Array v√† S·∫Øp x·∫øp (Cao -> Th·∫•p)
    let sortedGroups = Object.keys(groupMap).map(key => {
        return { name: key, ...groupMap[key] };
    }).sort((a, b) => b.total - a.total);

    return { groups: sortedGroups, totalRev: totalRevenue };
}
function updateRevenueGroupsUI(data) {
    const container = document.getElementById('mob-rev-chart-bars');
    container.className = "w-full flex flex-col gap-3 pb-4"; 
    
    // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn d∆∞·ªõi ƒë√°y
    document.getElementById('mob-chart-total').innerText = data.totalRev.toLocaleString() + ' ‚Ç´';

    // Header ƒë∆°n gi·∫£n (Kh√¥ng c·∫ßn n√∫t Sort ph·ª©c t·∫°p v√¨ nh√≥m √≠t)
    let html = `
    <div class="flex justify-between items-center mb-3 pb-2 border-b border-dashed border-gray-200">
        <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Ph√¢n lo·∫°i doanh thu</span>
        <span class="text-[10px] font-bold text-gray-400">Cao ‚ûù Th·∫•p</span>
    </div>
    `;

    if (data.groups.length === 0) {
        container.innerHTML = html + '<div class="text-center text-gray-300 py-10 text-xs">Ch∆∞a c√≥ d·ªØ li·ªáu</div>';
        return;
    }

    const maxVal = Math.max(...data.groups.map(i => i.total), 1);

    html += '<div class="space-y-4">'; 

    html += data.groups.map((group, index) => {
        let percent = Math.round((group.total / maxVal) * 100);
        
        // Icon ƒë·∫°i di·ªán cho nh√≥m (Gi·∫£ l·∫≠p)
        let icon = "category"; // M·∫∑c ƒë·ªãnh
        if(group.name.toLowerCase().includes('c√† ph√™')) icon = "coffee";
        else if(group.name.toLowerCase().includes('tr√†')) icon = "local_cafe";
        else if(group.name.toLowerCase().includes('ƒÉn v·∫∑t')) icon = "cookie";
        else if(group.name.toLowerCase().includes('sinh t·ªë')) icon = "blender";
        
        // M√†u s·∫Øc Top 1
        let isTop1 = index === 0;
        let barColor = isTop1 ? 'bg-amber-500' : 'bg-[#006241]';
        let iconBg = isTop1 ? 'bg-amber-100 text-amber-600' : 'bg-gray-100 text-gray-500';

        return `
        <div class="w-full group">
            <div class="flex justify-between items-center mb-1.5">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full ${iconBg} flex items-center justify-center shadow-sm border border-white">
                        <span class="material-symbols-outlined text-[16px]">${icon}</span>
                    </div>
                    
                    <div class="flex flex-col">
                        <span class="font-black text-[13px] text-slate-800 leading-tight">${group.name}</span>
                        <span class="text-[9px] font-bold text-slate-400">ƒê√£ b√°n: ${group.qty}</span>
                    </div>
                </div>
                
                <div class="flex flex-col items-end">
                    <span class="font-black text-[13px] text-[#006241]">${group.total.toLocaleString()}</span>
                    <span class="text-[9px] font-bold text-slate-400">${Math.round((group.total/data.totalRev)*100)}%</span>
                </div>
            </div>
            
            <div class="w-full h-2.5 bg-gray-100 rounded-full overflow-hidden">
                <div class="h-full ${barColor} rounded-full transition-all duration-1000 ease-out relative" style="width: ${percent}%">
                    <div class="absolute inset-0 bg-white/20"></div>
                </div>
            </div>
        </div>
        `;
    }).join('');
    
    html += '</div>';

    container.innerHTML = html;
}
function updateRevenueUIMobile(stats, mode) {
    // 1. C·∫≠p nh·∫≠t S·ªë ti·ªÅn (Gi·ªØ nguy√™n)
    const totalRev = stats.drinkTotal + stats.snackTotal;
    document.getElementById('mob-rev-total').innerHTML = `
        <span class="text-3xl">${totalRev.toLocaleString()}</span> 
        <span class="text-xs font-bold opacity-60">‚Ç´</span>
    `;
    
    document.getElementById('mob-rev-snack').innerHTML = `
        <span class="text-3xl">${stats.snackTotal.toLocaleString()}</span>
        <span class="text-xs font-bold opacity-60">‚Ç´</span>
    `;
    
    // 2. V·∫Ω bi·ªÉu ƒë·ªì (Logic m·ªõi)
    const chartBox = document.getElementById('mob-rev-chart-bars');
    const labels = stats.labels; 
    const data = stats.chartData;
    const maxVal = Math.max(...data, 1); 

    // --- X√ÅC ƒê·ªäNH CH·∫æ ƒê·ªò HI·ªÇN TH·ªä C·ªòT ---
    // Logic ph·∫£i kh·ªõp v·ªõi h√†m fetchRevenueDataMobile
    // N·∫øu s·ªë l∆∞·ª£ng c·ªôt > 12 (t·ª©c l√† Th√°ng/Custom d√†i) -> D√πng c·ªôt c·ª©ng (Scroll)
    // N·∫øu <= 12 (Tu·∫ßn/NƒÉm) -> D√πng flex-1 (Fit m√†n h√¨nh)
    let isScrollMode = labels.length > 12;

    let barsHtml = '';
    labels.forEach((lbl, index) => {
        const val = data[index] || 0;
        
        let heightPct = 0;
        if (val > 0) {
            heightPct = Math.round((val / maxVal) * 100);
            if (heightPct < 15) heightPct = 15; 
        }
        
        const isMax = val === maxVal && val > 0;
        
        let labelVal = "";
        if (val >= 1000000) labelVal = (val/1000000).toFixed(1) + "tr";
        else if (val > 0) labelVal = (val/1000).toFixed(0) + "k";

        // --- CH·ªåN CLASS CSS CHO C·ªòT ---
        let colClass = "";
        if (isScrollMode) {
            // Ch·∫ø ƒë·ªô cu·ªôn: C·ªôt r·ªông c·ªë ƒë·ªãnh 40px, kh√¥ng co gi√£n
            colClass = "min-w-[40px] flex-shrink-0";
        } else {
            // Ch·∫ø ƒë·ªô th∆∞·ªùng: C·ªôt t·ª± co gi√£n ƒë·ªÉ l·∫•p ƒë·∫ßy m√†n h√¨nh
            colClass = "flex-1";
        }

        barsHtml += `
        <div class="${colClass} flex flex-col items-center group h-full justify-end relative">
            <div class="w-full relative flex flex-col justify-end items-center h-full">
                
                ${val > 0 ? `
                <div class="mb-1 text-[9px] font-black text-slate-500 bg-white/90 backdrop-blur px-1.5 py-0.5 rounded-md shadow-sm border border-slate-100 z-10 whitespace-nowrap">
                    ${labelVal}
                </div>` : ''}

                <div class="w-3 sm:w-5 rounded-t-lg transition-all duration-1000 ease-out ${isMax ? 'bg-[#006241]' : 'bg-[#006241]/40'}" 
                     style="height: ${heightPct}%;">
                </div>
            </div>
            <span class="mt-2 text-[9px] font-bold text-gray-400 uppercase tracking-wider truncate w-full text-center">${lbl}</span>
        </div>`;
    });
    chartBox.innerHTML = barsHtml;

    // 3. C√°c ph·∫ßn c·∫≠p nh·∫≠t nh√£n kh√°c (Gi·ªØ nguy√™n)
    const totalChart = data.reduce((a, b) => a + b, 0);
    document.getElementById('mob-chart-total').innerText = totalChart.toLocaleString() + ' ‚Ç´';
    
    const labelMap = {'week': 'Tu·∫ßn n√†y', 'month': 'Th√°ng n√†y', 'year': 'NƒÉm nay', 'custom': 'T√πy ch·ªçn'};
    let finalLabel = currentRevLabelOverride || labelMap[mode] || 'Chi ti·∫øt';
    const labelEl = document.getElementById('mob-chart-label');
    if(labelEl) labelEl.innerText = finalLabel;
}
    // --- LOGIC DATE RANGE PICKER M·ªöI ---

// 1. M·ªü Modal ch·ªçn ng√†y
// ============================================================
// --- LOGIC B·ªò L·ªåC NG√ÄY MOBILE (MODAL DATE PICKER) ---
// ============================================================

// 1. H√†m m·ªü Modal ch·ªçn ng√†y (Thay th·∫ø h√†m prompt c≈©)
function openMobileDateFilter() {
    const modal = document.getElementById('modal-date-range');
    if(modal) {
        modal.classList.remove('hidden');
        
        // T·ª± ƒë·ªông ƒëi·ªÅn ng√†y h√¥m nay n·∫øu √¥ tr·ªëng
        const today = new Date().toISOString().split('T')[0];
        const startInput = document.getElementById('filter-start-date');
        const endInput = document.getElementById('filter-end-date');
        
        if(startInput && !startInput.value) startInput.value = today;
        if(endInput && !endInput.value) endInput.value = today;
    } else {
        console.error("Kh√¥ng t√¨m th·∫•y modal-date-range");
    }
}

// 2. X·ª≠ l√Ω khi b·∫•m n√∫t "√Åp d·ª•ng"
function submitDateFilter() {
    const start = document.getElementById('filter-start-date').value;
    const end = document.getElementById('filter-end-date').value;

    if(!start || !end) return alert("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c");
    if(new Date(start) > new Date(end)) return alert("Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n ng√†y k·∫øt th√∫c");

    // ƒê√≥ng modal
    document.getElementById('modal-date-range').classList.add('hidden');

    // C·∫≠p nh·∫≠t bi·∫øn mode
    currentRevMode = 'custom';

    // Reset style c√°c n√∫t tab (ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt ƒëang ·ªü mode Custom)
    ['week', 'month', 'year'].forEach(m => {
        const btn = document.getElementById(`tab-rev-${m}`);
        if(btn) btn.className = "flex-1 py-2.5 rounded-full text-[11px] font-bold text-slate-400 transition-all";
    });

    // G·ªçi h√†m l·∫•y d·ªØ li·ªáu
    fetchRevenueDataMobile('custom', start, end);
}
function switchRevTime(mode) {
    currentRevMode = mode;
    currentRevLabelOverride = null; // [FIX] Reset t√™n t√πy ch·ªânh khi b·∫•m n√∫t Tab th∆∞·ªùng

    // Update active tab style
    ['week', 'month', 'year'].forEach(m => {
        const btn = document.getElementById(`tab-rev-${m}`);
        if(m === mode) {
            btn.className = "flex-1 py-2.5 rounded-full text-[11px] font-black bg-[#065F46] text-white shadow-sm transition-all";
        } else {
            btn.className = "flex-1 py-2.5 rounded-full text-[11px] font-bold text-slate-400 transition-all";
        }
    });
    fetchRevenueDataMobile(mode);
}


function toggleRevenueDropdown() {
    const dd = document.getElementById('mob-revenue-dropdown');
    const ol = document.getElementById('mob-revenue-overlay');
    if(dd.classList.contains('hidden')) {
        dd.classList.remove('hidden');
        ol.classList.remove('hidden');
    } else {
        dd.classList.add('hidden');
        ol.classList.add('hidden');
    }
}   
    // --- [FIX] MODULE: C√ÅC H√ÄM H·ªñ TR·ª¢ & MOBILE LOGIC (CLEAN) ---
// ============================================================

// 1. H√†m h·ªó tr·ª£ ch·ªçn ti·ªÅn nhanh Mobile (ƒê√£ g·ªôp & Fix l·ªói)
function quickPaidMobile(v) {
    let input = document.getElementById('cash-paid-mobile');
    if(input) {
        // Th√™m d·∫•u ph·∫©y ƒë·ªãnh d·∫°ng chu·∫©n US
        input.value = v.toLocaleString('en-US'); 
        // K√≠ch ho·∫°t t√≠nh to√°n l·∫°i ti·ªÅn th·ª´a
        if(typeof syncMobileInputs === 'function') syncMobileInputs();
        
        // Rung ph·∫£n h·ªìi (n·∫øu c√≥)
        if(navigator.vibrate) navigator.vibrate(50);
    }
}
    // 3. H√†m Ch·ªçn Th·ªùi L∆∞·ª£ng (ƒê·ªïi t√™n ƒë·ªÉ tr√°nh xung ƒë·ªôt v·ªõi PC)
function selectDurationNew(hours) {
    selectedDurationHours = hours;
    
    // C·∫≠p nh·∫≠t gi√° tr·ªã v√†o input ·∫©n (ƒë·ªÉ logic c≈© v·∫´n hi·ªÉu)
    const hiddenInput = document.getElementById('final_duration_minutes');
    if(hiddenInput) hiddenInput.value = hours * 60;

    // Reset giao di·ªán n√∫t
    [1, 2, 3].forEach(h => {
        const btn = document.getElementById(`btn-dur-${h}`);
        if(btn) btn.className = "border border-gray-200 bg-white text-gray-600 py-2.5 rounded-xl text-sm font-bold hover:bg-gray-50 transition-all";
    });

    // Highlight n√∫t ƒë∆∞·ª£c ch·ªçn
    const activeBtn = document.getElementById(`btn-dur-${hours}`);
    if(activeBtn) activeBtn.className = "border border-green-600 bg-green-50 text-[#006241] py-2.5 rounded-xl text-sm font-bold shadow-sm transition-all";
}
function calculateBedStats(bookings, mode, customStart, customEnd) {
    // 1. THI·∫æT L·∫¨P TH·ªúI GIAN L·ªåC (Logic chu·∫©n)
    var now = new Date();
    var startTime, endTime;
    
    if (mode === 'week') {
        var day = now.getDay() || 7; 
        startTime = new Date(now); startTime.setDate(now.getDate() - day + 1); startTime.setHours(0,0,0,0);
        endTime = new Date(startTime); endTime.setDate(startTime.getDate() + 6); endTime.setHours(23,59,59,999);
    } else if (mode === 'month') {
        startTime = new Date(now.getFullYear(), now.getMonth(), 1);
        endTime = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
    } else if (mode === 'year') {
        startTime = new Date(now.getFullYear(), 0, 1);
        endTime = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
    } else { 
        if(!customStart || !customEnd) return null;
        startTime = new Date(customStart); startTime.setHours(0,0,0,0);
        endTime = new Date(customEnd); endTime.setHours(23,59,59,999);
    }

    // 2. KH·ªûI T·∫†O BI·∫æN TH·ªêNG K√ä
    let stats = {
        totalRevenue: 0,
        totalUsage: 0,
        topSpenders: {},
        topFrequent: {},
        cancelTimeout: 0,
        cancelCustomer: 0, // ƒê·∫øm chung cho h·ªßy th·ªß c√¥ng (Kh√°ch + Qu√°n)
        cancelList: []
    };

    // 3. DUY·ªÜT QUA DANH S√ÅCH BOOKING
    bookings.forEach(b => {
        // Parse ng√†y booking (d·ªØ li·ªáu chu·∫©n dd/mm/yyyy)
        let parts = (b.date || "").split('/');
        if(parts.length !== 3) return;
        let bDate = new Date(parts[2], parts[1]-1, parts[0]);
        
        // Ki·ªÉm tra xem ƒë∆°n n√†y c√≥ n·∫±m trong kho·∫£ng th·ªùi gian ƒëang l·ªçc kh√¥ng
        if (bDate >= startTime && bDate <= endTime) {
            
            // --- TR∆Ø·ªúNG H·ª¢P 1: ƒê√É XONG (T√çNH TI·ªÄN & L∆Ø·ª¢T) ---
            if (b.status === 'ƒë√£ xong') {
                // [FIX QUAN TR·ªåNG] L·∫•y totalSpend t·ª´ DB. 
                // L∆∞u √Ω: C√°c ƒë∆°n c≈© tr∆∞·ªõc khi update code tr·∫£ bed s·∫Ω kh√¥ng c√≥ tr∆∞·ªùng n√†y (l√† 0).
                let money = Number(b.totalSpend || 0);
                
                stats.totalRevenue += money;
                stats.totalUsage++;

                // Th·ªëng k√™ Top Spender (Ai chi nhi·ªÅu ti·ªÅn nh·∫•t)
                let key = b.phone || "V√£ng lai";
                if (!stats.topSpenders[key]) stats.topSpenders[key] = { name: b.name, total: 0, phone: key };
                stats.topSpenders[key].total += money;

                // Th·ªëng k√™ Top Frequent (Ai ƒëi nhi·ªÅu l·∫ßn nh·∫•t)
                if (!stats.topFrequent[key]) stats.topFrequent[key] = { name: b.name, count: 0, phone: key };
                stats.topFrequent[key].count++;
            } 
            // --- TR∆Ø·ªúNG H·ª¢P 2: ƒê√É H·ª¶Y (PH√ÇN LO·∫†I L√ù DO) ---
            else if (b.status === 'ƒë√£ h·ªßy') {
                if (b.cancelType === 'auto_timeout') {
                    // H·ªßy t·ª± ƒë·ªông do qu√° gi·ªù
                    stats.cancelTimeout++;
                } else {
                    // [FIX] H·ªßy th·ªß c√¥ng (Kh√°ch b√°o h·ªßy HO·∫∂C Qu√°n h·ªßy system)
                    // Gom chung v√†o ƒë√¢y ƒë·ªÉ hi·ªán s·ªë li·ªáu l√™n Dashboard
                    stats.cancelCustomer++;
                }
                
                // L∆∞u v√†o danh s√°ch ƒë·ªÉ hi·ªán chi ti·∫øt khi b·∫•m n√∫t Xem th√™m
                stats.cancelList.push(b);
            }
        }
    });

    // 4. S·∫ÆP X·∫æP V√Ä C·∫ÆT L·∫§Y TOP 5
    // Top ti·ªÅn: Cao -> Th·∫•p
    stats.topSpendersArr = Object.values(stats.topSpenders).sort((a,b) => b.total - a.total).slice(0, 5);
    // Top l·∫ßn: Cao -> Th·∫•p
    stats.topFrequentArr = Object.values(stats.topFrequent).sort((a,b) => b.count - a.count).slice(0, 5);

    return stats;
}
function updateRevenueBedUI(stats) {
    if(!stats) return;

    // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn d∆∞·ªõi ƒë√°y (Hi·ªÉn th·ªã t·ªïng thu Bed)
    document.getElementById('mob-chart-total').innerText = stats.totalRevenue.toLocaleString() + ' ‚Ç´';

    const container = document.getElementById('mob-rev-chart-bars');
    
    // Reset layout container: Cho ph√©p cu·ªôn d·ªçc n·ªôi dung b√™n trong
    container.className = "w-full flex flex-col gap-5 pb-4 overflow-visible"; 
    
    // --- 1. HAI √î T·ªîNG QUAN (Bed Rev & Bed Usage) ---
    let html = `
    <div class="grid grid-cols-2 gap-3 mb-2">
        <div class="bg-emerald-50/50 p-4 rounded-[20px] border border-emerald-100 flex flex-col items-center justify-center text-center">
            <p class="text-[9px] font-black uppercase tracking-widest text-emerald-600 mb-1">T·ªïng thu Bed</p>
            <p class="text-2xl font-black text-[#006241]">${stats.totalRevenue.toLocaleString()}<span class="text-xs ml-1 opacity-70">ƒë</span></p>
        </div>
        <div class="bg-blue-50/50 p-4 rounded-[20px] border border-blue-100 flex flex-col items-center justify-center text-center">
            <p class="text-[9px] font-black uppercase tracking-widest text-blue-600 mb-1">S·ªë l∆∞·ª£t d√πng</p>
            <p class="text-2xl font-black text-blue-700">${stats.totalUsage}<span class="text-xs ml-1 opacity-70">l∆∞·ª£t</span></p>
        </div>
    </div>
    `;

    // --- 2. TOP 5 KH√ÅCH CHI TI√äU ---
    html += `
    <div class="bg-gray-50/50 rounded-2xl p-4 border border-gray-100">
        <div class="flex items-center gap-2 mb-3">
            <span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span>
            <h4 class="text-[11px] font-black uppercase tracking-wider text-gray-500">Top 5 Chi Ti√™u</h4>
        </div>
        <div class="space-y-2.5">`;
    
    if(stats.topSpendersArr.length === 0) html += '<p class="text-xs text-center text-gray-400 py-2">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
    else {
        stats.topSpendersArr.forEach((user, idx) => {
            let medal = idx === 0 ? "ü•á" : (idx === 1 ? "ü•à" : (idx === 2 ? "ü•â" : `#${idx+1}`));
            html += `
            <div class="flex justify-between items-center text-sm">
                <div class="flex items-center gap-2 overflow-hidden">
                    <span class="text-xs w-5 text-center font-bold text-gray-400">${medal}</span>
                    <span class="font-bold text-slate-700 truncate">${user.name}</span>
                </div>
                <span class="font-black text-[#006241] whitespace-nowrap">${user.total.toLocaleString()}</span>
            </div>`;
        });
    }
    html += `</div></div>`;

    // --- 3. TOP 5 KH√ÅCH ƒê·∫∂T NHI·ªÄU ---
    html += `
    <div class="bg-gray-50/50 rounded-2xl p-4 border border-gray-100">
        <div class="flex items-center gap-2 mb-3">
            <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span>
            <h4 class="text-[11px] font-black uppercase tracking-wider text-gray-500">Top 5 Th∆∞·ªùng Xuy√™n</h4>
        </div>
        <div class="space-y-2.5">`;
        
    if(stats.topFrequentArr.length === 0) html += '<p class="text-xs text-center text-gray-400 py-2">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
    else {
        stats.topFrequentArr.forEach((user, idx) => {
            html += `
            <div class="flex justify-between items-center text-sm">
                <div class="flex items-center gap-2 overflow-hidden">
                    <span class="w-5 h-5 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-[10px] font-bold">${idx+1}</span>
                    <span class="font-bold text-slate-700 truncate">${user.name}</span>
                </div>
                <span class="font-black text-blue-600">${user.count} <span class="text-[9px] font-medium text-gray-400">l·∫ßn</span></span>
            </div>`;
        });
    }
    html += `</div></div>`;

    // --- 4. TH√îNG TIN H·ª¶Y ---
    // L∆∞u bi·∫øn to√†n c·ª•c t·∫°m ƒë·ªÉ d√πng cho modal
    window.currentCancelList = stats.cancelList; 

    html += `
    <div class="bg-red-50 rounded-2xl p-4 border border-red-100 relative overflow-hidden">
        <div class="flex justify-between items-start mb-3 relative z-10">
            <div>
                <h4 class="text-[11px] font-black uppercase tracking-wider text-red-500 mb-1">Th·ªëng k√™ h·ªßy</h4>
                <p class="text-[9px] font-medium text-red-400">T·ªïng c·ªông: ${stats.cancelTimeout + stats.cancelCustomer} l·ªãch</p>
            </div>
            <button onclick="showCancelDetailsModal()" class="bg-white text-red-500 text-[10px] font-bold px-3 py-1.5 rounded-lg shadow-sm active:scale-95 transition-all border border-red-100">
                Xem chi ti·∫øt
            </button>
        </div>
        
        <div class="grid grid-cols-2 gap-3 relative z-10">
            <div class="bg-white/60 rounded-xl p-2.5 flex flex-col items-center">
                <span class="text-2xl font-black text-red-600">${stats.cancelTimeout}</span>
                <span class="text-[9px] font-bold text-gray-500 uppercase">Qu√° gi·ªù</span>
            </div>
            <div class="bg-white/60 rounded-xl p-2.5 flex flex-col items-center">
                <span class="text-2xl font-black text-red-600">${stats.cancelCustomer}</span>
                <span class="text-[9px] font-bold text-gray-500 uppercase">Kh√°ch h·ªßy</span>
            </div>
        </div>
    </div>
    `;

    container.innerHTML = html;
}

// --- H√ÄM PH·ª§: M·ªû MODAL CHI TI·∫æT H·ª¶Y ---
function showCancelDetailsModal() {
    const list = window.currentCancelList || [];
    const container = document.getElementById('cancel-list-content');
    
    if(list.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-400 py-10">Kh√¥ng c√≥ l·ªãch h·ªßy n√†o.</div>';
    } else {
        container.innerHTML = list.map(b => {
            // [FIX] Hi·ªÉn th·ªã ƒë√∫ng l√Ω do
            let reason = 'Kh√°ch y√™u c·∫ßu';
            let badgeColor = 'text-red-500 bg-red-50 border-red-100';
            
            if (b.cancelType === 'auto_timeout') {
                reason = 'Qu√° gi·ªù (Auto)';
                badgeColor = 'text-gray-500 bg-gray-100 border-gray-200';
            } else if (b.cancelType === 'store') {
                reason = 'Qu√°n h·ªßy (System)';
                badgeColor = 'text-orange-600 bg-orange-50 border-orange-100';
            }
            
            let date = b.date || b.bookingDate || '--/--';
            
            return `
            <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                <div class="flex justify-between mb-1">
                    <span class="font-bold text-sm text-gray-800">${b.name}</span>
                    <span class="text-[10px] font-bold px-2 py-0.5 rounded border ${badgeColor}">${reason}</span>
                </div>
                <div class="flex justify-between text-[10px] text-gray-500">
                    <span>${date} ‚Ä¢ ${b.start}-${b.end}</span>
                    <span class="font-mono">${b.phone}</span>
                </div>
                ${b.note ? `<p class="text-[10px] text-gray-400 italic mt-1 border-t border-gray-200 pt-1">"${b.note}"</p>` : ''}
            </div>
            `;
        }).join('');
    }
    
    document.getElementById('modal-cancel-list').classList.remove('hidden');
}
    // --- H√ÄM V·∫º DANH S√ÅCH L·ªäCH S·ª¨ MOBILE (B·ªä THI·∫æU) ---
function renderHistoryMobile(data) {
    const container = document.getElementById('mob-history-list');
    if(!container) return;

    // Gom nh√≥m theo ng√†y
    const grouped = data.reduce((acc, obj) => { 
        const key = obj.dateStr; if (!acc[key]) acc[key] = []; acc [key].push(obj); return acc; 
    }, {}); 

    let html = "";
    
    // S·∫Øp x·∫øp ng√†y m·ªõi nh·∫•t l√™n ƒë·∫ßu
    Object.keys(grouped).sort((a,b) => {
         const da = a.split('/').reverse().join(''); const db = b.split('/').reverse().join(''); return db.localeCompare(da);
    }).forEach(date => {
        
        // Header ng√†y (Style t·ªëi gi·∫£n, n·ªÅn tr·∫Øng)
        html += `
        <div class="flex items-center gap-3 mb-4 mt-6">
            <span class="text-[12px] font-black text-[#1e3932] uppercase tracking-widest bg-white pr-2 sticky top-0">${date}</span>
            <div class="h-[1px] flex-1 bg-gray-100"></div>
        </div>
        <div class="space-y-4">`;
        
        grouped[date].forEach(h => {
            const realIdx = historyData.findIndex(item => item.id === h.id);
            
            // Logic m√†u s·∫Øc
            let isRefund = h.total < 0;
            let amountColor = isRefund ? "text-red-500" : "text-[#1e3932]";
            // Card n·ªÅn x√°m nh·∫°t (bg-gray-50) ƒë·ªÉ n·ªïi b·∫≠t tr√™n n·ªÅn tr·∫Øng t·ªïng th·ªÉ (gi·ªëng style Revenue)
            let cardBg = "bg-gray-50/80"; 
            let iconBg = isRefund ? "bg-red-100 text-red-500" : "bg-white text-[#006241]";
            let icon = isRefund ? "undo" : "receipt_long";

            // T√äN ƒê∆†N H√ÄNG L√Ä GI·ªú (h.timeStr)
            html += `
            <div onclick="showHistoryDetailMobile(${realIdx})" class="${cardBg} p-5 rounded-[24px] border border-transparent active:border-[#006241]/20 active:scale-[0.98] transition-all flex items-center justify-between relative overflow-hidden group">
                
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-[18px] ${iconBg} flex items-center justify-center shadow-sm border border-gray-100 shrink-0">
                        <span class="material-symbols-outlined font-bold">${icon}</span>
                    </div>
                    
                    <div class="min-w-0">
                        <h3 class="font-black text-xl text-[#1e3932] leading-none mb-1.5 tracking-tight">${h.timeStr}</h3>
                        
                        <p class="text-[11px] font-bold text-gray-400 truncate flex items-center gap-1.5">
                            <span class="font-mono text-[10px]">#${h.id.toString().slice(-4)}</span>
                            <span class="w-1 h-1 rounded-full bg-gray-300"></span>
                            <span class="truncate max-w-[100px]">${h.sdt || 'Kh√°ch l·∫ª'}</span>
                        </p>
                    </div>
                </div>

                <div class="text-right shrink-0 ml-2">
                    <p class="font-black text-lg ${amountColor} tracking-tight leading-none">${Number(h.total).toLocaleString()}<span class="text-xs opacity-60 ml-0.5 font-bold align-top">ƒë</span></p>
                    <p class="text-[9px] font-bold text-gray-400 mt-1 uppercase tracking-wider text-right">${h.method}</p>
                </div>
            </div>`;
        });
        html += `</div>`;
    });

    container.innerHTML = html;
}

// --- H√ÄM T√åM KI·∫æM TR√äN MOBILE ---
function filterHistoryMobile(keyword) {
    const kw = keyword.toLowerCase();
    const filtered = historyData.filter(h => 
        (h.sdt && h.sdt.toLowerCase().includes(kw)) || 
        h.total.toString().includes(kw) ||
        (h.id && h.id.toString().toLowerCase().includes(kw))
    );
    renderHistoryMobile(filtered);
}
    // --- [M·ªöI] H√ÄM X·ª¨ L√ù G·ªåI M√ìN T·ª™ MOBILE (T·ª∞ ƒêI·ªÄN SƒêT) ---
function handleMobileBedOrder(bookingId) {
    // 1. T√¨m th√¥ng tin ƒë∆°n ƒë·∫∑t trong bi·∫øn to√†n c·ª•c
    const booking = globalAllBookings.find(b => b.id === bookingId);
    
    if (!booking) return console.error("Kh√¥ng t√¨m th·∫•y booking ID:", bookingId);

    // 2. C·∫≠p nh·∫≠t bi·∫øn tr·∫°ng th√°i Bed
    // N·∫øu Bed ƒëang ch·ªù (WAITING) th√¨ ch∆∞a c√≥ bedId, ta d√πng activeOrderingBedId ƒë·ªÉ h·ªá th·ªëng bi·∫øt ƒëang x·ª≠ l√Ω ƒë∆°n n√†o
    activeOrderingBedId = booking.bedId || "WAITING"; 
    pendingBedOrder = booking; 

    // 3. T·ª∞ ƒê·ªòNG ƒêI·ªÄN S·ªê ƒêI·ªÜN THO·∫†I
    var sdtInput = document.getElementById('kh-sdt');
    if (sdtInput && booking.phone) {
        sdtInput.value = booking.phone;
        
        // K√≠ch ho·∫°t h√†m ki·ªÉm tra kh√°ch h√†ng (ƒë·ªÉ hi·ªán t√™n v√† ƒëi·ªÉm t√≠ch l≈©y)
        if (typeof checkSdtLive === 'function') {
            checkSdtLive(); 
        }
    }

    // 4. Chuy·ªÉn sang giao di·ªán Menu
    switchView('menu');

    // 5. (T√πy ch·ªçn) Hi·ªÉn th·ªã thanh th√¥ng b√°o nh·ªè tr√™n gi·ªè h√†ng ƒë·ªÉ bi·∫øt ƒëang order cho ai
    setTimeout(function() {
        var cartInfo = document.getElementById('cart-bed-info');
        var headerContainer = document.querySelector('#sidebar-cart .flex.justify-between');
        
        // N·∫øu ch∆∞a c√≥ thanh th√¥ng b√°o th√¨ t·∫°o m·ªõi (Logic l·∫•y t·ª´ PC sang)
        if (!cartInfo && headerContainer) {
            cartInfo = document.createElement('div');
            cartInfo.id = 'cart-bed-info';
            headerContainer.parentNode.insertBefore(cartInfo, headerContainer.nextSibling);
        }
        
        if (cartInfo) {
            var guestName = booking.name || "Kh√°ch h√†ng";
            cartInfo.className = "text-[11px] font-black uppercase mb-2 pl-1 mt-1 animate-pulse";
            
            if (booking.bedId && booking.bedId != "WAITING") {
                cartInfo.innerText = `üü¢ ƒêANG G·ªåI: BED 0${booking.bedId} - ${guestName}`;
                cartInfo.style.color = "#006241";
            } else {
                cartInfo.innerText = `üü† ƒêANG G·ªåI: KH√ÅCH CH·ªú - ${guestName}`;
                cartInfo.style.color = "#d97706";
            }
        }
    }, 100);
}
    // --- [CORE] H√ÄM QU√âT V√Ä H·ª¶Y ƒê∆†N TR·ªÑ (D√ôNG CHUNG) ---
// Gi√∫p Mobile t·ª± ƒë·ªông h·ªßy ƒë∆°n Waiting qu√° 50p m√† kh√¥ng c·∫ßn m·ªü PC
function runAutoCancelScan(list) {
    if (!list || list.length === 0) return;
    
    const now = new Date();
    const AUTO_CANCEL_MINUTES = 50; 
    const todayStr = new Date().toLocaleDateString('en-GB'); // dd/mm/yyyy

    list.forEach(booking => {
        // Ch·ªâ qu√©t ƒë∆°n CH·ªú KH√ÅCH c·ªßa H√îM NAY
        if ((booking.status === 'ch·ªù kh√°ch' || !booking.status) && 
            (!booking.displayDate || booking.displayDate === todayStr)) {
            
            if (booking.start && booking.start.includes(':')) {
                let parts = booking.start.split(':');
                let bookingTime = new Date();
                bookingTime.setHours(parseInt(parts[0]), parseInt(parts[1]), 0);

                let diff = (now - bookingTime) / 60000; // Ph√∫t tr·ªÖ

                // N·∫øu tr·ªÖ > 50p -> H·ª¶Y NGAY
                if (diff > AUTO_CANCEL_MINUTES) {
                    console.log(`üö´ Mobile Auto-cancel: ƒê∆°n ${booking.name} tr·ªÖ ${Math.round(diff)}p`);
                    
                    let bookingId = booking.id || booking.key;
                    if (bookingId) {
                        firebase.database().ref('bedBookings/' + bookingId).update({
                            status: 'ƒë√£ h·ªßy',
                            cancelType: 'auto_timeout',
                            note: 'H·ªßy t·ª± ƒë·ªông (Qu√° 50p)'
                        });
                    }
                }
            }
        }
    });
}
// --- H√ÄM T·ª∞ ƒê·ªòNG T√çNH GI·ªú (Logic 4h + h5) ---
function autoAddBedItems(booking) {
    if (!booking || !booking.start || !booking.end) return;

    // Ch·∫∑n duplicate
    const hasBedItem = cart.some(i => i.name.toLowerCase().includes('bed'));
    if (hasBedItem) return;

    let sParts = booking.start.split(':');
    let eParts = booking.end.split(':');
    
    let startMin = parseInt(sParts[0]) * 60 + parseInt(sParts[1]);
    let endMin = parseInt(eParts[0]) * 60 + parseInt(eParts[1]);

    if (endMin <= startMin) return;

    let diffMins = endMin - startMin;
    let totalHours = Math.ceil(diffMins / 60);

    console.log(`ü§ñ Auto-add Bed: ${totalHours}h`);

    for (let h = 1; h <= totalHours; h++) {
        if (h <= 4) autoAddMenuItemToCart("1h bed");
        else autoAddMenuItemToCart("1h bed t·ª´ h5");
    }
    
    // C·∫≠p nh·∫≠t l·∫°i UI gi·ªè h√†ng sau khi th√™m
    renderCart(); 
}

function autoAddMenuItemToCart(itemName) {
    const item = menu.find(m => m.name.toLowerCase() === itemName.toLowerCase());
    if (item) {
        let price = item.priceM > 0 ? item.priceM : item.priceL;
        addToCart(item.name, 'M', price); 
    }
}
    // 1. H√†m b·∫≠t popup ch·ªçn ng√†y (Thay th·∫ø alert t√≠nh nƒÉng ƒëang ph√°t tri·ªÉn)
document.addEventListener('DOMContentLoaded', updateCartPadding);

</script>
<div id="modal-cleaning-fee" class="fixed inset-0 bg-black/40 z-[9999] hidden flex items-center justify-center p-6 backdrop-blur-[4px]">
    <div class="bg-white/95 backdrop-blur-2xl w-full max-w-[340px] rounded-[35px] shadow-[0_30px_70px_rgba(0,0,0,0.3)] text-center border border-white/60 p-8 transform scale-100 transition-all">
        
        <div class="w-14 h-14 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm border border-red-100">
            <span class="text-2xl">üßπ</span>
        </div>
        
        <h3 class="text-lg font-black text-gray-800 uppercase tracking-wide mb-1">Ph√≠ V·ªá Sinh</h3>
        <p class="text-[11px] text-gray-400 font-bold uppercase tracking-wider mb-6">Ch·ªçn m·ª©c ph√≠ l∆∞u n·ª£ l·∫ßn sau</p>

        <div class="grid grid-cols-3 gap-3 mb-6">
            <button onclick="submitCleaningFee(20000)" class="py-4 bg-white border border-gray-100 rounded-[20px] text-gray-700 font-black text-xs shadow-sm active:scale-95 transition-all hover:border-red-500 hover:text-red-500 hover:shadow-md">
                20K
            </button>
            <button onclick="submitCleaningFee(30000)" class="py-4 bg-white border border-gray-100 rounded-[20px] text-gray-700 font-black text-xs shadow-sm active:scale-95 transition-all hover:border-red-500 hover:text-red-500 hover:shadow-md">
                30K
            </button>
            <button onclick="submitCleaningFee(50000)" class="py-4 bg-white border border-gray-100 rounded-[20px] text-gray-700 font-black text-xs shadow-sm active:scale-95 transition-all hover:border-red-500 hover:text-red-500 hover:shadow-md">
                50K
            </button>
        </div>

        <button onclick="document.getElementById('modal-cleaning-fee').classList.add('hidden')" 
            class="text-gray-400 font-bold text-xs hover:text-gray-600 underline decoration-dashed underline-offset-4">
            ƒê√≥ng
        </button>
    </div>
</div>
<div id="ios-confirm-modal" class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-black/30 backdrop-blur-[4px] transition-opacity duration-300 p-6">
    <div class="bg-white/90 backdrop-blur-2xl w-full max-w-[320px] rounded-[35px] shadow-[0_20px_60px_rgba(0,0,0,0.2)] text-center overflow-hidden border border-white/40">
        
        <div class="p-8 pb-6">
            <h3 class="text-xl font-black text-[#006241] mb-2 tracking-wide">X√°c Nh·∫≠n</h3>
            <p id="ios-modal-message" class="text-sm text-gray-600 font-medium leading-relaxed">
                N·ªôi dung x√°c nh·∫≠n...
            </p>
        </div>

        <div class="grid grid-cols-2 gap-0 border-t border-gray-200/50 bg-white/50">
            <button onclick="closeIOSModal()" 
                class="py-5 text-sm text-gray-500 font-bold hover:bg-gray-100 transition-colors border-r border-gray-200/50">
                H·ªßy b·ªè
            </button>
            <button id="ios-confirm-btn" 
                class="py-5 text-sm text-[#006241] font-black hover:bg-green-50 transition-colors">
                ƒê·ªìng √Ω
            </button>
        </div>
    </div>
</div>
<div id="qr-modal" class="fixed inset-0 bg-black/80 z-[100000] hidden flex items-center justify-center p-6 backdrop-blur-md">
    <div class="bg-white rounded-[30px] p-8 max-w-sm w-full text-center shadow-2xl relative">
        <button onclick="document.getElementById('qr-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 text-2xl">‚úï</button>
        <h3 class="text-[#006241] font-black text-xl uppercase mb-6">Qu√©t m√£ thanh to√°n</h3>
        <img id="vietqr-img" src="" class="w-64 h-64 mx-auto mb-4 rounded-xl border border-gray-100">
        <div class="bg-yellow-50 p-3 rounded-xl mb-4">
            <p class="text-[10px] text-gray-500 font-bold uppercase">N·ªôi dung chuy·ªÉn kho·∫£n</p>
            <p id="qr-content" class="text-xl font-black text-[#006241]">--</p>
        </div>
        <div id="qr-status" class="text-gray-400 font-bold text-xs animate-pulse">ƒêang ƒë·ª£i ti·ªÅn v·ªÅ...</div>
    </div>
</div>
<div id="modal-cancel-reason" class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-black/30 backdrop-blur-[4px] transition-opacity duration-300 p-6">
    <div class="bg-white/95 backdrop-blur-xl w-full max-w-[340px] rounded-[35px] shadow-[0_30px_70px_rgba(0,0,0,0.25)] text-center transform scale-100 transition-all border border-white/50 p-8">
        
        <div class="w-14 h-14 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm border border-red-100">
            <span class="text-2xl">üóëÔ∏è</span>
        </div>
        
        <h3 class="text-lg font-black text-gray-800 uppercase tracking-wide mb-1">H·ªßy L·ªãch N√†y?</h3>
        <p class="text-[11px] text-gray-400 font-bold uppercase tracking-wider mb-6">Vui l√≤ng ch·ªçn l√Ω do h·ªßy</p>

        <div class="space-y-3 mb-6">
            <button onclick="submitCancelBooking('customer')" 
                class="w-full py-4 bg-white border border-gray-100 rounded-[20px] text-gray-700 font-bold text-xs uppercase shadow-sm active:scale-95 transition-all hover:border-[#006241] hover:text-[#006241] hover:shadow-md flex items-center justify-center gap-2">
                <span>üë§</span> Kh√°ch b√°o h·ªßy
            </button>
            <button onclick="submitCancelBooking('store')" 
                class="w-full py-4 bg-white border border-gray-100 rounded-[20px] text-gray-700 font-bold text-xs uppercase shadow-sm active:scale-95 transition-all hover:border-[#006241] hover:text-[#006241] hover:shadow-md flex items-center justify-center gap-2">
                <span>üè™</span> Qu√°n h·ªßy (System)
            </button>
        </div>

        <button onclick="document.getElementById('modal-cancel-reason').classList.add('hidden')" 
            class="text-gray-400 font-bold text-xs hover:text-gray-600 underline decoration-dashed underline-offset-4">
            ƒê√≥ng, kh√¥ng h·ªßy n·ªØa
        </button>
    </div>
</div>
    <div id="mobile-bottom-bar" class="hidden md:hidden fixed bottom-6 left-4 right-4 h-24 bg-white/90 backdrop-blur-xl rounded-[3rem] shadow-[0_10px_40px_rgba(0,0,0,0.1)] border border-white/60 flex items-center justify-between p-2 z-[9000] transition-all duration-300">
    
    <div onclick="openCartModal()" class="flex-1 h-full pl-6 flex flex-col justify-center cursor-pointer group">
        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-0.5 group-active:text-[#006241]">T·ªïng t·∫°m t√≠nh</p>
        <div class="flex items-center gap-2">
            <p id="mob-bar-total" class="brand-font text-2xl text-[#1e3932] font-black tracking-tight">0ƒë</p>
            <span class="text-[10px] font-bold text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full group-active:bg-green-100 group-active:text-[#006241]">^</span>
        </div>
    </div>

    <button onclick="switchView('payment')" class="h-full px-10 bg-[#006241] text-white rounded-[2.5rem] font-bold uppercase text-xs shadow-lg active:scale-95 transition-all flex items-center gap-2 hover:bg-[#004f32]">
        <span>Thanh to√°n</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
        </svg>
    </button>
</div>
   <div id="split-payment-modal" class="hidden fixed inset-0 z-[100000] flex items-end justify-center bg-black/40 backdrop-blur-md">
    <div class="bg-white/95 backdrop-blur-2xl w-full max-h-[95vh] rounded-t-3xl shadow-2xl overflow-hidden flex flex-col border border-white/50">
        <!-- Header gi·ªëng gi·ªè h√†ng: title xanh bold uppercase, n√∫t X -->
        <div class="p-5 border-b border-gray-100/50 flex justify-between items-center relative">
            <h3 class="text-2xl font-black uppercase text-[#006241] absolute left-1/2 transform -translate-x-1/2">Thu ti·ªÅn ri√™ng</h3>
            <button onclick="closeSplitModal()" class="w-10 h-10 rounded-full bg-gray-100/80 flex items-center justify-center text-gray-600 text-2xl">‚úï</button>
        </div>
        
        <!-- Toast th√¥ng b√°o nh·∫π (gi·ªØ nh∆∞ng ·∫©n s√¢u h∆°n) -->
        <div id="split-toast" class="hidden mx-5 mt-4 px-6 py-4 bg-green-50/90 backdrop-blur border border-green-200 rounded-3xl text-center">
            <p class="text-green-700 font-black text-lg">ƒê√£ ƒë√°nh d·∫•u thu ti·ªÅn ph·∫ßn n√†y!</p>
        </div>
        
        <!-- Danh s√°ch m√≥n: full height, scroll m∆∞·ª£t, row gi·ªëng gi·ªè h√†ng -->
        <div class="flex-1 overflow-y-auto px-5 pt-4 pb-2 space-y-4" id="split-list">
            <!-- Render b·∫±ng JS -->
        </div>
        
        <!-- Footer gi·ªëng gi·ªè h√†ng: t·ªïng to xanh, n√∫t l·ªõn full width -->
        <div class="p-5 border-t border-gray-100/50 bg-gray-50/90 backdrop-blur">
            <div class="flex justify-between items-center mb-5">
                <span class="text-lg text-gray-600 font-bold">T·ªïng ƒëang ch·ªçn:</span>
                <span id="split-total" class="text-3xl font-black text-[#006241]">0ƒë</span>
            </div>
            
            <button id="pay-selected-btn" onclick="markAsPaidSelected()" disabled 
                    class="w-full py-5 bg-[#006241] text-white font-black text-xl rounded-3xl uppercase shadow-lg active:scale-95 disabled:opacity-50 disabled:active:scale-100 transition-all">
                ƒê√£ thu c√°c m√≥n n√†y
            </button>
            
            <button id="complete-all-btn" onclick="completeWholePayment()" class="hidden w-full py-5 mt-4 bg-amber-500 text-white font-black text-xl rounded-3xl uppercase shadow-lg active:scale-95 transition-all">
                Ho√†n t·∫•t thanh to√°n to√†n b·ªô
            </button>
        </div>
    </div>
</div>
    <div id="modal-date-range" class="fixed inset-0 z-[100000] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fade-in">
    <div class="bg-white w-[90%] max-w-[340px] rounded-[30px] p-6 shadow-2xl relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-2 bg-[#006241]"></div>
        
        <h3 class="text-xl font-black text-[#1e3932] uppercase text-center mb-6 tracking-tight">Ch·ªçn Kho·∫£ng Th·ªùi Gian</h3>
        
        <div class="space-y-4">
            <div>
                <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1.5 ml-1">T·ª´ ng√†y</label>
                <div class="bg-gray-50 rounded-2xl p-3 border border-gray-100 flex items-center">
                    <span class="material-symbols-outlined text-gray-400 mr-2">date_range</span>
                    <input type="date" id="filter-start-date" class="bg-transparent w-full text-sm font-bold text-[#1e3932] outline-none">
                </div>
            </div>
            
            <div>
                <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1.5 ml-1">ƒê·∫øn ng√†y</label>
                <div class="bg-gray-50 rounded-2xl p-3 border border-gray-100 flex items-center">
                    <span class="material-symbols-outlined text-gray-400 mr-2">event</span>
                    <input type="date" id="filter-end-date" class="bg-transparent w-full text-sm font-bold text-[#1e3932] outline-none">
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-8">
            <button onclick="document.getElementById('modal-date-range').classList.add('hidden')" class="py-3.5 rounded-xl bg-gray-100 text-gray-500 font-bold text-xs uppercase hover:bg-gray-200 transition-all">
                ƒê√≥ng
            </button>
            <button onclick="submitDateFilter()" class="py-3.5 rounded-xl bg-[#006241] text-white font-bold text-xs uppercase shadow-lg shadow-green-900/20 active:scale-95 transition-all">
                √Åp d·ª•ng
            </button>
        </div>
    </div>
</div>
    <div id="modal-item-select" class="fixed inset-0 z-[100001] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fade-in">
    <div class="bg-white w-[90%] max-w-[360px] rounded-[30px] flex flex-col max-h-[85vh] shadow-2xl relative overflow-hidden">
        
        <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-white z-10">
            <div>
                <h3 class="text-lg font-black text-[#1e3932] uppercase">Ch·ªçn m√≥n theo d√µi</h3>
                <p class="text-[10px] text-gray-400 font-bold" id="item-select-count">ƒê√£ ch·ªçn: 0/10</p>
            </div>
            <button onclick="document.getElementById('modal-item-select').classList.add('hidden')" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 font-bold">‚úï</button>
        </div>

        <div class="p-4 bg-gray-50 border-b border-gray-100">
            <input type="text" oninput="filterItemSelectionList(this.value)" placeholder="T√¨m t√™n m√≥n..." class="w-full bg-white px-4 py-3 rounded-xl text-sm font-bold border border-gray-200 focus:border-[#006241] outline-none">
        </div>

        <div id="item-select-list" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar bg-white">
            </div>

        <div class="p-4 border-t border-gray-100 bg-white z-10">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="resetItemSelection()" class="py-3 rounded-xl bg-gray-100 text-gray-600 font-bold text-xs uppercase">M·∫∑c ƒë·ªãnh (Top 10)</button>
                <button onclick="applyItemSelection()" class="py-3 rounded-xl bg-[#006241] text-white font-bold text-xs uppercase shadow-lg shadow-green-900/20 active:scale-95 transition-all">Xem k·∫øt qu·∫£</button>
            </div>
        </div>
    </div>
</div>
    <div id="modal-cancel-list" class="fixed inset-0 z-[100002] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fade-in">
    <div class="bg-white w-[90%] max-w-[360px] rounded-[30px] flex flex-col max-h-[80vh] shadow-2xl relative overflow-hidden">
        
        <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-red-50">
            <div>
                <h3 class="text-lg font-black text-red-600 uppercase">L·ªãch s·ª≠ h·ªßy Bed</h3>
                <p class="text-[10px] text-red-400 font-bold">Danh s√°ch chi ti·∫øt</p>
            </div>
            <button onclick="document.getElementById('modal-cancel-list').classList.add('hidden')" class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-red-500 font-bold shadow-sm">‚úï</button>
        </div>

        <div id="cancel-list-content" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar bg-white">
            </div>
    </div>
</div>
    <div id="view-history-mobile" class="hidden fixed inset-0 z-[9999] flex flex-col bg-white animate-fade-in">
    
    <div class="px-5 pt-12 pb-4 bg-white shadow-sm border-b border-gray-100 shrink-0 sticky top-0 z-20">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-black text-[#1e3932] tracking-tighter uppercase">L·ªãch s·ª≠ ƒë∆°n</h1>
            
            <button onclick="switchView('menu')" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 active:scale-90 transition-transform shadow-sm">
                <span class="material-symbols-outlined text-xl font-bold">close</span>
            </button>
        </div>

        <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 material-symbols-outlined text-[20px]">search</span>
            <input type="text" id="mob-history-search" oninput="filterHistoryMobile(this.value)" placeholder="T√¨m theo s·ªë ti·ªÅn, SƒêT..." 
                   class="w-full bg-gray-50 pl-10 pr-4 py-3 rounded-xl text-sm font-bold text-gray-700 outline-none focus:bg-white focus:ring-2 focus:ring-[#006241]/20 transition-all border border-transparent focus:border-[#006241]/20">
        </div>
    </div>

    <div id="mob-history-list" class="flex-1 overflow-y-auto p-5 space-y-6 custom-scrollbar pb-32">
        <div class="text-center text-gray-400 mt-10 text-xs">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    </div>
</div>
<div id="sheet-history-detail" class="fixed inset-0 z-[100002] hidden flex items-end justify-center">
    <div onclick="closeHistoryDetailMobile()" class="absolute inset-0 bg-black/40 backdrop-blur-[4px] transition-opacity duration-300" id="sheet-backdrop"></div>
    
    <div id="sheet-content-main" class="mt-auto h-[94vh] w-full bg-white rounded-t-[32px] shadow-2xl flex flex-col relative z-10 overflow-hidden transform translate-y-full transition-transform duration-300 touch-none">
        
        <div class="px-5 pt-4 pb-2 flex items-center justify-between shrink-0 z-20 bg-white">
            <button onclick="closeHistoryDetailMobile()" class="flex items-center text-[#006B44] font-bold active:opacity-60 transition-opacity p-2 -ml-2">
                <span class="material-symbols-outlined text-[26px]">chevron_left</span>
                <span class="text-[16px] leading-none pb-0.5">Quay l·∫°i</span>
            </button>
            <div class="absolute left-1/2 -translate-x-1/2 top-3 w-10 h-1 bg-gray-200 rounded-full opacity-60"></div>
            
            <button onclick="closeHistoryDetailMobile()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center active:bg-gray-200 transition-colors">
                <span class="material-symbols-outlined text-gray-500 text-[20px]">close</span>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar px-6 pt-0 pb-6 flex flex-col bg-white" id="sheet-scroll-body">
            
            <div class="mb-4 shrink-0 mt-2">
                <h1 class="text-[30px] font-black text-[#006B44] tracking-tight leading-tight">The cafe 33</h1>
                <div class="flex items-center gap-2 mt-1">
                    <span class="relative flex h-2 w-2">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                    <p class="text-[12px] font-bold text-gray-400 uppercase tracking-widest">H√≥a ƒë∆°n ƒëi·ªán t·ª≠</p>
                </div>
            </div>

            <div id="detail-mob-items-list" class="flex-1 flex flex-col justify-start">
                </div>

            <div class="h-6"></div> 

            <div class="mt-2 bg-[#F9FAFB] rounded-2xl p-4 shrink-0 border border-gray-100">
                <div class="flex items-center justify-between text-xs divide-x divide-gray-200">
                    <div class="px-2 flex-1 flex flex-col gap-1 first:pl-0">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Th·ªùi gian</span>
                        <span id="detail-mob-time" class="font-bold text-gray-800 truncate">--:--</span>
                    </div>
                    <div class="px-4 flex-1 flex flex-col gap-1 items-center">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Kh√°ch</span>
                        <span id="detail-mob-cust" class="font-bold text-gray-800 truncate max-w-[90px]">--</span>
                    </div>
                    <div class="px-2 flex-1 flex flex-col gap-1 items-end last:pr-0">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Thanh to√°n</span>
                        <span id="detail-mob-method" class="font-black text-[#006B44] truncate uppercase">--</span>
                    </div>
                </div>
            </div>

        </div>

        <div class="shrink-0 bg-white/95 backdrop-blur-md border-t border-gray-100 px-6 pt-4 pb-10 z-20">
            <div class="flex items-end justify-between">
                <button id="btn-cancel-order-mobile" class="w-14 h-14 rounded-full bg-[#FF3B30] text-white flex items-center justify-center shadow-lg shadow-red-500/30 active:scale-95 transition-transform group">
                    <span class="material-symbols-outlined text-[26px] group-active:rotate-12 transition-transform">delete</span>
                </button>

                <div class="text-right flex flex-col items-end">
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-0.5">T·ªïng Bill</span>
                    <div class="flex items-baseline gap-1 text-[#006B44]">
                        <span id="detail-mob-total" class="text-[42px] font-black tracking-tighter leading-none">0</span>
                        <span class="text-xl font-bold">ƒë</span>
                    </div>
                    <span id="detail-item-count" class="text-[11px] font-bold text-gray-400 mt-1">S·ªë l∆∞·ª£ng: 0 m√≥n</span>
                </div>
            </div>
        </div>

    </div>
</div>
    <div id="modal-smart-checkout" class="hidden fixed inset-0 z-[100000] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 transition-all duration-300 opacity-0 scale-95" style="transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);">
    
    <div class="bg-white w-full max-w-[420px] rounded-[2.5rem] shadow-2xl overflow-hidden relative border border-white/50">
        
        <div class="bg-gradient-to-br from-[#065F46] to-[#044e39] p-8 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full opacity-20 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
            <div class="relative z-10">
                <p class="text-[10px] font-black text-emerald-200 uppercase tracking-[0.3em] mb-2">X√ÅC NH·∫¨N TR·∫¢ BED</p>
                <h2 id="sco-bed-name" class="text-4xl font-black text-white tracking-tighter mb-1">BED 01</h2>
                <p id="sco-customer" class="text-emerald-100 font-bold text-sm">Kh√°ch h√†ng: Nguy·ªÖn VƒÉn A</p>
            </div>
        </div>

        <div class="p-6 bg-[#F2F4F7]">
            
            <div class="bg-white rounded-[1.5rem] p-5 shadow-sm border border-slate-100 mb-6 flex items-center justify-between">
                <div>
                    <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-1">TH·ªúI GIAN L·ªê</p>
                    <p id="sco-overtime" class="text-2xl font-black text-red-500">0 ph√∫t</p>
                </div>
                <div class="text-right">
                    <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-1">D·ª∞ KI·∫æN PH·∫†T</p>
                    <p id="sco-fee" class="text-xl font-black text-slate-800">0 gi·ªù</p>
                </div>
            </div>

            <div class="space-y-3">
                <button onclick="confirmCheckoutAuto()" class="w-full py-4 bg-[#065F46] text-white rounded-2xl font-black text-sm uppercase shadow-lg shadow-emerald-900/20 active:scale-95 transition-all flex items-center justify-center gap-3 group hover:bg-[#044e39]">
                    <span class="material-symbols-outlined group-hover:animate-bounce">auto_fix_high</span>
                    T√≠nh ph√≠ t·ª± ƒë·ªông
                </button>

                <button onclick="confirmCheckoutManual()" class="w-full py-4 bg-white text-amber-600 border border-amber-100 rounded-2xl font-black text-sm uppercase shadow-sm active:scale-95 transition-all flex items-center justify-center gap-3 hover:bg-amber-50">
                    <span class="material-symbols-outlined">touch_app</span>
                    T·ª± ch·ªçn ph√≠
                </button>

                <button onclick="confirmCheckoutFree()" class="w-full py-4 bg-gray-100 text-gray-500 rounded-2xl font-bold text-xs uppercase hover:bg-gray-200 active:scale-95 transition-all flex items-center justify-center gap-2">
                    Kh√¥ng t√≠nh th√™m (X√≠ x√≥a)
                </button>
            </div>

            <button onclick="closeSmartCheckout()" class="w-full mt-4 text-center text-xs font-bold text-gray-400 hover:text-gray-600 py-2">
                Quay l·∫°i
            </button>
        </div>
    </div>
</div>
</body>
</html>


































