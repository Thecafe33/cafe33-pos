<!DOCTYPE html>
<html>
<head>
<title>POS The cafe 33</title>
<meta name="apple-mobile-web-app-title" content="POS The cafe 33">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#ffffff">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth-compat.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=League+Spartan:wght@700;800&display=swap" rel="stylesheet">
<style>
/* --- C·∫§U H√åNH CHUNG --- */
html, body {
    width: 100%; height: 100%; overflow: hidden;
    font-size: 13px; /* Chu·∫©n PC */
    -webkit-text-size-adjust: 100%; text-size-adjust: 100%;
    overscroll-behavior-y: none; touch-action: pan-x pan-y;
    margin: 0; padding: 0; -webkit-tap-highlight-color: transparent;
}
body { font-family: 'Inter', sans-serif; background: #f3f4f6; transition: background-color 0.5s ease; }
input, button, select, textarea { font-size: 1rem; }

/* --- UTILITIES & COMPONENTS --- */
.brand-font { font-family: 'League Spartan', sans-serif; }
.sb-green { background-color: #006241; }
.tab-active { background-color: #006241 !important; color: white !important; font-weight: 900; }
.category-tab { padding: 6px 16px; font-size: 0.85rem; font-weight: 800; border-radius: 12px; border: 2px solid #f3f4f6; white-space: nowrap; }
#loading-overlay { display: flex; position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999; align-items: center; justify-content: center; flex-direction: column; gap: 1rem; }
.capitalize-first { text-transform: lowercase; display: inline-block; } .capitalize-first::first-letter { text-transform: uppercase; }
.history-item-active { border-color: #006241 !important; background-color: #f0fdf4 !important; }
.menu-item-name { text-transform: uppercase; font-size: 1rem; font-weight: 900; line-height: 1.1; }
.receipt-line { border-bottom: 1px dashed #f1f3f5; padding: 10px 0; display: flex; justify-content: space-between; align-items: flex-start; }
.refund-selected { background-color: #fee2e2 !important; border-left: 5px solid #ef4444 !important; }
.modal-active { display: flex !important; }

/* Scrollbar */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #D1D1D6; border-radius: 10px; }

/* Bed Box */
.bed-box { aspect-ratio: 1; border-radius: 1.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 900; text-transform: uppercase; cursor: pointer; transition: all 0.3s; position: relative; }
.bed-free { background-color: #f0fdf4; border: 4px solid #f0fdf4; color: #006241; }
.bed-busy { background-color: #1a1a1a; border: 4px solid #006241; color: white; }
.bed-selected { border-color: #ef4444; transform: scale(0.95); }

/* === LUXURY THEME === */
.luxury-theme .sb-green, .luxury-theme .bg-\[\#006241\] { background-color: #000000 !important; }
.luxury-theme .tab-active { background-color: #000000 !important; color: #D4AF37 !important; border: 1px solid #D4AF37 !important; }
.luxury-theme .text-\[\#006241\], .luxury-theme h2.text-\[\#006241\], .luxury-theme .font-black.text-\[\#006241\] { color: #D4AF37 !important; }
.luxury-theme #sidebar-pay-btn, .luxury-theme #btn-done { background-color: #000000 !important; color: #D4AF37 !important; border: 1px solid #D4AF37 !important; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); }
.luxury-theme #sidebar-cart { border-left-color: #000000 !important; }
.luxury-theme #cash-paid { color: #D4AF37 !important; }
.luxury-theme #menu-grid > div { background-color: #1a1a1a !important; border: 1px solid #D4AF37 !important; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important; }
.luxury-theme #menu-grid > div p { color: #D4AF37 !important; }
.luxury-theme #size-modal .bg-gray-50 { background-color: #1a1a1a !important; border: 1px solid #D4AF37 !important; }
.luxury-theme #size-modal h3, .luxury-theme #size-modal span { color: #D4AF37 !important; }

/* Animation */
.sheet-open { transform: translateY(0) !important; }
@keyframes slideUpFade { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.animate-slide-up { animation: slideUpFade 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

/* ============================================================ */
/* --- MASTER MOBILE CSS (B·∫¢N G·ªòP CHU·∫®N APPLE - FINAL) --- */
/* ============================================================ */
@media only screen and (max-width: 768px) {
/* === TH√äM ƒêO·∫†N N√ÄY ƒê·ªÇ ·∫®N TUY·ªÜT ƒê·ªêI SIDEBAR C≈® === */
    #sidebar-cart {
        display: none !important;
        opacity: 0 !important;
        pointer-events: none !important;
        visibility: hidden !important;
        z-index: -1 !important;
    }
    /* 1. C·∫§U TR√öC CHUNG (X·∫øp d·ªçc, Full m√†n h√¨nh) */
    body {
        font-size: 16px !important;
        flex-direction: column !important;
        padding: 0 !important;
        gap: 0 !important;
    }
    #main-container {
        width: 100% !important;
        flex: 1 !important;
        border-radius: 0 !important;
        border: none !important;
        box-shadow: none !important;
        display: flex;
        flex-direction: column;
    }

    /* 2. HEADER BAR (K√≠nh m·ªù, Trong su·ªët) */
    #header-bar {
        position: sticky !important;
        top: 0 !important;
        background: rgba(255, 255, 255, 0.85) !important;
        backdrop-filter: blur(20px) !important;
        -webkit-backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(0,0,0,0.05) !important;
        z-index: 50 !important;
        padding: 12px 20px !important;
    }
    #header-bar h2 {
        font-size: 1.4rem !important;
        font-weight: 900 !important;
        letter-spacing: -0.5px;
    }
    #header-bar button.md\:hidden {
        background: #F2F4F6 !important;
        border-radius: 12px !important;
        color: #333 !important;
        width: 44px !important;
        height: 44px !important;
    }
    #clock { display: none !important; } /* ·∫®n ƒë·ªìng h·ªì */

    /* 3. MENU GRID & CONTAINER (Tr√†n ƒë√°y ƒë·ªÉ kh√¥ng b·ªã Bottom Bar che) */
    /* --- S·ª¨A L·∫†I ƒê·ªÇ MENU TR√ÄN FULL M√ÄN H√åNH --- */
    
    /* --- ƒêO·∫†N CSS S·ª¨A L·ªñI (ƒê√É FIX: KH√îNG B·ªä ƒê√à GIAO DI·ªÜN) --- */
    
    /* 1. Khung bao ngo√†i: CH·ªà √ÅP D·ª§NG KHI KH√îNG B·ªä ·∫®N */
    #view-menu:not(.hidden), 
    #view-bed:not(.hidden) {
        padding: 10px !important;
        padding-top: 10px !important;
        padding-bottom: 0 !important;
        
        height: 100% !important;
        overflow: hidden !important;
        display: flex !important; /* Ch·ªâ hi·ªán flex khi kh√¥ng c√≥ class hidden */
        flex-direction: column !important;
    }

    /* 2. N·ªôi dung b√™n trong: ƒê·∫©y ƒë·ªám l√™n ƒë·ªÉ n√© Bottom Bar */
    #view-menu-content, #col-left-list {
        padding-bottom: 120px !important; 
        overflow-y: auto !important;
        height: 100% !important;
    }

    /* 3. ƒê·∫£m b·∫£o class hidden c·ªßa Tailwind c√≥ quy·ªÅn l·ª±c t·ªëi cao */
    .hidden {
        display: none !important;
    }

    html, body {
        background-color: #f3f4f6 !important;
        height: 100% !important;
    }
    /* L∆∞·ªõi m√≥n ƒÉn */
    #menu-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
        /* Kh√¥ng set padding-bottom ·ªü ƒë√¢y n·ªØa, ƒë·ªÉ container cha lo */
    }
    #menu-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
    }
    #menu-grid > div {
        height: auto !important;
        min-height: 120px;
        padding: 15px !important;
    }

    /* 4. THANH CART "DYNAMIC ISLAND" (Vi√™n thu·ªëc n·ªïi) */
    
    /* Tr·∫°ng th√°i ·∫®N: B·∫Øt bu·ªôc ·∫©n tuy·ªát ƒë·ªëi */
    #sidebar-cart.hidden {
        display: none !important;
        opacity: 0 !important;
        pointer-events: none !important;
        visibility: hidden !important;
    }

    /* Tr·∫°ng th√°i HI·ªÜN: N·ªïi kh·ªëi, K√≠nh m·ªù, Bo tr√≤n 999px */
    #sidebar-cart:not(.hidden) {
        display: flex !important;
        flex-direction: row !important;
        position: fixed !important;
        
        /* V·ªã tr√≠ "treo" l∆° l·ª≠ng s√°t ƒë√°y */
        bottom: calc(env(safe-area-inset-bottom) + 15px) !important;
        left: 14px !important;
        right: 14px !important;
        width: auto !important;
        height: auto !important;
        max-height: 72px !important;
        
        /* Hi·ªáu ·ª©ng k√≠nh m·ªù xuy√™n th·∫•u */
        background: rgba(255, 255, 255, 0.85) !important;
        backdrop-filter: blur(25px) !important;
        -webkit-backdrop-filter: blur(25px);
        
        /* H√¨nh d√°ng vi√™n thu·ªëc */
        border-radius: 999px !important;
        overflow: hidden !important; /* C·∫Øt b·ªè blur th·ª´a */
        border: none !important;
        
        /* ƒê·ªï b√≥ng cao c·∫•p */
        box-shadow: 
            0 15px 35px -8px rgba(0,0,0,0.15),
            0 0 0 1px rgba(0,0,0,0.05),
            inset 0 1px 0 rgba(255,255,255,0.6) !important;
        
        padding: 8px 20px !important;
        z-index: 9999 !important;
        align-items: center !important;
        justify-content: space-between !important;
    }

    /* Tinh ch·ªânh n·ªôi dung b√™n trong thanh Cart */
    #sidebar-cart #cart-bottom-bar {
        background: transparent !important;
        padding: 0 !important;
        margin: 0 !important;
        width: 100% !important;
        border: none !important;
        box-shadow: none !important;
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        justify-content: space-between !important;
        gap: 15px !important;
    }
    #sidebar-cart #cart-bottom-bar > div:first-child {
        display: flex !important;
        flex-direction: column !important;
        align-items: flex-start !important;
        cursor: pointer !important;
    }
    #total-price {
        font-size: 1.4rem !important;
        font-weight: 900 !important;
        color: #1e3932 !important;
    }
    #total-price::after {
        content: "Xem chi ti·∫øt ^";
        display: block;
        font-size: 10px !important;
        font-weight: 600 !important;
        color: #6B7280;
        margin-top: 2px;
    }
    
    /* ·∫®n c√°c ph·∫ßn th·ª´a c·ªßa sidebar g·ªëc */
    #sidebar-cart:not(.expanded) #cart-list,
    #sidebar-cart:not(.expanded) #cart-top-section,
    #sidebar-cart:not(.expanded) h2,
    #sidebar-cart:not(.expanded) .md\:hidden,
    #sidebar-cart:not(.expanded) #btn-clear-all,
    #cart-bottom-bar span.text-gray-400,
    #cart-bottom-bar .animate-bounce {
        display: none !important;
    }

    /* N√∫t Thanh To√°n tr√™n thanh Bar */
    #sidebar-pay-btn {
        width: auto !important;
        padding: 10px 24px !important;
        margin: 0 !important;
        border-radius: 99px !important; /* Bo tr√≤n theo thanh bar */
        background: #006241 !important;
        box-shadow: 0 4px 15px rgba(0, 98, 65, 0.3) !important;
        font-size: 0.85rem !important;
        letter-spacing: 0.5px !important;
    }

    /* 5. MENU DANH M·ª§C "DARK GLASS" (K√≠nh ƒëen m·ªù) */
    #sheet-category-content {
        background: rgba(20, 20, 20, 0.90) !important;
        backdrop-filter: blur(30px) !important;
        -webkit-backdrop-filter: blur(30px);
        border: 1px solid rgba(255, 255, 255, 0.15) !important;
        border-radius: 32px !important;
        bottom: 20px !important;
        left: 16px !important;
        right: 16px !important;
        box-shadow: 0 40px 80px -10px rgba(0,0,0,0.6) !important;
        color: white !important;
    }
    #sheet-category-content h3 {
        color: white !important;
        text-align: center !important;
        letter-spacing: 1px !important;
    }
    #sheet-category-content div.w-12 {
        background-color: rgba(255,255,255,0.2) !important;
    }

    /* 6. GIAO DI·ªÜN THANH TO√ÅN (FUTURE 2026) */
    #view-payment { background-color: #F2F2F7 !important; }
    .neo-card {
        background: #FFFFFF;
        border-radius: 32px;
        box-shadow: 0 10px 40px -10px rgba(0,0,0,0.08), 0 0 2px rgba(0,0,0,0.05);
        border: 1px solid rgba(255,255,255,0.6);
    }
    .neo-btn-primary {
        background: linear-gradient(145deg, #00704a, #005538);
        color: white;
        border-radius: 999px;
        box-shadow: 0 8px 20px -6px rgba(0, 98, 65, 0.4), inset 0 2px 0 rgba(255,255,255,0.2);
        border: none;
    }
    .neo-btn-secondary {
        background: #FFFFFF;
        color: #333;
        border-radius: 28px;
        box-shadow: 0 6px 15px -4px rgba(0,0,0,0.05), inset 0 0 0 1px rgba(0,0,0,0.02);
    }
    .neo-input-box {
        background: #F2F4F6;
        border-radius: 24px;
        border: 1px solid transparent;
        transition: all 0.3s;
    }
    .neo-input-box:focus-within {
        background: #FFFFFF;
        box-shadow: 0 4px 20px rgba(0, 98, 65, 0.15);
        border-color: #006241;
    }
    
    /* ·∫®n c√°c popup th·ª´a v√† tinh ch·ªânh Z-Index */
    .app-modal { z-index: 10001 !important; }
    #sheet-cart-edit { z-index: 20000 !important; }
    #sheet-cart-edit button { pointer-events: auto !important; }
    #sheet-cart-list p { font-size: 1rem !important; }
    
    
        /* ·∫®n ho√†n to√†n thanh category tabs desktop tr√™n mobile */
    /* Selector ph·ªï bi·∫øn cho Tailwind desktop tabs */
    .hidden.md\:flex,
    .md\:flex,
    .md\:block,
    .md\:grid,
    .category-tabs-container,  /* n·∫øu c√≥ class n√†y */
    #category-bar,             /* n·∫øu c√≥ id n√†y */
    .flex.gap-2.items-center.justify-start.overflow-x-auto {  /* selector g·∫ßn ƒë√∫ng t·ª´ ·∫£nh */
        display: none !important;
    }

    /* ·∫®n c·ª• th·ªÉ c√°c tab n·∫øu d√πng class category-tab cho desktop */
    .category-tab:not(.mobile-category) {
        display: none !important;
    }
    /* ·∫®n tuy·ªát ƒë·ªëi Sidebar c≈© tr√™n Mobile */
    #sidebar-cart {
        display: none !important;
    }
    
    /* ƒê·∫£m b·∫£o Bottom Bar m·ªõi lu√¥n n·ªïi l√™n tr√™n */
    #mobile-bottom-bar {
        z-index: 9999 !important;
    }
    
    /* T·∫°o kho·∫£ng tr·ªëng d∆∞·ªõi c√πng danh s√°ch m√≥n ƒÉn ƒë·ªÉ kh√¥ng b·ªã Bar che m·∫•t */
    #menu-grid {
        padding-bottom: 100px !important;
    }
}
</style>
</head>
<body class="flex p-3 gap-3 text-left">
   <div id="mobile-sidebar" class="fixed inset-y-0 left-0 w-[280px] bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 z-[9999] flex flex-col">
    <div class="p-6 bg-[#006241] flex justify-between items-center">
        <h2 class="brand-font text-2xl text-white uppercase">Menu</h2>
        <button onclick="toggleMobileMenu()" class="text-white text-xl font-bold">‚úï</button>
    </div>
    <div class="flex-1 p-4 space-y-3 overflow-y-auto">
        <button onclick="openRevenue(); toggleMobileMenu()" class="w-full p-4 bg-amber-50 text-amber-700 font-bold rounded-xl text-left flex items-center gap-3">
            <span>üí∞</span> Doanh thu
        </button>
        <button onclick="openHistory(); toggleMobileMenu()" class="w-full p-4 bg-blue-50 text-blue-700 font-bold rounded-xl text-left flex items-center gap-3">
            <span>üìÖ</span> L·ªãch s·ª≠ ƒë∆°n
        </button>
        <button onclick="openBedManager(); toggleMobileMenu()" class="w-full p-4 bg-green-50 text-[#006241] font-bold rounded-xl text-left flex items-center gap-3">
            <span>üõèÔ∏è</span> Qu·∫£n l√Ω Bed
        </button>
        <hr class="border-gray-100 my-2">
        <p class="text-xs text-gray-300 text-center mt-auto">The Cafe 33 POS Mobile</p>
    </div>
</div>
<div id="mobile-overlay" onclick="toggleMobileMenu()" class="fixed inset-0 bg-black/60 z-[9990] hidden backdrop-blur-[2px] transition-opacity"></div>

<div id="loading-overlay">
    <div class="w-16 h-16 border-4 border-[#006241] border-t-transparent rounded-full animate-spin"></div>
    <p class="brand-font text-[#006241] text-2xl font-black tracking-widest animate-pulse">The cafe 33</p>
    <p class="text-xs text-gray-400 font-bold" id="loading-text">ƒêang k·∫øt n·ªëi d·ªØ li·ªáu...</p>
</div>

<div class="flex-1 bg-white rounded-[2.5rem] shadow-xl overflow-hidden flex flex-col relative border-2 border-white transition-colors duration-500" id="main-container">
  <div class="md:hidden px-5 py-4 flex items-center justify-between sticky top-0 z-50 transition-all duration-300" 
     style="background: #F2F2F7; border-bottom: 1px solid rgba(0,0,0,0.05);"> <button onclick="toggleMobileMenu()" class="w-12 h-12 rounded-full bg-white shadow-sm border border-white flex items-center justify-center text-[#006241] active:scale-90 transition-transform">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="6" x2="20" y2="6"></line><line x1="4" y1="12" x2="20" y2="12"></line><line x1="4" y1="18" x2="12" y2="18"></line></svg>
    </button>

    <h2 class="brand-font text-3xl font-black text-[#006241] tracking-tighter cursor-pointer" onclick="switchView('menu')">The cafe 33</h2>

    <button onclick="openBedManager()" class="h-12 pl-4 pr-5 bg-[#006241] rounded-full shadow-[0_8px_20px_-5px_rgba(0,98,65,0.4)] flex items-center gap-2 active:scale-95 transition-all border border-white/10">
        <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9.5V20M3 20H21M3 20V21M21 20V9.5M21 20V21M3 9.5C3 8.39543 3.89543 7.5 5 7.5H9C10.1046 7.5 11 8.39543 11 9.5V11H3V9.5ZM21 9.5C21 8.39543 20.1046 7.5 19 7.5H15C13.8954 7.5 13 8.39543 13 9.5V11H21V9.5Z"/>
            <path d="M3 11H21V16H3V11Z"/>
        </svg>
        <span class="text-white font-black text-xs uppercase tracking-wider">BED</span>
    </button>
</div>

<div class="hidden md:flex px-6 py-4 border-b border-gray-50 justify-between items-center bg-white z-10 shrink-0 shadow-sm" id="header-bar-pc">
    <div class="flex items-center gap-6 w-full">
        <h2 class="brand-font text-4xl text-[#006241] whitespace-nowrap cursor-pointer hover:opacity-80 transition-all" onclick="switchView('menu')">The cafe 33</h2>
        
        <div class="flex gap-3 ml-auto">
            <button onclick="openRevenue()" class="bg-amber-100 text-amber-700 hover:bg-amber-200 px-6 py-3 rounded-2xl text-xs font-black uppercase active:scale-95 transition-all flex items-center gap-2">
                <span>üí∞</span> Doanh thu
            </button>
            <button onclick="openHistory()" class="bg-blue-50 text-blue-600 hover:bg-blue-100 px-6 py-3 rounded-2xl text-xs font-black uppercase active:scale-95 transition-all flex items-center gap-2">
                <span>üìÖ</span> L·ªãch s·ª≠
            </button>
            <button onclick="openBedManager()" class="bg-[#006241] text-white hover:bg-green-800 px-6 py-3 rounded-2xl text-xs font-black uppercase shadow-lg shadow-green-900/20 active:scale-95 transition-all flex items-center gap-2">
                <span>üõèÔ∏è</span> Qu·∫£n l√Ω Bed
            </button>
        </div>
    </div>
</div>
   <div id="view-menu" class="flex-1 flex flex-col overflow-hidden relative bg-[#F2F2F7]">

    <div id="category-bar" class="hidden md:flex px-6 py-2 border-b border-gray-50 bg-gray-50/30 gap-2 overflow-x-auto shrink-0">
        <div id="tabs-container" class="flex gap-2"></div>
    </div>

    <div class="md:hidden absolute top-4 right-4 z-50 flex flex-col items-end">
        
        <button onclick="toggleCategoryDropdown()" class="relative z-50 flex items-center gap-3 bg-[#006241] text-white pl-5 pr-4 py-3 rounded-full shadow-md active:scale-95 transition-all border border-white/20">
            <span class="text-[10px] font-black uppercase tracking-widest opacity-90">MENU</span>
            <div class="h-4 w-[1px] bg-white/30"></div>
            <span id="mob-cat-label-new" class="text-sm font-black text-white uppercase pl-1">T·∫•t c·∫£</span>
            <span class="text-xs text-white/80">‚ñº</span>
        </button>

        <div id="mob-cat-overlay" onclick="toggleCategoryDropdown()" class="hidden fixed inset-0 z-40 bg-black/20 backdrop-blur-[1px]"></div>

        <div id="mob-cat-dropdown" class="hidden absolute top-full right-0 mt-3 w-64 bg-white rounded-[2rem] shadow-xl p-3 z-50 origin-top-right transition-all duration-200 opacity-0 scale-95 border border-gray-100">
            <div id="mob-cat-list" class="max-h-[60vh] overflow-y-auto custom-scrollbar space-y-2">
                </div>
        </div>
    </div>

    <div id="view-menu-content" class="flex-1 px-3 pb-32 overflow-y-auto custom-scrollbar">
        <div class="h-16 md:hidden w-full"></div>
        <div id="menu-grid" class="grid grid-cols-2 md:grid-cols-3 gap-3 pb-20"></div>
    </div>

    <div id="sheet-category" class="md:hidden fixed inset-0 z-[100] hidden">
        <div onclick="closeCategorySheet()" class="absolute inset-0 bg-black/40 backdrop-blur-[2px] transition-opacity opacity-0 animate-fade-in"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[32px] p-6 pb-10 shadow-[0_-10px_40px_rgba(0,0,0,0.2)] transform translate-y-full transition-transform duration-300 ease-out flex flex-col max-h-[70vh]" id="sheet-category-content">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6 shrink-0"></div>
            <h3 class="text-lg font-black text-gray-800 uppercase mb-4 shrink-0">Ch·ªçn Danh M·ª•c</h3>
            <div id="sheet-category-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-2"></div>
        </div>
    </div>

    <div id="sheet-cart-edit" class="md:hidden fixed inset-0 z-[100] hidden">
        <div onclick="closeCartModal()" class="absolute inset-0 bg-black/40 backdrop-blur-[2px]"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[32px] flex flex-col max-h-[80vh] shadow-2xl animate-slide-up">
            <div class="p-5 border-b border-gray-50 flex justify-between items-center">
                <h3 class="text-lg font-black text-[#006241] uppercase">Gi·ªè h√†ng</h3>
                <button onclick="closeCartModal()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 font-bold">‚úï</button>
            </div>
            <div id="sheet-cart-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-[#F9FAFB]"></div>
            <div class="p-4 border-t border-gray-100 bg-white pb-8">
                <button onclick="closeCartModal()" class="w-full py-3.5 bg-[#006241] text-white rounded-xl font-bold uppercase">ƒê√≥ng & Ti·∫øp t·ª•c</button>
            </div>
        </div>
    </div>

</div>
       <div id="view-payment" class="hidden h-full flex-col animate-fade-in relative bg-[#f2f2f7]"> <div class="hidden md:flex flex-col h-full p-8 bg-white">
         <div class="flex justify-between items-center mb-6"><h2 class="brand-font text-4xl text-[#006241] uppercase font-black text-center w-full">Thanh to√°n</h2><button onclick="switchView('menu')" class="text-gray-400 font-bold uppercase text-xs border-b-2 absolute right-10">Quay l·∫°i</button></div>
         <div class="grid grid-cols-2 gap-6 flex-1"><div class="space-y-4"><button id="btn-cash" onclick="setMethod('Ti·ªÅn m·∫∑t')" class="w-full p-6 rounded-3xl border-4 border-[#006241] bg-white text-xl font-bold text-[#006241] flex justify-between items-center shadow-md">Ti·ªÅn m·∫∑t ‚úì</button><button id="btn-bank" onclick="setMethod('Chuy·ªÉn kho·∫£n')" class="w-full p-6 rounded-3xl border-4 border-transparent bg-white text-xl font-bold text-gray-300 flex justify-between items-center shadow-md uppercase tracking-tighter">Chuy·ªÉn kho·∫£n</button></div><div id="cash-detail-box" class="bg-white p-6 rounded-[2.5rem] shadow-md flex flex-col justify-center text-center"><label class="block font-bold text-gray-300 uppercase text-[9px] mb-3 tracking-widest text-center">Kh√°ch ƒë∆∞a</label><div id="cash-suggestions" class="flex justify-center gap-2 mb-4"></div><input type="number" id="cash-paid" onfocus="this.value=''" onblur="if(this.value=='') this.value=currentTotal; calcChange();" oninput="calcChange()" class="w-full p-5 bg-gray-50 rounded-2xl text-4xl font-black text-[#006241] outline-none text-center" placeholder="0"><div class="mt-6 pt-5 border-t border-dashed text-center"><p class="font-bold text-gray-300 uppercase text-[9px] mb-1">Ti·ªÅn th·ª´a</p><p id="cash-change" class="text-5xl font-black text-amber-500">0ƒë</p></div></div></div><button onclick="completeOrder()" id="btn-done" class="w-full py-8 mt-4 sb-green text-white font-black text-2xl rounded-3xl uppercase shadow-2xl active:scale-95 transition-all tracking-[0.2em]">Ho√†n t·∫•t</button>
    </div>

  <div class="flex md:hidden flex-col h-full bg-[#F2F2F7] relative overflow-hidden font-sans">
        
        <div class="px-5 py-4 flex items-center justify-between sticky top-0 z-20" style="background: rgba(242,242,247,0.9); backdrop-filter: blur(15px);">
            <button onclick="backMobileStep()" class="w-12 h-12 rounded-full bg-white flex items-center justify-center text-gray-800 shadow-sm active:scale-90 transition-transform border border-gray-100">
               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" /></svg>
            </button>
            <h2 id="mob-pay-title" class="text-2xl text-gray-900 font-black tracking-tight uppercase">Thanh to√°n</h2>
            <div class="w-12"></div> </div>

        <div class="flex-1 overflow-y-auto p-5 pb-32 space-y-6">

            <div id="mob-step-1" class="flex flex-col gap-5 animate-slide-up">
                
                <div class="neo-card p-6 py-8 flex flex-col items-center justify-center relative overflow-hidden">
                    <p class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-2">T·ªïng ho√° ƒë∆°n</p>
                    <p id="pay-total-display-1" class="brand-font text-6xl text-[#1e3932] font-black tracking-tighter">0</p>
                </div>

                <div class="neo-card p-2">
                    <div class="neo-input-box flex items-center p-3">
                        <div class="w-14 h-14 rounded-full bg-white flex items-center justify-center text-2xl shadow-sm shrink-0">üë§</div>
                        <div class="flex-1 ml-4 mr-2">
                            <p class="text-[11px] font-bold text-gray-500 uppercase mb-1">Kh√°ch h√†ng / T√≠ch ƒëi·ªÉm</p>
                            <input type="tel" id="pay-sdt-mobile" oninput="syncMobileInputs()" placeholder="Nh·∫≠p SƒêT..." 
                                   class="w-full bg-transparent border-none text-gray-900 text-xl font-bold p-0 outline-none placeholder:text-gray-300">
                        </div>
                    </div>
                    <div id="pay-cust-name-mobile" class="h-0 overflow-hidden transition-all duration-300"></div>
                </div>

                <div class="grid grid-cols-2 gap-4 mt-2">
                    <button onclick="goToMobileCash()" class="neo-btn-secondary py-6 flex flex-col items-center justify-center gap-2">
                        <span class="text-4xl mb-1">üíµ</span>
                        <span class="text-base font-bold text-gray-800">Ti·ªÅn m·∫∑t</span>
                    </button>
                    <button onclick="setMethod('Chuy·ªÉn kho·∫£n')" class="neo-btn-secondary py-6 flex flex-col items-center justify-center gap-2">
                        <span class="text-4xl mb-1">üè¶</span>
                        <span class="text-base font-bold text-gray-800">Chuy·ªÉn kho·∫£n</span>
                    </button>
                </div>
            </div>

            <div id="mob-step-2" class="hidden flex flex-col gap-5 animate-slide-up">
                
                <div class="neo-card p-5 pb-6 relative overflow-hidden">
                    <p class="text-center text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 mt-2">Nh·∫≠p ti·ªÅn kh√°ch ƒë∆∞a</p>
                    
                    <div class="relative flex justify-center items-center mb-6">
                        <input type="tel" id="cash-paid-mobile" oninput="syncMobileInputs()" placeholder="0" 
                               class="w-full text-center bg-transparent border-none outline-none text-6xl font-black text-[#006241] p-0 z-10 placeholder:text-gray-200">
                    </div>

                    <div id="cash-suggestions-mobile" class="grid grid-cols-2 gap-3 mb-2">
                        </div>

                    <div class="mt-6 pt-5 border-t border-dashed border-gray-100 flex justify-between items-end">
                        <span class="text-sm font-bold text-gray-500">Ti·ªÅn th·ª´a:</span>
                        <span id="cash-change-mobile" class="text-3xl font-black text-amber-500">0ƒë</span>
                    </div>
                </div>

                <button onclick="completeOrder()" class="neo-btn-primary w-full py-5 text-xl font-black uppercase tracking-widest shadow-xl shadow-green-900/20">
                    X√°c nh·∫≠n
                </button>
            </div>
        </div>
    </div>
</div>

        <div id="view-history" class="hidden h-full flex overflow-hidden bg-white" onclick="switchView('menu')">
    <div id="history-left-col" class="w-[320px] border-r border-gray-100 overflow-y-auto p-4 space-y-4 bg-gray-50/50" onclick="event.stopPropagation()">
        <div id="history-container" class="space-y-3"></div>
    </div>
    
    <div class="flex-1 p-6 flex flex-col items-center bg-white relative overflow-hidden" onclick="event.stopPropagation()">
        <div id="history-detail-empty" class="h-full flex flex-col items-center justify-center opacity-10 text-center">
            <h1 class="brand-font text-8xl text-[#006241]">The cafe 33</h1>
        </div>
        <div id="history-detail-content" class="hidden w-full h-full flex flex-col animate-fade-in text-left"></div>
    </div>
</div>

        <div id="view-bed" class="hidden h-full flex gap-3 bg-[#F2F2F7] p-3 rounded-[24px]">
            <div class="w-[30%] flex flex-col bg-white rounded-[20px] shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-4 py-3 border-b border-gray-50 bg-white sticky top-0 z-10 flex justify-between items-center">
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Danh s√°ch</span>
                    <input type="date" id="date-picker-btn" onchange="changeBedDate(this.value)" 
       class="text-[10px] font-bold text-[#006241] bg-green-50 px-2 py-1 rounded-md border-none outline-none cursor-pointer hover:bg-green-100 transition-colors">
                </div>
                <div id="col-left-list" class="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar"></div>
            </div>
            <div class="w-[50%] flex flex-col bg-white rounded-[20px] shadow-sm border border-gray-100 overflow-hidden relative">
                <div id="detail-empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-gray-300">
                    <p class="font-medium text-xs">Ch·ªçn l·ªãch ƒë·ªÉ xem</p>
                </div>
                <div id="detail-content-panel" class="hidden flex-col h-full bg-[#F2F2F7] relative overflow-hidden">
    
    <div class="relative z-10 bg-white/80 backdrop-blur-xl border-b border-gray-200 pt-6 pb-6 px-6 shadow-sm sticky top-0">
        <div class="flex justify-between items-start">
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">ƒêang ch·ªçn</p>
                </div>
                <h1 class="text-4xl font-black text-[#1e3932] tracking-tight" id="detail-bed-name">BED 01</h1>
            </div>
            
            <div id="detail-status-badge" class="px-4 py-1.5 bg-amber-100 text-amber-700 rounded-full text-[11px] font-black uppercase tracking-wide border border-amber-200/50 shadow-sm">
                WAITING
            </div>
        </div>
    </div>

    <div class="flex-1 overflow-y-auto custom-scrollbar p-5 space-y-5">

        <div id="detail-timer-box" class="hidden text-center py-6 bg-white rounded-[24px] shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-gray-100 relative overflow-hidden group">
            <div class="absolute inset-0 bg-green-50/50 opacity-0 group-hover:opacity-100 transition-opacity"></div>
            <span class="relative z-10 text-[10px] text-gray-400 uppercase font-bold tracking-widest bg-white px-3 py-1 rounded-full border border-gray-100">Th·ªùi gian c√≤n l·∫°i</span>
            <div id="detail-countdown" class="relative z-10 text-5xl font-black text-[#006241] font-mono tracking-tighter mt-3 drop-shadow-sm">00:00</div>
        </div>

        <div class="bg-white rounded-[24px] shadow-sm border border-gray-200/60 overflow-hidden">
            <div class="p-4 flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-xl shadow-inner shrink-0">
                    üë§
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-0.5">Ng∆∞·ªùi ƒë·∫∑t</p>
                    <p class="font-bold text-gray-900 text-lg truncate leading-tight" id="detail-cust-name">--</p>
                    <p class="font-mono text-xs text-gray-500 font-medium mt-0.5" id="detail-cust-phone">--</p>
                </div>
            </div>
            
            <div class="h-[1px] bg-gray-100 mx-4"></div>

            <div class="p-4 flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center text-xl shadow-inner shrink-0">
                    üë•
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-0.5">Ng∆∞·ªùi ƒëi c√πng</p>
                    <p class="font-bold text-gray-900 text-lg truncate leading-tight" id="detail-comp-name">--</p>
                    <p class="font-mono text-xs text-gray-500 font-medium mt-0.5" id="detail-comp-phone">--</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-[24px] shadow-sm border border-gray-200/60 p-5 flex justify-between items-center relative overflow-hidden">
            <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-[#006241]"></div>
            
            <div class="pl-2">
                <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">B·∫Øt ƒë·∫ßu</p>
                <p class="text-2xl font-black text-[#1e3932]" id="detail-start">--:--</p>
            </div>
            
            <div class="text-gray-200 text-2xl font-light">‚ûù</div>

            <div class="text-right">
                <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">K·∫øt th√∫c</p>
                <p class="text-2xl font-black text-[#1e3932]" id="detail-end">--:--</p>
            </div>
        </div>
        
        <div id="row-checkout-time" class="hidden bg-gray-100 rounded-[20px] p-4 border border-gray-200 flex justify-between items-center">
            <span class="text-xs font-bold text-gray-500 uppercase">Th·ª±c t·∫ø tr·∫£:</span>
            <span class="font-black text-red-600 text-lg" id="detail-real-end">--:--</span>
        </div>

    </div>

    <div id="detail-action-buttons" class="p-5 pb-8 bg-white/90 backdrop-blur-md border-t border-gray-200 mt-auto z-20">
        <div class="grid grid-cols-2 gap-3">
            <button id="btn-action-order" class="py-4 rounded-[18px] bg-amber-50 text-amber-700 font-bold border border-amber-100 shadow-sm active:scale-95 transition-all flex justify-center items-center gap-2 group">
                <span class="text-lg group-hover:scale-110 transition-transform">‚òï</span>
                <span class="uppercase text-xs tracking-wider">G·ªçi M√≥n</span>
            </button>
            
            <button id="btn-action-checkout" class="py-4 rounded-[18px] bg-[#006241] text-white font-bold shadow-lg shadow-green-900/20 active:scale-95 transition-all flex justify-center items-center gap-2">
                <span class="text-lg">üõèÔ∏è</span>
                <span class="uppercase text-xs tracking-wider">X·∫øp Bed Ngay</span>
            </button>
        </div>

        <div id="wrapper-btn-cancel" class="mt-3 hidden">
            <button id="btn-action-cancel" class="w-full py-3 rounded-[18px] text-red-400 font-bold bg-transparent hover:bg-red-50 transition-colors text-[10px] uppercase tracking-widest border border-dashed border-gray-300 hover:border-red-200">
                H·ªßy L·ªãch N√†y
            </button>
        </div>
    </div>
</div>
            </div>
            <div class="w-[20%] flex flex-col gap-3">
                <button onclick="openBookingModal()" class="w-full bg-[#006241] hover:bg-[#004f32] text-white py-4 rounded-[20px] font-bold shadow-md transform active:scale-95 transition-all flex flex-col items-center justify-center gap-1"><span class="text-xs uppercase tracking-wider">ƒê·∫∑t M·ªõi</span></button>
                <div class="flex-1 bg-white rounded-[20px] shadow-sm border border-gray-100 p-3 flex flex-col overflow-hidden"><h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3 text-center">Live Map</h3><div class="flex-1 flex flex-col gap-2 overflow-y-auto custom-scrollbar" id="vertical-map-container"></div></div>
            </div>
        </div>
    </div>
</div>

<div id="sidebar-cart" class="w-[360px] bg-white rounded-[2.5rem] shadow-2xl flex flex-col p-4 border-l-4 border-[#006241] text-left transition-all duration-300 z-[50]"> 
    <div class="md:hidden w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-3 cursor-pointer" onclick="toggleCartExpand()"></div>

    <div class="hidden md:flex justify-between items-center mb-3">
        <h2 class="brand-font text-lg uppercase">ƒê∆°n h√†ng</h2>
        <button id="btn-clear-all" onclick="clearFullOrder()" class="bg-red-50 text-red-500 text-[9px] font-black px-3 py-1.5 rounded-xl uppercase">X√≥a</button>
    </div>

    <div id="cart-top-section" class="block md:block">
        <input type="tel" id="kh-sdt" oninput="checkSdtLive()" placeholder="SƒêT kh√°ch..." class="w-full p-3 bg-gray-50 rounded-xl mb-3 outline-none border-2 border-gray-50 text-center font-bold text-base focus:border-[#006241]">
        <p id="sdt-status" class="text-[8px] font-black uppercase mb-3 text-center"></p>
    </div>

    <div id="cart-list" class="flex-1 overflow-y-auto space-y-1.5 mb-3 pr-1 text-left custom-scrollbar transition-all"></div>

    <div id="cart-bottom-bar" class="bg-gray-50 p-4 rounded-2xl space-y-3 shadow-inner text-left mt-auto">
        <div class="flex justify-between items-end" onclick="toggleCartExpand()">
            <span class="font-bold text-gray-400 text-[10px] uppercase text-left mb-1">T·ªïng bill</span>
            <div class="flex items-center gap-2">
                <span class="md:hidden text-[#006241] text-xs animate-bounce">‚ñ≤</span>
                <span id="total-price" class="text-3xl font-black text-[#006241]">0</span>
            </div>
        </div>
        <button id="sidebar-pay-btn" onclick="switchView('payment')" class="w-full py-4 sb-green text-white font-black rounded-xl uppercase shadow-xl active:scale-95 transition-all">Thanh to√°n</button>
    </div>
</div>

<div id="bed-select-modal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/40 backdrop-blur-sm transition-all duration-300 p-4 pb-8 sm:p-4">
    
    <div class="bg-[#F2F2F7] w-full max-w-[380px] rounded-3xl shadow-2xl overflow-hidden transform transition-all scale-100 relative flex flex-col animate-slide-up sm:animate-none">
        
        <div class="bg-[#006241] px-6 py-5 flex justify-between items-center shrink-0 relative overflow-hidden">
            <div class="absolute top-0 right-0 -mt-4 -mr-4 text-[#2a4f45] opacity-30">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor"><path d="M2 20h20v2H2v-2zm2-8h2v7H4v-7zm5 0h2v7H9v-7zm4 0h2v7h-2v-7zm5 0h2v7h-2v-7zM2 7h20v2H2V7zm2-5h2v4H4V2zm5 0h2v4H9V2zm4 0h2v4h-2V2zm5 0h2v4h-2V2z"/></svg>
            </div>
            <div class="relative z-10">
                <h3 class="text-white text-xl font-bold tracking-wide">Ch·ªçn Gi∆∞·ªùng</h3>
                <p class="text-green-100/80 text-sm mt-0.5">Vui l√≤ng ch·ªçn v·ªã tr√≠ c√≤n tr·ªëng</p>
            </div>
            <button onclick="document.getElementById('bed-select-modal').classList.add('hidden')" 
                class="relative z-10 w-8 h-8 rounded-full bg-black/20 flex items-center justify-center text-white hover:bg-black/30 transition backdrop-blur-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
            </button>
        </div>

        <div class="p-5 bg-[#F2F2F7]">
            <div class="grid grid-cols-2 gap-4" id="bed-selection-container">
                </div>
        </div>
        
        <div class="px-6 pb-5 text-center text-gray-400 text-[10px] font-medium uppercase tracking-wider">
            Ch·∫°m v√†o Bed m√†u xanh ƒë·ªÉ x√°c nh·∫≠n
        </div>
    </div>
</div>
<div id="walk-in-modal" class="fixed inset-0 bg-black/40 z-[9999] hidden flex items-center justify-center p-6 backdrop-blur-[4px]">
    <div class="bg-white/95 backdrop-blur-2xl w-full max-w-sm rounded-[35px] p-8 shadow-[0_30px_60px_rgba(0,0,0,0.3)] text-center border border-white/60">
        <h3 class="brand-font text-2xl text-[#006241] mb-1 uppercase font-black tracking-wide">Kh√°ch v√£ng lai</h3>
        <p class="text-[10px] text-gray-400 font-bold uppercase mb-6 tracking-widest">Nh·∫≠p th√¥ng tin nhanh</p>
        
        <input type="tel" id="walkin-phone" oninput="checkCustomer()" placeholder="Nh·∫≠p SƒêT kh√°ch..." 
            class="w-full p-4 bg-gray-50/50 rounded-3xl text-center font-bold mb-2 outline-none border border-gray-100 focus:border-[#006241] focus:bg-white transition-all text-[#006241] text-lg placeholder:text-gray-300">
        
        <div id="customer-info" class="h-4 mb-3 text-[10px]"></div>

        <input type="number" id="walkin-hours" placeholder="S·ªë gi·ªù (1, 2...)" 
            class="w-full p-4 bg-gray-50/50 rounded-3xl text-center font-bold mb-8 outline-none border border-gray-100 focus:border-[#006241] focus:bg-white transition-all text-[#006241] text-lg placeholder:text-gray-300">
        
        <div class="grid grid-cols-2 gap-3">
            <button onclick="document.getElementById('walk-in-modal').classList.add('hidden')" 
                class="py-4 bg-gray-100 text-gray-400 font-black rounded-[24px] uppercase text-xs hover:bg-gray-200 transition-all">
                Hu·ª∑
            </button>
            <button onclick="submitWalkIn()" 
                class="py-4 bg-[#006241] text-white font-black rounded-[24px] uppercase text-xs shadow-lg shadow-green-900/20 active:scale-95 transition-all">
                T·∫°o ƒë∆°n
            </button>
        </div>
    </div>
</div>

<div id="app-modal" class="fixed inset-0 bg-black/40 z-[9999] hidden flex items-center justify-center p-6 backdrop-blur-[4px]">
    <div class="bg-white/95 backdrop-blur-2xl w-full max-w-[320px] rounded-[35px] p-8 shadow-[0_30px_60px_rgba(0,0,0,0.3)] text-center border border-white/60">
        <div id="app-modal-icon" class="text-5xl mb-4"></div>
        <h3 id="app-modal-title" class="brand-font text-xl text-[#006241] mb-2 uppercase font-black text-center tracking-wide">Th√¥ng b√°o</h3>
        <div id="app-modal-msg" class="text-sm text-gray-600 font-medium mb-8 leading-relaxed px-2"></div>
        <button onclick="document.getElementById('app-modal').classList.add('hidden')" 
            class="w-full py-4 bg-[#006241] text-white font-black rounded-[24px] uppercase shadow-lg shadow-green-900/20 active:scale-95 transition-all">
            ƒê√£ hi·ªÉu
        </button>
    </div>
</div>

<div id="confirm-modal" class="fixed inset-0 bg-black/40 z-[10000] hidden flex items-center justify-center p-6 backdrop-blur-[4px]">
    <div class="bg-white/95 backdrop-blur-2xl w-full max-w-[320px] rounded-[35px] p-8 shadow-[0_30px_60px_rgba(0,0,0,0.3)] text-center border border-white/60 border-t-8 border-t-red-500">
        <div class="text-5xl mb-4">‚ö†Ô∏è</div>
        <h3 class="brand-font text-xl text-red-500 mb-2 uppercase font-black text-center tracking-wide">L∆∞u √Ω</h3>
        <div id="confirm-msg" class="text-sm text-gray-600 font-medium mb-8 leading-relaxed"></div>
        <div class="grid grid-cols-2 gap-3">
            <button onclick="document.getElementById('confirm-modal').classList.add('hidden')" 
                class="py-4 bg-gray-100 text-gray-500 rounded-[24px] font-black uppercase text-[10px] hover:bg-gray-200 transition-all">
                Quay l·∫°i
            </button>
            <button id="confirm-btn-yes" 
                class="py-4 bg-red-500 text-white rounded-[24px] font-black uppercase text-[10px] shadow-lg shadow-red-500/30 active:scale-95 transition-all">
                ƒê·ªìng √Ω
            </button>
        </div>
    </div>
</div>

<div id="size-modal" class="fixed inset-0 bg-black/40 z-[100] hidden items-center justify-center p-6 backdrop-blur-[6px]" onclick="closeSize()">
    
    <div class="bg-white/95 backdrop-blur-2xl w-full max-w-[500px] rounded-[45px] p-10 text-center shadow-[0_30px_80px_rgba(0,0,0,0.3)] border border-white/60 relative overflow-hidden" onclick="event.stopPropagation()">

        <h3 id="modal-item-name" class="brand-font text-3xl text-[#006241] mb-2 uppercase text-center font-black mt-2 leading-tight">T√™n m√≥n</h3>
        <p class="text-xs text-gray-400 font-bold uppercase tracking-widest mb-10">Vui l√≤ng ch·ªçn k√≠ch c·ª°</p>
        
        <div id="size-options-container" class="grid grid-cols-2 gap-6 text-center">
            
            <button id="btn-size-m" class="p-6 rounded-[35px] bg-green-50/50 border-2 border-[#006241]/10 flex flex-col items-center justify-center transition-all shadow-sm active:scale-95 active:bg-green-100 h-[200px]">
                <span class="block text-6xl mb-4 drop-shadow-sm">ü•§</span>
                <span class="block font-black text-xl uppercase text-[#006241]">SIZE M</span>
                <span id="price-m" class="text-[#006241] font-bold mt-2 text-2xl">--</span>
            </button>

            <button id="btn-size-l" class="p-6 rounded-[35px] bg-green-50/50 border-2 border-[#006241]/10 flex flex-col items-center justify-center transition-all shadow-sm active:scale-95 active:bg-green-100 h-[200px]">
                <span class="block text-7xl mb-4 drop-shadow-sm">ü•§</span>
                <span class="block font-black text-xl uppercase text-[#006241]">SIZE L</span>
                <span id="price-l" class="text-[#006241] font-bold mt-2 text-2xl">--</span>
            </button>
        </div>
    </div>
</div>
<div id="modal-add-booking" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm transition-all duration-300">
    
    <div class="bg-white w-full max-w-[420px] md:rounded-3xl rounded-t-3xl shadow-2xl overflow-hidden transform transition-all scale-100 relative max-h-[90vh] flex flex-col">
        
        <div class="bg-[#006241] px-6 py-5 flex justify-between items-center shrink-0">
            <div>
                <h3 class="text-white text-lg font-bold tracking-wide">ƒê·∫∑t Bed M·ªõi</h3>
                <p class="text-green-100/70 text-xs mt-0.5">Nh·∫≠p th√¥ng tin kh√°ch v√£ng lai</p>
            </div>
            <button type="button" onclick="closeBookingModal()" 
    class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-white hover:bg-white/20 transition cursor-pointer z-50">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
    </svg>
</button>
        </div>

        <div class="p-6 space-y-5 overflow-y-auto custom-scrollbar">
            
            <div>
                <div class="flex items-center gap-2 mb-3">
                    <div class="w-1 h-4 bg-[#006241] rounded-full"></div>
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Ng∆∞·ªùi ƒë·∫∑t</span>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-1">
                        <label class="block text-[10px] font-bold text-gray-500 mb-1 ml-1">S·ªê ƒêI·ªÜN THO·∫†I</label>
                        <input type="tel" id="new_cust_phone" placeholder="09..." oninput="autoFillCustomer()"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2.5 text-sm font-bold text-gray-800 focus:outline-none focus:border-[#006241] focus:bg-white focus:ring-1 focus:ring-[#006241] transition-all placeholder:font-normal">
                    </div>
                    <div class="col-span-1">
                        <label class="block text-[10px] font-bold text-gray-500 mb-1 ml-1">H·ªå T√äN</label>
                        <input type="text" id="new_cust_name" placeholder="T√™n kh√°ch" value="Kh√°ch v√£ng lai"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2.5 text-sm font-bold text-gray-800 focus:outline-none focus:border-[#006241] focus:bg-white focus:ring-1 focus:ring-[#006241] transition-all placeholder:font-normal">
                    </div>
                </div>
            </div>

            <div>
                <div class="flex items-center gap-2 mb-3">
                    <div class="w-1 h-4 bg-gray-300 rounded-full"></div>
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Ng∆∞·ªùi ƒëi c√πng</span>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="new_comp_name" placeholder="T√™n b·∫°n..." 
                        class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2.5 text-sm text-gray-700 focus:outline-none focus:border-[#006241] focus:bg-white transition-all">
                    <input type="tel" id="new_comp_phone" placeholder="SƒêT b·∫°n..." 
                        class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2.5 text-sm text-gray-700 focus:outline-none focus:border-[#006241] focus:bg-white transition-all">
                </div>
            </div>

            <div>
                <div class="flex items-center gap-2 mb-3">
                    <div class="w-1 h-4 bg-amber-400 rounded-full"></div>
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Th·ªùi gian</span>
                </div>
                <div class="bg-gray-100 p-1 rounded-xl flex mb-3 relative">
                    <button onclick="toggleTimeMode('duration')" id="tab-duration" class="flex-1 py-2 text-xs font-bold rounded-lg shadow-sm bg-white text-[#006241] transition-all">Theo Ti·∫øng</button>
                    <button onclick="toggleTimeMode('end-time')" id="tab-end-time" class="flex-1 py-2 text-xs font-bold rounded-lg text-gray-500 hover:bg-gray-200 transition-all">Ch·ªçn Gi·ªù V·ªÅ</button>
                </div>
                
                <div id="mode-duration-box" class="grid grid-cols-3 gap-2">
                    <button onclick="selectDuration(1)" id="btn-dur-1" class="border border-green-600 bg-green-50 text-[#006241] py-2.5 rounded-xl text-sm font-bold hover:opacity-80 transition-all">1 Gi·ªù</button>
                    <button onclick="selectDuration(2)" id="btn-dur-2" class="border border-gray-200 bg-white text-gray-600 py-2.5 rounded-xl text-sm font-bold hover:bg-gray-50 transition-all">2 Gi·ªù</button>
                    <button onclick="selectDuration(3)" id="btn-dur-3" class="border border-gray-200 bg-white text-gray-600 py-2.5 rounded-xl text-sm font-bold hover:bg-gray-50 transition-all">3 Gi·ªù</button>
                </div>
                
                <div id="mode-endtime-box" class="hidden">
                    <input type="time" id="manual-end-time" class="w-full text-center bg-gray-50 border-2 border-gray-200 rounded-xl py-3 text-lg font-bold text-[#006241] focus:border-[#006241] outline-none">
                </div>
            </div>
        </div>

        <div class="p-6 pt-0 mt-auto">
            <button onclick="submitNewBooking()" class="w-full bg-[#006241] text-white py-3.5 rounded-xl font-bold shadow-lg shadow-green-900/20 active:scale-[0.98] transition-all flex justify-center items-center gap-2">
                <span>T·∫†O L·ªäCH & CH·ªú X·∫æP</span>
            </button>
        </div>
    </div>
</div>

<script>    
function normalizePhone(p){
    return String(p || "").replace(/[^0-9]/g, "");
}

function findCustomerByPhone(phone){
    const key = normalizePhone(phone);
    if(!key) return null;
    return customerMap[key] || null;
}


// =========================================================
// 1. C·∫§U H√åNH & K·∫æT N·ªêI FIREBASE
// =========================================================
const firebaseConfig = {
  apiKey: "AIzaSyCNh1-16gYZ0P30Fkd-2tB-O89PXkPX9Lc",
  authDomain: "the-cafe-33.firebaseapp.com",
  databaseURL: "https://the-cafe-33-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "the-cafe-33",
  storageBucket: "the-cafe-33.appspot.com",
  messagingSenderId: "...",
  appId: "..."
};

// Kh·ªüi t·∫°o Firebase an to√†n
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.database();
// --- B·∫ÆT ƒê·∫¶U CODE ƒêƒÇNG NH·∫¨P T·ª∞ ƒê·ªòNG ---
const auth = firebase.auth();

function autoLoginPOS() {
    // Thay email/pass b·∫±ng c√°i b√† t·∫°o ·ªü B∆Ø·ªöC 1
    const email = "elio@thecafe33.com"; 
    const pass = "Thecafe33ty"; 

    auth.signInWithEmailAndPassword(email, pass)
        .then((userCredential) => {
            console.log("‚úÖ ƒê√£ ƒëƒÉng nh·∫≠p Admin th√†nh c√¥ng!");
            // ƒêƒÉng nh·∫≠p xong m·ªõi t·∫£i d·ªØ li·ªáu cho ch·∫Øc
            // (C√°c h√†m t·∫£i d·ªØ li·ªáu c≈© v·∫´n s·∫Ω t·ª± ch·∫°y nh·ªù listener, n√™n kh√¥ng c·∫ßn g·ªçi l·∫°i ·ªü ƒë√¢y c≈©ng ƒë∆∞·ª£c)
        })
        .catch((error) => {
            console.error("‚ùå L·ªói ƒëƒÉng nh·∫≠p:", error.message);
            alert("L·ªói: Kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p v√†o h·ªá th·ªëng! Ki·ªÉm tra l·∫°i Email/Pass trong code.");
        });
}

// G·ªçi h√†m n√†y ngay khi ch·∫°y App
autoLoginPOS();
// --- K·∫æT TH√öC CODE ƒêƒÇNG NH·∫¨P ---
// =========================================================
// 2. BI·∫æN TO√ÄN C·ª§C
// =========================================================
let menu = []; 
let historyData = [];
let cart = [];
let currentTotal = 0;
let customerMap = {};
let currentTab = "T·∫•t c·∫£";
let isPaymentMode = false;
let myChart = null;
let selectedRefundItems = [];
let paymentListener = null; // Bi·∫øn ƒë·ªÉ theo d√µi ti·ªÅn v·ªÅ
let currentOrderCode = "";  // Bi·∫øn l∆∞u m√£ ƒë∆°n h√†ng ƒëang ch·ªù


// Bi·∫øn qu·∫£n l√Ω Bed
var currentBedList = [];
var selectedBedIndex = -1;
var bedCountdownInterval = null;
var pendingBedOrder = null;
var activeOrderingBedId = null;
var isCheckoutFlow = false; // Bi·∫øn ƒë√°nh d·∫•u: C√≥ ph·∫£i ƒëang tr·∫£ Bed kh√¥ng?

// ƒê·ªìng h·ªì h·ªá th·ªëng
setInterval(() => {
    const el = document.getElementById('clock');
    if(el) el.innerText = new Date().toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
}, 1000);

// =========================================================
// 3. KH·ªûI ƒê·ªòNG APP (C√ì C∆† CH·∫æ CH·ªêNG TREO)
// =========================================================
    // === FIX ID SƒêT: walkin-phone -> kh-sdt ===


window.onload = function() {
    console.log("üöÄ App ƒëang kh·ªüi ƒë·ªông...");

    // A. C√†i ƒë·∫∑t "L·ªëi tho√°t hi·ªÉm": T·ª± t·∫Øt loading sau 5 gi√¢y n·∫øu Firebase kh√¥ng ph·∫£n h·ªìi
    const safetyTimer = setTimeout(() => {
        const ol = document.getElementById('loading-overlay');
        if(ol && ol.style.display !== 'none') {
            ol.style.display = 'none';
            console.warn("‚ö†Ô∏è Loading qu√° l√¢u, t·ª± ƒë·ªông b·ªè qua.");
        }
    }, 5000);

    // B. L·∫Øng nghe Menu t·ª´ Firebase
    db.ref("customers").on("value", (snap) => {
    customerMap = snap.val() || {};
    console.log("Customers:", Object.keys(customerMap).length);
});

    db.ref('menu').on('value', (snapshot) => {
        clearTimeout(safetyTimer); // H·ªßy b·ªô ƒë·∫øm tho√°t hi·ªÉm v√¨ ƒë√£ k·∫øt n·ªëi ƒë∆∞·ª£c
        const data = snapshot.val();
        
        if (data) {
            menu = Array.isArray(data) ? data : Object.values(data);
            console.log(`‚úÖ ƒê√£ t·∫£i ${menu.length} m√≥n.`);
            // V·∫Ω giao di·ªán
            renderTabs();
            renderMenu();
        } else {
            console.log("‚ö†Ô∏è Menu tr√™n Firebase ƒëang tr·ªëng!");
        }
        // T·∫Øt m√†n h√¨nh loading
        document.getElementById('loading-overlay').style.display = 'none';
    }, (error) => {
        console.error("‚ùå L·ªói Firebase Menu:", error);
        document.getElementById('loading-overlay').style.display = 'none';
        alert("L·ªói k·∫øt n·ªëi: " + error.message);
    });
// C. L·∫Øng nghe danh s√°ch KH√ÅCH H√ÄNG t·ª´ Firebase
db.ref("customers").on("value", snap => {
    customerMap = snap.val() || {};
    console.log("üë• ƒê√£ load", Object.keys(customerMap).length, "kh√°ch");
});

    // C. L·∫Øng nghe Bed (Ch·∫°y ng·∫ßm)
    db.ref('beds').on('value', (snapshot) => {
        const data = snapshot.val();
        currentBedList = [];
        if(data) {
            Object.keys(data).forEach(key => {
                let item = data[key];
                item.key = key; 
                currentBedList.push(item);
            });
        }
        // N·∫øu ƒëang m·ªü tab Bed th√¨ v·∫Ω l·∫°i ngay
        const viewBed = document.getElementById('view-bed');
        if(viewBed && !viewBed.classList.contains('hidden')) {
            renderBedBookings(currentBedList);
        }
    });
    switchView('menu'); // <--- K√≠ch ho·∫°t giao di·ªán & Hi·ªán Bottom Bar ngay l·∫≠p t·ª©c
};

// =========================================================
// 4. MENU & GI·ªé H√ÄNG (CORE)
// =========================================================
// --- H√ÄM V·∫º MENU (2 TRONG 1: NGANG CHO PC - D·ªåC CHO MOBILE) ---
// --- H√ÄM V·∫º MENU & C·∫¨P NH·∫¨T T·ªîNG TI·ªÄN TR√äN ƒê·∫¶U ---

function renderTabs() {
    if (!menu || menu.length === 0) return;
    const cats = ["T·∫•t c·∫£", ...new Set(menu.map(m => m.type))];

    // 1. Render cho Tablet (Gi·ªØ nguy√™n)
    const containerPC = document.getElementById('tabs-container');
    if(containerPC) {
        containerPC.innerHTML = cats.map(c => `<button onclick="filterTab('${c}')" class="category-tab ${c === currentTab? 'tab-active': 'bg-white text-gray-400'} capitalize-first transition-all">${c}</button>`).join('');
    }

    // 2. Render cho Mobile (Dropdown ki·ªÉu m·ªõi)
    const containerMob = document.getElementById('mob-cat-list-new');
    if(containerMob) {
        containerMob.innerHTML = cats.map(c => {
            const isActive = (c === currentTab);
            // Style: N√∫t bo tr√≤n, icon check b√™n ph·∫£i
            return `
            <div onclick="filterTabMobile('${c}')" class="p-3 rounded-xl flex justify-between items-center cursor-pointer transition-all ${isActive ? 'bg-green-50 text-[#006241]' : 'hover:bg-gray-50 text-gray-600'}">
                <span class="capitalize-first font-bold text-sm ml-2">${c}</span>
                ${isActive ? '<span class="text-[#006241] text-lg font-black">‚úì</span>' : ''}
            </div>
            `;
        }).join('');
    }
}

// ============================================================
// --- 1. LOGIC MENU DANH M·ª§C TR∆Ø·ª¢T T·ª™ ƒê√ÅY (BOTTOM SHEET) ---
// ============================================================
// --- H√ÄM M·ªû DANH M·ª§C (GIAO DI·ªÜN S√ÅNG & N√öT CHUBBY) ---
// --- LOGIC DROPDOWN MENU (M·ªöI: TH·∫¢ T·ª™ TR√äN XU·ªêNG) ---

// 1. H√†m B·∫≠t/T·∫Øt Menu
// 1. H√†m B·∫≠t/T·∫Øt Menu (ƒê√£ ch·ªânh ch·ªØ TO v√† ƒê·∫¨M)
function toggleCategoryDropdown() {
    const drop = document.getElementById('mob-cat-dropdown');
    const overlay = document.getElementById('mob-cat-overlay');
    const list = document.getElementById('mob-cat-list');

    if (drop.classList.contains('hidden')) {
        // --- M·ªû MENU ---
        
        // V·∫Ω danh s√°ch m√≥n
        const cats = ["T·∫•t c·∫£", ...new Set(menu.map(m => m.type))];
        list.innerHTML = cats.map(c => {
            const isActive = (c === currentTab);
            
            // LOGIC STYLE:
            // - text-lg: Ch·ªØ to (Large)
            // - font-black: Ch·ªØ si√™u ƒë·∫≠m (d·ªÖ ƒë·ªçc)
            // - py-4: N√∫t cao, d·ªÖ b·∫•m
            
            return `
            <button onclick="selectCategoryDropdown('${c}')" class="w-full py-4 px-6 rounded-[1.5rem] flex items-center justify-between transition-all mb-1 ${isActive ? 'bg-[#E6F4F1] text-[#006241] shadow-sm ring-1 ring-[#006241]/20' : 'bg-white text-gray-700 hover:bg-gray-50'}">
                <span class="capitalize-first text-lg font-black tracking-wide">${c}</span>
                ${isActive ? '<span class="text-xl font-bold">‚úì</span>' : ''}
            </button>`;
        }).join('');

        // Hi·ªáu ·ª©ng hi·ªán ra
        drop.classList.remove('hidden');
        overlay.classList.remove('hidden');
        setTimeout(() => {
            drop.classList.remove('opacity-0', 'scale-95');
            drop.classList.add('opacity-100', 'scale-100');
        }, 10);

    } else {
        // --- ƒê√ìNG MENU ---
        closeCategoryDropdown();
    }
}

// 2. H√†m ƒê√≥ng Menu (Hi·ªáu ·ª©ng m∆∞·ª£t)
function closeCategoryDropdown() {
    const drop = document.getElementById('mob-cat-dropdown');
    const overlay = document.getElementById('mob-cat-overlay');
    
    drop.classList.remove('opacity-100', 'scale-100');
    drop.classList.add('opacity-0', 'scale-95');
    overlay.classList.add('hidden');
    
    setTimeout(() => {
        drop.classList.add('hidden');
    }, 200);
}

// 3. H√†m Ch·ªçn M√≥n (X·ª≠ l√Ω xong th√¨ t·ª± ƒë√≥ng)
function selectCategoryDropdown(c) {
    currentTab = c;
    document.getElementById('mob-cat-label-new').innerText = c;
    renderMenu(); // L·ªçc m√≥n ƒÉn
    closeCategoryDropdown(); // ƒê√≥ng menu
}

function closeCategorySheet() {
    const sheet = document.getElementById('sheet-category');
    const content = document.getElementById('sheet-category-content');
    
    // Hi·ªáu ·ª©ng ƒë√≥ng
    content.classList.remove('sheet-open');
    sheet.querySelector('div').classList.add('opacity-0');
    
    setTimeout(() => {
        sheet.classList.add('hidden');
    }, 300);
}

// Khi ch·ªçn danh m·ª•c tr√™n Mobile
function selectCategoryMobile(c) {
    currentTab = c;
    // C·∫≠p nh·∫≠t ch·ªØ tr√™n n√∫t Menu
    document.getElementById('mob-cat-label-new').innerText = c;
    renderMenu(); // L·ªçc m√≥n ƒÉn
    closeCategorySheet(); // ƒê√≥ng sheet
}

// ============================================================
// --- 2. LOGIC GI·ªé H√ÄNG MOBILE (S·ª¨A / X√ìA M√ìN) ---
// ============================================================
// --- S·ª¨A H√ÄM N√ÄY ƒê·ªÇ GIAO DI·ªÜN N√öT TR√íN & KH√îNG B·ªä THANH BAR ƒê√à ---
/* --- ƒê√É S·ª¨A: Text to h∆°n, Padding ƒë√°y 200px ƒë·ªÉ kh√¥ng b·ªã ƒë√® --- */
/* --- ƒê√É S·ª¨A: Modal Chi Ti·∫øt Gi·ªè H√†ng (Ch·ªØ to, N√∫t tr√≤n, Padding ƒë√°y l·ªõn) --- */
function openCartModal() {
    if(cart.length === 0) return alert("Gi·ªè h√†ng ƒëang tr·ªëng! Ch·ªçn m√≥n ƒëi b√†.");

    const listEl = document.getElementById('sheet-cart-list');

    listEl.innerHTML = cart.map((i, idx) => `
    <div class="bg-white p-4 rounded-[24px] border border-gray-100 shadow-[0_2px_8px_rgba(0,0,0,0.04)] flex items-center gap-4 mb-3 relative overflow-hidden">
        
        <div class="flex-1 min-w-0 text-left">
            <p class="font-black text-[#1e3932] text-lg truncate capitalize-first tracking-tight">${i.name}</p>
            <p class="text-sm text-gray-400 font-bold uppercase mt-1">${i.size} ‚Ä¢ <span class="text-[#006241]">${i.price.toLocaleString()}ƒë</span></p>
        </div>

        <div class="flex items-center gap-3 bg-[#F2F4F6] rounded-full p-2 shadow-inner">
            <button onclick="updateQtyMobile(${idx}, -1)" class="w-10 h-10 flex items-center justify-center bg-white rounded-full shadow-sm text-gray-600 font-bold active:scale-90 transition-all text-2xl hover:text-red-500 leading-none pb-1">-</button>
            <span class="font-black text-xl w-6 text-center text-[#1e3932]">${i.qty}</span>
            <button onclick="updateQtyMobile(${idx}, 1)" class="w-10 h-10 flex items-center justify-center bg-[#006241] rounded-full shadow-lg shadow-green-900/20 text-white font-bold active:scale-90 transition-all text-2xl leading-none pb-1">+</button>
        </div>

        <button onclick="removeItemMobile(${idx})" class="w-12 h-12 flex items-center justify-center text-red-500 bg-red-50 rounded-full active:scale-90 transition-all hover:bg-red-100 border border-red-100 shadow-sm ml-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        </button>
    </div>
    `).join('');

    // ƒê·∫©y n·ªôi dung l√™n cao 200px ƒë·ªÉ kh√¥ng b·ªã thanh Bar che
    listEl.style.paddingBottom = "200px"; 

    document.getElementById('sheet-cart-edit').classList.remove('hidden');
    document.body.classList.add('cart-modal-open');     // ‚Üê TH√äM D√íNG N√ÄY
    updateCartPadding();
}
function closeCartModal() {
    document.getElementById('sheet-cart-edit').classList.add('hidden');
    document.body.classList.remove('cart-modal-open');  // ‚Üê TH√äM D√íNG N√ÄY
    updateCartPadding();
}

function updateQtyMobile(idx, delta) {
    cart[idx].qty += delta;
    if (cart[idx].qty <= 0) cart.splice(idx, 1); // H·∫øt th√¨ x√≥a lu√¥n
    
    renderCart(); // C·∫≠p nh·∫≠t l·∫°i t·ªïng ti·ªÅn b√™n ngo√†i
    
    if(cart.length === 0) closeCartModal();
    else openCartModal(); // V·∫Ω l·∫°i modal ƒë·ªÉ th·∫•y s·ªë l∆∞·ª£ng m·ªõi
}

function removeItemMobile(idx) {
    if(confirm("X√≥a m√≥n n√†y kh·ªèi gi·ªè h√©n?")) {
        cart.splice(idx, 1);
        renderCart();
        if(cart.length === 0) closeCartModal();
        else openCartModal();
    }
}

// --- H√ÄM ƒê√ìNG M·ªû DROPDOWN ---
function toggleCatDropdown() {
    const drop = document.getElementById('mob-cat-dropdown');
    const overlay = document.getElementById('mob-cat-overlay');
    const arrow = document.getElementById('cat-arrow');
    
    if (drop.classList.contains('hidden')) {
        // M·ªü ra
        drop.classList.remove('hidden');
        overlay.classList.remove('hidden');
        arrow.style.transform = "rotate(180deg)"; // Xoay m≈©i t√™n l√™n
    } else {
        // ƒê√≥ng l·∫°i
        drop.classList.add('hidden');
        overlay.classList.add('hidden');
        arrow.style.transform = "rotate(0deg)"; // Xoay m≈©i t√™n xu·ªëng
    }
}

// --- H√ÄM CH·ªåN DANH M·ª§C TR√äN MOBILE ---
function filterTabMobile(c) {
    // 1. C·∫≠p nh·∫≠t bi·∫øn to√†n c·ª•c
    currentTab = c;
    
    // 2. C·∫≠p nh·∫≠t nh√£n tr√™n n√∫t b·∫•m
    document.getElementById('mob-cat-label').innerText = c;
    
    // 3. L·ªçc m√≥n ƒÉn
    renderMenu();
    
    // 4. V·∫Ω l·∫°i dropdown (ƒë·ªÉ chuy·ªÉn d·∫•u t√≠ch xanh sang m√≥n m·ªõi)
    renderTabs();
    
    // 5. ƒê√≥ng dropdown
    toggleCatDropdown();
}

function filterTab(c) {
    currentTab = c; 
    
    // C·∫≠p nh·∫≠t giao di·ªán Tablet
    renderTabs(); 
    renderMenu();
    
    // C·∫≠p nh·∫≠t lu√¥n nh√£n Mobile (n·∫øu c√≥)
    const mobLabel = document.getElementById('mob-cat-label');
    if(mobLabel) mobLabel.innerText = c;
}

function renderMenu() { 
    const filtered = currentTab === "T·∫•t c·∫£"? menu: menu.filter(m => m.type === currentTab);
    const grid = document.getElementById('menu-grid');
    if (!grid) return;
    
    if (filtered.length === 0) { 
        grid.innerHTML = '<div class="col-span-3 text-center text-gray-400 py-10">Kh√¥ng c√≥ m√≥n n√†o.</div>'; 
        return; 
    }
    
    grid.innerHTML = filtered.map(m => 
        `<div onclick="handleItemClick('${m.name}', ${m.priceM}, ${m.priceL})" class="bg-white p-5 rounded-[2rem] border-2 border-gray-50 shadow-sm flex flex-col justify-center items-center text-center h-32 active:scale-95 cursor-pointer transition-all">
            <p class="font-bold text-[#006241] menu-item-name text-center">${m.name}</p>
            <p class="text-[10px] font-bold text-[#006241] mt-2 text-center">${m.priceM > 0 ? m.priceM.toLocaleString() : m.priceL.toLocaleString()}</p>
        </div>`
    ).join('');
}

function handleItemClick(name, pM, pL) { 
    if(isPaymentMode) return; 
    const vM = Number(pM), vL = Number(pL);
    
    // N·∫øu m√≥n c√≥ 2 size -> M·ªü Popup
    if (vM > 0 && vL > 0) { 
        document.getElementById('modal-item-name').innerText = name; 
        document.getElementById('price-m').innerText = vM.toLocaleString() + 'ƒë';
        document.getElementById('price-l').innerText = vL.toLocaleString() + 'ƒë'; 
        
        document.getElementById('btn-size-m').onclick = () => { addToCart(name, 'M', vM); closeSize(); };
        document.getElementById('btn-size-l').onclick = () => { addToCart(name, 'L', vL); closeSize(); }; 
        
        // --- S·ª¨A L·ªñI T·∫†I ƒê√ÇY: X√≥a class hidden ƒë·ªÉ popup hi·ªán l√™n ---
        var modal = document.getElementById('size-modal');
        modal.classList.remove('hidden');      // G·ª° b·ªè l·ªánh ·∫©n
        modal.classList.add('modal-active');   // K√≠ch ho·∫°t flexbox
        // -----------------------------------------------------------
        
    } else if (vM > 0) {
        addToCart(name, 'M', vM); 
    } else if (vL > 0) {
        addToCart(name, 'L', vL); 
    }
}

function closeSize() { 
    // --- S·ª¨A L·ªñI T·∫†I ƒê√ÇY: Th√™m l·∫°i class hidden ƒë·ªÉ ƒë√≥ng ---
    var modal = document.getElementById('size-modal');
    modal.classList.remove('modal-active');
    modal.classList.add('hidden');
    // ------------------------------------------------------
}

function addToCart(name, size, price) {
    const ex = cart.find(i => i.name === name && i.size === size);
    if (ex) ex.qty++; else cart.push({ name, size, price, qty: 1 });
    
    // 1. C·∫≠p nh·∫≠t giao di·ªán (Gi·ªù ƒë√£ an to√†n, kh√¥ng g√¢y crash)
    renderCart();
    
    // 2. B·∫Øt bu·ªôc ƒë√≥ng popup ch·ªçn size ngay l·∫≠p t·ª©c
    closeSize();
    updateCartPadding();
}

/* --- ƒê√É S·ª¨A: renderCart (T·ª± ƒë·ªông ·∫®n/Hi·ªán thanh Bar tr√™n Mobile) --- */
/* --- ƒê√É S·ª¨A: H√†m renderCart (Fix l·ªói Crash do thi·∫øu ID) --- */
function renderCart() {
    const list = document.getElementById('cart-list');
    if (!list) return;

    currentTotal = 0;

    // 1. Render cho Sidebar Desktop (B·∫£n L - Gi·ªØ nguy√™n kh√¥ng ƒë·ª•ng)
    list.innerHTML = cart.map((i, idx) => {
        currentTotal += i.price * i.qty;
        return `<div class="bg-gray-50 p-2.5 rounded-xl flex justify-between items-center shadow-sm border border-white text-xs mb-1">
            <div class="flex-1 pr-2 text-left"><p class="font-black text-[#006241] truncate capitalize-first">${i.name} (${i.size})</p></div>
            <div class="flex items-center gap-1.5 bg-white p-1 rounded-lg border border-gray-100">
                <button onclick="updateQty(${idx}, -1)" class="w-6 h-6 flex items-center justify-center font-black text-gray-300 text-lg ${isPaymentMode ? 'hidden': ''}">-</button>
                <span class="font-black text-[#006241] text-[11px] w-5 text-center">${isPaymentMode?'x': ''}${i.qty}</span>
                <button onclick="updateQty(${idx}, 1)" class="w-6 h-6 flex items-center justify-center font-black text-[#006241] text-lg ${isPaymentMode ? 'hidden' : ''}">+</button>
            </div>
        </div>`;
    }).join('');

    // 2. C·∫≠p nh·∫≠t s·ªë ti·ªÅn hi·ªÉn th·ªã
    document.getElementById('total-price').innerText = currentTotal.toLocaleString() + 'ƒë';
    // === [C·∫¨P NH·∫¨T CHO BOTTOM BAR M·ªöI] ===
    var mobTotal = document.getElementById('mob-bar-total');
    if (mobTotal) {
        mobTotal.innerText = currentTotal.toLocaleString() + 'ƒë';
    }
    const topTotal = document.getElementById('top-total-mobile');
    if(topTotal) topTotal.innerText = currentTotal.toLocaleString() + 'ƒë';

    // 3. LOGIC MOBILE (B·∫£n M): ƒêi·ªÅu khi·ªÉn Bottom Bar
    const isMobile = window.innerWidth <= 768;
    const sidebarCart = document.getElementById('sidebar-cart');
    
    // T√¨m th·∫ª view-menu (Gi·ªù ƒë√£ c√≥ ID nh·ªù B∆∞·ªõc 1)
    const viewMenuEl = document.getElementById('view-menu');

    updateSuggestions();
}

function updateQty(idx, d) { 
    if(isPaymentMode) return; 
    cart[idx].qty += d; 
    if (cart[idx].qty <= 0) cart.splice(idx, 1); 
    renderCart(); 
}

// =========================================================
// 5. THANH TO√ÅN (PAYMENT)
// =========================================================
// --- H√ÄM THANH TO√ÅN (ƒê√É S·ª¨A: RESET S·∫†CH S·∫º TH√îNG TIN KH√ÅCH) ---
// --- H√ÄM THANH TO√ÅN (ƒê√É FIX L·ªñI RESET BI·∫æN TR∆Ø·ªöC KHI ƒê√ìNG BED) ---
function completeOrder() {
    if (cart.length === 0) return showAppModal("Hic!", "Ch∆∞a c√≥ m√≥n n√†o!", 'üõí');
    
    let pVal = document.getElementById('cash-paid').value;
    if (pVal === "" || pVal === "0") pVal = currentTotal;
    const paid = Number(pVal);
    if (paid < currentTotal) return alert("Ti·ªÅn kh√°ch ƒë∆∞a ch∆∞a ƒë·ªß!");

    document.getElementById('loading-overlay').style.display = 'flex';
    
    // === [FIX] B∆Ø·ªöC 1: L∆ØU L·∫†I ID BED C·∫¶N ƒê√ìNG NGAY L·∫¨P T·ª®C ===
    // Ph·∫£i l∆∞u v√†o bi·∫øn c·ª•c b·ªô ngay l√∫c n√†y, v√¨ l√°t n·ªØa pendingBedOrder s·∫Ω b·ªã reset v·ªÅ null
    var bookingKeyToClose = (pendingBedOrder) ? (pendingBedOrder.id || pendingBedOrder.key) : null;
    
    // L·∫•y th√¥ng tin Bed/Kh√°ch ƒë·ªÉ l∆∞u ƒë∆°n h√†ng
    var bedIdToSend = ""; 
    var custNameToSend = "Kh√°ch v√£ng lai";
    if (pendingBedOrder) { 
        bedIdToSend = pendingBedOrder.bedId || "WAITING"; 
        custNameToSend = pendingBedOrder.name; 
    } else if (activeOrderingBedId) { 
        bedIdToSend = activeOrderingBedId; 
    }

    const orderData = {
        sdt: document.getElementById('kh-sdt').value || "Kh√°ch v√£ng lai",
        total: currentTotal, 
        paid: paid, 
        change: Math.max(0, paid - currentTotal),
        method: document.getElementById('btn-bank').classList.contains('border-[#006241]') ? 'Chuy·ªÉn kho·∫£n' : 'Ti·ªÅn m·∫∑t',
        items: cart.map(i => `${i.name}(${i.size})x${i.qty}`).join(', '),
        itemsArray: cart,
        bedId: bedIdToSend, 
        customerName: custNameToSend,
        createdAt: new Date().toISOString(),
        status: "pending_sync"
    };

    // ƒê·∫©y ƒë∆°n h√†ng l√™n Firebase
    db.ref('orders').push(orderData, (error) => {
        document.getElementById('loading-overlay').style.display = 'none';
        
        if(error) alert("L·ªói Firebase: " + error.message);
        else {
            // === D·ªåN D·∫∏P GIAO DI·ªÜN ===
            document.getElementById('kh-sdt').value = ""; 
            document.getElementById('sdt-status').innerText = "";
            var cartInfo = document.getElementById('cart-bed-info');
            if (cartInfo) cartInfo.remove();

            // X√≥a gi·ªè h√†ng (ƒê√∫ng, v√¨ ƒë√£ thanh to√°n r·ªìi)
            cart = [];
            renderCart();

            // === [QUAN TR·ªåNG] LOGIC RESET BI·∫æN TH√îNG MINH ===
            // N·∫øu ƒë√¢y l√† ƒë∆°n "WAITING" (Ch·ªù x·∫øp bed), ta TUY·ªÜT ƒê·ªêI KH√îNG ƒê∆Ø·ª¢C RESET pendingBedOrder
            // V√¨ l√°t n·ªØa ch·ªçn Bed xong, h√†m finalizeBedCheckIn c·∫ßn d√πng bi·∫øn n√†y ƒë·ªÉ bi·∫øt update cho ai.
            
            if (bedIdToSend !== "WAITING") {
                // Ch·ªâ reset khi ƒë∆°n ƒë√£ xong h·∫≥n (Mang v·ªÅ, ho·∫∑c Order th√™m cho Bed ƒë√£ c√≥ s·ªë)
                pendingBedOrder = null;
                activeOrderingBedId = null;
            }

            // === ƒêI·ªÄU H∆Ø·ªöNG TI·∫æP THEO ===

            // 1. Tr∆∞·ªùng h·ª£p Tr·∫£ Bed (Checkout) -> ƒê√≥ng Bed ngay
            if (isCheckoutFlow && bookingKeyToClose) {
                console.log("ƒêang ƒë√≥ng Bed ID:", bookingKeyToClose);
                db.ref('bedBookings/' + bookingKeyToClose).update({
                    status: 'ƒë√£ xong',
                    realEndTime: new Date().toLocaleTimeString('en-GB')
                });
                isCheckoutFlow = false;
                pendingBedOrder = null; // Xong r·ªìi th√¨ reset ƒë∆∞·ª£c
                openBedManager();
                setTimeout(() => { showAppModal("Ho√†n t·∫•t!", "ƒê√£ thanh to√°n v√† TR·∫¢ BED th√†nh c√¥ng!", 'üèÅ'); }, 150);
            } 
            // 2. Tr∆∞·ªùng h·ª£p Kh√°ch m·ªõi (WAITING) -> M·ªü Modal ch·ªçn Bed
            else if (bedIdToSend == "WAITING") {
                 // Kh√¥ng reset pendingBedOrder ·ªü ƒë√¢y, ƒë·ªÉ d√†nh cho b∆∞·ªõc ch·ªçn Bed
                 renderBedSelection();
                 document.getElementById('bed-select-modal').classList.remove('hidden');
            } 
            // 3. Tr∆∞·ªùng h·ª£p Order th√™m / Mang v·ªÅ -> Xong phim
            else {
                switchView('menu');
                setTimeout(() => { showAppModal("Xong!", "Thanh to√°n th√†nh c√¥ng!", '‚úÖ'); }, 150);
            }
        }
    });
}

// C√°c h√†m b·ªï tr·ª£ thanh to√°n
// --- H√ÄM CH·ªåN PH∆Ø∆†NG TH·ª®C THANH TO√ÅN (ƒê√É FIX: L√ÄM M·ªú √î TI·ªÄN M·∫∂T KHI CK) ---
function setMethod(m) {
    const isBank = (m === 'Chuy·ªÉn kho·∫£n');
    
    // 1. C·∫≠p nh·∫≠t giao di·ªán n√∫t b·∫•m
    // N·∫øu l√† Bank: N√∫t Bank s√°ng, N√∫t Cash x√°m
    // N·∫øu l√† Cash: N√∫t Cash s√°ng, N√∫t Bank x√°m
    
    // Class cho n√∫t ƒëang Active (C√≥ vi·ªÅn xanh/ƒëen t√πy theme)
    const activeClass = "w-full p-6 rounded-3xl border-4 bg-white text-xl font-bold flex justify-between items-center shadow-md border-[#006241] text-[#006241] sb-green";
    
    // Class cho n√∫t Inactive (M·ªù, kh√¥ng vi·ªÅn)
    const inactiveClass = "w-full p-6 rounded-3xl border-4 border-transparent bg-white text-xl font-bold text-gray-300 flex justify-between items-center shadow-md";

    // C·∫≠p nh·∫≠t class cho 2 n√∫t
    document.getElementById('btn-cash').className = isBank ? inactiveClass : activeClass;
    document.getElementById('btn-bank').className = isBank ? activeClass : inactiveClass;

    // 2. X·ª¨ L√ù √î NH·∫¨P TI·ªÄN "KH√ÅCH ƒê∆ØA"
    const box = document.getElementById('cash-detail-box');
    const input = document.getElementById('cash-paid');

    // Lu√¥n reset gi√° tr·ªã v·ªÅ t·ªïng bill tr∆∞·ªõc ƒë√£
    input.value = currentTotal;

    if (isBank) {
        // --- CH·∫æ ƒê·ªò CHUY·ªÇN KHO·∫¢N ---
        // G·ªçi h√†m hi·ªÉn th·ªã QR
        showPaymentQR(); 
        
        // V√¥ hi·ªáu h√≥a √¥ nh·∫≠p ti·ªÅn
        box.style.pointerEvents = "none";
        box.style.opacity = "0.4";
        box.style.filter = "grayscale(100%)";
    } else {
        // --- CH·∫æ ƒê·ªò TI·ªÄN M·∫∂T ---
        box.style.pointerEvents = "auto";
        box.style.opacity = "1";
        box.style.filter = "none";
        
        // ·∫®n Popup QR n·∫øu ƒëang m·ªü (tr∆∞·ªùng h·ª£p kh√°ch ƒë·ªïi √Ω)
        document.getElementById('qr-modal')?.classList.add('hidden');
    }
    calcChange();
}
// --- H√ÄM T·∫†O G·ª¢I √ù TI·ªÄN (CH·∫†Y C·∫¢ 2 GIAO DI·ªÜN) ---
// --- H√ÄM T·∫†O G·ª¢I √ù TI·ªÄN (CH·∫†Y C·∫¢ PC & MOBILE) ---
// --- H√ÄM V·∫º G·ª¢I √ù (STYLE N√öT TO - CHIA 2 C·ªòT) ---
function updateSuggestions() {
    const vals = [50000, 100000, 200000, 500000].filter(v => v >= currentTotal).slice(0, 4);
    if (currentTotal > 0 && !vals.includes(currentTotal)) vals.unshift(currentTotal);

    // PC (Gi·ªØ nguy√™n)
    const pcContainer = document.getElementById('cash-suggestions');
    if (pcContainer) {
        pcContainer.innerHTML = vals.map(v => `<button onclick="quickPaid(${v})" class="bg-white border-2 border-gray-100 px-3 py-1.5 rounded-xl text-[10px] font-bold text-gray-400 hover:border-[#006241] hover:text-[#006241] transition-all">${v.toLocaleString()}</button>`).join('');
    }

    // MOBILE (N√∫t to b√©o - Chia l∆∞·ªõi)
    const mobContainer = document.getElementById('cash-suggestions-mobile');
    if (mobContainer) {
        mobContainer.innerHTML = vals.map(v => 
            // D√πng w-full ƒë·ªÉ n√≥ gi√£n h·∫øt √¥ l∆∞·ªõi, py-4 ƒë·ªÉ n√∫t cao l√™n d·ªÖ b·∫•m
            `<button onclick="quickPaidMobile(${v})" 
                class="w-full py-4 bg-white text-[#006241] rounded-2xl text-lg font-black shadow-sm border border-gray-100 active:bg-[#006241] active:text-white active:scale-95 transition-all">
                ${(v/1000).toLocaleString()}k
            </button>`
        ).join('');
    }
}

// --- H√ÄM H·ªñ TR·ª¢ B·∫§M TR√äN MOBILE ---
function quickPaidMobile(v) {
    // 1. ƒêi·ªÅn ti·ªÅn v√†o √¥ Mobile
    let input = document.getElementById('cash-paid-mobile');
    if(input) {
        input.value = v.toLocaleString('en-US'); // Th√™m d·∫•u ph·∫©y
        
        // 2. K√≠ch ho·∫°t t√≠nh ti·ªÅn th·ª´a ngay l·∫≠p t·ª©c
        syncMobileInputs(); 
        
        // 3. (Tu·ª≥ ch·ªçn) Rung nh·∫π ƒëi·ªán tho·∫°i ƒë·ªÉ b√°o ƒë√£ nh·∫≠n
        if(navigator.vibrate) navigator.vibrate(50);
    }
}
// H√†m ki·ªÉm tra v√† c·∫≠p nh·∫≠t class cart-empty
function updateCartPadding() {
    // Kh√¥ng l√†m g√¨ c·∫£. Logic c≈© ƒë√£ b·ªã lo·∫°i b·ªè.
    return; 
}
// H√†m h·ªó tr·ª£ b·∫•m n√∫t tr√™n Mobile
function quickPaidMobile(v) {
    // ƒêi·ªÅn ti·ªÅn v√†o √¥ Mobile
    let input = document.getElementById('cash-paid-mobile');
    if(input) {
        input.value = v.toLocaleString('en-US'); // Th√™m d·∫•u ph·∫©y cho ƒë·∫πp
        syncMobileInputs(); // K√≠ch ho·∫°t t√≠nh ti·ªÅn th·ª´a
    }
}
function quickPaid(v) { document.getElementById('cash-paid').value = v; calcChange(); }
function calcChange() { const paid = Number(document.getElementById('cash-paid').value) || currentTotal; document.getElementById('cash-change').innerText = (paid - currentTotal > 0 ? (paid - currentTotal).toLocaleString(): 0) + 'ƒë'; }
function clearFullOrder() { if(pendingBedOrder) return alert("ƒêang trong quy tr√¨nh thanh to√°n Bed!"); cart = []; renderCart();updateCartPadding(); }

// =========================================================
// 6. L·ªäCH S·ª¨ & DOANH THU (ƒê√É S·ª¨A L·ªñI HI·ªÇN TH·ªä)
// =========================================================
function openHistory() {
    document.getElementById('loading-overlay').style.display = 'flex';
    switchView('history');
    
    // T√¨m c·∫£ 'orders' v√† 'order' ƒë·ªÅ ph√≤ng b·∫°n l∆∞u nh·∫ßm t√™n
    db.ref('orders').limitToLast(100).once('value', snap => {
        if(!snap.exists()) {
             // Th·ª≠ t√¨m nh√°nh 'order' n·∫øu 'orders' kh√¥ng c√≥
             db.ref('order').limitToLast(100).once('value', snap2 => {
                 processHistoryData(snap2.val());
             });
        } else {
             processHistoryData(snap.val());
        }
    });
}

function processHistoryData(data) {
    document.getElementById('loading-overlay').style.display = 'none';
    if(!data) {
        historyData = [];
        document.getElementById('history-container').innerHTML = "<div class='text-center text-gray-400 mt-10'>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</div>";
    } else {
        // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu
        historyData = Object.keys(data).map(key => {
            const o = data[key];
            const d = new Date(o.createdAt || Date.now());
            return {
                ...o,
                id: key,
                dateStr: d.toLocaleDateString('en-GB'),
                timeStr: d.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}),
                fullTime: d.toLocaleString('en-GB'),
                points: o.points || Math.floor((Number(o.total)||0)/100)
            };
        }).reverse();
        renderHistoryList(historyData);
    }
}

function renderHistoryList(data) { 
    if(!data || data.length === 0) return;
    const grouped = data.reduce((acc, obj) => { 
        const key = obj.dateStr; if (!acc[key]) acc[key] = []; acc [key].push(obj); return acc; 
    }, {}); 
    
    let html = ""; 
    Object.keys(grouped).sort((a,b) => {
         const da = a.split('/').reverse().join(''); const db = b.split('/').reverse().join(''); return db.localeCompare(da);
    }).forEach(date => { 
        html += `<div class="mb-4 text-left"><h3 class="brand-font text-[#006241] text-[10px] uppercase tracking-widest mb-2 ml-1 text-left">üìÖ Ng√†y ${date}</h3><div class="space-y-1.5 text-left">`; 
        grouped[date].forEach((h) => { 
            const realIdx = historyData.findIndex(item => item.id === h.id);
            const valColor = h.total < 0? 'text-red-500': 'text-[#006241]'; 
            html += `<div id="h-item-${realIdx}" onclick="selectBill(${realIdx})" class="p-3 bg-white rounded-2xl border-2 border-transparent shadow-sm flex justify-between items-center cursor-pointer active:scale-95 text-xs text-left">
                <div class="min-w-0 text-left">
                    <p class="font-black text-[#006241] uppercase text-left">${h.timeStr}</p>
                    <p class="text-[8px] text-gray-400 font-bold truncate w-20 text-left">${h.sdt}</p>
                </div>
                <p class="font-black ${valColor} text-right">${Number(h.total).toLocaleString()}</p>
            </div>`; 
        }); 
        html += '</div></div>'; 
    });
    document.getElementById('history-container').innerHTML = html; 
}
// --- H√ÄM SELECT BILL ƒê√É FIX (C√ì N√öT H·ª¶Y/HO√ÄN) ---
// --- COPY T·ª™ ƒê√ÇY ---
function selectBill(idx) {
    // 1. Reset highlight c≈©
    selectedRefundItems = [];
    document.querySelectorAll('[id^="h-item-"]').forEach(el => el.classList.remove('history-item-active'));
    
    // Highlight d√≤ng ƒë∆∞·ª£c ch·ªçn
    var rowEl = document.getElementById(`h-item-${idx}`);
    if (rowEl) rowEl.classList.add('history-item-active');

    // 2. L·∫•y d·ªØ li·ªáu ƒë∆°n h√†ng
    const h = historyData[idx];
    if (!h) return;

    const items = h.items.split(',');
    let tQty = 0;
    
    // Ki·ªÉm tra xem ƒë∆°n ƒë√£ ho√†n ch∆∞a (Ti·ªÅn √¢m = ƒë√£ ho√†n)
    const isAlreadyRefund = h.total < 0;

    // 3. X·ª≠ l√Ω danh s√°ch m√≥n ƒÉn
    // --- ƒê√ÇY L√Ä D√íNG B·∫†N ƒêANG B·ªä THI·∫æU ---
    const itemsHtml = items.map((item, i) => { 
    // -------------------------------------
        const raw = item.trim();
        const lastX = raw.lastIndexOf('x');
        if (lastX === -1) return '';

        const namePartFull = raw.substring(0, lastX).trim();
        const qty = parseInt(raw.substring(lastX + 1)) || 1;
        tQty += qty;

        let nameOnly = namePartFull, sizePart = "";
        if (namePartFull.includes('(')) {
            const lb = namePartFull.lastIndexOf('(');
            nameOnly = namePartFull.substring(0, lb).trim();
            sizePart = namePartFull.substring(lb + 1, namePartFull.lastIndexOf(')'));
        }

        const m = menu.find(mi => mi.name.toLowerCase() === nameOnly.toLowerCase());
        const uP = m ? (sizePart === 'L' ? m.priceL : m.priceM) : 0;
        const subTotal = uP * qty;
        
        // T√≠nh ƒëi·ªÉm
        const pts = (m && m.type === 'ƒÉn v·∫∑t') ? Math.floor((subTotal/100)*0.4) : Math.floor(subTotal/100);
        
        const itData = JSON.stringify({ name: nameOnly, size: sizePart, qty, subTotal, itemPoints: pts });

        // Render d√≤ng s·∫£n ph·∫©m
        return `<div id="refund-row-${i}" onclick='${isAlreadyRefund ? "" : `toggleRefundItem(${i}, ${itData})`}' class="receipt-line p-2 rounded-xl transition-all border-l-4 border-transparent ${isAlreadyRefund ? "opacity-50 text-left" : "cursor-pointer hover:bg-gray-50 text-left"}">
            <div class="flex-1 mr-4 text-left">
                <div class="flex items-start gap-2 text-left">
                    <span class="font-black text-[#006241] text-lg text-left">${qty}x</span>
                    <div class="flex flex-col text-left">
                        <span class="font-black text-[#006241] text-sm capitalize-first leading-tight text-left">${nameOnly} ${sizePart ? `<span class="text-green-500 font-black text-[12px] ml-1">[${sizePart}]</span>` : ""}</span>
                        <span class="text-[9px] text-gray-400 font-bold italic text-left">ƒê∆°n gi√°: ${uP.toLocaleString()}</span>
                    </div>
                </div>
            </div>
            <div class="text-right font-black text-[#006241] text-base pt-1 text-right">${subTotal.toLocaleString()}</div>
        </div>`;
    }).join(''); // <--- D·∫•u } n√†y b√¢y gi·ªù s·∫Ω kh·ªõp v·ªõi d·∫•u { ·ªü d√≤ng items.map b√™n tr√™n

    // 4. Hi·ªÉn th·ªã Panel Chi ti·∫øt
    document.getElementById('history-detail-empty').classList.add('hidden');
    const detail = document.getElementById('history-detail-content');
    detail.classList.remove('hidden');

    // 5. V·∫º GIAO DI·ªÜN CHI TI·∫æT
    detail.innerHTML = `
    <div class="grid grid-cols-12 gap-3 h-full overflow-hidden text-left relative">
        
        <button onclick="switchView('menu')" class="absolute top-0 right-0 z-50 w-8 h-8 bg-gray-100 hover:bg-gray-200 text-gray-500 rounded-full flex items-center justify-center font-bold shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
        <div class="col-span-4 border-r border-gray-100 pr-3 flex flex-col pt-2 text-left">
            <h3 class="brand-font text-3xl text-[#006241] leading-none mb-1 text-left">The cafe 33</h3>
            <p class="text-[8px] text-gray-400 font-bold uppercase mb-4 tracking-widest text-left">H√≥a ƒë∆°n ƒëi·ªán t·ª≠</p>

            <div class="space-y-2 text-left">
                <div class="p-2 bg-gray-50 rounded-xl text-left"><p class="text-[8px] text-gray-400 font-bold uppercase mb-0.5 text-left">Th·ªùi gian</p><p class="font-black text-[#006241] text-[10px] leading-tight text-left">${h.fullTime}</p></div>
                <div class="p-2 bg-gray-50 rounded-xl text-left"><p class="text-[8px] text-gray-400 font-bold uppercase mb-0.5 text-left">Kh√°ch h√†ng</p><p class="font-black text-[#006241] text-[10px] leading-tight text-left">${h.sdt}</p></div>
                <div class="p-2 bg-gray-50 rounded-xl border-l-4 ${h.total < 0 ? 'border-red-500 text-left' : 'border-[#006241] text-left'} text-left"><p class="text-[8px] text-gray-400 font-bold uppercase mb-0.5 text-left">Thanh to√°n</p><p class="font-black ${h.total < 0 ? 'text-red-500 text-left' : 'text-[#006241] text-left'} text-[10px] uppercase text-left">${h.method}</p></div>
            </div>

            ${isAlreadyRefund ?
                '<div class="mt-10 text-center"><p class="text-[10px] font-black text-red-400 uppercase italic text-center">H√≥a ƒë∆°n ho√†n tr·∫£</p></div>' :
                `<div class="mt-4 space-y-2 text-center">
                    <button onclick="executeRefundAction(${idx}, true)" class="w-full py-3 bg-red-500 text-white rounded-xl font-black text-[10px] uppercase shadow-lg active:scale-95 transition-all text-center">H·ªßy to√†n b·ªô</button>
                    <button id="btn-refund-selected" onclick="executeRefundAction(${idx}, false)" class="hidden w-full py-3 border-2 border-red-500 text-red-500 rounded-xl font-black text-[10px] uppercase active:scale-95 transition-all text-center">Ho√†n m√≥n ƒë√£ ch·ªçn</button>
                </div>`
            }

            ${h.sdt === "Kh√°ch v√£ng lai" ? "" : 
`<div class="mt-auto mb-2 text-center text-center"><p class="text-amber-600 font-black text-[9px] uppercase italic tracking-tighter text-center"> +${h.points} ƒêI·ªÇM</p></div>`
}
        </div>

        <div class="col-span-8 flex flex-col h-full pt-2 overflow-hidden text-left">
            <div id="refund-items-list" class="flex-1 overflow-y-auto pr-1 space-y-0.5 text-left">${itemsHtml}</div>
            <div class="mt-4 pt-4 border-t-2 border-[#006241] flex flex-col items-end flex-shrink-0 text-right">
                <div class="flex justify-between w-full items-center mb-1 text-left"><span class="text-[10px] font-bold text-gray-400 uppercase italic text-left">S·ªë l∆∞·ª£ng: ${tQty} m√≥n</span><span class="brand-font text-[#006241] text-xl uppercase font-black opacity-30 text-right">T·ªïng bill</span></div>
                <div class="font-black text-3xl leading-none text-right ${h.total < 0 ? 'text-red-500 text-right' : 'text-[#006241] text-right'}">${h.total.toLocaleString()}<span class="text-lg ml-1 text-right">ƒë</span></div>
            </div>
        </div>
    </div>`;
}
// --- ƒê·∫æN ƒê√ÇY ---

// --- H√ÄM M·ªû TAB DOANH THU (PHI√äN B·∫¢N AN TO√ÄN) ---
// --- H√ÄM M·ªû TAB DOANH THU (KH√îNG NH√ÅY M√ÄN H√åNH TR·∫ÆNG) ---
function openRevenue(mode) {
    if (!mode) mode = 'week';

    // 1. KI·ªÇM TRA XEM ƒêANG ·ªû ƒê√ÇU
    // N·∫øu tab view-history ƒëang hi·ªán V√Ä n√∫t revenue ƒëang active -> T·ª©c l√† ƒëang chuy·ªÉn ch·∫ø ƒë·ªô
    var isSwitchingMode = !document.getElementById('view-history').classList.contains('hidden') && 
                          document.getElementById('btn-nav-revenue').classList.contains('tab-active');

    if (isSwitchingMode) {
        // --- CH·∫æ ƒê·ªò CHUY·ªÇN TAB (KH√îNG NH√ÅY) ---
        // Hi·ªán v√≤ng xoay nh·ªè
        var miniLoader = document.getElementById('mini-loader');
        if (miniLoader) miniLoader.classList.remove('hidden');
        
        // L√†m m·ªù nh·∫π n·ªôi dung ƒë·ªÉ bi·∫øt ƒëang load
        var content = document.getElementById('history-detail-content');
        if (content) {
            content.style.opacity = "0.6";
            content.style.pointerEvents = "none"; // Ch·∫∑n b·∫•m lung tung khi ƒëang load
        }
    } else {
        // --- CH·∫æ ƒê·ªò M·ªû L·∫¶N ƒê·∫¶U (HI·ªÜN LOADING TO) ---
        document.getElementById('loading-overlay').style.display = 'flex';
        switchView('revenue');
    }

    // L·∫•y ng√†y custom
    var startEl = document.getElementById('rev-start');
    var endEl = document.getElementById('rev-end');
    var startVal = startEl ? startEl.value : null;
    var endVal = endEl ? endEl.value : null;

    Promise.all([
        db.ref('orders').once('value'),
        db.ref('order').once('value')
    ]).then(function(snapshots) {
        
        // T·∫Øt Loading to (n·∫øu c√≥)
        document.getElementById('loading-overlay').style.display = 'none';
        
        try {
            var allOrders = [];
            snapshots.forEach(function(snap) {
                if(snap.exists()) {
                    var val = snap.val();
                    if (val) {
                        Object.keys(val).forEach(function(k) {
                            allOrders.push(val[k]);
                        });
                    }
                }
            });

            var stats = calculateStats(allOrders, mode, startVal, endVal);
            
            if (stats) {
                renderDailyRevenueList(stats.dailyList);
                renderRevenueDashboard(stats, mode); // H√†m n√†y s·∫Ω t·ª± t·∫Øt mini-loader v√† b·ªè l√†m m·ªù
            }
        } catch (e) {
            alert("L·ªói: " + e.message);
            // N·∫øu l·ªói c≈©ng ph·∫£i nh·ªõ t·∫Øt hi·ªáu ·ª©ng l√†m m·ªù
            var content = document.getElementById('history-detail-content');
            if (content) { content.style.opacity = "1"; content.style.pointerEvents = "auto"; }
        }
    });
}
// --- H√ÄM T√çNH TO√ÅN (PHI√äN B·∫¢N FIX L·ªñI CRASH) ---
function calculateStats(orders, mode, customStart, customEnd) {
    var now = new Date();
    var startTime, endTime;
    var labels = [];
    var chartData = [];
    var groupType = 'day'; 

    // 1. THI·∫æT L·∫¨P TH·ªúI GIAN
    if (mode === 'week') {
        var day = now.getDay() || 7; 
        startTime = new Date(now); startTime.setDate(now.getDate() - day + 1); startTime.setHours(0,0,0,0);
        endTime = new Date(startTime); endTime.setDate(startTime.getDate() + 6); endTime.setHours(23,59,59,999);
        labels = ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'];
        chartData = [0,0,0,0,0,0,0];
    } 
    else if (mode === 'month') {
        startTime = new Date(now.getFullYear(), now.getMonth(), 1);
        endTime = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
        
        // T·∫°o nh√£n ng√†y 1 -> 31 b·∫±ng v√≤ng l·∫∑p th·ªß c√¥ng (An to√†n h∆°n Array.from)
        var daysInMonth = endTime.getDate();
        for (var i = 1; i <= daysInMonth; i++) {
            labels.push(i.toString());
            chartData.push(0);
        }
    } 
    else if (mode === 'year') {
        startTime = new Date(now.getFullYear(), 0, 1);
        endTime = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
        labels = ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'];
        chartData = [0,0,0,0,0,0,0,0,0,0,0,0];
        groupType = 'month';
    } 
    else if (mode === 'custom') {
        if (!customStart || !customEnd) return null;
        startTime = new Date(customStart); startTime.setHours(0,0,0,0);
        endTime = new Date(customEnd); endTime.setHours(23,59,59,999);
        
        var diffTime = Math.abs(endTime - startTime);
        var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        
        if (diffDays > 31) {
            groupType = 'month';
            labels = ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12']; 
            chartData = [0,0,0,0,0,0,0,0,0,0,0,0];
        } else {
            for (var j = 0; j <= diffDays; j++) {
                var dTemp = new Date(startTime); dTemp.setDate(dTemp.getDate() + j);
                labels.push(dTemp.getDate() + "/" + (dTemp.getMonth()+1));
                chartData.push(0);
            }
        }
    }

    var stats = { drinkTotal: 0, snackTotal: 0, labels: labels, chartData: chartData, dailyList: {}, today: 0, yesterday: 0 };
    
    var todayStr = now.toLocaleDateString('en-GB');
    var yest = new Date(now); yest.setDate(now.getDate() - 1); 
    var yestStr = yest.toLocaleDateString('en-GB');

    // 2. DUY·ªÜT ƒê∆†N H√ÄNG
    orders.forEach(function(o) {
        var d = new Date(o.createdAt || Date.now());
        var dateKey = d.toLocaleDateString('en-GB');
        var amount = Number(o.total) || 0;
        if (amount <= 0) return;

        if (dateKey === todayStr) stats.today += amount;
        if (dateKey === yestStr) stats.yesterday += amount;

        if (d >= startTime && d <= endTime) {
            var itemsStr = String(o.items || "").toLowerCase();
            var isSnack = (itemsStr.indexOf('h·∫°t') > -1 || itemsStr.indexOf('b√°nh') > -1 || itemsStr.indexOf('snack') > -1);
            
            if(isSnack) stats.snackTotal += amount; 
            else stats.drinkTotal += amount;
            
            if (!stats.dailyList[dateKey]) stats.dailyList[dateKey] = { drink: 0 };
            stats.dailyList[dateKey].drink += amount;

            // C·ªông d·ªìn v√†o bi·ªÉu ƒë·ªì
            var idx = -1;
            if (groupType === 'month') {
                idx = d.getMonth();
            } else if (mode === 'month') {
                idx = d.getDate() - 1;
            } else if (mode === 'week') {
                idx = (d.getDay() + 6) % 7;
            } else if (mode === 'custom' && labels.length <= 31) {
                // Logic ƒë∆°n gi·∫£n cho custom ng·∫Øn ng√†y
                var timeDiff = d.getTime() - startTime.getTime();
                var dayDiff = Math.floor(timeDiff / (1000 * 3600 * 24));
                idx = dayDiff;
            }

            if (idx >= 0 && idx < chartData.length) {
                chartData[idx] += amount;
            }
        }
    });
    return stats;
}

function renderDailyRevenueList(list) { 
    let html = '<div class="mb-4 text-left"><h3 class="brand-font text-[#006241] text-[10px] uppercase tracking-widest mb-2 ml-1 text-left">Doanh thu</h3><div class="space-y-1.5 text-left">'; 
    Object.keys(list).sort((a,b) => { const da = a.split('/').reverse().join(''); const db = b.split('/').reverse().join(''); return db.localeCompare(da); }).forEach(date => { 
        html += `<div class="p-3 bg-white rounded-2xl shadow-sm text-left"><p class="font-black text-[#006241] text-[10px] uppercase text-left">üìÖ ${date}</p><p class="text-[11px] font-black text-[#006241] mt-1 text-left">${list[date].drink.toLocaleString()}ƒë</p></div>`; 
    }); 
    html += '</div></div>'; 
    document.getElementById('history-container').innerHTML = html; 
}

// --- H√ÄM V·∫º DASHBOARD DOANH THU (STYLE APPLE: S√ÅNG, S·∫†CH, XANH TH∆Ø∆†NG HI·ªÜU) ---
// --- H√ÄM V·∫º DASHBOARD (C√ì TH√äM V√íNG XOAY LOADING NH·ªé) ---
// --- H√ÄM V·∫º DASHBOARD (N√öT X N·∫∞M CHUNG THANH C√îNG C·ª§ - SI√äU G·ªåN) ---
// --- H√ÄM V·∫º DASHBOARD (STYLE "FLOATING PILLS" - SI√äU SANG & BO TR√íN) ---
// --- H√ÄM V·∫º DASHBOARD (STYLE VI√äN THU·ªêC - 1 H√ÄNG NGANG TI·∫æT KI·ªÜM KH√îNG GIAN) ---
function renderRevenueDashboard(data, mode) {
    document.getElementById('history-detail-empty').classList.add('hidden');
    const detail = document.getElementById('history-detail-content');
    detail.classList.remove('hidden');
    
    // Reset hi·ªáu ·ª©ng load
    detail.style.opacity = "1";
    detail.style.pointerEvents = "auto";

    const diff = data.today - data.yesterday;
    const dColor = diff >= 0 ? 'text-green-500': 'text-red-500';
    const dIcon = diff >= 0 ? '‚ñ≤': '‚ñº';

    // Style n√∫t b·∫•m (Bo tr√≤n vi√™n thu·ªëc)
    const activeBtn = "bg-[#006241] text-white shadow-md font-bold rounded-full transform scale-105";
    const inactiveBtn = "bg-transparent text-gray-500 hover:bg-gray-100 font-medium rounded-full";

    detail.innerHTML = `
    <div class="flex flex-col h-full space-y-4 text-left pt-2 px-1">
        
        <div class="flex flex-row items-center justify-between gap-2 z-10 relative">
            
            <div class="flex bg-white p-1 rounded-full shadow-[0_2px_10px_rgba(0,0,0,0.05)] border border-gray-100 shrink-0">
                <button onclick="openRevenue('week')" class="px-5 py-2 text-[10px] uppercase transition-all duration-300 ${mode==='week'?activeBtn:inactiveBtn}">Tu·∫ßn</button>
                <button onclick="openRevenue('month')" class="px-5 py-2 text-[10px] uppercase transition-all duration-300 ${mode==='month'?activeBtn:inactiveBtn}">Th√°ng</button>
                <button onclick="openRevenue('year')" class="px-5 py-2 text-[10px] uppercase transition-all duration-300 ${mode==='year'?activeBtn:inactiveBtn}">NƒÉm</button>
            </div>
            
            <div class="flex items-center gap-2 bg-white p-1 pl-3 rounded-full shadow-[0_2px_10px_rgba(0,0,0,0.05)] border border-gray-100 shrink-0">
                
                <div id="mini-loader" class="hidden animate-spin rounded-full h-3 w-3 border-[2px] border-t-[#006241] border-gray-100 mr-1"></div>

                <div class="flex items-center gap-1 border-r border-gray-100 pr-2 mr-1">
                    <input type="date" id="rev-start" class="text-[10px] font-bold text-[#006241] outline-none bg-transparent w-[70px] uppercase cursor-pointer">
                    <span class="text-gray-300 font-light">-</span>
                    <input type="date" id="rev-end" class="text-[10px] font-bold text-[#006241] outline-none bg-transparent w-[70px] uppercase cursor-pointer">
                </div>

                <button onclick="openRevenue('custom')" class="w-8 h-8 bg-[#006241] text-white rounded-full flex items-center justify-center shadow-md hover:scale-105 active:scale-95 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </button>

                <button onclick="switchView('menu')" class="w-8 h-8 bg-gray-100 hover:bg-red-50 text-gray-500 hover:text-red-500 rounded-full flex items-center justify-center transition-all hover:scale-105 active:scale-95 ml-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-3 text-left z-0 relative">
            <div class="p-4 bg-white rounded-[24px] border border-gray-50 shadow-[0_4px_15px_rgba(0,0,0,0.02)] flex flex-col items-center justify-center">
                <p class="text-[8px] font-bold text-gray-400 uppercase tracking-widest mb-1">T·ªïng thu</p>
                <p class="brand-font text-xl text-[#006241]">${(data.drinkTotal + data.snackTotal).toLocaleString()}</p>
            </div>
            <div class="p-4 bg-white rounded-[24px] border border-gray-50 shadow-[0_4px_15px_rgba(0,0,0,0.02)] flex flex-col items-center justify-center">
                <p class="text-[8px] font-bold text-gray-400 uppercase tracking-widest mb-1">ƒÇn v·∫∑t</p>
                <p class="brand-font text-xl text-amber-500">${data.snackTotal.toLocaleString()}</p>
            </div>
            <div class="p-4 bg-white rounded-[24px] border border-gray-50 shadow-[0_4px_15px_rgba(0,0,0,0.02)] flex flex-col items-center justify-center">
                <p class="text-[8px] font-bold text-gray-400 uppercase tracking-widest mb-1">So h√¥m qua</p>
                <div class="flex items-center gap-1 bg-gray-50 px-2 py-0.5 rounded-full mt-1">
                    <span class="text-[10px] ${dColor}">${dIcon}</span>
                    <span class="font-black text-xs ${dColor}">${Math.abs(diff).toLocaleString()}</span>
                </div>
            </div>
        </div>

        <div class="flex-1 bg-white p-5 rounded-[2.5rem] border border-gray-50 shadow-sm flex flex-col relative overflow-hidden z-0">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>`;

    setTimeout(() => {
        renderChart(data.labels, data.chartData, mode);
    }, 200);
}
function renderChart(labels, chartData, type) { 
    const ctx = document.getElementById('revenueChart').getContext('2d'); 
    if (myChart) myChart.destroy(); 
    myChart = new Chart(ctx, { 
        type: 'bar', plugins: [ChartDataLabels], 
        data: { labels, datasets: [{ data: chartData, backgroundColor: '#006241', borderRadius: 6 }] }, 
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top', formatter: (v) => v != 0 ? (v/1000).toFixed(0) + 'k': '', font: { weight: 'bold', size: 9 }, color: '#006241'} }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { weight: 'bold', size: 8} } } } } 
    }); 
}

// =========================================================
// 7. C√ÅC H√ÄM KH√ÅC (NAV, SWITCH VIEW...)
// =========================================================
// --- H√ÄM CHUY·ªÇN VIEW (C·∫¨P NH·∫¨T LOGIC LUXURY THEME) ---
// --- H√ÄM CHUY·ªÇN VIEW (ƒê√É FIX: ·∫®N N√öT 'THANH TO√ÅN' ·ªû SIDEBAR KHI ƒêANG THANH TO√ÅN) ---
/* --- ƒê√É S·ª¨A: H√†m switchView Logic ch·∫∑t ch·∫Ω --- */
/* --- ƒê√É S·ª¨A: H√†m switchView (Logic ·∫©n/hi·ªán chu·∫©n x√°c cho Mobile) --- */
/* --- ƒê√É S·ª¨A: switchView (Ch·∫∑n thanh Bar ƒëi lung tung) --- */
// --- H√ÄM CHUY·ªÇN VIEW (ƒê√É FIX L·ªñI CRASH NULL PROPERTY) ---
// --- H√ÄM CHUY·ªÇN VIEW (ƒê√É FIX TO√ÄN DI·ªÜN L·ªñI NULL) ---
function switchView(v) {
    isPaymentMode = (v === 'payment');

    // 1. ·∫®n t·∫•t c·∫£ view c≈© & Reset tr·∫°ng th√°i n√∫t Nav
    ['menu', 'payment', 'history', 'bed', 'revenue'].forEach(id => {
        // ·∫®n view t∆∞∆°ng ·ª©ng
        var viewEl = document.getElementById('view-' + id);
        if (viewEl) viewEl.classList.add('hidden');

        // Reset style c·ªßa n√∫t Nav (n·∫øu n√∫t ƒë√≥ t·ªìn t·∫°i)
        var btn = document.getElementById('btn-nav-' + id);
        if (btn) {
            btn.classList.remove('tab-active');
            // Tr·∫£ v·ªÅ style m·∫∑c ƒë·ªãnh (x√°m)
            btn.className = 'bg-gray-100 text-gray-400 px-5 py-2.5 rounded-xl text-[10px] font-black uppercase active:scale-95 transition-all';
        }
    });

    // 2. Active n√∫t Nav t∆∞∆°ng ·ª©ng & Hi·ªán View m·ªõi
    // Style cho n√∫t ƒëang ƒë∆∞·ª£c ch·ªçn (xanh, ch·ªØ tr·∫Øng)
    let activeBtnClass = 'sb-green text-white px-5 py-2.5 rounded-xl text-[10px] font-black uppercase tab-active';

    if (v === 'revenue' || v === 'history') {
        // C·∫£ doanh thu v√† l·ªãch s·ª≠ ƒë·ªÅu d√πng chung khung view-history
        var historyView = document.getElementById('view-history');
        if (historyView) historyView.classList.remove('hidden');

        // X√°c ƒë·ªãnh n√∫t n√†o c·∫ßn s√°ng l√™n
        let btnId = (v === 'revenue') ? 'btn-nav-revenue' : 'btn-nav-history';
        let btn = document.getElementById(btnId);
        if (btn) btn.className = activeBtnClass; 

    } else if (v === 'bed') {
        // M·ªü view Bed
        var bedView = document.getElementById('view-bed');
        if (bedView) bedView.classList.remove('hidden');

        // [FIX QUAN TR·ªåNG]: Ki·ªÉm tra n√∫t btn-nav-bed tr∆∞·ªõc khi g√°n class
        // (Tr√™n Mobile n√∫t n√†y kh√¥ng c√≥, n√™n n·∫øu kh√¥ng check s·∫Ω b·ªã l·ªói null)
        let btnBed = document.getElementById('btn-nav-bed');
        if (btnBed) btnBed.className = activeBtnClass;

    } else {
        // C√°c view c√≤n l·∫°i (menu, payment)
        var viewTarget = document.getElementById('view-' + v);
        if (viewTarget) viewTarget.classList.remove('hidden');
    }

    // 3. Logic hi·ªÉn th·ªã Gi·ªè h√†ng (Sidebar Cart)
    var isMobile = window.innerWidth <= 768;
    var showCart = false;

    if (isMobile) {
        // Mobile: Ch·ªâ hi·ªán gi·ªè h√†ng ·ªü Menu, ·∫©n ·ªü Payment
        showCart = (v === 'menu');
    } else {
        // PC/Tablet: Hi·ªán ·ªü c·∫£ Menu v√† Payment
        showCart = (v === 'menu' || v === 'payment');
    }

    var sidebarCart = document.getElementById('sidebar-cart');
    if (sidebarCart) sidebarCart.classList.toggle('hidden', !showCart);

    // ·∫®n/Hi·ªán thanh danh m·ª•c (ch·ªâ hi·ªán ·ªü Menu)
    var catBar = document.getElementById('category-bar');
    if (catBar) catBar.classList.toggle('hidden', v !== 'menu');

    // ·∫®n n√∫t "Thanh to√°n" ·ªü Sidebar n·∫øu ƒëang ·ªü m√†n h√¨nh Payment (ƒë·ªÉ tr√°nh l·∫∑p l·∫°i n√∫t)
    var sidebarPayBtn = document.getElementById('sidebar-pay-btn');
    if (sidebarPayBtn) {
        if (v === 'payment') sidebarPayBtn.classList.add('hidden');
        else sidebarPayBtn.classList.remove('hidden');
    }

    // 4. Logic Luxury Theme (Giao di·ªán ƒëen v√†ng khi ph·ª•c v·ª• Bed)
    const isServingBed = (typeof pendingBedOrder !== 'undefined' && pendingBedOrder) || 
                         (typeof activeOrderingBedId !== 'undefined' && activeOrderingBedId && activeOrderingBedId != 0);

    if (isServingBed && (v === 'menu' || v === 'payment')) {
        document.body.classList.add('luxury-theme');
        var headerTitle = document.querySelector('#header-bar h2');
        if (headerTitle) headerTitle.classList.add('text-[#D4AF37]');
    } else {
        document.body.classList.remove('luxury-theme');
        var headerTitle = document.querySelector('#header-bar h2');
        if (headerTitle) headerTitle.classList.remove('text-[#D4AF37]');
    }

    // 5. Reset c√°c tr·∫°ng th√°i khi v√†o m√†n h√¨nh Thanh To√°n
    if (v === 'payment') {
        // Reset giao di·ªán mobile payment v·ªÅ b∆∞·ªõc 1
        var mobStep1 = document.getElementById('mob-step-1');
        var mobStep2 = document.getElementById('mob-step-2');
        if (mobStep1) mobStep1.classList.remove('hidden');
        if (mobStep2) mobStep2.classList.add('hidden');
        
        var mobTitle = document.getElementById('mob-pay-title');
        if(mobTitle) mobTitle.innerText = "Thanh to√°n";

        // Hi·ªÉn th·ªã t·ªïng ti·ªÅn
        var txtTotal = (typeof currentTotal !== 'undefined') ? currentTotal.toLocaleString() : "0";
        if (document.getElementById('pay-total-display-1')) document.getElementById('pay-total-display-1').innerText = txtTotal;
        if (document.getElementById('pay-total-display-2')) document.getElementById('pay-total-display-2').innerText = txtTotal;
        if (document.getElementById('pay-total-display')) document.getElementById('pay-total-display').innerText = txtTotal;

        // ƒê·ªìng b·ªô SƒêT t·ª´ gi·ªè h√†ng sang m√†n h√¨nh thanh to√°n
        var sdtInput = document.getElementById('kh-sdt');
        var sdtMobInput = document.getElementById('pay-sdt-mobile');
        if (sdtInput && sdtMobInput) {
            sdtMobInput.value = sdtInput.value;
            if (typeof syncMobileInputs === 'function') syncMobileInputs();
        }

        // Reset √¥ ti·ªÅn kh√°ch ƒë∆∞a tr√™n Mobile
        var cashMobInput = document.getElementById('cash-paid-mobile');
        if (cashMobInput) cashMobInput.value = "";

        // Reset ph∆∞∆°ng th·ª©c thanh to√°n v·ªÅ Ti·ªÅn m·∫∑t
        if (typeof setMethod === 'function') setMethod('Ti·ªÅn m·∫∑t');
        
        // Reset √¥ ti·ªÅn kh√°ch ƒë∆∞a tr√™n PC
        var cashPaidInput = document.getElementById('cash-paid');
        if(cashPaidInput && typeof currentTotal !== 'undefined') cashPaidInput.value = currentTotal;
        
        // T√≠nh l·∫°i ti·ªÅn th·ª´a
        if (typeof calcChange === 'function') calcChange();
    }
var mobBar = document.getElementById('mobile-bottom-bar');
    if (mobBar) {
        if (v === 'menu') {
            // N·∫øu l√† Menu -> HI·ªÜN (B·∫•t ch·∫•p gi·ªè h√†ng tr·ªëng hay kh√¥ng)
            mobBar.classList.remove('hidden');
            mobBar.classList.add('flex'); // D√πng flex ƒë·ªÉ cƒÉn ch·ªânh ƒë·∫πp
        } else {
            // N·∫øu l√† Payment, History, Bed... -> ·∫®N
            mobBar.classList.add('hidden');
            mobBar.classList.remove('flex');
        }
    }
}
// Bed Functions
// --- H√ÄM OPEN BED MANAGER (ƒê√É S·ª¨A L·ªñI NG√ÄY GI·ªú) ---
// =========================================================
// QU·∫¢N L√ù BED & L·ªäCH (ƒê√É N√ÇNG C·∫§P: CH·ªåN NG√ÄY)
// =========================================================

// Bi·∫øn l∆∞u tr·ªØ to√†n b·ªô l·ªãch (ƒë·ªÉ kh√¥ng ph·∫£i t·∫£i l·∫°i khi ƒë·ªïi ng√†y)
var globalAllBookings = []; 
var currentFilterDateStr = ""; // L∆∞u ng√†y ƒëang ch·ªçn (d·∫°ng dd/mm/yyyy)

function openBedManager() {
    document.getElementById('loading-overlay').style.display = 'flex';
    switchView('bed');
    
    // 1. M·∫∑c ƒë·ªãnh ch·ªçn ng√†y h√¥m nay
    const today = new Date();
    // Format yyyy-mm-dd cho √¥ input
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const todayInputFormat = `${yyyy}-${mm}-${dd}`;
    
    // Set gi√° tr·ªã cho √¥ ch·ªçn ng√†y
    const picker = document.getElementById('date-picker-btn');
    if(picker) picker.value = todayInputFormat;
    
    // 2. T·∫£i d·ªØ li·ªáu t·ª´ Firebase
    db.ref('bedBookings').on('value', snap => {
        const data = snap.val() || {};
        
        // Chu·∫©n h√≥a d·ªØ li·ªáu th√¥
        globalAllBookings = Object.keys(data).map(k => {
            const item = data[k];
            
            // X·ª≠ l√Ω ng√†y: Chuy·ªÉn h·∫øt v·ªÅ d·∫°ng dd/mm/yyyy ƒë·ªÉ so s√°nh
            let rawDate = item.date || item.bookingDate || "";
            // N·∫øu l√† yyyy-mm-dd (2026-01-23) -> ƒë·ªïi th√†nh 23/01/2026
            if (rawDate.includes('-') && rawDate.split('-')[0].length === 4) {
                const p = rawDate.split('-'); 
                rawDate = `${p[2]}/${p[1]}/${p[0]}`;
            }

            return {
                id: k,
                ...item,
                start: item.start || item.startTime || "--:--", 
                end: item.end || item.endTime || "--:--",
                displayDate: rawDate 
            };
        });

        document.getElementById('loading-overlay').style.display = 'none';
        
        // 3. G·ªçi h√†m l·ªçc theo ng√†y hi·ªán t·∫°i c·ªßa √¥ input
        changeBedDate(picker ? picker.value : todayInputFormat);
    });
}

// H√†m x·ª≠ l√Ω khi b√† b·∫•m ch·ªçn ng√†y kh√°c
function changeBedDate(dateInputValue) {
    if (!dateInputValue) return;

    // dateInputValue ƒëang l√†: 2026-01-25 (yyyy-mm-dd)
    // C·∫ßn ƒë·ªïi sang: 25/01/2026 (dd/mm/yyyy) ƒë·ªÉ kh·ªõp v·ªõi d·ªØ li·ªáu
    const parts = dateInputValue.split('-');
    const targetDateStr = `${parts[2]}/${parts[1]}/${parts[0]}`;
    
    currentFilterDateStr = targetDateStr; // L∆∞u l·∫°i ƒë·ªÉ d√πng n·∫øu c·∫ßn

    console.log("üìÖ ƒêang xem l·ªãch ng√†y:", targetDateStr);

    // L·ªçc danh s√°ch t·ª´ kho d·ªØ li·ªáu ƒë√£ t·∫£i (globalAllBookings)
    // Logic: 
    // 1. Kh·ªõp ng√†y
    // 2. HO·∫∂C ƒëang 'active' (ƒëang d√πng) th√¨ hi·ªán lu√¥n (ƒë·ªÉ nh·ª° qua ƒë√™m c√≤n th·∫•y)
    currentBedList = globalAllBookings.filter(b => {
        // Ch·ªâ hi·ªán active n·∫øu xem ng√†y h√¥m nay, c√≤n xem qu√° kh·ª© th√¨ ch·ªâ hi·ªán ƒë√∫ng ng√†y ƒë√≥
        const isToday = (targetDateStr === new Date().toLocaleDateString('en-GB'));
        
        if (isToday) {
             return b.displayDate === targetDateStr || (b.status && b.status.includes('active'));
        } else {
             // Xem qu√° kh·ª©/t∆∞∆°ng lai th√¨ c·ª© ƒë√∫ng ng√†y l√† hi·ªán
             return b.displayDate === targetDateStr;
        }
    });

    // V·∫Ω l·∫°i giao di·ªán
    renderBedBookings(currentBedList);
}
function renderBedBookings(list) {
    // ========================================================
    // 1. T·ª∞ ƒê·ªòNG QU√âT V√Ä H·ª¶Y L·ªäCH TR·ªÑ (Auto-Cancel Logic)
    // ========================================================
    const now = new Date();
    const AUTO_CANCEL_MINUTES = 50; // Gi·ªõi h·∫°n 50 ph√∫t
    const todayStr = now.toLocaleDateString('en-GB'); // dd/mm/yyyy

    if (list && list.length > 0) {
        list.forEach(booking => {
            // Ch·ªâ ki·ªÉm tra c√°c ƒë∆°n ƒëang "ch·ªù kh√°ch"
            if (booking.status === 'ch·ªù kh√°ch' || !booking.status) {
                
                // Ch·ªâ h·ªßy n·∫øu l√† l·ªãch c·ªßa H√îM NAY
                if (!booking.displayDate || booking.displayDate === todayStr) {
                    
                    if (booking.start && booking.start.includes(':')) {
                        // T√≠nh to√°n th·ªùi gian tr·ªÖ
                        let parts = booking.start.split(':');
                        let bookingTime = new Date();
                        bookingTime.setHours(parseInt(parts[0]), parseInt(parts[1]), 0);

                        let diff = (now - bookingTime) / 60000; // ƒê·ªïi ra ph√∫t

                        // N·∫øu tr·ªÖ h∆°n 50 ph√∫t -> H·ªßy ngay tr√™n Firebase
                        if (diff > AUTO_CANCEL_MINUTES) {
                            console.log(`üö´ Auto-cancel: ƒê∆°n ${booking.name} tr·ªÖ ${Math.round(diff)}p -> H·ª¶Y`);
                            
                            // [ƒê√É S·ª¨A L·ªñI ·ªû ƒê√ÇY]: D√πng booking.id thay v√¨ k, booking thay v√¨ item
                            let bookingId = booking.id || booking.key;
                            
                            if (bookingId) {
                                db.ref('bedBookings/' + bookingId).update({
                                    status: 'ƒë√£ h·ªßy',
                                    cancelType: 'auto_timeout',
                                    note: 'H·ªßy t·ª± ƒë·ªông (Qu√° 50p)'
                                });
                                
                                // C·∫≠p nh·∫≠t hi·ªÉn th·ªã ngay l·∫≠p t·ª©c
                                booking.status = 'ƒë√£ h·ªßy';
                                booking.cancelType = 'auto_timeout';
                            }
                        }
                    }
                }
            }
        });
    }

    // ========================================================
    // 2. RESET GIAO DI·ªÜN V·ªÄ M·∫∂C ƒê·ªäNH
    // ========================================================
    selectedBedIndex = -1; // B·ªè ch·ªçn item ƒëang click
    
    // Hi·ªán m√†n h√¨nh ch·ªù "Ch·ªçn l·ªãch ƒë·ªÉ xem"
    document.getElementById('detail-empty-state')?.classList.remove('hidden');
    
    // ·∫®n b·∫£ng chi ti·∫øt ƒëi
    document.getElementById('detail-content-panel')?.classList.add('hidden');
    
    // T·∫Øt ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c (n·∫øu ƒëang ch·∫°y c·ªßa bed tr∆∞·ªõc)
    stopPanelCountdown();

    // ========================================================
    // 3. V·∫º L·∫†I GIAO DI·ªÜN (List b√™n tr√°i + Map b√™n ph·∫£i)
    // ========================================================
    renderLeftColumnList();
    renderRightColumnMap();
}
// --- H√ÄM V·∫º DANH S√ÅCH B√äN TR√ÅI (KH√îI PH·ª§C & C√ì M√ÄU H·ª¶Y) ---
// --- H√ÄM V·∫º DANH S√ÅCH B√äN TR√ÅI (STYLE M·ªöI: BO TR√íN M·ªÄM M·∫†I) ---
function renderLeftColumnList() {
    var container = document.getElementById('col-left-list');
    if (!container) return;

    if (!currentBedList || currentBedList.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-300 text-[10px] py-10 font-bold uppercase tracking-widest">Kh√¥ng c√≥ l·ªãch</div>';
        return;
    }

    container.innerHTML = currentBedList.map(function(b, index) {
        var isDone = (b.status && b.status.includes('ƒë√£ xong'));
        var isCancelled = (b.status && b.status.includes('ƒë√£ h·ªßy'));
        var isActive = (b.status && (b.status.includes('active') || b.status.includes('ƒëang d√πng')));
        var isSelected = (index === selectedBedIndex);

        // Style c∆° b·∫£n: Bo tr√≤n 24px, padding r·ªông h∆°n
        var wrapperClass = "cursor-pointer p-4 rounded-[24px] transition-all duration-200 mb-3 border relative group ";
        var statusTextUI = ""; 

        if (isSelected) {
            // ƒêang ch·ªçn: Xanh ƒë·∫≠m, n·ªïi kh·ªëi
            wrapperClass += "bg-[#006241] border-[#006241] text-white shadow-lg scale-[1.02] z-10";
        } else if (isCancelled) {
            // ƒê√£ h·ªßy: ƒê·ªè nh·∫°t
            if (b.cancelType === 'auto_timeout') {
                wrapperClass += "bg-red-50 border-red-100 text-red-900";
                statusTextUI = "AUTO TIMEOUT";
            } else {
                wrapperClass += "bg-red-50 border-red-100 text-red-800 opacity-70 grayscale-[0.5]";
                statusTextUI = "ƒê√É H·ª¶Y";
            }
        } else if (isDone) {
            // ƒê√£ xong: X√°m s·∫°ch s·∫Ω
            wrapperClass += "bg-gray-100 border-gray-200 text-gray-500 hover:bg-gray-200";
        } else if (isActive) {
            // ƒêang d√πng: Xanh nh·∫°t
            wrapperClass += "bg-[#E6F4F1] border-[#bce3db] text-[#006241] shadow-sm";
        } else {
            // Ch·ªù: Tr·∫Øng
            wrapperClass += "bg-white border-gray-100 text-gray-600 hover:bg-gray-50 hover:shadow-md hover:border-gray-200";
        }

        // D·∫•u ch·∫•m tr·∫°ng th√°i
        var statusDot = "";
        if (isCancelled) statusDot = "bg-red-500";
        else if (isDone) statusDot = "bg-gray-400";
        else if (isActive) statusDot = "bg-green-500 animate-pulse shadow-[0_0_8px_rgba(34,197,94,0.6)]";
        else statusDot = "bg-amber-400";

        // Hi·ªÉn th·ªã gi·ªù
        var timeDisplay = `${b.start} - ${b.end}`;
        if (isDone && b.realEndTime) timeDisplay = `Check-out: ${b.realEndTime}`;
        else if (isCancelled) timeDisplay = statusTextUI;

        var bedLabel = (b.bedId && b.bedId != "WAITING") ? `BED 0${b.bedId}` : "CH·ªú X·∫æP";

        return `
        <div onclick="selectBedItem(${index})" class="${wrapperClass}">
            <div class="flex justify-between items-center mb-1.5">
                <span class="font-black text-[10px] opacity-70 uppercase tracking-widest">${bedLabel}</span>
                <div class="w-2.5 h-2.5 rounded-full ${statusDot}"></div>
            </div>
            <div class="font-black text-sm truncate mb-1.5 leading-tight">${b.name}</div>
            <div class="text-[10px] font-mono flex justify-between opacity-80 font-bold items-center">
                <span>${timeDisplay}</span>
                ${b.totalSpend ? `<span class="bg-black/10 px-1.5 rounded text-[9px]">${Number(b.totalSpend).toLocaleString()}ƒë</span>` : ''}
            </div>
        </div>`;
    }).join('');
}
function renderRightColumnMap() { var container = document.getElementById('vertical-map-container'); if(!container) return; var html = ''; for (var i = 1; i <= 4; i++) { var booking = currentBedList.find(b => b.bedId == i && b.status && !b.status.includes('ƒë√£ xong') && !b.status.includes('ƒë√£ h·ªßy')); var boxStyle = booking ? ((booking.status.includes('ƒëang d√πng') || booking.status.includes('active')) ? "bg-green-500 border-green-600 text-white shadow-md ring-2 ring-green-100 hover:scale-105 cursor-pointer" : "bg-amber-50 border-amber-300 text-amber-500 hover:scale-105 cursor-pointer") : "bg-gray-50 border-gray-200 text-gray-300"; var label = booking ? ((booking.status.includes('ƒëang d√πng') || booking.status.includes('active')) ? "ACTIVE" : "ƒê·∫∂T") : "TR·ªêNG"; var actionAttr = booking ? `onclick="selectBedFromMap(${i})"` : ""; html += `<div ${actionAttr} class="flex-1 rounded-xl border-2 border-dashed ${boxStyle} flex flex-col items-center justify-center transition-all min-h-[50px] mb-2 relative group"><span class="text-lg font-black">0${i}</span><span class="text-[8px] font-bold tracking-wider">${label}</span>${booking ? `<div class="absolute inset-0 flex items-center justify-center bg-black/10 opacity-0 group-hover:opacity-100 rounded-xl transition-opacity"><span class="text-[10px] font-bold text-white">Xem</span></div>` : ''}</div>`; } container.innerHTML = html; }
function selectBedFromMap(bedId) { var index = currentBedList.findIndex(b => b.bedId == bedId && b.status && !b.status.includes('ƒë√£ xong') && !b.status.includes('ƒë√£ h·ªßy')); if (index !== -1) { (index); var listItem = document.getElementById('col-left-list').children[index]; if(listItem) listItem.scrollIntoView({behavior: 'smooth', block: 'center'}); } }
// --- H√ÄM G·ªåI POPUP STYLE IPHONE ---
let onConfirmAction = null; // Bi·∫øn l∆∞u h√†nh ƒë·ªông s·∫Ω l√†m khi b·∫•m OK

function showIOSConfirm(message, callback) {
    // 1. G√°n n·ªôi dung
    document.getElementById('ios-modal-message').innerText = message;
    
    // 2. L∆∞u h√†nh ƒë·ªông c·∫ßn l√†m (callback)
    onConfirmAction = callback;
    
    // 3. G√°n s·ª± ki·ªán cho n√∫t OK
    const btnOk = document.getElementById('ios-confirm-btn');
    btnOk.onclick = function() {
        if (onConfirmAction) onConfirmAction(); // Ch·∫°y h√†nh ƒë·ªông
        closeIOSModal(); // ƒê√≥ng popup
    };

    // 4. Hi·ªÉn th·ªã Popup
    const modal = document.getElementById('ios-confirm-modal');
    modal.classList.remove('hidden');
    // Th√™m ch√∫t animation
    modal.classList.add('animate-fade-in'); 
}

function closeIOSModal() {
    document.getElementById('ios-confirm-modal').classList.add('hidden');
    onConfirmAction = null;
}
// --- H√ÄM SELECT ITEM: ƒê√É G·ªòP T·∫§T C·∫¢ LOGIC (KH√îNG B·ªä ƒê∆† N·ªÆA) ---
// --- H√ÄM SELECT ITEM: ƒê√É S·ª¨A L·ªñI D·∫§U NGO·∫∂C + POPUP IPHONE ---
// --- H√ÄM SELECT ITEM: ƒê√É FIX L·ªñI "BTN CANCEL" & TH√äM CH·ªåN L√ù DO H·ª¶Y ---
// --- H√ÄM CH·ªåN BED ITEM (N√ÇNG C·∫§P: T√çNH TI·ªÄN + PH·∫†T V·ªÜ SINH) ---
// --- H√ÄM SELECT BED ITEM (B·∫¢N CHU·∫®N: COMPACT UI + ƒê·ª¶ T√çNH NƒÇNG) ---
// --- H√ÄM CH·ªåN BED ITEM (ƒê√É N√ÇNG C·∫§P: QU·∫¢N L√ù PH·∫†T V·ªÜ SINH) ---
function selectBedItem(index) {
    selectedBedIndex = index;
    renderLeftColumnList(); 

    var data = currentBedList[index];
    var panel = document.getElementById('detail-content-panel');
    var empty = document.getElementById('detail-empty-state');
    
    // --- ·∫®N M√ÄN H√åNH CH·ªú ---
    if(empty) empty.classList.add('hidden');
    if(panel) { panel.classList.remove('hidden'); panel.classList.add('flex'); }

    // --- TR·∫†NG TH√ÅI ---
    var isDone = (data.status && data.status.includes('ƒë√£ xong'));
    var isCancelled = (data.status && data.status.includes('ƒë√£ h·ªßy'));
    var isActive = (data.status && (data.status.includes('active') || data.status.includes('ƒëang d√πng')));
    var hasBed = (data.bedId && data.bedId != "WAITING");
    var bookingId = data.id || data.key;
    
    // Ki·ªÉm tra xem ƒë∆°n n√†y ƒë√£ b·ªã ph·∫°t ch∆∞a?
    var hasPenalty = data.hasPenalty === true;
    var penaltyAmt = data.penaltyAmount || 0;

    // --- X√ÇY D·ª∞NG GIAO DI·ªÜN ---
    panel.innerHTML = `
    <div class="bg-white border-b border-gray-100 p-4 sticky top-0 z-10 shadow-sm">
        <div class="flex justify-between items-center">
            <div>
                <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-0.5">ƒêang ch·ªçn</p>
                <h1 class="text-3xl font-black text-[#1e3932] leading-none" id="detail-bed-name">${hasBed ? `BED 0${data.bedId}` : "CH·ªú X·∫æP"}</h1>
            </div>
            <div id="detail-status-badge" class="px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wider">
                ${isDone ? "ƒê√É XONG" : (isCancelled ? "ƒê√É H·ª¶Y" : (isActive ? "ƒêANG D√ôNG" : "CH·ªú KH√ÅCH"))}
            </div>
        </div>
    </div>

    <div class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-3 bg-[#F9FAFB]">
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-white p-3 rounded-2xl border border-gray-100 shadow-sm">
                <p class="text-[9px] font-bold text-gray-400 uppercase">Ng∆∞·ªùi ƒë·∫∑t</p>
                <p class="font-bold text-[#1e3932] text-sm truncate">${data.name || "Kh√°ch l·∫ª"}</p>
                <p class="font-mono text-[10px] text-gray-500 font-bold">${data.phone || "--"}</p>
            </div>
            <div class="bg-white p-3 rounded-2xl border border-gray-100 shadow-sm">
                <p class="text-[9px] font-bold text-gray-400 uppercase">ƒêi c√πng</p>
                <p class="font-bold text-[#1e3932] text-sm truncate">${data.compName || "---"}</p>
                <p class="font-mono text-[10px] text-gray-500 font-bold">${data.compPhone || "--"}</p>
            </div>
        </div>

        <div class="bg-white p-3 rounded-2xl border border-gray-100 shadow-sm flex justify-between items-center text-xs">
            <div><p class="text-[9px] text-gray-400 font-bold uppercase">B·∫Øt ƒë·∫ßu</p><p class="font-black text-[#1e3932] text-lg">${data.start}</p></div>
            <div class="text-gray-300">‚ûú</div>
            <div class="text-right"><p class="text-[9px] text-gray-400 font-bold uppercase">K·∫øt th√∫c</p><p class="font-black text-[#1e3932] text-lg">${data.end}</p></div>
        </div>
        
        <div id="row-checkout-time" class="hidden bg-gray-100 rounded-xl p-3 flex justify-between items-center">
            <span class="text-[10px] font-bold text-gray-500 uppercase">Check-out l√∫c:</span>
            <span class="font-black text-red-600 text-sm">${isCancelled ? (data.note || "ƒê√£ h·ªßy") : (data.realEndTime || "--:--")}</span>
        </div>

        <div id="done-session-info" class="hidden"></div>

    </div>

    <div id="detail-action-buttons" class="p-4 bg-white border-t border-gray-100 mt-auto">
        <div class="grid grid-cols-2 gap-3">
            <button id="btn-action-order" class="py-3 rounded-xl bg-amber-50 text-amber-700 font-bold border border-amber-100 shadow-sm active:scale-95 transition-all flex justify-center items-center gap-1.5">
                <span>‚òï</span> <span class="uppercase text-[10px] tracking-wider">G·ªçi M√≥n</span>
            </button>
            <button id="btn-action-checkout" class="py-3 rounded-xl bg-[#006241] text-white font-bold shadow-md shadow-green-900/10 active:scale-95 transition-all flex justify-center items-center gap-1.5">
                <span>üõèÔ∏è</span> <span class="uppercase text-[10px] tracking-wider">X·∫øp Bed</span>
            </button>
        </div>
        <div id="wrapper-btn-cancel" class="mt-2 hidden">
            <button id="btn-action-cancel" class="w-full py-2.5 rounded-xl text-red-400 font-bold bg-white border border-dashed border-gray-300 hover:bg-red-50 hover:border-red-200 transition-all text-[10px] uppercase tracking-widest">H·ªßy L·ªãch N√†y</button>
        </div>
    </div>
    `;

    // ... (Code c·∫≠p nh·∫≠t m√†u Badge Badge gi·ªØ nguy√™n) ...
    var badge = document.getElementById('detail-status-badge');
    if (isDone) badge.className = "px-3 py-1.5 bg-gray-200 text-gray-600 rounded-lg text-[10px] font-bold uppercase"; 
    else if (isCancelled) badge.className = "px-3 py-1.5 bg-red-100 text-red-600 rounded-lg text-[10px] font-bold uppercase"; 
    else if (isActive) badge.className = "px-3 py-1.5 bg-green-100 text-green-700 rounded-lg text-[10px] font-bold uppercase animate-pulse border border-green-200"; 
    else badge.className = "px-3 py-1.5 bg-amber-100 text-amber-700 rounded-lg text-[10px] font-bold uppercase border border-amber-200"; 

    // --- LOGIC ·∫®N HI·ªÜN & RENDER N√öT PH·∫†T ---
    var rowCheckout = document.getElementById('row-checkout-time');
    var actionBtns = document.getElementById('detail-action-buttons');
    var wrapperCancel = document.getElementById('wrapper-btn-cancel');

    if (isDone || isCancelled) {
        if(rowCheckout) rowCheckout.classList.remove('hidden');
        if(actionBtns) actionBtns.classList.add('hidden');
        if(wrapperCancel) wrapperCancel.classList.add('hidden');

        // [QUAN TR·ªåNG] HI·ªÜN T·ªîNG TI·ªÄN + LOGIC N√öT PH·∫†T TH√îNG MINH
        if (isDone && !isCancelled && data.phone) {
            calculateSessionSpend(data.phone, data.start, data.realEndTime).then(total => {
                var infoDiv = document.getElementById('done-session-info');
                if (infoDiv) {
                    
                    // A. N·∫æU CH∆ØA B·ªä PH·∫†T -> HI·ªÜN N√öT C√ÇY CH·ªîI
                    var penaltyHTML = `
                    <div class="mt-4 bg-white rounded-[24px] p-4 border border-red-100 shadow-[0_8px_20px_-8px_rgba(239,68,68,0.3)] flex items-center justify-between relative overflow-hidden group cursor-pointer" onclick="openCleaningModal('${data.phone}', '${bookingId}')">
                        <div class="flex items-center gap-4 z-10">
                            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-red-500 to-red-600 text-white flex items-center justify-center shadow-md shadow-red-300/50 group-active:scale-90 transition-all duration-300">
                                <span class="text-3xl drop-shadow-sm group-hover:-rotate-12 transition-transform">üßπ</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-black text-gray-900 leading-none mb-1 group-hover:text-red-600 transition-colors">Ph√≠ V·ªá Sinh</h3>
                                <p class="text-[11px] text-gray-500 font-medium">Ch·∫°m ƒë·ªÉ th√™m ph√≠ d·ªçn d·∫πp</p>
                            </div>
                        </div>
                        <div class="text-gray-300 text-2xl z-10">‚ûú</div>
                    </div>`;

                    // B. N·∫æU ƒê√É B·ªä PH·∫†T -> HI·ªÜN TH√îNG B√ÅO + N√öT S·ª¨A/X√ìA
                    if (hasPenalty) {
                        penaltyHTML = `
                        <div class="mt-4 bg-red-50 rounded-[24px] p-4 border border-red-200 flex flex-col gap-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-red-100 text-red-500 flex items-center justify-center text-xl">‚ö†Ô∏è</div>
                                <div>
                                    <p class="text-[10px] font-bold text-red-400 uppercase tracking-wider">ƒê√£ t√≠nh ph√≠ l·∫ßn sau</p>
                                    <p class="text-xl font-black text-red-600 leading-none">${penaltyAmt.toLocaleString()}ƒë</p>
                                </div>
                            </div>
                            <div class="flex gap-2 mt-1">
                                <button onclick="openCleaningModal('${data.phone}', '${bookingId}')" class="flex-1 py-2.5 bg-white border border-red-100 text-red-500 font-bold text-[10px] rounded-xl uppercase shadow-sm active:scale-95">‚úèÔ∏è Thay ƒë·ªïi</button>
                                <button onclick="deletePenalty('${data.phone}', '${bookingId}')" class="flex-1 py-2.5 bg-red-500 text-white font-bold text-[10px] rounded-xl uppercase shadow-sm active:scale-95">üóëÔ∏è X√≥a ph√≠</button>
                            </div>
                        </div>`;
                    }

                    infoDiv.innerHTML = `
                    <div class="bg-white border border-[#006241]/30 rounded-[20px] p-5 shadow-sm relative overflow-hidden mt-3">
                        <div class="absolute -right-5 -bottom-5 w-24 h-24 bg-[#006241]/10 rounded-full blur-xl pointer-events-none"></div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">T·ªïng chi session n√†y</p>
                        <div class="flex items-baseline gap-1">
                            <p class="text-4xl font-black text-[#1e3932] tracking-tight">${total.toLocaleString()}</p>
                            <span class="text-lg font-bold text-[#006241]">vnƒë</span>
                        </div>
                    </div>
                    ${penaltyHTML}
                    `;
                    infoDiv.classList.remove('hidden');
                }
            });
        }
    } else {
        // ... (Code hi·ªÉn th·ªã khi ƒëang ch·∫°y - Gi·ªØ nguy√™n nh∆∞ c≈©) ...
        var oldInfo = document.getElementById('done-session-info');
        if(oldInfo) oldInfo.classList.add('hidden');
        if(rowCheckout) rowCheckout.classList.add('hidden');
        if(actionBtns) actionBtns.classList.remove('hidden');
        if(isActive) { if(wrapperCancel) wrapperCancel.classList.add('hidden'); }
        else { if(wrapperCancel) wrapperCancel.classList.remove('hidden'); }
        setupActionButtons(bookingId, data, hasBed, 
            document.getElementById('btn-action-order'), 
            document.getElementById('btn-action-checkout'), 
            document.getElementById('btn-action-cancel')
        );
    }
}
// H√†m ph·ª• ƒë·ªÉ g√°n n√∫t (cho code g·ªçn)
function setupActionButtons(bookingId, data, hasBed, btnOrder, btnCheckout, btnCancel) {
    // Cancel
    if(btnCancel) {
        btnCancel.onclick = function() {
            window.pendingCancelId = bookingId;
            document.getElementById('modal-cancel-reason').classList.remove('hidden');
        };
    }
    // Order
    if (btnOrder) {
        btnOrder.innerHTML = "<span>‚òï G·ªçi M√≥n</span>";
        btnOrder.onclick = function() { showBedDetail(data.bedId); };
    }
    // Checkout
    if (btnCheckout) {
        if (!hasBed) {
            btnCheckout.innerHTML = '<span>üõèÔ∏è X·∫øp Bed Ngay</span>';
            btnCheckout.onclick = function() {
                pendingBedOrder = data;
                renderBedSelection();
                document.getElementById('bed-select-modal').classList.remove('hidden');
            };
        } else {
            btnCheckout.innerHTML = '<span>Tr·∫£ Bed</span>';
            btnCheckout.onclick = function() { handleBedCheckout(data); };
        }
    }
}
// --- S·ª¨A L·ªñI: G·ªåI M√ìN KH√îNG NH·∫¨N DI·ªÜN KH√ÅCH ---
function showBedDetail(bedId) { 
    var booking = null; 
    if (bedId && bedId != 0) booking = currentBedList.find(b => b.bedId == bedId);
    if (!booking && selectedBedIndex > -1) booking = currentBedList[selectedBedIndex]; 
    
    if (!booking) { 
        alert("Vui l√≤ng ch·ªçn kh√°ch h√†ng trong danh s√°ch tr∆∞·ªõc!");
        return; 
    } 
    
    activeOrderingBedId = bedId; 
    pendingBedOrder = booking; 
    if (booking.phone) {
        var cleanPhone = normalizePhone(booking.phone);
        // L·∫•y th√¥ng tin kh√°ch t·ª´ Firebase (ho·∫∑c bi·∫øn customerMap c√≥ s·∫µn)
        db.ref('customers/' + cleanPhone).once('value', snap => {
            var cust = snap.val();
            if (cust && cust.pendingFee > 0) {
                // >> PH√ÅT HI·ªÜN C√ì N·ª¢
                alert(`‚ö†Ô∏è Kh√°ch n√†y c√≥ kho·∫£n n·ª£ c≈©: ${cust.pendingFee.toLocaleString()}ƒë\nL√Ω do: ${cust.pendingFeeReason}\n\nH·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông th√™m v√†o bill.`);
                
                // Th√™m v√†o gi·ªè h√†ng
                addToCart("Ph√≠ V·ªá Sinh (N·ª£ c≈©)", "Ph·∫°t", cust.pendingFee);
                
                // X√≥a n·ª£ tr√™n Firebase ngay (ƒë·ªÉ kh√¥ng b·ªã c·ªông d·ªìn l·∫ßn sau n·ªØa)
                db.ref('customers/' + cleanPhone).update({
                    pendingFee: 0,
                    pendingFeeReason: null
                });
            }
        });
    }
    // --- ƒêO·∫†N M·ªöI TH√äM: T·ª∞ ƒêI·ªÄN SƒêT KH√ÅCH V√ÄO GI·ªé H√ÄNG ---
    var sdtInput = document.getElementById('kh-sdt');
    if (sdtInput && booking.phone) {
        sdtInput.value = booking.phone;
        // G·ªçi h√†m ki·ªÉm tra ƒë·ªÉ n√≥ hi·ªán t√™n kh√°ch l√™n (n·∫øu c√≥ trong data)
        if (typeof checkSdtLive === 'function') checkSdtLive();
    }
    // ----------------------------------------------------

    switchView('menu'); 
    
    // (ƒêo·∫°n d∆∞·ªõi gi·ªØ nguy√™n ƒë·ªÉ hi·ªán c√°i thanh th√¥ng b√°o nh·ªè)
    setTimeout(function() { 
        var cartInfo = document.getElementById('cart-bed-info'); 
        var headerContainer = document.querySelector('#sidebar-cart .flex.justify-between'); 
        if (!cartInfo && headerContainer) { 
            cartInfo = document.createElement('div'); 
            cartInfo.id = 'cart-bed-info'; 
            headerContainer.parentNode.insertBefore(cartInfo, headerContainer.nextSibling); 
        } 
        if (cartInfo) { 
            var guestName = booking.name || "Kh√°ch h√†ng"; 
            cartInfo.className = "text-[11px] font-black uppercase mb-2 pl-1 mt-1"; 
            if (booking.bedId && booking.bedId != 0) { 
                cartInfo.innerText = `üü¢ BED 0${booking.bedId} - ${guestName}`; 
                cartInfo.style.color = "#006241"; 
            } else { 
                cartInfo.innerText = `üü† KH√ÅCH CH·ªú - ${guestName}`; 
                cartInfo.style.color = "#d97706"; 
            } 
        } 
    }, 50);
}
    //--- S·ª¨A L·ªñI: X·∫æP BED B·ªä RA ƒê∆†N M·ªöI UNDEFINED ---
function finalizeBedCheckIn(bedId) {
    // 1. Ki·ªÉm tra an to√†n
    if (!pendingBedOrder) return alert("Ch∆∞a ch·ªçn kh√°ch h√†ng!");
    
    // QUAN TR·ªåNG: Ki·ªÉm tra xem c√≥ ID ƒë∆°n h√†ng kh√¥ng?
    // Code hi·ªÉn th·ªã d√πng .id, n√™n ·ªü ƒë√¢y ph·∫£i d√πng .id
    var bookingId = pendingBedOrder.id || pendingBedOrder.key; 
    
    if (!bookingId) {
        console.error("L·ªói: Kh√¥ng t√¨m th·∫•y ID ƒë∆°n h√†ng", pendingBedOrder);
        return alert("L·ªói d·ªØ li·ªáu: Kh√¥ng t√¨m th·∫•y m√£ ƒë∆°n h√†ng. Vui l√≤ng F5 v√† th·ª≠ l·∫°i.");
    }

    // 2. Ki·ªÉm tra xem Bed ƒë√≥ c√≥ ƒëang b·∫≠n kh√¥ng
    // (L·ªçc trong danh s√°ch hi·ªán t·∫°i ƒë·ªÉ xem Bed X ƒë√£ c√≥ ai Active ch∆∞a)
    const isBusy = currentBedList.find(b => 
        (b.status && (b.status.includes('active') || b.status.includes('ƒëang d√πng'))) 
        && b.bedId == bedId
    );

    if (isBusy) return alert("Bed " + bedId + " ƒëang c√≥ kh√°ch r·ªìi!");

    // 3. X·ª≠ l√Ω c·∫≠p nh·∫≠t
    document.getElementById('bed-select-modal').classList.add('hidden');
    document.getElementById('loading-overlay').style.display = 'flex';

    // 4. GHI ƒê√à V√ÄO ƒê√öNG ID C≈® (Update)
    // Tuy·ªát ƒë·ªëi kh√¥ng d√πng .push() ·ªü ƒë√¢y
    db.ref('bedBookings/' + bookingId).update({
        status: 'active',   // Chuy·ªÉn tr·∫°ng th√°i sang Active
        bedId: bedId,       // G√°n s·ªë Bed
        checkInTime: new Date().toLocaleTimeString('en-GB') // L∆∞u gi·ªù v√†o th·ª±c t·∫ø
    }, (err) => {
        document.getElementById('loading-overlay').style.display = 'none';
        
        if (!err) {
            // Reset bi·∫øn t·∫°m
            pendingBedOrder = null;
            isPaymentMode = false;
            
            // T·∫£i l·∫°i danh s√°ch ƒë·ªÉ th·∫•y k·∫øt qu·∫£
            // L√∫c n√†y √¥ng Nguyen Van A s·∫Ω nh·∫£y t·ª´ "Ch·ªù x·∫øp" sang "Bed X"
            openBedManager(); 
        } else {
            alert("L·ªói Firebase: " + err.message);
        }
    });
}
function openBookingModal() { document.getElementById('modal-add-booking').classList.remove('hidden'); document.getElementById('new_cust_name').value = "Kh√°ch v√£ng lai"; document.getElementById('new_cust_phone').value = ""; document.getElementById('new_cust_phone').focus(); switchTimeMode('duration'); }
function closeBookingModal() { document.getElementById('modal-add-booking').classList.add('hidden'); }
function autoFillCustomer() {
    // 1. L·∫•y SƒêT t·ª´ √¥ nh·∫≠p li·ªáu
    var phoneInput = document.getElementById('new_cust_phone');
    var phone = phoneInput.value.toString().trim();

    // 2. N·∫øu ch∆∞a nh·∫≠p ƒë·ªß s·ªë th√¨ ch∆∞a l√†m g√¨ c·∫£ (v√≠ d·ª• d∆∞·ªõi 3 s·ªë)
    if (!phone || phone.length < 3) return;

    // 3. TRA C·ª®U NGAY TRONG RAM (Kh√¥ng c·∫ßn g·ªçi Server, kh√¥ng c·∫ßn Loading spinner)
    var customer = customerMap[phone];

    // L·∫•y c√°c √¥ nh·∫≠p li·ªáu c·∫ßn ƒëi·ªÅn
    var elName = document.getElementById('new_cust_name');
    var elCompName = document.getElementById('new_comp_name');
    var elCompPhone = document.getElementById('new_comp_phone');

    if (customer) {
        // --- T√åM TH·∫§Y: ƒêI·ªÄN D·ªÆ LI·ªÜU T·ª∞ ƒê·ªòNG ---
        
        // ƒêi·ªÅn t√™n
        elName.value = customer.name || "";
        
        // ƒêi·ªÅn th√¥ng tin ng∆∞·ªùi ƒëi c√πng (Ki·ªÉm tra c·∫£ 2 tr∆∞·ªùng h·ª£p t√™n key cho ch·∫Øc)
        elCompName.value = customer.companionName || customer.compName || ""; 
        elCompPhone.value = customer.companionPhone || customer.compPhone || "";

        // Hi·ªáu ·ª©ng nh√°y m√†u xanh b√°o hi·ªáu ƒë√£ t√¨m th·∫•y
        elName.classList.add('bg-green-50', 'text-green-700');
        setTimeout(() => elName.classList.remove('bg-green-50', 'text-green-700'), 1000);
        
        console.log("Auto-fill th√†nh c√¥ng cho:", customer.name);
    } else {
        // --- KH√îNG T√åM TH·∫§Y ---
        // C√≥ th·ªÉ ƒë·ªÉ tr·ªëng ƒë·ªÉ nh√¢n vi√™n t·ª± nh·∫≠p, ho·∫∑c log ra console
        // Kh√¥ng n√™n x√≥a tr·∫Øng ngay v√¨ l·ª° nh√¢n vi√™n ƒëang g√µ d·ªü
        console.log("Ch∆∞a c√≥ d·ªØ li·ªáu cho SƒêT n√†y (Kh√°ch m·ªõi)");
    }
}
// --- H√ÄM T·∫†O L·ªäCH BED M·ªöI (ƒê√É FIX ƒê∆Ø·ªúNG D·∫™N + NG√ÄY GI·ªú) ---
// --- H√ÄM T·∫†O L·ªäCH BED M·ªöI (CHU·∫®N C√ö PH√ÅP) ---
// --- H√ÄM T·∫†O L·ªäCH M·ªöI (ƒê√É KH·ªöP V·ªöI GIAO DI·ªÜN IOS) ---
// --- H√ÄM T·∫†O L·ªäCH M·ªöI (ƒê√É FIX L·ªñI TR√ôNG BI·∫æN 'NOW') ---
function submitNewBooking() {
    // 1. L·∫•y th√¥ng tin kh√°ch
    var phone = document.getElementById('new_cust_phone').value;
    var name = document.getElementById('new_cust_name').value;
    var compName = document.getElementById('new_comp_name').value;
    var compPhone = document.getElementById('new_comp_phone').value;

    if (!phone || !name) return alert("Vui l√≤ng nh·∫≠p SƒêT v√† T√™n!");

    // 2. T√≠nh th·ªùi gian & Ki·ªÉm tra h·ª£p l·ªá
    var durationMinutes = 60; // M·∫∑c ƒë·ªãnh 1 ti·∫øng
    
    // Khai b√°o bi·∫øn 'now' M·ªòT L·∫¶N DUY NH·∫§T ·ªü ƒë√¢y ƒë·ªÉ d√πng chung
    var now = new Date(); 

    // Ki·ªÉm tra xem ƒëang ch·ªçn tab n√†o
    var boxDur = document.getElementById('mode-duration-box');
    
    if (boxDur && !boxDur.classList.contains('hidden')) {
        // Tab: Theo ti·∫øng (1h, 2h, 3h)
        durationMinutes = (typeof selectedDurationHours !== 'undefined' ? selectedDurationHours : 1) * 60;
    } else {
        // Tab: Ch·ªçn gi·ªù v·ªÅ
        var timeStr = document.getElementById('manual-end-time').value;
        if (!timeStr) return alert("Vui l√≤ng ch·ªçn gi·ªù v·ªÅ!");
        
        var parts = timeStr.split(':');
        var end = new Date(); // T·∫°o m·ªôt bi·∫øn ng√†y t·∫°m
        // Set gi·ªù ph√∫t user ch·ªçn v√†o ng√†y h√¥m nay
        end.setHours(parseInt(parts[0]), parseInt(parts[1]), 0);
        
        // N·∫øu ch·ªçn gi·ªù nh·ªè h∆°n gi·ªù hi·ªán t·∫°i -> B√°o l·ªói
        if (end <= now) return alert("Gi·ªù v·ªÅ ph·∫£i l·ªõn h∆°n gi·ªù hi·ªán t·∫°i!");
        
        durationMinutes = Math.floor((end - now) / 60000);
    }

    // 3. Hi·ªáu ·ª©ng n√∫t b·∫•m
    var btn = document.querySelector('button[onclick="submitNewBooking()"]');
    if(btn) { btn.innerHTML = "‚è≥ ƒêang t·∫°o..."; btn.disabled = true; }

    // 4. T√≠nh to√°n gi·ªù hi·ªÉn th·ªã (D√πng l·∫°i bi·∫øn 'now' ·ªü tr√™n, KH√îNG khai b√°o l·∫°i)
    const dateStr = now.toLocaleDateString('en-GB'); 
    const startStr = now.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
    
    const endObj = new Date(now.getTime() + durationMinutes * 60000);
    const endStr = endObj.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});

    // 5. G·ª≠i l√™n Firebase
    db.ref('bedBookings').push({
        phone: phone,
        name: name,
        date: dateStr,
        start: startStr,
        end: endStr,
        compName: compName,
        compPhone: compPhone,
        status: "ch·ªù kh√°ch",
        bedId: "",
        type: "walk-in"
    }, (err) => {
        if(btn) { btn.innerHTML = "T·∫†O L·ªäCH & CH·ªú X·∫æP"; btn.disabled = false; }
        
        if (!err) {
            closeBookingModal(); // ƒê√≥ng popup
            openBedManager();    // Load l·∫°i danh s√°ch
        } else {
            alert("L·ªói: " + err.message);
        }
    });
}
function submitWalkIn() { var phone = normalizePhone(document.getElementById('walkin-phone').value); var hours = document.getElementById('walkin-hours').value; if(!phone || !hours) return; document.getElementById('walk-in-modal').classList.add('hidden'); document.getElementById('loading-overlay').style.display = 'flex'; db.ref('beds').push({ phone: phone, name: "Kh√°ch v√£ng lai", duration: hours*60, type: "walk-in", status: "ch·ªù kh√°ch" }); document.getElementById('loading-overlay').style.display = 'none'; openBedManager(); }
function checkSdtLive() {
    // 1. L·∫•y gi√° tr·ªã t·ª´ √¥ input
    const sdtInput = document.getElementById('kh-sdt');
    const sdt = sdtInput.value.toString().trim(); // X√≥a kho·∫£ng tr·∫Øng th·ª´a cho ch·∫Øc
    const status = document.getElementById('sdt-status');

    // 2. Reset n·∫øu x√≥a tr·∫Øng ho·∫∑c ch∆∞a ƒë·ªß s·ªë
    if (sdt.length < 3) { // ƒê·ªÉ 3 ho·∫∑c 10 t√πy b·∫°n, th∆∞·ªùng reset s·ªõm cho ƒë·∫πp
        status.innerText = "";
        return;
    }

    // 3. KI·ªÇM TRA TRONG RAM (Si√™u nhanh, kh√¥ng c·∫ßn g·ªçi db.ref n·ªØa)
    // V√¨ key c·ªßa customerMap ch√≠nh l√† SƒêT, ta ch·ªâ c·∫ßn "nh·∫∑t" n√≥ ra
    const m = customerMap[sdt];

    if (m) {
        // --- T√åM TH·∫§Y ---
        // L∆∞u √Ω: m ch√≠nh l√† object {name: "...", points: ...} lu√¥n, kh√¥ng c·∫ßn Object.values g√¨ c·∫£
        status.innerText = "‚òÖ TH√ÄNH VI√äN: " + m.name;
        status.className = "text-[8px] font-black text-green-500 uppercase mt-1 text-center";
    } else {
        // --- KH√îNG T√åM TH·∫§Y ---
        // Ch·ªâ b√°o kh√°ch m·ªõi khi ƒë√£ nh·∫≠p ƒë·ªß d√†i (v√≠ d·ª• 10 s·ªë) ƒë·ªÉ ƒë·ª° nh√°y lo·∫°n x·∫°
        if (sdt.length >= 10) {
            status.innerText = "‚òÖ KH√ÅCH M·ªöI";
            status.className = "text-[8px] font-black text-amber-500 uppercase mt-1 text-center";
        } else {
            status.innerText = ""; // Ch∆∞a nh·∫≠p xong th√¨ ch∆∞a b√°o g√¨
        }
    }
}
function showAppModal(title, msg, icon = '') { document.getElementById('app-modal-title').innerText = title; document.getElementById('app-modal-msg').innerHTML = msg; document.getElementById('app-modal-icon').innerText = icon; document.getElementById('app-modal').classList.remove('hidden'); }
function parseTimeObj(timeStr) { if (!timeStr) return null; var d = new Date(); var parts = timeStr.split(':'); d.setHours(parseInt(parts[0]), parseInt(parts[1]), 0, 0); return d; }
function startPanelCountdown(endTimeStr) { stopPanelCountdown(); var clockEl = document.getElementById('detail-countdown'); if(!clockEl) return; var timeParts = endTimeStr.split(':'); if(timeParts.length < 2) return; var endDate = new Date(); endDate.setHours(parseInt(timeParts[0]), parseInt(timeParts[1]), 0); bedCountdownInterval = setInterval(function() { var diff = endDate - new Date(); var isOver = diff < 0; diff = Math.abs(diff); var h = Math.floor(diff / 3600000); var m = Math.floor((diff % 3600000) / 60000); var s = Math.floor((diff % 60000) / 1000); var fmt = v => v < 10 ? "0"+v : v; clockEl.innerText = (isOver ? '-' : '') + fmt(h) + ":" + fmt(m) + ":" + fmt(s); clockEl.className = isOver ? "text-3xl font-black text-red-500 font-mono tracking-tighter" : "text-3xl font-black text-[#006241] font-mono tracking-tighter"; }, 1000); }
function stopPanelCountdown() { if (bedCountdownInterval) clearInterval(bedCountdownInterval); }
function switchTimeMode(mode) { var btnDur = document.getElementById('tab-duration'); var btnFix = document.getElementById('tab-fixed'); var divDur = document.getElementById('mode-duration'); var divFix = document.getElementById('mode-fixed'); if (mode === 'duration') { btnDur.className = "flex-1 py-1.5 text-xs font-bold rounded-md bg-white shadow-sm text-[#006241]"; btnFix.className = "flex-1 py-1.5 text-xs font-bold rounded-md text-gray-400 hover:bg-white/50"; divDur.classList.remove('hidden'); divFix.classList.add('hidden'); document.getElementById('final_duration_minutes').value = 60; } else { btnFix.className = "flex-1 py-1.5 text-xs font-bold rounded-md bg-white shadow-sm text-[#006241]"; btnDur.className = "flex-1 py-1.5 text-xs font-bold rounded-md text-gray-400 hover:bg-white/50"; divFix.classList.remove('hidden'); divDur.classList.add('hidden'); var now = new Date(); now.setMinutes(now.getMinutes() + 90); var hh = ("0" + now.getHours()).slice(-2); var mm = ("0" + now.getMinutes()).slice(-2); document.getElementById('custom_end_time').value = `${hh}:${mm}`; calculateDurationFromTime(); } }
function selectDuration(minutes, btn) { document.getElementById('final_duration_minutes').value = minutes; document.querySelectorAll('.duration-btn').forEach(el => el.className = "duration-btn bg-white border border-gray-200 text-gray-600 font-bold py-2 rounded-lg text-xs hover:bg-gray-100"); btn.className = "duration-btn bg-[#006241] text-white border border-[#006241] font-bold py-2 rounded-lg text-xs shadow-md"; }
function calculateDurationFromTime() { var timeStr = document.getElementById('custom_end_time').value; if (!timeStr) return; var now = new Date(); var parts = timeStr.split(':'); var end = new Date(); end.setHours(parseInt(parts[0]), parseInt(parts[1]), 0); var diffMins = Math.floor((end - now) / 60000); if (diffMins <= 0) { document.getElementById('calculated-time-hint').innerText = "‚ö†Ô∏è Gi·ªù v·ªÅ ph·∫£i sau gi·ªù hi·ªán t·∫°i"; document.getElementById('final_duration_minutes').value = 0; } else { document.getElementById('calculated-time-hint').innerText = `T·ªïng c·ªông: ${Math.floor(diffMins/60)}h ${diffMins%60}p`; document.getElementById('final_duration_minutes').value = diffMins; } }
// ================= CUSTOMER LOOKUP =================

function normalizePhone(p){
    return String(p || "").replace(/[^0-9]/g, "");
}

function findCustomerByPhone(phone){
    const key = normalizePhone(phone);
    if(!key) return null;
    return customerMap[key] || null;
}

function checkCustomer(){
    const input = document.getElementById("walkin-phone");
    if(!input) return;

    const sdt = normalizePhone(input.value);
    const label = document.getElementById("sdt-status");

    if(!sdt){
        if(label) label.innerText = "";
        return;
    }

    const c = findCustomerByPhone(sdt);
    if(c){
        if(label){
            label.innerText = `‚úî ${c.name} ‚Äî ${c.points} ƒëi·ªÉm`;
            label.style.color = "#22c55e";
        }
    }else{
        if(label){
            label.innerText = "Kh√°ch m·ªõi";
            label.style.color = "#aaa";
        }
    }
}
// --- LOGIC GIAO DI·ªÜN MODAL CHECK-IN M·ªöI ---
let selectedDurationHours = 1; // M·∫∑c ƒë·ªãnh 1 gi·ªù

// H√†m chuy·ªÉn tab (Theo ti·∫øng / Ch·ªçn gi·ªù v·ªÅ)
function toggleTimeMode(mode) {
    const tabDur = document.getElementById('tab-duration');
    const tabEnd = document.getElementById('tab-end-time');
    const boxDur = document.getElementById('mode-duration-box');
    const boxEnd = document.getElementById('mode-endtime-box');

    if (mode === 'duration') {
        // Active Tab Duration
        tabDur.className = "flex-1 py-2 text-xs font-bold rounded-lg shadow-sm bg-white text-[#006241] transition-all";
        tabEnd.className = "flex-1 py-2 text-xs font-bold rounded-lg text-gray-500 hover:bg-gray-200 transition-all";
        boxDur.classList.remove('hidden');
        boxEnd.classList.add('hidden');
    } else {
        // Active Tab EndTime
        tabEnd.className = "flex-1 py-2 text-xs font-bold rounded-lg shadow-sm bg-white text-[#006241] transition-all";
        tabDur.className = "flex-1 py-2 text-xs font-bold rounded-lg text-gray-500 hover:bg-gray-200 transition-all";
        boxEnd.classList.remove('hidden');
        boxDur.classList.add('hidden');
    }
}

// H√†m ch·ªçn gi·ªù (1h, 2h, 3h) - ƒê·ªïi m√†u n√∫t
function selectDuration(hours) {
    selectedDurationHours = hours;
    
    // Reset m√†u t·∫•t c·∫£ n√∫t v·ªÅ tr·∫Øng
    [1, 2, 3].forEach(h => {
        const btn = document.getElementById(`btn-dur-${h}`);
        btn.className = "border border-gray-200 bg-white text-gray-600 py-2.5 rounded-xl text-sm font-bold hover:bg-gray-50 transition-all";
    });

    // T√¥ m√†u xanh cho n√∫t ƒë∆∞·ª£c ch·ªçn
    const activeBtn = document.getElementById(`btn-dur-${hours}`);
    activeBtn.className = "border border-green-600 bg-green-50 text-[#006241] py-2.5 rounded-xl text-sm font-bold shadow-sm transition-all";
}
    // --- H√ÄM X·ª¨ L√ù H·ª¶Y THEO L√ù DO ---
function submitCancelBooking(type) {
    var bookingId = window.pendingCancelId;
    if (!bookingId) return;

    var reasonText = "";
    if (type === 'customer') reasonText = "Kh√°ch b√°o h·ªßy";
    else if (type === 'store') reasonText = "The cafe 33 h·ªßy (System)";

    // ƒê√≥ng modal
    document.getElementById('modal-cancel-reason').classList.add('hidden');
    document.getElementById('loading-overlay').style.display = 'flex';

    // C·∫≠p nh·∫≠t Firebase
    db.ref('bedBookings/' + bookingId).update({
        status: 'ƒë√£ h·ªßy',
        cancelType: type, // L∆∞u lo·∫°i: 'customer' ho·∫∑c 'store'
        note: reasonText
    }, (err) => {
        document.getElementById('loading-overlay').style.display = 'none';
        if (!err) {
            openBedManager(); // Load l·∫°i danh s√°ch
        } else {
            alert("L·ªói: " + err.message);
        }
    });
}
    // =========================================================
// X·ª¨ L√ù TR·∫¢ BED & T√çNH PH√ç L·ªê GI·ªú (TH√îNG MINH)
// =========================================================
function handleBedCheckout(booking) {
    if (!booking) return;

    // 1. T√≠nh to√°n th·ªùi gian
    const now = new Date();
    
    // L·∫•y gi·ªù k·∫øt th√∫c theo l·ªãch
    let endParts = booking.end.split(':');
    let endTime = new Date();
    endTime.setHours(parseInt(endParts[0]), parseInt(endParts[1]), 0);
    
    // T√≠nh ph√∫t ch√™nh l·ªách (L·ªë bao nhi√™u ph√∫t)
    // N·∫øu diff > 0 l√† l·ªë, diff < 0 l√† tr·∫£ s·ªõm
    let diffMinutes = Math.floor((now - endTime) / 60000);

    // 2. LOGIC X·ª¨ L√ù
    if (diffMinutes <= 5) {
        // --- TR∆Ø·ªúNG H·ª¢P A: TR·∫¢ ƒê√öNG GI·ªú HO·∫∂C L·ªê √çT (< 5p) ---
        // Hi·ªán popup x√°c nh·∫≠n tr·∫£ bed b√¨nh th∆∞·ªùng
        showIOSConfirm(`X√°c nh·∫≠n tr·∫£ Bed 0${booking.bedId}?`, () => {
            processCheckoutFirebase(booking);
        });
    } else {
        // --- TR∆Ø·ªúNG H·ª¢P B: L·ªê GI·ªú (> 5p) -> T√çNH TI·ªÄN ---
        
        // T√≠nh s·ªë gi·ªù ph·∫£i thu th√™m (L√†m tr√≤n l√™n: 6p -> 1h, 65p -> 2h)
        let extraHoursQty = Math.ceil(diffMinutes / 60);
        
        // T√≠nh th·ªùi gian kh√°ch ƒê√É MUA tr∆∞·ªõc ƒë√≥ (ƒë·ªÉ bi·∫øt ƒëang ·ªü gi·ªù th·ª© m·∫•y)
        // V√≠ d·ª•: ƒê·∫∑t 2h30p -> H·ªá th·ªëng t√≠nh l√† 3h (Math.ceil)
        let startParts = booking.start.split(':');
        let startTime = new Date();
        startTime.setHours(parseInt(startParts[0]), parseInt(startParts[1]), 0);
        
        // T·ªïng ph√∫t ƒë√£ ƒë·∫∑t ban ƒë·∫ßu
        let bookedMinutes = (endTime - startTime) / 60000;
        // Quy ƒë·ªïi ra gi·ªù ƒë√£ tr·∫£ ti·ªÅn (V√≠ d·ª• 2.5h -> 3h)
        let paidHours = Math.ceil(bookedMinutes / 60);

        let msg = `‚ö†Ô∏è KH√ÅCH QU√Å GI·ªú: ${diffMinutes} PH√öT\n\nH·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông c·ªông th√™m ${extraHoursQty} gi·ªù v√†o Bill.\n(B·∫•m ƒê·ªìng √Ω ƒë·ªÉ chuy·ªÉn sang Menu)`;

        showIOSConfirm(msg, () => {
            // --- THU·∫¨T TO√ÅN T·ª∞ ƒê·ªòNG CH·ªåN M√ìN (1h th∆∞·ªùng vs 1h t·ª´ h5) ---
            
            // Duy·ªát qua t·ª´ng gi·ªù l·ªë ƒë·ªÉ xem n√≥ thu·ªôc khung gi√° n√†o
            for (let i = 1; i <= extraHoursQty; i++) {
                // Gi·ªù hi·ªán t·∫°i ƒëang t√≠nh = Gi·ªù ƒë√£ tr·∫£ + Gi·ªù l·ªë th·ª© i
                let currentHourIndex = paidHours + i;

                if (currentHourIndex <= 4) {
                    // N·∫øu l√† gi·ªù th·ª© 4 tr·ªü xu·ªëng -> Gi√° th∆∞·ªùng
                    autoAddMenuItemToCart("1h bed"); 
                } else {
                    // N·∫øu l√† gi·ªù th·ª© 5 tr·ªü l√™n -> Gi√° cao
                    autoAddMenuItemToCart("1h bed t·ª´ h5");
                }
            }
            activeOrderingBedId = booking.bedId;
        pendingBedOrder = booking; 
        
        isCheckoutFlow = true; // <--- QUAN TR·ªåNG: B·∫¨T C·ªú HI·ªÜU L√äN!
        var sdtInput = document.getElementById('kh-sdt');
        if (sdtInput && booking.phone) {
            sdtInput.value = booking.phone;
            // G·ªçi h√†m checkSdtLive ƒë·ªÉ hi·ªán t√™n kh√°ch & ƒëi·ªÉm t√≠ch l≈©y
            if (typeof checkSdtLive === 'function') checkSdtLive();
        }
        
        // C·∫≠p nh·∫≠t giao di·ªán gi·ªè h√†ng
        switchView('menu');
        
        setTimeout(() => {
            showAppModal("ƒê√£ t√≠nh ph√≠ l·ªë gi·ªù", `ƒê√£ th√™m ${extraHoursQty}h v√†o h√≥a ƒë∆°n. Vui l√≤ng ki·ªÉm tra v√† thanh to√°n!`, "üí∞");
        }, 300);
            });
}
}

// H√†m ph·ª•: T√¨m m√≥n trong menu v√† n√©m v√†o gi·ªè
function autoAddMenuItemToCart(itemName) {
    // T√¨m m√≥n trong m·∫£ng menu to√†n c·ª•c
    // (L∆∞u √Ω: So s√°nh ch·ªØ th∆∞·ªùng ƒë·ªÉ tr√°nh l·ªói vi·∫øt hoa/th∆∞·ªùng)
    const item = menu.find(m => m.name.toLowerCase() === itemName.toLowerCase());
    
    if (item) {
        // N·∫øu th·∫•y -> Th√™m v√†o gi·ªè (d√πng h√†m addToCart c√≥ s·∫µn c·ªßa b√†)
        // item.priceM ho·∫∑c priceL tu·ª≥ b√† set trong menu, ·ªü ƒë√¢y tui l·∫•y ƒë·∫°i priceM
        let price = item.priceM > 0 ? item.priceM : item.priceL;
        addToCart(item.name, 'M', price); 
    } else {
        console.warn(`Kh√¥ng t√¨m th·∫•y m√≥n "${itemName}" trong Menu! Ki·ªÉm tra l·∫°i t√™n m√≥n.`);
    }
}

// H√†m ph·ª•: G·ªçi Firebase checkout (T√°ch ra t·ª´ code c≈© cho g·ªçn)
function processCheckoutFirebase(booking) {
    let btnCheckout = document.getElementById('btn-action-checkout');
    if(btnCheckout) btnCheckout.innerHTML = 'Wait...';
    
    let bookingId = booking.id || booking.key;
    
    db.ref('bedBookings/' + bookingId).update({
        status: 'ƒë√£ xong',
        realEndTime: new Date().toLocaleTimeString('en-GB')
    }, (err) => { 
        if(!err) openBedManager(); 
        else {
            alert("L·ªói: " + err.message);
            if(btnCheckout) btnCheckout.innerHTML = '<span>üèÅ Tr·∫£ Bed</span>';
        }
    }); 
}
// --- H√ÄM V·∫º N√öT CH·ªåN BED (KH√îI PH·ª§C) ---
// --- H√ÄM V·∫º N√öT CH·ªåN BED (PHI√äN B·∫¢N IOS PREMIUM) ---
// --- H√ÄM V·∫º N√öT CH·ªåN BED (LAYOUT CHU·∫®N: 1 TR√äN 2, 3 B√äN PH·∫¢I 1) ---
// --- M√ÄU M·ªöI: T∆Ø∆†I T·∫ÆN H∆†N  ---
// --- H√ÄM V·∫º N√öT CH·ªåN BED (STYLE: N·ªÄN TR·∫ÆNG - CH·ªÆ XANH T∆Ø∆†I #006241) ---
function renderBedSelection() {
    var container = document.getElementById('bed-selection-container');
    if (!container) return;
    
    container.innerHTML = ""; // X√≥a tr·∫Øng c≈©

    // Th·ª© t·ª± v·∫Ω: 1 -> 3 -> 2 -> 4 (C·ªôt tr√°i: 1 tr√™n 2, C·ªôt ph·∫£i: 3 tr√™n 4)
    var orderMap = [1, 3, 2, 4];

    orderMap.forEach(i => {
        // Ki·ªÉm tra tr·∫°ng th√°i Bed
        var isBusy = currentBedList.find(b => 
            b.bedId == i && b.status && (b.status.includes('active') || b.status.includes('ƒëang d√πng'))
        );

        var btnHTML = "";

        if (isBusy) {
            // === TR·∫†NG TH√ÅI B·∫¨N (X√°m nh·∫°t) ===
            btnHTML = `
            <div class="relative w-full h-full">
                <button disabled class="w-full h-full bg-[#F3F4F6] rounded-2xl p-3 flex flex-col items-center justify-center border border-gray-200 cursor-not-allowed opacity-60 grayscale transition-all">
                    <div class="w-10 h-10 bg-gray-200 text-gray-400 rounded-full flex items-center justify-center mb-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                    </div>
                    <span class="font-bold text-gray-400 text-sm">BED 0${i}</span>
                    <span class="text-[9px] text-gray-400 font-bold uppercase tracking-wider bg-gray-200 px-2 py-0.5 rounded-full mt-1">ƒêang b·∫≠n</span>
                </button>
            </div>
            `;
        } else {
            // === TR·∫†NG TH√ÅI TR·ªêNG (N·ªÄN TR·∫ÆNG - CH·ªÆ XANH T∆Ø∆†I #006241) ===
            btnHTML = `
            <button onclick="finalizeBedCheckIn(${i})" class="w-full h-full bg-white rounded-2xl p-3 flex flex-col items-center justify-center shadow-[0_4px_15px_rgba(0,0,0,0.05)] border-2 border-transparent hover:border-[#006241]/30 active:scale-[0.97] active:shadow-sm transition-all duration-200 group relative overflow-hidden">
                
                <div class="absolute inset-0 bg-[#006241] opacity-0 group-hover:opacity-[0.03] transition-opacity"></div>
                
                <div class="w-11 h-11 bg-[#E6F4F1] text-[#006241] rounded-full flex items-center justify-center mb-1 shadow-sm group-hover:scale-110 transition-transform duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                </div>
                
                <span class="font-black text-[#006241] text-lg group-hover:text-[#004f32] transition-colors">BED 0${i}</span>
                
                <span class="text-[9px] text-[#006241] font-bold uppercase tracking-wider bg-[#E6F4F1] px-2.5 py-0.5 rounded-full mt-1">
                    S·∫µn s√†ng
                </span>
            </button>
            `;
        }

        container.innerHTML += btnHTML;
    });
}
// --- H√ÄM T√çNH T·ªîNG CHI TI√äU C·ª¶A 1 L·∫¶N BED ---
// --- H√ÄM T√çNH TI·ªÄN (CHU·∫®N X√ÅC THEO KHUNG GI·ªú) ---
function calculateSessionSpend(phone, startTimeStr, endTimeStr) {
    return new Promise((resolve) => {
        if (!startTimeStr || !endTimeStr) { resolve(0); return; }

        // 1. T·∫°o ƒë·ªëi t∆∞·ª£ng Date cho Start/End (Gi·∫£ ƒë·ªãnh l√† h√¥m nay ho·∫∑c ng√†y trong booking)
        // V√¨ data booking c√≥ th·ªÉ thi·∫øu ng√†y, ta l·∫•y ng√†y hi·ªán t·∫°i l√†m m·ªëc so s√°nh gi·ªù
        var now = new Date();
        
        var startParts = startTimeStr.split(':');
        var startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(startParts[0]), parseInt(startParts[1]), 0);

        var endParts = endTimeStr.split(':');
        var endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(endParts[0]), parseInt(endParts[1]), 59); // Th√™m gi√¢y cho ch·∫Øc

        // N·∫øu qua ƒë√™m (End < Start), c·ªông th√™m 1 ng√†y cho End
        if (endDate < startDate) endDate.setDate(endDate.getDate() + 1);

        // 2. Qu√©t ƒë∆°n h√†ng
        db.ref('orders').once('value', snap => {
            let total = 0;
            if (snap.exists()) {
                const orders = snap.val();
                Object.values(orders).forEach(o => {
                    // Check SƒêT
                    if (normalizePhone(o.sdt) === normalizePhone(phone)) {
                        // Check Th·ªùi gian t·∫°o ƒë∆°n
                        var orderDate = new Date(o.createdAt);
                        
                        // Logic so s√°nh: ƒê∆°n h√†ng ph·∫£i n·∫±m TRONG kho·∫£ng Start -> End
                        // (Th√™m buffer 5 ph√∫t tr∆∞·ªõc/sau ƒë·ªÉ tr·ª´ hao sai l·ªách)
                        var bufferStart = new Date(startDate.getTime() - 5*60000); 
                        var bufferEnd = new Date(endDate.getTime() + 5*60000);

                        if (orderDate >= bufferStart && orderDate <= bufferEnd) {
                            total += Number(o.total || 0);
                        }
                    }
                });
            }
            resolve(total);
        });
    });
}

// --- H√ÄM PH·∫†T PH√ç V·ªÜ SINH (L∆ØU N·ª¢) ---
function setCleaningFee(phone, amount, bookingId) {
    if (!phone) return alert("Kh√¥ng t√¨m th·∫•y SƒêT kh√°ch!");
    
    // 1. L∆∞u n·ª£ v√†o th√¥ng tin kh√°ch h√†ng (customers/SDT/pendingFee)
    db.ref('customers/' + normalizePhone(phone)).update({
        pendingFee: amount, // S·ªë ti·ªÅn n·ª£
        pendingFeeReason: "Ph√≠ v·ªá sinh n·ªám (L·∫ßn tr∆∞·ªõc)" // L√Ω do
    }, (error) => {
        if (error) alert("L·ªói: " + error.message);
        else {
            // 2. C·∫≠p nh·∫≠t giao di·ªán b√°o ƒë√£ l∆∞u
            let statusEl = document.getElementById(`fee-status-${bookingId}`);
            if(statusEl) {
                statusEl.innerText = `ƒê√£ l∆∞u n·ª£ ${amount.toLocaleString()}ƒë cho l·∫ßn sau.`;
                statusEl.classList.remove('text-gray-400');
                statusEl.classList.add('text-green-600', 'font-bold');
            }
            
            // 3. (Tu·ª≥ ch·ªçn) ƒê√°nh d·∫•u v√†o booking c≈© l√† ƒë√£ b·ªã ph·∫°t
            db.ref('bedBookings/' + bookingId).update({
                hasPenalty: true,
                penaltyAmount: amount
            });
        }
    });
}
// =========================================================
// C√ÅC H√ÄM X·ª¨ L√ù PH√ç V·ªÜ SINH (B·ªä THI·∫æU)
// =========================================================

// Bi·∫øn t·∫°m ƒë·ªÉ nh·ªõ ƒëang ph·∫°t ai
var pendingFeePhone = "";
var pendingFeeBookingId = "";

// 1. H√†m m·ªü Modal ch·ªçn ph√≠ (ƒê∆∞·ª£c g·ªçi khi b·∫•m n√∫t ch·ªïi/v·ªá sinh)
function openCleaningModal(phone, bookingId) {
    console.log("M·ªü modal ph·∫°t cho:", phone); 
    pendingFeePhone = phone;
    pendingFeeBookingId = bookingId;
    
    var modal = document.getElementById('modal-cleaning-fee');
    if(modal) {
        modal.classList.remove('hidden');
        // Th√™m animation nh·∫π cho ƒë·∫πp
        modal.querySelector('div').classList.add('scale-100');
        modal.querySelector('div').classList.remove('scale-95');
    } else {
        alert("L·ªói: Kh√¥ng t√¨m th·∫•y Modal HTML ID 'modal-cleaning-fee'. Vui l√≤ng ki·ªÉm tra l·∫°i code HTML.");
    }
}

// 2. H√†m x√°c nh·∫≠n ph√≠ (ƒê∆∞·ª£c g·ªçi khi ch·ªçn 20k/30k/50k)
// --- 1. X√ÅC NH·∫¨N V√Ä G·ª¨I PH√ç (C√ì POPUP CONFIRM) ---
function submitCleaningFee(amount) {
    if (!pendingFeePhone) return;
    
    // ƒê√≥ng modal ch·ªçn ti·ªÅn tr∆∞·ªõc
    document.getElementById('modal-cleaning-fee').classList.add('hidden');
    
    // Hi·ªán Popup x√°c nh·∫≠n ki·ªÉu Apple (IOS Confirm)
    showIOSConfirm(`X√°c nh·∫≠n t√≠nh ph√≠ ${amount.toLocaleString()}ƒë cho kh√°ch n√†y?`, function() {
        setCleaningFee(pendingFeePhone, amount, pendingFeeBookingId);
    });
}

// --- 2. L∆ØU PH√ç V√ÄO FIREBASE (C·∫¨P NH·∫¨T C·∫¢ KH√ÅCH V√Ä BED) ---
function setCleaningFee(phone, amount, bookingId) {
    document.getElementById('loading-overlay').style.display = 'flex';

    // A. C·∫≠p nh·∫≠t n·ª£ cho kh√°ch h√†ng
    db.ref('customers/' + normalizePhone(phone)).update({
        pendingFee: amount, 
        pendingFeeReason: "Ph√≠ v·ªá sinh n·ªám"
    }, (error) => {
        if (error) {
            document.getElementById('loading-overlay').style.display = 'none';
            alert("L·ªói: " + error.message);
        } else {
            // B. ƒê√°nh d·∫•u v√†o Booking l√† "ƒê√£ b·ªã ph·∫°t" (ƒê·ªÉ hi·ªÉn th·ªã l·∫°i n√∫t X√≥a/S·ª≠a)
            db.ref('bedBookings/' + bookingId).update({
                hasPenalty: true,
                penaltyAmount: amount
            }, () => {
                document.getElementById('loading-overlay').style.display = 'none';
                
                // Load l·∫°i danh s√°ch ƒë·ªÉ giao di·ªán t·ª± c·∫≠p nh·∫≠t (Hi·ªán b·∫£ng th√¥ng b√°o ƒë·ªè)
                openBedManager(); 
                
                // Hi·ªán th√¥ng b√°o th√†nh c√¥ng
                setTimeout(() => {
                    showAppModal("ƒê√£ t√≠nh ph√≠!", `Kh√°ch s·∫Ω b·ªã t√≠nh th√™m ${amount.toLocaleString()}ƒë v√†o l·∫ßn thanh to√°n sau.`, "‚úÖ");
                }, 300);
            });
        }
    });
}

// --- 3. X√ìA PH√ç PH·∫†T (N√öT X√ìA) ---
function deletePenalty(phone, bookingId) {
    showIOSConfirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën X√ìA ph√≠ ph·∫°t n√†y ch·ª©?", function() {
        document.getElementById('loading-overlay').style.display = 'flex';

        // A. X√≥a n·ª£ c·ªßa kh√°ch (V·ªÅ 0)
        db.ref('customers/' + normalizePhone(phone)).update({
            pendingFee: 0, 
            pendingFeeReason: null
        });

        // B. C·∫≠p nh·∫≠t l·∫°i booking (H·ªßy c·ªù hasPenalty)
        db.ref('bedBookings/' + bookingId).update({
            hasPenalty: false,
            penaltyAmount: 0
        }, () => {
            document.getElementById('loading-overlay').style.display = 'none';
            openBedManager(); // Refresh giao di·ªán
            setTimeout(() => { showAppModal("ƒê√£ x√≥a!", "ƒê√£ h·ªßy b·ªè kho·∫£n ph√≠ v·ªá sinh.", "üóëÔ∏è"); }, 300);
        });
    });
}
// --- H√ÄM L·∫ÆNG NGHE TI·ªÄN V·ªÄ T·ª™ PAYOS (CH√àN M·ªöI) ---
// --- H√ÄM L·∫ÆNG NGHE TI·ªÄN V·ªÄ THEO M√É ƒê∆†N H√ÄNG (VI·∫æT L·∫†I) ---
function listenForPayment(code, amount) {
    // 1. D·ªçn d·∫πp c√°c l·ªánh l·∫Øng nghe c≈© n·∫øu c√≥
    if (paymentListener) {
        db.ref('payment_events/' + currentOrderCode).off();
    }

    console.log("üîç ƒêang ƒë·ª£i thanh to√°n cho m√£:", code);

    // 2. L·∫Øng nghe tr·ª±c ti·∫øp v√†o nh√°nh payment_events/[M√£_CF]
    // C√°ch n√†y gi√∫p POS kh√¥ng ph·∫£i qu√©t to√†n b·ªô danh s√°ch, ti·∫øt ki·ªám pin v√† nhanh h∆°n
    paymentListener = db.ref('payment_events/' + code).on('value', (snap) => {
        const data = snap.val();
        
        // N·∫øu t√¨m th·∫•y d·ªØ li·ªáu v√† s·ªë ti·ªÅn kh·ªõp ho·∫∑c d∆∞
        if (data && Number(data.amount) >= amount) {
            console.log("‚úÖ ƒê√£ nh·∫≠n ti·ªÅn:", code);
            // --- CH√àN D√íNG N√ÄY V√ÄO ƒê√ÇY ---
            speakSuccess(data.amount); 
            // -----------------------------

            // C·∫≠p nh·∫≠t giao di·ªán th√¥ng b√°o
            const statusEl = document.getElementById('qr-status');
            if(statusEl) {
                statusEl.innerHTML = `
                    <div class="flex flex-col items-center animate-bounce">
                        <span class="text-green-500 text-3xl">‚úÖ</span>
                        <span class="text-green-600 font-black text-sm uppercase">ƒê√£ nh·∫≠n ƒë·ªß ti·ªÅn</span>
                    </div>`;
            }

            // ƒê·ª£i 1.5 gi√¢y ƒë·ªÉ nh√¢n vi√™n k·ªãp th·∫•y d·∫•u t√≠ch xanh r·ªìi t·ª± ƒë·ªông ƒë√≥ng
            setTimeout(() => {
                document.getElementById('qr-modal')?.classList.add('hidden');
                
                // G·ªçi h√†m thanh to√°n m·∫∑c ƒë·ªãnh c·ªßa b√† ƒë·ªÉ l∆∞u ƒë∆°n v√†o Sheet/Firebase Orders
                if (typeof completeOrder === "function") {
                    completeOrder(); 
                }
            }, 1500);

            // T·∫Øt l·∫Øng nghe sau khi ƒë√£ xong vi·ªác
            db.ref('payment_events/' + code).off();
            paymentListener = null;
        }
    });
}
// --- H√ÄM HI·ªÇN TH·ªä QR V√Ä ƒê·ª¢I TI·ªÄN (CH√àN M·ªöI) ---
// --- H√ÄM T·∫†O QR D√ÄNH RI√äNG CHO GITHUB / WEB NGO√ÄI ---
// --- H√ÄM T·∫†O QR (B·∫¢N FIX L·ªñI ·∫¢NH B·ªä G√ÉY) ---
function showPaymentQR() {
    // 1. KI·ªÇM TRA S·ªê TI·ªÄN
    if (!currentTotal || currentTotal < 2000) {
        alert("Vui l√≤ng ch·ªçn m√≥n (T·ªëi thi·ªÉu 2.000ƒë) ƒë·ªÉ t·∫°o m√£ QR!");
        setMethod('Ti·ªÅn m·∫∑t'); 
        return;
    }

    // 2. D√ÅN LINK WEB APP C·ª¶A B√Ä V√ÄO ƒê√ÇY
    // (Nh·ªõ gi·ªØ nguy√™n c√°i link b√† ƒëang d√πng, ƒë·ª´ng x√≥a ƒëi nh√©)
    const API_URL = "https://script.google.com/macros/s/AKfycbwJ4KQT1oO5cG1xsahyZcHtmDiiTfg0FqK_pw-pSViiz_AlJXm2059Rcxst1ccqGyQYYw/exec"; 

    // Hi·ªÉn th·ªã Popup ch·ªù
    const modal = document.getElementById('qr-modal');
    modal.classList.remove('hidden');
    
    const qrImg = document.getElementById('vietqr-img');
    const qrText = document.getElementById('qr-content');
    const statusEl = document.getElementById('qr-status');
    
    // ·∫¢nh loading
    qrImg.src = "https://i.gifer.com/ZZ5H.gif"; 
    qrText.innerText = "ƒêang k·∫øt n·ªëi PayOS...";
    statusEl.innerText = "Vui l√≤ng ƒë·ª£i gi√¢y l√°t...";

    // 3. G·ªåI SERVER
    fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({
            action: "createPayment",
            amount: currentTotal
        })
    })
    .then(response => response.json())
    .then(result => {
        console.log("PayOS Result:", result);
        
        if (result.status === "success") {
            qrImg.src = "https://api.qrserver.com/v1/create-qr-code/?size=400x400&margin=10&data=" + encodeURIComponent(result.qrCode);
            currentOrderCode = result.orderCodeFull;
            qrText.innerText = currentOrderCode; 
            statusEl.innerHTML = '<b class="text-amber-500 animate-pulse">ƒêang ch·ªù thanh to√°n...</b>';
            
            listenForPayment(result.orderCodeFull, result.amount);
        } else {
            alert("L·ªói t·ª´ PayOS: " + result.message);
            modal.classList.add('hidden');
        }
    })
    .catch(error => {
        console.error("L·ªói Fetch:", error);
        alert("L·ªói k·∫øt n·ªëi! Vui l√≤ng th·ª≠ l·∫°i.");
        modal.classList.add('hidden');
    });
}
// --- H√ÄM ƒê·ªåC √ÇM THANH KHI NH·∫¨N TI·ªÄN ---
function speakSuccess(amount) {
    // 1. So·∫°n n·ªôi dung c·∫ßn ƒë·ªçc
    // D√πng toLocaleString('vi-VN') ƒë·ªÉ n√≥ ƒë·ªçc l√† "NƒÉm m∆∞∆°i ngh√¨n" thay v√¨ "5 kh√¥ng kh√¥ng..."
    var textToRead = "The Cafe 33 ƒë√£ nh·∫≠n " + Number(amount).toLocaleString('vi-VN') + " ƒë·ªìng. C·∫£m ∆°n nh√≥!";
    
    // 2. C·∫•u h√¨nh gi·ªçng ƒë·ªçc
    var msg = new SpeechSynthesisUtterance();
    msg.text = textToRead;
    msg.lang = 'vi-VN'; // Ch·ªçn gi·ªçng ti·∫øng Vi·ªát
    msg.volume = 1;     // √Çm l∆∞·ª£ng to nh·∫•t (0 -> 1)
    msg.rate = 1.1;     // T·ªëc ƒë·ªô ƒë·ªçc (1 l√† b√¨nh th∆∞·ªùng, 1.1 l√† nhanh nh·∫π vui t∆∞∆°i)
    
    // 3. Ph√°t loa
    window.speechSynthesis.speak(msg);
}
// --- BI·∫æN TO√ÄN C·ª§C ƒê·ªÇ GI·ªÆ LOA ---
let synth = window.speechSynthesis;
let soundLock = null;

// 1. H√†m ƒë·ªçc c∆° b·∫£n (Fix l·ªói gi·ªçng ch·ªã Google b·ªã k·∫πt)
function speakNow(text) {
    if (synth.speaking) synth.cancel(); // D·ª´ng c√¢u ƒëang n√≥i d·ªü

    let msg = new SpeechSynthesisUtterance(text);
    msg.lang = 'vi-VN'; 
    msg.rate = 1.1;
    msg.volume = 1.0;

    synth.speak(msg);
}

// 2. H√†m "M·ªìi loa" (G·∫Øn v√†o n√∫t Chuy·ªÉn kho·∫£n)
// M·∫πo: Ph√°t m·ªôt √¢m thanh r·ªóng li√™n t·ª•c ƒë·ªÉ tr√¨nh duy·ªát t∆∞·ªüng b√† ƒëang nghe nh·∫°c
function unlockAudio() {
    speakNow("ƒêang t·∫°o m√£ thanh to√°n"); // N√≥i c√¢u ƒë·∫ßu ti√™n ƒë·ªÉ xin quy·ªÅn
    
    // Hack: T·∫°o m·ªôt audio r·ªóng ch·∫°y n·ªÅn ƒë·ªÉ gi·ªØ k·∫øt n·ªëi loa kh√¥ng b·ªã ng·∫Øt
    if (!soundLock) {
        soundLock = new Audio("https://github.com/anars/blank-audio/raw/master/10-minutes-of-silence.mp3");
        soundLock.loop = true;
        soundLock.play().catch(e => console.log("Kh√¥ng play ƒë∆∞·ª£c audio n·ªÅn"));
    }
}

// 3. H√†m g·ªçi khi ti·ªÅn v·ªÅ
function speakSuccess(amount) {
    // D·ª´ng audio n·ªÅn l·∫°i cho ƒë·ª° t·ªën pin
    if (soundLock) {
        soundLock.pause();
        soundLock = null;
    }

    let text = "ƒê√£ nh·∫≠n " + Number(amount).toLocaleString('vi-VN') + " ƒë·ªìng. C·∫£m ∆°n!";
    speakNow(text);
}
// --- LOGIC MOBILE ---
function toggleMobileMenu() {
    const sb = document.getElementById('mobile-sidebar');
    const ol = document.getElementById('mobile-overlay');
    if (sb.classList.contains('-translate-x-full')) {
        sb.classList.remove('-translate-x-full'); ol.classList.remove('hidden');
    } else {
        sb.classList.add('-translate-x-full'); ol.classList.add('hidden');
    }
}
function toggleCartExpand() {
    if (window.innerWidth > 768) return;
    
    // Thay v√¨ m·ªü r·ªông sidebar (giao di·ªán c≈©), ta g·ªçi Modal chi ti·∫øt (Giao di·ªán m·ªõi)
    openCartModal(); 
}
// --- LOGIC CHO M√ÄN H√åNH THANH TO√ÅN MOBILE ---
function syncMobileInputs() {
    // 1. ƒê·ªìng b·ªô SƒêT
    var sdtMob = document.getElementById('pay-sdt-mobile').value;
    var sdtMain = document.getElementById('kh-sdt');
    if (sdtMain) {
        sdtMain.value = sdtMob;
        // G·ªçi h√†m ki·ªÉm tra t√™n kh√°ch c√≥ s·∫µn
        if (typeof checkSdtLive === 'function') checkSdtLive(); 
    }
    
    // Hi·ªÉn th·ªã t√™n kh√°ch ngay tr√™n mobile
    var cleanSdt = sdtMob.replace(/[^0-9]/g, '');
    var custNameEl = document.getElementById('pay-cust-name-mobile');
if (custNameEl) {
    if (customerMap[cleanSdt]) {
        custNameEl.innerHTML = `<div class="mt-3 bg-green-50 p-2 rounded-xl text-center"><span class="text-xs font-black text-green-700">‚òÖ ${customerMap[cleanSdt].name}</span></div>`;
        custNameEl.style.height = "auto"; // M·ªü r·ªông chi·ªÅu cao
    } else {
        custNameEl.innerHTML = "";
        custNameEl.style.height = "0"; // Thu g·ªçn l·∫°i
    }
}

    // 2. ƒê·ªìng b·ªô Ti·ªÅn kh√°ch ƒë∆∞a & T√≠nh ti·ªÅn th·ª´a
    var cashMob = document.getElementById('cash-paid-mobile').value;
    var cashMain = document.getElementById('cash-paid');
    
    // X·ª≠ l√Ω d·∫•u ph·∫©y (n·∫øu mu·ªën nh·∫≠p 50,000)
    var rawCash = cashMob.replace(/[^0-9]/g, '');
    
    if (cashMain) {
        cashMain.value = rawCash;
        // G·ªçi h√†m t√≠nh to√°n c≈©
        if (typeof calcChange === 'function') calcChange();
    }

    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã ti·ªÅn th·ª´a tr√™n Mobile
    var paid = Number(rawCash) || 0;
    var change = paid - currentTotal;
    var changeEl = document.getElementById('cash-change-mobile');
    if (changeEl) {
        changeEl.innerText = (change > 0 ? change.toLocaleString() : 0) + 'ƒë';
    }
}
// --- LOGIC ƒêI·ªÄU KHI·ªÇN B∆Ø·ªöC THANH TO√ÅN MOBILE ---

// 1. Chuy·ªÉn sang m√†n h√¨nh nh·∫≠p ti·ªÅn m·∫∑t (B∆∞·ªõc 2)
// 1. Chuy·ªÉn sang m√†n h√¨nh nh·∫≠p ti·ªÅn m·∫∑t (B∆∞·ªõc 2)
function goToMobileCash() {
    setMethod('Ti·ªÅn m·∫∑t'); 
    
    // ·∫®n b∆∞·ªõc 1, hi·ªán b∆∞·ªõc 2
    document.getElementById('mob-step-1').classList.add('hidden');
    document.getElementById('mob-step-2').classList.remove('hidden');
    // document.getElementById('mob-pay-title').innerText = "Thu ti·ªÅn m·∫∑t"; // C√≥ th·ªÉ b·ªè d√≤ng n√†y n·∫øu mu·ªën gi·ªØ ti√™u ƒë·ªÅ ng·∫Øn g·ªçn

    var input = document.getElementById('cash-paid-mobile');
    if(input) {
        // T·ª± ƒëi·ªÅn t·ªïng bill v√†o √¥ kh√°ch ƒë∆∞a
        input.value = currentTotal.toLocaleString('en-US'); 
        
        // T√≠nh ngay ti·ªÅn th·ª´a
        syncMobileInputs();
        
        // --- S·ª¨A L·ªñI ·ªû ƒê√ÇY ---
        // input.focus();  <-- X√ìA D√íNG N√ÄY ƒêI (N√≥ l√† th·ªß ph·∫°m g·ªçi b√†n ph√≠m)
        
        input.blur();   // <-- TH√äM D√íNG N√ÄY (Ra l·ªánh cho b√†n ph√≠m: "N·∫±m im, c·∫•m nh√∫c nh√≠ch!")
        // --------------------
    }
    
    // C·∫≠p nh·∫≠t g·ª£i √Ω ti·ªÅn
    updateSuggestions();
}

// 2. N√∫t Quay l·∫°i th√¥ng minh
function backMobileStep() {
    var step2 = document.getElementById('mob-step-2');
    
    // N·∫øu ƒëang ·ªü B∆∞·ªõc 2 (Nh·∫≠p ti·ªÅn) -> Quay v·ªÅ B∆∞·ªõc 1
    if (step2 && !step2.classList.contains('hidden')) {
        document.getElementById('mob-step-2').classList.add('hidden');
        document.getElementById('mob-step-1').classList.remove('hidden');
        document.getElementById('mob-pay-title').innerText = "Thanh to√°n";
    } else {
        // N·∫øu ƒëang ·ªü B∆∞·ªõc 1 -> Quay v·ªÅ Menu ch√≠nh
        switchView('menu');
    }
}
document.addEventListener('DOMContentLoaded', updateCartPadding);
</script>
<div id="modal-cleaning-fee" class="fixed inset-0 bg-black/40 z-[9999] hidden flex items-center justify-center p-6 backdrop-blur-[4px]">
    <div class="bg-white/95 backdrop-blur-2xl w-full max-w-[340px] rounded-[35px] shadow-[0_30px_70px_rgba(0,0,0,0.3)] text-center border border-white/60 p-8 transform scale-100 transition-all">
        
        <div class="w-14 h-14 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm border border-red-100">
            <span class="text-2xl">üßπ</span>
        </div>
        
        <h3 class="text-lg font-black text-gray-800 uppercase tracking-wide mb-1">Ph√≠ V·ªá Sinh</h3>
        <p class="text-[11px] text-gray-400 font-bold uppercase tracking-wider mb-6">Ch·ªçn m·ª©c ph√≠ l∆∞u n·ª£ l·∫ßn sau</p>

        <div class="grid grid-cols-3 gap-3 mb-6">
            <button onclick="submitCleaningFee(20000)" class="py-4 bg-white border border-gray-100 rounded-[20px] text-gray-700 font-black text-xs shadow-sm active:scale-95 transition-all hover:border-red-500 hover:text-red-500 hover:shadow-md">
                20K
            </button>
            <button onclick="submitCleaningFee(30000)" class="py-4 bg-white border border-gray-100 rounded-[20px] text-gray-700 font-black text-xs shadow-sm active:scale-95 transition-all hover:border-red-500 hover:text-red-500 hover:shadow-md">
                30K
            </button>
            <button onclick="submitCleaningFee(50000)" class="py-4 bg-white border border-gray-100 rounded-[20px] text-gray-700 font-black text-xs shadow-sm active:scale-95 transition-all hover:border-red-500 hover:text-red-500 hover:shadow-md">
                50K
            </button>
        </div>

        <button onclick="document.getElementById('modal-cleaning-fee').classList.add('hidden')" 
            class="text-gray-400 font-bold text-xs hover:text-gray-600 underline decoration-dashed underline-offset-4">
            ƒê√≥ng
        </button>
    </div>
</div>
<div id="ios-confirm-modal" class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-black/30 backdrop-blur-[4px] transition-opacity duration-300 p-6">
    <div class="bg-white/90 backdrop-blur-2xl w-full max-w-[320px] rounded-[35px] shadow-[0_20px_60px_rgba(0,0,0,0.2)] text-center overflow-hidden border border-white/40">
        
        <div class="p-8 pb-6">
            <h3 class="text-xl font-black text-[#006241] mb-2 tracking-wide">X√°c Nh·∫≠n</h3>
            <p id="ios-modal-message" class="text-sm text-gray-600 font-medium leading-relaxed">
                N·ªôi dung x√°c nh·∫≠n...
            </p>
        </div>

        <div class="grid grid-cols-2 gap-0 border-t border-gray-200/50 bg-white/50">
            <button onclick="closeIOSModal()" 
                class="py-5 text-sm text-gray-500 font-bold hover:bg-gray-100 transition-colors border-r border-gray-200/50">
                H·ªßy b·ªè
            </button>
            <button id="ios-confirm-btn" 
                class="py-5 text-sm text-[#006241] font-black hover:bg-green-50 transition-colors">
                ƒê·ªìng √Ω
            </button>
        </div>
    </div>
</div>
<div id="qr-modal" class="fixed inset-0 bg-black/80 z-[100000] hidden flex items-center justify-center p-6 backdrop-blur-md">
    <div class="bg-white rounded-[30px] p-8 max-w-sm w-full text-center shadow-2xl relative">
        <button onclick="document.getElementById('qr-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 text-2xl">‚úï</button>
        <h3 class="text-[#006241] font-black text-xl uppercase mb-6">Qu√©t m√£ thanh to√°n</h3>
        <img id="vietqr-img" src="" class="w-64 h-64 mx-auto mb-4 rounded-xl border border-gray-100">
        <div class="bg-yellow-50 p-3 rounded-xl mb-4">
            <p class="text-[10px] text-gray-500 font-bold uppercase">N·ªôi dung chuy·ªÉn kho·∫£n</p>
            <p id="qr-content" class="text-xl font-black text-[#006241]">--</p>
        </div>
        <div id="qr-status" class="text-gray-400 font-bold text-xs animate-pulse">ƒêang ƒë·ª£i ti·ªÅn v·ªÅ...</div>
    </div>
</div>
<div id="modal-cancel-reason" class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-black/30 backdrop-blur-[4px] transition-opacity duration-300 p-6">
    <div class="bg-white/95 backdrop-blur-xl w-full max-w-[340px] rounded-[35px] shadow-[0_30px_70px_rgba(0,0,0,0.25)] text-center transform scale-100 transition-all border border-white/50 p-8">
        
        <div class="w-14 h-14 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm border border-red-100">
            <span class="text-2xl">üóëÔ∏è</span>
        </div>
        
        <h3 class="text-lg font-black text-gray-800 uppercase tracking-wide mb-1">H·ªßy L·ªãch N√†y?</h3>
        <p class="text-[11px] text-gray-400 font-bold uppercase tracking-wider mb-6">Vui l√≤ng ch·ªçn l√Ω do h·ªßy</p>

        <div class="space-y-3 mb-6">
            <button onclick="submitCancelBooking('customer')" 
                class="w-full py-4 bg-white border border-gray-100 rounded-[20px] text-gray-700 font-bold text-xs uppercase shadow-sm active:scale-95 transition-all hover:border-[#006241] hover:text-[#006241] hover:shadow-md flex items-center justify-center gap-2">
                <span>üë§</span> Kh√°ch b√°o h·ªßy
            </button>
            <button onclick="submitCancelBooking('store')" 
                class="w-full py-4 bg-white border border-gray-100 rounded-[20px] text-gray-700 font-bold text-xs uppercase shadow-sm active:scale-95 transition-all hover:border-[#006241] hover:text-[#006241] hover:shadow-md flex items-center justify-center gap-2">
                <span>üè™</span> Qu√°n h·ªßy (System)
            </button>
        </div>

        <button onclick="document.getElementById('modal-cancel-reason').classList.add('hidden')" 
            class="text-gray-400 font-bold text-xs hover:text-gray-600 underline decoration-dashed underline-offset-4">
            ƒê√≥ng, kh√¥ng h·ªßy n·ªØa
        </button>
    </div>
</div>
    <div id="mobile-bottom-bar" class="hidden md:hidden fixed bottom-6 left-4 right-4 h-24 bg-white/90 backdrop-blur-xl rounded-[3rem] shadow-[0_10px_40px_rgba(0,0,0,0.1)] border border-white/60 flex items-center justify-between p-2 z-[9000] transition-all duration-300">
    
    <div onclick="openCartModal()" class="flex-1 h-full pl-6 flex flex-col justify-center cursor-pointer group">
        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-0.5 group-active:text-[#006241]">T·ªïng t·∫°m t√≠nh</p>
        <div class="flex items-center gap-2">
            <p id="mob-bar-total" class="brand-font text-2xl text-[#1e3932] font-black tracking-tight">0ƒë</p>
            <span class="text-[10px] font-bold text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full group-active:bg-green-100 group-active:text-[#006241]">^</span>
        </div>
    </div>

    <button onclick="switchView('payment')" class="h-full px-10 bg-[#006241] text-white rounded-[2.5rem] font-bold uppercase text-xs shadow-lg active:scale-95 transition-all flex items-center gap-2 hover:bg-[#004f32]">
        <span>Thanh to√°n</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
        </svg>
    </button>
</div>
</body>
</html>

















