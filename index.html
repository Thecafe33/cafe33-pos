<!DOCTYPE html>
<html>
<head>
  <title>The cafe 33</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#006241">
  
  <link rel="icon" href="https://i.ibb.co/nqdTWnvt/N-u-v-N-u-v-ng-Ngh-thu-t-s-p-ch-In-m-Ti-m-c-ph-Bi-u-tr-ng-C-ph-20260121-210413-0000.png">
  <link rel="apple-touch-icon" href="https://i.ibb.co/nqdTWnvt/N-u-v-N-u-v-ng-Ngh-thu-t-s-p-ch-In-m-Ti-m-c-ph-Bi-u-tr-ng-C-ph-20260121-210413-0000.png">
  
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-database-compat.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=League+Spartan:wght@700;800&display=swap" rel="stylesheet">
  
  <style>
    /* GI·ªÆ NGUY√äN CSS C≈® [cite: 6034-6062] */
    html, body {
      overscroll-behavior-y: none;
      touch-action: pan-x pan-y;
      margin: 0; padding: 0; height: 100%; width: 100%;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      background-color: #f8f9fa;
      font-family: 'Inter', sans-serif;
      color: #1e3932;
      text-align: left;
      -webkit-font-smoothing: antialiased;
      overflow-y: auto;
    }
    .brand-font { font-family: 'League Spartan', sans-serif; font-weight: 800; letter-spacing: -0.01em; }
    .sb-green { background-color: #006241; }
    .card-gradient { background: linear-gradient(135deg, #004d33 0%, #006241 100%); }
    .nav-active { color: #006241; font-weight: 800; background-color: rgba(0, 98, 65, 0.05); border-radius: 1.5rem; }
    .tab-content { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    #custom-modal, #image-overlay { transition: all 0.3s ease; }
    .modal-enter { opacity: 0; transform: scale(0.9); }
    .modal-show { opacity: 1; transform: scale(1); }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #D1D1D6; border-radius: 10px; }
  </style>
  <style>
    /* CSS RI√äNG CHO THANH MENU APPLE (STYLE TINH T·∫æ - GI·ªêNG ·∫¢NH M·∫™U) */
    .nav-item {
        color: #9CA3AF; /* M√†u x√°m khi ch∆∞a ch·ªçn */
        border: 1px solid transparent; 
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Hi·ªáu ·ª©ng chuy·ªÉn ƒë·ªông m∆∞·ª£t */
    }

    /* Khi ƒëang ch·ªçn (Active): N·ªÄN TR·∫ÆNG + B√ìNG ƒê·ªî + √ÅNH S√ÅNG */
    .nav-item.active {
        background-color: #ffffff !important; /* N·ªÅn tr·∫Øng t·ªáp v·ªõi bar */
        
        /* K·ªπ thu·∫≠t ƒë·ªï b√≥ng cao c·∫•p: 
           1. Inset tr·∫Øng: T·∫°o √°nh s√°ng vi·ªÅn tr√™n
           2. Shadow ngo√†i: T·∫°o ƒë·ªô n·ªïi nh·∫π nh√†ng 
        */
        box-shadow: 
            inset 0 1px 2px rgba(255, 255, 255, 1), 
            0 4px 15px rgba(0, 0, 0, 0.08),
            0 1px 3px rgba(0, 0, 0, 0.05) !important;
            
        border: 1px solid rgba(243, 244, 246, 0.8) !important; /* Vi·ªÅn x√°m si√™u m·ªù ƒë·ªÉ t√°ch bi·ªát */
        transform: translateY(-4px); /* N·ªïi l√™n cao h∆°n ch√∫t n·ªØa */
    }

    /* ƒê·ªïi m√†u Icon th√†nh Xanh khi ch·ªçn */
    .nav-item.active svg {
        stroke: #006241 !important;
        /* Th√™m t√≠ b√≥ng cho Icon n√≥ s√¢u h∆°n */
        filter: drop-shadow(0 2px 2px rgba(0, 98, 65, 0.15));
        fill: transparent !important; /* Kh√¥ng t√¥ m√†u n·ªÅn icon n·ªØa cho tinh t·∫ø */
    }
    
    .nav-item.active span {
        color: #006241 !important;
        font-weight: 800;
    }
    /* CSS G·ª¢I √ù TH√îNG MINH - THE CAFE 33 */
/* CSS G·ª¢I √ù TH√îNG MINH - THE CAFE 33 (PREMIUM) */
.suggestion-box {
    background: #ffffff; 
    border: 1px solid #f3f4f6; 
    border-radius: 16px; 
    margin-bottom: 12px; 
    padding: 14px;
    position: relative;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.suggestion-box:active {
    border-color: #006241; 
    background-color: #f0fdf9;
    transform: scale(0.98);
}
.suggestion-left { display: flex; flex-direction: column; gap: 4px; }
.suggestion-time { 
    font-weight: 800; 
    color: #1e3932; 
    font-size: 16px; 
    font-family: 'Inter', sans-serif;
    line-height: 1.2;
}
.suggestion-note {
    font-size: 11px;
    color: #6b7280;
    font-weight: 500;
}
.suggestion-bonus-badge {
    font-size: 10px;
    color: #b45309; /* M√†u h·ªï ph√°ch ƒë·∫≠m */
    background: #fffbeb;
    padding: 6px 10px;
    border-radius: 8px;
    font-weight: 700;
    margin-top: 6px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    border: 1px dashed #fcd34d;
    width: fit-content;
}
.btn-pick-now { 
    font-size: 10px; 
    font-weight: 800; 
    text-transform: uppercase;
    color: white; 
    background: linear-gradient(135deg, #006241 0%, #004d33 100%);
    padding: 10px 16px; 
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,98,65,0.2);
    white-space: nowrap;
}
    /* --- CSS FORM ƒêƒÇNG K√ù (DYNAMIC ISLAND) --- */
.input-island {
    background-color: #F3F4F6; border-radius: 99px; padding: 12px 24px;
    border: 2px solid transparent; transition: all 0.3s ease; display: flex; 
    flex-direction: column; margin-bottom: 16px; text-align: left;
}
.input-island:focus-within {
    background-color: #FFFFFF; border-color: #006241; box-shadow: 0 4px 20px -4px rgba(0,98,65,0.2);
}
.input-island-label {
    font-size: 11px; font-weight: 800; color: #9CA3AF;
    text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 2px;
}
.input-island-field {
    background: transparent; border: none; outline: none;
    font-size: 17px; font-weight: 700; color: #1F2937; width: 100%;
}
.input-island-field::placeholder { color: #D1D5DB; font-weight: 500; }

   /* --- CSS CHO TRANG CH·ª¶ (SLIDER & BANNER) --- */
.hide-scroll::-webkit-scrollbar { display: none; }
.hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
.mask-gradient-left {
    -webkit-mask-image: linear-gradient(to left, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 100%);
    mask-image: linear-gradient(to left, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 100%);
}
.snap-x-mandatory { scroll-snap-type: x mandatory; }
.snap-center { scroll-snap-align: center; } 

    /* Hi·ªáu ·ª©ng nh√∫n nh·∫£y ch·∫≠m */
@keyframes bounce-slow {
  0%, 100% { transform: translateY(-3%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
  50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
}
.animate-bounce-slow {
  animation: bounce-slow 3s infinite;
}

/* Hi·ªáu ·ª©ng xoay ch·∫≠m cho hoa */
.animate-spin-slow {
    animation: spin 8s linear infinite;
}
</style>
</head>
<body class="min-h-screen pb-32">

  <div id="loading-overlay" class="fixed inset-0 bg-white/95 z-[9999] hidden flex flex-col items-center justify-center backdrop-blur-sm">
    <div class="w-14 h-14 border-4 border-[#006241] border-t-transparent rounded-full animate-spin mb-4"></div>
    <p class="brand-font text-[#006241] text-xl font-black animate-pulse">The cafe 33</p>
    <p class="text-xs text-gray-400 font-bold mt-2" id="loading-text">ƒêang k·∫øt n·ªëi...</p>
  </div>

  <div id="image-overlay" class="fixed inset-0 bg-black/95 z-[200] hidden flex flex-col items-center justify-center p-4 backdrop-blur-md">
    <button onclick="document.getElementById('image-overlay').classList.add('hidden')" class="absolute top-8 right-8 text-white text-5xl font-light">&times;</button>
    <div class="w-full h-full flex items-center justify-center overflow-auto"><img id="zoomed-img" src="" class="max-w-full max-h-full object-contain shadow-2xl transition-transform" onclick="event.stopPropagation()"></div>
  </div>

  <div id="modal-overlay" class="fixed inset-0 bg-black/40 z-[100] hidden flex items-center justify-center p-6 backdrop-blur-sm">
    <div id="custom-modal" class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl text-center modal-enter">
      <div id="modal-icon" class="text-5xl mb-4">‚òï</div>
      <h3 id="modal-title" class="brand-font text-2xl text-[#006241] mb-3">Th√¥ng b√°o</h3>
      <div id="modal-message" class="text-lg text-[#1e3932] font-bold mb-8 leading-relaxed brand-font"></div>
      <div id="modal-actions" class="flex flex-col gap-3">
        <button id="modal-btn-main" class="w-full py-4 sb-green text-white font-bold rounded-2xl uppercase tracking-widest text-xs shadow-lg">ƒê·ªìng √Ω</button>
        <button id="modal-btn-sub" class="w-full py-4 text-gray-400 font-bold rounded-2xl uppercase tracking-widest text-[10px] hidden">H·ªßy b·ªè</button>
      </div>
    </div>
  </div>

  <div id="login-screen" class="flex flex-col items-center justify-center min-h-screen p-8 bg-white text-center">
    <h1 class="text-5xl text-[#006241] mb-4 brand-font">The cafe 33</h1>
    <p class="text-[11px] font-bold text-gray-400 mb-12 uppercase tracking-widest">T√≠ch ƒëi·ªÉm nh·∫≠n ƒë·∫∑c quy·ªÅn</p>
    <input type="tel" id="login-sdt" placeholder="S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n..." class="w-full p-5 rounded-3xl bg-gray-50 border border-gray-100 mb-4 text-center outline-none text-lg">
    <button id="btn-login" onclick="login()" class="w-full p-5 rounded-3xl sb-green text-white font-bold shadow-md active:scale-95 transition-all uppercase text-lg">ƒêƒÉng nh·∫≠p</button>
    <p class="mt-6 text-sm text-gray-400 font-medium">Ch∆∞a c√≥ t√†i kho·∫£n?</p>
<button onclick="showRegister()" class="text-[#006241] font-bold text-sm uppercase tracking-widest hover:underline py-2">
    ƒêƒÉng k√Ω th√†nh vi√™n m·ªõi
</button>
  </div>
<div id="register-screen" class="hidden flex-col min-h-screen p-8 bg-white text-center">
    <div class="pt-2 mb-6 text-left">
        <button onclick="hideRegister()" class="w-10 h-10 -ml-2 flex items-center justify-center rounded-full active:bg-gray-100 text-gray-500 hover:text-[#006241] transition-colors">
            <span class="material-symbols-rounded text-3xl text-2xl font-bold"><</span> 
        </button>
    </div>

    <h2 class="text-3xl font-bold text-gray-900 mb-2 text-left brand-font text-[#006241]">T·∫°o t√†i kho·∫£n</h2>
    <p class="text-gray-500 mb-8 text-left text-sm">Nh·∫≠p th√¥ng tin ƒë·ªÉ t√≠ch ƒëi·ªÉm ngay.</p>

    <div class="flex-1">
        <div class="input-island group">
            <label class="input-island-label">H·ªç v√† t√™n</label>
            <input type="text" id="reg-name" class="input-island-field capitalize" placeholder="V√≠ d·ª•: Minh Tu·∫•n">
        </div>

        <div class="input-island group">
            <label class="input-island-label">S·ªë ƒëi·ªán tho·∫°i</label>
            <input type="tel" id="reg-phone" class="input-island-field" placeholder="090..." inputmode="numeric">
        </div>
    </div>

    <div class="mt-auto w-full pb-8">
        <button id="btn-reg-submit" onclick="submitRegister()" class="w-full p-5 rounded-3xl sb-green text-white font-bold shadow-xl active:scale-95 transition-all uppercase text-lg">
            X√°c nh·∫≠n ƒëƒÉng k√Ω
        </button>
        <p class="text-center text-[10px] text-gray-400 mt-5 font-medium uppercase tracking-wider">T·∫∑ng ngay 333 ƒëi·ªÉm khi tham gia</p>
    </div>
</div>
  <div id="main-app" class="hidden">
    <div class="p-5 bg-white shadow-sm flex justify-between items-center sticky top-0 z-50">
      <h2 class="text-2xl text-[#006241] brand-font">The cafe 33</h2>
      <div id="live-clock" class="text-[11px] font-extrabold text-[#006241] border border-gray-100 px-4 py-2 rounded-full bg-gray-50 shadow-inner">--:--</div>
    </div>
<div id="tab-home" class="pb-40 tab-content hidden bg-white h-full overflow-y-auto hide-scroll">
    
    <div class="px-6 pt-10 pb-6 bg-white sticky top-0 z-20">
        <div class="flex justify-between items-center">
            <div>
                <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest mb-1">Xin ch√†o,</p>
                <h1 class="text-[#006241] text-3xl font-black tracking-tighter capitalize" id="home-cust-name">B·∫°n m·ªõi</h1>
            </div>
            <div onclick="showTab('user')" class="flex flex-col items-center justify-center w-12 h-12 rounded-full bg-green-50 border border-green-100 text-[#006241] shadow-sm cursor-pointer active:scale-95 transition-transform">
                <span class="text-lg font-black" id="home-mini-point">0</span>
                <span class="text-[8px] font-bold">ƒëi·ªÉm</span>
            </div>
        </div>
    </div>

    <div class="px-6 flex flex-col items-center justify-center min-h-[60vh] relative">
        
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-green-100/50 rounded-full blur-3xl -z-10 pointer-events-none"></div>

        <div class="w-full max-w-[280px] mb-10 relative group">
            <img src="https://firebasestorage.googleapis.com/v0/b/the-cafe-33.firebasestorage.app/o/1770902653587.png?alt=media&token=1ce7e441-fc40-4cb2-8c88-4d673c2bb4e8" 
                 class="w-full h-auto object-contain drop-shadow-xl hover:scale-105 transition-transform duration-500 animate-bounce-slow" 
     alt="Avatar">
        </div>

        <div class="w-full max-w-sm bg-white/60 backdrop-blur-xl border border-white/50 p-8 rounded-[50px] shadow-[0_20px_40px_rgba(0,0,0,0.05)] text-center relative z-10">
            
            <h2 class="text-xl font-black text-[#006241] uppercase mb-4 tracking-tight">Ch√∫c M·ª´ng NƒÉm M·ªõi</h2>
            
            <div class="text-gray-600 font-medium text-sm leading-relaxed space-y-2">
                <p>NƒÉm con Ng·ª±a ch√∫c c·∫£ nh√† m√¨nh:</p>
                <div class="py-2">
                    <span class="inline-block px-3 py-1 bg-green-50 text-[#006241] rounded-full font-bold text-xs mb-1">Ng·ª±a Kho·∫ª</span>
                    <span class="inline-block px-3 py-1 bg-green-50 text-[#006241] rounded-full font-bold text-xs mb-1">Ng·ª±a Vui</span>
                    <span class="inline-block px-3 py-1 bg-green-50 text-[#006241] rounded-full font-bold text-xs">Ng·ª±a Ph√°t T√†i</span>
                </div>
                <p>"ƒêi ƒë√¢u c≈©ng thu·∫≠n,<br>L√†m g√¨ c≈©ng may."</p>
            </div>
            
            <div class="mt-6 opacity-30">
                <p class="text-[9px] font-black uppercase tracking-[0.3em]">The Cafe 33</p>
            </div>
        </div>

    </div>

</div>

<div id="home-detail-modal" class="fixed inset-0 z-[200] hidden flex items-center justify-center p-6 backdrop-blur-sm transition-all duration-300">
    <div onclick="closeHomePopup()" class="absolute inset-0 bg-black/40"></div>
    
    <div class="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl relative overflow-hidden animate-bounce-in z-10 flex flex-col max-h-[80vh]">
        
        <div class="h-48 w-full bg-gray-200 relative shrink-0">
            <img id="home-popup-img" src="" class="w-full h-full object-cover">
            <button onclick="closeHomePopup()" class="absolute top-4 right-4 w-10 h-10 bg-black/30 backdrop-blur-md text-white rounded-full flex items-center justify-center hover:bg-black/50 transition">‚úï</button>
        </div>

        <div class="p-6 overflow-y-auto">
            <div id="home-popup-tag" class="inline-block px-3 py-1 rounded-lg bg-green-50 text-[#006241] text-[10px] font-black uppercase mb-3">TIN T·ª®C</div>
            <h3 id="home-popup-title" class="text-2xl font-black text-[#1e3932] mb-3 leading-tight">Ti√™u ƒë·ªÅ tin t·ª©c</h3>
            <p id="home-popup-desc" class="text-sm text-gray-600 leading-relaxed">N·ªôi dung chi ti·∫øt s·∫Ω hi·ªán ·ªü ƒë√¢y...</p>
        </div>

        <div class="p-6 pt-0 mt-auto">
            <button onclick="closeHomePopup(); showTab('menu')" class="w-full py-4 bg-[#006241] text-white rounded-2xl font-bold uppercase text-xs shadow-lg active:scale-95 transition-transform">
                Xem Menu & ƒê·∫∑t Ngay
            </button>
        </div>
    </div>
</div>
    
    
    <div id="tab-user" class="p-5 tab-content pb-40">
      <div class="card-gradient p-8 rounded-[2.5rem] text-white shadow-2xl h-60 flex flex-col justify-between relative overflow-hidden mb-8 text-left">
        <div class="flex justify-between items-start z-10"><p class="text-[10px] font-bold uppercase tracking-widest opacity-80">Member Card</p><p class="text-[14px] opacity-60 brand-font">The cafe 33</p></div>
        <div class="z-10"><p id="user-name-display" class="text-3xl font-bold uppercase tracking-wider mb-2"></p>
          <div class="flex justify-between items-end"><p id="user-rank" class="text-[12px] text-amber-400 font-bold uppercase tracking-widest"></p><div class="text-right"><span id="user-points" class="text-5xl font-black">0</span><span class="text-xs ml-1 opacity-70 font-bold">‚òÖ</span></div></div>
        </div>
        <div class="absolute -bottom-10 -right-10 w-48 h-48 bg-white/5 rounded-full blur-3xl"></div>
      </div>

      <div id="btn-open-history" onclick="openHistory()" class="bg-white p-5 rounded-[2.5rem] shadow-sm border border-gray-100 flex items-center justify-between cursor-pointer mb-6 active:scale-95 transition-transform">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 rounded-full bg-green-50 flex items-center justify-center text-xl text-[#006241]">üìÖ</div>
          <div>
            <p class="font-bold text-[#1e3932] text-sm uppercase tracking-wider">L·ªãch s·ª≠ ƒë·∫∑t Bed</p>
            <p class="text-[10px] text-gray-400 font-bold">Xem l·ªãch tr√¨nh & H·ªßy l·ªãch</p>
          </div>
        </div>
        <div class="text-gray-300 font-bold">‚ûú</div>
      </div>

      <div class="bg-white p-7 rounded-[2.5rem] shadow-sm border border-gray-100 space-y-4 text-left">
        <h4 class="font-bold text-[10px] uppercase text-gray-400 ml-2 tracking-widest">H·ªì s∆° c·ªßa b·∫°n</h4>
        <div><label class="text-[10px] font-bold text-gray-400 ml-2 uppercase">T√™n c·ªßa b·∫°n</label><input type="text" id="edit-name" class="w-full p-4 bg-gray-50 rounded-2xl outline-none mt-1 shadow-inner"></div>
        <div><label class="text-[10px] font-bold text-gray-400 ml-2 uppercase">S·ªë ƒëi·ªán tho·∫°i</label><input type="tel" id="edit-sdt" class="w-full p-4 bg-gray-50 rounded-2xl outline-none mt-1 shadow-inner" readonly></div>
        <p class="text-[10px] font-bold text-gray-400 ml-2 uppercase pt-2 tracking-widest">Ng∆∞·ªùi ƒëi c√πng m·∫∑c ƒë·ªãnh</p>
        <div class="space-y-3"><input type="text" id="edit-cname" class="w-full p-4 bg-gray-50 rounded-2xl outline-none shadow-inner" placeholder="T√™n ng∆∞·ªùi ƒëi c√πng"><input type="tel" id="edit-cphone" class="w-full p-4 bg-gray-50 rounded-2xl outline-none shadow-inner" placeholder="SƒêT ng∆∞·ªùi ƒëi c√πng"></div>
        <button id="btn-update-profile" onclick="handleUpdate()" class="w-full py-4 rounded-2xl border-2 border-[#006241] text-[#006241] font-bold text-sm mt-4 uppercase tracking-widest">L∆∞u thay ƒë·ªïi</button>
        <div class="mt-8 pt-6 border-t border-gray-50 text-center">
            <button onclick="handleLogout()" class="w-full py-4 rounded-2xl bg-red-50 text-red-500 font-bold text-xs uppercase tracking-widest border border-red-100 active:scale-95 transition-all shadow-sm hover:bg-red-100">
                ƒêƒÉng xu·∫•t t√†i kho·∫£n
            </button>
            <p class="text-[9px] text-gray-300 mt-4 font-bold tracking-widest">THE CAFE 33 APP ‚Ä¢ V2026</p>
        </div>
      </div>
    </div>

    <div id="tab-bed" class="p-6 pb-40 tab-content hidden">
      <h3 class="text-2xl text-[#006241] mb-6 brand-font text-left">ƒê·∫∑t ch·ªó Cafe in Bed</h3>
      <div class="bg-white p-7 rounded-[2.5rem] shadow-sm border border-gray-100 space-y-7 text-left">
        <div class="space-y-4"><label class="text-[10px] font-bold text-gray-400 uppercase ml-2 tracking-widest">Ng√†y b·∫°n ƒë·∫øn</label><input type="date" id="book-date" class="w-full p-4 rounded-2xl bg-gray-50 outline-none mt-1 shadow-inner text-center">
          <div class="flex gap-4"><div class="flex-1 text-center"><label class="text-[10px] font-bold text-gray-400 uppercase">B·∫Øt ƒë·∫ßu</label><input type="time" id="book-start" class="w-full p-4 rounded-2xl bg-gray-50 outline-none mt-1 shadow-inner text-center"></div><div class="flex-1 text-center"><label class="text-[10px] font-bold text-gray-400 uppercase">K·∫øt th√∫c</label><input type="time" id="book-end" class="w-full p-4 rounded-2xl bg-gray-50 outline-none mt-1 shadow-inner text-center"></div></div>
          <p class="text-[9px] text-amber-600 font-bold text-center italic">* Qu√°n ho·∫°t ƒë·ªông: 08:00 - 20:50</p>
        </div>
        <div class="space-y-4"><label class="text-[10px] font-bold text-gray-400 uppercase ml-2 tracking-widest">Th√¥ng tin ng∆∞·ªùi ƒëi c√πng</label><input type="text" id="book-cname" placeholder="T√™n ng∆∞·ªùi ƒëi c√πng" class="w-full p-4 rounded-2xl bg-gray-50 outline-none shadow-inner"><input type="tel" id="book-cphone" placeholder="S·ªë ƒëi·ªán tho·∫°i" class="w-full p-4 rounded-2xl bg-gray-50 outline-none shadow-inner"></div>
        <hr class="border-gray-50">
        <div class="space-y-5"><p class="text-[10px] font-bold text-gray-400 uppercase ml-2 text-center tracking-widest">N·ªôi quy & Mi·ªÖn tr·ª´ tr√°ch nhi·ªám</p>
          <div class="grid grid-cols-2 gap-4">
            <div class="relative aspect-square w-full rounded-[2rem] overflow-hidden border border-gray-100 shadow-sm" onclick="document.getElementById('zoomed-img').src='https://i.ibb.co/KcwBLYBN/N-I-QUY-S-D-NG-BED-20260109-102319-0000.png';document.getElementById('image-overlay').classList.remove('hidden');"><img src="https://i.ibb.co/KcwBLYBN/N-I-QUY-S-D-NG-BED-20260109-102319-0000.png" class="w-full h-full object-cover"><div class="absolute inset-0 bg-black/20 flex items-end justify-center pb-3"><span class="text-[8px] text-white font-bold uppercase bg-black/40 px-2 py-1 rounded-full backdrop-blur-sm">Nh·∫•n ƒë·ªÉ xem r√µ</span></div></div>
            <div class="relative aspect-square w-full rounded-[2rem] overflow-hidden border border-gray-100 shadow-sm" onclick="document.getElementById('zoomed-img').src='https://i.ibb.co/XrqnhTQK/2-20250520-223429-0001.png';document.getElementById('image-overlay').classList.remove('hidden');"><img src="https://i.ibb.co/XrqnhTQK/2-20250520-223429-0001.png" class="w-full h-full object-cover"><div class="absolute inset-0 bg-black/20 flex items-end justify-center pb-3"><span class="text-[8px] text-white font-bold uppercase bg-black/40 px-2 py-1 rounded-full backdrop-blur-sm">Nh·∫•n ƒë·ªÉ xem r√µ</span></div></div>
          </div>
          <div class="flex items-start gap-3 p-6 bg-gray-50 rounded-[2rem] border border-gray-100 text-left"><input type="checkbox" id="agree-rules" class="mt-1 w-7 h-7 accent-[#006241]"><label for="agree-rules" class="text-[12px] leading-relaxed text-gray-600 font-medium italic">T√¥i cam k·∫øt ƒë√£ ƒë·ªçc v√† tu√¢n th·ªß to√†n b·ªô n·ªôi quy c·ªßa <span class="brand-font">The cafe 33</span>.</label></div>
        </div>
        <button id="btn-booking" onclick="handleBooking()" class="w-full p-5 rounded-3xl sb-green text-white font-bold uppercase text-lg shadow-xl tracking-widest active:scale-95 transition-all">X√°c nh·∫≠n ƒë·∫∑t ch·ªó</button>
      </div>
    </div>

    <div id="tab-rewards" class="p-6 tab-content hidden pb-40"><h3 class="text-2xl text-[#006241] mb-6 brand-font text-left">ƒê·ªïi qu√† t·∫∑ng</h3><div id="rewards-list" class="grid grid-cols-1 gap-4"></div></div>
  </div>

  <nav id="nav-bar" class="fixed bottom-6 left-6 right-6 h-20 bg-white/90 backdrop-blur-xl rounded-[2.5rem] shadow-[0_10px_40px_rgba(0,0,0,0.1)] border border-white/60 flex justify-between items-center p-2 z-50 hidden">
    <button onclick="showTab('home')" id="nav-home" class="nav-item flex-1 h-full rounded-[2rem] flex flex-col items-center justify-center gap-1.5 active:scale-95">
        <div class="relative w-6 h-6">
            <svg class="w-full h-full stroke-current" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
        </div>
        <span class="text-[10px] font-bold tracking-widest uppercase">Home</span>
    </button>
    <button onclick="showTab('user')" id="nav-user" class="nav-item flex-1 h-full rounded-[2rem] flex flex-col items-center justify-center gap-1.5 active:scale-95">
        <div class="relative w-6 h-6">
            <svg class="w-full h-full stroke-current" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21C20 19.6044 20 18.9067 19.8278 18.3389C19.44 17.0605 18.4395 16.06 17.1611 15.6722C16.5933 15.5 15.8956 15.5 14.5 15.5H9.5C8.10444 15.5 7.40665 15.5 6.83886 15.6722C5.56045 16.06 4.56045 17.0605 4.17224 18.3389C4 18.9067 4 19.6044 4 21"/>
                <circle cx="12" cy="7" r="4"/>
            </svg>
        </div>
        <span class="text-[10px] font-bold tracking-widest uppercase">B·∫°n</span>
    </button>

    <button onclick="showTab('bed')" id="nav-bed" class="nav-item flex-1 h-full rounded-[2rem] flex flex-col items-center justify-center gap-1.5 active:scale-95">
        <div class="relative w-6 h-6">
            <svg class="w-full h-full stroke-current" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 9.5V20M3 20H21M3 20V21M21 20V9.5M21 20V21M3 9.5C3 8.39543 3.89543 7.5 5 7.5H9C10.1046 7.5 11 8.39543 11 9.5V11H3V9.5ZM21 9.5C21 8.39543 20.1046 7.5 19 7.5H15C13.8954 7.5 13 8.39543 13 9.5V11H21V9.5Z"/>
                <path d="M3 11H21V16H3V11Z"/>
            </svg>
        </div>
        <span class="text-[10px] font-bold tracking-widest uppercase">ƒê·∫∑t Bed</span>
    </button>

    <button onclick="showTab('rewards')" id="nav-rewards" class="nav-item flex-1 h-full rounded-[2rem] flex flex-col items-center justify-center gap-1.5 active:scale-95">
        <div class="relative w-6 h-6">
            <svg class="w-full h-full stroke-current" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 7V20M12 7H7.5C5.83333 7 5 8.5 6 9.5C6.63223 10.1322 8.5 12 12 12M12 7H16.5C18.1667 7 19 8.5 18 9.5C17.3678 10.1322 15.5 12 12 12M12 12V20M12 12H4.5M12 12H19.5M4 20H20"/>
                <path d="M12 7V4"/>
            </svg>
        </div>
        <span class="text-[10px] font-bold tracking-widest uppercase">ƒê·ªïi qu√†</span>
    </button>
</nav>

  <div id="history-modal" class="fixed inset-0 bg-white z-50 hidden flex-col overflow-hidden">
    <div class="px-5 pt-12 pb-4 bg-white border-b border-gray-100 flex items-center justify-between sticky top-0 z-10 shadow-sm">
      <h2 class="text-2xl font-black text-[#1e3932]">L·ªãch s·ª≠ ƒë·∫∑t Bed</h2>
      <button onclick="document.getElementById('history-modal').classList.add('hidden')" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200 transition">‚úï</button>
    </div>
    <div class="flex-1 overflow-y-auto overflow-x-hidden p-6 pb-40 bg-[#f8f9fa] w-full h-full overscroll-contain" id="history-content" style="-webkit-overflow-scrolling: touch;">
      <div id="history-loading" class="text-center py-10 text-gray-400">ƒêang t·∫£i d·ªØ li·ªáu...</div>
      <div id="section-active-booking" class="hidden mb-6">
        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">L·ªãch tr√¨nh h√¥m nay</h3>
        <div id="active-card" class="bg-white rounded-2xl p-5 shadow-sm border border-amber-100 relative overflow-hidden"></div>
      </div>
      <div id="section-past-booking">
        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">L·ªãch s·ª≠ ho·∫°t ƒë·ªông</h3>
        <div id="history-list" class="space-y-3"></div>
      </div>
    </div>
  </div>

  <div id="gift-detail-modal" class="fixed inset-0 bg-black/60 z-[80] hidden flex items-center justify-center p-6 backdrop-blur-sm transition-opacity duration-300">
    <div class="bg-white w-full max-w-sm rounded-[2.5rem] overflow-hidden shadow-2xl relative animate-bounce-in">
      <button onclick="document.getElementById('gift-detail-modal').classList.add('hidden')" class="absolute top-4 right-4 z-10 w-10 h-10 bg-black/20 text-white rounded-full flex items-center justify-center backdrop-blur-md hover:bg-black/40 transition">‚úï</button>
      <div class="h-64 w-full bg-gray-100 relative">
        <img id="detail-gift-img" src="" class="w-full h-full object-cover">
        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
        <div class="absolute bottom-5 left-6 right-6"><h3 id="detail-gift-name" class="text-2xl font-black text-white leading-tight mb-1 shadow-black drop-shadow-md">T√™n qu√†</h3></div>
      </div>
      <div class="p-6">
        <p id="detail-gift-desc" class="text-gray-500 text-sm mb-6 leading-relaxed">M√¥ t·∫£ qu√† t·∫∑ng...</p>
        <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100 mb-6">
          <div class="flex justify-between text-xs font-bold text-gray-400 uppercase tracking-wider mb-2"><span>ƒêi·ªÉm c·ªßa b·∫°n</span><span>C·∫ßn c√≥</span></div>
          <div class="flex justify-between items-end"><span id="detail-user-point" class="text-xl font-black text-[#1e3932]">0</span><span class="text-gray-300 mb-1">/</span><span id="detail-gift-cost" class="text-xl font-black text-[#006241]">0</span></div>
          <div class="w-full h-2 bg-gray-200 rounded-full mt-3 overflow-hidden"><div id="detail-progress" class="h-full bg-[#006241] rounded-full transition-all duration-500" style="width: 0%"></div></div>
          <p id="detail-message" class="text-[10px] font-bold text-amber-500 mt-2 text-right hidden">B·∫°n c√≤n thi·∫øu ƒëi·ªÉm nha!</p>
        </div>
        <button id="btn-confirm-redeem" class="w-full py-4 rounded-2xl bg-[#006241] text-white font-bold text-sm uppercase tracking-widest shadow-lg shadow-green-900/20 active:scale-[0.98] transition-transform">X√°c nh·∫≠n ƒë·ªïi qu√†</button>
      </div>
    </div>
  </div>
<div id="reschedule-modal" class="fixed inset-0 bg-black/60 z-[90] hidden flex items-center justify-center p-6 backdrop-blur-sm transition-opacity duration-300">
    <div class="bg-white w-full max-w-sm rounded-[2.5rem] overflow-hidden shadow-2xl relative animate-bounce-in p-7 text-left">
        <button onclick="document.getElementById('reschedule-modal').classList.add('hidden')" class="absolute top-4 right-4 w-10 h-10 bg-gray-100 text-gray-500 rounded-full flex items-center justify-center hover:bg-gray-200 transition">‚úï</button>
        
        <h3 class="text-2xl font-black text-[#006241] mb-1 brand-font">ƒê·ªïi l·ªãch ƒë·∫∑t</h3>
        <p class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-6">Ch·ªçn th·ªùi gian m·ªõi c·ªßa b·∫°n</p>

        <div class="space-y-4">
            <div>
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-2 tracking-widest">Ng√†y</label>
                <input type="date" id="re-date" class="w-full p-4 rounded-2xl bg-gray-50 outline-none mt-1 shadow-inner text-center font-bold text-[#1e3932]">
            </div>
            <div class="flex gap-4">
                <div class="flex-1">
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">B·∫Øt ƒë·∫ßu</label>
                    <input type="time" id="re-start" class="w-full p-4 rounded-2xl bg-gray-50 outline-none mt-1 shadow-inner text-center font-bold text-[#1e3932]">
                </div>
                <div class="flex-1">
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">K·∫øt th√∫c</label>
                    <input type="time" id="re-end" class="w-full p-4 rounded-2xl bg-gray-50 outline-none mt-1 shadow-inner text-center font-bold text-[#1e3932]">
                </div>
            </div>
        </div>

        <button onclick="submitReschedule()" class="w-full py-4 mt-8 rounded-2xl bg-[#006241] text-white font-bold text-sm uppercase tracking-widest shadow-lg shadow-green-900/20 active:scale-[0.98] transition-transform">
            X√°c nh·∫≠n ƒë·ªïi
        </button>
    </div>
</div>
<script>
// =============================================================
// 1. C·∫§U H√åNH (D√ÅN T·ª™ FILE POS V√ÄO ƒê√ÇY)
// =============================================================
const firebaseConfig = {
  apiKey: "AIzaSyCNh1-16gYZ0P30Fkd-2tB-O89PXkPX9Lc",
  authDomain: "the-cafe-33.firebaseapp.com",
  databaseURL: "https://the-cafe-33-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "the-cafe-33",
  storageBucket: "the-cafe-33.appspot.com",
  messagingSenderId: "...",
  appId: "..."
};

// D√ÅN LINK WEB APP M·ªöI C·ª¶A B√Ä V√ÄO ƒê√ÇY (ƒêu√¥i /exec)
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwDrZmGgIC3c-oPAOhGHaaYOIRuHC2YaSFDoCQ5x6S-CdLQLUc4dtJhLnekccxWmQNjBg/exec"; 

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let curPhone = localStorage.getItem('member_phone');
let userData = {};
let _cachedGiftList = []; // Th√™m bi·∫øn cache danh s√°ch qu√†
// --- LOGIC ƒêƒÇNG K√ù (NO GSA) ---

function showRegister() {
    document.getElementById('login-screen').classList.add('hidden');
    const regScreen = document.getElementById('register-screen');
    regScreen.classList.remove('hidden');
    regScreen.style.display = 'flex';
}

function hideRegister() {
    const regScreen = document.getElementById('register-screen');
    regScreen.classList.add('hidden');
    regScreen.style.display = 'none';
    document.getElementById('login-screen').classList.remove('hidden');
}

function submitRegister() {
    const nameEl = document.getElementById('reg-name');
    const phoneEl = document.getElementById('reg-phone');
    const btn = document.getElementById('btn-reg-submit');

    const name = nameEl.value.trim();
    // H√†m normalizePhone ƒë√£ c√≥ s·∫µn trong code c≈©
    const phone = normalizePhone(phoneEl.value); 

    if (name.length < 2) return alert("Vui l√≤ng nh·∫≠p t√™n ƒë·∫ßy ƒë·ªß!");
    if (phone.length < 9) return alert("S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá!");

    const oldText = btn.innerHTML;
    btn.innerHTML = "ƒêang x·ª≠ l√Ω...";
    btn.disabled = true;

    const userRef = db.ref('customers/' + phone);
    
    userRef.once('value', (snapshot) => {
        if (snapshot.exists()) {
            alert("SƒêT n√†y ƒë√£ t·ªìn t·∫°i! Vui l√≤ng ƒëƒÉng nh·∫≠p.");
            btn.innerHTML = oldText;
            btn.disabled = false;
            hideRegister();
        } else {
            // T·∫†O USER M·ªöI TR√äN FIREBASE
            userRef.set({
                name: name,
                phone: phone,
                points: 333, // T·∫∑ng 333 ƒëi·ªÉm nh∆∞ y√™u c·∫ßu
                joinDate: new Date().toISOString(),
                source: 'app_index',
                
                // C√°c tr∆∞·ªùng b·∫Øt bu·ªôc cho App Bed
                lastCompName: "",       
                lastCompPhone: "",      
                lastVisit: new Date().toISOString(),
                pendingFee: 0,          
                pendingFeeReason: ""    
            }, (error) => {
                if (error) {
                    alert("L·ªói: " + error.message);
                    btn.innerHTML = oldText;
                    btn.disabled = false;
                } else {
                    // TH√ÄNH C√îNG -> V√ÄO TH·∫≤NG APP
                    // Kh√¥ng hi·ªán th√¥ng b√°o voucher, kh√¥ng g·ªçi GSA
                    localStorage.setItem('member_phone', phone);
                    
                    document.getElementById('register-screen').classList.add('hidden');
                    document.getElementById('register-screen').style.display = 'none';
                    
                    showDashboard(phone); // H√†m n√†y c√≥ s·∫µn trong index, s·∫Ω t·ª± t·∫£i giao di·ªán ch√≠nh
                }
            });
        }
    });
}
// --- 2. LOGIC CHUNG ---
window.onload = function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('book-date').setAttribute('min', today);
    if(curPhone) showDashboard(curPhone);
    updateClock();
};

function updateClock() { 
    const now = new Date(); 
    const h = String(now.getHours()).padStart(2,'0'), m = String(now.getMinutes()).padStart(2,'0'); 
    const d = String(now.getDate()).padStart(2,'0'), mo = String(now.getMonth()+1).padStart(2,'0'); 
    document.getElementById('live-clock').innerText = `${h}:${m} - ${d}/${mo}`;
}
setInterval(updateClock, 10000);

// --- H√ÄM CHUY·ªÇN TAB (CHO MENU APPLE STYLE) ---
function showTab(t) { 
    // 1. ·∫®n t·∫•t c·∫£ c√°c Tab n·ªôi dung
    var contents = document.getElementsByClassName('tab-content');
    for (var i = 0; i < contents.length; i++) {
        contents[i].classList.add('hidden');
    }
    
    // 2. Hi·ªán Tab ƒë∆∞·ª£c ch·ªçn
    var selectedTab = document.getElementById('tab-' + t);
    if (selectedTab) {
        selectedTab.classList.remove('hidden');
    }
    
    // 3. X·ª≠ l√Ω hi·ªáu ·ª©ng tr√™n thanh Menu (ƒê·ªïi m√†u icon)
    // L·∫•y t·∫•t c·∫£ c√°c n√∫t trong menu
    var navItems = document.getElementsByClassName('nav-item');
    for (var i = 0; i < navItems.length; i++) {
        // T·∫Øt tr·∫°ng th√°i active (x√°m ƒëi)
        navItems[i].classList.remove('active'); 
    }
    
    // B·∫≠t tr·∫°ng th√°i active cho n√∫t ƒë∆∞·ª£c ch·ªçn (xanh l√™n)
    var activeBtn = document.getElementById('nav-' + t);
    if (activeBtn) {
        activeBtn.classList.add('active');
    }
    
    // (T√πy ch·ªçn) Cu·ªôn l√™n ƒë·∫ßu trang cho m∆∞·ª£t
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function showAppModal(title, msg, icon='‚òï', cb=null, showCancel=false) {
    document.getElementById('modal-title').innerText = title;
    document.getElementById('modal-message').innerHTML = msg;
    document.getElementById('modal-icon').innerText = icon;
    
    const overlay = document.getElementById('modal-overlay');
    const modalContent = document.getElementById('custom-modal');
    
    // Reset tr·∫°ng th√°i
    modalContent.classList.remove('modal-show');
    modalContent.classList.add('modal-enter');
    
    // B·∫≠t overlay
    overlay.classList.remove('hidden');
    
    // Trigger animation sau 10ms (ƒë·ªÉ browser render l·∫°i)
    setTimeout(() => {
        modalContent.classList.remove('modal-enter');
        modalContent.classList.add('modal-show');
    }, 10);
    
    const btnMain = document.getElementById('modal-btn-main');
    const btnSub = document.getElementById('modal-btn-sub');
    
    btnMain.onclick = () => { 
        overlay.classList.add('hidden'); 
        if(cb) cb(); 
    };
    
    if(showCancel) {
        btnSub.classList.remove('hidden');
        btnSub.onclick = () => { overlay.classList.add('hidden'); };
    } else {
        btnSub.classList.add('hidden');
    }
}

function normalizePhone(p) { return String(p || "").replace(/[^0-9]/g, ""); }

// --- 3. ƒêƒÇNG NH·∫¨P ---
function login() {
    const phone = normalizePhone(document.getElementById('login-sdt').value);
    if (phone.length < 9) return alert("SƒêT kh√¥ng h·ª£p l·ªá!");
    
    document.getElementById('loading-overlay').classList.remove('hidden');
    db.ref('customers/' + phone).once('value', snap => {
        document.getElementById('loading-overlay').classList.add('hidden');
        if (snap.exists()) {
            localStorage.setItem('member_phone', phone);
            showDashboard(phone);
        } else {
            alert("SƒêT n√†y ch∆∞a ƒëƒÉng k√Ω th√†nh vi√™n!");
        }
    });
}

// --- [FIX] SHOW DASHBOARD (T·ª∞ ƒêI·ªÄN TH√îNG TIN NG∆Ø·ªúI ƒêI C√ôNG) ---
// --- [FIX] SHOW DASHBOARD (L·∫§Y DATA GI·ªêNG POS & T·ª∞ ƒêI·ªÄN V√ÄO ƒê·∫∂T BED) ---
// --- [FIX FINAL] SHOW DASHBOARD (√âP BU·ªòC HI·ªÇN TH·ªä D·ªÆ LI·ªÜU) ---
// --- [FIX FINAL] SHOW DASHBOARD (D√ôNG ƒê√öNG KEY C·ª¶A FIREBASE) ---
function showDashboard(phone) {
    curPhone = phone;
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('main-app').classList.remove('hidden');
    document.getElementById('nav-bar').classList.remove('hidden');

    // L·∫Øng nghe d·ªØ li·ªáu
    db.ref('customers/' + phone).on('value', snap => {
        userData = snap.val();
        
        if(userData) {
          // === C·∫¨P NH·∫¨T TRANG CH·ª¶ (M·ªöI) ===
            const displayName = userData.name || "B·∫°n m·ªõi";
            // C·∫≠p nh·∫≠t t√™n ·ªü trang ch·ªß
            const homeNameEl = document.getElementById('home-cust-name');
            if(homeNameEl) homeNameEl.innerText = displayName;
            
            // C·∫≠p nh·∫≠t ƒëi·ªÉm mini ·ªü trang ch·ªß
            const homePointEl = document.getElementById('home-mini-point');
            if(homePointEl) homePointEl.innerText = (userData.points || 0).toLocaleString();
            // =================================
            // 1. Hi·ªÉn th·ªã th√¥ng tin c∆° b·∫£n
            document.getElementById('user-name-display').innerText = userData.name || "Kh√°ch h√†ng";
            document.getElementById('user-points').innerText = (userData.points || 0).toLocaleString();
            
            // X·∫øp h·∫°ng
            let p = userData.points || 0;
            let r = "Th√†nh vi√™n";
            if (p >= 55000) r = "Th√†nh vi√™n 'siu th√¢n'";
            else if (p >= 33000) r = "Th√†nh vi√™n 'th√¢n iu'";
            else if (p >= 10000) r = "Th√†nh vi√™n B·∫°c";
            document.getElementById('user-rank').innerText = r;

            // ==========================================================
            // üéØ L·∫§Y ƒê√öNG KEY T·ª™ FIREBASE (lastCompName)
            // ==========================================================
            
            // Key chu·∫©n Ti√™n sinh cung c·∫•p:
            var cName = userData.lastCompName || "";
            var cPhone = userData.lastCompPhone || "";
            var uName = userData.name || "";

            // 2. Autofill v√†o Tab H·ªí S∆†
            if(document.getElementById('edit-name')) document.getElementById('edit-name').value = uName;
            if(document.getElementById('edit-sdt')) document.getElementById('edit-sdt').value = phone;
            if(document.getElementById('edit-cname')) document.getElementById('edit-cname').value = cName;
            if(document.getElementById('edit-cphone')) document.getElementById('edit-cphone').value = cPhone;

            // 3. Autofill v√†o Tab ƒê·∫∂T BED (Ghi ƒë√® lu√¥n)
            var bookCName = document.getElementById('book-cname');
            var bookCPhone = document.getElementById('book-cphone');

            if (bookCName) bookCName.value = cName;
            if (bookCPhone) bookCPhone.value = cPhone;
        }
    });
    
    loadRewards();
  // === QUAN TR·ªåNG: M·ªû TAB HOME ƒê·∫¶U TI√äN ===
    showTab('home');
}
// --- 4. C·∫¨P NH·∫¨T H·ªí S∆† ---
// --- H√ÄM C·∫¨P NH·∫¨T TH√îNG TIN (ƒê√É FIX L·ªñI TREO M√ÄN H√åNH) ---
// --- 4. C·∫¨P NH·∫¨T H·ªí S∆† (ƒê√É FIX ƒê√öNG ID V√Ä CH·ªêNG TREO) ---
// --- H√ÄM C·∫¨P NH·∫¨T TH√îNG TIN (S·∫†CH S·∫º - KH√îNG L·ªñI) ---
// --- H√ÄM C·∫¨P NH·∫¨T H·ªí S∆† (PHI√äN B·∫¢N CH·ªêNG TREO TUY·ªÜT ƒê·ªêI) ---
// --- H√ÄM C·∫¨P NH·∫¨T H·ªí S∆† (PHI√äN B·∫¢N C∆Ø·ª†NG CH·∫æ T·∫ÆT TO√ÄN B·ªò) ---
window.handleUpdate = function() {
    // 1. L·∫•y d·ªØ li·ªáu
    const nameInput = document.getElementById('edit-name');
    const cNameInput = document.getElementById('edit-cname');
    const cPhoneInput = document.getElementById('edit-cphone');

    if (!nameInput || !cNameInput) return alert("L·ªói: Kh√¥ng t√¨m th·∫•y √¥ nh·∫≠p li·ªáu.");

    const newName = nameInput.value.trim();
    const newComp = cNameInput.value.trim();
    const newCompPhone = cPhoneInput ? cPhoneInput.value.trim() : "";
    
    if (newName === "") return alert("Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!");
    
    // 2. B·∫¨T LOADING (D√πng l·ªánh n√†y ƒë·ªÉ t√≥m g·ªçn t·∫•t c·∫£ c√°c l·ªõp ph·ªß ƒëang ·∫©n n·∫•p)
    const allLoadings = document.querySelectorAll('#loading-overlay');
    allLoadings.forEach(el => el.classList.remove('hidden'));

    // === BOM H·∫∏N GI·ªú: T·∫Øt T·∫§T C·∫¢ sau 3 gi√¢y (ƒë·ªÅ ph√≤ng m·∫°ng lag) ===
    const safetyTimer = setTimeout(() => {
        allLoadings.forEach(el => el.classList.add('hidden')); // T·∫Øt s·∫°ch s·∫Ω
    }, 3000); 

    const oldName = (typeof userData !== 'undefined' && userData.name) ? userData.name : "---";
    const updates = {};
    updates['customers/' + curPhone + '/name'] = newName;
    updates['customers/' + curPhone + '/compName'] = newComp;
    updates['customers/' + curPhone + '/companionName'] = newComp;
    updates['customers/' + curPhone + '/compPhone'] = newCompPhone;

    // 3. G·ª≠i l·ªánh update
    db.ref().update(updates)
        .then(() => {
            clearTimeout(safetyTimer);
            
            // TH√ÄNH C√îNG -> T·∫ÆT S·∫†CH C√ÅC LOADING
            allLoadings.forEach(el => el.classList.add('hidden'));
            
            if(typeof showAppModal === 'function') {
                showAppModal("Th√†nh c√¥ng", "ƒê√£ c·∫≠p nh·∫≠t h·ªì s∆°!", '‚úÖ');
            } else {
                alert("ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!");
            }

            // G·ª≠i Log
            if (typeof GOOGLE_SCRIPT_URL !== 'undefined' && GOOGLE_SCRIPT_URL) {
                const logData = {
                    action: 'logProfileUpdate',
                    phone: curPhone,
                    oldName: oldName,
                    newName: newName,
                    oldComp: "---",
                    newComp: newComp
                };
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(logData)
                }).catch(e => console.log(e));
            }
        })
        .catch((error) => {
            clearTimeout(safetyTimer);
            // L·ªñI -> C≈®NG PH·∫¢I T·∫ÆT S·∫†CH
            allLoadings.forEach(el => el.classList.add('hidden'));
            alert("L·ªói: " + error.message);
        });
}
// --- 5. ƒê·∫∂T BED (POS STYLE) ---
// --- H√ÄM ƒê·∫∂T BED (LOGIC M·ªöI: CH·ªú X·∫æP BED) ---
// --- H√ÄM ƒê·∫∂T BED (B·∫¢N FULL: CH·∫∂N TR√ôNG KH√ÅCH + G·ª¢I √ù GI·ªú + CH·ªú X·∫æP BED) ---
// --- [FIX FINAL] HANDLE BOOKING (B·∫¢N FULL: G√ÅC C·ªîNG + ƒê·∫∂T L·ªäCH) ---
// --- [FIX FINAL] HANDLE BOOKING (B·∫¢N AN TO√ÄN TUY·ªÜT ƒê·ªêI) ---
// =============================================================
// LOGIC ƒê·∫∂T BED TH√îNG MINH & NH√ÇN VƒÇN - THE CAFE 33
// =============================================================

// 1. H√ÄM CHECK KH·∫¢ D·ª§NG (Helper)
// Tr·∫£ v·ªÅ true n·∫øu khung gi·ªù (s, e) c√≤n tr·ªëng √≠t nh·∫•t 1 bed
// 1. H√ÄM CHECK KH·∫¢ D·ª§NG (Helper)
function isSlotAvailable(s, e, bookedSlots) {
    let overlap = 0;
    bookedSlots.forEach(slot => {
        const bs = parseInt(slot.start.split(':')[0])*60 + parseInt(slot.start.split(':')[1]);
        const be = parseInt(slot.end.split(':')[0])*60 + parseInt(slot.end.split(':')[1]);
        if (Math.max(s, bs) < Math.min(e, be)) overlap++;
    });
    return overlap < 4; // Qu√°n c√≥ 4 Bed
}
// 2. H√ÄM T√åM KI·∫æM TH√îNG MINH (TR√ÅI TIM C·ª¶A H·ªÜ TH·ªêNG)
// 2. H√ÄM T√åM KI·∫æM TH√îNG MINH (C√ì CHECK TH·ªúI GIAN TH·ª∞C)
// =============================================================
// LOGIC G·ª¢I √ù: NAM CH√ÇM + QU√Ä T·∫∂NG "X·ª®NG ƒê√ÅNG"
// =============================================================

// =============================================================
// LOGIC G·ª¢I √ù: B·∫ÆT D√çNH T·ª™NG PH√öT & KH√îNG B·ªé S√ìT (NO HIDDEN BUFFER)
// =============================================================
// =============================================================
// LOGIC G·ª¢I √ù: NAM CH√ÇM + ƒê·ªòC QUY·ªÄN (WINNER TAKES ALL)
// =============================================================

// =============================================================
// LOGIC G·ª¢I √ù SI√äU C·∫§P: NAM CH√ÇM + T·ª∞ C·∫ÆT ƒêU√îI THEO GI·ªú ƒê√ìNG C·ª¨A
// =============================================================
// =============================================================
// LOGIC G·ª¢I √ù: NAM CH√ÇM TUY·ªÜT ƒê·ªêI (GAP MATCH = ONLY ONE)
// =============================================================

function findSmartSlots(bookedSlots, reqStart, reqEnd, dateStr) {
    let suggestions = [];
    const reqDuration = reqEnd - reqStart;
    
    // 1. DATA CHU·∫®N B·ªä
    const now = new Date();
    const d = String(now.getDate()).padStart(2, '0');
    const m = String(now.getMonth() + 1).padStart(2, '0');
    const y = now.getFullYear();
    const todayStr = `${d}/${m}/${y}`;
    const currentMinutes = now.getHours() * 60 + now.getMinutes();
    const minValidTime = (dateStr === todayStr) ? currentMinutes : 0; 
    const CLOSE_TIME = 1250; // 20:50

    // 2. T·∫†O ƒêI·ªÇM NAM CH√ÇM (GAP POINTS)
    let gapPoints = new Set(); 
    let candidateStarts = new Set();
    
    // L·∫•y gi·ªù tr·∫£ Bed c·ªßa c√°c ƒë∆°n c≈©
    bookedSlots.forEach(slot => {
        const be = parseInt(slot.end.split(':')[0]) * 60 + parseInt(slot.end.split(':')[1]);
        gapPoints.add(be); 
        // L·∫•y t·∫•t c·∫£ c√°c m·ªëc tr·∫£ bed, mi·ªÖn l√† trong ng√†y v√† ch∆∞a qua
        candidateStarts.add(be);
    });

    candidateStarts.add(reqStart);
    candidateStarts.add(480); // 08:00

    // Qu√©t th√™m xung quanh (ph√≤ng h·ªù)
    for (let offset = -120; offset <= 120; offset += 15) candidateStarts.add(reqStart + offset);

    // 3. CH·∫§M ƒêI·ªÇM
    let scoredSuggestions = [];

    candidateStarts.forEach(startT => {
        if (startT < 480 || startT >= CLOSE_TIME - 30 || startT <= minValidTime) return;

        // T·ª± ƒë·ªông k√©o d√†i ƒë·∫øn ƒë√≥ng c·ª≠a n·∫øu c·∫ßn (T·ªëi ∆∞u doanh thu)
        let maxPossibleEnd = Math.min(startT + reqDuration, CLOSE_TIME);
        
        if (maxPossibleEnd - startT < 30) return; // Qu√° ng·∫Øn th√¨ b·ªè

        if (isSlotAvailable(startT, maxPossibleEnd, bookedSlots)) {
            
            let score = 0;
            const diffStart = Math.abs(startT - reqStart);
            const duration = maxPossibleEnd - startT;
            const lostMin = reqDuration - duration;

            // [TR·ªåNG S·ªê QUY·∫æT ƒê·ªäNH]: KH·ªöP GAP
            // Gap c√†ng g·∫ßn gi·ªù kh√°ch mu·ªën c√†ng ƒëi·ªÉm cao
            if (gapPoints.has(startT)) {
                score += 5000; // ƒêi·ªÉm c·ª±c kh·ªßng ƒë·ªÉ ƒë·∫£m b·∫£o n√≥ l√™n Top 1
                score -= diffStart; // L·ªách √≠t th√¨ ƒëi·ªÉm c√†ng cao h∆°n
            } else {
                score -= 500; // Kh√¥ng kh·ªõp gap th√¨ tr·ª´ ƒëi·ªÉm n·∫∑ng
            }

            // ƒêi·ªÉm ph·ª•: Doanh thu (th·ªùi l∆∞·ª£ng)
            score += duration; 

            // N·ªôi dung
            let noteText = "";
            let bonusText = "";
            
            if (lostMin <= 0) {
                if (gapPoints.has(startT)) noteText = "V·ª´a kh√≠t c√≥ kh√°ch tr·∫£ Bed lu√¥n!";
                else noteText = startT > reqStart ? "D·ªùi l·∫°i x√≠u l√† c√≥ ch·ªó!" : "ƒêi s·ªõm h∆°n ch√∫t c√≥ ch·ªó ƒë·∫πp!";
            } else {
                // Logic Qu√†
                if (lostMin >= 10 && lostMin <= 20) bonusText = "‚ú® ƒê·∫∂C QUY·ªÄN: Free chƒÉn √™m";
                else if (lostMin > 20 && lostMin <= 60) bonusText = "‚ú® ∆ØU ƒê√ÉI K√âP: Free chƒÉn + Gi·∫£m 5k";
                else if (lostMin > 60 && lostMin <= 65) bonusText = "‚ú® ƒê·∫∂C QUY·ªÄN: Free chƒÉn √™m";
                else if (lostMin > 65) bonusText = "‚ú® ∆ØU ƒê√ÉI VIP: Free chƒÉn + Gi·∫£m 5k";

                if (maxPossibleEnd === CLOSE_TIME) noteText = `Ng·ªìi ƒë·∫øn ƒë√≥ng c·ª≠a (20:50)`;
                else noteText = `Ng·∫Øn h∆°n ${lostMin}p`;
            }

            if (lostMin <= 0 || bonusText !== "") {
                scoredSuggestions.push({
                    start: startT, end: maxPossibleEnd, 
                    isShorter: (lostMin > 0),
                    diff: diffStart,
                    score: score,
                    note: noteText,
                    bonus: bonusText,
                    isGapMatch: gapPoints.has(startT) // C·ªù ƒë√°nh d·∫•u Nam ch√¢m
                });
            }
        }
    });

    // 4. S·∫ÆP X·∫æP & L·ªåC TR√ôNG
    // (Th·∫±ng n√†o kh·ªõp Gap v√† g·∫ßn reqStart nh·∫•t s·∫Ω n·∫±m ƒë·∫ßu ti√™n)
    scoredSuggestions.sort((a, b) => b.score - a.score);

    let finalSuggestions = [];
    let seenStarts = new Set(); 

    for (let item of scoredSuggestions) {
        if (!seenStarts.has(item.start)) {
            seenStarts.add(item.start);
            finalSuggestions.push(item);
        }
    }

    // =========================================================
    // 5. CHI·∫æN THU·∫¨T "ƒê·ªòC T√ÄI" (S·ª¨A L·∫†I THEO √ù TI√äN SINH)
    // =========================================================
    if (finalSuggestions.length > 0) {
        const best = finalSuggestions[0];
        
        // N·∫æU t√¨m th·∫•y Slot kh·ªõp Gap (Nam ch√¢m) -> L·∫§Y DUY NH·∫§T 1 C√ÅI ƒê√ì
        // B·∫•t k·ªÉ n√≥ l·ªách bao nhi√™u ph√∫t. V√¨ n√≥ l√† slot t·ªët nh·∫•t, s·ªõm nh·∫•t r·ªìi.
        // Hi·ªÉn th·ªã th√™m c√°c slot sau ƒë√≥ (xa h∆°n) ch·ªâ l√†m lo√£ng th√¥ng tin.
        if (best.isGapMatch) {
            return [best];
        }
    }

    // N·∫øu kh√¥ng t√¨m th·∫•y Gap Match n√†o (hi·∫øm), m·ªõi hi·ªÉn th·ªã t·ªëi ƒëa 3 c√°i
    return finalSuggestions.slice(0, 3);
}


// 3. H√ÄM CH√çNH: HANDLE BOOKING (GI·ªÆ NGUY√äN STRUCURE, THAY LOGIC)
// =============================================================
// LOGIC ƒê·∫∂T BED: C√ì CHECK 5 PH√öT CHU·∫®N B·ªä (PREP BUFFER)
// =============================================================

function handleBooking() {
    // A. Validate Input (Gi·ªØ nguy√™n)
    if (!document.getElementById('agree-rules').checked) return alert("Vui l√≤ng ƒë·ªìng √Ω n·ªôi quy!");
    
    const loading = document.getElementById('loading-overlay');
    
    // --- B∆Ø·ªöC 1: KI·ªÇM TRA 5 PH√öT CHU·∫®N B·ªä (NEW) ---
    const dateVal = document.getElementById('book-date').value;
    const startVal = document.getElementById('book-start').value;
    const endVal = document.getElementById('book-end').value;

    if(!dateVal || !startVal || !endVal) return alert("Nh·∫≠p ƒë·ªß ng√†y gi·ªù!");

    const now = new Date();
    const d = String(now.getDate()).padStart(2, '0');
    const m = String(now.getMonth() + 1).padStart(2, '0');
    const y = now.getFullYear();
    const todayInputFormat = `${y}-${m}-${d}`; // Format yyyy-mm-dd c·ªßa input date

    // Ch·ªâ ki·ªÉm tra n·∫øu kh√°ch ƒë·∫∑t cho H√îM NAY
    if (dateVal === todayInputFormat) {
        const currentTotalMin = now.getHours() * 60 + now.getMinutes();
        const bookingStartMin = parseInt(startVal.split(':')[0]) * 60 + parseInt(startVal.split(':')[1]);
        
        // N·∫øu gi·ªù ƒë·∫∑t nh·ªè h∆°n (Hi·ªán t·∫°i + 5 ph√∫t)
        if (bookingStartMin < currentTotalMin + 5) {
            
            // T√≠nh to√°n gi·ªù g·ª£i √Ω m·ªõi (Hi·ªán t·∫°i + 10 ph√∫t cho th∆∞ th·∫£)
            const suggestMin = currentTotalMin + 10;
            const h = Math.floor(suggestMin / 60).toString().padStart(2, '0');
            const mi = (suggestMin % 60).toString().padStart(2, '0');
            const newStartStr = `${h}:${mi}`;

            // T√≠nh l·∫°i gi·ªù k·∫øt th√∫c t∆∞∆°ng ·ª©ng (ƒë·ªÉ gi·ªØ nguy√™n th·ªùi l∆∞·ª£ng kh√°ch mu·ªën)
            const oldDuration = (parseInt(endVal.split(':')[0])*60 + parseInt(endVal.split(':')[1])) - bookingStartMin;
            const newEndMin = suggestMin + oldDuration;
            const he = Math.floor(newEndMin / 60).toString().padStart(2, '0');
            const me = (newEndMin % 60).toString().padStart(2, '0');
            const newEndStr = `${he}:${me}`;

            // HI·ªÜN TH√îNG B√ÅO KH√âO L√âO
            showAppModal(
                "C·∫ßn th√™m x√≠u th·ªùi gian", 
                `<p class="text-left text-sm text-[#1e3932] mb-2">
                    B·∫°n ∆°i, <b>The cafe 33</b> c·∫ßn t·ªëi thi·ªÉu <b>5</b> ƒë·ªÉ d·ªçn d·∫πp v√† chu·∫©n b·ªã bed.
                 </p>
                 <p class="text-left text-sm text-gray-500 italic">
                    H·ªá th·ªëng xin ph√©p d·ªùi l·ªãch sang <b>${newStartStr}</b> ƒë·ªÉ nh√¢n vi√™n k·ªãp chu·∫©n b·ªã chu ƒë√°o nh√©?
                 </p>`,
                "üßπ",
                // Callback khi b·∫•m ƒê·ªìng √Ω: T·ª± ƒë·ªông s·ª≠a gi·ªù v√† g·ªçi l·∫°i h√†m ƒë·∫∑t
                () => {
                    document.getElementById('book-start').value = newStartStr;
                    document.getElementById('book-end').value = newEndStr;
                    // G·ªçi ƒë·ªá quy l·∫°i ch√≠nh h√†m n√†y ƒë·ªÉ ti·∫øp t·ª•c quy tr√¨nh ƒë·∫∑t
                    setTimeout(() => handleBooking(), 300); 
                },
                true // Show n√∫t H·ªßy (ƒë·ªÉ kh√°ch ch·ªçn l·∫°i n·∫øu kh√¥ng th√≠ch)
            );
            return; // D·ª™NG L·∫†I NGAY, KH√îNG CH·∫†Y TI·∫æP
        }
    }

    // --- C√ÅC B∆Ø·ªöC TI·∫æP THEO (LOGIC C≈®) ---
    loading.classList.remove('hidden');
    const safetyTimer = setTimeout(() => { if (!loading.classList.contains('hidden')) loading.classList.add('hidden'); }, 5000);

    // B. Check Store OFF
    db.ref('store_status').once('value', (statusSnap) => {
        const storeStatus = statusSnap.val();
        if (storeStatus && storeStatus.isOff) {
             const now = new Date();
             let until = storeStatus.offUntil ? new Date(storeStatus.offUntil) : null;
             if (until && now < until) {
                 clearTimeout(safetyTimer); loading.classList.add('hidden');
                 const timeStr = until.toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'});
                 showAppModal("Bed ƒëang t·∫°m ng∆∞ng", `<span class="text-red-500 font-bold">${storeStatus.reason || "B·∫£o tr√¨"}</span><br>Vui l√≤ng quay l·∫°i sau <b>${timeStr}</b> nh√©!`, "üõë");
                 return;
             }
        }

        // C. L·∫•y Form Data (ƒê√£ l·∫•y ·ªü tr√™n, ch·ªâ c·∫ßn parse l·∫°i)
        const cName = (document.getElementById('book-cname').value || "").trim();
        const cPhone = (document.getElementById('book-cphone').value || "").trim();
        
        const sMin = parseInt(startVal.split(':')[0])*60 + parseInt(startVal.split(':')[1]);
        const eMin = parseInt(endVal.split(':')[0])*60 + parseInt(endVal.split(':')[1]);
        
        if(sMin >= eMin || sMin < 480 || eMin > 1250 || eMin - sMin < 30) { 
            clearTimeout(safetyTimer); loading.classList.add('hidden'); 
            return alert("Gi·ªù kh√¥ng h·ª£p l·ªá (08:00-20:50, t·ªëi thi·ªÉu 30p)!"); 
        }

        // D. Check Active Booking
        db.ref('bedBookings').orderByChild('phone').equalTo(curPhone).once('value', userSnap => {
            let hasActive = false;
            userSnap.forEach(c => { const st = (c.val().status||"").toLowerCase(); if(st!=='ƒë√£ h·ªßy' && st!=='ƒë√£ xong') hasActive=true; });
            if(hasActive) {
                clearTimeout(safetyTimer); loading.classList.add('hidden');
                showAppModal("B·∫°n ƒë√£ c√≥ l·ªãch ƒë·∫∑t!", "Vui l√≤ng ki·ªÉm tra l·∫°i.", "‚ö†Ô∏è", () => { showTab('user'); openHistory(); });
                return;
            }

            // E. CHECK TR√ôNG & X·ª¨ L√ù
            const p = dateVal.split('-');
            const dateStr = `${p[2]}/${p[1]}/${p[0]}`; 

            db.ref('bedBookings').orderByChild('date').equalTo(dateStr).once('value', snap => {
                let bookedSlots = [];
                let overlapCount = 0;
                
                snap.forEach(c => {
                    const v = c.val();
                    if(v.status !== 'ƒë√£ h·ªßy' && v.status !== 'ƒë√£ xong') {
                        bookedSlots.push(v);
                        const bs = parseInt(v.start.split(':')[0])*60 + parseInt(v.start.split(':')[1]);
                        const be = parseInt(v.end.split(':')[0])*60 + parseInt(v.end.split(':')[1]);
                        if(Math.max(sMin, bs) < Math.min(eMin, be)) overlapCount++;
                    }
                });

                if (overlapCount < 4) { // Qu√°n c√≥ 4 Bed
                    // ---> C√íN CH·ªñ
                    if (cName) {
                        db.ref('customers/' + curPhone).update({
                            companionName: cName, compName: cName, companionPhone: cPhone, compPhone: cPhone,
                            lastCompName: cName, lastCompPhone: cPhone
                        });
                    }
                    db.ref('bedBookings').push({
                        phone: curPhone, name: userData.name || "Kh√°ch h√†ng",
                        date: dateStr, start: startVal, end: endVal,
                        compName: cName, compPhone: cPhone,
                        bedId: "", status: "ch·ªù x·∫øp bed", type: "app",
                        createdAt: new Date().toISOString()
                    }, () => {
                        clearTimeout(safetyTimer); loading.classList.add('hidden');
                        showAppModal("Th√†nh c√¥ng", `ƒê√£ ch·ªët l·ªãch: <b>${startVal} - ${endVal}</b>.<br>H·∫πn g·∫∑p b·∫°n nh√©!`, '‚úÖ', () => {
                            document.getElementById('book-date').value = "";
                            showTab('user');
                        });
                    });

                } else {
                    // ---> H·∫æT CH·ªñ: G·ª¢I √ù TH√îNG MINH
                    clearTimeout(safetyTimer); loading.classList.add('hidden');
                    const suggestions = findSmartSlots(bookedSlots, sMin, eMin, dateStr);
                    showSuggestionUI(suggestions);
                }
            });
        });
    });
}
// 4. UI G·ª¢I √ù (HI·ªÜN TH·ªä QU√Ä T·∫∂NG B√ô ƒê·∫ÆP)
// 1. S·ª¨A L·∫†I GIAO DI·ªÜN G·ª¢I √ù (S·ª≠a ch·ªØ n√∫t b·∫•m th√†nh "CH·ªåN" thay v√¨ "CH·ªêT")
// =============================================================
// UI G·ª¢I √ù - TH√îNG MINH THEO S·ªê L∆Ø·ª¢NG
// =============================================================

function showSuggestionUI(suggestions) {
    let title = ""; let html = ""; let icon = "";

    if (suggestions.length === 0) {
        // CASE: KH√îNG C√íN G√å
        icon = "ü•∫"; title = "Huhu, full m·∫•t r·ªìi!";
        html = `
            <div class="text-center py-2">
                <p class="text-[#1e3932] text-sm font-medium mb-2">Ti·∫øc qu√°, h√¥m nay <b>The cafe 33</b> tr·ªôm v√≠a kh√°ch ƒë√¥ng n√™n ƒë√£ k√≠n l·ªãch v√†o gi·ªù n√†y r·ªìi ·∫°.</p>
                <p class="text-gray-500 text-xs italic">B·∫°n vui l√≤ng ch·ªçn sang ng√†y mai ho·∫∑c khung gi·ªù kh√°c xa h∆°n nh√©. H·∫πn g·∫∑p b·∫°n s·ªõm! ‚ù§Ô∏è</p>
            </div>`;
    } 
    else if (suggestions.length === 1) {
        // CASE: ƒê·ªòC QUY·ªÄN (WINNER) - CH·ªà HI·ªÜN 1 C√ÅI
        const s = suggestions[0];
        
        // T√≠nh gi·ªù hi·ªÉn th·ªã
        const h1 = Math.floor(s.start / 60).toString().padStart(2, '0');
        const m1 = (s.start % 60).toString().padStart(2, '0');
        const h2 = Math.floor(s.end / 60).toString().padStart(2, '0');
        const m2 = (s.end % 60).toString().padStart(2, '0');
        const timeStr = `${h1}:${m1} - ${h2}:${m2}`;
        
        icon = "üéØ"; // Icon bia m·ª•c ti√™u (Chu·∫©n x√°c)
        title = "T√¨m th·∫•y ch·ªó ngay g·∫ßn ƒë√≥!";
        
        // L·ªùi tho·∫°i kh·∫≥ng ƒë·ªãnh ch·∫Øc n·ªãch
        html = `
            <p class="text-[#1e3932] text-sm font-medium mb-4 text-left leading-relaxed">
                Gi·ªù b·∫°n ch·ªçn v·ª´a k√≠n, nh∆∞ng <b>The cafe 33</b> t√¨m th·∫•y m·ªôt khung gi·ªù <b>ho√†n h·∫£o</b> ngay s√°t b√™n cho b·∫°n ƒë√¢y:
            </p>
            
            <div onclick="applyAutoBook('${timeStr}')" class="suggestion-box cursor-pointer group" style="border: 2px solid #006241; background: #f0fdf9;">
                <div class="suggestion-left">
                    <div class="suggestion-time" style="color: #006241; font-size: 18px;">${timeStr}</div>
                    <div class="suggestion-note text-[#006241] font-bold">‚úÖ ${s.note}</div>
                </div>
                <div class="btn-pick-now group-active:scale-95 transition-transform" style="padding: 12px 20px;">CH·ªêT NGAY</div>
            </div>
            
            <p class="text-[10px] text-gray-400 text-center mt-3 italic">*ƒê·∫£m b·∫£o ƒë·ªß s·ªë ph√∫t s·ª≠ d·ª•ng lu√¥n ƒë√≥</p>
        `;

    } else {
        // CASE: 3 L·ª∞A CH·ªåN (KHI KH√îNG C√ì C√ÅI N√ÄO HO√ÄN H·∫¢O)
        icon = "‚ú®"; title = "Ti·∫øc qu√°, v·ª´a c√≥ kh√°ch ƒë·∫∑t!";
        html = `
            <p class="text-[#1e3932] text-sm font-medium mb-4 text-left leading-relaxed">
                Khung gi·ªù b·∫°n ch·ªçn v·ª´a kh√≠t c√≥ ng∆∞·ªùi ƒë·∫∑t tr∆∞·ªõc m·∫•t r·ªìi.<br>
                Nh∆∞ng ƒë·ª´ng lo, <b>The cafe 33</b> ƒë√£ nhanh tay gi·ªØ l·∫°i <b> c√°c l·ª±a ch·ªçn "x·ªãn" nh·∫•t</b> d√†nh ri√™ng cho b·∫°n:
            </p>
        `;
        
        suggestions.forEach(s => {
            const h1 = Math.floor(s.start / 60).toString().padStart(2, '0');
            const m1 = (s.start % 60).toString().padStart(2, '0');
            const h2 = Math.floor(s.end / 60).toString().padStart(2, '0');
            const m2 = (s.end % 60).toString().padStart(2, '0');
            const timeStr = `${h1}:${m1} - ${h2}:${m2}`;
            
            const bonusHtml = s.bonus 
                ? `<div class="suggestion-bonus-badge">${s.bonus}</div>` 
                : `<div class="suggestion-note">‚úÖ ${s.note}</div>`;

            html += `
            <div onclick="applyAutoBook('${timeStr}')" class="suggestion-box cursor-pointer group">
                <div class="suggestion-left"><div class="suggestion-time">${timeStr}</div>${bonusHtml}</div>
                <div class="btn-pick-now group-active:scale-95 transition-transform">D√ôNG GI·ªú N√ÄY</div>
            </div>`;
        });
        html += `<p class="text-[10px] text-gray-400 text-center mt-3 italic">*B·∫•m ch·ªçn ƒë·ªÉ ƒëi·ªÅn t·ª± ƒë·ªông v√†o phi·∫øu ƒë·∫∑t</p>`;
    }

    showAppModal(title, html, icon);
}
// 5. AUTO BOOK KHI KH√ÅCH CH·ªåN G·ª¢I √ù
// 2. S·ª¨A L·∫†I H√ÄM "CH·ªåN GI·ªú" (QUAN TR·ªåNG NH·∫§T)
// Ch·ªâ ƒëi·ªÅn gi·ªù -> Kh√¥ng ƒë·∫∑t ngay -> Nh·∫Øc kh√°ch b·∫•m n√∫t
function applyAutoBook(timeRange) {
    const s = timeRange.split(' - ')[0];
    const e = timeRange.split(' - ')[1];
    
    // 1. ƒêi·ªÅn gi·ªù m·ªõi v√†o √¥ nh·∫≠p li·ªáu
    document.getElementById('book-start').value = s;
    document.getElementById('book-end').value = e;
    
    // 2. T·∫Øt Modal g·ª£i √Ω hi·ªán t·∫°i
    document.getElementById('modal-overlay').classList.add('hidden');
    
    // 3. Hi·ªán th√¥ng b√°o nh·∫Øc nh·ªü (ƒê·ªÉ kh√°ch t·ª± b·∫•m n√∫t ƒë·∫∑t)
    setTimeout(() => {
        showAppModal(
            "ƒê√£ c·∫≠p nh·∫≠t gi·ªù", 
            `Th·ªùi gian ƒë√£ ƒë∆∞·ª£c ƒë·ªïi th√†nh: <br><b class="text-xl text-[#006241]">${timeRange}</b><br><br>
            Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin v√† b·∫•m n√∫t <br><b>"X√ÅC NH·∫¨N ƒê·∫∂T CH·ªñ"</b> ƒë·ªÉ ho√†n t·∫•t nh√©! üëá`, 
            "üëå"
        );
        
        // (T√πy ch·ªçn) Cu·ªôn m√†n h√¨nh xu·ªëng n√∫t ƒë·∫∑t cho kh√°ch d·ªÖ th·∫•y
        const btn = document.getElementById('btn-booking');
        if(btn) btn.scrollIntoView({behavior: "smooth", block: "center"});
        
    }, 300);
}
// --- 6. QU√Ä & L·ªäCH S·ª¨ ---
function loadRewards() {
    db.ref('rewards').on('value', snap => {
        const list = document.getElementById('rewards-list');
        list.innerHTML = "";
        const rewards = snap.val();
        
        if (!rewards) { 
            list.innerHTML = '<div class="text-center text-gray-400 py-10 italic text-xs">Ch∆∞a c√≥ qu√†.</div>'; 
            return; 
        }
        
        // L∆∞u cache ƒë·ªÉ d√πng khi m·ªü modal chi ti·∫øt
        _cachedGiftList = Object.values(rewards);

        _cachedGiftList.forEach((item, index) => {
            list.innerHTML += `
            <div onclick="openGiftDetail(${index})" class="bg-white p-4 rounded-[2rem] border border-gray-100 shadow-sm flex items-center gap-4 mb-3 relative overflow-hidden group active:scale-[0.98] transition-transform cursor-pointer hover:shadow-md">
                <div class="shrink-0 w-24 h-24 rounded-3xl overflow-hidden border border-gray-100 bg-gray-50"><img src="${item.img || ''}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/150'"></div>
                <div class="flex-1 min-w-0"><p class="font-bold text-sm text-[#1e3932] mb-1 uppercase truncate">${item.name}</p><p class="text-[10px] text-gray-400 mb-2 line-clamp-2">${item.desc || '...'}</p><p class="text-md text-[#006241] font-black brand-font">${item.cost.toLocaleString()} <span class="text-amber-500 text-xs">‚òÖ</span></p></div>
                <div class="shrink-0 w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 group-hover:bg-[#006241] group-hover:text-white transition-colors">‚ûú</div>
            </div>`;
        });
    });
}

function openGiftDetail(index) {
    const item = _cachedGiftList[index];
    if (!item) return;
    document.getElementById('detail-gift-name').innerText = item.name;
    document.getElementById('detail-gift-desc').innerText = item.desc || '...';
    document.getElementById('detail-gift-cost').innerText = item.cost.toLocaleString() + ' ‚òÖ';
    document.getElementById('detail-gift-img').src = item.img || '';
    document.getElementById('detail-user-point').innerText = userData.points.toLocaleString() + ' ‚òÖ';
    let percent = (userData.points / item.cost) * 100; if (percent > 100) percent = 100;
    document.getElementById('detail-progress').style.width = percent + '%';

    const btn = document.getElementById('btn-confirm-redeem');
    const msg = document.getElementById('detail-message');
    const prog = document.getElementById('detail-progress');

    if (userData.points >= item.cost) {
        btn.disabled = false; btn.innerHTML = 'X√ÅC NH·∫¨N ƒê·ªîI NGAY';
        btn.className = "w-full py-4 rounded-2xl bg-[#006241] text-white font-bold text-sm uppercase tracking-widest shadow-lg active:scale-[0.98] transition-transform";
        btn.onclick = () => { document.getElementById('gift-detail-modal').classList.add('hidden'); redeemGift(item.name, item.cost); };
        prog.className = "h-full bg-[#006241] rounded-full transition-all duration-500";
        msg.classList.add('hidden');
    } else {
        btn.disabled = true; btn.innerHTML = 'CH∆ØA ƒê·ª¶ ƒêI·ªÇM';
        btn.className = "w-full py-4 rounded-2xl bg-gray-300 text-gray-500 font-bold text-sm uppercase tracking-widest cursor-not-allowed";
        prog.className = "h-full bg-red-500 rounded-full transition-all duration-500";
        msg.classList.remove('hidden'); msg.innerText = `Thi·∫øu ${(item.cost - userData.points).toLocaleString()} ‚òÖ n·ªØa.`;
    }
    document.getElementById('gift-detail-modal').classList.remove('hidden');
}

function redeemGift(name, cost) {
    if(!confirm(`ƒê·ªïi ${name} v·ªõi ${cost} ƒëi·ªÉm?`)) return;
    const np = (userData.points || 0) - cost;
    if(np < 0) return alert("L·ªói ƒëi·ªÉm");
    
    document.getElementById('loading-overlay').classList.remove('hidden');
    db.ref('customers/' + curPhone).update({ points: np });
    // 2. [M·ªöI] Hi·ªán th√¥ng b√°o y√™u c·∫ßu ch·ª•p m√†n h√¨nh
    setTimeout(() => {
        document.getElementById('loading-overlay').classList.add('hidden');
        document.getElementById('gift-detail-modal').classList.add('hidden'); // T·∫Øt modal chi ti·∫øt qu√† c≈© ƒëi
        
        // Hi·ªán Modal th√¥ng b√°o th√†nh c√¥ng + L·ªùi nh·∫Øc ch·ª•p m√†n h√¨nh
        showAppModal(
            "ƒê·ªïi qu√† th√†nh c√¥ng!", 
            `<div class="text-left">
                <p class="text-sm text-[#1e3932] mb-2">B·∫°n ƒë√£ ƒë·ªïi th√†nh c√¥ng m√≥n:</p>
                <p class="text-2xl font-black text-[#006241] mb-4 brand-font uppercase">${name}</p>
                
                <div class="bg-yellow-50 p-4 rounded-2xl border border-yellow-100 shadow-sm">
                    <p class="text-red-500 font-bold text-[10px] uppercase mb-1 tracking-wider">‚ö†Ô∏è QUAN TR·ªåNG:</p>
                    <p class="text-[#1e3932] text-sm font-bold leading-relaxed">
                        Vui l√≤ng <span class="underline decoration-2 decoration-red-500">ch·ª•p l·∫°i m√†n h√¨nh n√†y</span> v√† ƒë∆∞a cho The cafe 33 xem l√∫c order ƒë·ªÉ qu√† ƒë∆∞·ª£c √°p d·ª•ng.
                    </p>
                </div>
            </div>`, 
            "üì∏" // Icon m√°y ·∫£nh cho d·ªÖ hi·ªÉu
        );
    }, 500);
    fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST', mode: 'no-cors',
        body: JSON.stringify({ action: 'logRedeem', phone: curPhone, custName: userData.name, giftName: name, pointCost: cost })
    }).finally(() => {
        document.getElementById('loading-overlay').classList.add('hidden');
        alert("ƒê·ªïi th√†nh c√¥ng!");
    });
}

// --- H√ÄM XEM L·ªäCH S·ª¨ ƒê·∫∂T BED (ƒê√É S·ª¨A: L·∫§Y T·ª™ FIREBASE) ---
// --- H√ÄM XEM L·ªäCH S·ª¨ (ƒê√É FIX L·ªñI ·∫®N ƒê∆†N) ---
// --- H√ÄM XEM L·ªäCH S·ª¨ (ƒê√É FIX: HI·ªÜN ƒê·∫¶Y ƒê·ª¶ KH√îNG S√ìT) ---
// --- H√ÄM XEM L·ªäCH S·ª¨ (ƒê√É FIX: HI·ªÜN TO√ÄN B·ªò KH√îNG B·ªé S√ìT) ---
// --- BI·∫æN TO√ÄN C·ª§C L∆ØU CACHE L·ªäCH S·ª¨ ---
// --- BI·∫æN CACHE TO√ÄN C·ª§C ---
let _historyCache = [];

// 1. H√ÄM M·ªû DANH S√ÅCH L·ªäCH S·ª¨ (ƒê√£ s·ª≠a: Hi·ªán ch·ªØ "ƒê√É H·ª¶Y" ·ªü d√≤ng V·ªã tr√≠)
// --- H√ÄM XEM L·ªäCH S·ª¨ (ƒê√É FIX: CH·ªà HI·ªÜN H√îM NAY + TR·∫†NG TH√ÅI TR·ªêNG) ---
// --- H√ÄM XEM L·ªäCH S·ª¨ (ƒê√É FIX: C·∫¨P NH·∫¨T CACHE ƒê·ªÇ M·ªû ƒê∆Ø·ª¢C POPUP) ---
function openHistory() {
    document.getElementById('history-modal').classList.remove('hidden');
    document.getElementById('history-loading').classList.remove('hidden');
    
    const listDiv = document.getElementById('history-list');
    const activeDiv = document.getElementById('section-active-booking');
    
    listDiv.innerHTML = ''; 
    activeDiv.classList.add('hidden'); // M·∫∑c ƒë·ªãnh ·∫©n tr∆∞·ªõc

    // L·∫•y d·ªØ li·ªáu
    db.ref('bedBookings').orderByChild('phone').equalTo(curPhone).once('value', snap => {
        document.getElementById('history-loading').classList.add('hidden');
        
        // 1. C·∫¨P NH·∫¨T BI·∫æN TO√ÄN C·ª§C (QUAN TR·ªåNG NH·∫§T)
        _historyCache = []; 
        snap.forEach(c => { 
            const val = c.val(); 
            if(val) _historyCache.push({key: c.key, ...val}); 
        });

        // 2. S·∫Øp x·∫øp ngay tr√™n bi·∫øn _historyCache
        _historyCache.sort((a,b) => {
            try { 
                return (b.date.split('/').reverse().join('') + b.start)
                       .localeCompare(a.date.split('/').reverse().join('') + a.start); 
            } catch(e){ return 0 }
        });

        // 3. X·ª≠ l√Ω logic hi·ªÉn th·ªã
        const todayObj = new Date();
        const d = String(todayObj.getDate()).padStart(2,'0');
        const m = String(todayObj.getMonth()+1).padStart(2,'0');
        const y = todayObj.getFullYear();
        const todayStr1 = `${d}/${m}/${y}`;
        const todayStr2 = `${y}-${m}-${d}`;

        // T√¨m ƒë∆°n h√¥m nay
        let todayBooking = _historyCache.find(h => {
            const s = (h.status || "").toLowerCase();
            const isActive = (s !== 'ƒë√£ h·ªßy' && s !== 'ƒë√£ xong');
            const isToday = (h.date === todayStr1 || h.date === todayStr2);
            return isActive && isToday;
        });

        // V·∫Ω th·∫ª Active (H√¥m nay)
        activeDiv.classList.remove('hidden');
        let activeContent = '';
        
        if (todayBooking) {
            const h = todayBooking;
            const bedText = (h.bedId && h.bedId != "WAITING") ? "BED 0" + h.bedId : "Ch·ªù x·∫øp...";
            const allowCancel = (h.status || "").includes('ch·ªù') ? '' : 'hidden'; 

            activeContent = `
                <div id="active-card" class="bg-white rounded-2xl p-5 shadow-sm border border-amber-100 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-3 bg-amber-100 text-amber-800 text-[10px] font-bold rounded-bl-2xl shadow-sm animate-pulse">H√îM NAY</div>
                    <div class="mb-4">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">üìÖ ${h.date}</p>
                        <p class="text-3xl font-black text-[#1e3932] tracking-tight">${h.start}</p>
                        <p class="text-sm text-gray-500 font-bold mt-1">ƒê·∫øn: ${h.end} ‚Ä¢ <span class="text-[#006241]">${bedText}</span></p>
                    </div>
                    <div class="flex gap-2">
                       <button onclick="openRescheduleModal('${h.key}')" class="flex-1 py-3 rounded-xl bg-blue-50 text-blue-600 font-bold text-xs border border-blue-100 hover:bg-blue-100 active:scale-95 transition-all">ƒê·ªïi gi·ªù</button>
                        <button onclick="cancelBooking('${h.key}')" class="flex-1 py-3 rounded-xl bg-red-50 text-red-600 font-bold text-xs border border-red-100 ${allowCancel}">üóëÔ∏è H·ªßy</button>
                    </div>
                </div>`;
        } else {
            activeContent = `
                <div class="bg-white/50 border-2 border-dashed border-gray-200 rounded-2xl p-6 text-center">
                    <p class="text-2xl mb-2">üõèÔ∏è</p>
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">B·∫°n ch∆∞a c√≥ l·ªãch ƒë·∫∑t bed h√¥m nay</p>
                    <button onclick="document.getElementById('history-modal').classList.add('hidden'); showTab('bed')" class="mt-3 text-[10px] font-bold text-[#006241] uppercase hover:underline">ƒê·∫∑t ngay +</button>
                </div>`;
        }
        activeDiv.innerHTML = `<h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 ml-1">L·ªãch tr√¨nh h√¥m nay</h3>` + activeContent;

        // V·∫Ω danh s√°ch l·ªãch s·ª≠ c≈©
        if (_historyCache.length === 0) {
            listDiv.innerHTML = '<div class="text-center text-gray-400 text-sm italic py-10">Ch∆∞a c√≥ l·ªãch s·ª≠ n√†o.</div>';
        } else {
            _historyCache.forEach(h => {
                if (todayBooking && h.key === todayBooking.key) return; // B·ªè qua c√°i ƒë√£ hi·ªán ·ªü tr√™n

                let clr = "text-gray-500 bg-gray-100"; let txt = h.status || "---";
                if (txt.includes('xong')) { clr = "text-green-700 bg-green-50"; txt = "HO√ÄN TH√ÄNH"; }
                else if (txt.includes('h·ªßy')) { clr = "text-red-500 bg-red-50"; txt = "ƒê√É H·ª¶Y"; }

                let locationText = (h.status||"").includes('h·ªßy') ? '<span class="text-red-400 font-bold">ƒê√É H·ª¶Y</span>' : (h.bedId ? "BED 0"+h.bedId : "ƒêang x·∫øp...");

                listDiv.innerHTML += `
                <div onclick="showHistoryDetail('${h.key}')" class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col gap-2 relative mb-2 active:scale-95 transition-transform cursor-pointer">
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">üìÖ ${h.date}</span>
                        <span class="px-2.5 py-1 rounded-lg text-[9px] font-black uppercase ${clr}">${txt}</span>
                    </div>
                    <div class="flex justify-between items-end">
                        <div><p class="text-lg font-black text-[#1e3932] leading-none">${h.start} - ${h.end}</p><p class="text-[10px] text-gray-400 font-bold mt-1">V·ªã tr√≠: <span class="text-gray-600">${locationText}</span></p></div>
                        ${h.totalSpend ? `<span class="text-xs font-bold text-[#006241]">-${Number(h.totalSpend).toLocaleString()}ƒë</span>` : ''}
                    </div>
                </div>`;
            });
        }
    });
}

// C√°c h√†m ph·ª• tr·ª£ popup
function closeHistoryDetail() { document.getElementById('detail-history-modal').classList.add('hidden'); }
function toggleViolationDetail() { document.getElementById('violation-detail-box').classList.toggle('hidden'); }
// --- H√ÄM H·ª¶Y L·ªäCH (C·∫¨P NH·∫¨T TR·ª∞C TI·∫æP FIREBASE) ---//
function cancelBooking(key) {
    if(!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën h·ªßy l·ªãch n√†y?")) return;
    
    document.getElementById('loading-overlay').classList.remove('hidden');
    
    // C·∫≠p nh·∫≠t tr·∫°ng th√°i tr√™n Firebase
    db.ref('bedBookings/' + key).update({ 
        status: 'ƒë√£ h·ªßy', 
        note: 'Kh√°ch t·ª± h·ªßy qua App' 
    }, (error) => {
        document.getElementById('loading-overlay').classList.add('hidden');
        if (error) {
            alert("L·ªói: " + error.message);
        } else {
            alert("ƒê√£ h·ªßy l·ªãch th√†nh c√¥ng.");
            // T·∫£i l·∫°i danh s√°ch ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán
            openHistory();
        }
    });
}
  // --- LOGIC POPUP CHI TI·∫æT (APPLE STYLE) ---

// --- H√ÄM HI·ªÜN CHI TI·∫æT L·ªäCH S·ª¨ (AN TO√ÄN - KH√îNG B·ªä ƒê∆†) ---
function showHistoryDetail(key) {
    const item = _historyCache.find(i => i.key === key);
    if(!item) return;

    const isCancelled = (item.status || "").includes('h·ªßy');
    
    // 1. ƒêi·ªÅn th√¥ng tin c∆° b·∫£n
    document.getElementById('dh-date').innerText = item.date;
    document.getElementById('dh-in').innerText = item.start;
    document.getElementById('dh-out').innerText = item.end;

    // 2. X·ª≠ l√Ω Header M√†u & T√™n (C√≥ ki·ªÉm tra l·ªói ƒë·ªÉ kh√¥ng b·ªã treo)
    const header = document.getElementById('dh-header');
    const bedLabel = document.getElementById('dh-bed');
    const durationLabel = document.getElementById('dh-duration');

    if (header) {
        // X√≥a m√†u c≈©
        header.classList.remove('from-[#006241]', 'to-[#1e3932]', 'from-red-500', 'to-red-800');

        if (isCancelled) {
            // STYLE H·ª¶Y: M√ÄU ƒê·ªé
            header.classList.add('from-red-500', 'to-red-800');
            bedLabel.innerText = "ƒê√É H·ª¶Y L·ªäCH";
            durationLabel.innerText = "Ch∆∞a s·ª≠ d·ª•ng";
            durationLabel.className = "text-3xl font-black text-gray-400 brand-font mt-1";
        } else {
            // STYLE TH∆Ø·ªúNG: M√ÄU XANH
            header.classList.add('from-[#006241]', 'to-[#1e3932]');
            bedLabel.innerText = item.bedId ? "BED 0" + item.bedId : "CH∆ØA X·∫æP";
            
            // T√≠nh gi·ªù
            const s = parseInt(item.start.split(':')[0])*60 + parseInt(item.start.split(':')[1]);
            const e = parseInt(item.end.split(':')[0])*60 + parseInt(item.end.split(':')[1]);
            let diff = e - s;
            if(diff < 0) diff = 0;
            const h = Math.floor(diff/60);
            const m = diff % 60;
            
            durationLabel.innerText = `${h} gi·ªù ${m} ph√∫t`;
            durationLabel.className = "text-3xl font-black text-[#006241] brand-font mt-1";
        }
    }

    // 3. X·ª≠ l√Ω n√∫t Vi Ph·∫°m
    const badge = document.getElementById('violation-badge');
    const vList = document.getElementById('violation-list');
    vList.innerHTML = "";
    
    let errors = [];
    if(item.violations && Array.isArray(item.violations)) errors = item.violations;
    else if (item.note && (item.note.includes('·ªìn') || item.note.includes('v·ªá sinh') || item.note.includes('ph·∫°t'))) errors.push(item.note);
    
    if(errors.length > 0) {
        badge.innerText = errors.length;
        badge.classList.remove('hidden'); badge.classList.add('flex');
        errors.forEach(err => { vList.innerHTML += `<li class="border-b border-gray-50 pb-1 last:border-0 last:pb-0">‚ö†Ô∏è ${err}</li>`; });
    } else {
        badge.classList.add('hidden');
        vList.innerHTML = `<li class="text-gray-400 italic">Kh√¥ng c√≥ vi ph·∫°m n√†o.</li>`;
    }

    // 4. M·ªû POPUP (Quan tr·ªçng nh·∫•t)
    document.getElementById('violation-detail-box').classList.add('hidden');
    document.getElementById('detail-history-modal').classList.remove('hidden');
}
function closeHistoryDetail() {
    document.getElementById('detail-history-modal').classList.add('hidden');
}

function toggleViolationDetail() {
    const box = document.getElementById('violation-detail-box');
    box.classList.toggle('hidden');
}
  // =========================================================
// LOGIC ƒê·ªîI GI·ªú (RESCHEDULE)
// =========================================================
let editingBookingKey = null; // Bi·∫øn l∆∞u xem ƒëang s·ª≠a ƒë∆°n n√†o

// 1. M·ªû MODAL V√Ä ƒêI·ªÄN D·ªÆ LI·ªÜU C≈®
function openRescheduleModal(key) {
    // T√¨m th√¥ng tin ƒë∆°n trong cache
    const booking = _historyCache.find(b => b.key === key);
    if (!booking) return alert("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu!");

    editingBookingKey = key; // L∆∞u key l·∫°i ƒë·ªÉ l√°t update

    // Chuy·ªÉn ƒë·ªïi ng√†y t·ª´ dd/mm/yyyy (Firebase) sang yyyy-MM-dd (Input Date)
    const p = booking.date.split('/');
    const isoDate = `${p[2]}-${p[1]}-${p[0]}`;

    // ƒêi·ªÅn v√†o √¥ input
    document.getElementById('re-date').value = isoDate;
    document.getElementById('re-start').value = booking.start;
    document.getElementById('re-end').value = booking.end;

    // Gi·ªõi h·∫°n ng√†y (kh√¥ng cho ch·ªçn qu√° kh·ª©)
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('re-date').setAttribute('min', today);

    // Hi·ªán Modal
    document.getElementById('history-modal').classList.add('z-[80]'); // H·∫° z-index l·ªãch s·ª≠ xu·ªëng t√≠
    document.getElementById('reschedule-modal').classList.remove('hidden');
}

// 2. X·ª¨ L√ù KHI B·∫§M "X√ÅC NH·∫¨N ƒê·ªîI"
function submitReschedule() {
    if (!editingBookingKey) return;

    // A. L·∫•y d·ªØ li·ªáu m·ªõi
    const dateVal = document.getElementById('re-date').value;
    const start = document.getElementById('re-start').value;
    const end = document.getElementById('re-end').value;

    // B. Validate c∆° b·∫£n (Gi·ªëng h·ªát l√∫c ƒë·∫∑t m·ªõi)
    if(!dateVal || !start || !end) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß ng√†y gi·ªù!");
    if(start >= end) return alert("Gi·ªù k·∫øt th√∫c ph·∫£i sau gi·ªù b·∫Øt ƒë·∫ßu!");
    if(start < "08:00" || end > "20:50") return alert("Qu√°n ho·∫°t ƒë·ªông 08:00 - 20:50");
    
    const sMin = parseInt(start.split(':')[0])*60 + parseInt(start.split(':')[1]);
    const eMin = parseInt(end.split(':')[0])*60 + parseInt(end.split(':')[1]);
    if(eMin - sMin < 30) return alert("T·ªëi thi·ªÉu 30 ph√∫t!");

    // C. Ki·ªÉm tra tr√πng l·ªãch (Collision Check)
    document.getElementById('loading-overlay').classList.remove('hidden');
    
    // Convert ng√†y sang format dd/mm/yyyy ƒë·ªÉ so s√°nh v·ªõi Database
    const p = dateVal.split('-');
    const dateStr = `${p[2]}/${p[1]}/${p[0]}`;

    db.ref('bedBookings').orderByChild('date').equalTo(dateStr).once('value', snap => {
        let overlapCount = 0;
        
        snap.forEach(c => {
            const v = c.val();
            // B·ªè qua ƒë∆°n ƒë√£ h·ªßy, ƒë√£ xong V√Ä CH√çNH ƒê∆†N ƒêANG S·ª¨A (Quan tr·ªçng!)
            if(c.key !== editingBookingKey && v.status !== 'ƒë√£ h·ªßy' && v.status !== 'ƒë√£ xong') {
                const bs = parseInt(v.start.split(':')[0])*60 + parseInt(v.start.split(':')[1]);
                const be = parseInt(v.end.split(':')[0])*60 + parseInt(v.end.split(':')[1]);
                
                // Logic tr√πng gi·ªù
                if(Math.max(sMin, bs) < Math.min(eMin, be)) {
                    overlapCount++;
                }
            }
        });

        // Gi·∫£ s·ª≠ qu√°n c√≥ 4 Bed (S·ª≠a s·ªë 4 n·∫øu qu√°n Ti√™n sinh nhi·ªÅu bed h∆°n)
        if (overlapCount < 4) {
            // D. OK -> C·∫≠p nh·∫≠t Firebase
            db.ref('bedBookings/' + editingBookingKey).update({
                date: dateStr,
                start: start,
                end: end,
                status: 'ch·ªù x·∫øp bed', // Reset v·ªÅ ch·ªù x·∫øp ƒë·ªÉ nh√¢n vi√™n x·∫øp l·∫°i bed
                bedId: ""              // X√≥a bed c≈© v√¨ gi·ªù m·ªõi c√≥ th·ªÉ bed ƒë√≥ b·∫≠n
            }, (error) => {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('reschedule-modal').classList.add('hidden');
                
                if(error) alert("L·ªói: " + error.message);
                else {
                    showAppModal("Th√†nh c√¥ng", "ƒê√£ ƒë·ªïi l·ªãch th√†nh c√¥ng!<br>ƒê·∫øn ƒë√∫ng gi·ªù nh√©!.", "‚úÖ");
                    openHistory(); // Load l·∫°i danh s√°ch
                }
            });
        } else {
            // E. H·∫øt ch·ªó
            document.getElementById('loading-overlay').classList.add('hidden');
            alert(`Khung gi·ªù n√£y ƒë√£ full (${overlapCount}). Ch·ªçn gi·ªù kh√°c nha`);
        }
    });
}
  // --- H√ÄM ƒêƒÇNG XU·∫§T ---
window.handleLogout = function() {
    // 1. H·ªèi x√°c nh·∫≠n cho ch·∫Øc
    if(confirm("N·∫øu anh ƒëi, tr√°i tim n√†y bu·ªìn bi·∫øt m·∫•y, out thi·ªát h·∫£")) {
        
        // 2. X√≥a s·ªë ƒëi·ªán tho·∫°i ƒë√£ l∆∞u trong m√°y
        localStorage.removeItem('member_phone');
        
        // 3. T·∫£i l·∫°i trang -> T·ª± ƒë·ªông quay v·ªÅ m√†n h√¨nh ƒëƒÉng nh·∫≠p
        location.reload();
    }
}
  
</script>
  <div id="detail-history-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6 transition-all duration-300">
    <div class="absolute inset-0 bg-black/30 backdrop-blur-md" onclick="closeHistoryDetail()"></div>
    
    <div class="relative bg-white/90 backdrop-blur-xl w-full max-w-sm rounded-[2.5rem] shadow-[0_20px_50px_rgba(0,0,0,0.2)] overflow-hidden animate-fade-in border border-white/50">
        
        <div id="dh-header" class="h-32 bg-gradient-to-br from-[#006241] to-[#1e3932] relative flex items-center justify-center">
            <p class="text-[80px] opacity-10">‚òï</p>
            <div class="absolute -bottom-10 w-full flex justify-center">
                <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center shadow-lg text-3xl">
                    üõå
                </div>
            </div>
            <button onclick="closeHistoryDetail()" class="absolute top-5 right-5 w-8 h-8 bg-black/20 text-white rounded-full flex items-center justify-center backdrop-blur-sm hover:bg-black/30 transition">‚úï</button>
        </div>

        <div class="pt-12 pb-8 px-8 text-center">
            <h3 class="brand-font text-2xl text-[#1e3932] mb-1" id="dh-date">--/--/----</h3>
            <p class="text-xs text-gray-400 font-bold uppercase tracking-widest mb-6" id="dh-bed">BED --</p>

            <div class="flex justify-between items-center bg-gray-50/80 rounded-3xl p-5 border border-white shadow-inner mb-6">
                <div class="text-left">
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Check-in</p>
                    <p class="text-xl font-black text-[#1e3932]" id="dh-in">--:--</p>
                </div>
                <div class="h-8 w-[1px] bg-gray-200"></div>
                <div class="text-right">
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Check-out</p>
                    <p class="text-xl font-black text-[#1e3932]" id="dh-out">--:--</p>
                </div>
            </div>

            <div class="mb-8">
                <p class="text-xs text-gray-400 font-medium">T·ªïng th·ªùi gian s·ª≠ d·ª•ng</p>
                <p class="text-3xl font-black text-[#006241] brand-font mt-1" id="dh-duration">-- gi·ªù -- ph√∫t</p>
            </div>

            <div id="violation-container" class="relative inline-block group">
                <button onclick="toggleViolationDetail()" class="w-16 h-16 rounded-full bg-white shadow-[0_8px_20px_rgba(0,0,0,0.1)] flex items-center justify-center text-2xl transition-transform active:scale-95 border border-gray-100 relative">
                    ‚ö†Ô∏è
                    <div id="violation-badge" class="absolute -top-1 -right-1 w-6 h-6 bg-[#FF3B30] text-white text-[10px] font-bold rounded-full flex items-center justify-center shadow-md hidden">0</div>
                </button>
                <p class="text-[10px] text-gray-400 font-bold mt-2">B√°o c√°o vi ph·∫°m</p>
                
                <div id="violation-detail-box" class="hidden absolute bottom-full left-1/2 -translate-x-1/2 mb-3 w-48 bg-white/95 backdrop-blur-md p-3 rounded-2xl shadow-xl border border-gray-100 text-left z-10 animate-fade-in">
                    <p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Chi ti·∫øt l·ªói:</p>
                    <ul id="violation-list" class="text-xs text-[#1e3932] font-medium space-y-1">
                        </ul>
                    <div class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-white rotate-45 border-b border-r border-gray-100"></div>
                </div>
            </div>

        </div>
    </div>
</div>
</body>
</html>

























































