<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#006241">
  
  <link rel="icon" href="https://i.ibb.co/nqdTWnvt/N-u-v-N-u-v-ng-Ngh-thu-t-s-p-ch-In-m-Ti-m-c-ph-Bi-u-tr-ng-C-ph-20260121-210413-0000.png">
  <link rel="apple-touch-icon" href="https://i.ibb.co/nqdTWnvt/N-u-v-N-u-v-ng-Ngh-thu-t-s-p-ch-In-m-Ti-m-c-ph-Bi-u-tr-ng-C-ph-20260121-210413-0000.png">
  
  <link rel="manifest" href='data:application/manifest+json,{
    "name": "Cafe 33 Member",
    "short_name": "Cafe 33",
    "display": "standalone",
    "start_url": ".",
    "background_color": "#006241",
    "theme_color": "#006241",
    "icons": [{
      "src": "https://i.ibb.co/nqdTWnvt/N-u-v-N-u-v-ng-Ngh-thu-t-s-p-ch-In-m-Ti-m-c-ph-Bi-u-tr-ng-C-ph-20260121-210413-0000.png",
      "sizes": "192x192",
      "type": "image/png"
    }]
  }'>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=League+Spartan:wght@700;800&display=swap" rel="stylesheet">
  <style>
    /* CSS CH·ªêNG RELOAD & ZOOM */
    html, body {
        overscroll-behavior-y: none; 
        touch-action: pan-x pan-y;
        margin: 0; padding: 0; height: 100%; width: 100%;
        -webkit-tap-highlight-color: transparent;
    }
    body { 
        background-color: #f8f9fa; 
        font-family: 'Inter', sans-serif; 
        color: #1e3932; 
        text-align: left; 
        -webkit-font-smoothing: antialiased;
        overflow-y: auto; /* Cho ph√©p cu·ªôn n·ªôi dung */
    }
    .brand-font { font-family: 'League Spartan', sans-serif; font-weight: 800; letter-spacing: -0.01em; }
    .sb-green { background-color: #006241; }
    .card-gradient { background: linear-gradient(135deg, #004d33 0%, #006241 100%); }
    .nav-active { color: #006241; font-weight: 800; background-color: rgba(0, 98, 65, 0.05); border-radius: 1.5rem; }
    .tab-content { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    #custom-modal, #image-overlay { transition: all 0.3s ease; }
    .modal-enter { opacity: 0; transform: scale(0.9); }
    .modal-show { opacity: 1; transform: scale(1); }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #D1D1D6; border-radius: 10px; }
  </style>
</head>
<body class="min-h-screen pb-32">

  <div id="loading-overlay" class="fixed inset-0 bg-white/95 z-[9999] hidden flex flex-col items-center justify-center backdrop-blur-sm">
    <div class="w-14 h-14 border-4 border-[#006241] border-t-transparent rounded-full animate-spin mb-4"></div>
    <p class="brand-font text-[#006241] text-xl font-black animate-pulse">The cafe 33</p>
    <p class="text-xs text-gray-400 font-bold mt-2" id="loading-text">ƒêang x·ª≠ l√Ω...</p>
  </div>

  <div id="image-overlay" class="fixed inset-0 bg-black/95 z-[200] hidden flex flex-col items-center justify-center p-4 backdrop-blur-md" onclick="closeZoom()">
    <button class="absolute top-8 right-8 text-white text-5xl font-light">&times;</button>
    <div class="w-full h-full flex items-center justify-center overflow-auto"><img id="zoomed-img" src="" class="max-w-full max-h-full object-contain shadow-2xl transition-transform" onclick="event.stopPropagation()"></div>
  </div>

  <div id="modal-overlay" class="fixed inset-0 bg-black/40 z-[100] hidden flex items-center justify-center p-6 backdrop-blur-sm">
    <div id="custom-modal" class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl text-center modal-enter">
      <div id="modal-icon" class="text-5xl mb-4">‚òï</div>
      <h3 id="modal-title" class="brand-font text-2xl text-[#006241] mb-3">Th√¥ng b√°o</h3>
      <div id="modal-message" class="text-lg text-[#1e3932] font-bold mb-8 leading-relaxed brand-font"></div>
      <div id="modal-actions" class="flex flex-col gap-3">
        <button id="modal-btn-main" class="w-full py-4 sb-green text-white font-bold rounded-2xl uppercase tracking-widest text-xs shadow-lg">ƒê·ªìng √Ω</button>
        <button id="modal-btn-sub" class="w-full py-4 text-gray-400 font-bold rounded-2xl uppercase tracking-widest text-[10px] hidden">H·ªßy b·ªè</button>
      </div>
    </div>
  </div>

  <div id="login-screen" class="flex flex-col items-center justify-center min-h-screen p-8 bg-white text-center">
    <h1 class="text-5xl text-[#006241] mb-4 brand-font">The cafe 33</h1>
    <p class="text-[11px] font-bold text-gray-400 mb-12 uppercase tracking-widest">T√≠ch ƒëi·ªÉm nh·∫≠n ƒë·∫∑c quy·ªÅn</p>
    <input type="tel" id="login-sdt" placeholder="S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n..." class="w-full p-5 rounded-3xl bg-gray-50 border border-gray-100 mb-4 text-center outline-none text-lg">
    <button onclick="login()" id="btn-login" class="w-full p-5 rounded-3xl sb-green text-white font-bold shadow-md active:scale-95 transition-all uppercase text-lg">ƒêƒÉng nh·∫≠p</button>
  </div>

  <div id="main-app" class="hidden">
    <div class="p-5 bg-white shadow-sm flex justify-between items-center sticky top-0 z-50">
      <h2 class="text-2xl text-[#006241] brand-font">The cafe 33</h2>
      <div id="live-clock" class="text-[11px] font-extrabold text-[#006241] border border-gray-100 px-4 py-2 rounded-full bg-gray-50 shadow-inner">--:--</div>
    </div>

    <div id="tab-user" class="p-5 tab-content">
      <div class="card-gradient p-8 rounded-[2.5rem] text-white shadow-2xl h-60 flex flex-col justify-between relative overflow-hidden mb-8 text-left">
        <div class="flex justify-between items-start z-10"><p class="text-[10px] font-bold uppercase tracking-widest opacity-80">Member Card</p><p class="text-[14px] opacity-60 brand-font">The cafe 33</p></div>
        <div class="z-10"><p id="user-name-display" class="text-3xl font-bold uppercase tracking-wider mb-2"></p>
          <div class="flex justify-between items-end"><p id="user-rank" class="text-[12px] text-amber-400 font-bold uppercase tracking-widest"></p><div class="text-right"><span id="user-points" class="text-5xl font-black">0</span><span class="text-xs ml-1 opacity-70 font-bold">‚òÖ</span></div></div>
        </div>
        <div class="absolute -bottom-10 -right-10 w-48 h-48 bg-white/5 rounded-full blur-3xl"></div>
      </div>
      
      <div onclick="openHistory()" class="bg-white p-5 rounded-[2.5rem] shadow-sm border border-gray-100 flex items-center justify-between cursor-pointer mb-6 active:scale-95 transition-transform">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-full bg-green-50 flex items-center justify-center text-xl text-[#006241]">üìÖ</div>
            <div>
                <p class="font-bold text-[#1e3932] text-sm uppercase tracking-wider">L·ªãch s·ª≠ ƒë·∫∑t Bed</p>
                <p class="text-[10px] text-gray-400 font-bold">Xem l·ªãch tr√¨nh & H·ªßy l·ªãch</p>
            </div>
        </div>
        <div class="text-gray-300 font-bold">‚ûú</div>
      </div>

      <div class="bg-white p-7 rounded-[2.5rem] shadow-sm border border-gray-100 space-y-4 text-left">
        <h4 class="font-bold text-[10px] uppercase text-gray-400 ml-2 tracking-widest">H·ªì s∆° c·ªßa b·∫°n</h4>
        <div><label class="text-[10px] font-bold text-gray-400 ml-2 uppercase">T√™n c·ªßa b·∫°n</label><input type="text" id="edit-name" class="w-full p-4 bg-gray-50 rounded-2xl outline-none mt-1 shadow-inner"></div>
        <div><label class="text-[10px] font-bold text-gray-400 ml-2 uppercase">S·ªë ƒëi·ªán tho·∫°i</label><input type="tel" id="edit-sdt" class="w-full p-4 bg-gray-50 rounded-2xl outline-none mt-1 shadow-inner" readonly></div>
        <p class="text-[10px] font-bold text-gray-400 ml-2 uppercase pt-2 tracking-widest">Ng∆∞·ªùi ƒëi c√πng m·∫∑c ƒë·ªãnh</p>
        <div class="space-y-3"><input type="text" id="edit-cname" class="w-full p-4 bg-gray-50 rounded-2xl outline-none shadow-inner" placeholder="T√™n ng∆∞·ªùi ƒëi c√πng"><input type="tel" id="edit-cphone" class="w-full p-4 bg-gray-50 rounded-2xl outline-none shadow-inner" placeholder="SƒêT ng∆∞·ªùi ƒëi c√πng"></div>
        <button onclick="handleUpdate()" class="w-full py-4 rounded-2xl border-2 border-[#006241] text-[#006241] font-bold text-sm mt-4 uppercase tracking-widest">L∆∞u thay ƒë·ªïi</button>
      </div>
    </div>

    <div id="tab-bed" class="p-6 tab-content hidden">
      <h3 class="text-2xl text-[#006241] mb-6 brand-font text-left">ƒê·∫∑t ch·ªó Cafe in Bed</h3>
      <div class="bg-white p-7 rounded-[2.5rem] shadow-sm border border-gray-100 space-y-7 text-left">
        <div class="space-y-4"><label class="text-[10px] font-bold text-gray-400 uppercase ml-2 tracking-widest">Ng√†y b·∫°n ƒë·∫øn</label><input type="date" id="book-date" class="w-full p-4 rounded-2xl bg-gray-50 outline-none mt-1 shadow-inner text-center">
          <div class="flex gap-4"><div class="flex-1 text-center"><label class="text-[10px] font-bold text-gray-400 uppercase">B·∫Øt ƒë·∫ßu</label><input type="time" id="book-start" class="w-full p-4 rounded-2xl bg-gray-50 outline-none mt-1 shadow-inner text-center"></div><div class="flex-1 text-center"><label class="text-[10px] font-bold text-gray-400 uppercase">K·∫øt th√∫c</label><input type="time" id="book-end" class="w-full p-4 rounded-2xl bg-gray-50 outline-none mt-1 shadow-inner text-center"></div></div>
          <p class="text-[9px] text-amber-600 font-bold text-center italic">* Qu√°n ho·∫°t ƒë·ªông: 08:00 - 20:50</p>
        </div>
        <div class="space-y-4"><label class="text-[10px] font-bold text-gray-400 uppercase ml-2 tracking-widest">Th√¥ng tin ng∆∞·ªùi ƒëi c√πng</label><input type="text" id="book-cname" placeholder="T√™n ng∆∞·ªùi ƒëi c√πng" class="w-full p-4 rounded-2xl bg-gray-50 outline-none shadow-inner"><input type="tel" id="book-cphone" placeholder="S·ªë ƒëi·ªán tho·∫°i" class="w-full p-4 rounded-2xl bg-gray-50 outline-none shadow-inner"></div>
        <hr class="border-gray-50">
        <div class="space-y-5"><p class="text-[10px] font-bold text-gray-400 uppercase ml-2 text-center tracking-widest">N·ªôi quy & Mi·ªÖn tr·ª´ tr√°ch nhi·ªám</p>
          <div class="grid grid-cols-2 gap-4">
            <div class="relative aspect-square w-full rounded-[2rem] overflow-hidden border border-gray-100 shadow-sm" onclick="zoomImg('https://i.ibb.co/KcwBLYBN/N-I-QUY-S-D-NG-BED-20260109-102319-0000.png')"><img src="https://i.ibb.co/KcwBLYBN/N-I-QUY-S-D-NG-BED-20260109-102319-0000.png" class="w-full h-full object-cover"><div class="absolute inset-0 bg-black/20 flex items-end justify-center pb-3"><span class="text-[8px] text-white font-bold uppercase bg-black/40 px-2 py-1 rounded-full backdrop-blur-sm">Nh·∫•n ƒë·ªÉ xem r√µ</span></div></div>
            <div class="relative aspect-square w-full rounded-[2rem] overflow-hidden border border-gray-100 shadow-sm" onclick="zoomImg('https://i.ibb.co/XrqnhTQK/2-20250520-223429-0001.png')"><img src="https://i.ibb.co/XrqnhTQK/2-20250520-223429-0001.png" class="w-full h-full object-cover"><div class="absolute inset-0 bg-black/20 flex items-end justify-center pb-3"><span class="text-[8px] text-white font-bold uppercase bg-black/40 px-2 py-1 rounded-full backdrop-blur-sm">Nh·∫•n ƒë·ªÉ xem r√µ</span></div></div>
          </div>
          <div class="flex items-start gap-3 p-6 bg-gray-50 rounded-[2rem] border border-gray-100 text-left"><input type="checkbox" id="agree-rules" class="mt-1 w-7 h-7 accent-[#006241]"><label for="agree-rules" class="text-[12px] leading-relaxed text-gray-600 font-medium italic">T√¥i cam k·∫øt ƒë√£ ƒë·ªçc v√† tu√¢n th·ªß to√†n b·ªô n·ªôi quy c·ªßa <span class="brand-font">The cafe 33</span>.</label></div>
        </div>
        <button onclick="handleBooking()" class="w-full p-5 rounded-3xl sb-green text-white font-bold uppercase text-lg shadow-xl tracking-widest active:scale-95 transition-all">X√°c nh·∫≠n ƒë·∫∑t ch·ªó</button>
      </div>
    </div>

    <div id="tab-rewards" class="p-6 tab-content hidden"><h3 class="text-2xl text-[#006241] mb-6 brand-font text-left">ƒê·ªïi qu√† t·∫∑ng</h3><div id="rewards-list" class="grid grid-cols-1 gap-4"></div></div>
  </div>

  <nav id="nav-bar" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 h-28 flex justify-around items-center hidden z-50 px-6 shadow-2xl">
    <button onclick="showTab('user')" id="nav-user" class="nav-active flex flex-col items-center justify-center w-1/3 py-4 transition-all"><span class="text-3xl mb-1">üë§</span><span class="text-[14px] uppercase font-extrabold tracking-tighter">B·∫°n</span></button>
    <button onclick="showTab('bed')" id="nav-bed" class="text-gray-300 flex flex-col items-center justify-center w-1/3 py-4 transition-all"><span class="text-3xl mb-1">üõå</span><span class="text-[14px] uppercase font-extrabold tracking-tighter">ƒê·∫∑t Bed</span></button>
    <button onclick="showTab('rewards')" id="nav-rewards" class="text-gray-300 flex flex-col items-center justify-center w-1/3 py-4 transition-all"><span class="text-3xl mb-1">üéÅ</span><span class="text-[14px] uppercase font-extrabold tracking-tighter">ƒê·ªïi qu√†</span></button>
  </nav>

  <div id="history-modal" class="fixed inset-0 bg-white z-50 hidden flex-col overflow-hidden">
    <div class="px-5 pt-12 pb-4 bg-white border-b border-gray-100 flex items-center justify-between sticky top-0 z-10 shadow-sm">
      <h2 class="text-2xl font-black text-[#1e3932]">L·ªãch s·ª≠ ƒë·∫∑t Bed</h2>
      <button onclick="document.getElementById('history-modal').classList.add('hidden')" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200 transition">‚úï</button>
    </div>
    <div class="flex-1 overflow-y-auto overflow-x-hidden p-6 pb-40 bg-[#f8f9fa] w-full h-full overscroll-contain" id="history-content" style="-webkit-overflow-scrolling: touch;">
      <div id="history-loading" class="text-center py-10 text-gray-400">ƒêang t·∫£i d·ªØ li·ªáu...</div>
      <div id="section-active-booking" class="hidden mb-6">
         <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">L·ªãch tr√¨nh h√¥m nay</h3>
         <div id="active-card" class="bg-white rounded-2xl p-5 shadow-sm border border-amber-100 relative overflow-hidden"></div>
      </div>
      <div id="section-past-booking">
         <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">L·ªãch s·ª≠ ho·∫°t ƒë·ªông</h3>
         <div id="history-list" class="space-y-3"></div>
      </div>
    </div>
  </div>

  <div id="change-time-modal" class="fixed inset-0 bg-black/50 z-[60] hidden items-center justify-center p-5">
     <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl animate-bounce-in">
        <h3 class="text-lg font-bold text-[#1e3932] mb-4">Thay ƒë·ªïi gi·ªù ƒë·∫∑t</h3>
        <input type="hidden" id="edit-booking-id">
        <div class="grid grid-cols-2 gap-3 mb-4">
           <div><label class="block text-xs font-bold text-gray-400 mb-1">B·∫Øt ƒë·∫ßu</label><input type="time" id="edit-start" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-[#1e3932] outline-none border focus:border-[#006241]"></div>
           <div><label class="block text-xs font-bold text-gray-400 mb-1">K·∫øt th√∫c</label><input type="time" id="edit-end" class="w-full p-3 bg-gray-50 rounded-xl font-bold text-[#1e3932] outline-none border focus:border-[#006241]"></div>
        </div>
        <div class="flex gap-2">
           <button onclick="document.getElementById('change-time-modal').classList.add('hidden')" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">H·ªßy</button>
           <button onclick="submitChangeTime()" class="flex-1 py-3 bg-[#006241] rounded-xl font-bold text-white shadow-lg shadow-green-900/20">L∆∞u thay ƒë·ªïi</button>
        </div>
     </div>
  </div>

  <div id="gift-detail-modal" class="fixed inset-0 bg-black/60 z-[80] hidden flex items-center justify-center p-6 backdrop-blur-sm transition-opacity duration-300">
    <div class="bg-white w-full max-w-sm rounded-[2.5rem] overflow-hidden shadow-2xl relative animate-bounce-in">
        <button onclick="document.getElementById('gift-detail-modal').classList.add('hidden')" class="absolute top-4 right-4 z-10 w-10 h-10 bg-black/20 text-white rounded-full flex items-center justify-center backdrop-blur-md hover:bg-black/40 transition">‚úï</button>
        <div class="h-64 w-full bg-gray-100 relative">
            <img id="detail-gift-img" src="" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
            <div class="absolute bottom-5 left-6 right-6"><h3 id="detail-gift-name" class="text-2xl font-black text-white leading-tight mb-1 shadow-black drop-shadow-md">T√™n qu√†</h3></div>
        </div>
        <div class="p-6">
            <p id="detail-gift-desc" class="text-gray-500 text-sm mb-6 leading-relaxed">M√¥ t·∫£ qu√† t·∫∑ng...</p>
            <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100 mb-6">
                <div class="flex justify-between text-xs font-bold text-gray-400 uppercase tracking-wider mb-2"><span>ƒêi·ªÉm c·ªßa b·∫°n</span><span>C·∫ßn c√≥</span></div>
                <div class="flex justify-between items-end"><span id="detail-user-point" class="text-xl font-black text-[#1e3932]">0</span><span class="text-gray-300 mb-1">/</span><span id="detail-gift-cost" class="text-xl font-black text-[#006241]">0</span></div>
                <div class="w-full h-2 bg-gray-200 rounded-full mt-3 overflow-hidden"><div id="detail-progress" class="h-full bg-[#006241] rounded-full transition-all duration-500" style="width: 0%"></div></div>
                <p id="detail-message" class="text-[10px] font-bold text-amber-500 mt-2 text-right hidden">B·∫°n c√≤n thi·∫øu ƒëi·ªÉm nha!</p>
            </div>
            <button id="btn-confirm-redeem" class="w-full py-4 rounded-2xl bg-[#006241] text-white font-bold text-sm uppercase tracking-widest shadow-lg shadow-green-900/20 active:scale-[0.98] transition-transform">X√°c nh·∫≠n ƒë·ªïi qu√†</button>
        </div>
    </div>
  </div>

  <script>
    // --- K·∫æT N·ªêI SERVER (Thay th·∫ø google.script.run) ---
    // Link n√†y l·∫•y t·ª´ POS c·ªßa b·∫°n
    const API_URL = "https://script.google.com/macros/s/AKfycbzGYGW9U89dDOdECG4CdWV6OTJQXzcUmf1BBjg26aHQdFZMoBlbSzXDb0bu7XkbpXs6Ng/exec";

    async function callAPI(action, data = {}) {
        console.log(`üì° ƒêang g·ªçi: ${action}`, data);
        try {
            const response = await fetch(API_URL, {
                method: "POST",
                redirect: "follow",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ action: action, ...data })
            });
            const result = await response.json();
            console.log(`‚úÖ K·∫øt qu·∫£ ${action}:`, result);
            return result;
        } catch (error) {
            console.error("‚ùå L·ªói API:", error);
            showAppModal("L·ªói m·∫°ng", "Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.<br>" + error.message, '‚ùå');
            document.getElementById('loading-overlay').classList.add('hidden');
            return { status: "error", message: error.message };
        }
    }

    // --- LOGIC APP CH√çNH ---
    let uData = {}; 
    let curPhone = "";
    let _cachedGiftList = [];

    // Clock
    function updateClock() { const now = new Date(); const h = String(now.getHours()).padStart(2, '0'); const m = String(now.getMinutes()).padStart(2, '0'); const d = String(now.getDate()).padStart(2, '0'); const mo = String(now.getMonth() + 1).padStart(2, '0'); document.getElementById('live-clock').innerText = h + ":" + m + " - " + d + "/" + mo; }
    setInterval(updateClock, 10000); updateClock();

    // UI Helpers
    function zoomImg(src) { document.getElementById('zoomed-img').src = src; document.getElementById('image-overlay').classList.remove('hidden'); }
    function closeZoom() { document.getElementById('image-overlay').classList.add('hidden'); }
    function showTab(t) { document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden')); document.getElementById('tab-' + t).classList.remove('hidden'); document.querySelectorAll('nav button').forEach(btn => { btn.classList.remove('nav-active', 'text-[#006241]'); btn.classList.add('text-gray-300'); }); document.getElementById('nav-' + t).classList.add('nav-active'); document.getElementById('nav-' + t).classList.remove('text-gray-300'); }

    // App Modal
    function showAppModal(title, message, icon = '‚òï', onConfirm = null) { 
        const overlay = document.getElementById('modal-overlay'); 
        const modal = document.getElementById('custom-modal'); 
        const btnSub = document.getElementById('modal-btn-sub'); 
        const btnMain = document.getElementById('modal-btn-main'); 
        document.getElementById('modal-title').innerText = title; 
        document.getElementById('modal-message').innerHTML = message; 
        document.getElementById('modal-icon').innerText = icon; 
        overlay.classList.remove('hidden'); 
        setTimeout(() => modal.classList.replace('modal-enter', 'modal-show'), 10); 
        
        if (onConfirm) { 
            btnSub.classList.remove('hidden'); 
            btnMain.onclick = () => { closeAppModal(); onConfirm(); }; 
            btnSub.onclick = closeAppModal; 
        } else { 
            btnSub.classList.add('hidden'); 
            btnMain.onclick = closeAppModal; 
        } 
    }
    function closeAppModal() { 
        const overlay = document.getElementById('modal-overlay'); 
        const modal = document.getElementById('custom-modal'); 
        modal.classList.replace('modal-show', 'modal-enter'); 
        setTimeout(() => overlay.classList.add('hidden'), 300); 
    }

    // --- LOGIN ---
    async function login() { 
        curPhone = document.getElementById('login-sdt').value.trim(); 
        if(!curPhone) return showAppModal("Hic!", "B·∫°n nh·∫≠p s·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ ƒëƒÉng nh·∫≠p nh√©."); 
        
        document.getElementById('loading-overlay').classList.remove('hidden');
        
        // G·ªåI API THAY V√å GOOGLE.SCRIPT.RUN
        const res = await callAPI('checkUser', { phone: curPhone });
        
        document.getElementById('loading-overlay').classList.add('hidden');
        if (res.status === 'success') { 
            uData = res; 
            document.getElementById('login-screen').classList.add('hidden'); 
            document.getElementById('main-app').classList.remove('hidden'); 
            document.getElementById('nav-bar').classList.remove('hidden'); 
            refreshUI(); 
        } else { 
            showAppModal("Th√¥ng b√°o", res.message); 
        } 
    }

    function refreshUI() { 
        document.getElementById('user-name-display').innerText = uData.name; 
        document.getElementById('user-points').innerText = uData.points.toLocaleString(); 
        document.getElementById('edit-name').value = uData.name; 
        document.getElementById('edit-sdt').value = curPhone; 
        document.getElementById('edit-cname').value = uData.compName || ""; 
        document.getElementById('edit-cphone').value = uData.compPhone || ""; 
        document.getElementById('book-cname').value = uData.compName || ""; 
        document.getElementById('book-cphone').value = uData.compPhone || ""; 
        
        let r = "Th√†nh vi√™n"; 
        if (uData.points >= 55000) r = "Th√†nh vi√™n 'siu th√¢n'"; 
        else if (uData.points >= 33000) r = "Th√†nh vi√™n 'th√¢n iu'"; 
        else if (uData.points >= 10000) r = "Th√†nh vi√™n B·∫°c"; 
        document.getElementById('user-rank').innerText = r; 
        
        renderRewards(uData.rewards); 
    }

    async function handleUpdate() { 
        const up = { 
            name: document.getElementById('edit-name').value, 
            sdt: document.getElementById('edit-sdt').value, 
            cName: document.getElementById('edit-cname').value, 
            cPhone: document.getElementById('edit-cphone').value 
        }; 
        
        document.getElementById('loading-overlay').classList.remove('hidden');
        const res = await callAPI('updateProfile', { phone: curPhone, data: up });
        document.getElementById('loading-overlay').classList.add('hidden');
        
        showAppModal("Th√†nh c√¥ng", res, '‚úÖ'); 
        curPhone = up.sdt; 
        login(); // Reload l·∫°i d·ªØ li·ªáu
    }

    // --- BOOKING LOGIC ---
    async function handleBooking() {
        if (!document.getElementById('agree-rules').checked) return showAppModal("N·ªôi quy", "B·∫°n t√≠ch ƒë·ªìng √Ω n·ªôi quy ƒë·ªÉ ti·∫øp t·ª•c nh√©.", 'üìú');
        
        const bDate = document.getElementById('book-date').value;
        const sT = document.getElementById('book-start').value;
        const eT = document.getElementById('book-end').value;

        if (!bDate || !sT || !eT) return showAppModal("Th√¥ng b√°o", "B·∫°n ch·ªçn ng√†y v√† gi·ªù c·ª• th·ªÉ nh√©.", 'üìÖ');

        const now = new Date();
        const today = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
        const curT = String(now.getHours()).padStart(2, '0') + ":" + String(now.getMinutes()).padStart(2, '0');

        if (bDate < today) return showAppModal("Ng√†y kh√¥ng h·ª£p l·ªá", "Kh√¥ng th·ªÉ ƒë·∫∑t l·ªãch qu√° kh·ª©.", 'üìÖ');
        if (bDate === today && sT < curT) return showAppModal("Gi·ªù kh√¥ng h·ª£p l·ªá", "Gi·ªù b·∫Øt ƒë·∫ßu kh√¥ng th·ªÉ ·ªü qu√° kh·ª©.", '‚è∞');
        if (sT < "08:00" || eT > "20:50" || sT >= eT) return showAppModal("Gi·ªù ho·∫°t ƒë·ªông", "Qu√°n ho·∫°t ƒë·ªông t·ª´ 08:00 ƒë·∫øn 20:50.", '‚è∞');

        const startMin = parseInt(sT.split(':')[0]) * 60 + parseInt(sT.split(':')[1]);
        const endMin = parseInt(eT.split(':')[0]) * 60 + parseInt(eT.split(':')[1]);
        const duration = endMin - startMin;

        if (duration < 30) return showAppModal("Th·ªùi gian", "T·ªëi thi·ªÉu 30 ph√∫t nh√©.", '‚è≥');

        document.getElementById('loading-overlay').classList.remove('hidden');
        
        // G·ªåI API CHECK SLOT
        const res = await callAPI('checkMemberBookingAvailability', { 
            phone: curPhone, date: bDate, start: sT, duration: duration 
        });
        
        document.getElementById('loading-overlay').classList.add('hidden');

        if (res.status === 'SUCCESS') {
            executeSaveBooking(bDate, sT, eT);
        } else if (res.status === 'LIMIT_REACHED') {
            showAppModal("Quy ƒë·ªãnh ƒë·∫∑t ch·ªó", res.message, 'üö´');
        } else {
            handleFullSlot(res);
        }
    }

    function handleFullSlot(res) {
        let msg = `Hic, khung gi·ªù <b>${res.finalStart || 'n√†y'}</b> ƒë√£ k√≠n ch·ªó.`;
        if (res.suggestions && res.suggestions.length > 0) {
            const best = res.suggestions[0];
            if (best.type === 'SHRINK') {
                msg += `<br><br>üí° C√≤n 1 Bed tr·ªëng t·ª´ <b>${best.startTime} ƒë·∫øn ${best.endTime}</b>. B·∫°n mu·ªën ƒë·∫∑t kh√¥ng?`;
            } else {
                msg += `<br><br>üí° G·ª£i √Ω tr·ªëng g·∫ßn nh·∫•t:<br>`;
                res.suggestions.forEach(s => msg += `‚Ä¢ ${s.startTime} - ${s.endTime}<br>`);
                msg += `<br>ƒê·ªïi sang <b>${best.startTime}</b> nh√©?`;
            }
            showAppModal("H·∫øt ch·ªó", msg, '‚ö†Ô∏è', () => {
                document.getElementById('book-start').value = best.startTime;
                document.getElementById('book-end').value = best.endTime;
            });
        } else {
            showAppModal("H·∫øt ch·ªó", msg + "<br>Vui l√≤ng ch·ªçn khung gi·ªù kh√°c.", '‚ùå');
        }
    }

    async function executeSaveBooking(bDate, sT, eT) {
        const bData = { 
            uName: uData.name, uPhone: curPhone, date: bDate, sTime: sT, eTime: eT, 
            cName: document.getElementById('book-cname').value, 
            cPhone: document.getElementById('book-cphone').value 
        };
        
        document.getElementById('loading-overlay').classList.remove('hidden');
        const res = await callAPI('saveBooking', { data: bData });
        document.getElementById('loading-overlay').classList.add('hidden');
        
        showAppModal("Th√†nh c√¥ng", res, '‚úÖ');
    }

    // --- REWARDS LOGIC ---
    function renderRewards(list) {
        const container = document.getElementById('rewards-list');
        if (!list || list.length === 0) { container.innerHTML = '<div class="text-center text-gray-400 py-10 italic text-xs">Ch∆∞a c√≥ qu√†.</div>'; return; }
        _cachedGiftList = list;
        container.innerHTML = list.map((item, index) => {
            return `<div onclick="openGiftDetail(${index})" class="bg-white p-4 rounded-[2rem] border border-gray-100 shadow-sm flex items-center gap-4 mb-3 relative overflow-hidden group active:scale-[0.98] transition-transform cursor-pointer hover:shadow-md">
                <div class="shrink-0 w-24 h-24 rounded-3xl overflow-hidden border border-gray-100 bg-gray-50"><img src="${item.img || ''}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/150'"></div>
                <div class="flex-1 min-w-0"><p class="font-bold text-sm text-[#1e3932] mb-1 uppercase truncate">${item.name}</p><p class="text-[10px] text-gray-400 mb-2 line-clamp-2">${item.desc || '...'}</p><p class="text-md text-[#006241] font-black brand-font">${item.cost.toLocaleString()} <span class="text-amber-500 text-xs">‚òÖ</span></p></div>
                <div class="shrink-0 w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 group-hover:bg-[#006241] group-hover:text-white transition-colors">‚ûú</div>
            </div>`;
        }).join('');
    }

    function openGiftDetail(index) {
        const item = _cachedGiftList[index];
        if (!item) return;
        document.getElementById('detail-gift-name').innerText = item.name;
        document.getElementById('detail-gift-desc').innerText = item.desc || '...';
        document.getElementById('detail-gift-cost').innerText = item.cost.toLocaleString() + ' ‚òÖ';
        document.getElementById('detail-gift-img').src = item.img || '';
        document.getElementById('detail-user-point').innerText = uData.points.toLocaleString() + ' ‚òÖ';
        let percent = (uData.points / item.cost) * 100; if (percent > 100) percent = 100;
        document.getElementById('detail-progress').style.width = percent + '%';

        const btn = document.getElementById('btn-confirm-redeem');
        const msg = document.getElementById('detail-message');
        const prog = document.getElementById('detail-progress');

        if (uData.points >= item.cost) {
            btn.disabled = false; btn.innerHTML = 'X√ÅC NH·∫¨N ƒê·ªîI NGAY';
            btn.className = "w-full py-4 rounded-2xl bg-[#006241] text-white font-bold text-sm uppercase tracking-widest shadow-lg active:scale-[0.98] transition-transform";
            btn.onclick = () => { document.getElementById('gift-detail-modal').classList.add('hidden'); redeem(item.name, item.cost); };
            prog.className = "h-full bg-[#006241] rounded-full transition-all duration-500";
            msg.classList.add('hidden');
        } else {
            btn.disabled = true; btn.innerHTML = 'CH∆ØA ƒê·ª¶ ƒêI·ªÇM';
            btn.className = "w-full py-4 rounded-2xl bg-gray-300 text-gray-500 font-bold text-sm uppercase tracking-widest cursor-not-allowed";
            prog.className = "h-full bg-red-500 rounded-full transition-all duration-500";
            msg.classList.remove('hidden'); msg.innerText = `Thi·∫øu ${(item.cost - uData.points).toLocaleString()} ‚òÖ n·ªØa.`;
        }
        document.getElementById('gift-detail-modal').classList.remove('hidden');
    }

    async function redeem(name, cost) {
        showAppModal("X√°c nh·∫≠n", `D√πng <b>${cost.toLocaleString()} ‚òÖ</b> ƒë·ªïi <b>${name}</b>?`, 'üéÅ', async () => {
            document.getElementById('loading-overlay').classList.remove('hidden');
            const res = await callAPI('redeem', { phone: curPhone, rewardName: name, cost: cost }); // 'redeem' ph·∫£i kh·ªõp action b√™n M√£.gs
            document.getElementById('loading-overlay').classList.add('hidden');
            
            if (res.status === 'success') { 
                showAppModal("Th√†nh c√¥ng", "ƒê√£ ƒë·ªïi qu√†. ƒê∆∞a m√†n h√¨nh n√†y cho nh√¢n vi√™n nh√©.", '‚úÖ'); 
                login(); 
            } else { 
                showAppModal("L·ªói", res.message, '‚ùå'); 
            }
        });
    }

    // --- HISTORY LOGIC ---
    async function openHistory() {
        document.getElementById('history-modal').classList.remove('hidden');
        const listDiv = document.getElementById('history-list');
        const activeDiv = document.getElementById('section-active-booking');
        const activeCard = document.getElementById('active-card');
        document.getElementById('history-loading').classList.remove('hidden');
        listDiv.innerHTML = ''; activeDiv.classList.add('hidden');

        const data = await callAPI('getMemberBookingHistory', { phone: curPhone });
        document.getElementById('history-loading').classList.add('hidden');

        if (data.active) {
            activeDiv.classList.remove('hidden');
            const b = data.active;
            const bedText = (b.bed && b.bed != '') ? "BED " + b.bed : "Ch·ªù x·∫øp";
            activeCard.innerHTML = `<div class="absolute top-0 right-0 p-3 bg-amber-100 text-amber-800 text-[10px] font-bold rounded-bl-2xl">ƒêANG HO·∫†T ƒê·ªòNG</div><p class="text-3xl font-black text-[#1e3932] mb-1">${b.start}</p><p class="text-sm text-gray-500 font-medium mb-4">ƒê·∫øn: <b>${b.end}</b> ‚Ä¢ V·ªã tr√≠: <b class="text-[#006241]">${bedText}</b></p><div class="flex gap-2"><button onclick="openChangeTime(${b.id}, '${b.start}', '${b.end}')" class="flex-1 py-2 rounded-xl bg-blue-50 text-blue-700 font-bold text-xs border border-blue-100">‚úèÔ∏è ƒê·ªïi gi·ªù</button><button onclick="requestCancel(${b.id})" class="flex-1 py-2 rounded-xl bg-red-50 text-red-700 font-bold text-xs border border-red-100">üóëÔ∏è H·ªßy l·ªãch</button></div>`;
        }
        if (data.history.length === 0) {
            listDiv.innerHTML = '<div class="text-center text-gray-400 text-sm italic">Ch∆∞a c√≥ l·ªãch s·ª≠.</div>';
        } else {
            listDiv.innerHTML = data.history.map(h => {
                let clr = "text-gray-500 bg-gray-100", txt = h.status;
                if (h.status.includes('ƒë√£ xong')) { clr = "text-green-600 bg-green-100"; txt = "HO√ÄN TH√ÄNH"; }
                else if (h.status.includes('ƒë√£ h·ªßy')) { clr = "text-red-500 bg-red-50"; txt = "ƒê√É H·ª¶Y"; }
                return `<div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm"><div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-gray-400">${h.date}</span><span class="px-2 py-1 rounded-md text-[10px] font-bold uppercase ${clr}">${txt}</span></div><p class="text-lg font-black text-[#1e3932] leading-none">${h.start} - ${h.end}</p><p class="text-xs text-gray-400 mt-1">Bed: ${h.bed || '--'} | ƒêi·ªÉm: ${h.points}</p></div>`;
            }).join('');
        }
    }

    function requestCancel(id) {
        showAppModal("X√°c nh·∫≠n", "H·ªßy l·ªãch n√†y?", '‚ö†Ô∏è', async () => {
            document.getElementById('loading-overlay').classList.remove('hidden');
            const res = await callAPI('userCancelBooking', { id: id });
            document.getElementById('loading-overlay').classList.add('hidden');
            if(res === 'OK') { showAppModal("Xong", "ƒê√£ h·ªßy.", '‚úÖ'); openHistory(); } 
            else showAppModal("L·ªói", res, '‚ùå');
        });
    }

    function openChangeTime(id, s, e) {
        document.getElementById('edit-booking-id').value = id;
        document.getElementById('edit-start').value = s;
        document.getElementById('edit-end').value = e;
        document.getElementById('change-time-modal').classList.remove('hidden');
    }

    async function submitChangeTime() {
        const id = document.getElementById('edit-booking-id').value;
        const s = document.getElementById('edit-start').value;
        const e = document.getElementById('edit-end').value;
        document.getElementById('change-time-modal').classList.add('hidden');
        document.getElementById('loading-overlay').classList.remove('hidden');

        const now = new Date();
        const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
        
        const res = await callAPI('userUpdateBooking', { id: id, start: s, end: e, date: todayStr });
        document.getElementById('loading-overlay').classList.add('hidden');

        if(res === 'OK') { showAppModal("Xong", "ƒê√£ ƒë·ªïi gi·ªù.", '‚úÖ'); openHistory(); }
        else if (res === 'FULL') showAppModal("H·∫øt ch·ªó", "Gi·ªù n√†y k√≠n r·ªìi.", 'üö´');
        else showAppModal("L·ªói", "Th·ª≠ l·∫°i sau nh√©.", '‚ùå');
    }
  </script>
</body>
</html>