<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#006241">
  
  <link rel="icon" href="https://i.ibb.co/nqdTWnvt/N-u-v-N-u-v-ng-Ngh-thu-t-s-p-ch-In-m-Ti-m-c-ph-Bi-u-tr-ng-C-ph-20260121-210413-0000.png">
  <link rel="apple-touch-icon" href="https://i.ibb.co/nqdTWnvt/N-u-v-N-u-v-ng-Ngh-thu-t-s-p-ch-In-m-Ti-m-c-ph-Bi-u-tr-ng-C-ph-20260121-210413-0000.png">
  
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-database-compat.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=League+Spartan:wght@700;800&display=swap" rel="stylesheet">
  
  <style>
    /* GIá»® NGUYÃŠN CSS CÅ¨ Cá»¦A BÃ€ */
    html, body {
      overscroll-behavior-y: none;
      touch-action: pan-x pan-y;
      margin: 0; padding: 0; height: 100%; width: 100%;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      background-color: #f8f9fa;
      font-family: 'Inter', sans-serif;
      color: #1e3932;
      text-align: left;
      -webkit-font-smoothing: antialiased;
      overflow-y: auto;
    }
    .brand-font { font-family: 'League Spartan', sans-serif; font-weight: 800; letter-spacing: -0.01em; }
    .sb-green { background-color: #006241; }
    .card-gradient { background: linear-gradient(135deg, #004d33 0%, #006241 100%); }
    .nav-active { color: #006241; font-weight: 800; background-color: rgba(0, 98, 65, 0.05); border-radius: 1.5rem; }
    .tab-content { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    #custom-modal, #image-overlay { transition: all 0.3s ease; }
    .modal-enter { opacity: 0; transform: scale(0.9); }
    .modal-show { opacity: 1; transform: scale(1); }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #D1D1D6; border-radius: 10px; }
  </style>
</head>
<body class="min-h-screen pb-32">

  <div id="loading-overlay" class="fixed inset-0 bg-white/95 z-[9999] hidden flex flex-col items-center justify-center backdrop-blur-sm">
    <div class="w-14 h-14 border-4 border-[#006241] border-t-transparent rounded-full animate-spin mb-4"></div>
    <p class="brand-font text-[#006241] text-xl font-black animate-pulse">The cafe 33</p>
    <p class="text-xs text-gray-400 font-bold mt-2" id="loading-text">Äang káº¿t ná»‘i...</p>
  </div>

  <div id="image-overlay" class="fixed inset-0 bg-black/95 z-[200] hidden flex flex-col items-center justify-center p-4 backdrop-blur-md">
    <button onclick="document.getElementById('image-overlay').classList.add('hidden')" class="absolute top-8 right-8 text-white text-5xl font-light">&times;</button>
    <div class="w-full h-full flex items-center justify-center overflow-auto"><img id="zoomed-img" src="" class="max-w-full max-h-full object-contain shadow-2xl transition-transform" onclick="event.stopPropagation()"></div>
  </div>

  <div id="modal-overlay" class="fixed inset-0 bg-black/40 z-[100] hidden flex items-center justify-center p-6 backdrop-blur-sm">
    <div id="custom-modal" class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl text-center modal-enter">
      <div id="modal-icon" class="text-5xl mb-4">â˜•</div>
      <h3 id="modal-title" class="brand-font text-2xl text-[#006241] mb-3">ThÃ´ng bÃ¡o</h3>
      <div id="modal-message" class="text-lg text-[#1e3932] font-bold mb-8 leading-relaxed brand-font"></div>
      <div id="modal-actions" class="flex flex-col gap-3">
        <button id="modal-btn-main" class="w-full py-4 sb-green text-white font-bold rounded-2xl uppercase tracking-widest text-xs shadow-lg">Äá»“ng Ã½</button>
        <button id="modal-btn-sub" class="w-full py-4 text-gray-400 font-bold rounded-2xl uppercase tracking-widest text-[10px] hidden">Há»§y bá»</button>
      </div>
    </div>
  </div>

  <div id="login-screen" class="flex flex-col items-center justify-center min-h-screen p-8 bg-white text-center">
    <h1 class="text-5xl text-[#006241] mb-4 brand-font">The cafe 33</h1>
    <p class="text-[11px] font-bold text-gray-400 mb-12 uppercase tracking-widest">TÃ­ch Ä‘iá»ƒm nháº­n Ä‘áº·c quyá»n</p>
    <input type="tel" id="login-sdt" placeholder="Sá»‘ Ä‘iá»‡n thoáº¡i cá»§a báº¡n..." class="w-full p-5 rounded-3xl bg-gray-50 border border-gray-100 mb-4 text-center outline-none text-lg">
    <button id="btn-login" onclick="login()" class="w-full p-5 rounded-3xl sb-green text-white font-bold shadow-md active:scale-95 transition-all uppercase text-lg">ÄÄƒng nháº­p</button>
  </div>

  <div id="main-app" class="hidden">
    <div class="p-5 bg-white shadow-sm flex justify-between items-center sticky top-0 z-50">
      <h2 class="text-2xl text-[#006241] brand-font">The cafe 33</h2>
      <div id="live-clock" class="text-[11px] font-extrabold text-[#006241] border border-gray-100 px-4 py-2 rounded-full bg-gray-50 shadow-inner">--:--</div>
    </div>

    <div id="tab-user" class="p-5 tab-content">
      <div class="card-gradient p-8 rounded-[2.5rem] text-white shadow-2xl h-60 flex flex-col justify-between relative overflow-hidden mb-8 text-left">
        <div class="flex justify-between items-start z-10"><p class="text-[10px] font-bold uppercase tracking-widest opacity-80">Member Card</p><p class="text-[14px] opacity-60 brand-font">The cafe 33</p></div>
        <div class="z-10"><p id="user-name-display" class="text-3xl font-bold uppercase tracking-wider mb-2"></p>
          <div class="flex justify-between items-end"><p id="user-rank" class="text-[12px] text-amber-400 font-bold uppercase tracking-widest"></p><div class="text-right"><span id="user-points" class="text-5xl font-black">0</span><span class="text-xs ml-1 opacity-70 font-bold">â˜…</span></div></div>
        </div>
        <div class="absolute -bottom-10 -right-10 w-48 h-48 bg-white/5 rounded-full blur-3xl"></div>
      </div>

      <div id="btn-open-history" onclick="openHistory()" class="bg-white p-5 rounded-[2.5rem] shadow-sm border border-gray-100 flex items-center justify-between cursor-pointer mb-6 active:scale-95 transition-transform">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 rounded-full bg-green-50 flex items-center justify-center text-xl text-[#006241]">ğŸ“…</div>
          <div>
            <p class="font-bold text-[#1e3932] text-sm uppercase tracking-wider">Lá»‹ch sá»­ Ä‘áº·t Bed</p>
            <p class="text-[10px] text-gray-400 font-bold">Xem lá»‹ch trÃ¬nh & Há»§y lá»‹ch</p>
          </div>
        </div>
        <div class="text-gray-300 font-bold">âœ</div>
      </div>

      <div class="bg-white p-7 rounded-[2.5rem] shadow-sm border border-gray-100 space-y-4 text-left">
        <h4 class="font-bold text-[10px] uppercase text-gray-400 ml-2 tracking-widest">Há»“ sÆ¡ cá»§a báº¡n</h4>
        <div><label class="text-[10px] font-bold text-gray-400 ml-2 uppercase">TÃªn cá»§a báº¡n</label><input type="text" id="edit-name" class="w-full p-4 bg-gray-50 rounded-2xl outline-none mt-1 shadow-inner"></div>
        <div><label class="text-[10px] font-bold text-gray-400 ml-2 uppercase">Sá»‘ Ä‘iá»‡n thoáº¡i</label><input type="tel" id="edit-sdt" class="w-full p-4 bg-gray-50 rounded-2xl outline-none mt-1 shadow-inner" readonly></div>
        <p class="text-[10px] font-bold text-gray-400 ml-2 uppercase pt-2 tracking-widest">NgÆ°á»i Ä‘i cÃ¹ng máº·c Ä‘á»‹nh</p>
        <div class="space-y-3"><input type="text" id="edit-cname" class="w-full p-4 bg-gray-50 rounded-2xl outline-none shadow-inner" placeholder="TÃªn ngÆ°á»i Ä‘i cÃ¹ng"><input type="tel" id="edit-cphone" class="w-full p-4 bg-gray-50 rounded-2xl outline-none shadow-inner" placeholder="SÄT ngÆ°á»i Ä‘i cÃ¹ng"></div>
        <button id="btn-update-profile" onclick="handleUpdate()" class="w-full py-4 rounded-2xl border-2 border-[#006241] text-[#006241] font-bold text-sm mt-4 uppercase tracking-widest">LÆ°u thay Ä‘á»•i</button>
      </div>
    </div>

    <div id="tab-bed" class="p-6 tab-content hidden">
      <h3 class="text-2xl text-[#006241] mb-6 brand-font text-left">Äáº·t chá»— Cafe in Bed</h3>
      <div class="bg-white p-7 rounded-[2.5rem] shadow-sm border border-gray-100 space-y-7 text-left">
        <div class="space-y-4"><label class="text-[10px] font-bold text-gray-400 uppercase ml-2 tracking-widest">NgÃ y báº¡n Ä‘áº¿n</label><input type="date" id="book-date" class="w-full p-4 rounded-2xl bg-gray-50 outline-none mt-1 shadow-inner text-center">
          <div class="flex gap-4"><div class="flex-1 text-center"><label class="text-[10px] font-bold text-gray-400 uppercase">Báº¯t Ä‘áº§u</label><input type="time" id="book-start" class="w-full p-4 rounded-2xl bg-gray-50 outline-none mt-1 shadow-inner text-center"></div><div class="flex-1 text-center"><label class="text-[10px] font-bold text-gray-400 uppercase">Káº¿t thÃºc</label><input type="time" id="book-end" class="w-full p-4 rounded-2xl bg-gray-50 outline-none mt-1 shadow-inner text-center"></div></div>
          <p class="text-[9px] text-amber-600 font-bold text-center italic">* QuÃ¡n hoáº¡t Ä‘á»™ng: 08:00 - 20:50</p>
        </div>
        <div class="space-y-4"><label class="text-[10px] font-bold text-gray-400 uppercase ml-2 tracking-widest">ThÃ´ng tin ngÆ°á»i Ä‘i cÃ¹ng</label><input type="text" id="book-cname" placeholder="TÃªn ngÆ°á»i Ä‘i cÃ¹ng" class="w-full p-4 rounded-2xl bg-gray-50 outline-none shadow-inner"><input type="tel" id="book-cphone" placeholder="Sá»‘ Ä‘iá»‡n thoáº¡i" class="w-full p-4 rounded-2xl bg-gray-50 outline-none shadow-inner"></div>
        <hr class="border-gray-50">
        <div class="space-y-5"><p class="text-[10px] font-bold text-gray-400 uppercase ml-2 text-center tracking-widest">Ná»™i quy & Miá»…n trá»« trÃ¡ch nhiá»‡m</p>
          <div class="grid grid-cols-2 gap-4">
            <div class="relative aspect-square w-full rounded-[2rem] overflow-hidden border border-gray-100 shadow-sm" onclick="document.getElementById('zoomed-img').src='https://i.ibb.co/KcwBLYBN/N-I-QUY-S-D-NG-BED-20260109-102319-0000.png';document.getElementById('image-overlay').classList.remove('hidden');"><img src="https://i.ibb.co/KcwBLYBN/N-I-QUY-S-D-NG-BED-20260109-102319-0000.png" class="w-full h-full object-cover"><div class="absolute inset-0 bg-black/20 flex items-end justify-center pb-3"><span class="text-[8px] text-white font-bold uppercase bg-black/40 px-2 py-1 rounded-full backdrop-blur-sm">Nháº¥n Ä‘á»ƒ xem rÃµ</span></div></div>
            <div class="relative aspect-square w-full rounded-[2rem] overflow-hidden border border-gray-100 shadow-sm" onclick="document.getElementById('zoomed-img').src='https://i.ibb.co/XrqnhTQK/2-20250520-223429-0001.png';document.getElementById('image-overlay').classList.remove('hidden');"><img src="https://i.ibb.co/XrqnhTQK/2-20250520-223429-0001.png" class="w-full h-full object-cover"><div class="absolute inset-0 bg-black/20 flex items-end justify-center pb-3"><span class="text-[8px] text-white font-bold uppercase bg-black/40 px-2 py-1 rounded-full backdrop-blur-sm">Nháº¥n Ä‘á»ƒ xem rÃµ</span></div></div>
          </div>
          <div class="flex items-start gap-3 p-6 bg-gray-50 rounded-[2rem] border border-gray-100 text-left"><input type="checkbox" id="agree-rules" class="mt-1 w-7 h-7 accent-[#006241]"><label for="agree-rules" class="text-[12px] leading-relaxed text-gray-600 font-medium italic">TÃ´i cam káº¿t Ä‘Ã£ Ä‘á»c vÃ  tuÃ¢n thá»§ toÃ n bá»™ ná»™i quy cá»§a <span class="brand-font">The cafe 33</span>.</label></div>
        </div>
        <button id="btn-booking" onclick="handleBooking()" class="w-full p-5 rounded-3xl sb-green text-white font-bold uppercase text-lg shadow-xl tracking-widest active:scale-95 transition-all">XÃ¡c nháº­n Ä‘áº·t chá»—</button>
      </div>
    </div>

    <div id="tab-rewards" class="p-6 tab-content hidden"><h3 class="text-2xl text-[#006241] mb-6 brand-font text-left">Äá»•i quÃ  táº·ng</h3><div id="rewards-list" class="grid grid-cols-1 gap-4"></div></div>
  </div>

  <nav id="nav-bar" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 h-28 flex justify-around items-center hidden z-50 px-6 shadow-2xl">
    <button onclick="showTab('user')" id="nav-user" class="nav-active flex flex-col items-center justify-center w-1/3 py-4 transition-all"><span class="text-3xl mb-1">ğŸ‘¤</span><span class="text-[14px] uppercase font-extrabold tracking-tighter">Báº¡n</span></button>
    <button onclick="showTab('bed')" id="nav-bed" class="text-gray-300 flex flex-col items-center justify-center w-1/3 py-4 transition-all"><span class="text-3xl mb-1">ğŸ›Œ</span><span class="text-[14px] uppercase font-extrabold tracking-tighter">Äáº·t Bed</span></button>
    <button onclick="showTab('rewards')" id="nav-rewards" class="text-gray-300 flex flex-col items-center justify-center w-1/3 py-4 transition-all"><span class="text-3xl mb-1">ğŸ</span><span class="text-[14px] uppercase font-extrabold tracking-tighter">Äá»•i quÃ </span></button>
  </nav>

  <div id="history-modal" class="fixed inset-0 bg-white z-50 hidden flex-col overflow-hidden">
    <div class="px-5 pt-12 pb-4 bg-white border-b border-gray-100 flex items-center justify-between sticky top-0 z-10 shadow-sm">
      <h2 class="text-2xl font-black text-[#1e3932]">Lá»‹ch sá»­ Ä‘áº·t Bed</h2>
      <button onclick="document.getElementById('history-modal').classList.add('hidden')" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200 transition">âœ•</button>
    </div>
    <div class="flex-1 overflow-y-auto overflow-x-hidden p-6 pb-40 bg-[#f8f9fa] w-full h-full overscroll-contain" id="history-content" style="-webkit-overflow-scrolling: touch;">
      <div id="history-loading" class="text-center py-10 text-gray-400">Äang táº£i dá»¯ liá»‡u...</div>
      <div id="section-active-booking" class="hidden mb-6">
        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Lá»‹ch trÃ¬nh hÃ´m nay</h3>
        <div id="active-card" class="bg-white rounded-2xl p-5 shadow-sm border border-amber-100 relative overflow-hidden"></div>
      </div>
      <div id="section-past-booking">
        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Lá»‹ch sá»­ hoáº¡t Ä‘á»™ng</h3>
        <div id="history-list" class="space-y-3"></div>
      </div>
    </div>
  </div>

  <div id="gift-detail-modal" class="fixed inset-0 bg-black/60 z-[80] hidden flex items-center justify-center p-6 backdrop-blur-sm transition-opacity duration-300">
    <div class="bg-white w-full max-w-sm rounded-[2.5rem] overflow-hidden shadow-2xl relative animate-bounce-in">
      <button onclick="document.getElementById('gift-detail-modal').classList.add('hidden')" class="absolute top-4 right-4 z-10 w-10 h-10 bg-black/20 text-white rounded-full flex items-center justify-center backdrop-blur-md hover:bg-black/40 transition">âœ•</button>
      <div class="h-64 w-full bg-gray-100 relative">
        <img id="detail-gift-img" src="" class="w-full h-full object-cover">
        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
        <div class="absolute bottom-5 left-6 right-6"><h3 id="detail-gift-name" class="text-2xl font-black text-white leading-tight mb-1 shadow-black drop-shadow-md">TÃªn quÃ </h3></div>
      </div>
      <div class="p-6">
        <p id="detail-gift-desc" class="text-gray-500 text-sm mb-6 leading-relaxed">MÃ´ táº£ quÃ  táº·ng...</p>
        <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100 mb-6">
          <div class="flex justify-between text-xs font-bold text-gray-400 uppercase tracking-wider mb-2"><span>Äiá»ƒm cá»§a báº¡n</span><span>Cáº§n cÃ³</span></div>
          <div class="flex justify-between items-end"><span id="detail-user-point" class="text-xl font-black text-[#1e3932]">0</span><span class="text-gray-300 mb-1">/</span><span id="detail-gift-cost" class="text-xl font-black text-[#006241]">0</span></div>
          <div class="w-full h-2 bg-gray-200 rounded-full mt-3 overflow-hidden"><div id="detail-progress" class="h-full bg-[#006241] rounded-full transition-all duration-500" style="width: 0%"></div></div>
          <p id="detail-message" class="text-[10px] font-bold text-amber-500 mt-2 text-right hidden">Báº¡n cÃ²n thiáº¿u Ä‘iá»ƒm nha!</p>
        </div>
        <button id="btn-confirm-redeem" class="w-full py-4 rounded-2xl bg-[#006241] text-white font-bold text-sm uppercase tracking-widest shadow-lg shadow-green-900/20 active:scale-[0.98] transition-transform">XÃ¡c nháº­n Ä‘á»•i quÃ </button>
      </div>
    </div>
  </div>

<script>
// =============================================================
// 1. Cáº¤U HÃŒNH (DÃN Tá»ª FILE POS VÃ€O ÄÃ‚Y)
// =============================================================
const firebaseConfig = {
  apiKey: "AIzaSyCNh1-16gYZ0P30Fkd-2tB-O89PXkPX9Lc",
  authDomain: "the-cafe-33.firebaseapp.com",
  databaseURL: "https://the-cafe-33-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "the-cafe-33",
  storageBucket: "the-cafe-33.appspot.com",
  messagingSenderId: "...",
  appId: "..."
};

// DÃN LINK WEB APP Má»šI Cá»¦A BÃ€ VÃ€O ÄÃ‚Y (ÄuÃ´i /exec)
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxxxx...../exec"; 

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let curPhone = localStorage.getItem('member_phone');
let userData = {};

// --- 2. LOGIC CHUNG ---
window.onload = function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('book-date').setAttribute('min', today);
    if(curPhone) showDashboard(curPhone);
    updateClock();
};

function updateClock() { 
    const now = new Date(); 
    const h = String(now.getHours()).padStart(2,'0'), m = String(now.getMinutes()).padStart(2,'0'); 
    const d = String(now.getDate()).padStart(2,'0'), mo = String(now.getMonth()+1).padStart(2,'0'); 
    document.getElementById('live-clock').innerText = `${h}:${m} - ${d}/${mo}`;
}
setInterval(updateClock, 10000);

function showTab(t) { 
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden')); 
    document.getElementById('tab-' + t).classList.remove('hidden'); 
    document.querySelectorAll('nav button').forEach(btn => { btn.classList.remove('nav-active', 'text-[#006241]'); btn.classList.add('text-gray-300'); }); 
    document.getElementById('nav-' + t).classList.add('nav-active');
    document.getElementById('nav-' + t).classList.remove('text-gray-300'); 
}

function showAppModal(title, msg, icon='â˜•', cb=null) {
    document.getElementById('modal-title').innerText = title;
    document.getElementById('modal-message').innerHTML = msg;
    document.getElementById('modal-icon').innerText = icon;
    document.getElementById('modal-overlay').classList.remove('hidden');
    const btnMain = document.getElementById('modal-btn-main');
    const btnSub = document.getElementById('modal-btn-sub');
    
    // Reset buttons
    btnMain.onclick = null; btnSub.onclick = null;
    
    btnMain.onclick = () => { document.getElementById('modal-overlay').classList.add('hidden'); if(cb) cb(); };
    btnSub.classList.add('hidden');
}

function normalizePhone(p) { return String(p || "").replace(/[^0-9]/g, ""); }

// --- 3. ÄÄ‚NG NHáº¬P ---
function login() {
    const phone = normalizePhone(document.getElementById('login-sdt').value);
    if (phone.length < 9) return alert("SÄT khÃ´ng há»£p lá»‡!");
    
    document.getElementById('loading-overlay').classList.remove('hidden');
    db.ref('customers/' + phone).once('value', snap => {
        document.getElementById('loading-overlay').classList.add('hidden');
        if (snap.exists()) {
            localStorage.setItem('member_phone', phone);
            showDashboard(phone);
        } else {
            alert("SÄT nÃ y chÆ°a Ä‘Äƒng kÃ½ thÃ nh viÃªn!");
        }
    });
}

function showDashboard(phone) {
    curPhone = phone;
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('main-app').classList.remove('hidden');
    document.getElementById('nav-bar').classList.remove('hidden');

    // Láº¯ng nghe User Realtime
    db.ref('customers/' + phone).on('value', snap => {
        userData = snap.val();
        if(userData) {
            document.getElementById('user-name-display').innerText = userData.name;
            document.getElementById('user-points').innerText = (userData.points || 0).toLocaleString();
            
            // Äiá»n form
            document.getElementById('edit-name').value = userData.name;
            document.getElementById('edit-sdt').value = phone;
            document.getElementById('edit-cname').value = userData.compName || "";
            document.getElementById('edit-cphone').value = userData.compPhone || "";
            
            document.getElementById('book-cname').value = userData.compName || "";
            document.getElementById('book-cphone').value = userData.compPhone || "";
            
            let r = "ThÃ nh viÃªn";
            if (userData.points >= 55000) r = "ThÃ nh viÃªn 'siu thÃ¢n'";
            else if (userData.points >= 33000) r = "ThÃ nh viÃªn 'thÃ¢n iu'";
            else if (userData.points >= 10000) r = "ThÃ nh viÃªn Báº¡c";
            document.getElementById('user-rank').innerText = r;
        }
    });
    
    loadRewards();
}

// --- 4. Cáº¬P NHáº¬T Há»’ SÆ  ---
function handleUpdate() {
    const name = document.getElementById('edit-name').value;
    const cName = document.getElementById('edit-cname').value;
    const cPhone = document.getElementById('edit-cphone').value;
    const oldData = {...userData};

    document.getElementById('loading-overlay').classList.remove('hidden');
    
    // Update Firebase
    db.ref('customers/' + curPhone).update({ name: name, compName: cName, compPhone: cPhone });
    
    // Log Sheet
    fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST', mode: 'no-cors',
        body: JSON.stringify({ action: 'logProfileUpdate', phone: curPhone, oldName: oldData.name, newName: name, oldComp: oldData.compName || "", newComp: cName })
    }).finally(() => {
        document.getElementById('loading-overlay').classList.add('hidden');
        showAppModal("ThÃ nh cÃ´ng", "ÄÃ£ cáº­p nháº­t há»“ sÆ¡!", 'âœ…');
    });
}

// --- 5. Äáº¶T BED (POS STYLE) ---
function handleBooking() {
    if (!document.getElementById('agree-rules').checked) return alert("Vui lÃ²ng Ä‘á»“ng Ã½ ná»™i quy!");
    const date = document.getElementById('book-date').value;
    const start = document.getElementById('book-start').value;
    const end = document.getElementById('book-end').value;
    const cName = document.getElementById('book-cname').value;
    const cPhone = document.getElementById('book-cphone').value;

    if(!date || !start || !end) return alert("Nháº­p Ä‘á»§ ngÃ y giá»!");
    if(start >= end) return alert("Giá» káº¿t thÃºc pháº£i sau giá» báº¯t Ä‘áº§u!");
    if(start < "08:00" || end > "20:50") return alert("QuÃ¡n hoáº¡t Ä‘á»™ng 08:00 - 20:50");

    const sMin = parseInt(start.split(':')[0])*60 + parseInt(start.split(':')[1]);
    const eMin = parseInt(end.split(':')[0])*60 + parseInt(end.split(':')[1]);
    if(eMin - sMin < 30) return alert("Tá»‘i thiá»ƒu 30 phÃºt!");

    document.getElementById('loading-overlay').classList.remove('hidden');

    // Chuyá»ƒn ngÃ y sang dd/MM/yyyy
    const p = date.split('-');
    const dateStr = `${p[2]}/${p[1]}/${p[0]}`;

    // Check Firebase
    db.ref('bedBookings').orderByChild('date').equalTo(dateStr).once('value', snap => {
        const bookings = [];
        snap.forEach(c => { const v = c.val(); if(v.status !== 'Ä‘Ã£ há»§y' && v.status !== 'Ä‘Ã£ xong') bookings.push(v); });

        let availableBed = null;
        for(let i=1; i<=4; i++) {
            let busy = false;
            for(let b of bookings) {
                if(b.bedId == i) {
                    const bs = parseInt(b.start.split(':')[0])*60 + parseInt(b.start.split(':')[1]);
                    const be = parseInt(b.end.split(':')[0])*60 + parseInt(b.end.split(':')[1]);
                    if(Math.max(sMin, bs) < Math.min(eMin, be)) { busy = true; break; }
                }
            }
            if(!busy) { availableBed = i; break; }
        }

        if(availableBed) {
            db.ref('bedBookings').push({
                phone: curPhone, name: userData.name,
                date: dateStr, start: start, end: end,
                compName: cName, compPhone: cPhone,
                bedId: availableBed, status: "chá» khÃ¡ch", type: "app",
                createdAt: new Date().toISOString()
            }, () => {
                document.getElementById('loading-overlay').classList.add('hidden');
                showAppModal("ThÃ nh cÃ´ng", `ÄÃ£ Ä‘áº·t Bed 0${availableBed}`, 'âœ…', () => {
                    document.getElementById('book-date').value = "";
                    showTab('user');
                });
            });
        } else {
            document.getElementById('loading-overlay').classList.add('hidden');
            alert("Giá» nÃ y Ä‘Ã£ kÃ­n chá»—. Vui lÃ²ng chá»n giá» khÃ¡c.");
        }
    });
}

// --- 6. QUÃ€ & Lá»ŠCH Sá»¬ ---
function loadRewards() {
    db.ref('rewards').on('value', snap => {
        const list = document.getElementById('rewards-list');
        list.innerHTML = "";
        const r = snap.val();
        if(!r) { list.innerHTML = "ChÆ°a cÃ³ quÃ "; return; }
        
        Object.values(r).forEach(item => {
            const cost = parseInt(item.cost);
            const can = (userData.points || 0) >= cost;
            const btnCls = can ? "bg-[#006241] text-white active:scale-95" : "bg-gray-200 text-gray-400";
            
            list.innerHTML += `
            <div class="bg-white p-4 rounded-[2rem] border border-gray-100 shadow-sm flex items-center gap-4">
                <img src="${item.img}" class="w-20 h-20 rounded-2xl object-cover bg-gray-50">
                <div class="flex-1">
                    <p class="font-bold text-sm text-[#1e3932] truncate">${item.name}</p>
                    <p class="text-[10px] font-bold text-amber-500 mb-2">${cost.toLocaleString()} Ä‘iá»ƒm</p>
                    <button onclick="redeemGift('${item.name}', ${cost})" ${can?'':'disabled'} class="w-full py-2 rounded-xl text-[10px] font-bold uppercase ${btnCls}">Äá»•i</button>
                </div>
            </div>`;
        });
    });
}

function redeemGift(name, cost) {
    if(!confirm(`Äá»•i ${name} vá»›i ${cost} Ä‘iá»ƒm?`)) return;
    const np = (userData.points || 0) - cost;
    if(np < 0) return alert("Lá»—i Ä‘iá»ƒm");
    
    document.getElementById('loading-overlay').classList.remove('hidden');
    db.ref('customers/' + curPhone).update({ points: np });
    
    fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST', mode: 'no-cors',
        body: JSON.stringify({ action: 'logRedeem', phone: curPhone, custName: userData.name, giftName: name, pointCost: cost })
    }).finally(() => {
        document.getElementById('loading-overlay').classList.add('hidden');
        alert("Äá»•i thÃ nh cÃ´ng!");
    });
}

function openHistory() {
    document.getElementById('history-modal').classList.remove('hidden');
    document.getElementById('history-loading').classList.remove('hidden');
    const list = document.getElementById('history-list');
    const activeDiv = document.getElementById('section-active-booking');
    const activeCard = document.getElementById('active-card');
    list.innerHTML = ""; activeDiv.classList.add('hidden');

    db.ref('bedBookings').orderByChild('phone').equalTo(curPhone).limitToLast(20).once('value', snap => {
        document.getElementById('history-loading').classList.add('hidden');
        const arr = [];
        snap.forEach(c => arr.push({key: c.key, ...c.val()}));
        
        arr.sort((a,b) => {
            const da = a.date.split('/').reverse().join('') + a.start;
            const db = b.date.split('/').reverse().join('') + b.start;
            return db.localeCompare(da);
        });

        const today = new Date();
        const dStr = String(today.getDate()).padStart(2,'0') + '/' + String(today.getMonth()+1).padStart(2,'0') + '/' + today.getFullYear();

        arr.forEach(h => {
            if(h.date === dStr && h.status !== 'Ä‘Ã£ xong' && h.status !== 'Ä‘Ã£ há»§y') {
                activeDiv.classList.remove('hidden');
                activeCard.innerHTML = `<div class="absolute top-0 right-0 p-3 bg-amber-100 text-amber-800 text-[10px] font-bold rounded-bl-2xl">ÄANG HOáº T Äá»˜NG</div><p class="text-3xl font-black text-[#1e3932] mb-1">${h.start}</p><p class="text-sm text-gray-500 font-medium mb-4">Äáº¿n: <b>${h.end}</b> â€¢ Bed: <b>${h.bedId}</b></p><button onclick="cancelBooking('${h.key}')" class="w-full py-3 bg-red-50 text-red-600 rounded-xl font-bold text-xs">Há»§y lá»‹ch</button>`;
            } else {
                let clr = "bg-gray-100 text-gray-500";
                if(h.status.includes('xong')) clr = "bg-green-100 text-green-600";
                if(h.status.includes('há»§y')) clr = "bg-red-50 text-red-500";
                list.innerHTML += `<div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm"><div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-gray-400">${h.date}</span><span class="px-2 py-1 rounded-md text-[10px] font-bold uppercase ${clr}">${h.status}</span></div><p class="text-lg font-black text-[#1e3932] leading-none">${h.start} - ${h.end}</p><p class="text-xs text-gray-400 mt-1">Bed: ${h.bedId}</p></div>`;
            }
        });
        if(arr.length === 0) list.innerHTML = "<p class='text-center text-gray-400 text-xs'>ChÆ°a cÃ³ lá»‹ch.</p>";
    });
}

function cancelBooking(key) {
    if(!confirm("Há»§y lá»‹ch nÃ y?")) return;
    document.getElementById('loading-overlay').classList.remove('hidden');
    db.ref('bedBookings/' + key).update({ status: 'Ä‘Ã£ há»§y', note: 'KhÃ¡ch tá»± há»§y' }, () => {
        document.getElementById('loading-overlay').classList.add('hidden');
        alert("ÄÃ£ há»§y.");
        openHistory();
    });
}
</script>
</body>
</html>
