<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Th√†nh Vi√™n - The Cafe 33</title>
    <meta name="theme-color" content="#006241">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-database-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=League+Spartan:wght@700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background: #F3F4F6; -webkit-tap-highlight-color: transparent; }
        .brand-font { font-family: 'League Spartan', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="bg-[#F2F2F7] min-h-screen flex flex-col relative overflow-hidden">

    <div id="loading-overlay" class="fixed inset-0 bg-white/95 z-[9999] hidden flex flex-col items-center justify-center backdrop-blur-sm">
        <div class="w-12 h-12 border-4 border-[#006241] border-t-transparent rounded-full animate-spin mb-3"></div>
        <p class="brand-font text-[#006241] animate-pulse font-bold tracking-widest">THE CAFE 33</p>
    </div>

    <div id="view-login" class="w-full h-screen flex flex-col items-center justify-center px-6 z-10 animate-fade-in">
        <div class="glass-panel rounded-[40px] p-8 shadow-xl text-center w-full max-w-sm">
            <div class="w-20 h-20 bg-[#006241] rounded-full mx-auto mb-6 flex items-center justify-center shadow-lg shadow-green-900/30">
                <span class="text-4xl">‚òï</span>
            </div>
            <h1 class="brand-font text-3xl text-[#006241] font-black uppercase tracking-wide mb-2">The Cafe 33</h1>
            <p class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-8">Tra c·ª©u th√†nh vi√™n</p>
            <div class="space-y-4">
                <input type="tel" id="login-phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i..." class="w-full p-5 bg-gray-50 rounded-[24px] text-center font-bold text-lg text-[#006241] outline-none border-2 border-transparent focus:border-[#006241] transition-all shadow-inner">
                <button onclick="handleLogin()" class="w-full py-5 bg-[#006241] text-white font-black rounded-[24px] uppercase text-sm shadow-xl shadow-green-900/20 active:scale-95 transition-all">ƒêƒÉng nh·∫≠p</button>
            </div>
            <p id="login-error" class="text-[10px] text-red-500 font-bold mt-4 h-4"></p>
        </div>
    </div>

    <div id="view-dashboard" class="hidden w-full h-screen flex flex-col z-10 animate-fade-in absolute inset-0 bg-[#F2F2F7]">
        <div class="bg-[#006241] pt-12 pb-24 px-8 rounded-b-[45px] shadow-lg relative shrink-0">
            <div class="flex justify-between items-start">
                <div onclick="document.getElementById('modal-profile').classList.remove('hidden')">
                    <p class="text-green-100/80 text-[10px] font-bold uppercase tracking-widest mb-1">Xin ch√†o,</p>
                    <h2 id="user-name" class="brand-font text-3xl text-white font-black capitalize">--</h2>
                    <p class="text-[9px] text-amber-300 font-bold mt-1 cursor-pointer">‚úé Ch·∫°m ƒë·ªÉ s·ª≠a h·ªì s∆°</p>
                </div>
                <button onclick="handleLogout()" class="bg-white/10 p-2 rounded-xl text-white/80 hover:bg-white/20 transition backdrop-blur-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                </button>
            </div>
        </div>

        <div class="px-6 -mt-16 mb-4 relative z-20">
            <div class="glass-panel bg-white/95 p-6 rounded-[35px] shadow-lg flex items-center justify-between">
                <div>
                    <p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest mb-1">ƒêi·ªÉm t√≠ch l≈©y</p>
                    <p id="user-points" class="brand-font text-5xl text-[#006241] font-black">0</p>
                </div>
                <div class="w-14 h-14 bg-amber-100 text-amber-500 rounded-full flex items-center justify-center shadow-inner text-2xl">üëë</div>
            </div>
        </div>

        <div class="px-6 mb-4 flex gap-2">
            <button onclick="switchTab('history')" id="tab-btn-history" class="flex-1 py-3 bg-[#006241] text-white rounded-2xl font-bold text-xs shadow-md transition-all">L·ªãch s·ª≠</button>
            <button onclick="switchTab('rewards')" id="tab-btn-rewards" class="flex-1 py-3 bg-white text-gray-400 rounded-2xl font-bold text-xs shadow-sm transition-all">ƒê·ªïi qu√†</button>
        </div>

        <div class="flex-1 overflow-y-auto px-6 pb-6 space-y-4 custom-scrollbar">
            <div id="tab-history" class="animate-fade-in">
                <div id="history-list" class="space-y-3"></div>
            </div>
            <div id="tab-rewards" class="hidden animate-fade-in">
                <div id="rewards-list" class="grid grid-cols-2 gap-3"></div>
            </div>
        </div>
    </div>

    <div id="modal-profile" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-[35px] p-8 w-full max-w-sm shadow-2xl">
            <h3 class="brand-font text-xl text-[#006241] mb-6 text-center uppercase font-black">C·∫≠p nh·∫≠t h·ªì s∆°</h3>
            <div class="space-y-3">
                <input id="edit-name" type="text" placeholder="T√™n c·ªßa b·∫°n" class="w-full p-4 bg-gray-50 rounded-2xl text-sm font-bold text-[#006241] outline-none border border-transparent focus:border-[#006241]">
                <input id="edit-comp-name" type="text" placeholder="T√™n ng∆∞·ªùi ƒëi c√πng" class="w-full p-4 bg-gray-50 rounded-2xl text-sm font-bold text-[#006241] outline-none border border-transparent focus:border-[#006241]">
                <input id="edit-comp-phone" type="tel" placeholder="SƒêT ng∆∞·ªùi ƒëi c√πng" class="w-full p-4 bg-gray-50 rounded-2xl text-sm font-bold text-[#006241] outline-none border border-transparent focus:border-[#006241]">
            </div>
            <div class="grid grid-cols-2 gap-3 mt-6">
                <button onclick="document.getElementById('modal-profile').classList.add('hidden')" class="py-3 bg-gray-100 text-gray-500 rounded-xl font-bold text-xs uppercase">H·ªßy</button>
                <button onclick="saveProfile()" class="py-3 bg-[#006241] text-white rounded-xl font-bold text-xs shadow-lg uppercase">L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>

    <script>
        // =============================================================
        // 1. C·∫§U H√åNH (THAY ƒê·ªîI T·∫†I ƒê√ÇY)
        // =============================================================
        
        // [QUAN TR·ªåNG] COPY NGUY√äN KH·ªêI N√ÄY T·ª™ FILE POS C·ª¶A B√Ä SANG
        const firebaseConfig = {
            apiKey: "AIzaSyCNh1-16gYZ0P30Fkd-2tB-O89PXkPX9Lc",
            authDomain: "the-cafe-33.firebaseapp.com",
            databaseURL: "https://the-cafe-33-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "the-cafe-33",
            storageBucket: "the-cafe-33.appspot.com",
            messagingSenderId: "...",
            appId: "..."
        };
        
        // [QUAN TR·ªåNG] D√ÅN LINK WEB APP (ƒêU√îI /exec) M·ªöI NH·∫§T V√ÄO ƒê√ÇY
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxDp3MHSZJmux8cZwROdQKdallHwnO6jvqy-CpXjj4a/dev"; 

        // Kh·ªüi t·∫°o Firebase
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Bi·∫øn to√†n c·ª•c
        let curPhone = localStorage.getItem('member_phone');
        let userData = {};

        // =============================================================
        // 2. KH·ªûI ƒê·ªòNG & ƒêƒÇNG NH·∫¨P
        // =============================================================
        window.onload = function() {
            if(curPhone) showDashboard(curPhone);
        };

        function normalizePhone(p) { return String(p || "").replace(/[^0-9]/g, ""); }

        function handleLogin() {
            const phone = normalizePhone(document.getElementById('login-phone').value);
            if (phone.length < 9) return document.getElementById('login-error').innerText = "SƒêT kh√¥ng h·ª£p l·ªá!";

            document.getElementById('loading-overlay').classList.remove('hidden');
            
            // T√¨m trong Firebase (Nhanh nh∆∞ ƒëi·ªán)
            db.ref('customers/' + phone).once('value', snap => {
                document.getElementById('loading-overlay').classList.add('hidden');
                if (snap.exists()) {
                    localStorage.setItem('member_phone', phone);
                    showDashboard(phone);
                } else {
                    document.getElementById('login-error').innerText = "SƒêT ch∆∞a ƒëƒÉng k√Ω!";
                }
            });
        }

        function handleLogout() {
            localStorage.removeItem('member_phone');
            location.reload();
        }

        function showDashboard(phone) {
            curPhone = phone;
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-dashboard').classList.remove('hidden');

            // A. L·∫Øng nghe th√¥ng tin kh√°ch Realtime (C·ª±c quan tr·ªçng)
            db.ref('customers/' + phone).on('value', snap => {
                userData = snap.val();
                if(userData) {
                    document.getElementById('user-name').innerText = userData.name;
                    // Hi·ªáu ·ª©ng nh·∫£y s·ªë
                    animateValue("user-points", parseInt(document.getElementById('user-points').innerText.replace(/,/g,'')||0), userData.points || 0, 1000);
                    
                    // ƒêi·ªÅn s·∫µn form s·ª≠a
                    document.getElementById('edit-name').value = userData.name;
                    document.getElementById('edit-comp-name').value = userData.compName || userData.companionName || "";
                    document.getElementById('edit-comp-phone').value = userData.compPhone || userData.companionPhone || "";
                }
            });

            // B. T·∫£i d·ªØ li·ªáu ph·ª•
            loadHistory(phone);
            loadRewards();
        }

        // =============================================================
        // 3. QU·∫¢N L√ù QU√Ä T·∫∂NG (T·ª´ Firebase 'rewards')
        // =============================================================
        function loadRewards() {
            // L·∫Øng nghe nh√°nh 'rewards' do Script ƒë·∫©y l√™n
            db.ref('rewards').on('value', snap => {
                const list = document.getElementById('rewards-list');
                list.innerHTML = "";
                const rewards = snap.val();
                
                if (!rewards) {
                    list.innerHTML = '<p class="col-span-2 text-center text-gray-400 text-xs py-10">Ch∆∞a c√≥ danh s√°ch qu√†.</p>';
                    return;
                }

                Object.values(rewards).forEach(r => {
                    const cost = parseInt(r.cost);
                    const canRedeem = ((userData.points || 0) >= cost);
                    
                    // Style n√∫t ƒë·ªïi qu√†
                    const btnClass = canRedeem 
                        ? "bg-[#006241] text-white shadow-md active:scale-95 hover:bg-[#004f32]" 
                        : "bg-gray-100 text-gray-400 cursor-not-allowed";
                    
                    list.innerHTML += `
                    <div class="bg-white p-4 rounded-[24px] shadow-sm border border-gray-100 flex flex-col items-center text-center relative overflow-hidden group">
                        <div class="w-16 h-16 rounded-2xl bg-gray-50 mb-3 overflow-hidden border border-gray-100">
                            <img src="${r.img || 'https://placehold.co/100'}" class="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-500">
                        </div>
                        <p class="text-xs font-black text-[#1e3932] mb-1 truncate w-full uppercase tracking-tight">${r.name}</p>
                        <p class="text-[10px] font-bold text-amber-500 mb-3 bg-amber-50 px-2 py-0.5 rounded-md">${cost.toLocaleString()} ƒëi·ªÉm</p>
                        <button onclick="redeemGift('${r.name}', ${cost})" ${canRedeem ? '' : 'disabled'} class="w-full py-2.5 rounded-xl text-[10px] font-black uppercase transition-all ${btnClass}">
                            ƒê·ªïi Ngay
                        </button>
                    </div>`;
                });
            });
        }

        function redeemGift(giftName, cost) {
            if(!confirm(`X√°c nh·∫≠n ƒë·ªïi [${giftName}] v·ªõi ${cost.toLocaleString()} ƒëi·ªÉm?`)) return;
            
            const newPoints = (userData.points || 0) - cost;
            if(newPoints < 0) return alert("L·ªói: Kh√¥ng ƒë·ªß ƒëi·ªÉm!");

            document.getElementById('loading-overlay').classList.remove('hidden');

            // 1. Tr·ª´ ƒëi·ªÉm tr√™n Firebase NGAY L·∫¨P T·ª®C (ƒë·ªÉ POS th·∫•y ngay)
            db.ref('customers/' + curPhone).update({ points: newPoints });

            // 2. G·ªçi v·ªÅ Google Sheet ƒë·ªÉ ghi s·ªï (LichSuDoiQua)
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // Quan tr·ªçng: no-cors ƒë·ªÉ kh√¥ng b·ªã l·ªói tr√¨nh duy·ªát ch·∫∑n
                body: JSON.stringify({
                    action: 'logRedeemGift', // Kh·ªõp v·ªõi l·ªánh trong M√£.gs
                    phone: curPhone,
                    custName: userData.name,
                    giftName: giftName,
                    pointCost: cost
                })
            }).then(() => {
                // Th√†nh c√¥ng (d√π no-cors kh√¥ng tr·∫£ v·ªÅ k·∫øt qu·∫£ ƒë·ªçc ƒë∆∞·ª£c, nh∆∞ng code 200 l√† ok)
                document.getElementById('loading-overlay').classList.add('hidden');
                alert("ƒê·ªïi qu√† th√†nh c√¥ng! H√£y ƒë∆∞a m√†n h√¨nh cho nh√¢n vi√™n.");
            }).catch(e => {
                document.getElementById('loading-overlay').classList.add('hidden');
                alert("ƒê√£ ƒë·ªïi tr√™n App nh∆∞ng l·ªói l∆∞u Sheet. Vui l√≤ng b√°o nh√¢n vi√™n.");
            });
        }

        // =============================================================
        // 4. S·ª¨A H·ªí S∆†
        // =============================================================
        function saveProfile() {
            const newName = document.getElementById('edit-name').value;
            const newComp = document.getElementById('edit-comp-name').value;
            const newCompPhone = document.getElementById('edit-comp-phone').value;

            document.getElementById('modal-profile').classList.add('hidden');
            document.getElementById('loading-overlay').classList.remove('hidden');

            const oldData = { ...userData }; // Backup d·ªØ li·ªáu c≈©

            // 1. C·∫≠p nh·∫≠t Firebase NGAY L·∫¨P T·ª®C
            db.ref('customers/' + curPhone).update({
                name: newName,
                compName: newComp,
                compPhone: newCompPhone
            });

            // 2. G·ª≠i v·ªÅ Google Sheet ƒë·ªÉ l∆∞u v·∫øt (LichSuThayDoi)
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({
                    action: 'logUpdateProfile', // Kh·ªõp v·ªõi l·ªánh trong M√£.gs
                    phone: curPhone,
                    oldName: oldData.name, newName: newName,
                    oldComp: oldData.compName || "", newComp: newComp
                })
            }).finally(() => {
                document.getElementById('loading-overlay').classList.add('hidden');
                alert("C·∫≠p nh·∫≠t h·ªì s∆° th√†nh c√¥ng!");
            });
        }

        // =============================================================
        // 5. L·ªäCH S·ª¨ ƒê∆†N H√ÄNG (GI·ªêNG POS)
        // =============================================================
        function loadHistory(phone) {
            // L·∫•y 20 ƒë∆°n m·ªõi nh·∫•t t·ª´ Firebase
            db.ref('orders').orderByChild('createdAt').limitToLast(20).on('value', snap => {
                const list = document.getElementById('history-list');
                list.innerHTML = "";
                const orders = [];
                
                snap.forEach(child => {
                    const val = child.val();
                    // L·ªçc ƒë√∫ng SƒêT kh√°ch (chu·∫©n h√≥a)
                    if (normalizePhone(val.sdt) === phone) orders.push(val);
                });

                if(orders.length == 0) {
                    list.innerHTML = '<p class="text-center text-gray-400 text-xs mt-10">B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</p>';
                    return;
                }

                // ƒê·∫£o ng∆∞·ª£c ƒë·ªÉ ƒë∆°n m·ªõi nh·∫•t l√™n ƒë·∫ßu
                orders.reverse().forEach(o => {
                    const d = new Date(o.createdAt);
                    const timeStr = d.toLocaleDateString('vi-VN') + " ‚Ä¢ " + d.toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'});
                    
                    list.innerHTML += `
                    <div class="bg-white p-4 rounded-[24px] shadow-sm border border-gray-100 flex justify-between items-center relative overflow-hidden">
                        <div class="absolute left-0 top-0 bottom-0 w-1 bg-[#006241]"></div>
                        <div class="pl-2">
                            <p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest mb-1">${timeStr}</p>
                            <p class="text-xs font-bold text-gray-700 line-clamp-1 w-48">${o.items}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-black text-[#006241]">${Number(o.total).toLocaleString()}ƒë</p>
                            ${o.bedId && o.bedId !== "WAITING" ? '<span class="text-[8px] bg-green-50 text-green-700 px-1.5 py-0.5 rounded font-bold uppercase border border-green-100">BED 0'+o.bedId+'</span>' : ''}
                        </div>
                    </div>`;
                });
            });
        }

        // Helper: Chuy·ªÉn Tab
        function switchTab(t) {
            document.getElementById('tab-history').classList.add('hidden');
            document.getElementById('tab-rewards').classList.add('hidden');
            
            // Reset style n√∫t
            const inactiveClass = "flex-1 py-3 bg-white text-gray-400 rounded-2xl font-bold text-xs shadow-sm transition-all";
            document.getElementById('tab-btn-history').className = inactiveClass;
            document.getElementById('tab-btn-rewards').className = inactiveClass;
            
            // Active style
            document.getElementById('tab-' + t).classList.remove('hidden');
            document.getElementById('tab-btn-' + t).className = "flex-1 py-3 bg-[#006241] text-white rounded-2xl font-bold text-xs shadow-md transition-all transform scale-105";
        }

        // Helper: Hi·ªáu ·ª©ng nh·∫£y s·ªë
        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const range = end - start;
            let current = start;
            const increment = end > start ? Math.ceil(range/20) : Math.floor(range/20); // Nh·∫£y nhanh h∆°n
            const stepTime = Math.abs(Math.floor(duration / (range / increment)));
            const obj = document.getElementById(id);
            const timer = setInterval(function() {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    current = end;
                    clearInterval(timer);
                }
                obj.innerHTML = current.toLocaleString();
            }, stepTime);
        }
    </script>
</body>
</html>
