<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#006241">
  
  <link rel="icon" href="https://i.ibb.co/nqdTWnvt/N-u-v-N-u-v-ng-Ngh-thu-t-s-p-ch-In-m-Ti-m-c-ph-Bi-u-tr-ng-C-ph-20260121-210413-0000.png">
  <link rel="apple-touch-icon" href="https://i.ibb.co/nqdTWnvt/N-u-v-N-u-v-ng-Ngh-thu-t-s-p-ch-In-m-Ti-m-c-ph-Bi-u-tr-ng-C-ph-20260121-210413-0000.png">
  
  <link rel="manifest" href='data:application/manifest+json,{
    "name": "Cafe 33 Member",
    "short_name": "Cafe 33",
    "display": "standalone",
    "start_url": ".",
    "background_color": "#006241",
    "theme_color": "#006241",
    "icons": [{
      "src": "https://i.ibb.co/nqdTWnvt/N-u-v-N-u-v-ng-Ngh-thu-t-s-p-ch-In-m-Ti-m-c-ph-Bi-u-tr-ng-C-ph-20260121-210413-0000.png",
      "sizes": "192x192",
      "type": "image/png"
    }]
  }'>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=League+Spartan:wght@700;800&display=swap" rel="stylesheet">
  
  <!-- Realtime Database SDK chung v·ªõi POS -->
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-database-compat.js"></script>
  
  <style>
    /* CSS CH·ªêNG RELOAD & ZOOM */
    html, body {
        overscroll-behavior-y: none; 
        touch-action: pan-x pan-y;
        margin: 0; padding: 0; height: 100%; width: 100%;
        -webkit-tap-highlight-color: transparent;
    }
    body { 
        background-color: #f8f9fa; 
        font-family: 'Inter', sans-serif; 
        color: #1e3932; 
        text-align: left; 
        -webkit-font-smoothing: antialiased;
        overflow-y: auto; 
    }
    .brand-font { font-family: 'League Spartan', sans-serif; font-weight: 800; letter-spacing: -0.01em; }
    .sb-green { background-color: #006241; }
    .card-gradient { background: linear-gradient(135deg, #004d33 0%, #006241 100%); }
    .nav-active { color: #006241; font-weight: 800; background-color: rgba(0, 98, 65, 0.05); border-radius: 1.5rem; }
    .tab-content { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    #custom-modal, #image-overlay { transition: all 0.3s ease; }
    .modal-enter { opacity: 0; transform: scale(0.9); }
    .modal-show { opacity: 1; transform: scale(1); }
    
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #D1D1D6; border-radius: 10px; }
  </style>
</head>
<body class="min-h-screen pb-32">

  <div id="loading-overlay" class="fixed inset-0 bg-white/95 z-[9999] hidden flex flex-col items-center justify-center backdrop-blur-sm">
    <div class="w-14 h-14 border-4 border-[#006241] border-t-transparent rounded-full animate-spin mb-4"></div>
    <p class="brand-font text-[#006241] text-xl font-black animate-pulse">The cafe 33</p>
    <p class="text-xs text-gray-400 font-bold mt-2" id="loading-text">ƒêang k·∫øt n·ªëi...</p>
  </div>

  <div id="image-overlay" class="fixed inset-0 bg-black/95 z-[200] hidden flex flex-col items-center justify-center p-4 backdrop-blur-md">
    <button onclick="document.getElementById('image-overlay').classList.add('hidden')" class="absolute top-8 right-8 text-white text-5xl font-light">&times;</button>
    <div class="w-full h-full flex items-center justify-center overflow-auto"><img id="zoomed-img" src="" class="max-w-full max-h-full object-contain shadow-2xl transition-transform" onclick="event.stopPropagation()"></div>
  </div>

  <div id="modal-overlay" class="fixed inset-0 bg-black/40 z-[100] hidden flex items-center justify-center p-6 backdrop-blur-sm">
    <div id="custom-modal" class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl text-center modal-enter">
      <div id="modal-icon" class="text-5xl mb-4">‚òï</div>
      <h3 id="modal-title" class="brand-font text-2xl text-[#006241] mb-3">Th√¥ng b√°o</h3>
      <div id="modal-message" class="text-lg text-[#1e3932] font-bold mb-8 leading-relaxed brand-font"></div>
      <div id="modal-actions" class="flex flex-col gap-3">
        <button id="modal-btn-main" class="w-full py-4 sb-green text-white font-bold rounded-2xl uppercase tracking-widest text-xs shadow-lg">ƒê·ªìng √Ω</button>
        <button id="modal-btn-sub" class="w-full py-4 text-gray-400 font-bold rounded-2xl uppercase tracking-widest text-[10px] hidden">H·ªßy b·ªè</button>
      </div>
    </div>
  </div>

  <div id="login-screen" class="flex flex-col items-center justify-center min-h-screen p-8 bg-white text-center">
    <h1 class="text-5xl text-[#006241] mb-4 brand-font">The cafe 33</h1>
    <p class="text-[11px] font-bold text-gray-400 mb-12 uppercase tracking-widest">T√≠ch ƒëi·ªÉm nh·∫≠n ƒë·∫∑c quy·ªÅn</p>
    <input type="tel" id="login-sdt" placeholder="S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n..." class="w-full p-5 rounded-3xl bg-gray-50 border border-gray-100 mb-4 text-center outline-none text-lg">
    <button id="btn-login" class="w-full p-5 rounded-3xl sb-green text-white font-bold shadow-md active:scale-95 transition-all uppercase text-lg">ƒêƒÉng nh·∫≠p</button>
  </div>

  <div id="main-app" class="hidden">
    <div class="p-5 bg-white shadow-sm flex justify-between items-center sticky top-0 z-50">
      <h2 class="text-2xl text-[#006241] brand-font">The cafe 33</h2>
      <div id="live-clock" class="text-[11px] font-extrabold text-[#006241] border border-gray-100 px-4 py-2 rounded-full bg-gray-50 shadow-inner">--:--</div>
    </div>

    <div id="tab-user" class="p-5 tab-content">
      <div class="card-gradient p-8 rounded-[2.5rem] text-white shadow-2xl h-60 flex flex-col justify-between relative overflow-hidden mb-8 text-left">
        <div class="flex justify-between items-start z-10"><p class="text-[10px] font-bold uppercase tracking-widest opacity-80">Member Card</p><p class="text-[14px] opacity-60 brand-font">The cafe 33</p></div>
        <div class="z-10"><p id="user-name-display" class="text-3xl font-bold uppercase tracking-wider mb-2"></p>
          <div class="flex justify-between items-end"><p id="user-rank" class="text-[12px] text-amber-400 font-bold uppercase tracking-widest"></p><div class="text-right"><span id="user-points" class="text-5xl font-black">0</span><span class="text-xs ml-1 opacity-70 font-bold">‚òÖ</span></div></div>
        </div>
        <div class="absolute -bottom-10 -right-10 w-48 h-48 bg-white/5 rounded-full blur-3xl"></div>
      </div>
      
      <div id="btn-open-history" class="bg-white p-5 rounded-[2.5rem] shadow-sm border border-gray-100 flex items-center justify-between cursor-pointer mb-6 active:scale-95 transition-transform">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-full bg-green-50 flex items-center justify-center text-xl text-[#006241]">üìÖ</div>
            <div>
                <p class="font-bold text-[#1e3932] text-sm uppercase tracking-wider">L·ªãch s·ª≠ ƒë·∫∑t Bed</p>
                <p class="text-[10px] text-gray-400 font-bold">Xem l·ªãch tr√¨nh & H·ªßy l·ªãch</p>
            </div>
        </div>
        <div class="text-gray-300 font-bold">‚ûú</div>
      </div>

      <div class="bg-white p-7 rounded-[2.5rem] shadow-sm border border-gray-100 space-y-4 text-left">
        <h4 class="font-bold text-[10px] uppercase text-gray-400 ml-2 tracking-widest">H·ªì s∆° c·ªßa b·∫°n</h4>
        <div><label class="text-[10px] font-bold text-gray-400 ml-2 uppercase">T√™n c·ªßa b·∫°n</label><input type="text" id="edit-name" class="w-full p-4 bg-gray-50 rounded-2xl outline-none mt-1 shadow-inner"></div>
        <div><label class="text-[10px] font-bold text-gray-400 ml-2 uppercase">S·ªë ƒëi·ªán tho·∫°i</label><input type="tel" id="edit-sdt" class="w-full p-4 bg-gray-50 rounded-2xl outline-none mt-1 shadow-inner"></div>
        <p class="text-[10px] font-bold text-gray-400 ml-2 uppercase pt-2 tracking-widest">Ng∆∞·ªùi ƒëi c√πng m·∫∑c ƒë·ªãnh</p>
        <div class="space-y-3"><input type="text" id="edit-cname" class="w-full p-4 bg-gray-50 rounded-2xl outline-none shadow-inner" placeholder="T√™n ng∆∞·ªùi ƒëi c√πng"><input type="tel" id="edit-cphone" class="w-full p-4 bg-gray-50 rounded-2xl outline-none shadow-inner" placeholder="SƒêT ng∆∞·ªùi ƒëi c√πng"></div>
        <button id="btn-update-profile" class="w-full py-4 rounded-2xl border-2 border-[#006241] text-[#006241] font-bold text-sm mt-4 uppercase tracking-widest">L∆∞u thay ƒë·ªïi</button>
      </div>
    </div>

    <div id="tab-bed" class="p-6 tab-content hidden">
      <h3 class="text-2xl text-[#006241] mb-6 brand-font text-left">ƒê·∫∑t ch·ªó Cafe in Bed</h3>
      <div class="bg-white p-7 rounded-[2.5rem] shadow-sm border border-gray-100 space-y-7 text-left">
        <div class="space-y-4"><label class="text-[10px] font-bold text-gray-400 uppercase ml-2 tracking-widest">Ng√†y b·∫°n ƒë·∫øn</label><input type="date" id="book-date" class="w-full p-4 rounded-2xl bg-gray-50 outline-none mt-1 shadow-inner text-center">
          <div class="flex gap-4"><div class="flex-1 text-center"><label class="text-[10px] font-bold text-gray-400 uppercase">B·∫Øt ƒë·∫ßu</label><input type="time" id="book-start" class="w-full p-4 rounded-2xl bg-gray-50 outline-none mt-1 shadow-inner text-center"></div><div class="flex-1 text-center"><label class="text-[10px] font-bold text-gray-400 uppercase">K·∫øt th√∫c</label><input type="time" id="book-end" class="w-full p-4 rounded-2xl bg-gray-50 outline-none mt-1 shadow-inner text-center"></div></div>
          <p class="text-[9px] text-amber-600 font-bold text-center italic">* Qu√°n ho·∫°t ƒë·ªông: 08:00 - 20:50</p>
        </div>
        <div class="space-y-4"><label class="text-[10px] font-bold text-gray-400 uppercase ml-2 tracking-widest">Th√¥ng tin ng∆∞·ªùi ƒëi c√πng</label><input type="text" id="book-cname" placeholder="T√™n ng∆∞·ªùi ƒëi c√πng" class="w-full p-4 rounded-2xl bg-gray-50 outline-none shadow-inner"><input type="tel" id="book-cphone" placeholder="S·ªë ƒëi·ªán tho·∫°i" class="w-full p-4 rounded-2xl bg-gray-50 outline-none shadow-inner"></div>
        <hr class="border-gray-50">
        <div class="space-y-5"><p class="text-[10px] font-bold text-gray-400 uppercase ml-2 text-center tracking-widest">N·ªôi quy & Mi·ªÖn tr·ª´ tr√°ch nhi·ªám</p>
          <div class="grid grid-cols-2 gap-4">
            <div class="relative aspect-square w-full rounded-[2rem] overflow-hidden border border-gray-100 shadow-sm" onclick="document.getElementById('zoomed-img').src='https://i.ibb.co/KcwBLYBN/N-I-QUY-S-D-NG-BED-20260109-102319-0000.png';document.getElementById('image-overlay').classList.remove('hidden');"><img src="https://i.ibb.co/KcwBLYBN/N-I-QUY-S-D-NG-BED-20260109-102319-0000.png" class="w-full h-full object-cover"><div class="absolute inset-0 bg-black/20 flex items-end justify-center pb-3"><span class="text-[8px] text-white font-bold uppercase bg-black/40 px-2 py-1 rounded-full backdrop-blur-sm">Nh·∫•n ƒë·ªÉ xem r√µ</span></div></div>
            <div class="relative aspect-square w-full rounded-[2rem] overflow-hidden border border-gray-100 shadow-sm" onclick="document.getElementById('zoomed-img').src='https://i.ibb.co/XrqnhTQK/2-20250520-223429-0001.png';document.getElementById('image-overlay').classList.remove('hidden');"><img src="https://i.ibb.co/XrqnhTQK/2-20250520-223429-0001.png" class="w-full h-full object-cover"><div class="absolute inset-0 bg-black/20 flex items-end justify-center pb-3"><span class="text-[8px] text-white font-bold uppercase bg-black/40 px-2 py-1 rounded-full backdrop-blur-sm">Nh·∫•n ƒë·ªÉ xem r√µ</span></div></div>
          </div>
          <div class="flex items-start gap-3 p-6 bg-gray-50 rounded-[2rem] border border-gray-100 text-left"><input type="checkbox" id="agree-rules" class="mt-1 w-7 h-7 accent-[#006241]"><label for="agree-rules" class="text-[12px] leading-relaxed text-gray-600 font-medium italic">T√¥i cam k·∫øt ƒë√£ ƒë·ªçc v√† tu√¢n th·ªß to√†n b·ªô n·ªôi quy c·ªßa <span class="brand-font">The cafe 33</span>.</label></div>
        </div>
        <button id="btn-booking" class="w-full p-5 rounded-3xl sb-green text-white font-bold uppercase text-lg shadow-xl tracking-widest active:scale-95 transition-all">X√°c nh·∫≠n ƒë·∫∑t ch·ªó</button>
      </div>
    </div>

    <div id="tab-rewards" class="p-6 tab-content hidden"><h3 class="text-2xl text-[#006241] mb-6 brand-font text-left">ƒê·ªïi qu√† t·∫∑ng</h3><div id="rewards-list" class="grid grid-cols-1 gap-4"></div></div>
  </div>

  <nav id="nav-bar" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 h-28 flex justify-around items-center hidden z-50 px-6 shadow-2xl">
    <button id="nav-user" class="nav-active flex flex-col items-center justify-center w-1/3 py-4 transition-all"><span class="text-3xl mb-1">üë§</span><span class="text-[14px] uppercase font-extrabold tracking-tighter">B·∫°n</span></button>
    <button id="nav-bed" class="text-gray-300 flex flex-col items-center justify-center w-1/3 py-4 transition-all"><span class="text-3xl mb-1">üõå</span><span class="text-[14px] uppercase font-extrabold tracking-tighter">ƒê·∫∑t Bed</span></button>
    <button id="nav-rewards" class="text-gray-300 flex flex-col items-center justify-center w-1/3 py-4 transition-all"><span class="text-3xl mb-1">üéÅ</span><span class="text-[14px] uppercase font-extrabold tracking-tighter">ƒê·ªïi qu√†</span></button>
  </nav>

  <div id="history-modal" class="fixed inset-0 bg-white z-50 hidden flex-col overflow-hidden">
    <div class="px-5 pt-12 pb-4 bg-white border-b border-gray-100 flex items-center justify-between sticky top-0 z-10 shadow-sm">
      <h2 class="text-2xl font-black text-[#1e3932]">L·ªãch s·ª≠ ƒë·∫∑t Bed</h2>
      <button onclick="document.getElementById('history-modal').classList.add('hidden')" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200 transition">‚úï</button>
    </div>
    <div class="flex-1 overflow-y-auto overflow-x-hidden p-6 pb-40 bg-[#f8f9fa] w-full h-full overscroll-contain" id="history-content" style="-webkit-overflow-scrolling: touch;">
      <div id="history-loading" class="text-center py-10 text-gray-400">ƒêang t·∫£i d·ªØ li·ªáu...</div>
      <div id="section-active-booking" class="hidden mb-6">
         <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">L·ªãch tr√¨nh h√¥m nay</h3>
         <div id="active-card" class="bg-white rounded-2xl p-5 shadow-sm border border-amber-100 relative overflow-hidden"></div>
      </div>
      <div id="section-past-booking">
         <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">L·ªãch s·ª≠ ho·∫°t ƒë·ªông</h3>
         <div id="history-list" class="space-y-3"></div>
      </div>
    </div>
  </div>

  <div id="gift-detail-modal" class="fixed inset-0 bg-black/60 z-[80] hidden flex items-center justify-center p-6 backdrop-blur-sm transition-opacity duration-300">
    <div class="bg-white w-full max-w-sm rounded-[2.5rem] overflow-hidden shadow-2xl relative animate-bounce-in">
        <button onclick="document.getElementById('gift-detail-modal').classList.add('hidden')" class="absolute top-4 right-4 z-10 w-10 h-10 bg-black/20 text-white rounded-full flex items-center justify-center backdrop-blur-md hover:bg-black/40 transition">‚úï</button>
        <div class="h-64 w-full bg-gray-100 relative">
            <img id="detail-gift-img" src="" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
            <div class="absolute bottom-5 left-6 right-6"><h3 id="detail-gift-name" class="text-2xl font-black text-white leading-tight mb-1 shadow-black drop-shadow-md">T√™n qu√†</h3></div>
        </div>
        <div class="p-6">
            <p id="detail-gift-desc" class="text-gray-500 text-sm mb-6 leading-relaxed">M√¥ t·∫£ qu√† t·∫∑ng...</p>
            <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100 mb-6">
                <div class="flex justify-between text-xs font-bold text-gray-400 uppercase tracking-wider mb-2"><span>ƒêi·ªÉm c·ªßa b·∫°n</span><span>C·∫ßn c√≥</span></div>
                <div class="flex justify-between items-end"><span id="detail-user-point" class="text-xl font-black text-[#1e3932]">0</span><span class="text-gray-300 mb-1">/</span><span id="detail-gift-cost" class="text-xl font-black text-[#006241]">0</span></div>
                <div class="w-full h-2 bg-gray-200 rounded-full mt-3 overflow-hidden"><div id="detail-progress" class="h-full bg-[#006241] rounded-full transition-all duration-500" style="width: 0%"></div></div>
                <p id="detail-message" class="text-[10px] font-bold text-amber-500 mt-2 text-right hidden">B·∫°n c√≤n thi·∫øu ƒëi·ªÉm nha!</p>
            </div>
            <button id="btn-confirm-redeem" class="w-full py-4 rounded-2xl bg-[#006241] text-white font-bold text-sm uppercase tracking-widest shadow-lg shadow-green-900/20 active:scale-[0.98] transition-transform">X√°c nh·∫≠n ƒë·ªïi qu√†</button>
        </div>
    </div>
  </div>

  <script>
    
    // [EDIT HERE] Copy c·∫•u h√¨nh Firebase t·ª´ file POS d√°n v√†o ƒë√¢y:
    const firebaseConfig = {
  apiKey: "AIzaSyCNh1-16gYZ0P30Fkd-2tB-O89PXkPX9Lc",
  authDomain: "the-cafe-33.firebaseapp.com",
  databaseURL: "https://the-cafe-33-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "the-cafe-33",
  storageBucket: "the-cafe-33.firebasestorage.app",
  messagingSenderId: "238718397407",
  appId: "1:238718397407:web:8d605d6e0508c46dfaf26a",
  measurementId: "G-6CPTZGXJRY"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let curPhone = "";
    let curData = {};
    // Kh·ªüi t·∫°o App
    let app, db;
    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        console.log("Firebase initialized");
    } catch (e) {
        console.error("Firebase init error:", e);
        alert("L·ªói c·∫•u h√¨nh Firebase. Ki·ªÉm tra console.");
    }

    // --- 3. GLOBAL VARIABLES ---
    let uData = {}; 
    let curPhone = "";
    let _cachedGiftList = [];
    let unsubscribeUser = null; // D√πng ƒë·ªÉ h·ªßy l·∫Øng nghe khi logout

    // --- 4. CLOCK & UI HELPERS ---
    function updateClock() { 
        const now = new Date(); 
        const h = String(now.getHours()).padStart(2, '0'); 
        const m = String(now.getMinutes()).padStart(2, '0'); 
        const d = String(now.getDate()).padStart(2, '0'); 
        const mo = String(now.getMonth() + 1).padStart(2, '0'); 
        const el = document.getElementById('live-clock');
        if(el) el.innerText = h + ":" + m + " - " + d + "/" + mo; 
    }
    setInterval(updateClock, 10000); updateClock();

    window.showTab = function(t) { 
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden')); 
        document.getElementById('tab-' + t).classList.remove('hidden'); 
        document.querySelectorAll('nav button').forEach(btn => { 
            btn.classList.remove('nav-active', 'text-[#006241]'); 
            btn.classList.add('text-gray-300'); 
        }); 
        document.getElementById('nav-' + t).classList.add('nav-active'); 
        document.getElementById('nav-' + t).classList.remove('text-gray-300'); 
    }

    // Modal System
    window.showAppModal = function(title, message, icon = '‚òï', onConfirm = null) { 
        const overlay = document.getElementById('modal-overlay'); 
        const modal = document.getElementById('custom-modal'); 
        const btnSub = document.getElementById('modal-btn-sub'); 
        const btnMain = document.getElementById('modal-btn-main'); 
        
        document.getElementById('modal-title').innerText = title; 
        document.getElementById('modal-message').innerHTML = message; 
        document.getElementById('modal-icon').innerText = icon; 
        
        overlay.classList.remove('hidden'); 
        setTimeout(() => modal.classList.replace('modal-enter', 'modal-show'), 10); 
        
        // Reset button
        btnMain.onclick = null;
        btnSub.onclick = null;
        
        if (onConfirm) { 
            btnSub.classList.remove('hidden'); 
            btnMain.onclick = () => { closeAppModal(); onConfirm(); }; 
            btnSub.onclick = closeAppModal; 
        } else { 
            btnSub.classList.add('hidden'); 
            btnMain.onclick = closeAppModal; 
        } 
    }
    
    window.closeAppModal = function() { 
        const overlay = document.getElementById('modal-overlay'); 
        const modal = document.getElementById('custom-modal'); 
        modal.classList.replace('modal-show', 'modal-enter'); 
        setTimeout(() => overlay.classList.add('hidden'), 300); 
    }

    // --- 5. LOGIC ƒêƒÇNG NH·∫¨P ---
    document.getElementById('btn-login').addEventListener('click', login);

    async function login() { 
        curPhone = document.getElementById('login-sdt').value.trim(); 
        if(!curPhone) return showAppModal("Hic!", "B·∫°n nh·∫≠p s·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ ƒëƒÉng nh·∫≠p nh√©."); 
        
        document.getElementById('loading-overlay').classList.remove('hidden');
        document.getElementById('loading-text').innerText = "ƒêang t√¨m d·ªØ li·ªáu...";

        try {
            // Query collection 'customers'
            const q = query(collection(db, 'customers'), where('phone', '==', curPhone));
            const snapshot = await getDocs(q);
            
            if (!snapshot.empty) {
                const docSnap = snapshot.docs[0];
                uData = docSnap.data();
                uData.id = docSnap.id; // L∆∞u ID ƒë·ªÉ update
                
                // L·∫Øng nghe thay ƒë·ªïi ƒëi·ªÉm Realtime
                listenUserChanges(docSnap.id);

                // Load danh s√°ch qu√†
                await loadRewards();

                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('login-screen').classList.add('hidden'); 
                document.getElementById('main-app').classList.remove('hidden'); 
                document.getElementById('nav-bar').classList.remove('hidden'); 
                refreshUI(); 
            } else {
                document.getElementById('loading-overlay').classList.add('hidden');
                showAppModal("Th√¥ng b√°o", "S·ªë ƒëi·ªán tho·∫°i n√†y ch∆∞a ƒëƒÉng k√Ω th√†nh vi√™n!", 'üö´'); 
            }
        } catch (error) {
            console.error(error);
            document.getElementById('loading-overlay').classList.add('hidden');
            showAppModal("L·ªói m·∫°ng", "Kh√¥ng th·ªÉ k·∫øt n·ªëi Firebase: " + error.message, '‚ùå');
        }
    }

    function listenUserChanges(docId) {
        if (unsubscribeUser) unsubscribeUser(); // H·ªßy c√°i c≈© n·∫øu c√≥
        unsubscribeUser = onSnapshot(doc(db, 'customers', docId), (doc) => {
            if (doc.exists()) {
                uData = { ...uData, ...doc.data() };
                refreshUI(); // C·∫≠p nh·∫≠t giao di·ªán khi ƒëi·ªÉm thay ƒë·ªïi t·ª´ POS
            }
        });
    }

    async function loadRewards() {
        try {
            const q = query(collection(db, 'rewards')); // Collection 'rewards'
            const snapshot = await getDocs(q);
            let list = [];
            snapshot.forEach(doc => list.push(doc.data()));
            _cachedGiftList = list;
            // G·ªçi render sau
        } catch(e) { console.log("Ch∆∞a t·∫£i ƒë∆∞·ª£c qu√†:", e); }
    }

    function refreshUI() { 
        document.getElementById('user-name-display').innerText = uData.name || "Kh√°ch h√†ng"; 
        document.getElementById('user-points').innerText = (uData.points || 0).toLocaleString(); 
        
        document.getElementById('edit-name').value = uData.name || ""; 
        document.getElementById('edit-sdt').value = curPhone; 
        document.getElementById('edit-cname').value = uData.compName || ""; 
        document.getElementById('edit-cphone').value = uData.compPhone || ""; 
        
        document.getElementById('book-cname').value = uData.compName || ""; 
        document.getElementById('book-cphone').value = uData.compPhone || ""; 
        
        let p = uData.points || 0;
        let r = "Th√†nh vi√™n"; 
        if (p >= 55000) r = "Th√†nh vi√™n 'siu th√¢n'"; 
        else if (p >= 33000) r = "Th√†nh vi√™n 'th√¢n iu'"; 
        else if (p >= 10000) r = "Th√†nh vi√™n B·∫°c"; 
        document.getElementById('user-rank').innerText = r; 
        
        renderRewards(_cachedGiftList); 
    }

    // --- 6. LOGIC C·∫¨P NH·∫¨T & ƒê·ªíNG B·ªò 2 CHI·ªÄU ---
    document.getElementById('btn-update-profile').addEventListener('click', handleUpdate);

    async function handleUpdate() {
        const oldName = uData.name;
        const oldPhone = curPhone;
        const oldCName = uData.compName || "";
        const oldCPhone = uData.compPhone || "";

        const newName = document.getElementById('edit-name').value.trim();
        const newPhone = document.getElementById('edit-sdt').value.trim(); 
        const newCName = document.getElementById('edit-cname').value.trim();
        const newCPhone = document.getElementById('edit-cphone').value.trim();

        if (!newName || !newPhone) return showAppModal("Thi·∫øu tin", "T√™n v√† SƒêT ch√≠nh kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!", '‚ö†Ô∏è');

        document.getElementById('loading-overlay').classList.remove('hidden');
        document.getElementById('loading-text').innerText = "ƒêang l∆∞u v√† ƒë·ªìng b·ªô...";

        try {
            const userRef = doc(db, 'customers', uData.id);

            // A. Update Firebase
            const updateData = {
                name: newName,
                phone: newPhone,
                compName: newCName,
                compPhone: newCPhone,
                updatedAt: serverTimestamp()
            };
            await updateDoc(userRef, updateData);

            // B. Ghi Audit Log (LichSuThayDoi)
            if (newName !== oldName || newPhone !== oldPhone || newCName !== oldCName || newCPhone !== oldCPhone) {
                await addDoc(collection(db, 'audit_logs'), {
                    customerId: uData.id,
                    phone: oldPhone, 
                    action: 'update_profile',
                    changes: {
                        old: { name: oldName, phone: oldPhone, cName: oldCName, cPhone: oldCPhone },
                        new: { name: newName, phone: newPhone, cName: newCName, cPhone: newCPhone }
                    },
                    createdAt: serverTimestamp()
                });
            }

            // C. G·ªçi Webhook ƒë·ªÉ ƒë·ªìng b·ªô v·ªÅ Sheet (QUAN TR·ªåNG)
            if (GOOGLE_SCRIPT_SYNC_URL && GOOGLE_SCRIPT_SYNC_URL.includes("http")) {
                 const payload = JSON.stringify({
                    action: "syncProfileFromApp",
                    oldPhone: oldPhone,
                    data: { name: newName, phone: newPhone, compName: newCName, compPhone: newCPhone }
                });
                
                // Fire and forget (g·ª≠i ƒëi kh√¥ng ch·ªù k·∫øt qu·∫£ ƒë·ªÉ app m∆∞·ª£t)
                fetch(GOOGLE_SCRIPT_SYNC_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: payload
                }).catch(e => console.log("L·ªói g·ªçi sync sheet:", e));
            }

            // D. Ho√†n t·∫•t
            curPhone = newPhone; 
            uData = { ...uData, ...updateData };
            
            document.getElementById('loading-overlay').classList.add('hidden');
            showAppModal("Th√†nh c√¥ng", "Th√¥ng tin ƒë√£ ƒë∆∞·ª£c l∆∞u v√† ƒë·ªìng b·ªô!", '‚úÖ');
            
            if (oldPhone !== newPhone) {
                 showAppModal("L∆∞u √Ω", "B·∫°n v·ª´a ƒë·ªïi SƒêT. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.", 'üîÑ', () => location.reload());
            } else {
                refreshUI();
            }

        } catch (e) {
            document.getElementById('loading-overlay').classList.add('hidden');
            showAppModal("L·ªói", "Kh√¥ng l∆∞u ƒë∆∞·ª£c: " + e.message, '‚ùå');
        }
    }

    // --- 7. LOGIC ƒê·∫∂T BED (CLIENT-SIDE CALCULATION) ---
    document.getElementById('btn-booking').addEventListener('click', handleBooking);

    async function handleBooking() {
        if (!document.getElementById('agree-rules').checked) return showAppModal("N·ªôi quy", "B·∫°n t√≠ch ƒë·ªìng √Ω n·ªôi quy ƒë·ªÉ ti·∫øp t·ª•c nh√©.", 'üìú');
        
        const bDate = document.getElementById('book-date').value;
        const sT = document.getElementById('book-start').value;
        const eT = document.getElementById('book-end').value;

        if (!bDate || !sT || !eT) return showAppModal("Th√¥ng b√°o", "B·∫°n ch·ªçn ng√†y v√† gi·ªù c·ª• th·ªÉ nh√©.", 'üìÖ');

        const now = new Date();
        const today = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
        const curT = String(now.getHours()).padStart(2, '0') + ":" + String(now.getMinutes()).padStart(2, '0');

        if (bDate < today) return showAppModal("Ng√†y sai", "Kh√¥ng ƒë·∫∑t qu√° kh·ª© nha.", 'üìÖ');
        if (bDate === today && sT < curT) return showAppModal("Gi·ªù sai", "Gi·ªù b·∫Øt ƒë·∫ßu ƒë√£ qua r·ªìi.", '‚è∞');
        if (sT < "08:00" || eT > "20:50" || sT >= eT) return showAppModal("Gi·ªù ho·∫°t ƒë·ªông", "Qu√°n m·ªü t·ª´ 08:00 - 20:50.", '‚è∞');

        const startMin = timeToMinutes(sT);
        const endMin = timeToMinutes(eT);
        if ((endMin - startMin) < 30) return showAppModal("Th·ªùi gian", "T·ªëi thi·ªÉu 30 ph√∫t nh√©.", '‚è≥');

        document.getElementById('loading-overlay').classList.remove('hidden');
        document.getElementById('loading-text').innerText = "ƒêang ki·ªÉm tra ch·ªó...";

        // --- CHECK TR·ªêNG CH·ªñ (LOGIC T·ª™ M√É.GS CHUY·ªÇN V·ªÄ) ---
        try {
            // 1. T·∫£i booking trong ng√†y
            const q = query(collection(db, 'bedBookings'), where('date', '==', bDate));
            const snapshot = await getDocs(q);
            
            let bookings = [];
            let hasMyBooking = false;

            snapshot.forEach(doc => {
                const d = doc.data();
                if (d.status !== 'ƒë√£ h·ªßy') {
                    bookings.push(d);
                    if (d.phone === curPhone && d.status !== 'ƒë√£ xong') hasMyBooking = true;
                }
            });

            if (hasMyBooking) {
                document.getElementById('loading-overlay').classList.add('hidden');
                return showAppModal("Quy ƒë·ªãnh", "B·∫°n ƒë√£ c√≥ l·ªãch ƒë·∫∑t trong ng√†y n√†y r·ªìi.", 'üö´');
            }

            // 2. Logic x·∫øp Bed (Gi·∫£ l·∫≠p 4 Bed)
            let bedStatus = { 1: [], 2: [], 3: [], 4: [] };
            // Ph√¢n lo·∫°i ƒë∆°n c≈© v√†o bed
            bookings.forEach(b => {
                const s = timeToMinutes(b.startTime);
                const e = timeToMinutes(b.endTime);
                const bid = parseInt(b.bedId);
                if (bid >= 1 && bid <= 4) bedStatus[bid].push({s, e});
            });

            // 3. T√¨m Bed tr·ªëng
            let foundBed = null;
            for (let i = 1; i <= 4; i++) {
                let slots = bedStatus[i];
                let isBusy = false;
                for (let sl of slots) {
                    // Check overlap: Max(StartA, StartB) < Min(EndA, EndB)
                    if (Math.max(startMin, sl.s) < Math.min(endMin, sl.e)) {
                        isBusy = true; break;
                    }
                }
                if (!isBusy) { foundBed = i; break; }
            }

            if (foundBed) {
                // -> C√íN CH·ªñ: Ghi ƒë∆°n
                await addDoc(collection(db, 'bedBookings'), {
                    phone: curPhone,
                    name: uData.name,
                    date: bDate,
                    startTime: sT,
                    endTime: eT,
                    cName: document.getElementById('book-cname').value,
                    cPhone: document.getElementById('book-cphone').value,
                    bedId: foundBed,
                    status: "ƒë√£ ƒë·∫∑t tr∆∞·ªõc",
                    type: "app",
                    createdAt: serverTimestamp()
                });
                document.getElementById('loading-overlay').classList.add('hidden');
                showAppModal("Th√†nh c√¥ng", "ƒê√£ ƒë·∫∑t Bed th√†nh c√¥ng!", '‚úÖ');
            } else {
                // -> H·∫æT CH·ªñ
                document.getElementById('loading-overlay').classList.add('hidden');
                showAppModal("H·∫øt ch·ªó", "Gi·ªù n√†y ƒë√£ k√≠n ch·ªó. B·∫°n vui l√≤ng ch·ªçn gi·ªù kh√°c.", '‚ùå');
            }

        } catch (e) {
            document.getElementById('loading-overlay').classList.add('hidden');
            showAppModal("L·ªói", "L·ªói ki·ªÉm tra: " + e.message, '‚ùå');
        }
    }

    // --- 8. REWARDS & REDEMPTION (TRANSACTION) ---
    function renderRewards(list) {
        const container = document.getElementById('rewards-list');
        if (!container) return;
        if (!list || list.length === 0) { container.innerHTML = '<div class="text-center text-gray-400 py-10 italic text-xs">Ch∆∞a c√≥ qu√†.</div>'; return; }
        
        container.innerHTML = list.map((item, index) => {
            return `<div onclick="window.openGiftDetail(${index})" class="bg-white p-4 rounded-[2rem] border border-gray-100 shadow-sm flex items-center gap-4 mb-3 relative overflow-hidden group active:scale-[0.98] transition-transform cursor-pointer hover:shadow-md">
                <div class="shrink-0 w-24 h-24 rounded-3xl overflow-hidden border border-gray-100 bg-gray-50"><img src="${item.img || ''}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/150'"></div>
                <div class="flex-1 min-w-0"><p class="font-bold text-sm text-[#1e3932] mb-1 uppercase truncate">${item.name}</p><p class="text-[10px] text-gray-400 mb-2 line-clamp-2">${item.desc || '...'}</p><p class="text-md text-[#006241] font-black brand-font">${parseInt(item.point_cost || item.cost).toLocaleString()} <span class="text-amber-500 text-xs">‚òÖ</span></p></div>
                <div class="shrink-0 w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 group-hover:bg-[#006241] group-hover:text-white transition-colors">‚ûú</div>
            </div>`;
        }).join('');
    }

    window.openGiftDetail = function(index) {
        const item = _cachedGiftList[index];
        if (!item) return;
        const cost = parseInt(item.point_cost || item.cost || 0);
        
        document.getElementById('detail-gift-name').innerText = item.name;
        document.getElementById('detail-gift-desc').innerText = item.desc || '...';
        document.getElementById('detail-gift-cost').innerText = cost.toLocaleString() + ' ‚òÖ';
        document.getElementById('detail-gift-img').src = item.img || '';
        document.getElementById('detail-user-point').innerText = (uData.points || 0).toLocaleString() + ' ‚òÖ';
        
        let percent = (uData.points / cost) * 100; if (percent > 100) percent = 100;
        document.getElementById('detail-progress').style.width = percent + '%';

        const btn = document.getElementById('btn-confirm-redeem');
        const msg = document.getElementById('detail-message');
        
        // G√°n s·ª± ki·ªán cho n√∫t (Closure ƒë·ªÉ gi·ªØ bi·∫øn item)
        btn.onclick = () => { document.getElementById('gift-detail-modal').classList.add('hidden'); performRedeem(item, cost); };

        if (uData.points >= cost) {
            btn.disabled = false; btn.innerHTML = 'X√ÅC NH·∫¨N ƒê·ªîI NGAY';
            btn.className = "w-full py-4 rounded-2xl bg-[#006241] text-white font-bold text-sm uppercase tracking-widest shadow-lg active:scale-[0.98] transition-transform";
            msg.classList.add('hidden');
        } else {
            btn.disabled = true; btn.innerHTML = 'CH∆ØA ƒê·ª¶ ƒêI·ªÇM';
            btn.className = "w-full py-4 rounded-2xl bg-gray-300 text-gray-500 font-bold text-sm uppercase tracking-widest cursor-not-allowed";
            msg.classList.remove('hidden'); msg.innerText = `Thi·∫øu ${(cost - uData.points).toLocaleString()} ‚òÖ n·ªØa.`;
        }
        document.getElementById('gift-detail-modal').classList.remove('hidden');
    }

    async function performRedeem(item, cost) {
        showAppModal("X√°c nh·∫≠n", `D√πng <b>${cost.toLocaleString()} ‚òÖ</b> ƒë·ªïi <b>${item.name}</b>?`, 'üéÅ', async () => {
            document.getElementById('loading-overlay').classList.remove('hidden');
            
            try {
                // Transaction: Tr·ª´ ƒëi·ªÉm & Ghi l·ªãch s·ª≠
                await runTransaction(db, async (transaction) => {
                    const userRef = doc(db, 'customers', uData.id);
                    const sfDoc = await transaction.get(userRef);
                    
                    if (!sfDoc.exists()) throw "User kh√¥ng t·ªìn t·∫°i!";
                    const currentPoints = sfDoc.data().points || 0;
                    
                    if (currentPoints < cost) throw "Kh√¥ng ƒë·ªß ƒëi·ªÉm!";
                    
                    // 1. Update ƒëi·ªÉm
                    transaction.update(userRef, { points: currentPoints - cost });
                    
                    // 2. Ghi redemptions (LichSuDoiQua)
                    const newRef = doc(collection(db, "redemptions"));
                    transaction.set(newRef, {
                        phone: curPhone,
                        reward_name: item.name,
                        points_deducted: cost,
                        status: "new",
                        created_at: serverTimestamp()
                    });
                });

                document.getElementById('loading-overlay').classList.add('hidden');
                showAppModal("Th√†nh c√¥ng", "ƒê·ªïi qu√† th√†nh c√¥ng! H√£y ƒë∆∞a m√†n h√¨nh cho nh√¢n vi√™n.", '‚úÖ');
            } catch (e) {
                document.getElementById('loading-overlay').classList.add('hidden');
                showAppModal("L·ªói", "Giao d·ªãch th·∫•t b·∫°i: " + e, '‚ùå');
            }
        });
    }

    // --- 9. HISTORY ---
    document.getElementById('btn-open-history').addEventListener('click', openHistory);

    async function openHistory() {
        document.getElementById('history-modal').classList.remove('hidden');
        const listDiv = document.getElementById('history-list');
        const activeDiv = document.getElementById('section-active-booking');
        const activeCard = document.getElementById('active-card');
        
        document.getElementById('history-loading').classList.remove('hidden');
        listDiv.innerHTML = ''; activeDiv.classList.add('hidden');

        try {
            // Query bookings by phone
            // L∆∞u √Ω: C·∫ßn t·∫°o Index trong Firestore: bedBookings -> phone (Asc) + date (Desc)
            const q = query(collection(db, 'bedBookings'), where('phone', '==', curPhone), orderBy('date', 'desc'), limit(10));
            const snapshot = await getDocs(q);
            
            const todayStr = new Date().toISOString().split('T')[0];
            let hasActive = false;

            if (snapshot.empty) {
                 listDiv.innerHTML = '<div class="text-center text-gray-400 text-sm italic">Ch∆∞a c√≥ l·ªãch s·ª≠.</div>';
            } else {
                 let html = "";
                 snapshot.forEach(doc => {
                    const h = doc.data();
                    const id = doc.id;
                    
                    // Check Active
                    if (h.date === todayStr && !h.status.includes('h·ªßy') && !h.status.includes('xong')) {
                        hasActive = true;
                        activeDiv.classList.remove('hidden');
                        const bedText = h.bedId ? "BED " + h.bedId : "ƒêang x·∫øp";
                        activeCard.innerHTML = `<div class="absolute top-0 right-0 p-3 bg-amber-100 text-amber-800 text-[10px] font-bold rounded-bl-2xl">ƒêANG HO·∫†T ƒê·ªòNG</div><p class="text-3xl font-black text-[#1e3932] mb-1">${h.startTime}</p><p class="text-sm text-gray-500 font-medium mb-4">ƒê·∫øn: <b>${h.endTime}</b> ‚Ä¢ V·ªã tr√≠: <b class="text-[#006241]">${bedText}</b></p><div class="flex gap-2"><button onclick="window.requestCancel('${id}')" class="flex-1 py-2 rounded-xl bg-red-50 text-red-700 font-bold text-xs border border-red-100">üóëÔ∏è H·ªßy l·ªãch</button></div>`;
                    } else {
                        // History Item
                        let clr = "text-gray-500 bg-gray-100";
                        if (h.status.includes('xong')) clr = "text-green-600 bg-green-100";
                        else if (h.status.includes('h·ªßy')) clr = "text-red-500 bg-red-50";
                        
                        html += `<div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm mb-2"><div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-gray-400">${h.date}</span><span class="px-2 py-1 rounded-md text-[10px] font-bold uppercase ${clr}">${h.status}</span></div><p class="text-lg font-black text-[#1e3932] leading-none">${h.startTime} - ${h.endTime}</p><p class="text-xs text-gray-400 mt-1">Bed: ${h.bedId || '--'}</p></div>`;
                    }
                 });
                 listDiv.innerHTML = html;
            }
            document.getElementById('history-loading').classList.add('hidden');
        } catch (e) {
            console.error(e);
            document.getElementById('history-loading').innerText = "L·ªói t·∫£i (C·∫ßn t·∫°o Index Firestore).";
        }
    }

    window.requestCancel = function(docId) {
        showAppModal("X√°c nh·∫≠n", "H·ªßy l·ªãch n√†y?", '‚ö†Ô∏è', async () => {
            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                await updateDoc(doc(db, 'bedBookings', docId), {
                    status: 'ƒë√£ h·ªßy',
                    note: 'Kh√°ch t·ª± h·ªßy App'
                });
                document.getElementById('loading-overlay').classList.add('hidden');
                showAppModal("Xong", "ƒê√£ h·ªßy.", '‚úÖ');
                openHistory();
            } catch(e) {
                document.getElementById('loading-overlay').classList.add('hidden');
                showAppModal("L·ªói", e.message, '‚ùå');
            }
        });
    }

    // Utils
    function timeToMinutes(timeStr) {
        if (!timeStr) return 0;
        const [h, m] = timeStr.split(':').map(Number);
        return h * 60 + m;
    }
  </script>
</body>
</html>

